
Source Trees:

/app:
(Files/directories marked with ❌ are excluded or not included here)

app/
├── Console/
│   └── Kernel.php
├── Domains/
│   ├── Alarm/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── CheckPosition.php
│   │   │   ├── Create.php
│   │   │   ├── CreateUpdateAbstract.php
│   │   │   ├── Delete.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateBoolean.php
│   │   │   └── UpdateVehicle.php
│   │   ├── Command/
│   │   │   ├── CheckPosition.php
│   │   │   └── CommandAbstract.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Create.php
│   │   │   │   ├── CreateUpdateAbstract.php
│   │   │   │   ├── Index.php
│   │   │   │   ├── Update.php
│   │   │   │   ├── UpdateAlarmNotification.php
│   │   │   │   └── UpdateVehicle.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Create.php
│   │   │   ├── Index.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateAlarmNotification.php
│   │   │   ├── UpdateBoolean.php
│   │   │   ├── UpdateVehicle.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Job/
│   │   │   ├── CheckPosition.php
│   │   │   └── JobAbstract.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   ├── Alarm.php
│   │   │   │   └── AlarmVehicle.php
│   │   │   ├── Collection/
│   │   │   │   ├── Alarm.php
│   │   │   │   └── AlarmVehicle.php
│   │   │   ├── Traits/
│   │   │   │   └── TypeFormat.php
│   │   │   ├── Alarm.php
│   │   │   └── AlarmVehicle.php
│   │   ├── Service/
│   │   │   └── Type/
│   │   │       ├── Format/
│   │   │       │   ├── FenceAbstract.php
│   │   │       │   ├── FenceIn.php
│   │   │       │   ├── FenceOut.php
│   │   │       │   ├── FormatAbstract.php
│   │   │       │   ├── Movement.php
│   │   │       │   ├── Overspeed.php
│   │   │       │   ├── PolygonAbstract.php
│   │   │       │   ├── PolygonIn.php
│   │   │       │   ├── PolygonOut.php
│   │   │       │   └── Vibration.php
│   │   │       └── Manager.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── CheckPosition.php
│   │       ├── Create.php
│   │       ├── Update.php
│   │       ├── UpdateBoolean.php
│   │       ├── UpdateVehicle.php
│   │       └── ValidateFactory.php
│   ├── AlarmNotification/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Delete.php
│   │   │   ├── Notify.php
│   │   │   ├── UpdateClosedAt.php
│   │   │   └── UpdateSentAt.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   └── Index.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Delete.php
│   │   │   ├── Index.php
│   │   │   ├── UpdateClosedAt.php
│   │   │   ├── UpdateSentAt.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Job/
│   │   │   ├── JobAbstract.php
│   │   │   └── Notify.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── AlarmNotification.php
│   │   │   ├── Collection/
│   │   │   │   └── AlarmNotification.php
│   │   │   └── AlarmNotification.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Update.php
│   │       ├── UpdateBoolean.php
│   │       └── ValidateFactory.php
│   ├── City/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── GetOrNew.php
│   │   │   ├── Update.php
│   │   │   └── UpdateMerge.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Index.php
│   │   │   │   ├── Update.php
│   │   │   │   └── UpdateMerge.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Index.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateMerge.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── City.php
│   │   │   ├── Collection/
│   │   │   │   └── City.php
│   │   │   └── City.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── GetOrNew.php
│   │       ├── Update.php
│   │       ├── UpdateMerge.php
│   │       └── ValidateFactory.php
│   ├── Configuration/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── AppBind.php
│   │   │   ├── Dump.php
│   │   │   └── Update.php
│   │   ├── Command/
│   │   │   ├── CommandAbstract.php
│   │   │   └── Dump.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Index.php
│   │   │   │   └── Update.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Index.php
│   │   │   ├── Update.php
│   │   │   └── router.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── Configuration.php
│   │   │   ├── Collection/
│   │   │   │   └── Configuration.php
│   │   │   └── Configuration.php
│   │   ├── Seeder/
│   │   │   ├── data/
│   │   │   │   └── configuration.json
│   │   │   └── Configuration.php
│   │   ├── Service/
│   │   │   └── Getter/
│   │   │       └── Getter.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Dump.php
│   │       ├── Update.php
│   │       └── ValidateFactory.php
│   ├── Core/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   └── ActionFactoryAbstract.php
│   │   ├── Command/
│   │   │   └── CommandAbstract.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   └── ControllerAbstract.php
│   │   │   ├── ControllerAbstract.php
│   │   │   └── ControllerWebAbstract.php
│   │   ├── Database/
│   │   │   └── Builder/
│   │   │       └── Cache.php
│   │   ├── Event/
│   │   │   └── EventAbstract.php
│   │   ├── Fractal/
│   │   │   └── FractalAbstract.php
│   │   ├── Job/
│   │   │   ├── Middleware/
│   │   │   │   └── RateLimit.php
│   │   │   └── JobAbstract.php
│   │   ├── Listener/
│   │   │   └── ListenerAbstract.php
│   │   ├── Mail/
│   │   │   ├── MailAbstract.php
│   │   │   └── MailFactoryAbstract.php
│   │   ├── Middleware/
│   │   │   └── MiddlewareAbstract.php
│   │   ├── Migration/
│   │   │   ├── Database/
│   │   │   │   ├── DatabaseAbstract.php
│   │   │   │   ├── DatabaseFactory.php
│   │   │   │   ├── MySQL.php
│   │   │   │   ├── PostgreSQL.php
│   │   │   │   └── SQLite.php
│   │   │   └── MigrationAbstract.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── BuilderAbstract.php
│   │   │   ├── Collection/
│   │   │   │   └── CollectionAbstract.php
│   │   │   ├── Traits/
│   │   │   │   ├── Column.php
│   │   │   │   ├── DateDisabled.php
│   │   │   │   ├── JsonColumn.php
│   │   │   │   ├── MutatorDisabled.php
│   │   │   │   ├── Transform.php
│   │   │   │   ├── Translate.php
│   │   │   │   ├── Translation.php
│   │   │   │   └── TranslationSimple.php
│   │   │   ├── ModelAbstract.php
│   │   │   └── PivotAbstract.php
│   │   ├── Schedule/
│   │   │   └── ScheduleAbstract.php
│   │   ├── Seeder/
│   │   │   └── SeederAbstract.php
│   │   ├── Service/
│   │   │   └── Factory/
│   │   │       └── Factory.php
│   │   ├── Test/ ❌
│   │   ├── Traits/
│   │   │   └── Factory.php
│   │   └── Validate/
│   │       ├── Rule/
│   │       │   └── CSRF.php
│   │       ├── ValidateAbstract.php
│   │       └── ValidateFactoryAbstract.php
│   ├── CoreApp/
│   │   ├── Action/
│   │   │   ├── Traits/
│   │   │   │   ├── Cache.php
│   │   │   │   └── LogRow.php
│   │   │   ├── ActionAbstract.php
│   │   │   └── UpdateBoolean.php
│   │   ├── Command/
│   │   │   └── CommandAbstract.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   └── ControllerAbstract.php
│   │   │   ├── ControllerApiAbstract.php
│   │   │   └── ControllerWebAbstract.php
│   │   ├── ControllerApi/
│   │   │   └── Service/
│   │   │       └── ControllerApiAbstract.php
│   │   ├── Migration/
│   │   │   └── MigrationAbstract.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   ├── Traits/
│   │   │   │   │   └── Gis.php
│   │   │   │   └── BuilderAbstract.php
│   │   │   ├── Collection/
│   │   │   │   └── CollectionAbstract.php
│   │   │   ├── Traits/
│   │   │   │   ├── Content.php
│   │   │   │   └── Gis.php
│   │   │   ├── ModelAbstract.php
│   │   │   └── PivotAbstract.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       └── UpdateBoolean.php
│   ├── CoreMaintenance/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── CurlCacheClean.php
│   │   │   ├── DirectoryEmptyDelete.php
│   │   │   ├── DomainCreate.php
│   │   │   ├── FileDeleteOld.php
│   │   │   ├── FileZip.php
│   │   │   ├── MailTestQueue.php
│   │   │   ├── MailTestSend.php
│   │   │   ├── MigrationClean.php
│   │   │   └── OpcachePreload.php
│   │   ├── Command/
│   │   │   ├── CommandAbstract.php
│   │   │   ├── CurlCacheClean.php
│   │   │   ├── DirectoryEmptyDelete.php
│   │   │   ├── DomainCreate.php
│   │   │   ├── FileDeleteOld.php
│   │   │   ├── FileZip.php
│   │   │   ├── MigrationClean.php
│   │   │   └── OpcachePreload.php
│   │   ├── Schedule/
│   │   │   └── Manager.php
│   │   ├── Service/
│   │   │   ├── Domain/
│   │   │   │   ├── Section/
│   │   │   │   │   ├── Test/ ❌
│   │   │   │   │   └── SectionAbstract.php
│   │   │   │   ├── stub/
│   │   │   │   │   ├── Action/
│   │   │   │   │   │   ├── ActionAbstract.stub
│   │   │   │   │   │   ├── ActionFactory.stub
│   │   │   │   │   │   └── Create.stub
│   │   │   │   │   ├── Command/
│   │   │   │   │   │   ├── CommandAbstract.stub
│   │   │   │   │   │   └── Create.stub
│   │   │   │   │   ├── Controller/
│   │   │   │   │   │   ├── ControllerAbstract.stub
│   │   │   │   │   │   ├── Create.stub
│   │   │   │   │   │   ├── Index.stub
│   │   │   │   │   │   ├── Update.stub
│   │   │   │   │   │   └── router.stub
│   │   │   │   │   ├── Exception/
│   │   │   │   │   │   ├── ExceptionAbstract.stub
│   │   │   │   │   │   └── NotFound.stub
│   │   │   │   │   ├── Fractal/
│   │   │   │   │   │   └── FractalFactory.stub
│   │   │   │   │   ├── Job/
│   │   │   │   │   │   ├── JobAbstract.stub
│   │   │   │   │   │   └── Stats.stub
│   │   │   │   │   ├── Mail/
│   │   │   │   │   │   ├── MailFactory.stub
│   │   │   │   │   │   └── Signup.stub
│   │   │   │   │   ├── Middleware/
│   │   │   │   │   │   ├── MiddlewareAbstract.stub
│   │   │   │   │   │   └── Request.stub
│   │   │   │   │   ├── Model/
│   │   │   │   │   │   ├── Builder/
│   │   │   │   │   │   │   ├── __domain__.stub
│   │   │   │   │   │   │   └── __domain__Tag.stub
│   │   │   │   │   │   ├── Collection/
│   │   │   │   │   │   │   ├── __domain__.stub
│   │   │   │   │   │   │   └── __domain__Tag.stub
│   │   │   │   │   │   ├── __domain__.stub
│   │   │   │   │   │   └── __domain__Tag.stub
│   │   │   │   │   ├── Schedule/
│   │   │   │   │   │   └── Manager.stub
│   │   │   │   │   ├── Seeder/
│   │   │   │   │   │   ├── data/
│   │   │   │   │   │   │   └── __name__.json
│   │   │   │   │   │   └── __domain__.stub
│   │   │   │   │   ├── Test/ ❌
│   │   │   │   │   └── Validate/
│   │   │   │   │       ├── Create.stub
│   │   │   │   │       └── ValidateFactory.stub
│   │   │   │   └── Create.php
│   │   │   └── OPcache/
│   │   │       └── Preloader.php
│   │   └── Validate/
│   │       ├── DomainCreate.php
│   │       └── ValidateFactory.php
│   ├── CoreTranslation/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Clean.php
│   │   │   ├── Fill.php
│   │   │   ├── Fix.php
│   │   │   ├── Fixed.php
│   │   │   ├── NotTranslated.php
│   │   │   ├── Only.php
│   │   │   ├── PlainExport.php
│   │   │   ├── PlainImport.php
│   │   │   ├── Translate.php
│   │   │   └── Unused.php
│   │   ├── Command/
│   │   │   ├── Clean.php
│   │   │   ├── CommandAbstract.php
│   │   │   ├── Fill.php
│   │   │   ├── Fix.php
│   │   │   ├── Fixed.php
│   │   │   ├── NotTranslated.php
│   │   │   ├── Only.php
│   │   │   ├── PlainExport.php
│   │   │   ├── PlainImport.php
│   │   │   ├── Translate.php
│   │   │   └── Unused.php
│   │   ├── Service/
│   │   │   ├── Clean.php
│   │   │   ├── Fill.php
│   │   │   ├── Fix.php
│   │   │   ├── Fixed.php
│   │   │   ├── NotTranslated.php
│   │   │   ├── Only.php
│   │   │   ├── PlainExport.php
│   │   │   ├── PlainImport.php
│   │   │   ├── ServiceAbstract.php
│   │   │   ├── Translate.php
│   │   │   └── Unused.php
│   │   └── Validate/
│   │       ├── Fixed.php
│   │       ├── Only.php
│   │       ├── PlainExport.php
│   │       ├── PlainImport.php
│   │       ├── Translate.php
│   │       └── ValidateFactory.php
│   ├── Country/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── GetOrNew.php
│   │   │   ├── Update.php
│   │   │   └── UpdateMerge.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Index.php
│   │   │   │   ├── Update.php
│   │   │   │   └── UpdateMerge.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Index.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateMerge.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── Country.php
│   │   │   ├── Collection/
│   │   │   │   └── Country.php
│   │   │   └── Country.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── GetOrNew.php
│   │       ├── Update.php
│   │       ├── UpdateMerge.php
│   │       └── ValidateFactory.php
│   ├── Dashboard/
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   └── Index.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Index.php
│   │   │   └── router.php
│   │   └── Test/ ❌
│   ├── Device/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Create.php
│   │   │   ├── CreateUpdateAbstract.php
│   │   │   ├── Delete.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateBoolean.php
│   │   │   ├── UpdateDeviceMessageCreate.php
│   │   │   └── UpdateTransfer.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Create.php
│   │   │   │   ├── CreateUpdateAbstract.php
│   │   │   │   ├── Index.php
│   │   │   │   ├── Map.php
│   │   │   │   ├── Update.php
│   │   │   │   ├── UpdateDeviceMessage.php
│   │   │   │   └── UpdateTransfer.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Create.php
│   │   │   ├── Index.php
│   │   │   ├── Map.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateBoolean.php
│   │   │   ├── UpdateDeviceMessage.php
│   │   │   ├── UpdateDeviceMessageCreate.php
│   │   │   ├── UpdateDeviceMessageUpdate.php
│   │   │   ├── UpdateTransfer.php
│   │   │   └── router.php
│   │   ├── ControllerApi/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerApiAbstract.php
│   │   │   │   ├── Create.php
│   │   │   │   ├── Index.php
│   │   │   │   └── Update.php
│   │   │   ├── ControllerApiAbstract.php
│   │   │   ├── Create.php
│   │   │   ├── Delete.php
│   │   │   ├── Index.php
│   │   │   ├── Update.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Middleware/
│   │   │   ├── Available.php
│   │   │   └── MiddlewareAbstract.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── Device.php
│   │   │   ├── Collection/
│   │   │   │   └── Device.php
│   │   │   └── Device.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Create.php
│   │       ├── Update.php
│   │       ├── UpdateBoolean.php
│   │       ├── UpdateTransfer.php
│   │       └── ValidateFactory.php
│   ├── DeviceMessage/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Create.php
│   │   │   ├── Delete.php
│   │   │   └── Duplicate.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── DeviceMessage.php
│   │   │   ├── Collection/
│   │   │   │   └── DeviceMessage.php
│   │   │   └── DeviceMessage.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Create.php
│   │       └── ValidateFactory.php
│   ├── Error/
│   │   └── Controller/
│   │       ├── ControllerAbstract.php
│   │       └── Index.php
│   ├── File/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Create.php
│   │   │   ├── CreateUpdateAbstract.php
│   │   │   ├── Delete.php
│   │   │   ├── Update.php
│   │   │   └── Upload.php
│   │   ├── Controller/
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── View.php
│   │   │   └── router.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── File.php
│   │   │   ├── Collection/
│   │   │   │   └── File.php
│   │   │   └── File.php
│   │   └── Validate/
│   │       ├── Create.php
│   │       ├── Update.php
│   │       ├── Upload.php
│   │       └── ValidateFactory.php
│   ├── Help/
│   │   ├── Command/
│   │   │   ├── CommandAbstract.php
│   │   │   └── Show.php
│   │   └── ControllerApi/
│   │       ├── Service/
│   │       │   ├── ControllerApiAbstract.php
│   │       │   ├── Detail.php
│   │       │   └── Index.php
│   │       ├── ControllerApiAbstract.php
│   │       ├── Detail.php
│   │       ├── Index.php
│   │       └── router.php
│   ├── IpLock/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Check.php
│   │   │   ├── Create.php
│   │   │   ├── CreateUpdateAbstract.php
│   │   │   ├── Delete.php
│   │   │   ├── Lock.php
│   │   │   ├── Update.php
│   │   │   └── UpdateEndAt.php
│   │   ├── Controller/
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Create.php
│   │   │   ├── Index.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateEndAt.php
│   │   │   └── router.php
│   │   ├── Exception/
│   │   │   ├── ExceptionAbstract.php
│   │   │   └── IpLocked.php
│   │   ├── Middleware/
│   │   │   ├── Check.php
│   │   │   └── MiddlewareAbstract.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── IpLock.php
│   │   │   ├── Collection/
│   │   │   │   └── IpLock.php
│   │   │   └── IpLock.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Check.php
│   │       ├── Create.php
│   │       ├── Lock.php
│   │       ├── Update.php
│   │       └── ValidateFactory.php
│   ├── Language/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Request.php
│   │   │   └── Set.php
│   │   ├── ControllerApi/
│   │   │   ├── ControllerApiAbstract.php
│   │   │   ├── Index.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Middleware/
│   │   │   └── Request.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── Language.php
│   │   │   ├── Collection/
│   │   │   │   └── Language.php
│   │   │   └── Language.php
│   │   ├── Seeder/
│   │   │   ├── data/
│   │   │   │   └── language.json
│   │   │   └── Language.php
│   │   └── Test/ ❌
│   ├── Maintenance/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Create.php
│   │   │   ├── CreateUpdateAbstract.php
│   │   │   ├── Delete.php
│   │   │   ├── Update.php
│   │   │   └── UpdateItem.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Create.php
│   │   │   │   ├── CreateUpdateAbstract.php
│   │   │   │   ├── Index.php
│   │   │   │   ├── Update.php
│   │   │   │   └── UpdateItem.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Create.php
│   │   │   ├── Index.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateItem.php
│   │   │   └── router.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   ├── Maintenance.php
│   │   │   │   └── MaintenanceMaintenanceItem.php
│   │   │   ├── Collection/
│   │   │   │   ├── Maintenance.php
│   │   │   │   └── MaintenanceMaintenanceItem.php
│   │   │   ├── Maintenance.php
│   │   │   └── MaintenanceMaintenanceItem.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Create.php
│   │       ├── Update.php
│   │       ├── UpdateItem.php
│   │       └── ValidateFactory.php
│   ├── MaintenanceItem/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Create.php
│   │   │   ├── CreateUpdateAbstract.php
│   │   │   ├── Delete.php
│   │   │   └── Update.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Create.php
│   │   │   │   ├── CreateUpdateAbstract.php
│   │   │   │   ├── Index.php
│   │   │   │   ├── Update.php
│   │   │   │   └── UpdateMaintenance.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Create.php
│   │   │   ├── Index.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateMaintenance.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── MaintenanceItem.php
│   │   │   ├── Collection/
│   │   │   │   └── MaintenanceItem.php
│   │   │   └── MaintenanceItem.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Create.php
│   │       ├── Update.php
│   │       └── ValidateFactory.php
│   ├── Monitor/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   └── QueueFailedRetry.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Database.php
│   │   │   │   ├── Index.php
│   │   │   │   ├── Installation.php
│   │   │   │   ├── Log.php
│   │   │   │   ├── LogAbstract.php
│   │   │   │   ├── LogFile.php
│   │   │   │   ├── LogFileDownload.php
│   │   │   │   ├── Queue.php
│   │   │   │   └── Requirements.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Database.php
│   │   │   ├── Index.php
│   │   │   ├── Installation.php
│   │   │   ├── Log.php
│   │   │   ├── LogFile.php
│   │   │   ├── LogFileDownload.php
│   │   │   ├── Queue.php
│   │   │   ├── Requirements.php
│   │   │   └── router.php
│   │   ├── Service/
│   │   │   ├── Database/
│   │   │   │   ├── Driver/
│   │   │   │   │   ├── DriverAbstract.php
│   │   │   │   │   ├── MySQL.php
│   │   │   │   │   └── PgSQL.php
│   │   │   │   └── Database.php
│   │   │   └── System/
│   │   │       ├── Cpu.php
│   │   │       ├── Disk.php
│   │   │       ├── Memory.php
│   │   │       ├── Summary.php
│   │   │       └── SystemAbstract.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── QueueFailedRetry.php
│   │       └── ValidateFactory.php
│   ├── Position/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Create.php
│   │   │   ├── UpdateCity.php
│   │   │   └── UpdateCityEmpty.php
│   │   ├── Command/
│   │   │   ├── CommandAbstract.php
│   │   │   ├── UpdateCity.php
│   │   │   └── UpdateCityEmpty.php
│   │   ├── ControllerApi/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerApiAbstract.php
│   │   │   │   └── Index.php
│   │   │   ├── ControllerApiAbstract.php
│   │   │   ├── Index.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Job/
│   │   │   ├── JobAbstract.php
│   │   │   └── UpdateCity.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── Position.php
│   │   │   ├── Collection/
│   │   │   │   └── Position.php
│   │   │   ├── Traits/
│   │   │   │   ├── Query.php
│   │   │   │   └── SelectRaw.php
│   │   │   └── Position.php
│   │   ├── Schedule/
│   │   │   └── Manager.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Create.php
│   │       └── ValidateFactory.php
│   ├── Profile/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateTelegram.php
│   │   │   ├── UpdateTelegramChatId.php
│   │   │   └── UpdateTelegramTest.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   └── Update.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateTelegram.php
│   │   │   ├── UpdateUserSession.php
│   │   │   └── router.php
│   │   ├── ControllerApi/
│   │   │   ├── ControllerApiAbstract.php
│   │   │   ├── Index.php
│   │   │   └── router.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Update.php
│   │       ├── UpdateTelegram.php
│   │       └── ValidateFactory.php
│   ├── QueueFail/
│   │   └── Model/
│   │       ├── Builder/
│   │       │   └── QueueFail.php
│   │       ├── Collection/
│   │       │   └── QueueFail.php
│   │       └── QueueFail.php
│   ├── Refuel/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Create.php
│   │   │   ├── CreateUpdateAbstract.php
│   │   │   ├── Delete.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateCity.php
│   │   │   └── UpdateCityEmpty.php
│   │   ├── Command/
│   │   │   ├── CommandAbstract.php
│   │   │   ├── UpdateCity.php
│   │   │   └── UpdateCityEmpty.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Create.php
│   │   │   │   ├── CreateUpdateAbstract.php
│   │   │   │   ├── Index.php
│   │   │   │   ├── IndexMapAbstract.php
│   │   │   │   ├── Map.php
│   │   │   │   └── Update.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Create.php
│   │   │   ├── Index.php
│   │   │   ├── Map.php
│   │   │   ├── Update.php
│   │   │   └── router.php
│   │   ├── ControllerApi/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerApiAbstract.php
│   │   │   │   ├── Create.php
│   │   │   │   ├── Index.php
│   │   │   │   └── Update.php
│   │   │   ├── ControllerApiAbstract.php
│   │   │   ├── Create.php
│   │   │   ├── Delete.php
│   │   │   ├── Index.php
│   │   │   ├── Update.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Job/
│   │   │   ├── JobAbstract.php
│   │   │   └── UpdateCity.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── Refuel.php
│   │   │   ├── Collection/
│   │   │   │   └── Refuel.php
│   │   │   └── Refuel.php
│   │   ├── Schedule/
│   │   │   └── Manager.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Create.php
│   │       ├── Update.php
│   │       └── ValidateFactory.php
│   ├── Server/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Create.php
│   │   │   ├── CreateUpdateAbstract.php
│   │   │   ├── Delete.php
│   │   │   ├── LogRead.php
│   │   │   ├── Parse.php
│   │   │   ├── StartAll.php
│   │   │   ├── StartPort.php
│   │   │   ├── StartPorts.php
│   │   │   ├── StopAll.php
│   │   │   ├── StopPorts.php
│   │   │   ├── Update.php
│   │   │   └── UpdateBoolean.php
│   │   ├── Command/
│   │   │   ├── CommandAbstract.php
│   │   │   ├── LogRead.php
│   │   │   ├── StartAll.php
│   │   │   ├── StartPort.php
│   │   │   └── StopAll.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Status.php
│   │   │   │   └── UpdateParser.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Create.php
│   │   │   ├── Index.php
│   │   │   ├── Status.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateBoolean.php
│   │   │   ├── UpdateParser.php
│   │   │   └── router.php
│   │   ├── Exception/
│   │   │   ├── ExceptionAbstract.php
│   │   │   ├── PortBusy.php
│   │   │   └── PortLocked.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── Server.php
│   │   │   ├── Collection/
│   │   │   │   └── Server.php
│   │   │   └── Server.php
│   │   ├── Schedule/
│   │   │   └── Manager.php
│   │   ├── Seeder/
│   │   │   ├── data/
│   │   │   │   └── server.json
│   │   │   └── Server.php
│   │   ├── Service/
│   │   │   ├── Command/
│   │   │   │   └── Generator.php
│   │   │   └── Logger/
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Create.php
│   │       ├── LogRead.php
│   │       ├── Parse.php
│   │       ├── StartAll.php
│   │       ├── StartPort.php
│   │       ├── StartPorts.php
│   │       ├── StopPorts.php
│   │       ├── Update.php
│   │       ├── UpdateBoolean.php
│   │       └── ValidateFactory.php
│   ├── Shared/
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Device.php
│   │   │   │   └── Index.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Device.php
│   │   │   ├── Index.php
│   │   │   ├── Trip.php
│   │   │   └── router.php
│   │   └── Test/ ❌
│   ├── State/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── GetOrNew.php
│   │   │   ├── Update.php
│   │   │   └── UpdateMerge.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Index.php
│   │   │   │   ├── Update.php
│   │   │   │   └── UpdateMerge.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Index.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateMerge.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── State.php
│   │   │   ├── Collection/
│   │   │   │   └── State.php
│   │   │   └── State.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── GetOrNew.php
│   │       ├── Update.php
│   │       ├── UpdateMerge.php
│   │       └── ValidateFactory.php
│   ├── Timezone/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Geojson.php
│   │   │   └── UpdateDefault.php
│   │   ├── Command/
│   │   │   ├── CommandAbstract.php
│   │   │   └── Geojson.php
│   │   ├── Controller/
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Index.php
│   │   │   ├── UpdateDefault.php
│   │   │   └── router.php
│   │   ├── ControllerApi/
│   │   │   ├── ControllerApiAbstract.php
│   │   │   ├── Index.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── Timezone.php
│   │   │   ├── Collection/
│   │   │   │   └── Timezone.php
│   │   │   └── Timezone.php
│   │   ├── Seeder/
│   │   │   ├── data/
│   │   │   │   └── timezone.json
│   │   │   └── Timezone.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Geojson.php
│   │       └── ValidateFactory.php
│   ├── Tool/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   └── ManifestGenerate.php
│   │   └── Command/
│   │       ├── CommandAbstract.php
│   │       └── ManifestGenerate.php
│   ├── Trip/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── Create.php
│   │   │   ├── Delete.php
│   │   │   ├── Import.php
│   │   │   ├── LastOrNew.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateBoolean.php
│   │   │   ├── UpdateExport.php
│   │   │   ├── UpdateMerge.php
│   │   │   ├── UpdateNameDistanceTime.php
│   │   │   ├── UpdatePositionCreate.php
│   │   │   ├── UpdatePositionDelete.php
│   │   │   ├── UpdateStats.php
│   │   │   └── UpdateStatsAll.php
│   │   ├── Command/
│   │   │   ├── CommandAbstract.php
│   │   │   ├── Import.php
│   │   │   ├── UpdateStats.php
│   │   │   └── UpdateStatsAll.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Heatmap.php
│   │   │   │   ├── Import.php
│   │   │   │   ├── Index.php
│   │   │   │   ├── Map.php
│   │   │   │   ├── Search.php
│   │   │   │   ├── Update.php
│   │   │   │   ├── UpdateAlarmNotification.php
│   │   │   │   ├── UpdateMap.php
│   │   │   │   ├── UpdateMerge.php
│   │   │   │   ├── UpdatePosition.php
│   │   │   │   └── UpdateStat.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Heatmap.php
│   │   │   ├── Import.php
│   │   │   ├── Index.php
│   │   │   ├── Map.php
│   │   │   ├── Search.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateAbstract.php
│   │   │   ├── UpdateAlarmNotification.php
│   │   │   ├── UpdateBoolean.php
│   │   │   ├── UpdateExport.php
│   │   │   ├── UpdateMap.php
│   │   │   ├── UpdateMerge.php
│   │   │   ├── UpdatePosition.php
│   │   │   ├── UpdateStat.php
│   │   │   └── router.php
│   │   ├── ControllerApi/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerApiAbstract.php
│   │   │   │   ├── Index.php
│   │   │   │   ├── Position.php
│   │   │   │   └── Update.php
│   │   │   ├── ControllerApiAbstract.php
│   │   │   ├── Delete.php
│   │   │   ├── Index.php
│   │   │   ├── Position.php
│   │   │   ├── Update.php
│   │   │   └── router.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Job/
│   │   │   ├── JobAbstract.php
│   │   │   └── UpdateStats.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── Trip.php
│   │   │   ├── Collection/
│   │   │   │   └── Trip.php
│   │   │   ├── Traits/
│   │   │   │   ├── Query.php
│   │   │   │   └── Statement.php
│   │   │   └── Trip.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Create.php
│   │       ├── Import.php
│   │       ├── LastOrNew.php
│   │       ├── Update.php
│   │       ├── UpdateBoolean.php
│   │       ├── UpdateMerge.php
│   │       ├── UpdatePositionCreate.php
│   │       ├── UpdatePositionDelete.php
│   │       ├── UpdateStatsAll.php
│   │       └── ValidateFactory.php
│   ├── User/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   ├── AuthApi.php
│   │   │   ├── AuthCredentials.php
│   │   │   ├── AuthModel.php
│   │   │   ├── Create.php
│   │   │   ├── CreateUpdateAbstract.php
│   │   │   ├── Delete.php
│   │   │   ├── Logout.php
│   │   │   ├── Request.php
│   │   │   ├── Set.php
│   │   │   └── Update.php
│   │   ├── Command/
│   │   │   ├── CommandAbstract.php
│   │   │   ├── Create.php
│   │   │   └── Update.php
│   │   ├── Controller/
│   │   │   ├── Service/
│   │   │   │   ├── ControllerAbstract.php
│   │   │   │   ├── Create.php
│   │   │   │   ├── CreateUpdateAbstract.php
│   │   │   │   └── Update.php
│   │   │   ├── AuthCredentials.php
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Create.php
│   │   │   ├── Disabled.php
│   │   │   ├── Index.php
│   │   │   ├── Logout.php
│   │   │   ├── Update.php
│   │   │   ├── UpdateUserSession.php
│   │   │   └── router.php
│   │   ├── ControllerApi/
│   │   │   ├── ControllerApiAbstract.php
│   │   │   ├── Create.php
│   │   │   ├── Delete.php
│   │   │   ├── Index.php
│   │   │   ├── Update.php
│   │   │   └── router.php
│   │   ├── Exception/
│   │   │   ├── AuthFailed.php
│   │   │   ├── ExceptionAbstract.php
│   │   │   ├── NotEnabled.php
│   │   │   ├── NotLogged.php
│   │   │   └── SessionEmpty.php
│   │   ├── Fractal/
│   │   │   └── FractalFactory.php
│   │   ├── Middleware/
│   │   │   ├── Admin.php
│   │   │   ├── AdminMode.php
│   │   │   ├── AuthApi.php
│   │   │   ├── AuthRedirect.php
│   │   │   ├── Enabled.php
│   │   │   ├── Manager.php
│   │   │   ├── ManagerMode.php
│   │   │   ├── MiddlewareAbstract.php
│   │   │   └── Request.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── User.php
│   │   │   ├── Collection/
│   │   │   │   └── User.php
│   │   │   ├── Traits/
│   │   │   │   └── Preferences.php
│   │   │   └── User.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── AuthCredentials.php
│   │       ├── Create.php
│   │       ├── Update.php
│   │       └── ValidateFactory.php
│   ├── UserFail/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   └── Create.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── UserFail.php
│   │   │   ├── Collection/
│   │   │   │   └── UserFail.php
│   │   │   └── UserFail.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Create.php
│   │       └── ValidateFactory.php
│   ├── UserSession/
│   │   ├── Action/
│   │   │   ├── ActionAbstract.php
│   │   │   ├── ActionFactory.php
│   │   │   └── Create.php
│   │   ├── Controller/
│   │   │   ├── ControllerAbstract.php
│   │   │   ├── Index.php
│   │   │   └── router.php
│   │   ├── Model/
│   │   │   ├── Builder/
│   │   │   │   └── UserSession.php
│   │   │   ├── Collection/
│   │   │   │   └── UserSession.php
│   │   │   └── UserSession.php
│   │   ├── Test/ ❌
│   │   └── Validate/
│   │       ├── Create.php
│   │       └── ValidateFactory.php
│   └── Vehicle/
│       ├── Action/
│       │   ├── ActionAbstract.php
│       │   ├── ActionFactory.php
│       │   ├── Create.php
│       │   ├── CreateUpdateAbstract.php
│       │   ├── Delete.php
│       │   ├── Update.php
│       │   ├── UpdateAlarm.php
│       │   └── UpdateDevice.php
│       ├── Controller/
│       │   ├── Service/
│       │   │   ├── ControllerAbstract.php
│       │   │   ├── Create.php
│       │   │   ├── CreateUpdateAbstract.php
│       │   │   ├── Index.php
│       │   │   ├── Map.php
│       │   │   ├── Update.php
│       │   │   ├── UpdateAlarm.php
│       │   │   ├── UpdateAlarmNotification.php
│       │   │   └── UpdateDevice.php
│       │   ├── ControllerAbstract.php
│       │   ├── Create.php
│       │   ├── Index.php
│       │   ├── Map.php
│       │   ├── Update.php
│       │   ├── UpdateAlarm.php
│       │   ├── UpdateAlarmNotification.php
│       │   ├── UpdateDevice.php
│       │   └── router.php
│       ├── ControllerApi/
│       │   ├── Service/
│       │   │   ├── ControllerApiAbstract.php
│       │   │   ├── Create.php
│       │   │   ├── Index.php
│       │   │   └── Update.php
│       │   ├── ControllerApiAbstract.php
│       │   ├── Create.php
│       │   ├── Delete.php
│       │   ├── Index.php
│       │   ├── Update.php
│       │   └── router.php
│       ├── Fractal/
│       │   └── FractalFactory.php
│       ├── Middleware/
│       │   ├── Available.php
│       │   └── MiddlewareAbstract.php
│       ├── Model/
│       │   ├── Builder/
│       │   │   └── Vehicle.php
│       │   ├── Collection/
│       │   │   └── Vehicle.php
│       │   └── Vehicle.php
│       ├── Test/ ❌
│       └── Validate/
│           ├── Create.php
│           ├── Update.php
│           ├── UpdateAlarm.php
│           ├── UpdateDevice.php
│           └── ValidateFactory.php
├── Exceptions/
│   ├── AuthenticationException.php
│   ├── GenericException.php
│   ├── Handler.php
│   ├── NotAllowedException.php
│   ├── NotFoundException.php
│   ├── Response.php
│   ├── UnexpectedValueException.php
│   └── ValidatorException.php
├── Http/
│   ├── Middleware/
│   │   ├── Https.php
│   │   ├── MessagesShareFromSession.php
│   │   ├── RequestLogger.php
│   │   ├── Reset.php
│   │   └── TrustProxies.php
│   └── Kernel.php
├── Providers/
│   ├── App.php
│   ├── Debug.php
│   ├── Route.php
│   └── View.php
├── Services/
│   ├── Buffer/
│   │   ├── Bcd.php
│   │   ├── Bit.php
│   │   └── Byte.php
│   ├── Captcha/
│   │   └── Captcha.php
│   ├── Chrono/
│   │   └── Chrono.php
│   ├── Command/
│   │   ├── Artisan.php
│   │   └── Exec.php
│   ├── Compress/
│   │   └── Zip/
│   │       ├── Contents.php
│   │       ├── Create.php
│   │       ├── Extract.php
│   │       ├── File.php
│   │       └── Folder.php
│   ├── Csv/
│   │   ├── Read.php
│   │   └── Write.php
│   ├── Curl/
│   │   ├── Cache.php
│   │   ├── Curl.php
│   │   ├── CurlException.php
│   │   └── Log.php
│   ├── Database/
│   │   └── Logger.php
│   ├── Filesystem/
│   │   ├── Directory.php
│   │   └── File.php
│   ├── Gpx/
│   │   ├── Read.php
│   │   └── Write.php
│   ├── Helper/
│   │   ├── Traits/
│   │   │   ├── Arrays.php
│   │   │   ├── Custom.php
│   │   │   ├── Date.php
│   │   │   ├── Exception.php
│   │   │   ├── File.php
│   │   │   ├── Geo.php
│   │   │   ├── Misc.php
│   │   │   ├── Number.php
│   │   │   └── Unit.php
│   │   ├── Helper.php
│   │   ├── Service.php
│   │   └── functions.php
│   ├── Html/
│   │   ├── Traits/
│   │   │   └── Custom.php
│   │   ├── Alert.php
│   │   └── Html.php
│   ├── Locate/
│   │   ├── Arcgis.php
│   │   ├── Gisgraphy.php
│   │   ├── LocateAbstract.php
│   │   ├── LocateFactory.php
│   │   ├── Nominatim.php
│   │   └── Resource.php
│   ├── Logger/
│   │   ├── DailyAbstract.php
│   │   ├── DeprecationsDaily.php
│   │   ├── LaravelDaily.php
│   │   ├── Mail.php
│   │   ├── MonologRotatingFileAbstract.php
│   │   └── RotatingFileAbstract.php
│   ├── Protocol/
│   │   ├── Aquila/
│   │   │   ├── Parser/
│   │   │   │   └── Location.php
│   │   │   └── Manager.php
│   │   ├── DebugHttp/
│   │   │   └── Manager.php
│   │   ├── DebugSocket/
│   │   │   └── Manager.php
│   │   ├── GPS103/
│   │   │   ├── Parser/
│   │   │   │   ├── Auth.php
│   │   │   │   ├── Command.php
│   │   │   │   ├── Heartbeat.php
│   │   │   │   └── Location.php
│   │   │   └── Manager.php
│   │   ├── GT06/
│   │   │   ├── Parser/
│   │   │   │   ├── Auth.php
│   │   │   │   ├── Heartbeat.php
│   │   │   │   ├── LocationGpsModular.php
│   │   │   │   └── LocationLbs.php
│   │   │   └── Manager.php
│   │   ├── H02/
│   │   │   ├── Parser/
│   │   │   │   ├── Command.php
│   │   │   │   ├── Location.php
│   │   │   │   ├── LocationBinary.php
│   │   │   │   └── Sms.php
│   │   │   └── Manager.php
│   │   ├── OsmAnd/
│   │   │   ├── Parser/
│   │   │   │   └── Location.php
│   │   │   └── Manager.php
│   │   ├── Queclink/
│   │   │   ├── Parser/
│   │   │   │   └── Location.php
│   │   │   └── Manager.php
│   │   ├── Resource/
│   │   │   ├── Auth.php
│   │   │   ├── Command.php
│   │   │   ├── Heartbeat.php
│   │   │   ├── Location.php
│   │   │   ├── ResourceAbstract.php
│   │   │   └── Sms.php
│   │   ├── TK102/
│   │   │   ├── Parser/
│   │   │   │   ├── Command.php
│   │   │   │   └── Location.php
│   │   │   └── Manager.php
│   │   ├── Teltonika/
│   │   │   ├── Parser/
│   │   │   │   ├── Auth.php
│   │   │   │   ├── Codec.php
│   │   │   │   ├── Location.php
│   │   │   │   └── Locations.php
│   │   │   └── Manager.php
│   │   ├── ParserAbstract.php
│   │   ├── ProtocolAbstract.php
│   │   └── ProtocolFactory.php
│   ├── Request/
│   │   ├── Logger.php
│   │   └── Response.php
│   ├── Server/
│   │   ├── Http/
│   │   │   ├── Client.php
│   │   │   └── Server.php
│   │   ├── Socket/
│   │   │   ├── Client.php
│   │   │   └── Server.php
│   │   ├── Connection.php
│   │   ├── Logger.php
│   │   ├── Pool.php
│   │   ├── Process.php
│   │   └── ServerAbstract.php
│   ├── Telegram/
│   │   └── Client.php
│   ├── Translator/
│   │   ├── Provider/
│   │   │   ├── DeepL/
│   │   │   │   └── Manager.php
│   │   │   ├── Microsoft/
│   │   │   │   └── Manager.php
│   │   │   ├── OpenAI/
│   │   │   │   └── Manager.php
│   │   │   └── ProviderAbstract.php
│   │   └── TranslatorFactory.php
│   ├── Validator/
│   │   ├── Data.php
│   │   └── ValidatorAbstract.php
│   └── View/
│       ├── Bag.php
│       └── Message.php
└── View/
    └── Components/
        ├── ChartSpeed.php
        ├── Map.php
        ├── MapDevice.php
        ├── MapRefuel.php
        ├── MapTrip.php
        ├── MapVehicle.php
        ├── Message.php
        └── Select.php

Excluded Content:

Directories with excluded files:

- /app/Domains/Configuration/Seeder/data: 1 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Action: 3 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Command: 2 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Controller: 5 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Exception: 2 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Fractal: 1 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Job: 2 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Mail: 2 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Middleware: 2 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Model: 2 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Model/Builder: 2 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Model/Collection: 2 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Schedule: 1 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Seeder: 1 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Seeder/data: 1 files

- /app/Domains/CoreMaintenance/Service/Domain/stub/Validate: 2 files

- /app/Domains/Language/Seeder/data: 1 files

- /app/Domains/Server/Seeder/data: 1 files

- /app/Domains/Timezone/Seeder/data: 1 files

File extensions excluded:

- .json: 5 files

- .stub: 29 files

`app/Console/Kernel.php:`

```php
<?php declare(strict_types=1);

namespace App\Console;

use Illuminate\Console\Scheduling\Schedule;
use Illuminate\Foundation\Console\Kernel as KernelVendor;
use App\Domains\CoreMaintenance\Schedule\Manager as CoreMaintenanceScheduleManager;
use App\Domains\Position\Schedule\Manager as PositionScheduleManager;
use App\Domains\Refuel\Schedule\Manager as RefuelScheduleManager;
use App\Domains\Server\Schedule\Manager as ServerScheduleManager;

class Kernel extends KernelVendor
{
    /**
     * @return void
     */
    protected function commands(): void
    {
        foreach (glob(app_path('Domains/*/Command')) as $dir) {
            $this->load($dir);
        }
    }

    /**
     * @param \Illuminate\Console\Scheduling\Schedule $schedule
     *
     * @return void
     */
    protected function schedule(Schedule $schedule): void
    {
        ServerScheduleManager::new($schedule)->handle();
        PositionScheduleManager::new($schedule)->handle();
        RefuelScheduleManager::new($schedule)->handle();
        CoreMaintenanceScheduleManager::new($schedule)->handle();

        $this->scheduleQueue($schedule);
    }

    /**
     * @param \Illuminate\Console\Scheduling\Schedule $schedule
     *
     * @return void
     */
    protected function scheduleQueue(Schedule $schedule): void
    {
        if (config('queue.schedule') !== true) {
            return;
        }

        $schedule->command('queue:work', ['--tries' => 3, '--max-time' => 3600])
            ->withoutOverlapping()
            ->runInBackground()
            ->appendOutputTo($this->scheduleQueueLog())
            ->everyMinute();
    }

    /**
     * @return string
     */
    protected function scheduleQueueLog(): string
    {
        $file = storage_path('logs/artisan/'.date('Y/m/d').'/schedule-command-queue-work.log');

        helper()->mkdir($file, true);

        return $file;
    }
}

```

`app/Domains/Alarm/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Action;

use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Alarm\Model\Alarm
     */
    protected ?Model $row;
}

```

`app/Domains/Alarm/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Action;

use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\Core\Action\ActionFactoryAbstract;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Alarm\Model\Alarm
     */
    protected ?Model $row;

    /**
     * @return void
     */
    public function checkPosition(): void
    {
        $this->actionHandle(CheckPosition::class, $this->validate()->checkPosition());
    }

    /**
     * @return \App\Domains\Alarm\Model\Alarm
     */
    public function create(): Model
    {
        return $this->actionHandle(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandle(Delete::class);
    }

    /**
     * @return \App\Domains\Alarm\Model\Alarm
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\Alarm\Model\Alarm
     */
    public function updateBoolean(): Model
    {
        return $this->actionHandle(UpdateBoolean::class, $this->validate()->updateBoolean());
    }

    /**
     * @return \App\Domains\Alarm\Model\Alarm
     */
    public function updateVehicle(): Model
    {
        return $this->actionHandle(UpdateVehicle::class, $this->validate()->updateVehicle());
    }
}

```

`app/Domains/Alarm/Action/CheckPosition.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Action;

use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\Alarm\Model\AlarmVehicle as AlarmVehicleModel;
use App\Domains\Alarm\Model\Collection\Alarm as Collection;
use App\Domains\Alarm\Service\Type\Manager as TypeManager;
use App\Domains\AlarmNotification\Job\Notify as AlarmNotificationNotifyJob;
use App\Domains\AlarmNotification\Model\AlarmNotification as AlarmNotificationModel;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class CheckPosition extends ActionAbstract
{
    /**
     * @var \App\Domains\Alarm\Service\Type\Manager
     */
    protected TypeManager $manager;

    /**
     * @var \App\Domains\Position\Model\Position
     */
    protected PositionModel $position;

    /**
     * @var \App\Domains\Vehicle\Model\Vehicle
     */
    protected VehicleModel $vehicle;

    /**
     * @var array
     */
    protected array $states = [];

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->manager();
        $this->position();
        $this->vehicle();
        $this->iterate();
        $this->save();
    }

    /**
     * @return void
     */
    protected function manager(): void
    {
        $this->manager = new TypeManager();
    }

    /**
     * @return void
     */
    protected function position(): void
    {
        $this->position = PositionModel::query()
            ->withVehicle()
            ->withTrip()
            ->findOrFail($this->data['position_id']);
    }

    /**
     * @return void
     */
    protected function vehicle(): void
    {
        $this->vehicle = $this->position->vehicle;
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->list() as $row) {
            $this->check($row);
        }
    }

    /**
     * @return \App\Domains\Alarm\Model\Collection\Alarm
     */
    protected function list(): Collection
    {
        return Model::query()
            ->enabled()
            ->byVehicleIdEnabled($this->vehicle->id)
            ->withVehiclePivot($this->vehicle->id)
            ->withNotificationLastClosedAtByVehicleId($this->vehicle->id)
            ->get();
    }

    /**
     * @param \App\Domains\Alarm\Model\Alarm $row
     *
     * @return void
     */
    protected function check(Model $row): void
    {
        $state = $this->checkState($row);

        if (($state === null) || ($state === $row->vehiclePivot->state)) {
            return;
        }

        $this->checkStateSave($row, $state);

        if ($state === false) {
            return;
        }

        if ($this->checkLast($row) === false) {
            return;
        }

        $this->checkSave($row);
    }

    /**
     * @param \App\Domains\Alarm\Model\Alarm $row
     *
     * @return ?bool
     */
    protected function checkState(Model $row): ?bool
    {
        return $this->manager->factory($row->type, $row->config)->state($this->position);
    }

    /**
     * @param \App\Domains\Alarm\Model\Alarm $row
     * @param bool $state
     *
     * @return void
     */
    protected function checkStateSave(Model $row, bool $state): void
    {
        $this->states[] = [
            'alarm_id' => $row->id,
            'vehicle_id' => $this->vehicle->id,
            'state' => $state,
        ];
    }

    /**
     * @param \App\Domains\Alarm\Model\Alarm $row
     *
     * @return bool
     */
    protected function checkLast(Model $row): bool
    {
        return empty($row->notificationLast) || $row->notificationLast->closed_at;
    }

    /**
     * @param \App\Domains\Alarm\Model\Alarm $row
     *
     * @return void
     */
    protected function checkSave(Model $row): void
    {
        $this->checkSaveJob($this->checkSaveNotification($row));
    }

    /**
     * @param \App\Domains\Alarm\Model\Alarm $row
     *
     * @return \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    protected function checkSaveNotification(Model $row): AlarmNotificationModel
    {
        return AlarmNotificationModel::query()->create([
            'name' => $row->name,
            'type' => $row->type,
            'config' => $row->config,

            'dashboard' => $row->dashboard,
            'telegram' => $row->telegram,

            'point' => AlarmNotificationModel::pointFromLatitudeLongitude($this->position->latitude, $this->position->longitude),

            'date_at' => $this->position->date_at,
            'date_utc_at' => $this->position->date_utc_at,

            'alarm_id' => $row->id,
            'position_id' => $this->position->id,
            'trip_id' => $this->position->trip->id,
            'vehicle_id' => $this->vehicle->id,
        ]);
    }

    /**
     * @param \App\Domains\AlarmNotification\Model\AlarmNotification $notification
     *
     * @return void
     */
    protected function checkSaveJob(AlarmNotificationModel $notification): void
    {
        AlarmNotificationNotifyJob::dispatch($notification->id);
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveStates();
    }

    /**
     * @return void
     */
    protected function saveStates(): void
    {
        if (empty($this->states)) {
            return;
        }

        AlarmVehicleModel::query()->upsert($this->states, ['alarm_id', 'vehicle_id'], ['state']);
    }
}

```

`app/Domains/Alarm/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Action;

use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\Alarm\Service\Type\Manager as TypeManager;

class Create extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function type(): void
    {
        $this->type = TypeManager::new()->factory($this->data['type'], $this->data['config']);
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'type' => $this->data['type'],
            'name' => $this->data['name'],
            'config' => $this->data['config'],
            'dashboard' => $this->data['dashboard'],
            'telegram' => $this->data['telegram'],
            'enabled' => $this->data['enabled'],
            'schedule_start' => $this->data['schedule_start'],
            'schedule_end' => $this->data['schedule_end'],
            'user_id' => $this->data['user_id'],
        ]);
    }
}

```

`app/Domains/Alarm/Action/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Action;

use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\Alarm\Service\Type\Format\FormatAbstract as TypeFormatAbstract;

abstract class CreateUpdateAbstract extends ActionAbstract
{
    /**
     * @var \App\Domains\Alarm\Service\Type\Format\FormatAbstract
     */
    protected TypeFormatAbstract $type;

    /**
     * @return void
     */
    abstract protected function type(): void;

    /**
     * @return void
     */
    abstract protected function save(): void;

    /**
     * @return \App\Domains\Alarm\Model\Alarm
     */
    public function handle(): Model
    {
        $this->type();
        $this->check();
        $this->data();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkType();
        $this->checkSchedule();
    }

    /**
     * @return void
     */
    protected function checkType(): void
    {
        $this->type->validate();
    }

    /**
     * @return void
     */
    protected function checkSchedule(): void
    {
        if (empty($this->data['schedule_start']) && empty($this->data['schedule_end'])) {
            return;
        }

        if (empty($this->data['schedule_start'])) {
            $this->exceptionValidator(__('alarm-create.error.schedule_start'));
        }

        if (empty($this->data['schedule_end'])) {
            $this->exceptionValidator(__('alarm-create.error.schedule_end'));
        }

        if ($this->data['schedule_start'] >= $this->data['schedule_end']) {
            $this->exceptionValidator(__('alarm-create.error.schedule_start_gt_schedule_end'));
        }
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataType();
        $this->dataConfig();
        $this->dataSchedule();
        $this->dataUserId();
    }

    /**
     * @return void
     */
    protected function dataType(): void
    {
        $this->data['type'] = $this->type->code();
    }

    /**
     * @return void
     */
    protected function dataConfig(): void
    {
        $this->data['config'] = $this->type->config();
    }

    /**
     * @return void
     */
    protected function dataSchedule(): void
    {
        $this->data['schedule_start'] = $this->data['schedule_start'] ?: null;
        $this->data['schedule_end'] = $this->data['schedule_end'] ?: null;
    }
}

```

`app/Domains/Alarm/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->delete();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }
}

```

`app/Domains/Alarm/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Action;

class Update extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function type(): void
    {
        $this->type = $this->row->typeFormat($this->data['config']);
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->name = $this->data['name'];
        $this->row->config = $this->data['config'];
        $this->row->telegram = $this->data['telegram'];
        $this->row->enabled = $this->data['enabled'];
        $this->row->schedule_start = $this->data['schedule_start'];
        $this->row->schedule_end = $this->data['schedule_end'];

        $this->row->save();
    }
}

```

`app/Domains/Alarm/Action/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Action;

use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\CoreApp\Action\UpdateBoolean as UpdateBooleanCoreApp;

class UpdateBoolean extends UpdateBooleanCoreApp
{
    /**
     * @var \App\Domains\Alarm\Model\Alarm
     */
    protected Model $row;
}

```

`app/Domains/Alarm/Action/UpdateVehicle.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Action;

use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class UpdateVehicle extends ActionAbstract
{
    /**
     * @return \App\Domains\Alarm\Model\Alarm
     */
    public function handle(): Model
    {
        $this->data();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->data['related'] = VehicleModel::query()
            ->byUserId($this->row->user_id)
            ->byIds($this->data['related'])
            ->pluck('id')
            ->all();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->vehicles()->sync($this->data['related']);
    }
}

```

`app/Domains/Alarm/Command/CheckPosition.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Command;

class CheckPosition extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'alarm:check:position {--position_id=}';

    /**
     * @var string
     */
    protected $description = 'Check Alarm Using Position {--position_id=}';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->checkOptions(['position_id']);
        $this->requestWithOptions();

        $this->factory()->action()->checkPosition();

        $this->info('[END]');
    }
}

```

`app/Domains/Alarm/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Command;

use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\CoreApp\Command\CommandAbstract as CommandAbstractSahred;

abstract class CommandAbstract extends CommandAbstractSahred
{
    /**
     * @var \App\Domains\Alarm\Model\Alarm
     */
    protected Model $row;

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = Model::query()->findOrFail($this->checkOption('id'));
    }
}

```

`app/Domains/Alarm/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller;

use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\CoreApp\Controller\ControllerWebAbstract;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\Alarm\Model\Alarm
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Alarm\Model\Alarm
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('alarm.error.not-found')));
    }
}

```

`app/Domains/Alarm/Controller/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Alarm\Controller\Service\Create as ControllerService;

class Create extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($response = $this->actionPost('create')) {
            return $response;
        }

        $this->meta('title', __('alarm-create.meta-title'));

        return $this->page('alarm.create', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function create(): RedirectResponse
    {
        $this->row = $this->action()->create();

        $this->sessionMessage('success', __('alarm-create.success'));

        return redirect()->route('alarm.update', $this->row->id);
    }
}

```

`app/Domains/Alarm/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Response;
use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\Alarm\Model\Collection\Alarm as Collection;
use App\Domains\Alarm\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse
     */
    public function __invoke(): Response|JsonResponse
    {
        if ($this->request->wantsJson()) {
            return $this->responseJson();
        }

        $this->meta('title', __('alarm-index.meta-title'));

        return $this->page('alarm.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->factory()->fractal('simple', $this->responseJsonList()));
    }

    /**
     * @return \App\Domains\Alarm\Model\Collection\Alarm
     */
    protected function responseJsonList(): Collection
    {
        return Model::query()
            ->byUserId($this->auth->id)
            ->enabled()
            ->get();
    }
}

```

`app/Domains/Alarm/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/Alarm/Controller/Service/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;

class Create extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->request();
        $this->typeManager();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCommon();
    }

    /**
     * @return ?string
     */
    protected function type(): ?string
    {
        return $this->typeManager->selected($this->request->input('type'));
    }
}

```

`app/Domains/Alarm/Controller/Service/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller\Service;

use App\Domains\Alarm\Service\Type\Manager as TypeManager;
use App\Domains\Position\Model\Position as PositionModel;

abstract class CreateUpdateAbstract extends ControllerAbstract
{
    /**
     * @var \App\Domains\Alarm\Service\Type\Manager
     */
    protected TypeManager $typeManager;

    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow([
            'user_id' => $this->user()->id,
        ]);
    }

    /**
     * @return void
     */
    protected function typeManager()
    {
        $this->typeManager = TypeManager::new();
    }

    /**
     * @return array
     */
    protected function dataCommon(): array
    {
        return $this->dataCore() + [
            'types' => $this->types(),
            'type' => $this->type(),
            'position' => $this->position(),
        ];
    }

    /**
     * @return array
     */
    protected function types(): array
    {
        return $this->typeManager->titles();
    }

    /**
     * @return ?\App\Domains\Position\Model\Position
     */
    protected function position(): ?PositionModel
    {
        if ($this->type() === null) {
            return null;
        }

        return $this->cache(
            fn () => PositionModel::query()
                ->byUserId($this->user()->id)
                ->orderByDateUtcAtDesc()
                ->first()
        );
    }
}

```

`app/Domains/Alarm/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\Alarm\Model\Collection\Alarm as Collection;

class Index extends ControllerAbstract
{
    /**
     * @var bool
     */
    protected bool $userEmpty = true;

    /**
     * @var bool
     */
    protected bool $vehicleEmpty = true;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->filters();
    }

    /**
     * @return void
     */
    protected function filters(): void
    {
        $this->filtersUserId();
        $this->filtersVehicleId();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCore() + [
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'vehicle_empty' => $this->vehicleEmpty(),
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\Alarm\Model\Collection\Alarm
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->whenVehicleId($this->vehicle()?->id)
                ->withUser()
                ->withVehiclesCount()
                ->withNotificationsCount()
                ->withNotificationsPendingCount()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Alarm/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Alarm\Model\Alarm as Model;

class Update extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Alarm\Model\Alarm $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
        $this->typeManager();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCommon() + [
            'row' => $this->row,
        ];
    }

    /**
     * @return string
     */
    protected function type(): string
    {
        return $this->row->type;
    }
}

```

`app/Domains/Alarm/Controller/Service/UpdateAlarmNotification.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\AlarmNotification\Model\AlarmNotification as AlarmNotificationModel;
use App\Domains\AlarmNotification\Model\Collection\AlarmNotification as AlarmNotificationCollection;

class UpdateAlarmNotification extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Alarm\Model\Alarm $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'notifications' => $this->notifications(),
        ];
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\Collection\AlarmNotification
     */
    protected function notifications(): AlarmNotificationCollection
    {
        return AlarmNotificationModel::query()
            ->byAlarmId($this->row->id)
            ->withVehicle()
            ->withPosition()
            ->withTrip()
            ->list()
            ->get();
    }
}

```

`app/Domains/Alarm/Controller/Service/UpdateVehicle.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\Vehicle\Model\Collection\Vehicle as VehicleCollection;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class UpdateVehicle extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Alarm\Model\Alarm $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'vehicles' => $this->vehicles(),
        ];
    }

    /**
     * @return \App\Domains\Vehicle\Model\Collection\Vehicle
     */
    protected function vehicles(): VehicleCollection
    {
        return VehicleModel::query()
            ->byUserId($this->user()->id)
            ->list()
            ->withAlarmPivot($this->row->id)
            ->get()
            ->sortByDesc('alarmPivot');
    }
}

```

`app/Domains/Alarm/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Alarm\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actions()) {
            return $response;
        }

        $this->meta('title', __('alarm-update.meta-title', ['title' => $this->row->name]));

        return $this->page('alarm.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('update')
            ?: $this->actionPost('delete');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('alarm-update.success'));

        return redirect()->route('alarm.update', $this->row->id);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function delete(): RedirectResponse
    {
        $this->action()->delete();

        $this->sessionMessage('success', __('alarm-update.delete-success'));

        return redirect()->route('alarm.index');
    }
}

```

`app/Domains/Alarm/Controller/UpdateAlarmNotification.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Alarm\Controller\Service\UpdateAlarmNotification as ControllerService;

class UpdateAlarmNotification extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        $this->meta('title', __('alarm-update-alarm-notification.meta-title', ['title' => $this->row->name]));

        return $this->page('alarm.update-alarm-notification', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }
}

```

`app/Domains/Alarm/Controller/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller;

use Illuminate\Http\JsonResponse;
use App\Domains\Alarm\Model\Alarm as Model;

class UpdateBoolean extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(int $id): JsonResponse
    {
        $this->row($id);

        return $this->json($this->fractal($this->action()->updateBoolean()));
    }

    /**
     * @param \App\Domains\Alarm\Model\Alarm $row
     *
     * @return array
     */
    protected function fractal(Model $row): array
    {
        return $this->factory()->fractal('simple', $row);
    }
}

```

`app/Domains/Alarm/Controller/UpdateVehicle.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Alarm\Controller\Service\UpdateVehicle as ControllerService;

class UpdateVehicle extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('updateVehicle')) {
            return $response;
        }

        $this->meta('title', __('alarm-update-vehicle.meta-title', ['title' => $this->row->name]));

        return $this->page('alarm.update-vehicle', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateVehicle(): RedirectResponse
    {
        $this->action()->updateVehicle();

        $this->sessionMessage('success', __('alarm-update-vehicle.success'));

        return redirect()->route('alarm.update.vehicle', $this->row->id);
    }
}

```

`app/Domains/Alarm/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth']], static function () {
    Route::get('/alarm', Index::class)->name('alarm.index');
    Route::any('/alarm/create', Create::class)->name('alarm.create');
    Route::any('/alarm/{id}', Update::class)->name('alarm.update');
    Route::any('/alarm/{id}/alarm-notification', UpdateAlarmNotification::class)->name('alarm.update.alarm-notification');
    Route::any('/alarm/{id}/vehicle', UpdateVehicle::class)->name('alarm.update.vehicle');
    Route::any('/alarm/{id}/boolean/{column}', UpdateBoolean::class)->name('alarm.update.boolean');
});

```

`app/Domains/Alarm/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Fractal;

use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\Core\Fractal\FractalAbstract;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\Alarm\Model\Alarm $row
     *
     * @return array
     */
    protected function simple(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
            'type' => $row->type,
            'dashboard' => $row->dashboard,
            'telegram' => $row->telegram,
            'enabled' => $row->enabled,
            'vehicle' => $this->fromIfLoaded('Vehicle', 'simple', $row, 'vehicle'),
        ];
    }
}

```

`app/Domains/Alarm/Job/CheckPosition.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Job;

class CheckPosition extends JobAbstract
{
    /**
     * @param int $position_id
     *
     * @return void
     */
    public function __construct(protected int $position_id)
    {
    }

    /**
     * @return array
     */
    public function middleware(): array
    {
        return [$this->middlewareWithoutOverlapping($this->position_id)->expireAfter(30)];
    }

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->factory()->action(['position_id' => $this->position_id])->checkPosition();
    }
}

```

`app/Domains/Alarm/Job/JobAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Job;

use App\Domains\Alarm\Model\Alarm as Model;
use App\Domains\Core\Job\JobAbstract as JobAbstractCore;

abstract class JobAbstract extends JobAbstractCore
{
    /**
     * @var \App\Domains\Alarm\Model\Alarm
     */
    protected Model $row;

    /**
     * @param int $id
     *
     * @return void
     */
    public function __construct(protected int $id)
    {
    }

    /**
     * @return array
     */
    public function middleware(): array
    {
        return [$this->middlewareWithoutOverlapping()->expireAfter(30)];
    }

    /**
     * @return \App\Domains\Alarm\Model\Alarm
     */
    protected function row(): Model
    {
        return $this->rowOrDeleteAndException(Model::class);
    }
}

```

`app/Domains/Alarm/Model/Alarm.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\HasOne;
use App\Domains\Alarm\Model\Builder\Alarm as Builder;
use App\Domains\Alarm\Model\Collection\Alarm as Collection;
use App\Domains\Alarm\Model\Traits\TypeFormat as TypeFormatTrait;
use App\Domains\Alarm\Test\Factory\Alarm as TestFactory;
use App\Domains\AlarmNotification\Model\AlarmNotification as AlarmNotificationModel;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\User\Model\User as UserModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class Alarm extends ModelAbstract
{
    use HasFactory;
    use TypeFormatTrait;

    /**
     * @var string
     */
    protected $table = 'alarm';

    /**
     * @const string
     */
    public const TABLE = 'alarm';

    /**
     * @const string
     */
    public const FOREIGN = 'alarm_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'config' => 'array',
        'dashboard' => 'boolean',
        'telegram' => 'boolean',
        'enabled' => 'boolean',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\Alarm\Model\Collection\Alarm
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Alarm\Model\Builder\Alarm
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Alarm\Test\Factory\Alarm
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function notifications(): HasMany
    {
        return $this->hasMany(AlarmNotificationModel::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasOne
     */
    public function notificationLast(): HasOne
    {
        return $this->hasOne(AlarmNotificationModel::class, static::FOREIGN)->latestOfMany();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(UserModel::class, UserModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasOne
     */
    public function vehiclePivot(): HasOne
    {
        return $this->hasOne(AlarmVehicle::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsToMany
     */
    public function vehicles(): BelongsToMany
    {
        return $this->belongsToMany(VehicleModel::class, AlarmVehicle::TABLE)->withTimezone();
    }
}

```

`app/Domains/Alarm/Model/AlarmVehicle.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use App\Domains\Alarm\Model\Builder\AlarmVehicle as Builder;
use App\Domains\Alarm\Model\Collection\AlarmVehicle as Collection;
use App\Domains\Alarm\Model\Traits\TypeFormat as TypeFormatTrait;
use App\Domains\Alarm\Test\Factory\AlarmVehicle as TestFactory;
use App\Domains\CoreApp\Model\PivotAbstract;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class AlarmVehicle extends PivotAbstract
{
    use HasFactory;
    use TypeFormatTrait;

    /**
     * @var string
     */
    protected $table = 'alarm_vehicle';

    /**
     * @const string
     */
    public const TABLE = 'alarm_vehicle';

    /**
     * @const string
     */
    public const FOREIGN = 'alarm_vehicle_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'state' => 'boolean',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\Alarm\Model\Collection\AlarmVehicle
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Alarm\Model\Builder\AlarmVehicle
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Alarm\Test\Factory\AlarmVehicle
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function alarm(): BelongsTo
    {
        return $this->belongsTo(Alarm::class, Alarm::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(VehicleModel::class, VehicleModel::FOREIGN)->withTimezone();
    }
}

```

`app/Domains/Alarm/Model/Builder/Alarm.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Model\Builder;

use App\Domains\Alarm\Model\AlarmVehicle as AlarmVehicleModel;
use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class Alarm extends BuilderAbstract
{
    /**
     * @param string $time
     *
     * @return self
     */
    public function bySchedule(string $time): self
    {
        return $this->where(static function ($q) use ($time) {
            $q->where(fn ($q) => $q->whereScheduleIsEmpty())
                ->orWhere(fn ($q) => $q->byScheduleStart($time)->byScheduleEnd($time));
        });
    }

    /**
     * @param string $time
     *
     * @return self
     */
    public function byScheduleEnd(string $time): self
    {
        return $this->where('schedule_end', '>=', $time);
    }

    /**
     * @param string $time
     *
     * @return self
     */
    public function byScheduleStart(string $time): self
    {
        return $this->where('schedule_start', '<=', $time);
    }

    /**
     * @param string $type
     *
     * @return self
     */
    public function byType(string $type): self
    {
        return $this->where('type', $type);
    }

    /**
     * @param int $vehicle_id
     *
     * @return self
     */
    public function byVehicleId(int $vehicle_id): self
    {
        return $this->whereIn('id', AlarmVehicleModel::query()->select('alarm_id')->byVehicleId($vehicle_id));
    }

    /**
     * @param int $vehicle_id
     *
     * @return self
     */
    public function byVehicleIdEnabled(int $vehicle_id): self
    {
        return $this->whereIn('id', AlarmVehicleModel::query()->select('alarm_id')->byVehicleIdEnabled($vehicle_id));
    }

    /**
     * @return self
     */
    public function selectRelatedSimple(): self
    {
        return $this->select('id', 'name', 'type', 'enabled', 'user_id');
    }

    /**
     * @param bool $dashboard = true
     *
     * @return self
     */
    public function whereDashboard(bool $dashboard = true): self
    {
        return $this->where('dashboard', $dashboard);
    }

    /**
     * @return self
     */
    public function whereScheduleIsEmpty(): self
    {
        return $this->whereScheduleStartIsEmpty()->whereScheduleEndIsEmpty();
    }

    /**
     * @return self
     */
    public function whereScheduleEndIsEmpty(): self
    {
        return $this->whereRaw('TRIM(COALESCE(`schedule_end`, "")) = ""');
    }

    /**
     * @return self
     */
    public function whereScheduleStartIsEmpty(): self
    {
        return $this->whereRaw('TRIM(COALESCE(`schedule_start`, "")) = ""');
    }

    /**
     * @param int $vehicle_id
     *
     * @return self
     */
    public function withVehiclePivot(int $vehicle_id): self
    {
        return $this->with(['vehiclePivot' => fn ($q) => $q->byVehicleId($vehicle_id)]);
    }

    /**
     * @return self
     */
    public function withVehicles(): self
    {
        return $this->with('vehicles');
    }

    /**
     * @return self
     */
    public function withVehiclesCount(): self
    {
        return $this->withCount('vehicles');
    }

    /**
     * @param int $vehicle_id
     *
     * @return self
     */
    public function withNotificationLastClosedAtByVehicleId(int $vehicle_id): self
    {
        return $this->with(['notificationLast' => fn ($q) => $q->select($q->addTable(['id', 'alarm_id', 'closed_at']))->byVehicleId($vehicle_id)]);
    }

    /**
     * @return self
     */
    public function withNotificationsCount(): self
    {
        return $this->withCount('notifications');
    }

    /**
     * @return self
     */
    public function withNotificationsPendingCount(): self
    {
        return $this->withCount([
            'notifications as notifications_pending_count' => fn ($q) => $q->whereClosedAt(false),
        ]);
    }
}

```

`app/Domains/Alarm/Model/Builder/AlarmVehicle.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class AlarmVehicle extends BuilderAbstract
{
    /**
     * @param int $alarm_id
     *
     * @return self
     */
    public function byAlarmId(int $alarm_id): self
    {
        return $this->where('alarm_id', $alarm_id);
    }

    /**
     * @param int $vehicle_id
     *
     * @return self
     */
    public function byVehicleId(int $vehicle_id): self
    {
        return $this->where('vehicle_id', $vehicle_id);
    }

    /**
     * @param int $vehicle_id
     *
     * @return self
     */
    public function byVehicleIdEnabled(int $vehicle_id): self
    {
        return $this->whereIn('vehicle_id', VehicleModel::query()->select('id')->byId($vehicle_id)->enabled());
    }

    /**
     * @param int $user_id
     *
     * @return self
     */
    public function byUserId(int $user_id): self
    {
        return $this->whereIn('vehicle_id', VehicleModel::query()->select('id')->byUserId($user_id));
    }
}

```

`app/Domains/Alarm/Model/Collection/Alarm.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Alarm extends CollectionAbstract
{
}

```

`app/Domains/Alarm/Model/Collection/AlarmVehicle.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class AlarmVehicle extends CollectionAbstract
{
}

```

`app/Domains/Alarm/Model/Traits/TypeFormat.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Model\Traits;

use App\Domains\Alarm\Service\Type\Format\FormatAbstract as TypeFormatAbstract;
use App\Domains\Alarm\Service\Type\Manager as TypeManager;

trait TypeFormat
{
    /**
     * @var \App\Domains\Alarm\Service\Type\Format\FormatAbstract
     */
    protected TypeFormatAbstract $typeFormat;

    /**
     * @param ?array $config = null
     *
     * @return \App\Domains\Alarm\Service\Type\Format\FormatAbstract
     */
    public function typeFormat(?array $config = null): TypeFormatAbstract
    {
        return $this->typeFormat ??= TypeManager::new()->factory($this->type, $config ?? $this->config ?? []);
    }
}

```

`app/Domains/Alarm/Service/Type/Format/FenceAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Service\Type\Format;

use App\Domains\Position\Model\Position as PositionModel;

abstract class FenceAbstract extends FormatAbstract
{
    /**
     * @param float $radius
     * @param float $distance
     *
     * @return bool
     */
    abstract protected function stateValue(float $radius, float $distance): bool;

    /**
     * @return array
     */
    public function config(): array
    {
        return [
            'latitude' => floatval($this->config['latitude'] ?? 0),
            'longitude' => floatval($this->config['longitude'] ?? 0),
            'radius' => floatval($this->config['radius'] ?? 0),
        ];
    }

    /**
     * @return void
     */
    public function validate(): void
    {
        $config = $this->config();

        if (empty($config['latitude'])) {
            $this->exceptionValidator(__('alarm-type-fence.error.latitude'));
        }

        if (empty($config['longitude'])) {
            $this->exceptionValidator(__('alarm-type-fence.error.longitude'));
        }

        if (empty($config['radius'])) {
            $this->exceptionValidator(__('alarm-type-fence.error.radius'));
        }
    }

    /**
     * @param \App\Domains\Position\Model\Position $position
     *
     * @return ?bool
     */
    public function state(PositionModel $position): ?bool
    {
        $config = $this->config();

        if (empty($config['latitude'])) {
            return null;
        }

        if (empty($config['longitude'])) {
            return null;
        }

        if (empty($config['radius'])) {
            return null;
        }

        $distance = helper()->coordinatesDistance(
            $config['latitude'],
            $config['longitude'],
            $position->latitude,
            $position->longitude,
        );

        return $this->stateValue($config['radius'] * 1000, $distance);
    }
}

```

`app/Domains/Alarm/Service/Type/Format/FenceIn.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Service\Type\Format;

class FenceIn extends FenceAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'fence-in';
    }

    /**
     * @return string
     */
    public function title(): string
    {
        return __('alarm-type-fence-in.title');
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return __('alarm-type-fence-in.message');
    }

    /**
     * @param float $radius
     * @param float $distance
     *
     * @return bool
     */
    protected function stateValue(float $radius, float $distance): bool
    {
        return $distance <= $radius;
    }
}

```

`app/Domains/Alarm/Service/Type/Format/FenceOut.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Service\Type\Format;

class FenceOut extends FenceAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'fence-out';
    }

    /**
     * @return string
     */
    public function title(): string
    {
        return __('alarm-type-fence-out.title');
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return __('alarm-type-fence-out.message');
    }

    /**
     * @param float $radius
     * @param float $distance
     *
     * @return bool
     */
    protected function stateValue(float $radius, float $distance): bool
    {
        return $distance > $radius;
    }
}

```

`app/Domains/Alarm/Service/Type/Format/FormatAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Service\Type\Format;

use App\Domains\Position\Model\Position as PositionModel;
use App\Exceptions\ValidatorException;

abstract class FormatAbstract
{
    /**
     * @return string
     */
    abstract public function code(): string;

    /**
     * @return string
     */
    abstract public function title(): string;

    /**
     * @return string
     */
    abstract public function message(): string;

    /**
     * @return void
     */
    abstract public function validate(): void;

    /**
     * @return array
     */
    abstract public function config(): array;

    /**
     * @param \App\Domains\Position\Model\Position $position
     *
     * @return ?bool
     */
    abstract public function state(PositionModel $position): ?bool;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param array $config
     *
     * @return self
     */
    public function __construct(protected array $config)
    {
    }

    /**
     * @param string $message
     *
     * @return void
     */
    protected function exceptionValidator(string $message): void
    {
        throw new ValidatorException($message);
    }
}

```

`app/Domains/Alarm/Service/Type/Format/Movement.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Service\Type\Format;

use App\Domains\Position\Model\Position as PositionModel;

class Movement extends FormatAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'movement';
    }

    /**
     * @return string
     */
    public function title(): string
    {
        return __('alarm-type-movement.title');
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return __('alarm-type-movement.message');
    }

    /**
     * @return array
     */
    public function config(): array
    {
        return [];
    }

    /**
     * @return void
     */
    public function validate(): void
    {
    }

    /**
     * @param \App\Domains\Position\Model\Position $position
     *
     * @return ?bool
     */
    public function state(PositionModel $position): ?bool
    {
        return $position->speed > 0;
    }
}

```

`app/Domains/Alarm/Service/Type/Format/Overspeed.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Service\Type\Format;

use App\Domains\Position\Model\Position as PositionModel;

class Overspeed extends FormatAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'overspeed';
    }

    /**
     * @return string
     */
    public function title(): string
    {
        return __('alarm-type-overspeed.title');
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return __('alarm-type-overspeed.message');
    }

    /**
     * @return array
     */
    public function config(): array
    {
        return [
            'speed' => intval($this->config['speed'] ?? 0),
        ];
    }

    /**
     * @return void
     */
    public function validate(): void
    {
        if ($this->config()['speed'] === 0) {
            $this->exceptionValidator(__('alarm-type-overspeed.error.speed'));
        }
    }

    /**
     * @param \App\Domains\Position\Model\Position $position
     *
     * @return ?bool
     */
    public function state(PositionModel $position): ?bool
    {
        $speed = $this->config()['speed'];

        if ($speed === 0) {
            return null;
        }

        return $position->userSpeed() > $speed;
    }
}

```

`app/Domains/Alarm/Service/Type/Format/PolygonAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Service\Type\Format;

use App\Domains\Position\Model\Position as PositionModel;

abstract class PolygonAbstract extends FormatAbstract
{
    /**
     * @param bool $inside
     *
     * @return bool
     */
    abstract protected function stateValue(bool $inside): bool;

    /**
     * @return array
     */
    public function config(): array
    {
        return [
            'geojson' => ($this->config['geojson'] = $this->configGeoJsonFromText()),
        ];
    }

    /**
     * @return array
     */
    public function configGeoJsonFromText(): array
    {
        if (is_array($this->config['geojson'] ?? null)) {
            return $this->config['geojson'];
        }

        $geojson = json_decode($this->config['geojson'] ?? '[]', true) ?: [];
        $geojson['features'][0]['properties'] = null;

        return $geojson;
    }

    /**
     * @return void
     */
    public function validate(): void
    {
        $geojson = $this->config()['geojson'];

        if (empty($geojson)) {
            $this->exceptionValidator(__('alarm-type-polygon.error.geojson'));
        }

        if (empty($geojson['type']) || ($geojson['type'] !== 'FeatureCollection')) {
            $this->exceptionValidator(__('alarm-type-polygon.error.geojson-format'));
        }

        if (empty($geojson['features']) || (count($geojson['features']) !== 1)) {
            $this->exceptionValidator(__('alarm-type-polygon.error.geojson-format'));
        }

        $feature = $geojson['features'][0];

        if (empty($feature['type']) || ($feature['type'] !== 'Feature')) {
            $this->exceptionValidator(__('alarm-type-polygon.error.geojson-format'));
        }

        if (empty($feature['geometry'])) {
            $this->exceptionValidator(__('alarm-type-polygon.error.geojson-format'));
        }

        $geometry = $feature['geometry'];

        if (empty($geometry['type']) || ($geometry['type'] !== 'Polygon')) {
            $this->exceptionValidator(__('alarm-type-polygon.error.geojson-format'));
        }

        if (empty($geometry['coordinates'])) {
            $this->exceptionValidator(__('alarm-type-polygon.error.geojson-format'));
        }

        $coordinates = $geometry['coordinates'];

        if ((is_array($coordinates) === false) || (count($coordinates) !== 1)) {
            $this->exceptionValidator(__('alarm-type-polygon.error.geojson-format'));
        }
    }

    /**
     * @param \App\Domains\Position\Model\Position $position
     *
     * @return ?bool
     */
    public function state(PositionModel $position): ?bool
    {
        $geojson = $this->config()['geojson'];

        if (empty($geojson['features'][0]['geometry']['coordinates'])) {
            return null;
        }

        $inside = helper()->latitudeLongitudeInsideGeoJson(
            $position->latitude,
            $position->longitude,
            $geojson,
        );

        return $this->stateValue($inside);
    }
}

```

`app/Domains/Alarm/Service/Type/Format/PolygonIn.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Service\Type\Format;

class PolygonIn extends PolygonAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'polygon-in';
    }

    /**
     * @return string
     */
    public function title(): string
    {
        return __('alarm-type-polygon-in.title');
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return __('alarm-type-polygon-in.message');
    }

    /**
     * @param bool $inside
     *
     * @return bool
     */
    protected function stateValue(bool $inside): bool
    {
        return $inside;
    }
}

```

`app/Domains/Alarm/Service/Type/Format/PolygonOut.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Service\Type\Format;

class PolygonOut extends PolygonAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'polygon-out';
    }

    /**
     * @return string
     */
    public function title(): string
    {
        return __('alarm-type-polygon-out.title');
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return __('alarm-type-polygon-out.message');
    }

    /**
     * @param bool $inside
     *
     * @return bool
     */
    protected function stateValue(bool $inside): bool
    {
        return $inside === false;
    }
}

```

`app/Domains/Alarm/Service/Type/Format/Vibration.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Service\Type\Format;

use App\Domains\Position\Model\Position as PositionModel;

class Vibration extends FormatAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'vibration';
    }

    /**
     * @return string
     */
    public function title(): string
    {
        return __('alarm-type-vibration.title');
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return __('alarm-type-vibration.message');
    }

    /**
     * @return array
     */
    public function config(): array
    {
        return [];
    }

    /**
     * @return void
     */
    public function validate(): void
    {
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param \App\Domains\Position\Model\Position $position
     *
     * @return ?bool
     */
    public function state(PositionModel $position): ?bool
    {
        return true;
    }
}

```

`app/Domains/Alarm/Service/Type/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Service\Type;

use App\Domains\Alarm\Service\Type\Format\FormatAbstract;
use App\Exceptions\UnexpectedValueException;

class Manager
{
    /**
     * @const
     */
    protected const FORMATS = [
        'fence-in', 'fence-out', 'movement', 'overspeed', 'polygon-in', 'polygon-out', 'vibration',
    ];

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @return array
     */
    public function titles(): array
    {
        return [
            'fence-in' => __('alarm-type-fence-in.title'),
            'fence-out' => __('alarm-type-fence-out.title'),
            'movement' => __('alarm-type-movement.title'),
            'overspeed' => __('alarm-type-overspeed.title'),
            'polygon-in' => __('alarm-type-polygon-in.title'),
            'polygon-out' => __('alarm-type-polygon-out.title'),
            'vibration' => __('alarm-type-vibration.title'),
        ];
    }

    /**
     * @param ?string $code
     *
     * @return ?string
     */
    public function selected(?string $code): ?string
    {
        return in_array($code, static::FORMATS) ? $code : null;
    }

    /**
     * @param string $code
     * @param array $config
     *
     * @return \App\Domains\Alarm\Service\Type\Format\FormatAbstract
     */
    public function factory(string $code, array $config): FormatAbstract
    {
        return $this->init($this->class($code), $config);
    }

    /**
     * @param string $code
     *
     * @return string
     */
    protected function class(string $code): string
    {
        return match ($code) {
            'fence-in' => $this->classFormat('FenceIn'),
            'fence-out' => $this->classFormat('FenceOut'),
            'movement' => $this->classFormat('Movement'),
            'overspeed' => $this->classFormat('Overspeed'),
            'polygon-in' => $this->classFormat('PolygonIn'),
            'polygon-out' => $this->classFormat('PolygonOut'),
            'vibration' => $this->classFormat('Vibration'),
            default => throw new UnexpectedValueException(__('alarm-type.error.invalid')),
        };
    }

    /**
     * @param string $class
     *
     * @return string
     */
    protected function classFormat(string $class): string
    {
        return __NAMESPACE__.'\\Format\\'.$class;
    }

    /**
     * @param string $class
     * @param array $config
     *
     * @return \App\Domains\Alarm\Service\Type\Format\FormatAbstract
     */
    protected function init(string $class, array $config): FormatAbstract
    {
        return new $class($config);
    }
}

```

`app/Domains/Alarm/Validate/CheckPosition.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class CheckPosition extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'position_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/Alarm/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'type' => ['bail', 'required'],
            'name' => ['bail', 'required'],
            'config' => ['bail', 'array'],
            'dashboard' => ['bail', 'boolean'],
            'telegram' => ['bail', 'boolean'],
            'enabled' => ['bail', 'boolean'],
            'schedule_start' => ['bail', 'nullable', 'date_format:H:i'],
            'schedule_end' => ['bail', 'nullable', 'date_format:H:i'],
            'user_id' => ['bail', 'integer'],
        ];
    }
}

```

`app/Domains/Alarm/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Update extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'config' => ['bail', 'array'],
            'dashboard' => ['bail', 'boolean'],
            'telegram' => ['bail', 'boolean'],
            'enabled' => ['bail', 'boolean'],
            'schedule_start' => ['bail', 'nullable', 'date_format:H:i'],
            'schedule_end' => ['bail', 'nullable', 'date_format:H:i'],
        ];
    }
}

```

`app/Domains/Alarm/Validate/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Validate;

use App\Domains\CoreApp\Validate\UpdateBoolean as UpdateBooleanCoreApp;

class UpdateBoolean extends UpdateBooleanCoreApp
{
}

```

`app/Domains/Alarm/Validate/UpdateVehicle.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdateVehicle extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'related' => ['bail', 'array'],
            'related.*' => ['bail', 'integer'],
        ];
    }
}

```

`app/Domains/Alarm/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Alarm\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/AlarmNotification/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Action;

use App\Domains\AlarmNotification\Model\AlarmNotification as Model;
use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\AlarmNotification\Model\AlarmNotification
     */
    protected ?Model $row;
}

```

`app/Domains/AlarmNotification/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Action;

use App\Domains\AlarmNotification\Model\AlarmNotification as Model;
use App\Domains\Core\Action\ActionFactoryAbstract;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\AlarmNotification\Model\AlarmNotification
     */
    protected ?Model $row;

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandle(Delete::class);
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    public function notify(): Model
    {
        return $this->actionHandle(Notify::class);
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    public function updateClosedAt(): Model
    {
        return $this->actionHandle(UpdateClosedAt::class);
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    public function updateSentAt(): Model
    {
        return $this->actionHandle(UpdateSentAt::class);
    }
}

```

`app/Domains/AlarmNotification/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->delete();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }
}

```

`app/Domains/AlarmNotification/Action/Notify.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Action;

use App\Domains\AlarmNotification\Model\AlarmNotification as Model;
use App\Services\Telegram\Client as TelegramClient;

class Notify extends ActionAbstract
{
    /**
     * @return \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    public function handle(): Model
    {
        $this->telegram();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function telegram(): void
    {
        if ($chatId = $this->telegramChatId()) {
            TelegramClient::new()->message($chatId, $this->telegramMessage());
        }
    }

    /**
     * @return ?int
     */
    protected function telegramChatId(): ?int
    {
        if (empty($this->row->telegram)) {
            return null;
        }

        if (TelegramClient::new()->enabled() === false) {
            return null;
        }

        $telegram = $this->row->vehicle->user->telegram;

        if (empty($telegram['username'])) {
            return null;
        }

        return $telegram['chat_id'] ?? null ?: null;
    }

    /**
     * @return string
     */
    protected function telegramMessage(): string
    {
        return __('alarm-notification-notify.telegram.message', [
            'alarm' => $this->row->alarm->name,
            'vehicle' => $this->row->vehicle->name,
            'message' => $this->row->typeFormat()->message(),
            'trip' => $this->row->trip->name,
            'trip_link' => route('trip.update.alarm-notification', $this->row->trip->id),
        ]);
    }
}

```

`app/Domains/AlarmNotification/Action/UpdateClosedAt.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Action;

use App\Domains\AlarmNotification\Model\AlarmNotification as Model;

class UpdateClosedAt extends ActionAbstract
{
    /**
     * @return \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    public function handle(): Model
    {
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        if ($this->row->closed_at) {
            return;
        }

        $this->row->closed_at = date('Y-m-d H:i:s');
        $this->row->save();
    }
}

```

`app/Domains/AlarmNotification/Action/UpdateSentAt.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Action;

use App\Domains\AlarmNotification\Model\AlarmNotification as Model;

class UpdateSentAt extends ActionAbstract
{
    /**
     * @return \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    public function handle(): Model
    {
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        if ($this->row->sent_at) {
            return;
        }

        $this->row->sent_at = date('Y-m-d H:i:s');
        $this->row->save();
    }
}

```

`app/Domains/AlarmNotification/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Controller;

use App\Domains\AlarmNotification\Model\AlarmNotification as Model;
use App\Domains\CoreApp\Controller\ControllerWebAbstract;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\AlarmNotification\Model\AlarmNotification
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('alarm-notification.error.not-found')));
    }
}

```

`app/Domains/AlarmNotification/Controller/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Controller;

use Illuminate\Http\RedirectResponse;

class Delete extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): RedirectResponse
    {
        $this->row($id);

        $this->actionCall('delete');

        return redirect()->back();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->sessionMessage('success', __('alarm-notification-update.delete-success'));

        $this->factory()->action()->delete();
    }
}

```

`app/Domains/AlarmNotification/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Response;
use App\Domains\AlarmNotification\Model\AlarmNotification as Model;
use App\Domains\AlarmNotification\Model\Collection\AlarmNotification as Collection;
use App\Domains\AlarmNotification\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse
     */
    public function __invoke(): Response|JsonResponse
    {
        if ($this->request->wantsJson()) {
            return $this->responseJson();
        }

        $this->meta('title', __('alarm-notification-index.meta-title'));

        return $this->page('alarm-notification.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->factory()->fractal('simple', $this->responseJsonList()));
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\Collection\AlarmNotification
     */
    protected function responseJsonList(): Collection
    {
        return Model::query()
            ->byUserId($this->auth->id)
            ->whereClosedAt(false)
            ->whereSentAt()
            ->withAlarm()
            ->withVehicle()
            ->get();
    }
}

```

`app/Domains/AlarmNotification/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/AlarmNotification/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\AlarmNotification\Model\AlarmNotification as Model;
use App\Domains\AlarmNotification\Model\Collection\AlarmNotification as Collection;

class Index extends ControllerAbstract
{
    /**
     * @const string
     */
    protected const DATE_REGEXP = '/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}$/';

    /**
     * @var bool
     */
    protected bool $userEmpty = true;

    /**
     * @var bool
     */
    protected bool $vehicleEmpty = true;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->filters();
    }

    /**
     * @return void
     */
    protected function filters(): void
    {
        $this->filtersUserId();
        $this->filtersVehicleId();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'users' => $this->users(),
            'users_multiple' => $this->usersMultiple(),
            'user' => $this->user(),
            'user_empty' => $this->userEmpty(),
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'vehicle_empty' => $this->vehicleEmpty(),
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\Collection\AlarmNotification
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->whenVehicleId($this->vehicle()?->id)
                ->withAlarm()
                ->withPosition()
                ->withTrip()
                ->withUser()
                ->withVehicle()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/AlarmNotification/Controller/UpdateClosedAt.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;

class UpdateClosedAt extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): JsonResponse|RedirectResponse
    {
        $this->row($id);

        $this->actionCall('updateClosedAt');

        if ($this->request->wantsJson()) {
            return $this->json($this->factory()->fractal('simple', $this->row));
        }

        return redirect()->back();
    }

    /**
     * @return void
     */
    protected function updateClosedAt(): void
    {
        $this->factory()->action()->updateClosedAt();
    }
}

```

`app/Domains/AlarmNotification/Controller/UpdateSentAt.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;

class UpdateSentAt extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): JsonResponse|RedirectResponse
    {
        $this->row($id);

        $this->actionCall('updateSentAt');

        if ($this->request->wantsJson()) {
            return $this->json($this->factory()->fractal('simple', $this->row));
        }

        return redirect()->back();
    }

    /**
     * @return void
     */
    protected function updateSentAt(): void
    {
        $this->factory()->action()->updateSentAt();
    }
}

```

`app/Domains/AlarmNotification/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth']], static function () {
    Route::get('/alarm-notification', Index::class)->name('alarm-notification.index');
    Route::any('/alarm-notification/{id}/delete', Delete::class)->name('alarm-notification.delete');
    Route::any('/alarm-notification/{id}/closed-at', UpdateClosedAt::class)->name('alarm-notification.update.closed-at');
    Route::any('/alarm-notification/{id}/sent-at', UpdateSentAt::class)->name('alarm-notification.update.sent-at');
});

```

`app/Domains/AlarmNotification/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Fractal;

use App\Domains\AlarmNotification\Model\AlarmNotification as Model;
use App\Domains\Core\Fractal\FractalAbstract;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\AlarmNotification\Model\AlarmNotification $row
     *
     * @return array
     */
    protected function simple(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
            'type' => $row->type,
            'title' => $row->typeFormat()->title(),
            'message' => $row->typeFormat()->message(),
            'latitude' => $row->latitude,
            'longitude' => $row->longitude,
            'vehicle' => $this->fromIfLoaded('Vehicle', 'simple', $row, 'vehicle'),
            'alarm' => $this->fromIfLoaded('Alarm', 'simple', $row, 'alarm'),
        ];
    }
}

```

`app/Domains/AlarmNotification/Job/JobAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Job;

use App\Domains\AlarmNotification\Model\AlarmNotification as Model;
use App\Domains\Core\Job\JobAbstract as JobAbstractCore;

abstract class JobAbstract extends JobAbstractCore
{
    /**
     * @var \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    protected Model $row;

    /**
     * @param int $id
     *
     * @return void
     */
    public function __construct(protected int $id)
    {
    }

    /**
     * @return array
     */
    public function middleware(): array
    {
        return [$this->middlewareWithoutOverlapping()->expireAfter(30)];
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    protected function row(): Model
    {
        return $this->rowOrDeleteAndException(Model::class);
    }
}

```

`app/Domains/AlarmNotification/Job/Notify.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Job;

class Notify extends JobAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->factory(row: $this->row())->action()->notify();
    }
}

```

`app/Domains/AlarmNotification/Model/AlarmNotification.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasOneThrough;
use App\Domains\Alarm\Model\Alarm as AlarmModel;
use App\Domains\Alarm\Model\Traits\TypeFormat as TypeFormatTrait;
use App\Domains\AlarmNotification\Model\Builder\AlarmNotification as Builder;
use App\Domains\AlarmNotification\Model\Collection\AlarmNotification as Collection;
use App\Domains\AlarmNotification\Test\Factory\AlarmNotification as TestFactory;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\CoreApp\Model\Traits\Gis as GisTrait;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as TripModel;
use App\Domains\User\Model\User as UserModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class AlarmNotification extends ModelAbstract
{
    use GisTrait;
    use HasFactory;
    use TypeFormatTrait;

    /**
     * @var string
     */
    protected $table = 'alarm_notification';

    /**
     * @const string
     */
    public const TABLE = 'alarm_notification';

    /**
     * @const string
     */
    public const FOREIGN = 'alarm_notification_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'config' => 'array',
        'dashboard' => 'boolean',
        'telegram' => 'boolean',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\AlarmNotification\Model\Collection\AlarmNotification
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\AlarmNotification\Model\Builder\AlarmNotification
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\AlarmNotification\Test\Factory\AlarmNotification
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function alarm(): BelongsTo
    {
        return $this->belongsTo(AlarmModel::class, AlarmModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function position(): BelongsTo
    {
        return $this->belongsTo(PositionModel::class, PositionModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function trip(): BelongsTo
    {
        return $this->belongsTo(TripModel::class, TripModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasOneThrough
     */
    public function user(): HasOneThrough
    {
        return $this->hasOneThrough(UserModel::class, VehicleModel::class, 'vehicle.id', 'user.id', 'vehicle_id', 'user_id');
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(VehicleModel::class, VehicleModel::FOREIGN)->withTimezone();
    }
}

```

`app/Domains/AlarmNotification/Model/Builder/AlarmNotification.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class AlarmNotification extends BuilderAbstract
{
    /**
     * @param int $alarm_id
     *
     * @return self
     */
    public function byAlarmId(int $alarm_id): self
    {
        return $this->where('alarm_id', $alarm_id);
    }

    /**
     * @param int $trip_id
     *
     * @return self
     */
    public function byTripId(int $trip_id): self
    {
        return $this->where('trip_id', $trip_id);
    }

    /**
     * @param int $user_id
     *
     * @return self
     */
    public function byUserId(int $user_id): self
    {
        return $this->whereIn('vehicle_id', VehicleModel::query()->select('id')->byUserId($user_id));
    }

    /**
     * @param bool $closed_at
     *
     * @return self
     */
    public function whereClosedAt(bool $closed_at): self
    {
        return $this->when(
            $closed_at,
            fn ($q) => $q->whereNotNull('closed_at'),
            fn ($q) => $q->whereNull('closed_at')
        );
    }

    /**
     * @param bool $dashboard = true
     *
     * @return self
     */
    public function whereDashboard(bool $dashboard = true): self
    {
        return $this->where('dashboard', $dashboard);
    }

    /**
     * @param bool $sent_at = false
     *
     * @return self
     */
    public function whereSentAt(bool $sent_at = false): self
    {
        return $this->when(
            $sent_at,
            fn ($q) => $q->whereNotNull('sent_at'),
            fn ($q) => $q->whereNull('sent_at')
        );
    }

    /**
     * @return self
     */
    public function withAlarm(): self
    {
        return $this->with('alarm');
    }

    /**
     * @return self
     */
    public function withPosition(): self
    {
        return $this->with('position');
    }

    /**
     * @return self
     */
    public function withTrip(): self
    {
        return $this->with('trip');
    }

    /**
     * @return self
     */
    public function withVehicle(): self
    {
        return $this->with('vehicle');
    }
}

```

`app/Domains/AlarmNotification/Model/Collection/AlarmNotification.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class AlarmNotification extends CollectionAbstract
{
}

```

`app/Domains/AlarmNotification/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Update extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'config' => ['bail', 'array'],
            'enabled' => ['bail', 'boolean'],
        ];
    }
}

```

`app/Domains/AlarmNotification/Validate/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Validate;

use App\Domains\CoreApp\Validate\UpdateBoolean as UpdateBooleanCoreApp;

class UpdateBoolean extends UpdateBooleanCoreApp
{
}

```

`app/Domains/AlarmNotification/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\AlarmNotification\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/City/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Action;

use App\Domains\City\Model\City as Model;
use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\City\Model\City
     */
    protected ?Model $row;
}

```

`app/Domains/City/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Action;

use App\Domains\City\Model\City as Model;
use App\Domains\Core\Action\ActionFactoryAbstract;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\City\Model\City
     */
    protected ?Model $row;

    /**
     * @return ?\App\Domains\City\Model\City
     */
    public function getOrNew(): ?Model
    {
        return $this->actionHandle(GetOrNew::class, $this->validate()->getOrNew());
    }

    /**
     * @return \App\Domains\City\Model\City
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\City\Model\City
     */
    public function updateMerge(): Model
    {
        return $this->actionHandle(UpdateMerge::class, $this->validate()->updateMerge());
    }
}

```

`app/Domains/City/Action/GetOrNew.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Action;

use App\Domains\City\Model\City as Model;
use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\State\Model\State as StateModel;
use App\Services\Locate\LocateFactory;
use App\Services\Locate\Resource as LocateResource;

class GetOrNew extends ActionAbstract
{
    /**
     * @var ?\App\Services\Locate\Resource
     */
    protected ?LocateResource $locate;

    /**
     * @var \App\Domains\Country\Model\Country
     */
    protected CountryModel $country;

    /**
     * @var \App\Domains\State\Model\State
     */
    protected StateModel $state;

    /**
     * @return ?\App\Domains\City\Model\City
     */
    public function handle(): ?Model
    {
        $this->locate();

        if ($this->locateIsValid() === false) {
            return $this->near();
        }

        $this->country();
        $this->state();
        $this->row();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function locate(): void
    {
        $this->locate = LocateFactory::new($this->data['latitude'], $this->data['longitude'])->locate();
    }

    /**
     * @return bool
     */
    protected function locateIsValid(): bool
    {
        return $this->locate
            && $this->locate->city
            && $this->locate->state
            && $this->locate->country;
    }

    /**
     * @return ?\App\Domains\City\Model\City
     */
    protected function near(): ?Model
    {
        return Model::query()
            ->selectDistance($this->data['latitude'], $this->data['longitude'])
            ->byDistanceMax(1000)
            ->orderByDistance()
            ->first();
    }

    /**
     * @return void
     */
    protected function country(): void
    {
        $this->country = $this->factory('Country')->action($this->countryData())->getOrNew();
    }

    /**
     * @return array
     */
    protected function countryData(): array
    {
        return [
            'name' => $this->locate->country,
            'code' => $this->locate->country_code,
        ];
    }

    /**
     * @return void
     */
    protected function state(): void
    {
        $this->state = $this->factory('State')->action($this->stateData())->getOrNew();
    }

    /**
     * @return array
     */
    protected function stateData(): array
    {
        return [
            'name' => $this->locate->state,
            'country_id' => $this->country->id,
        ];
    }

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = $this->rowByName()
            ?: $this->rowByAlias()
            ?: $this->rowByCreate();
    }

    /**
     * @return ?\App\Domains\City\Model\City
     */
    protected function rowByName(): ?Model
    {
        return Model::query()
            ->byName($this->locate->city)
            ->byStateId($this->state->id)
            ->byCountryId($this->country->id)
            ->first();
    }

    /**
     * @return ?\App\Domains\City\Model\City
     */
    protected function rowByAlias(): ?Model
    {
        return Model::query()
            ->byAlias($this->locate->city)
            ->byStateId($this->state->id)
            ->byCountryId($this->country->id)
            ->first();
    }

    /**
     * @return \App\Domains\City\Model\City
     */
    protected function rowByCreate(): Model
    {
        return Model::query()->create([
            'name' => $this->locate->city,
            'state_id' => $this->state->id,
            'country_id' => $this->country->id,
            'point' => Model::pointFromLatitudeLongitude($this->data['latitude'], $this->data['longitude']),
        ]);
    }
}

```

`app/Domains/City/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Action;

use App\Domains\City\Model\City as Model;
use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\State\Model\State as StateModel;

class Update extends ActionAbstract
{
    /**
     * @var bool
     */
    protected bool $relocate;

    /**
     * @return \App\Domains\City\Model\City
     */
    public function handle(): Model
    {
        $this->relocate();
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function relocate(): void
    {
        $this->relocate = ($this->data['state_id'] !== $this->row->state_id)
            || ($this->data['country_id'] !== $this->row->country_id);
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataAlias();
        $this->dataPoint();
    }

    /**
     * @return void
     */
    protected function dataAlias(): void
    {
        $this->data['alias'] = array_filter(array_map('trim', explode(',', $this->data['alias'])));
    }

    /**
     * @return void
     */
    protected function dataPoint(): void
    {
        $this->data['point'] = Model::pointFromLatitudeLongitude(
            round($this->data['latitude'], 5),
            round($this->data['longitude'], 5),
        );
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkStateId();
        $this->checkCountryId();
    }

    /**
     * @return void
     */
    protected function checkStateId(): void
    {
        if ($this->checkStateIdExists() === false) {
            $this->exceptionValidator(__('city-update.error.state-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkStateIdExists(): bool
    {
        return StateModel::query()
            ->byId($this->data['state_id'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkCountryId(): void
    {
        if ($this->checkCountryIdExists() === false) {
            $this->exceptionValidator(__('city-update.error.country-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkCountryIdExists(): bool
    {
        return CountryModel::query()
            ->byId($this->data['country_id'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->name = $this->data['name'];
        $this->row->alias = $this->data['alias'];
        $this->row->point = $this->data['point'];
        $this->row->state_id = $this->data['state_id'];
        $this->row->country_id = $this->data['country_id'];
        $this->row->save();
    }
}

```

`app/Domains/City/Action/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Action;

use App\Domains\City\Model\City as Model;
use App\Domains\City\Model\Collection\City as Collection;

class UpdateMerge extends ActionAbstract
{
    /**
     * @var \App\Domains\City\Model\Collection\City
     */
    protected Collection $list;

    /**
     * @return \App\Domains\City\Model\City
     */
    public function handle(): Model
    {
        $this->list();
        $this->data();
        $this->check();
        $this->save();
        $this->delete();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function list(): void
    {
        $this->list = Model::query()
            ->byIdNot($this->row->id)
            ->byIds($this->data['ids'])
            ->get();
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataIds();
        $this->dataAlias();
    }

    /**
     * @return void
     */
    protected function dataIds(): void
    {
        $this->data['ids'] = $this->list->pluck('id')->all();
    }

    /**
     * @return void
     */
    protected function dataAlias(): void
    {
        $this->data['alias'] = array_unique(array_filter(array_merge(
            (array)$this->row->alias,
            $this->list->pluck('name')->all(),
            ...array_filter($this->list->pluck('alias')->all())
        )));
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        if ($this->list->isEmpty()) {
            $this->exceptionValidator(__('city-update-merge.error.ids-empty'));
        }
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->alias = $this->data['alias'];
        $this->row->save();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        Model::query()
            ->byIds($this->data['ids'])
            ->delete();
    }
}

```

`app/Domains/City/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Controller;

use App\Domains\City\Model\City as Model;
use App\Domains\CoreApp\Controller\ControllerWebAbstract;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\City\Model\City
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\City\Model\City
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->firstOr(fn () => $this->exceptionNotFound(__('city.error.not-found')));
    }
}

```

`app/Domains/City/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Controller;

use Illuminate\Http\Response;
use App\Domains\City\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('city-index.meta-title'));

        return $this->page('city.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/City/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/City/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\City\Model\City as Model;
use App\Domains\City\Model\Collection\City as Collection;

class Index extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\City\Model\Collection\City
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->list()
                ->withState()
                ->withCountry()
                ->get()
        );
    }
}

```

`app/Domains/City/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\City\Model\City as Model;
use App\Domains\Country\Model\Collection\Country as CountryCollection;
use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\State\Model\Collection\State as StateCollection;
use App\Domains\State\Model\State as StateModel;

class Update extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\City\Model\City $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
    }

    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow(data: ['alias' => $this->requestAlias()]);
    }

    /**
     * @return string
     */
    protected function requestAlias(): string
    {
        return $this->request->input('alias')
            ?: implode(',', $this->row->alias ?? []);
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'states' => $this->states(),
            'countries' => $this->countries(),
        ];
    }

    /**
     * @return \App\Domains\State\Model\Collection\State
     */
    protected function states(): StateCollection
    {
        return StateModel::query()
            ->withCountry()
            ->get()
            ->each(static fn ($each) => $each->name = $each->country->name.' - '.$each->name)
            ->sortBy('name');
    }

    /**
     * @return \App\Domains\Country\Model\Collection\Country
     */
    protected function countries(): CountryCollection
    {
        return CountryModel::query()
            ->list()
            ->get();
    }
}

```

`app/Domains/City/Controller/Service/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\City\Model\City as Model;
use App\Domains\City\Model\Collection\City as Collection;

class UpdateMerge extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\City\Model\City $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\City\Model\Collection\City
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->byIdNot($this->row->id)
                ->withState()
                ->withCountry()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/City/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\City\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('update')) {
            return $response;
        }

        $this->meta('title', __('city-update.meta-title', ['title' => $this->row->name]));

        return $this->page('city.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('city-update.success'));

        return redirect()->route('city.update', $this->row->id);
    }
}

```

`app/Domains/City/Controller/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\City\Controller\Service\UpdateMerge as ControllerService;

class UpdateMerge extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('updateMerge')) {
            return $response;
        }

        $this->meta('title', __('city-update-merge.meta-title', ['title' => $this->row->name]));

        return $this->page('city.update-merge', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateMerge(): RedirectResponse
    {
        $this->action()->updateMerge();

        $this->sessionMessage('success', __('city-update-merge.success'));

        return redirect()->route('city.update.merge', $this->row->id);
    }
}

```

`app/Domains/City/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth-admin-mode']], static function () {
    Route::get('/city', Index::class)->name('city.index');
    Route::any('/city/{id}', Update::class)->name('city.update');
    Route::any('/city/{id}/merge', UpdateMerge::class)->name('city.update.merge');
});

```

`app/Domains/City/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Fractal;

use App\Domains\City\Model\City as Model;
use App\Domains\Core\Fractal\FractalAbstract;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\City\Model\City $row
     *
     * @return array
     */
    protected function related(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
        ];
    }
}

```

`app/Domains/City/Model/Builder/City.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\Position\Model\Position as PositionModel;

class City extends BuilderAbstract
{
    /**
     * @param string $alias
     *
     * @return self
     */
    public function byAlias(string $alias): self
    {
        return $this->whereJsonContains('alias', $alias);
    }

    /**
     * @param int $country_id
     *
     * @return self
     */
    public function byCountryId(int $country_id): self
    {
        return $this->where('country_id', $country_id);
    }

    /**
     * @param array $country_ids
     *
     * @return self
     */
    public function byCountryIds(array $country_ids): self
    {
        return $this->whereIntegerInRaw('country_id', $country_ids);
    }

    /**
     * @param int $distance
     *
     * @return self
     */
    public function byDistanceMax(int $distance): self
    {
        return $this->having('distance', '<=', $distance);
    }

    /**
     * @param int $device_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     * @param ?string $start_end
     *
     * @return self
     */
    public function byDeviceIdWhenTripStartUtcAtDateBetween(int $device_id, ?string $before_start_utc_at, ?string $after_start_utc_at, ?string $start_end): self
    {
        return $this->whereIn('id', PositionModel::query()->select('city_id')->byDeviceIdWhenTripStartUtcAtDateBetween($device_id, $before_start_utc_at, $after_start_utc_at, $start_end));
    }

    /**
     * @param string $name
     *
     * @return self
     */
    public function byName(string $name): self
    {
        return $this->where('name', $name);
    }

    /**
     * @param int $state_id
     *
     * @return self
     */
    public function byStateId(int $state_id): self
    {
        return $this->where('state_id', $state_id);
    }

    /**
     * @param array $state_ids
     *
     * @return self
     */
    public function byStateIds(array $state_ids): self
    {
        return $this->whereIntegerInRaw('state_id', $state_ids);
    }

    /**
     * @param int $vehicle_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     * @param ?string $start_end
     *
     * @return self
     */
    public function byVehicleIdWhenTripStartUtcAtDateBetween(int $vehicle_id, ?string $before_start_utc_at, ?string $after_start_utc_at, ?string $start_end): self
    {
        return $this->whereIn('id', PositionModel::query()->select('city_id')->byVehicleIdWhenTripStartUtcAtDateBetween($vehicle_id, $before_start_utc_at, $after_start_utc_at, $start_end));
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->select(
            'id',
            'name',
            'alias',
            'latitude',
            'longitude',
            'created_at',
            'updated_at',
            'state_id',
            'country_id'
        )->orderBy('name', 'ASC');
    }

    /**
     * @return self
     */
    public function orderByDistance(): self
    {
        return $this->orderBy('distance', 'ASC');
    }

    /**
     * @return self
     */
    public function selectRelated(): self
    {
        return $this->select('id', 'name', 'state_id', 'country_id')->withSimple('state');
    }

    /**
     * @param float $latitude
     * @param float $longitude
     *
     * @return self
     */
    public function selectDistance(float $latitude, float $longitude): self
    {
        return $this->selectRaw(sprintf(
            '*, ST_Distance_Sphere(`point`, ST_SRID(POINT(%f, %f), 4326)) `distance`',
            helper()->longitude($longitude),
            helper()->latitude($latitude),
        ));
    }

    /**
     * @param ?int $country_id
     *
     * @return self
     */
    public function whenCountryId(?int $country_id): self
    {
        return $this->when($country_id, fn ($q) => $q->byCountryId($country_id));
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_date_at
     * @param ?string $after_date_at
     *
     * @return self
     */
    public function whenRefuelUserIdVehicleIdDateAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_date_at, ?string $after_date_at): self
    {
        return $this->whereIn('id', PositionModel::query()->select('city_id')->whenRefuelUserIdVehicleIdDateAtBetween($user_id, $vehicle_id, $before_date_at, $after_date_at));
    }

    /**
     * @param ?int $state_id
     *
     * @return self
     */
    public function whenStateId(?int $state_id): self
    {
        return $this->when($state_id, fn ($q) => $q->byStateId($state_id));
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_start_at
     * @param ?string $after_start_at
     *
     * @return self
     */
    public function whenTripUserIdVehicleIdStartAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_start_at, ?string $after_start_at): self
    {
        return $this->whereIn('id', PositionModel::query()->select('city_id')->whenTripUserIdVehicleIdStartAtBetween($user_id, $vehicle_id, $before_start_at, $after_start_at));
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     *
     * @return self
     */
    public function whenTripUserIdVehicleIdStartUtcAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_start_utc_at, ?string $after_start_utc_at): self
    {
        return $this->whereIn('id', PositionModel::query()->select('city_id')->whenTripUserIdVehicleIdStartUtcAtBetween($user_id, $vehicle_id, $before_start_utc_at, $after_start_utc_at));
    }

    /**
     * @return self
     */
    public function withCountry(): self
    {
        return $this->with('country');
    }

    /**
     * @return self
     */
    public function withState(): self
    {
        return $this->with('state');
    }
}

```

`app/Domains/City/Model/City.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use App\Domains\City\Model\Builder\City as Builder;
use App\Domains\City\Model\Collection\City as Collection;
use App\Domains\City\Test\Factory\City as TestFactory;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\CoreApp\Model\Traits\Gis as GisTrait;
use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\State\Model\State as StateModel;

class City extends ModelAbstract
{
    use GisTrait;
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'city';

    /**
     * @const string
     */
    public const TABLE = 'city';

    /**
     * @const string
     */
    public const FOREIGN = 'city_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'alias' => 'array',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\City\Model\Collection\City
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\City\Model\Builder\City
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\City\Test\Factory\City
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function country(): BelongsTo
    {
        return $this->belongsTo(CountryModel::class, CountryModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function state(): BelongsTo
    {
        return $this->belongsTo(StateModel::class, StateModel::FOREIGN);
    }

    /**
     * @return string
     */
    public function latitudeLongitudeUrl(): string
    {
        return sprintf('https://maps.google.com/?q=%s,%s', $this->latitude, $this->longitude);
    }

    /**
     * @return string
     */
    public function latitudeLongitudeLink(): string
    {
        return sprintf(
            '<a href="%s" rel="nofollow noopener noreferrer" target="_blank">%.5f,%.5f</a>',
            $this->latitudeLongitudeUrl(),
            $this->latitude,
            $this->longitude,
        );
    }
}

```

`app/Domains/City/Model/Collection/City.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class City extends CollectionAbstract
{
}

```

`app/Domains/City/Validate/GetOrNew.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class GetOrNew extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'latitude' => ['bail', 'required', 'numeric', 'between:-90,90'],
            'longitude' => ['bail', 'required', 'numeric', 'between:-180,180'],
        ];
    }
}

```

`app/Domains/City/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Update extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'alias' => ['bail', 'string'],
            'latitude' => ['bail', 'numeric', 'required'],
            'longitude' => ['bail', 'numeric', 'required'],
            'state_id' => ['bail', 'required', 'integer'],
            'country_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/City/Validate/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdateMerge extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'ids' => ['bail', 'required', 'array'],
        ];
    }
}

```

`app/Domains/City/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\City\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Configuration/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Action;

use App\Domains\Configuration\Model\Configuration as Model;
use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Configuration\Model\Configuration
     */
    protected ?Model $row;
}

```

`app/Domains/Configuration/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Action;

use App\Domains\Configuration\Model\Configuration as Model;
use App\Domains\Core\Action\ActionFactoryAbstract;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Configuration\Model\Configuration
     */
    protected ?Model $row;

    /**
     * @return void
     */
    public function appBind(): void
    {
        $this->actionHandle(AppBind::class);
    }

    /**
     * @return mixed
     */
    public function dump(): mixed
    {
        return $this->actionHandle(Dump::class, $this->validate()->dump());
    }

    /**
     * @return \App\Domains\Configuration\Model\Configuration
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }
}

```

`app/Domains/Configuration/Action/AppBind.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Action;

use App\Domains\Configuration\Model\Configuration as Model;
use App\Domains\Configuration\Service\Getter\Getter as GetterService;

class AppBind extends ActionAbstract
{
    /**
     * @var \App\Domains\Configuration\Service\Getter\Getter
     */
    protected GetterService $getter;

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->getter();
        $this->bind();
    }

    /**
     * @return void
     */
    protected function getter(): void
    {
        $this->getter = new GetterService($this->list());
    }

    /**
     * @return array
     */
    protected function list(): array
    {
        return $this->listAvailable()
            ? Model::query()->pluck('value', 'key')->all()
            : [];
    }

    /**
     * @return bool
     */
    protected function listAvailable(): bool
    {
        return Model::schema()->hasTable(Model::TABLE);
    }

    /**
     * @return void
     */
    protected function bind(): void
    {
        app()->bind('configuration', fn () => $this->getter);
    }
}

```

`app/Domains/Configuration/Action/Dump.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Action;

use App\Domains\Configuration\Model\Configuration as Model;

class Dump extends ActionAbstract
{
    /**
     * @return mixed
     */
    public function handle(): mixed
    {
        if ($this->data['config']) {
            return $this->config();
        }

        if ($this->data['server']) {
            return $this->server();
        }

        return $this->database();
    }

    /**
     * @return mixed
     */
    protected function config(): mixed
    {
        return $this->data['only']
            ? $this->configOnly()
            : $this->configAll();
    }

    /**
     * @return mixed
     */
    protected function configOnly(): mixed
    {
        return config($this->data['only']);
    }

    /**
     * @return array
     */
    protected function configAll(): array
    {
        $values = config()->all();

        ksort($values);

        return $values;
    }

    /**
     * @return mixed
     */
    protected function server(): mixed
    {
        return $this->data['only']
            ? $this->serverOnly()
            : $this->serverAll();
    }

    /**
     * @return mixed
     */
    protected function serverOnly(): mixed
    {
        return env($this->data['only']) ?? null;
    }

    /**
     * @return array
     */
    protected function serverAll(): array
    {
        $env = $_ENV;

        ksort($env);

        return $env;
    }

    /**
     * @return array|string|null
     */
    protected function database(): array|string|null
    {
        return $this->data['only']
            ? $this->databaseOnly()
            : $this->databaseAll();
    }

    /**
     * @return ?string
     */
    protected function databaseOnly(): ?string
    {
        return Model::query()->byKey($this->data['only'])->value('value');
    }

    /**
     * @return array
     */
    protected function databaseAll(): array
    {
        return Model::query()->list()->get()->toArray();
    }
}

```

`app/Domains/Configuration/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Action;

use App\Domains\Configuration\Model\Configuration as Model;

class Update extends ActionAbstract
{
    /**
     * @return \App\Domains\Configuration\Model\Configuration
     */
    public function handle(): Model
    {
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->value = $this->data['value'];
        $this->row->description = $this->data['description'];
        $this->row->updated_at = date('Y-m-d H:i:s');

        $this->row->save();
    }
}

```

`app/Domains/Configuration/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Command;

use App\Domains\CoreApp\Command\CommandAbstract as CommandAbstractSahred;

abstract class CommandAbstract extends CommandAbstractSahred
{
}

```

`app/Domains/Configuration/Command/Dump.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Command;

class Dump extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'configuration:dump {--config} {--server} {--only=}';

    /**
     * @var string
     */
    protected $description = 'Dump Configuration by {--config} {--server} or {--only=}';

    /**
     * @return void
     */
    public function handle()
    {
        $this->info('START');

        $this->requestWithOptions();

        dump($this->factory()->action()->dump());

        $this->info('END');
    }
}

```

`app/Domains/Configuration/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Controller;

use App\Domains\Configuration\Model\Configuration as Model;
use App\Domains\CoreApp\Controller\ControllerWebAbstract;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\Configuration\Model\Configuration
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Configuration\Model\Configuration
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->firstOr(fn () => $this->exceptionNotFound(__('configuration.error.not-found')));
    }
}

```

`app/Domains/Configuration/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Controller;

use Illuminate\Http\Response;
use App\Domains\Configuration\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('configuration-index.meta-title'));

        return $this->page('configuration.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Configuration/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/Configuration/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Configuration\Model\Collection\Configuration as Collection;
use App\Domains\Configuration\Model\Configuration as Model;

class Index extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\Configuration\Model\Collection\Configuration
     */
    protected function list(): Collection
    {
        return Model::query()
            ->list()
            ->get();
    }
}

```

`app/Domains/Configuration/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Configuration\Model\Configuration as Model;

class Update extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Configuration\Model\Configuration $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
        ];
    }
}

```

`app/Domains/Configuration/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Configuration\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('update')) {
            return $response;
        }

        $this->requestMergeWithRow();

        $this->meta('title', __('configuration-update.meta-title', ['title' => $this->row->key]));

        return $this->page('configuration.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('configuration-update.success'));

        return redirect()->route('configuration.update', $this->row->id);
    }
}

```

`app/Domains/Configuration/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth-admin']], static function () {
    Route::get('/configuration', Index::class)->name('configuration.index');
    Route::any('/configuration/{id}', Update::class)->name('configuration.update');
});

```

`app/Domains/Configuration/Model/Builder/Configuration.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class Configuration extends BuilderAbstract
{
    /**
     * @param string $key
     *
     * @return self
     */
    public function byKey(string $key): self
    {
        return $this->where('key', $key);
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderBy('key', 'ASC');
    }
}

```

`app/Domains/Configuration/Model/Collection/Configuration.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Configuration extends CollectionAbstract
{
}

```

`app/Domains/Configuration/Model/Configuration.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use App\Domains\Configuration\Model\Builder\Configuration as Builder;
use App\Domains\Configuration\Model\Collection\Configuration as Collection;
use App\Domains\Configuration\Test\Factory\Configuration as TestFactory;
use App\Domains\CoreApp\Model\ModelAbstract;

class Configuration extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'configuration';

    /**
     * @const string
     */
    public const TABLE = 'configuration';

    /**
     * @const string
     */
    public const FOREIGN = 'configuration_id';

    /**
     * @param array $models
     *
     * @return \App\Domains\Configuration\Model\Collection\Configuration
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Configuration\Model\Builder\Configuration
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Configuration\Test\Factory\Configuration
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }
}

```

`app/Domains/Configuration/Seeder/Configuration.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Seeder;

use App\Domains\Configuration\Model\Configuration as Model;
use App\Domains\Core\Seeder\SeederAbstract;

class Configuration extends SeederAbstract
{
    /**
     * @return void
     */
    public function run(): void
    {
        $this->insertWithoutDuplicates(Model::class, 'key', $this->json('configuration'));
    }
}

```

`app/Domains/Configuration/Service/Getter/Getter.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Service\Getter;

class Getter
{
    /**
     * @param array $list
     *
     * @return self
     */
    public function __construct(protected readonly array $list)
    {
    }

    /**
     * @return bool
     */
    public function available(): bool
    {
        return empty($this->list) === false;
    }

    /**
     * @param string $key
     *
     * @return bool
     */
    public function bool(string $key): bool
    {
        return filter_var($this->list[$key] ?? false, FILTER_VALIDATE_BOOLEAN);
    }

    /**
     * @param string $key
     *
     * @return float
     */
    public function float(string $key): float
    {
        return floatval($this->list[$key] ?? 0);
    }

    /**
     * @param string $key
     *
     * @return int
     */
    public function int(string $key): int
    {
        return intval($this->list[$key] ?? 0);
    }

    /**
     * @param string $key
     *
     * @return string
     */
    public function string(string $key): string
    {
        return strval($this->list[$key] ?? '');
    }
}

```

`app/Domains/Configuration/Validate/Dump.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Dump extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'config' => ['bail', 'boolean'],
            'server' => ['bail', 'boolean'],
            'only' => ['bail', 'string', 'nullable'],
        ];
    }
}

```

`app/Domains/Configuration/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Update extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'value' => ['bail', 'required'],
            'description' => ['bail', 'required'],
        ];
    }
}

```

`app/Domains/Configuration/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Configuration\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Core/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Action;

use Closure;
use Throwable;
use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\App;
use Illuminate\Support\Facades\Log;
use App\Domains\Core\Model\ModelAbstract;
use App\Domains\Core\Traits\Factory;
use App\Exceptions\NotFoundException;
use App\Exceptions\ValidatorException;

abstract class ActionAbstract
{
    use Factory;

    /**
     * @param ?\Illuminate\Http\Request $request = null
     * @param ?\Illuminate\Contracts\Auth\Authenticatable $auth = null
     * @param ?\App\Domains\Core\Model\ModelAbstract $row = null
     * @param array $data = []
     *
     * @return self
     */
    final public function __construct(?Request $request = null, ?Authenticatable $auth = null, ?ModelAbstract $row = null, array $data = [])
    {
        $this->request = $request;
        $this->auth = $auth;
        $this->data = $data;

        if (property_exists($this, 'row')) {
            $this->row = $row;
        }
    }

    /**
     * @param \Closure $closure
     * @param ?\Closure $rollback = null
     *
     * @return mixed
     */
    final protected function transaction(Closure $closure, ?Closure $rollback = null): mixed
    {
        try {
            return $this->connection()->transaction($closure);
        } catch (Throwable $e) {
            if ($rollback) {
                return $rollback($e);
            }

            throw $e;
        }
    }

    /**
     * @param \Closure $closure
     * @param int $limit
     * @param int $wait
     *
     * @return mixed
     */
    final protected function try(Closure $closure, int $limit, int $wait): mixed
    {
        $try = 1;

        do {
            try {
                return $closure();
            } catch (Throwable $e) {
                $this->tryError($e, $limit, $wait, $try);
            }
        } while ($limit > $try++);

        throw $e;
    }

    /**
     * @param \Throwable $e
     * @param int $limit
     * @param int $wait
     * @param int $try
     *
     * @return void
     */
    final protected function tryError(Throwable $e, int $limit, int $wait, int $try): void
    {
        Log::error(sprintf('tryError - Limit %s - Wait %s - Try %s', $limit, $wait, $try));
        Log::error($e);

        sleep($wait);
    }

    /**
     * @param string $message = ''
     *
     * @return void
     */
    final protected function exceptionNotFound(string $message = ''): void
    {
        throw new NotFoundException($message ?: __('common.error.not-found'));
    }

    /**
     * @param string $message
     *
     * @return void
     */
    final protected function exceptionValidator(string $message): void
    {
        throw new ValidatorException($message);
    }

    /**
     * @return bool
     */
    final protected function runningUnitTests(): bool
    {
        return App::runningUnitTests();
    }
}

```

`app/Domains/Core/Action/ActionFactoryAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Action;

use Closure;
use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Core\Model\ModelAbstract;
use App\Domains\Core\Traits\Factory;
use App\Domains\Core\Validate\ValidateFactoryAbstract;

abstract class ActionFactoryAbstract
{
    use Factory;

    /**
     * @param ?\Illuminate\Http\Request $request = null
     * @param ?\Illuminate\Contracts\Auth\Authenticatable $auth = null
     * @param ?\App\Domains\Core\Model\ModelAbstract $row = null
     * @param array $data = []
     *
     * @return self
     */
    final public function __construct(?Request $request = null, ?Authenticatable $auth = null, ?ModelAbstract $row = null, array $data = [])
    {
        $this->request = $request;
        $this->auth = $auth;
        $this->data = $data;

        if (property_exists($this, 'row')) {
            $this->row = $row;
        }
    }

    /**
     * @param string $class
     * @param ?array $data = []
     *
     * @return \App\Domains\Core\Action\ActionAbstract
     */
    final protected function action(string $class, ?array $data = []): ActionAbstract
    {
        return new $class($this->request, $this->auth, $this->row ?? null, $data ?? $this->data);
    }

    /**
     * @param string $class
     * @param ?array $data = []
     * @param mixed ...$args
     *
     * @return mixed
     */
    final protected function actionHandle(string $class, ?array $data = [], ...$args): mixed
    {
        return $this->action($class, $data ?? $this->data)->handle(...$args);
    }

    /**
     * @param string $class
     * @param ?array $data = []
     * @param mixed ...$args
     *
     * @return mixed
     */
    final protected function actionHandleTransaction(string $class, ?array $data = [], ...$args): mixed
    {
        return $this->transaction(fn () => $this->actionHandle($class, $data ?? $this->data, ...$args));
    }

    /**
     * @param \Closure $closure
     *
     * @return mixed
     */
    final protected function transaction(Closure $closure): mixed
    {
        return $this->connection()->transaction($closure);
    }

    /**
     * @return \App\Domains\Core\Validate\ValidateFactoryAbstract
     */
    final protected function validate(): ValidateFactoryAbstract
    {
        return $this->factory()->validate($this->data);
    }
}

```

`app/Domains/Core/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Command;

use ReflectionClass;
use Illuminate\Console\Command;
use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\File\UploadedFile;
use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Core\Model\ModelAbstract;
use App\Domains\Core\Traits\Factory;
use App\Exceptions\ValidatorException;

abstract class CommandAbstract extends Command
{
    use Factory;

    /**
     * @return self
     */
    public function __construct()
    {
        $this->request = request();

        parent::__construct();
    }

    /**
     * @param mixed $string
     * @param int|string|null $verbosity = false
     *
     * @return void
     */
    final public function info($string, $verbosity = null): void
    {
        if (is_string($string) === false) {
            $string = print_r($string, true);
        }

        parent::info('['.date('Y-m-d H:i:s').'] '.$this->className().' '.$string, $verbosity);
    }

    /**
     * @param mixed $string
     * @param int|string|null $verbosity = false
     *
     * @return void
     */
    final public function error($string, $verbosity = null): void
    {
        if (is_string($string) === false) {
            $string = print_r($string, true);
        }

        parent::error('['.date('Y-m-d H:i:s').'] '.$this->className().' '.$string, $verbosity);
    }

    /**
     * @return string
     */
    final public function className(): string
    {
        $namespace = explode('\\', get_class($this));

        return '['.$namespace[2].'] ['.$namespace[4].']';
    }

    /**
     * @param string $key
     *
     * @return mixed
     */
    final protected function checkOption(string $key): mixed
    {
        if (is_null($value = $this->option($key))) {
            throw new ValidatorException(sprintf('Option "%s" is required', $key));
        }

        return $value;
    }

    /**
     * @param array $keys
     *
     * @return void
     */
    final protected function checkOptions(array $keys): void
    {
        foreach ($keys as $key) {
            $this->checkOption($key);
        }
    }

    /**
     * @return \Illuminate\Http\Request
     */
    final protected function requestWithOptions(): Request
    {
        return request()->replace($this->options() + $this->arguments());
    }

    /**
     * @param string $key
     *
     * @return \Illuminate\Http\Request
     */
    final protected function requestOptionAsFile(string $key): Request
    {
        $value = $this->option($key);

        if (empty($value)) {
            return request();
        }

        if (str_starts_with($value, '/') === false) {
            $value = base_path($value);
        }

        if (is_file($value) === false) {
            throw new ValidatorException(sprintf('The "%s" "%s" does not exists', $key, $value));
        }

        $file = new UploadedFile($value, basename($value), mime_content_type($value), UPLOAD_ERR_OK, true);

        return request()->merge([$key => $file]);
    }

    /**
     * @return \Illuminate\Http\Request
     */
    final protected function requestMergeRow(): Request
    {
        return request()->replace(array_filter(request()->input()) + $this->row->toArray());
    }

    /**
     * @param \Illuminate\Contracts\Auth\Authenticatable|int|null $user = null
     *
     * @return \Illuminate\Contracts\Auth\Authenticatable
     */
    final protected function actingAs(Authenticatable|int|null $user = null): Authenticatable
    {
        $model = config('auth.providers.users.model');

        if (is_null($user)) {
            $user = new $model();
        } elseif (is_int($user)) {
            $user = $model::query()->findOrFail($user);
        }

        $this->factory($this->actingAsDomain($user), $user)->action()->set();

        return $this->auth = $user;
    }

    /**
     * @param \Illuminate\Contracts\Auth\Authenticatable $user
     *
     * @return string
     */
    final protected function actingAsDomain(Authenticatable $user): string
    {
        return (new ReflectionClass($user))->getShortName();
    }

    /**
     * @param ?\App\Domains\Core\Model\ModelAbstract $row = null
     * @param array $data = []
     *
     * @return \App\Domains\Core\Action\ActionFactoryAbstract
     */
    final protected function action(?ModelAbstract $row = null, array $data = []): ActionFactoryAbstract
    {
        return $this->factory(row: $row)->action($data);
    }
}

```

`app/Domains/Core/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Controller;

use Closure;
use Throwable;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Routing\Controller;
use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Core\Model\ModelAbstract;
use App\Domains\Core\Traits\Factory;
use App\Exceptions\NotFoundException;

abstract class ControllerAbstract extends Controller
{
    use Factory;

    /**
     * @return self
     */
    public function __construct()
    {
        $this->middleware($this->setup(...));
    }

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    protected function setup(Request $request, Closure $next): mixed
    {
        $this->request = $request;
        $this->auth = $request->user();

        $this->init();

        return $next($request);
    }

    /**
     * @return void
     */
    protected function init(): void
    {
    }

    /**
     * @param mixed $data = null
     * @param int $status = 200
     *
     * @return \Illuminate\Http\JsonResponse
     */
    final protected function json($data = null, int $status = 200): JsonResponse
    {
        return response()->json($data, $status);
    }

    /**
     * @param ?\App\Domains\Core\Model\ModelAbstract $row = null
     * @param array $data = []
     *
     * @return \App\Domains\Core\Action\ActionFactoryAbstract
     */
    final protected function action(?ModelAbstract $row = null, array $data = []): ActionFactoryAbstract
    {
        return $this->factory(row: $row)->action($data);
    }

    /**
     * @param string $name
     * @param ?string $target = null
     * @param mixed ...$args
     *
     * @return mixed
     */
    final protected function actionCall(string $name, ?string $target = null, ...$args): mixed
    {
        try {
            return call_user_func_array([$this, $target ?: $name], $args);
        } catch (Throwable $e) {
            return $this->actionException($e);
        }
    }

    /**
     * @param \Closure $closure
     *
     * @return mixed
     */
    final protected function actionCallClosure(Closure $closure): mixed
    {
        try {
            return $closure();
        } catch (Throwable $e) {
            return $this->actionException($e);
        }
    }

    /**
     * @param \Throwable $e
     *
     * @return mixed
     */
    protected function actionException(Throwable $e): mixed
    {
        report($e);

        return false;
    }

    /**
     * @param string $message = ''
     *
     * @return void
     */
    final protected function exceptionNotFound(string $message = ''): void
    {
        throw new NotFoundException($message ?: __('common.error.not-found'));
    }
}

```

`app/Domains/Core/Controller/ControllerWebAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Controller;

use Throwable;
use Illuminate\Http\Response;
use Eusonlito\LaravelMeta\Facade as Meta;
use App\Domains\Core\Model\ModelAbstract;
use App\Services\Html\Alert;
use App\Services\Request\Response as ResponseService;

abstract class ControllerWebAbstract extends ControllerAbstract
{
    /**
     * @return void
     */
    protected function init(): void
    {
        $this->initDefault();
        $this->initCustom();
    }

    /**
     * @return void
     */
    protected function initDefault(): void
    {
        $this->initViewShare();
    }

    /**
     * @return void
     */
    protected function initViewShare(): void
    {
        view()->share([
            'ROUTE' => $this->request->route()?->getName() ?: '',
            'AUTH' => $this->auth,
            'REQUEST' => $this->request,
        ]);
    }

    /**
     * @return void
     */
    protected function initCustom(): void
    {
    }

    /**
     * @param string $name
     * @param ?string $value
     *
     * @return void
     */
    protected function meta(string $name, ?string $value): void
    {
        if ($value) {
            Meta::set($name, $value);
        }
    }

    /**
     * @param string $page
     * @param array $data = []
     * @param ?int $status = null
     *
     * @return \Illuminate\Http\Response
     */
    protected function page(string $page, array $data = [], ?int $status = null): Response
    {
        return response()->view('domains.'.$page, $data, ResponseService::status($status));
    }

    /**
     * @param array $data = []
     * @param ?\App\Domains\Core\Model\ModelAbstract $row = null
     *
     * @return void
     */
    final protected function requestMergeWithRow(array $data = [], ?ModelAbstract $row = null): void
    {
        $this->request->merge($this->request->input() + $data + $this->requestMergeWithRowAsArray($row));
    }

    /**
     * @param ?\App\Domains\Core\Model\ModelAbstract $row
     *
     * @return array
     */
    final protected function requestMergeWithRowAsArray(?ModelAbstract $row): array
    {
        if ($row) {
            return $row->toArray();
        }

        if (isset($this->row)) {
            return $this->row->toArray();
        }

        return [];
    }

    /**
     * @param string $name
     *
     * @return mixed
     */
    final protected function actionIfExists(string $name): mixed
    {
        if ($this->request->input('_action') !== $name) {
            return null;
        }

        return call_user_func_array([$this, 'actionCall'], func_get_args());
    }

    /**
     * @param string $name
     *
     * @return mixed
     */
    final protected function actionPost(string $name): mixed
    {
        if ($this->request->isMethod('post') === false) {
            return null;
        }

        return $this->actionIfExists($name, ...func_get_args());
    }

    /**
     * @param \Throwable $e
     *
     * @return mixed
     */
    protected function actionException(Throwable $e): mixed
    {
        parent::actionException($e);

        return Alert::exception($this->request, $e);
    }

    /**
     * @param string $status
     * @param string $message
     *
     * @return mixed
     */
    final protected function sessionMessage(string $status, string $message): mixed
    {
        return Alert::{$status}($message);
    }
}

```

`app/Domains/Core/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Controller\Service;

use Closure;
use ReflectionFunction;
use App\Domains\Core\Model\ModelAbstract;
use App\Exceptions\NotFoundException;
use App\Exceptions\ValidatorException;

abstract class ControllerAbstract
{
    /**
     * @var array
     */
    protected array $cache = [];

    /**
     * @return mixed
     */
    abstract public function data(): mixed;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param \Closure $callback
     *
     * @return mixed
     */
    protected function cache(Closure $callback): mixed
    {
        $key = $this->cacheKey($callback);

        if (array_key_exists($key, $this->cache) === false) {
            $this->cache[$key] = $callback();
        }

        return $this->cache[$key];
    }

    /**
     * @param \Closure $callback
     *
     * @return string
     */
    protected function cacheKey(Closure $callback): string
    {
        $r = new ReflectionFunction($callback);

        return md5($r->getFileName().$r->getStartLine().$r->getEndLine());
    }

    /**
     * @param string $key
     * @param ?array $default = []
     *
     * @return ?array
     */
    protected function requestArray(string $key, ?array $default = []): ?array
    {
        return (array)$this->request->input($key) ?: $default;
    }

    /**
     * @param string $key
     * @param ?bool $default = false
     *
     * @return ?bool
     */
    protected function requestBool(string $key, ?bool $default = false): ?bool
    {
        return match ($this->request->input($key)) {
            'true', '1' => true,
            'false', '0' => false,
            default => $default,
        };
    }

    /**
     * @param string $key
     * @param ?string $default = null
     *
     * @return ?string
     */
    protected function requestDateToIso(string $key, ?string $default = null): ?string
    {
        return helper()->dateToDate($this->request->input($key), $default);
    }

    /**
     * @param string $key
     * @param ?float $default = 0
     *
     * @return ?float
     */
    protected function requestFloat(string $key, ?float $default = 0): ?float
    {
        return floatval($this->request->input($key)) ?: $default;
    }

    /**
     * @param string $key
     * @param ?int $default = 0
     *
     * @return ?int
     */
    protected function requestInteger(string $key, ?int $default = 0): ?int
    {
        return intval($this->request->input($key)) ?: $default;
    }

    /**
     * @param string $key
     * @param ?string $default = ''
     *
     * @return ?string
     */
    protected function requestString(string $key, ?string $default = ''): ?string
    {
        return strval($this->request->input($key)) ?: $default;
    }

    /**
     * @param array $after = []
     * @param array $before = []
     *
     * @return void
     */
    protected function requestMerge(array $after = [], array $before = []): void
    {
        $this->request->merge($before + $this->request->input() + $after);
    }

    /**
     * @param array $data = []
     * @param ?\App\Domains\Core\Model\ModelAbstract $row = null
     *
     * @return void
     */
    protected function requestMergeWithRow(array $data = [], ?ModelAbstract $row = null): void
    {
        $this->request->merge($this->request->input() + $data + $this->requestMergeWithRowAsArray($row));
    }

    /**
     * @param ?\App\Domains\Core\Model\ModelAbstract $row
     *
     * @return array
     */
    protected function requestMergeWithRowAsArray(?ModelAbstract $row): array
    {
        if ($row) {
            return $row->toArray();
        }

        if (isset($this->row)) {
            return $this->row->toArray();
        }

        return [];
    }

    /**
     * @param string $message = ''
     *
     * @return void
     */
    final protected function exceptionNotFound(string $message = ''): void
    {
        throw new NotFoundException($message ?: __('common.error.not-found'));
    }

    /**
     * @param string $message
     *
     * @return void
     */
    final protected function exceptionValidator(string $message): void
    {
        throw new ValidatorException($message);
    }
}

```

`app/Domains/Core/Database/Builder/Cache.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Database\Builder;

use Illuminate\Contracts\Cache\Repository;
use Illuminate\Database\Query\Builder;

class Cache extends Builder
{
    /**
     * @var array
     */
    protected array $cacheConfig;

    /**
     * @return array
     */
    protected function runSelect(): array
    {
        return $this->cacheResult(fn () => parent::runSelect());
    }

    /**
     * @param ?int $ttl = null
     *
     * @return self
     */
    public function cache(?int $ttl = null): self
    {
        if ($ttl !== null) {
            $this->cacheConfig('ttl', $ttl);
        }

        return $this;
    }

    /**
     * @param callable $result
     *
     * @return array
     */
    protected function cacheResult(callable $result): array
    {
        if ($this->cacheEnabled() === false) {
            return $result();
        }

        return $this->cacheManager()->remember($this->cacheKey(), $this->cacheTtl(), $result);
    }

    /**
     * @return bool
     */
    protected function cacheEnabled(): bool
    {
        return $this->cacheConfig('enabled') && $this->cacheConfig('ttl');
    }

    /**
     * @param ?string $key = null
     * @param string|int|bool|null $value = null
     *
     * @return mixed
     */
    protected function cacheConfig(?string $key = null, string|int|bool|null $value = null): mixed
    {
        $this->cacheConfig ??= $this->cacheConfigDefault();

        if ($value !== null) {
            return $this->cacheConfig[$key] = $value;
        }

        if ($key === null) {
            return $this->cacheConfig;
        }

        return $this->cacheConfig[$key] ?? null;
    }

    /**
     * @return array
     */
    protected function cacheConfigDefault(): array
    {
        static $config;

        return $config ??= config('database.cache', []) + [
            'enabled' => false,
            'driver' => 'redis',
            'ttl' => 3600,
            'tag' => 'database',
            'prefix' => 'database|',
        ];
    }

    /**
     * @return string
     */
    protected function cacheKey(): string
    {
        return $this->cacheConfig('prefix').md5($this->toSql().'|'.serialize($this->getBindings()));
    }

    /**
     * @return int
     */
    protected function cacheTtl(): int
    {
        return (int)$this->cacheConfig('ttl');
    }

    /**
     * @return \Illuminate\Contracts\Cache\Repository
     */
    protected function cacheManager(): Repository
    {
        $repository = $this->cacheRepository();

        if ($repository->supportsTags() && $this->cacheTagGlobal()) {
            $repository = $repository->tags($this->cacheTags());
        }

        return $repository;
    }

    /**
     * @return \Illuminate\Contracts\Cache\Repository
     */
    protected function cacheRepository(): Repository
    {
        static $repository;

        return $repository ??= resolve('cache')->store($this->cacheConfig('driver'));
    }

    /**
     * @return array
     */
    protected function cacheTags(): array
    {
        return array_filter([$this->cacheTagGlobal(), $this->cacheTagPrefix()]);
    }

    /**
     * @return ?string
     */
    protected function cacheTagGlobal(): ?string
    {
        return $this->cacheConfig('tag');
    }

    /**
     * @return ?string
     */
    protected function cacheTagPrefix(): ?string
    {
        if ($this->from) {
            return $this->cacheTagGlobal().'|'.$this->from;
        }

        return null;
    }
}

```

`app/Domains/Core/Event/EventAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Event;

use Illuminate\Queue\SerializesModels;

abstract class EventAbstract
{
    use SerializesModels;
}

```

`app/Domains/Core/Fractal/FractalAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Fractal;

use Illuminate\Pagination\LengthAwarePaginator;
use Illuminate\Support\Collection;
use App\Domains\Core\Model\ModelAbstract;
use App\Domains\Core\Traits\Factory;

abstract class FractalAbstract
{
    use Factory;

    final public function transform(string $function, $value, ...$args): ?array
    {
        if ($value === null) {
            return null;
        }

        if (empty($value)) {
            return [];
        }

        if ($value instanceof Collection) {
            return $this->collection($function, $value, $args);
        }

        if ($value instanceof LengthAwarePaginator) {
            return $this->paginated($function, $value, $args);
        }

        if ($this->isArraySequential($value)) {
            return $this->sequential($function, $value, $args);
        }

        return $this->call($function, $value, $args);
    }

    final protected function isArraySequential($value): bool
    {
        return is_array($value)
            && ($keys = array_keys($value))
            && ($keys === array_keys($value));
    }

    final protected function collection(string $function, Collection $value, array $args): array
    {
        return $value
            ->toBase()
            ->map(fn ($each) => $this->call($function, $each, $args))
            ->values()
            ->toArray();
    }

    final protected function paginated(string $function, LengthAwarePaginator $value, array $args): array
    {
        return [
            'data' => $this->transform($function, $value->items(), ...$args),
            'pages' => $value->lastPage(),
            'page' => $value->currentPage(),
            'offset' => $value->perPage(),
            'total' => $value->total(),
        ];
    }

    final protected function sequential(string $function, array $value, array $args): array
    {
        return array_map(fn ($each) => $this->call($function, $each, $args), array_values($value));
    }

    final protected function call(string $function, $value, array $args): ?array
    {
        return $this->$function($value, ...$args);
    }

    final protected function from(string $domain, string $view, $data, ...$args): ?array
    {
        return $this->factory($domain)->fractal($view, $data, ...$args);
    }

    final protected function fromIfLoaded(string $domain, string $view, ModelAbstract $row, string $relation, ...$args): ?array
    {
        if ($row->relationLoaded($relation) === false) {
            return null;
        }

        return $this->from($domain, $view, $row->$relation, ...$args);
    }

    final protected function fromIfLoadedOrId(string $domain, string $view, ModelAbstract $row, string $relation, ...$args): ?array
    {
        $return = $this->fromIfLoaded($domain, $view, $row, $relation, ...$args);

        if ($return) {
            return $return;
        }

        $id = $row->{$relation.'_id'};

        if ($id) {
            return ['id' => $id];
        }

        return null;
    }
}

```

`app/Domains/Core/Job/JobAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Job;

use Throwable;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\Middleware\WithoutOverlapping;
use Illuminate\Queue\SerializesModels;
use App\Domains\Core\Model\ModelAbstract;
use App\Domains\Core\Traits\Factory;

abstract class JobAbstract implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;
    use Factory;

    /**
     * @param \Throwable $e
     *
     * @return void
     */
    public function failed(Throwable $e): void
    {
        logger()->error($e);

        if (app()->bound('sentry')) {
            app('sentry')->captureException($e);
        }
    }

    /**
     * @param int|string|null $id = null
     *
     * @return \Illuminate\Queue\Middleware\WithoutOverlapping
     */
    protected function middlewareWithoutOverlapping(int|string|null $id = null): WithoutOverlapping
    {
        return new WithoutOverlapping(strval($id ?: $this->id));
    }

    /**
     * @return void
     */
    protected function deleteAndException(): void
    {
        $this->delete();

        throw new ModelNotFoundException();
    }

    /**
     * @param string $class
     *
     * @return \App\Domains\Core\Model\ModelAbstract
     */
    protected function rowOrDeleteAndException(string $class): ModelAbstract
    {
        return $this->row = $class::query()->byId($this->id)->firstOr(fn () => $this->deleteAndException());
    }
}

```

`app/Domains/Core/Job/Middleware/RateLimit.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Job\Middleware;

use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Support\Facades\Redis;

class RateLimit
{
    /**
     * @param \Illuminate\Contracts\Queue\ShouldQueue $job
     * @param callable $next
     * @param int $block = 30
     * @param int $allow = 1
     * @param int $every = 10
     *
     * @return void
     */
    final public function handle(
        ShouldQueue $job,
        callable $next,
        int $block = 30,
        int $allow = 1,
        int $every = 10
    ) {
        Redis::throttle('RateLimitJob')
            ->block($block)
            ->allow($allow)
            ->every($every)
            ->then(
                fn () => $this->send($job, $next),
                fn () => $this->fail($job),
            );
    }

    /**
     * @param \Illuminate\Contracts\Queue\ShouldQueue $job
     * @param callable $next
     *
     * @return void
     */
    final public function send(ShouldQueue $job, callable $next): void
    {
        $job->handle();

        $next($job);
    }

    /**
     * @param \Illuminate\Contracts\Queue\ShouldQueue $job
     *
     * @return void
     */
    final public function fail(ShouldQueue $job): void
    {
        $job->release(10);
    }
}

```

`app/Domains/Core/Listener/ListenerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Listener;

use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use App\Domains\Core\Traits\Factory;

abstract class ListenerAbstract implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;
    use Factory;
}

```

`app/Domains/Core/Mail/MailAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Mail;

use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Mail\Mailable;
use Illuminate\Queue\SerializesModels;
use Symfony\Component\HttpFoundation\File\UploadedFile;

abstract class MailAbstract extends Mailable implements ShouldQueue
{
    use Queueable, SerializesModels;

    /**
     * @var string
     */
    public $subject = '';

    /**
     * @var string
     */
    public $view = '';

    /**
     * @return self
     */
    final public function build(): self
    {
        return $this->buildData()->view($this->view);
    }

    /**
     * @return self
     */
    public function buildData(): self
    {
        return $this;
    }

    /**
     * @param array|string|\Symfony\Component\HttpFoundation\File\UploadedFile $file
     *
     * @return self
     */
    final public function file(array|string|UploadedFile $file): self
    {
        if (is_array($file)) {
            return $this->files($file);
        }

        if (is_string($file)) {
            return $this->attach($file);
        }

        return $this->fileUploaded($file);
    }

    /**
     * @param \Symfony\Component\HttpFoundation\File\UploadedFile $file
     *
     * @return self
     */
    final protected function fileUploaded(UploadedFile $file): self
    {
        return $this->attach($file->getRealPath(), [
            'as' => $file->getClientOriginalName(),
            'mime' => $file->getClientMimeType(),
        ]);
    }

    /**
     * @param array $files
     *
     * @return self
     */
    final protected function files(array $files): self
    {
        foreach ($files as $each) {
            $this->file($each);
        }

        return $this;
    }

    /**
     * @param string|array $emails
     *
     * @return array
     */
    final protected function emails($emails): array
    {
        if (is_string($emails)) {
            $emails = preg_split('/[,;\s]+/', strtolower($emails));
        }

        return array_values(array_unique(array_filter(array_map('trim', $emails), function ($value) {
            return $value && filter_var($value, FILTER_VALIDATE_EMAIL);
        })));
    }
}

```

`app/Domains/Core/Mail/MailFactoryAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Mail;

use BadMethodCallException;
use ReflectionClass;
use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Mail\Mailable;
use Illuminate\Support\Facades\Mail;

abstract class MailFactoryAbstract
{
    /**
     * @var ?\Illuminate\Contracts\Auth\Authenticatable
     */
    protected ?Authenticatable $auth;

    /**
     * @param ?\Illuminate\Contracts\Auth\Authenticatable $auth = null
     *
     * @return self
     */
    final public function __construct(?Authenticatable $auth = null)
    {
        $this->auth = $auth;
    }

    /**
     * @param \Illuminate\Mail\Mailable $mail
     *
     * @return \Illuminate\Mail\Mailable
     */
    final public function send(Mailable $mail): Mailable
    {
        return tap($mail, static fn () => Mail::send($mail));
    }

    /**
     * @param string $name
     * @param array $arguments
     *
     * @return \Illuminate\Mail\Mailable
     */
    final public function __call(string $name, array $arguments): Mailable
    {
        $class = (new ReflectionClass($this))->getNamespaceName().'\\'.ucfirst($name);

        if (class_exists($class) === false) {
            throw new BadMethodCallException();
        }

        return $this->send($this->new($class, $arguments));
    }

    /**
     * @param string $class
     * @param array $arguments
     *
     * @return \App\Domains\Core\Mail\MailAbstract
     */
    final protected function new(string $class, array $arguments): MailAbstract
    {
        return new $class(...$arguments);
    }
}

```

`app/Domains/Core/Middleware/MiddlewareAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Middleware;

use Illuminate\Http\Request;
use App\Domains\Core\Traits\Factory;

abstract class MiddlewareAbstract
{
    use Factory;

    /**
     * @param \Illuminate\Http\Request $request
     *
     * @return self
     */
    final public function __construct(Request $request)
    {
        $this->request = $request;
    }
}

```

`app/Domains/Core/Migration/Database/DatabaseAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Migration\Database;

use Illuminate\Database\ConnectionInterface;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Schema\ColumnDefinition;

abstract class DatabaseAbstract
{
    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     *
     * @return \Illuminate\Database\Schema\ColumnDefinition
     */
    abstract public function uuid(Blueprint $table): ColumnDefinition;

    /**
     * @param \Illuminate\Database\ConnectionInterface $db
     *
     * @return void
     */
    public function __construct(protected ConnectionInterface $db)
    {
    }

    /**
     * @return void
     */
    public function updatedAtNow(): void
    {
    }
}

```

`app/Domains/Core/Migration/Database/DatabaseFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Migration\Database;

use LogicException;
use Illuminate\Database\ConnectionInterface;

class DatabaseFactory
{
    /**
     * @param \Illuminate\Database\ConnectionInterface $db
     *
     * @return \App\Domains\Core\Migration\Database\DatabaseAbstract
     */
    public static function get(ConnectionInterface $db): DatabaseAbstract
    {
        return match ($db->getDriverName()) {
            'pgsql' => new PostgreSQL($db),
            'mysql' => new MySQL($db),
            'sqlite' => new SQLite($db),
            default => throw new LogicException('Invalid Database Driver'),
        };
    }
}

```

`app/Domains/Core/Migration/Database/MySQL.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Migration\Database;

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Schema\ColumnDefinition;

class MySQL extends DatabaseAbstract
{
    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     *
     * @return \Illuminate\Database\Schema\ColumnDefinition
     */
    public function uuid(Blueprint $table): ColumnDefinition
    {
        return $table->uuid('uuid')->unique()->default($this->db->raw('(UUID())'));
    }
}

```

`app/Domains/Core/Migration/Database/PostgreSQL.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Migration\Database;

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Schema\ColumnDefinition;

class PostgreSQL extends DatabaseAbstract
{
    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     *
     * @return \Illuminate\Database\Schema\ColumnDefinition
     */
    public function uuid(Blueprint $table): ColumnDefinition
    {
        return $table->uuid('uuid')->unique()->default($this->db->raw('gen_random_uuid()'));
    }

    /**
     * @return void
     */
    public function updatedAtNow(): void
    {
        $this->updatedAtNowFunction();
        $this->updatedAtNowTrigger();
    }

    /**
     * @return void
     */
    protected function updatedAtNowFunction(): void
    {
        $this->db->unprepared(trim(<<<'EOF'

            CREATE OR REPLACE FUNCTION "updated_at_now"()
            RETURNS TRIGGER AS $$
            BEGIN
                NEW."updated_at" = NOW();
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;

            EOF));
    }

    /**
     * @return void
     */
    protected function updatedAtNowTrigger(): void
    {
        $this->db->unprepared(trim(<<<'EOF'

            DO $$
            DECLARE
                "tbl" RECORD;
            BEGIN
                FOR "tbl" IN
                    SELECT "table_schema", "table_name"
                    FROM "information_schema"."columns"
                    WHERE (
                        "column_name" = 'updated_at'
                        AND "table_schema" = 'public'
                    )
                LOOP
                    EXECUTE format(
                        'CREATE OR REPLACE TRIGGER "updated_at_now_trigger" BEFORE UPDATE ON %I.%I FOR EACH ROW EXECUTE FUNCTION "updated_at_now"();',
                        "tbl"."table_schema",
                        "tbl"."table_name"
                    );
                END LOOP;
            END;
            $$;

            EOF));
    }
}

```

`app/Domains/Core/Migration/Database/SQLite.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Migration\Database;

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Schema\ColumnDefinition;

class SQLite extends DatabaseAbstract
{
    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     *
     * @return \Illuminate\Database\Schema\ColumnDefinition
     */
    public function uuid(Blueprint $table): ColumnDefinition
    {
        return $table->uuid('uuid')->unique();
    }
}

```

`app/Domains/Core/Migration/MigrationAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Migration;

use Illuminate\Database\ConnectionInterface;
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Schema\ColumnDefinition;
use Illuminate\Database\Schema\ForeignKeyDefinition;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use App\Domains\Core\Migration\Database\DatabaseAbstract;
use App\Domains\Core\Migration\Database\DatabaseFactory;

abstract class MigrationAbstract extends Migration
{
    /**
     * @var \Illuminate\Database\ConnectionInterface
     */
    protected ConnectionInterface $db;

    /**
     * @var \App\Domains\Core\Migration\Database\DatabaseAbstract
     */
    protected DatabaseAbstract $database;

    /**
     * @var array
     */
    protected array $config;

    /**
     * @param string $key
     *
     * @return string|int
     */
    protected function config(string $key): string|int
    {
        $this->config ??= config('database.connections.'.config('database.default'));

        return $this->config[$key];
    }

    /**
     * @return \Illuminate\Database\ConnectionInterface
     */
    protected function db(): ConnectionInterface
    {
        return $this->db ??= DB::connection();
    }

    /**
     * @return \App\Domains\Core\Migration\Database\DatabaseAbstract
     */
    protected function database(): DatabaseAbstract
    {
        return $this->database ??= DatabaseFactory::get($this->db());
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     *
     * @return \Illuminate\Database\Schema\ColumnDefinition
     */
    protected function uuid(Blueprint $table): ColumnDefinition
    {
        return $this->database()->uuid($table);
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     *
     * @return void
     */
    protected function timestamps(Blueprint $table): void
    {
        $this->dateTimeCreatedAt($table);
        $this->dateTimeUpdatedAt($table);
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     *
     * @return void
     */
    protected function timestampsWithDelete(Blueprint $table): void
    {
        $this->timestamps($table);
        $this->dateTimeDeletedAt($table);
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     *
     * @return \Illuminate\Database\Schema\ColumnDefinition
     */
    protected function dateTimeCreatedAt(Blueprint $table): ColumnDefinition
    {
        return $table->dateTime('created_at')->useCurrent();
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     *
     * @return \Illuminate\Database\Schema\ColumnDefinition
     */
    protected function dateTimeUpdatedAt(Blueprint $table): ColumnDefinition
    {
        return $table->dateTime('updated_at')->useCurrent()->useCurrentOnUpdate();
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     *
     * @return \Illuminate\Database\Schema\ColumnDefinition
     */
    protected function dateTimeDeletedAt(Blueprint $table): ColumnDefinition
    {
        return $table->dateTime('deleted_at')->nullable();
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     * @param string $remote
     * @param ?string $alias = null
     * @param ?string $reference = null
     *
     * @return \Illuminate\Database\Schema\ForeignKeyDefinition
     */
    protected function foreign(Blueprint $table, string $remote, ?string $alias = null, ?string $reference = null): ForeignKeyDefinition
    {
        $name = ($alias ?: ($remote.'_id'));
        $column = $alias ?: $remote;

        if ($this->config('driver') === 'pgsql') {
            $this->tableAddIndex($table, $name);
        }

        return $table->foreign($name, $this->indexName($table, $column, 'fk'))
            ->references($reference ?: 'id')
            ->on($remote);
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     * @param string $remote
     * @param ?string $alias = null
     * @param ?string $reference = null
     *
     * @return \Illuminate\Database\Schema\ForeignKeyDefinition
     */
    protected function foreignOnDeleteSetNull(Blueprint $table, string $remote, ?string $alias = null, ?string $reference = null): ForeignKeyDefinition
    {
        return $this->foreign($table, $remote, $alias, $reference)->onDelete('SET NULL');
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     * @param string $remote
     * @param ?string $alias = null
     * @param ?string $reference = null
     *
     * @return \Illuminate\Database\Schema\ForeignKeyDefinition
     */
    protected function foreignOnDeleteCascade(Blueprint $table, string $remote, ?string $alias = null, ?string $reference = null): ForeignKeyDefinition
    {
        return $this->foreign($table, $remote, $alias, $reference)->onDelete('CASCADE');
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint|string $table
     * @param string|array $columns
     * @param ?string $sufix = null
     *
     * @return string
     */
    protected function indexName(Blueprint|string $table, $columns, ?string $sufix = null): string
    {
        $table = strtolower(is_string($table) ? $table : $table->getTable());
        $columns = array_map('strtolower', (array)$columns);
        $sufix = trim(strtolower($sufix ?: 'index'), '_');
        $index = $table.'_'.implode('_', $columns).'_'.$sufix;

        for ($i = 1; strlen($index) >= 64; $i++) {
            $index = $this->indexNameCut($table, $columns, $sufix, $i);
        }

        return $index;
    }

    /**
     * @param string $table
     * @param array $columns
     * @param string $sufix
     * @param int $i
     *
     * @return string
     */
    protected function indexNameCut(string $table, array $columns, string $sufix, int $i): string
    {
        return substr($table, 0, -$i)
            .'_'.implode('_', array_map(static fn ($value) => substr($value, 0, -$i), $columns))
            .'_'.$sufix;
    }

    /**
     * @param array $tables = []
     *
     * @return void
     */
    protected function drop(array $tables = []): void
    {
        foreach (($tables ?: $this->getTables()) as $table) {
            Schema::dropIfExists($table);
        }
    }

    /**
     * @param string $table
     * @param string $column
     *
     * @return void
     */
    protected function dropColumnIfExists(string $table, string $column): void
    {
        if (Schema::hasColumn($table, $column)) {
            Schema::table($table, static fn (Blueprint $table) => $table->dropColumn($column));
        }
    }

    /**
     * @return array
     */
    protected function getTables(): array
    {
        return array_filter(
            array_column(Schema::getTables(schema: $this->getTablesSchema()), 'name'),
            static fn ($table) => $table !== 'migrations'
        );
    }

    /**
     * @return string
     */
    protected function getTablesSchema(): string
    {
        return $this->config($this->config('driver') === 'pgsql' ? 'search_path' : 'database');
    }

    /**
     * @param string $table
     * @param string|array $name
     * @param ?string $suffix = null
     *
     * @return bool
     */
    protected function tableHasIndex(string $table, string|array $name, ?string $suffix = null): bool
    {
        return Schema::hasIndex($table, $this->indexName($table, $name, $suffix));
    }

    /**
     * @param string $table
     * @param string|array $name
     * @param ?string $suffix = null
     *
     * @return bool
     */
    protected function tableHasForeign(string $table, string|array $name, ?string $suffix = null): bool
    {
        $index = $this->indexName($table, $name, $suffix ?: 'fk');

        return boolval(array_filter(
            Schema::getForeignKeys($table),
            static fn ($foreign) => $foreign['name'] === $index
        ));
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     * @param string|array $name
     * @param ?string $suffix = null
     *
     * @return void
     */
    protected function tableAddIndex(Blueprint $table, string|array $name, ?string $suffix = null): void
    {
        if ($this->tableHasIndex($table->getTable(), $name, $suffix) === false) {
            $table->index((array)$name, $this->indexName($table, $name, $suffix));
        }
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     * @param string|array $name
     * @param ?string $suffix = null
     *
     * @return void
     */
    protected function tableAddUnique(Blueprint $table, string|array $name, ?string $suffix = null): void
    {
        if ($this->tableHasIndex($table->getTable(), $name, $suffix ?: '_unique') === false) {
            $table->unique((array)$name, $this->indexName($table, $name, $suffix ?: 'unique'));
        }
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     * @param string|array $name
     * @param ?string $suffix = null
     *
     * @return void
     */
    protected function tableDropIndex(Blueprint $table, string|array $name, ?string $suffix = null): void
    {
        if ($this->tableHasIndex($table->getTable(), $name, $suffix)) {
            $table->dropIndex($this->indexName($table, $name, $suffix));
        }
    }

    /**
     * @param \Illuminate\Database\Schema\Blueprint $table
     * @param string|array $name
     * @param ?string $suffix = null
     *
     * @return void
     */
    protected function tableDropForeign(Blueprint $table, string|array $name, ?string $suffix = null): void
    {
        $suffix = $suffix ?: 'fk';

        if ($this->tableHasForeign($table->getTable(), $name, $suffix)) {
            $table->dropForeign($this->indexName($table, $name, $suffix));
        }
    }
}

```

`app/Domains/Core/Model/Builder/BuilderAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model\Builder;

use Illuminate\Database\ConnectionInterface;
use Illuminate\Database\Eloquent\Builder;

abstract class BuilderAbstract extends Builder
{
    /**
     * @var \Illuminate\Database\ConnectionInterface
     */
    protected ConnectionInterface $db;

    /**
     * @var string
     */
    protected string $table;

    /**
     * @return \Illuminate\Database\ConnectionInterface
     */
    public function db(): ConnectionInterface
    {
        return $this->db ??= $this->getModel()->db();
    }

    /**
     * @return string
     */
    public function getTable(): string
    {
        return $this->table ??= $this->getModel()->getTable();
    }

    /**
     * @param string $column
     *
     * @return string
     */
    public function wrap(string $column): string
    {
        return $this->getGrammar()->wrap($column);
    }

    /**
     * @param string|array $column
     *
     * @return string|array
     */
    public function addTable(string|array $column): string|array
    {
        $table = $this->getTable();

        if (is_string($column)) {
            return $table.'.'.$column;
        }

        return array_map(fn ($column) => $table.'.'.$column, $column);
    }

    /**
     * @param string|array $column
     *
     * @return string|array
     */
    public function addTableRaw(string|array $column): string|array
    {
        $table = $this->wrap($this->getTable());

        if (is_string($column)) {
            return $table.'.'.$this->wrap($column);
        }

        return array_map(fn ($column) => $table.'.'.$this->wrap($column), $column);
    }

    /**
     * @param string $created_at
     *
     * @return self
     */
    public function byCreatedAtAfter(string $created_at): self
    {
        return $this->where($this->addTable('created_at'), '>', $created_at);
    }

    /**
     * @param int $id
     *
     * @return self
     */
    public function byId(int $id): self
    {
        return $this->where($this->addTable('id'), $id);
    }

    /**
     * @param int $id
     *
     * @return self
     */
    public function byIdNext(int $id): self
    {
        return $this->where($this->addTable('id'), '>', $id);
    }

    /**
     * @param int $id
     *
     * @return self
     */
    public function byIdPrevious(int $id): self
    {
        return $this->where($this->addTable('id'), '<', $id);
    }

    /**
     * @param int $id
     *
     * @return self
     */
    public function byIdNot(int $id): self
    {
        return $this->where($this->addTable('id'), '!=', $id);
    }

    /**
     * @param array $ids
     *
     * @return self
     */
    public function byIds(array $ids): self
    {
        return $this->whereIntegerInRaw($this->addTable('id'), $ids);
    }

    /**
     * @param array $ids
     *
     * @return self
     */
    public function byIdsNot(array $ids): self
    {
        return $this->whereIntegerNotInRaw($this->addTable('id'), $ids);
    }

    /**
     * @param string $updated_at
     *
     * @return self
     */
    public function byUpdatedAtAfter(string $updated_at): self
    {
        return $this->where($this->addTable('updated_at'), '>', $updated_at);
    }

    /**
     * @param int $user_id
     *
     * @return self
     */
    public function byUserId(int $user_id): self
    {
        return $this->where($this->addTable('user_id'), $user_id);
    }

    /**
     * @param bool $enabled = true
     *
     * @return self
     */
    public function enabled(bool $enabled = true): self
    {
        return $this->where($this->addTable('enabled'), $enabled);
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderBy($this->addTable('id'), 'DESC');
    }

    /**
     * @return self
     */
    public function orderByCreatedAtAsc(): self
    {
        return $this->orderBy($this->addTable('created_at'), 'ASC');
    }

    /**
     * @return self
     */
    public function orderByCreatedAtDesc(): self
    {
        return $this->orderBy($this->addTable('created_at'), 'DESC');
    }

    /**
     * @return self
     */
    public function orderByFirst(): self
    {
        return $this->orderBy($this->addTable('id'), 'ASC');
    }

    /**
     * @return self
     */
    public function orderByLast(): self
    {
        return $this->orderBy($this->addTable('id'), 'DESC');
    }

    /**
     * @return self
     */
    public function orderByUpdatedAtAsc(): self
    {
        return $this->orderBy($this->addTable('updated_at'), 'ASC');
    }

    /**
     * @return self
     */
    public function orderByUpdatedAtDesc(): self
    {
        return $this->orderBy($this->addTable('updated_at'), 'DESC');
    }

    /**
     * @param string $column
     * @param ?string $mode
     *
     * @return self
     */
    public function orderByColumn(string $column, ?string $mode): self
    {
        return $this->orderBy($column, $this->orderMode($mode));
    }

    /**
     * @param ?string $mode
     * @param string $default = 'ASC'
     *
     * @return string
     */
    public function orderMode(?string $mode, string $default = 'ASC'): string
    {
        return match ($mode = strtoupper($mode)) {
            'ASC', 'DESC' => $mode,
            default => $default,
        };
    }

    /**
     * @param string|array $column
     * @param string $search
     *
     * @return self
     */
    protected function searchLike(string|array $column, string $search): self
    {
        if ($search = $this->searchLikeString($search)) {
            $this->where(fn ($q) => $this->searchLikeColumns($q, (array)$column, $search));
        } else {
            $this->whereRaw('FALSE');
        }

        return $this;
    }

    /**
     * @param \Illuminate\Database\Eloquent\Builder $q
     * @param array $columns
     * @param string $search
     *
     * @return self
     */
    protected function searchLikeColumns(Builder $q, array $columns, string $search): self
    {
        foreach ($columns as $each) {
            $q->orWhere($this->addTable($each), 'LIKE', $search);
        }

        return $q;
    }

    /**
     * @param string $search
     *
     * @return ?string
     */
    protected function searchLikeString(string $search): ?string
    {
        $search = trim(preg_replace('/[^\p{L}0-9]/u', ' ', $search));
        $search = array_filter(explode(' ', $search), static fn ($value) => strlen($value) >= 2);

        return $search ? ('%'.implode('%', $search).'%') : null;
    }

    /**
     * @param ?array $ids
     *
     * @return self
     */
    public function whenIds(?array $ids): self
    {
        return $this->when($ids, fn ($q) => $q->byIds($ids));
    }

    /**
     * @param int $id
     *
     * @return self
     */
    public function whenIdNext(int $id): self
    {
        return $this->when($id, fn ($q) => $q->byIdNext($id));
    }

    /**
     * @param string $column
     * @param array $strings
     *
     * @return self
     */
    public function whereStringInRaw(string $column, array $strings): self
    {
        return $this->whereRaw($this->wrap($column).' '.$this->stringsIn($strings));
    }

    /**
     * @param string $column
     * @param array $strings
     *
     * @return self
     */
    public function orWhereStringInRaw(string $column, array $strings): self
    {
        return $this->orWhereRaw($this->wrap($column).' '.$this->stringsIn($strings));
    }

    /**
     * @param array $strings
     *
     * @return string
     */
    protected function stringsIn(array $strings): string
    {
        return "IN ('".implode("', '", $this->strings($strings))."')";
    }

    /**
     * @param array $strings
     *
     * @return array
     */
    protected function strings(array $strings): array
    {
        return array_unique(array_filter(array_map(static function (mixed $string) {
            return trim(str_replace(['"', "'", '\\'], '', strval($string)));
        }, $strings)));
    }
}

```

`app/Domains/Core/Model/Collection/CollectionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model\Collection;

use Illuminate\Database\Eloquent\Collection;

abstract class CollectionAbstract extends Collection
{
}

```

`app/Domains/Core/Model/ModelAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model;

use DateTime;
use Illuminate\Database\ConnectionInterface;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Schema\Builder;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;
use App\Domains\Core\Model\Traits\Column as ColumnTrait;
use App\Domains\Core\Model\Traits\DateDisabled as DateDisabledTrait;
use App\Domains\Core\Model\Traits\MutatorDisabled as MutatorDisabledTrait;
use App\Domains\Core\Model\Traits\Transform as TransformTrait;

abstract class ModelAbstract extends Model
{
    use ColumnTrait, DateDisabledTrait, MutatorDisabledTrait, TransformTrait;

    /**
     * @var bool
     */
    public static $snakeAttributes = false;

    /**
     * @var bool
     */
    public $incrementing = true;

    /**
     * @var bool
     */
    public $timestamps = false;

    /**
     * @var array<string>|bool
     */
    protected $guarded = [];

    /**
     * @param string $column
     *
     * @return \DateTime
     */
    public function datetime(string $column): DateTime
    {
        return new DateTime($this->$column);
    }

    /**
     * @return \Illuminate\Database\ConnectionInterface
     */
    public static function db(): ConnectionInterface
    {
        return DB::connection();
    }

    /**
     * @return \Illuminate\Database\Schema\Builder
     */
    public static function schema(): Builder
    {
        return Schema::connection(static::db()->getName());
    }
}

```

`app/Domains/Core/Model/PivotAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model;

use DateTime;
use Illuminate\Database\ConnectionInterface;
use Illuminate\Database\Eloquent\Relations\Pivot;
use Illuminate\Support\Facades\DB;
use App\Domains\Core\Model\Traits\Column as ColumnTrait;
use App\Domains\Core\Model\Traits\DateDisabled as DateDisabledTrait;
use App\Domains\Core\Model\Traits\MutatorDisabled as MutatorDisabledTrait;
use App\Domains\Core\Model\Traits\Transform as TransformTrait;

abstract class PivotAbstract extends Pivot
{
    use ColumnTrait, DateDisabledTrait, MutatorDisabledTrait, TransformTrait;

    /**
     * @var bool
     */
    public static $snakeAttributes = false;

    /**
     * @var bool
     */
    public $incrementing = true;

    /**
     * @var bool
     */
    public $timestamps = false;

    /**
     * @var array<string>|bool
     */
    protected $guarded = [];

    /**
     * @param string $column
     *
     * @return \DateTime
     */
    public function datetime(string $column): DateTime
    {
        return new DateTime($this->$column);
    }

    /**
     * @return \Illuminate\Database\ConnectionInterface
     */
    public static function db(): ConnectionInterface
    {
        return DB::connection();
    }
}

```

`app/Domains/Core/Model/Traits/Column.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model\Traits;

trait Column
{
    /**
     * @psalm-suppress UndefinedConstant
     *
     * @return array
     */
    public static function getTableColumns(): array
    {
        return static::db()->getSchemaBuilder()->getColumnListing(static::TABLE);
    }
}

```

`app/Domains/Core/Model/Traits/DateDisabled.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model\Traits;

trait DateDisabled
{
    /**
     * @return array
     */
    public function getDates(): array
    {
        return [];
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $key
     *
     * @return bool
     */
    protected function isDateAttribute($key): bool
    {
        return false;
    }
}

```

`app/Domains/Core/Model/Traits/JsonColumn.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model\Traits;

trait JsonColumn
{
    /**
     * @var array
     */
    protected array $jsonColumnCache = [];

    /**
     * @param string $column
     * @param string $key
     * @param mixed $default = null
     *
     * @return mixed
     */
    public function jsonColumn(string $column, string $key, mixed $default = null): mixed
    {
        $cacheKey = md5(json_encode(func_get_args()));

        if (array_key_exists($cacheKey, $this->jsonColumnCache)) {
            return $this->jsonColumnCache[$cacheKey] ?: $default;
        }

        $value = $this->attributes[$column] ?? null;

        if (empty($value)) {
            return $this->jsonColumnCache($cacheKey, $value, $default);
        }

        if (is_string($value)) {
            $value = json_decode($value, true);
        }

        if (is_array($value) === false) {
            return $this->jsonColumnCache($cacheKey, null, $default);
        }

        if (str_contains($key, '.')) {
            return $this->jsonColumnCache($cacheKey, data_get($value, $key), $default);
        }

        return $this->jsonColumnCache($cacheKey, $value[$key] ?? null, $default);
    }

    /**
     * @param string $key
     * @param mixed $value
     * @param mixed $default
     *
     * @return mixed
     */
    protected function jsonColumnCache(string $key, mixed $value, mixed $default): mixed
    {
        $this->jsonColumnCache[$key] = $value;

        return $value ?: $default;
    }
}

```

`app/Domains/Core/Model/Traits/MutatorDisabled.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model\Traits;

trait MutatorDisabled
{
    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $key
     *
     * @return bool
     */
    public function hasGetMutator($key): bool
    {
        return false;
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $key
     *
     * @return bool
     */
    public function hasSetMutator($key): bool
    {
        return false;
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $key
     *
     * @return bool
     */
    public function hasAttributeMutator($key): bool
    {
        return false;
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $key
     *
     * @return bool
     */
    public function hasAttributeGetMutator($key): bool
    {
        return false;
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $key
     *
     * @return bool
     */
    public function hasAttributeSetMutator($key): bool
    {
        return false;
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $key
     *
     * @return bool
     */
    protected function isDateCastable($key): bool
    {
        return false;
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $key
     *
     * @return bool
     */
    protected function isDateCastableWithCustomFormat($key): bool
    {
        return false;
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $key
     *
     * @return bool
     */
    protected function isEnumCastable($key): bool
    {
        return false;
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $attribute
     *
     * @return bool
     */
    public function hasAppended($attribute): bool
    {
        return false;
    }
}

```

`app/Domains/Core/Model/Traits/Transform.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model\Traits;

use stdClass;

trait Transform
{
    /**
     * @psalm-suppress UndefinedConstant
     *
     * @return \stdClass
     */
    public function toObject(): stdClass
    {
        return json_decode(json_encode($this->toArray()));
    }
}

```

`app/Domains/Core/Model/Traits/Translate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model\Traits;

trait Translate
{
    /**
     * @var array
     */
    protected array $translateCache = [];

    /**
     * @param string $column
     * @param ?string $lang = null
     * @param mixed $default = null
     *
     * @return mixed
     */
    public function translate(string $column, ?string $lang = null, mixed $default = null): mixed
    {
        $cacheKey = md5(json_encode(func_get_args()));

        if (array_key_exists($cacheKey, $this->translateCache)) {
            return $this->translateCache[$cacheKey] ?: $value;
        }

        $value = $this->attributes[$column] ?? null;

        if (empty($value)) {
            return $this->translateCache($cacheKey, $value, $default);
        }

        $value = json_decode($value, true);

        if (is_array($value) === false) {
            return $this->translateCache($cacheKey, null, $default);
        }

        return $this->translateCache($cacheKey, $value[$this->translateLocale($lang)] ?? null, $default);
    }

    /**
     * @param ?string $lang = null
     *
     * @return string
     */
    protected function translateLocale(?string $lang = null): string
    {
        return $lang ?: app('language')->locale;
    }

    /**
     * @param string $key
     * @param mixed $value
     * @param mixed $default
     *
     * @return mixed
     */
    protected function translateCache(string $key, mixed $value, mixed $default): mixed
    {
        $this->translateCache[$key] = $value;

        return $value ?: $default;
    }
}

```

`app/Domains/Core/Model/Traits/Translation.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model\Traits;

trait Translation
{
    use Translate;

    /**
     * @var array
     */
    protected array $translationCache = [];

    /**
     * @param ?string $key
     * @param string|bool|null $lang = null
     * @param mixed $default = null
     *
     * @return mixed
     */
    public function translation(?string $key, string|bool|null $lang = null, mixed $default = null): mixed
    {
        $cacheKey = md5(json_encode(func_get_args()));

        if (array_key_exists($cacheKey, $this->translationCache)) {
            return $this->translationCache[$cacheKey] ?: $default;
        }

        if ($lang === false) {
            return $this->translationCache($cacheKey, $this->translationAny($key), $default);
        }

        $translation = $this->translate('translation', $lang, []);

        if ($key === null) {
            return $this->translationCache($cacheKey, $translation, $default);
        }

        if (str_contains($key, '.')) {
            return $this->translationCache($cacheKey, data_get($translation, $key), $default);
        }

        return $this->translationCache($cacheKey, $translation[$key] ?? null, $default);
    }

    /**
     * @param string $key
     *
     * @return mixed
     */
    protected function translationAny(string $key): mixed
    {
        if ($translation = $this->translation($key, null)) {
            return $translation;
        }

        if (str_contains($key, '.') === false) {
            return current(array_filter(array_column($this->translation, $key))) ?: $default;
        }

        foreach ($this->translation as $each) {
            if ($value = data_get($each, $key)) {
                return $value;
            }
        }

        return null;
    }

    /**
     * @param string $key
     * @param mixed $value
     * @param mixed $default
     *
     * @return mixed
     */
    protected function translationCache(string $key, mixed $value, mixed $default): mixed
    {
        $this->translationCache[$key] = $value;

        return $value ?: $default;
    }
}

```

`app/Domains/Core/Model/Traits/TranslationSimple.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Model\Traits;

trait TranslationSimple
{
    use JsonColumn;

    /**
     * @param ?string $key = null
     * @param mixed $default = null
     *
     * @return mixed
     */
    public function translation(?string $key = null, mixed $default = null): mixed
    {
        return $this->jsonColumn('translation', $key, $default);
    }
}

```

`app/Domains/Core/Schedule/ScheduleAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Schedule;

use Illuminate\Console\Scheduling\Event;
use Illuminate\Console\Scheduling\Schedule;
use App\Domains\Core\Job\JobAbstract;
use App\Services\Filesystem\Directory;

abstract class ScheduleAbstract
{
    /**
     * @var \Illuminate\Console\Scheduling\Schedule
     */
    protected Schedule $schedule;

    /**
     * @return void
     */
    abstract public function handle(): void;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param \Illuminate\Console\Scheduling\Schedule $schedule
     *
     * @return void
     */
    final public function __construct(Schedule $schedule)
    {
        $this->schedule = $schedule;
    }

    /**
     * @param string $command
     * @param string $log = ''
     * @param array $arguments = []
     *
     * @return \Illuminate\Console\Scheduling\Event
     */
    final protected function command(string $command, string $log = '', array $arguments = []): Event
    {
        $schedule = $this->schedule->command($command, $arguments)->runInBackground();

        if ($log) {
            $schedule->appendOutputTo($this->log('command', $log));
        }

        return $schedule;
    }

    /**
     * @param \App\Domains\Core\Job\JobAbstract $job
     * @param string $log = ''
     *
     * @return \Illuminate\Console\Scheduling\Event
     */
    final protected function job(JobAbstract $job, string $log = ''): Event
    {
        $job = $this->schedule->job($job)->withoutOverlapping(60);

        if ($log) {
            $job->appendOutputTo($this->log('job', $log));
        }

        return $job;
    }

    /**
     * @param string $type
     * @param string $name
     *
     * @return string
     */
    protected function log(string $type, string $name): string
    {
        $file = storage_path('logs/artisan/'.date('Y/m/d').'/schedule-'.$type.'-'.str_slug($name).'.log');

        Directory::create($file, true);

        return $file;
    }
}

```

`app/Domains/Core/Seeder/SeederAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Seeder;

use Closure;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

class SeederAbstract extends Seeder
{
    /**
     * @param string $name
     *
     * @return string
     */
    protected function file(string $name): string
    {
        return $this->pathDataFromClass().'/'.$name;
    }

    /**
     * @return string
     */
    protected function pathDataFromClass(): string
    {
        return base_path(lcfirst(dirname(str_replace('\\', '/', get_called_class())))).'/data';
    }

    /**
     * @param string $name
     *
     * @return string
     */
    protected function contents(string $name): string
    {
        return file_get_contents($this->file($name));
    }

    /**
     * @param string $name
     *
     * @return array
     */
    protected function json(string $name): array
    {
        return json_decode($this->contents($name.'.json'), true);
    }

    /**
     * @param \Closure $function
     *
     * @return void
     */
    protected function transaction(Closure $function): void
    {
        DB::transaction(function () use ($function) {
            Schema::disableForeignKeyConstraints();

            $function();

            Schema::enableForeignKeyConstraints();
        });
    }

    /**
     * @param string ...$tables
     *
     * @return void
     */
    protected function truncate(string ...$tables): void
    {
        Schema::disableForeignKeyConstraints();

        foreach ((array)$tables as $table) {
            DB::table($table)->truncate();
        }

        Schema::enableForeignKeyConstraints();
    }

    /**
     * @param string $model
     * @param string $key
     * @param array $rows
     *
     * @return void
     */
    protected function insertWithoutDuplicates(string $model, string $key, array $rows): void
    {
        $keys = $model::query()->withoutGlobalScopes()->pluck($key)->toArray();

        foreach ($rows as $row) {
            if (in_array($row[$key], $keys) === false) {
                $model::query()->insert($this->insertUpdateData($row));
            }
        }
    }

    /**
     * @param string $model
     * @param string $key
     * @param array $rows
     *
     * @return void
     */
    protected function updateBy(string $model, string $key, array $rows): void
    {
        foreach ($rows as $row) {
            $model::query()
                ->where($key, $row[$key])
                ->update($this->insertUpdateData($row));
        }
    }

    /**
     * @param array $row
     *
     * @return array
     */
    protected function insertUpdateData(array $row): array
    {
        return array_map(static fn ($value) => is_array($value) ? json_encode($value) : $value, $row);
    }
}

```

`app/Domains/Core/Service/Factory/Factory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Service\Factory;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Core\Mail\MailFactoryAbstract;
use App\Domains\Core\Model\ModelAbstract;
use App\Domains\Core\Validate\ValidateFactoryAbstract;

class Factory
{
    /**
     * @var string
     */
    protected string $namespace;

    /**
     * @var ?\Illuminate\Http\Request
     */
    protected ?Request $request;

    /**
     * @var ?\Illuminate\Contracts\Auth\Authenticatable
     */
    protected ?Authenticatable $auth;

    /**
     * @var ?\App\Domains\Core\Model\ModelAbstract
     */
    protected ?ModelAbstract $row;

    /**
     * @param string $namespace
     * @param ?\Illuminate\Http\Request $request = null
     * @param ?\Illuminate\Contracts\Auth\Authenticatable $auth = null
     *
     * @return self
     */
    public function __construct(
        string $namespace,
        ?Request $request = null,
        ?Authenticatable $auth = null,
        ?ModelAbstract $row = null
    ) {
        $this->namespace = $namespace;
        $this->request = $request;
        $this->auth = $auth;
        $this->row = $row;
    }

    /**
     * @param array $data = []
     *
     * @return \App\Domains\Core\Action\ActionFactoryAbstract
     */
    public function action(array $data = []): ActionFactoryAbstract
    {
        return $this->new($this->classFactory('Action'), $this->request, $this->auth, $this->row, $this->data($data));
    }

    /**
     * @param array $data = []
     *
     * @return \App\Domains\Core\Validate\ValidateFactoryAbstract
     */
    public function validate(array $data = []): ValidateFactoryAbstract
    {
        return $this->new($this->classFactory('Validate'), $this->request, $this->data($data));
    }

    /**
     * @return \App\Domains\Core\Mail\MailFactoryAbstract
     */
    public function mail(): MailFactoryAbstract
    {
        return $this->new($this->classFactory('Mail'), $this->auth);
    }

    /**
     * @param string $view
     * @param mixed $data
     * @param mixed ...$args
     *
     * @return ?array
     */
    public function fractal(string $view, $data, ...$args): ?array
    {
        return $this->new($this->classFactory('Fractal'))->transform($view, $data, ...$args);
    }

    /**
     * @param string $folder
     * @param ?string $class = null
     *
     * @return string
     */
    protected function class(string $folder, ?string $class = null): string
    {
        return $this->namespace.'\\'.$folder.'\\'.($class ?: $folder);
    }

    /**
     * @param string $name
     *
     * @return string
     */
    protected function classFactory(string $name): string
    {
        return $this->class($name).'Factory';
    }

    /**
     * @param string $class
     * @param mixed $args
     *
     * @return object
     */
    protected static function new(string $class, ...$args): object
    {
        return new $class(...$args);
    }

    /**
     * @param array $data = []
     *
     * @return array
     */
    protected function data(array $data = []): array
    {
        if ($data) {
            return $data;
        }

        if (empty($this->request)) {
            return [];
        }

        if (empty($this->request->route())) {
            return $this->request->all();
        }

        return array_merge($this->request->route()->parameters(), $this->request->all());
    }
}

```

`app/Domains/Core/Traits/Factory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Traits;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Database\ConnectionInterface;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use App\Domains\Core\Model\ModelAbstract;
use App\Domains\Core\Service\Factory\Factory as FactoryService;

trait Factory
{
    /**
     * @var ?\Illuminate\Http\Request
     */
    protected ?Request $request = null;

    /**
     * @var ?\Illuminate\Contracts\Auth\Authenticatable
     */
    protected ?Authenticatable $auth = null;

    /**
     * @var array
     */
    protected array $data = [];

    /**
     * @param ?string $domain = null
     * @param ?\App\Domains\Core\Model\ModelAbstract $row = null
     *
     * @return \App\Domains\Core\Service\Factory\Factory
     */
    final protected function factory(?string $domain = null, ?ModelAbstract $row = null): FactoryService
    {
        return new FactoryService($this->factoryNamespace($domain), $this->request, $this->auth, $this->factoryRow($domain, $row));
    }

    /**
     * @param ?string $domain = null
     *
     * @return string
     */
    final protected function factoryNamespace(?string $domain = null): string
    {
        return 'App\\Domains\\'.$this->factoryDomain($domain);
    }

    /**
     * @param ?string $domain = null
     *
     * @return string
     */
    final protected function factoryDomain(?string $domain = null): string
    {
        return $domain ?: explode('\\', get_called_class())[2];
    }

    /**
     * @param ?string $domain = null
     * @param ?\App\Domains\Core\Model\ModelAbstract $row = null
     *
     * @return ?\App\Domains\Core\Model\ModelAbstract
     */
    final protected function factoryRow(?string $domain = null, ?ModelAbstract $row = null): ?ModelAbstract
    {
        return ($row || ($domain !== null)) ? $row : ($this->row ?? null);
    }

    /**
     * @return \Illuminate\Database\ConnectionInterface
     */
    final protected function connection(): ConnectionInterface
    {
        return DB::connection($this->connectionName());
    }

    /**
     * @return string
     */
    protected function connectionName(): string
    {
        return config('database.default');
    }
}

```

`app/Domains/Core/Validate/Rule/CSRF.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Validate\Rule;

use Throwable;
use Illuminate\Contracts\Validation\Rule as RuleContract;

class CSRF implements RuleContract
{
    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $attribute
     * @param mixed $value
     *
     * @return bool
     */
    public function passes($attribute, $value): bool
    {
        try {
            return $value === csrf_token();
        } catch (Throwable $e) {
            return false;
        }
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return __('validator.csrf');
    }
}

```

`app/Domains/Core/Validate/ValidateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Validate;

use Illuminate\Http\Request;
use Illuminate\Support\MessageBag;
use App\Services\Validator\ValidatorAbstract;

abstract class ValidateAbstract extends ValidatorAbstract
{
    /**
     * @param ?\Illuminate\Http\Request $request
     * @param array $data
     *
     * @return self
     */
    final public function __construct(protected ?Request $request, protected array $data)
    {
    }

    /**
     * @param \Illuminate\Support\MessageBag $errors
     *
     * @return void
     */
    protected function notify(MessageBag $errors): void
    {
        $messages = $errors->messages();
        $key = key($messages);

        service()->message()->error($messages[$key][0], 'validate', $key);
    }
}

```

`app/Domains/Core/Validate/ValidateFactoryAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Core\Validate;

use BadMethodCallException;
use ReflectionClass;
use Illuminate\Http\Request;

abstract class ValidateFactoryAbstract
{
    /**
     * @param ?\Illuminate\Http\Request $request
     * @param array $data
     *
     * @return self
     */
    final public function __construct(protected ?Request $request, protected array $data)
    {
    }

    /**
     * @param string $class
     *
     * @return array
     */
    final protected function handle(string $class): array
    {
        return $class::new($this->request, $this->data)->handle();
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $name
     * @param array $arguments
     *
     * @return array
     */
    final public function __call(string $name, array $arguments): array
    {
        $class = (new ReflectionClass($this))->getNamespaceName().'\\'.ucfirst($name);

        if (class_exists($class) === false) {
            throw new BadMethodCallException(sprintf('Invalid Validator Method %s', $name));
        }

        return $this->handle($class);
    }
}

```

`app/Domains/CoreApp/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Action;

use App\Domains\Core\Action\ActionAbstract as ActionAbstractCore;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @return int
     */
    protected function userId(): int
    {
        if ($this->row?->user_id) {
            return $this->row->user_id;
        }

        if ($this->auth->managerMode() && ($this->data['user_id'] ?? false)) {
            return $this->data['user_id'];
        }

        return $this->auth->id;
    }

    /**
     * @return void
     */
    protected function dataUserId(): void
    {
        $this->data['user_id'] = $this->userId();
    }
}

```

`app/Domains/CoreApp/Action/Traits/Cache.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Action\Traits;

use Illuminate\Contracts\Cache\Repository;

trait Cache
{
    /**
     * @return void
     */
    protected function cacheClear(): void
    {
        if ($this->cacheClearEnabled()) {
            $this->cacheClearManager()->flush();
        }
    }

    /**
     * @param string $tag
     *
     * @return void
     */
    protected function cacheClearTag(string $tag): void
    {
        if ($this->cacheClearEnabled()) {
            $this->cacheClearManager($tag)->flush();
        }
    }

    /**
     * @return bool
     */
    protected function cacheClearEnabled(): bool
    {
        return $this->cacheClearConfig('enabled')
            && $this->cacheClearConfig('ttl');
    }

    /**
     * @param ?string $tag = null
     *
     * @return \Illuminate\Contracts\Cache\Repository
     */
    protected function cacheClearManager(?string $tag = null): Repository
    {
        $repository = $this->cacheClearRepository();

        if ($repository->supportsTags() === false) {
            return $repository;
        }

        return $repository->tags(implode('|', array_filter([$this->cacheClearTagGlobal(), $tag])));
    }

    /**
     * @return \Illuminate\Contracts\Cache\Repository
     */
    protected function cacheClearRepository(): Repository
    {
        static $repository;

        return $repository ??= resolve('cache')->store($this->cacheClearConfig('driver'));
    }

    /**
     * @return string
     */
    protected function cacheClearTagGlobal(): string
    {
        return $this->cacheClearConfig('tag');
    }

    /**
     * @param ?string $key = null
     *
     * @return mixed
     */
    protected function cacheClearConfig(?string $key = null): mixed
    {
        return $this->cacheClearConfigDefault()[$key] ?? null;
    }

    /**
     * @return array
     */
    protected function cacheClearConfigDefault(): array
    {
        static $config;

        return $config ??= config('database-cache', []) + [
            'enabled' => false,
            'driver' => 'redis',
            'ttl' => 3600,
            'tag' => 'database',
            'prefix' => 'database|',
        ];
    }
}

```

`app/Domains/CoreApp/Action/Traits/LogRow.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Action\Traits;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Collection;

trait LogRow
{
    /**
     * @param \Illuminate\Database\Eloquent\Model|array|null $row
     *
     * @return void
     */
    protected function logRow(Model|array|null $row = null): void
    {
        $this->factory('Log')->action([
            'class' => $this::class,
            'payload' => $this->logRowPayload(),
            'related' => $this->logRowRelated($row ??= $this->row),
        ])->create();
    }

    /**
     * @return array
     */
    protected function logRowPayload(): array
    {
        return [
            'data' => $this->data,
            'request' => $this->logRowPayloadRequest(),
        ];
    }

    /**
     * @return array
     */
    protected function logRowPayloadRequest(): array
    {
        return [
            'url' => $this->request?->fullUrl(),
            'parameters' => $this->request?->route()?->parameters(),
        ];
    }

    /**
     * @param \Illuminate\Database\Eloquent\Model|array|null $row
     *
     * @return array
     */
    protected function logRowRelated(Model|array|null $row): array
    {
        if ($row === null) {
            return [];
        }

        if (is_array($row)) {
            return array_map($this->logRowRelatedRow(...), $row);
        }

        return [$this->logRowRelatedRow($row)];
    }

    /**
     * @param \Illuminate\Database\Eloquent\Model $row
     *
     * @return array
     */
    protected function logRowRelatedRow(Model $row): array
    {
        return [
            'related_table' => $row->getTable(),
            'related_id' => $row->id,
            'payload' => ['row' => $row->withoutRelations()->toArray()],
        ];
    }

    /**
     * @param \Illuminate\Support\Collection $rows
     *
     * @return void
     */
    protected function logRows(Collection $rows): void
    {
        foreach ($rows as $row) {
            $this->logRow($row);
        }
    }
}

```

`app/Domains/CoreApp/Action/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Action;

use App\Domains\Core\Model\ModelAbstract;

abstract class UpdateBoolean extends ActionAbstract
{
    /**
     * @return \App\Domains\Core\Model\ModelAbstract
     */
    public function handle(): ModelAbstract
    {
        $this->before();
        $this->check();
        $this->data();
        $this->store();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function before(): void
    {
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        if (array_key_exists($this->data['column'], $this->row->toArray()) === false) {
            $this->exceptionValidator(__('validator.column-not-valid'));
        }
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataValue();
    }

    /**
     * @return void
     */
    protected function dataValue(): void
    {
        $value = $this->row->{$this->data['column']};

        $this->data['value'] = match (is_bool($value) || is_int($value)) {
            true => $this->dataValueBoolean($value),
            false => $this->dataValueDate($value),
        };
    }

    /**
     * @param bool|int $value
     *
     * @return bool
     */
    protected function dataValueBoolean(bool|int $value): bool
    {
        return empty($value);
    }

    /**
     * @param ?string $value
     *
     * @return ?string
     */
    protected function dataValueDate(?string $value): ?string
    {
        return $value ? null : date('Y-m-d H:i:s');
    }

    /**
     * @return void
     */
    protected function store(): void
    {
        $this->row->{$this->data['column']} = $this->data['value'];
        $this->row->save();
    }
}

```

`app/Domains/CoreApp/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Command;

use App\Domains\Core\Command\CommandAbstract as CommandAbstractCore;

abstract class CommandAbstract extends CommandAbstractCore
{
    /**
     * @return void
     */
    protected function middlewares(): void
    {
    }
}

```

`app/Domains/CoreApp/Controller/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Controller;

use App\Domains\Core\Controller\ControllerAbstract;

abstract class ControllerApiAbstract extends ControllerAbstract
{
}

```

`app/Domains/CoreApp/Controller/ControllerWebAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Controller;

use App\Domains\Core\Controller\ControllerWebAbstract as CoreControllerWebAbstract;

abstract class ControllerWebAbstract extends CoreControllerWebAbstract
{
}

```

`app/Domains/CoreApp/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Controller\Service;

use App\Domains\Core\Controller\Service\ControllerAbstract as ControllerAbstractCore;
use App\Domains\Device\Model\Collection\Device as DeviceCollection;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\User\Model\Collection\User as UserCollection;
use App\Domains\User\Model\User as UserModel;
use App\Domains\Vehicle\Model\Collection\Vehicle as VehicleCollection;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

abstract class ControllerAbstract extends ControllerAbstractCore
{
    /**
     * @var bool
     */
    protected bool $userEmpty = false;

    /**
     * @var bool
     */
    protected bool $vehicleEmpty = false;

    /**
     * @var bool
     */
    protected bool $deviceEmpty = false;

    /**
     * @param string $column
     * @param bool $empty
     *
     * @return int|string|null
     */
    protected function filtersId(string $column, bool $empty): int|string|null
    {
        if (is_null($id = $this->filtersIdByRequest($column, $empty))) {
            if (is_null($id = $this->filtersIdByUserPreference($column, $empty))) {
                $id = $this->filtersIdByMethod($column);
            }
        }

        if (is_null($id) === false) {
            return $this->auth->preference($column, $id);
        }

        return $id;
    }

    /**
     * @param string $column
     *
     * @return int|string|null
     */
    protected function filtersIdByRequest(string $column, bool $empty): int|string|null
    {
        if ($id = $this->request->input($column)) {
            return $id;
        }

        if ($id === null) {
            return null;
        }

        if ($empty) {
            return $id;
        }

        $this->request->input([$column => null]);

        return null;
    }

    /**
     * @param string $column
     *
     * @return int|string|null
     */
    protected function filtersIdByUserPreference(string $column, bool $empty): int|string|null
    {
        if ($id = $this->auth->preference($column)) {
            return $id;
        }

        if ($empty) {
            return $id;
        }

        return null;
    }

    /**
     * @param string $column
     *
     * @return int|string|null
     */
    protected function filtersIdByMethod(string $column): int|string|null
    {
        $method = preg_replace('/_id$/', '', $column);

        return $this->$method()?->id;
    }

    /**
     * @return void
     */
    protected function filtersUserId(): void
    {
        $this->request->merge(['user_id' => $this->filtersId('user_id', $this->userEmpty)]);
    }

    /**
     * @return void
     */
    protected function filtersVehicleId(): void
    {
        $this->request->merge(['vehicle_id' => $this->filtersId('vehicle_id', $this->vehicleEmpty)]);
    }

    /**
     * @return void
     */
    protected function filtersDeviceId(): void
    {
        $this->request->merge(['device_id' => $this->filtersId('device_id', $this->deviceEmpty)]);
    }

    /**
     * @return array
     */
    protected function dataCore(): array
    {
        return [
            'users' => $this->users(),
            'users_multiple' => $this->usersMultiple(),
            'user' => $this->user(),
            'user_empty' => $this->userEmpty(),
        ];
    }

    /**
     * @return \App\Domains\Device\Model\Collection\Device
     */
    protected function devices(): DeviceCollection
    {
        return $this->cache(
            fn () => DeviceModel::query()
                ->whenUserId($this->user()?->id)
                ->whenVehicleId($this->vehicle()?->id)
                ->listSimple()
                ->get()
        );
    }

    /**
     * @return bool
     */
    protected function devicesMultiple(): bool
    {
        return $this->devices()->count() > 1;
    }

    /**
     * @return ?\App\Domains\Device\Model\Device
     */
    protected function device(): ?DeviceModel
    {
        return $this->cache(function () {
            $device_id = $this->request->input('device_id');

            if ($this->deviceEmpty && ($device_id === '')) {
                return;
            }

            $devices = $this->devices();

            if ($device_id === null) {
                return $devices->first();
            }

            return $devices->firstWhere('id', $device_id)
                ?: $devices->first();
        });
    }

    /** @return bool
     */
    protected function deviceEmpty(): bool
    {
        return $this->cache(fn () => empty($this->device()));
    }

    /**
     * @return \App\Domains\User\Model\Collection\User
     */
    protected function users(): UserCollection
    {
        return $this->cache(function () {
            if ($this->auth->managerMode() === false) {
                return new UserCollection();
            }

            return UserModel::query()
                ->listSimple()
                ->get();
        });
    }

    /**
     * @return bool
     */
    protected function usersMultiple(): bool
    {
        return $this->users()->count() > 1;
    }

    /**
     * @return ?\App\Domains\User\Model\User
     */
    protected function user(): ?UserModel
    {
        return $this->cache(function () {
            if ($this->auth->managerMode() === false) {
                return $this->auth;
            }

            if (isset($this->row->user_id)) {
                return $this->users()->firstWhere('id', $this->row->user_id);
            }

            $user_id = $this->request->input('user_id');

            if ($this->userEmpty && ($user_id === '')) {
                return;
            }

            if ($user_id === null) {
                return $this->auth;
            }

            return $this->users()->firstWhere('id', $user_id)
                ?: $this->auth;
        });
    }

    /**
     * @return bool
     */
    protected function userEmpty(): bool
    {
        return $this->cache(fn () => empty($this->user()));
    }

    /**
     * @return \App\Domains\Vehicle\Model\Collection\Vehicle
     */
    protected function vehicles(): VehicleCollection
    {
        return $this->cache(
            fn () => VehicleModel::query()
                ->whenUserId($this->user()?->id)
                ->listSimple()
                ->get()
        );
    }

    /**
     * @return bool
     */
    protected function vehiclesMultiple(): bool
    {
        return $this->vehicles()->count() > 1;
    }

    /**
     * @return ?\App\Domains\Vehicle\Model\Vehicle
     */
    protected function vehicle(): ?VehicleModel
    {
        return $this->cache(function () {
            $vehicle_id = $this->request->input('vehicle_id');

            if ($this->vehicleEmpty && ($vehicle_id === '')) {
                return;
            }

            $vehicles = $this->vehicles();

            if ($vehicle_id === null) {
                return $vehicles->first();
            }

            return $vehicles->firstWhere('id', $vehicle_id)
                ?: $vehicles->first();
        });
    }

    /**
     * @return bool
     */
    protected function vehicleEmpty(): bool
    {
        return $this->cache(fn () => empty($this->vehicle()));
    }
}

```

`app/Domains/CoreApp/ControllerApi/Service/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\ControllerApi\Service;

use App\Domains\Core\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerApiAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/CoreApp/Migration/MigrationAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Migration;

use App\Domains\Core\Migration\MigrationAbstract as MigrationAbstractCore;

abstract class MigrationAbstract extends MigrationAbstractCore
{
}

```

`app/Domains/CoreApp/Model/Builder/BuilderAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Model\Builder;

use App\Domains\Core\Model\Builder\BuilderAbstract as BuilderAbstractCore;
use App\Domains\User\Model\User as UserModel;

abstract class BuilderAbstract extends BuilderAbstractCore
{
    /**
     * @param int $device_id
     *
     * @return self
     */
    public function byDeviceId(int $device_id): self
    {
        return $this->where('device_id', $device_id);
    }

    /**
     * @param array $device_ids
     *
     * @return self
     */
    public function byDeviceIds(array $device_ids): self
    {
        return $this->whereIntegerInRaw('device_id', $device_ids);
    }

    /**
     * @param \App\Domains\User\Model\User $user
     *
     * @return self
     */
    public function byUserOrManager(UserModel $user): self
    {
        return $this->when($user->managerMode() === false, fn ($q) => $q->byUserId($user->id));
    }

    /**
     * @param int $vehicle_id
     *
     * @return self
     */
    public function byVehicleId(int $vehicle_id): self
    {
        return $this->where('vehicle_id', $vehicle_id);
    }

    /**
     * @param array $vehicle_ids
     *
     * @return self
     */
    public function byVehicleIds(array $vehicle_ids): self
    {
        return $this->whereIntegerInRaw('vehicle_id', $vehicle_ids);
    }

    /**
     * @param ?int $id
     *
     * @return self
     */
    public function whenId(?int $id): self
    {
        return $this->when($id, fn ($q) => $q->byId($id));
    }

    /**
     * @param ?int $device_id
     *
     * @return self
     */
    public function whenDeviceId(?int $device_id): self
    {
        return $this->when($device_id, fn ($q) => $q->byDeviceId($device_id));
    }

    /**
     * @param ?int $user_id
     *
     * @return self
     */
    public function whenUserId(?int $user_id): self
    {
        return $this->when($user_id, fn ($q) => $q->byUserId($user_id));
    }

    /**
     * @param ?int $vehicle_id
     *
     * @return self
     */
    public function whenVehicleId(?int $vehicle_id): self
    {
        return $this->when($vehicle_id, fn ($q) => $q->byVehicleId($vehicle_id));
    }

    /**
     * @param string $relation
     *
     * @return self
     */
    public function withSimple(string $relation): self
    {
        return $this->with([$relation => fn ($q) => $q->selectRelated()]);
    }

    /**
     * @return self
     */
    public function withUser(): self
    {
        return $this->with('user');
    }
}

```

`app/Domains/CoreApp/Model/Builder/Traits/Gis.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Model\Builder\Traits;

trait Gis
{
    /**
     * @param float $latitude
     * @param float $longitude
     * @param int $meters
     *
     * @return self
     */
    public function inRadius(float $latitude, float $longitude, int $meters): self
    {
        return $this->whereRaw($this->inRadiusSql($latitude, $longitude, $meters));
    }

    /**
     * @param float $latitude
     * @param float $longitude
     * @param int $meters
     *
     * @return string
     */
    protected function inRadiusSql(float $latitude, float $longitude, int $meters): string
    {
        return sprintf(
            'ST_Intersects(ST_Buffer(ST_SRID(POINT(%f, %f), 4326), %d), ST_SRID(`point`, 4326))',
            helper()->longitude($longitude),
            helper()->latitude($latitude),
            $meters,
        );
    }
}

```

`app/Domains/CoreApp/Model/Collection/CollectionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Model\Collection;

use App\Domains\Core\Model\Collection\CollectionAbstract as CollectionAbstractCore;

abstract class CollectionAbstract extends CollectionAbstractCore
{
}

```

`app/Domains/CoreApp/Model/ModelAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Model;

use App\Domains\Core\Model\ModelAbstract as ModelAbstractCore;

abstract class ModelAbstract extends ModelAbstractCore
{
}

```

`app/Domains/CoreApp/Model/PivotAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Model;

use App\Domains\Core\Model\PivotAbstract as PivotAbstractCore;

abstract class PivotAbstract extends PivotAbstractCore
{
}

```

`app/Domains/CoreApp/Model/Traits/Content.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Model\Traits;

use App\Domains\Core\Model\Traits\JsonColumn;

trait Content
{
    use JsonColumn;

    /**
     * @param string $key
     * @param mixed $default = null
     *
     * @return mixed
     */
    public function content(string $key, mixed $default = null): mixed
    {
        return $this->jsonColumn('content', $key, $default);
    }
}

```

`app/Domains/CoreApp/Model/Traits/Gis.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Model\Traits;

use stdClass;
use Illuminate\Contracts\Database\Query\Expression;

trait Gis
{
    /**
     * @return string
     */
    public static function emptyGeoJSON(): string
    {
        return 'ST_GeomFromText("MULTIPOLYGON(((0 90,0 90,0 90,0 90)))", 0)';
    }

    /**
     * @param float $latitude
     * @param float $longitude
     *
     * @return \Illuminate\Contracts\Database\Query\Expression
     */
    public static function pointFromLatitudeLongitude(float $latitude, float $longitude): Expression
    {
        return static::db()->raw(sprintf(
            'ST_PointFromText("POINT(%f %f)", 4326, "axis-order=long-lat")',
            helper()->longitude($longitude),
            helper()->latitude($latitude)
        ));
    }

    /**
     * @param \stdClass $json
     * @param float $simplify = 0
     *
     * @return \Illuminate\Contracts\Database\Query\Expression
     */
    public static function geomFromGeoJSON(stdClass $json, float $simplify = 0): Expression
    {
        if ($json->type !== 'MultiPolygon') {
            $json->type = 'MultiPolygon';
            $json->coordinates = [$json->coordinates];
        }

        $sql = sprintf("ST_GeomFromGeoJSON('%s', 2, 0)", json_encode($json));

        if ($simplify) {
            $sql = 'ST_Simplify('.$sql.', '.$simplify.')';
        }

        return static::db()->raw($sql);
    }
}

```

`app/Domains/CoreApp/Validate/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreApp\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

abstract class UpdateBoolean extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'column' => 'bail|required|string',
        ];
    }

    /**
     * @return array
     */
    public function messages(): array
    {
        return [
            'column.required' => __('validator.column-required'),
        ];
    }
}

```

`app/Domains/CoreMaintenance/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Action;

use InvalidArgumentException;
use ReflectionClass;
use UnexpectedValueException;
use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var array
     */
    protected array $config;

    /**
     * @param string $key
     *
     * @return mixed
     */
    protected function config(string $key): mixed
    {
        $this->config ??= $this->configLoad();

        if (array_key_exists($key, $this->config) === false) {
            throw new InvalidArgumentException(sprintf('Invalid config key %s', $key));
        }

        return $this->config[$key];
    }

    /**
     * @return array
     */
    protected function configLoad(): array
    {
        $name = snake_case((new ReflectionClass($this))->getShortName(), '-');
        $config = config('maintenance.'.$name);

        if (is_array($config) === false) {
            throw new UnexpectedValueException(sprintf('Invalid Config %s', $name));
        }

        return $config;
    }
}

```

`app/Domains/CoreMaintenance/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @return void
     */
    public function curlCacheClean(): void
    {
        $this->actionHandle(CurlCacheClean::class);
    }

    /**
     * @return void
     */
    public function domainCreate(): void
    {
        $this->actionHandle(DomainCreate::class, $this->validate()->domainCreate());
    }

    /**
     * @return void
     */
    public function directoryEmptyDelete(): void
    {
        $this->actionHandle(DirectoryEmptyDelete::class);
    }

    /**
     * @return void
     */
    public function fileDeleteOld(): void
    {
        $this->actionHandle(FileDeleteOld::class);
    }

    /**
     * @return void
     */
    public function fileZip(): void
    {
        $this->actionHandle(FileZip::class);
    }

    /**
     * @return void
     */
    public function mailTestQueue(): void
    {
        $this->actionHandle(MailTestQueue::class, $this->validate()->mailTestQueue());
    }

    /**
     * @return void
     */
    public function mailTestSend(): void
    {
        $this->actionHandle(MailTestSend::class, $this->validate()->mailTestSend());
    }

    /**
     * @return void
     */
    public function migrationClean(): void
    {
        $this->actionHandle(MigrationClean::class);
    }

    /**
     * @return array
     */
    public function opcachePreload(): array
    {
        return $this->actionHandle(OpcachePreload::class);
    }
}

```

`app/Domains/CoreMaintenance/Action/CurlCacheClean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Action;

use Generator;
use App\Services\Filesystem\Directory;

class CurlCacheClean extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        if ($this->enabled() === false) {
            return;
        }

        $this->data();
        $this->iterate();
    }

    /**
     * @return bool
     */
    protected function enabled(): bool
    {
        return boolval($this->config('path'));
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataPath();
        $this->dataTime();
    }

    /**
     * @return void
     */
    protected function dataPath(): void
    {
        $this->data['path'] = base_path($this->config('path'));
    }

    /**
     * @return void
     */
    protected function dataTime(): void
    {
        $this->data['time'] = time();
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->scan() as $file) {
            $this->file($file);
        }
    }

    /**
     * @return \Generator
     */
    protected function scan(): Generator
    {
        return Directory::files($this->data['path']);
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function file(string $file): void
    {
        if (filemtime($file) < $this->data['time']) {
            $this->delete($file);
        }
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function delete(string $file): void
    {
        unlink($file);
    }
}

```

`app/Domains/CoreMaintenance/Action/DirectoryEmptyDelete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Action;

class DirectoryEmptyDelete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        if ($this->enabled() === false) {
            return;
        }

        $this->data();
        $this->iterate();
    }

    /**
     * @return bool
     */
    protected function enabled(): bool
    {
        return boolval($this->config('path'));
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataPath();
    }

    /**
     * @return void
     */
    protected function dataPath(): void
    {
        $this->data['path'] = base_path($this->config('path'));
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        $this->iterateRecursive($this->data['path']);
    }

    /**
     * @param string $path
     *
     * @return void
     */
    protected function iterateRecursive(string $path): void
    {
        foreach ($this->scan($path) as $directory) {
            if (is_dir($path.'/'.$directory)) {
                $this->iterateRecursive($path.'/'.$directory);
            }
        }

        if ($this->pathIsEmpty($path)) {
            $this->delete($path);
        }
    }

    /**
     * @param string $path
     *
     * @return array
     */
    protected function scan(string $path): array
    {
        return array_diff(scandir($path), ['.', '..']);
    }

    /**
     * @param string $path
     *
     * @return bool
     */
    protected function pathIsEmpty(string $path): bool
    {
        return ($path !== $this->data['path'])
            && empty(array_diff(scandir($path), ['.', '..']));
    }

    /**
     * @param string $path
     *
     * @return void
     */
    protected function delete(string $path): void
    {
        rmdir($path);
    }
}

```

`app/Domains/CoreMaintenance/Action/DomainCreate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Action;

use App\Domains\CoreMaintenance\Service\Domain\Create as CreateService;

class DomainCreate extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->check();
        $this->iterate();
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        if (preg_match('/^[A-Z][a-zA-Z0-9]+$/', $this->data['name']) === 0) {
            $this->exceptionValidator(sprintf('Invalid domain name %s', $this->data['name']));
        }
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach (CreateService::SECTIONS as $section) {
            $this->section($section);
        }
    }

    /**
     * @param string $section
     *
     * @return void
     */
    protected function section(string $section): void
    {
        if ($this->data[strtolower($section)] ?? false) {
            CreateService::new($this->data['name'], $section)->handle();
        }
    }
}

```

`app/Domains/CoreMaintenance/Action/FileDeleteOld.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Action;

use Generator;
use App\Services\Filesystem\Directory;

class FileDeleteOld extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        if ($this->enabled() === false) {
            return;
        }

        $this->data();
        $this->iterate();
    }

    /**
     * @return bool
     */
    protected function enabled(): bool
    {
        return $this->config('path')
            && $this->config('extensions')
            && $this->config('days');
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataPath();
        $this->dataTime();
        $this->dataExtensions();
    }

    /**
     * @return void
     */
    protected function dataPath(): void
    {
        $this->data['path'] = base_path($this->config('path'));
    }

    /**
     * @return void
     */
    protected function dataTime(): void
    {
        $this->data['time'] = strtotime('-'.$this->config('days').' days');
    }

    /**
     * @return void
     */
    protected function dataExtensions(): void
    {
        $this->data['extensions'] = $this->config('extensions');
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->scan() as $file) {
            $this->file($file);
        }
    }

    /**
     * @return \Generator
     */
    protected function scan(): Generator
    {
        return Directory::files($this->data['path'], $this->scanInclude());
    }

    /**
     * @return string
     */
    protected function scanInclude(): string
    {
        return '/\.('.implode('|', $this->data['extensions']).')$/i';
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function file(string $file): void
    {
        if (filemtime($file) < $this->data['time']) {
            $this->delete($file);
        }
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function delete(string $file): void
    {
        unlink($file);
    }
}

```

`app/Domains/CoreMaintenance/Action/FileZip.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Action;

use App\Services\Compress\Zip\File as ZipFile;

class FileZip extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        if ($this->enabled() === false) {
            return;
        }

        $this->data();
        $this->compress();
    }

    /**
     * @return bool
     */
    protected function enabled(): bool
    {
        return $this->config('path')
            && $this->config('days')
            && $this->config('extensions');
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataPath();
        $this->dataTime();
        $this->dataExtensions();
    }

    /**
     * @return void
     */
    protected function dataPath(): void
    {
        $this->data['path'] = base_path($this->config('path'));
    }

    /**
     * @return void
     */
    protected function dataTime(): void
    {
        $this->data['time'] = strtotime('-'.$this->config('days').' days');
    }

    /**
     * @return void
     */
    protected function dataExtensions(): void
    {
        $this->data['extensions'] = $this->config('extensions');
    }

    /**
     * @return void
     */
    protected function compress(): void
    {
        (new ZipFile($this->data['path']))
            ->extensions($this->data['extensions'])
            ->toTime($this->data['time'])
            ->compress();
    }
}

```

`app/Domains/CoreMaintenance/Action/MailTestQueue.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Action;

class MailTestQueue extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->send();
    }

    /**
     * @return void
     */
    protected function send(): void
    {
        $this->factory()->mail()->testQueue($this->data['email']);
    }
}

```

`app/Domains/CoreMaintenance/Action/MailTestSend.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Action;

class MailTestSend extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->send();
    }

    /**
     * @return void
     */
    protected function send(): void
    {
        $this->factory()->mail()->testSend($this->data['email']);
    }
}

```

`app/Domains/CoreMaintenance/Action/MigrationClean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Action;

use Illuminate\Support\Facades\DB;

class MigrationClean extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->iterate();
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach (DB::table('migrations')->pluck('migration') as $each) {
            $this->check($each);
        }
    }

    /**
     * @param string $migration
     *
     * @return void
     */
    protected function check(string $migration): void
    {
        if (is_file($this->file($migration)) === false) {
            DB::table('migrations')->where('migration', $migration)->delete();
        }
    }

    /**
     * @param string $migration
     *
     * @return string
     */
    protected function file(string $migration): string
    {
        return base_path('database/migrations/'.$migration.'.php');
    }
}

```

`app/Domains/CoreMaintenance/Action/OpcachePreload.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Action;

use App\Domains\CoreMaintenance\Service\OPcache\Preloader;

class OpcachePreload extends ActionAbstract
{
    /**
     * @return array
     */
    public function handle(): array
    {
        return $this->preload();
    }

    /**
     * @return array
     */
    protected function preload(): array
    {
        return (new Preloader($this->base()))
            ->paths(...$this->paths())
            ->ignore(...$this->ignore())
            ->load()
            ->log();
    }

    /**
     * @return string
     */
    protected function base(): string
    {
        return base_path('');
    }

    /**
     * @return array
     */
    protected function paths(): array
    {
        return [
            base_path('app'),
            base_path('vendor/laravel'),
        ];
    }

    /**
     * @return array
     */
    protected function ignore(): array
    {
        return [
            'Illuminate\Http\Testing',
            'Illuminate\Filesystem\Cache',
            'Illuminate\Foundation\Testing',
            'Illuminate\Testing',
            'Laravel\Octane',
            'PHPUnit',
            'Swoole',
            'Tests',
            '/App\\\Domains\\\[^\\\]+\\\Test/',
        ];
    }
}

```

`app/Domains/CoreMaintenance/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Command;

use App\Domains\Core\Command\CommandAbstract as CommandAbstractCore;

abstract class CommandAbstract extends CommandAbstractCore
{
}

```

`app/Domains/CoreMaintenance/Command/CurlCacheClean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Command;

class CurlCacheClean extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:maintenance:curl:cache:clean';

    /**
     * @var string
     */
    protected $description = 'Delete expired curl cache files';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('START');

        $this->factory()->action()->curlCacheClean();

        $this->info('END');
    }
}

```

`app/Domains/CoreMaintenance/Command/DirectoryEmptyDelete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Command;

class DirectoryEmptyDelete extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:maintenance:directory:empty:delete';

    /**
     * @var string
     */
    protected $description = 'Delete empty storage/logs directories';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('START');

        $this->factory()->action()->directoryEmptyDelete();

        $this->info('END');
    }
}

```

`app/Domains/CoreMaintenance/Command/DomainCreate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Command;

class DomainCreate extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:maintenance:domain:create {--name=} {--action} {--command} {--controller} {--exception} {--fractal} {--job} {--mail} {--middleware} {--model} {--schedule} {--seeder} {--test} {--validate}';

    /**
     * @var string
     */
    protected $description = 'Create a Domain {--name=} with {--action} {--command} {--controller} {--exception} {--fractal} {--job} {--mail} {--middleware} {--model} {--schedule} {--seeder} {--test} {--validate}';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('START');

        $this->checkOption('name');
        $this->requestWithOptions();

        $this->factory()->action()->domainCreate();

        $this->info(sprintf('Created Domain %s', $this->option('name')));

        $this->info('END');
    }
}

```

`app/Domains/CoreMaintenance/Command/FileDeleteOld.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Command;

class FileDeleteOld extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:maintenance:file:delete:old';

    /**
     * @var string
     */
    protected $description = 'Delete old logs files files';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('START');

        $this->factory()->action()->fileDeleteOld();

        $this->info('END');
    }
}

```

`app/Domains/CoreMaintenance/Command/FileZip.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Command;

class FileZip extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:maintenance:file:zip';

    /**
     * @var string
     */
    protected $description = 'Compress old files on folder storage/logs';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('START');

        $this->factory()->action()->fileZip();

        $this->info('END');
    }
}

```

`app/Domains/CoreMaintenance/Command/MigrationClean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Command;

class MigrationClean extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:maintenance:migration:clean';

    /**
     * @var string
     */
    protected $description = 'Clean "migrations" table if migration file not exists';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('START');

        $this->factory()->action()->migrationClean();

        $this->info('END');
    }
}

```

`app/Domains/CoreMaintenance/Command/OpcachePreload.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Command;

class OpcachePreload extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:maintenance:opcache:preload';

    /**
     * @var string
     */
    protected $description = 'Preload Opcache';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('START');

        $this->factory()->action()->opcachePreload();

        $this->info('END');
    }
}

```

`app/Domains/CoreMaintenance/Schedule/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Schedule;

use App\Domains\Core\Schedule\ScheduleAbstract;
use App\Domains\CoreMaintenance\Command\CurlCacheClean as CurlCacheCleanCommand;
use App\Domains\CoreMaintenance\Command\DirectoryEmptyDelete as DirectoryEmptyDeleteCommand;
use App\Domains\CoreMaintenance\Command\FileDeleteOld as FileDeleteOldCommand;
use App\Domains\CoreMaintenance\Command\FileZip as FileZipCommand;

class Manager extends ScheduleAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->cachePruneStaleTags();
        $this->queuePruneFailed();
        $this->fileZip();
        $this->fileDeleteOld();
        $this->curlCacheClean();
        $this->directoryEmptyDelete();
    }

    /**
     * @return void
     */
    protected function cachePruneStaleTags(): void
    {
        $this->command('cache:prune-stale-tags', 'cache-prune-stale-tags')
            ->hourly();
    }

    /**
     * @return void
     */
    protected function queuePruneFailed(): void
    {
        $this->command('queue:prune-failed', 'queue-prune-failed', [
            '--hours' => 120,
        ])->daily();
    }

    /**
     * @return void
     */
    protected function fileZip(): void
    {
        $this->command(FileZipCommand::class, 'core-maintenance-file-zip')
            ->dailyAt('01:05');
    }

    /**
     * @return void
     */
    protected function fileDeleteOld(): void
    {
        $this->command(FileDeleteOldCommand::class, 'core-maintenance-file-delete-old')
            ->dailyAt('01:15');
    }

    /**
     * @return void
     */
    protected function curlCacheClean(): void
    {
        $this->command(CurlCacheCleanCommand::class, 'core-maintenance-curl-cache-clean')
            ->dailyAt('01:20');
    }

    /**
     * @return void
     */
    protected function directoryEmptyDelete(): void
    {
        $this->command(DirectoryEmptyDeleteCommand::class, 'core-maintenance-directory-empty-delete')
            ->dailyAt('01:25');
    }
}

```

`app/Domains/CoreMaintenance/Service/Domain/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Service\Domain;

use App\Exceptions\ValidatorException;
use App\Services\Filesystem\Directory;
use App\Services\Filesystem\File;

class Create
{
    /**
     * @const
     */
    public const SECTIONS = [
        'Action', 'Command', 'Controller', 'Exception', 'Fractal',
        'Job', 'Mail', 'Middleware', 'Model', 'Schedule',
        'Seeder', 'Test', 'Validate',
    ];

    /**
     * @var string
     */
    protected string $base;

    /**
     * @var string
     */
    protected string $target;

    /**
     * @var string
     */
    protected string $name;

    /**
     * @var string
     */
    protected string $table;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param string $domain
     * @param string $section
     *
     * @return self
     */
    public function __construct(protected string $domain, protected string $section)
    {
        $this->check();
        $this->config();
    }

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->copy();
        $this->section();
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkName();
        $this->checkSection();
    }

    /**
     * @return void
     */
    protected function checkName(): void
    {
        if (preg_match('/^[A-Z][a-zA-Z0-9]+$/', $this->domain) === 0) {
            throw new ValidatorException(sprintf('Invalid domain name %s', $this->domain));
        }
    }

    /**
     * @return void
     */
    protected function checkSection(): void
    {
        if (in_array($this->section, static::SECTIONS) === false) {
            throw new ValidatorException(sprintf('Invalid section %s', $this->section));
        }
    }

    /**
     * @return void
     */
    protected function config(): void
    {
        $this->base = __DIR__.'/stub';
        $this->target = app_path('Domains/'.$this->domain);
        $this->name = snake_case($this->domain, '-');
        $this->table = snake_case($this->domain, '_');
    }

    /**
     * @return void
     */
    protected function copy(): void
    {
        foreach (Directory::files($this->base.'/'.$this->section) as $file) {
            $this->file($file);
        }
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function file(string $file): void
    {
        $target = $this->fileTarget($file);

        if (is_file($target) === false) {
            File::write($target, $this->fileContents($file));
        }
    }

    /**
     * @param string $file
     *
     * @return string
     */
    protected function fileTarget(string $file): string
    {
        return $this->target.preg_replace('/\.stub$/', '.php', $this->replace(str_replace($this->base, '', $file)));
    }

    /**
     * @param string $file
     *
     * @return string
     */
    protected function fileContents(string $file): string
    {
        return $this->replace(file_get_contents($file));
    }

    /**
     * @param string $string
     *
     * @return string
     */
    protected function replace(string $string): string
    {
        return strtr($string, [
            '{{ domain }}' => $this->domain,
            '__domain__' => $this->domain,
            '{{ name }}' => $this->name,
            '__name__' => $this->name,
            '{{ table }}' => $this->table,
            '__table__' => $this->table,
        ]);
    }

    /**
     * @return void
     */
    protected function section(): void
    {
        $class = __NAMESPACE__.'\\Section\\'.$this->section.'\\Create';

        if (class_exists($class)) {
            $class::new($this->domain)->handle();
        }
    }
}

```

`app/Domains/CoreMaintenance/Service/Domain/Section/SectionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Service\Domain\Section;

abstract class SectionAbstract
{
    /**
     * @var string
     */
    protected string $base;

    /**
     * @var string
     */
    protected string $name;

    /**
     * @var string
     */
    protected string $table;

    /**
     * @return void
     */
    abstract public function handle(): void;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param string $domain
     *
     * @return self
     */
    public function __construct(protected string $domain)
    {
        $this->config();
    }

    /**
     * @return void
     */
    protected function config(): void
    {
        $this->base = app_path('Domains/'.$this->domain);
        $this->name = snake_case($this->domain, '-');
        $this->table = snake_case($this->domain, '_');
    }
}

```

`app/Domains/CoreMaintenance/Service/OPcache/Preloader.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Service\OPcache;

class Preloader
{
    /**
     * @var int
     */
    protected static int $count = 0;

    /**
     * @var array
     */
    protected array $ignores = [];

    /**
     * @var array
     */
    protected array $paths;

    /**
     * @var array
     */
    protected array $fileMap;

    /**
     * @var array
     */
    protected array $classMap;

    /**
     * @var array
     */
    protected array $log = [];

    /**
     * @param string $base
     *
     * @return self
     */
    public function __construct(string $base)
    {
        $this->classMap = require $base.'/vendor/composer/autoload_classmap.php';
        $this->fileMap = array_flip($this->classMap);
    }

    /**
     * @param string ...$paths
     *
     * @return self
     */
    public function paths(string ...$paths): self
    {
        $this->paths = $paths;

        return $this;
    }

    /**
     * @param string ...$names
     *
     * @return self
     */
    public function ignore(string ...$names): self
    {
        $this->ignores = array_merge($this->ignores, $names);

        return $this;
    }

    /**
     * @return self
     */
    public function load(): self
    {
        static::$count = 0;

        $time = microtime(true);

        foreach ($this->paths as $path) {
            $this->path(rtrim($this->classMap[$path] ?? $path, '/'));
        }

        $this->log['summary'] = sprintf('Preloaded %d classes in %.03f seconds', static::$count, microtime(true) - $time);

        return $this;
    }

    /**
     * @return array
     */
    public function log(): array
    {
        return $this->log;
    }

    /**
     * @param string $path
     *
     * @return void
     */
    protected function path(string $path): void
    {
        if (is_dir($path)) {
            $this->dir($path);
        } else {
            $this->file($path);
        }
    }

    /**
     * @param string $path
     *
     * @return void
     */
    protected function dir(string $path): void
    {
        $handle = opendir($path);

        while ($file = readdir($handle)) {
            if (!in_array($file, ['.', '..'])) {
                $this->path($path.'/'.$file);
            }
        }

        closedir($handle);
    }

    /**
     * @param string $path
     *
     * @return void
     */
    protected function file(string $path): void
    {
        $class = $this->fileMap[$path] ?? null;

        if (empty($class)) {
            return;
        }

        if ($this->ignored($class)) {
            $this->log['ignored'][] = $class;

            return;
        }

        require_once $path;

        static::$count++;

        $this->log['preloaded'][] = $class;
    }

    /**
     * @param ?string $name
     *
     * @return bool
     */
    protected function ignored(?string $name): bool
    {
        if (empty($name)) {
            return true;
        }

        foreach ($this->ignores as $ignore) {
            if (str_starts_with($ignore, '/')) {
                if (preg_match($ignore, $name) !== 0) {
                    return true;
                }
            } elseif (str_starts_with($name, $ignore)) {
                return true;
            }
        }

        return false;
    }
}

```

`app/Domains/CoreMaintenance/Validate/DomainCreate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class DomainCreate extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'string', 'required'],
            'action' => ['bail', 'boolean'],
            'command' => ['bail', 'boolean'],
            'controller' => ['bail', 'boolean'],
            'exception' => ['bail', 'boolean'],
            'fractal' => ['bail', 'boolean'],
            'job' => ['bail', 'boolean'],
            'middleware' => ['bail', 'boolean'],
            'mail' => ['bail', 'boolean'],
            'model' => ['bail', 'boolean'],
            'schedule' => ['bail', 'boolean'],
            'seeder' => ['bail', 'boolean'],
            'test' => ['bail', 'boolean'],
            'validate' => ['bail', 'boolean'],
        ];
    }
}

```

`app/Domains/CoreMaintenance/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreMaintenance\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/CoreTranslation/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;

abstract class ActionAbstract extends ActionAbstractCore
{
}

```

`app/Domains/CoreTranslation/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @return void
     */
    public function clean(): void
    {
        $this->actionHandle(Clean::class);
    }

    /**
     * @return void
     */
    public function fill(): void
    {
        $this->actionHandle(Fill::class);
    }

    /**
     * @return void
     */
    public function fix(): void
    {
        $this->actionHandle(Fix::class);
    }

    /**
     * @return array
     */
    public function fixed(): array
    {
        return $this->actionHandle(Fixed::class, $this->validate()->fixed());
    }

    /**
     * @return array
     */
    public function notTranslated(): array
    {
        return $this->actionHandle(NotTranslated::class);
    }

    /**
     * @return array
     */
    public function only(): array
    {
        return $this->actionHandle(Only::class, $this->validate()->only());
    }

    /**
     * @return string
     */
    public function plainExport(): string
    {
        return $this->actionHandle(PlainExport::class, $this->validate()->plainExport());
    }

    /**
     * @return void
     */
    public function plainImport(): void
    {
        $this->actionHandle(PlainImport::class, $this->validate()->plainImport());
    }

    /**
     * @return void
     */
    public function translate(): void
    {
        $this->actionHandle(Translate::class, $this->validate()->translate());
    }

    /**
     * @return void
     */
    public function unused(): void
    {
        $this->actionHandle(Unused::class);
    }
}

```

`app/Domains/CoreTranslation/Action/Clean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\CoreTranslation\Service\Clean as ActionService;

class Clean extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        ActionService::new()->write();
    }
}

```

`app/Domains/CoreTranslation/Action/Fill.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\CoreTranslation\Service\Fill as ActionService;

class Fill extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        ActionService::new()->write();
    }
}

```

`app/Domains/CoreTranslation/Action/Fix.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\CoreTranslation\Service\Fix as ActionService;

class Fix extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        ActionService::new()->write();
    }
}

```

`app/Domains/CoreTranslation/Action/Fixed.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\CoreTranslation\Service\Fixed as ActionService;

class Fixed extends ActionAbstract
{
    /**
     * @return array
     */
    public function handle(): array
    {
        return ActionService::new($this->data['paths-exclude'])->scan();
    }
}

```

`app/Domains/CoreTranslation/Action/NotTranslated.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\CoreTranslation\Service\NotTranslated as ActionService;

class NotTranslated extends ActionAbstract
{
    /**
     * @return array
     */
    public function handle(): array
    {
        return ActionService::new()->scan();
    }
}

```

`app/Domains/CoreTranslation/Action/Only.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\CoreTranslation\Service\Only as ActionService;

class Only extends ActionAbstract
{
    /**
     * @return array
     */
    public function handle(): array
    {
        return ActionService::new($this->data['lang'])->scan();
    }
}

```

`app/Domains/CoreTranslation/Action/PlainExport.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\CoreTranslation\Service\PlainExport as ActionService;

class PlainExport extends ActionAbstract
{
    /**
     * @return string
     */
    public function handle(): string
    {
        return ActionService::new($this->data['lang'])->generate();
    }
}

```

`app/Domains/CoreTranslation/Action/PlainImport.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\CoreTranslation\Service\PlainImport as ActionService;

class PlainImport extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        ActionService::new($this->data['lang'], $this->data['file'])->write();
    }
}

```

`app/Domains/CoreTranslation/Action/Translate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\CoreTranslation\Service\Translate as ActionService;

class Translate extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        ActionService::new($this->data['from'], $this->data['to'])->write();
    }
}

```

`app/Domains/CoreTranslation/Action/Unused.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Action;

use App\Domains\CoreTranslation\Service\Unused as ActionService;

class Unused extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        ActionService::new()->write();
    }
}

```

`app/Domains/CoreTranslation/Command/Clean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Command;

class Clean extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:translation:clean';

    /**
     * @var string
     */
    protected $description = 'Clean non existing translations';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->action()->clean();

        $this->info('[END]');
    }
}

```

`app/Domains/CoreTranslation/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Command;

use App\Domains\Core\Command\CommandAbstract as CommandAbstractCore;

abstract class CommandAbstract extends CommandAbstractCore
{
}

```

`app/Domains/CoreTranslation/Command/Fill.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Command;

class Fill extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:translation:fill';

    /**
     * @var string
     */
    protected $description = 'Fill PHP files with translation codes';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->action()->fill();

        $this->info('[END]');
    }
}

```

`app/Domains/CoreTranslation/Command/Fix.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Command;

class Fix extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:translation:fix';

    /**
     * @var string
     */
    protected $description = 'Fix PHP files with string translated same as code';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->action()->fix();

        $this->info('[END]');
    }
}

```

`app/Domains/CoreTranslation/Command/Fixed.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Command;

class Fixed extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:translation:fixed {--paths-exclude=*}';

    /**
     * @var string
     */
    protected $description = 'Search fixed texts on app and views';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->requestWithOptions();

        $this->info($this->action()->fixed());

        $this->info('[END]');
    }
}

```

`app/Domains/CoreTranslation/Command/NotTranslated.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Command;

class NotTranslated extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:translation:not-translated';

    /**
     * @var string
     */
    protected $description = 'Search empty translations on app and views';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->info($this->action()->notTranslated());

        $this->info('[END]');
    }
}

```

`app/Domains/CoreTranslation/Command/Only.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Command;

class Only extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:translation:only {--lang=}';

    /**
     * @var string
     */
    protected $description = 'Search translations only in one language';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->checkOptions(['lang']);
        $this->requestWithOptions();

        $this->info($this->action()->only());

        $this->info('[END]');
    }
}

```

`app/Domains/CoreTranslation/Command/PlainExport.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Command;

class PlainExport extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:translation:plain:export {--lang=}';

    /**
     * @var string
     */
    protected $description = 'Export translation file as JSON by {--lang=}';

    /**
     * @return void
     */
    public function handle()
    {
        $this->info('[START]');

        $this->checkOptions(['lang']);
        $this->requestWithOptions();

        $this->info($this->action()->plainExport());

        $this->info('[END]');
    }
}

```

`app/Domains/CoreTranslation/Command/PlainImport.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Command;

class PlainImport extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:translation:plain:import {--lang=} {--file=}';

    /**
     * @var string
     */
    protected $description = 'Import JSON translation {--file=} by {--lang=}';

    /**
     * @return void
     */
    public function handle()
    {
        $this->info('[START]');

        $this->checkOptions(['lang', 'file']);
        $this->requestWithOptions();

        $this->info($this->action()->plainImport());

        $this->info('[END]');
    }
}

```

`app/Domains/CoreTranslation/Command/Translate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Command;

class Translate extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:translation:translate {--from=} {--to=*}';

    /**
     * @var string
     */
    protected $description = 'Translate to languages using online translator';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->checkOptions(['from', 'to']);
        $this->requestWithOptions();

        $this->action()->translate();

        $this->info('[END]');
    }
}

```

`app/Domains/CoreTranslation/Command/Unused.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Command;

class Unused extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'core:translation:unused';

    /**
     * @var string
     */
    protected $description = 'Delete unused translation files';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->action()->unused();

        $this->info('[END]');
    }
}

```

`app/Domains/CoreTranslation/Service/Clean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Service;

use Exception;

class Clean extends ServiceAbstract
{
    /**
     * @var array
     */
    protected array $list = [];

    /**
     * @return self
     */
    public function write(): self
    {
        $this->scan();

        return $this->fill(array_map('array_unique', $this->list));
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function file(string $file): void
    {
        preg_match_all('/(__|trans_choice)\([\'"]([^\'"]+)/', file_get_contents($file), $matches);

        foreach ($matches[2] as $string) {
            if (str_contains($string, '.') === false) {
                throw new Exception(sprintf('Invalid string %s on file %s', $string, $this->fileRelative($file)));
            }

            [$file, $code] = explode('.', $string, 2);

            $this->list[$file][] = $code;
        }
    }

    /**
     * @param array $default
     *
     * @return self
     */
    protected function fill(array $default): self
    {
        foreach (config('app.locales') as $lang) {
            $this->fillLanguage($lang, $default);
        }

        return $this;
    }

    /**
     * @param string $lang
     * @param array $default
     *
     * @return void
     */
    protected function fillLanguage(string $lang, array $default): void
    {
        foreach ($default as $file => $keys) {
            $this->fillLanguageFile($lang, $file, $keys);
        }
    }

    /**
     * @param string $lang
     * @param string $file
     * @param array $keys
     *
     * @return void
     */
    protected function fillLanguageFile(string $lang, string $file, array $keys): void
    {
        $file = base_path('resources/lang/'.$lang.'/'.$file.'.php');

        if (!is_file($file)) {
            return;
        }

        $current = array_dot(require $file);
        $remove = array_diff(array_keys($current), $keys);

        $this->writeFile($file, $this->undot(array_diff_key($current, array_flip($remove))));
    }
}

```

`app/Domains/CoreTranslation/Service/Fill.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Service;

use Exception;

class Fill extends ServiceAbstract
{
    /**
     * @var array
     */
    protected array $list = [];

    /**
     * @return self
     */
    public function write(): self
    {
        $this->scan();

        return $this->fill(array_map('array_unique', $this->list));
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function file(string $file): void
    {
        if (str_contains($file, '/node_modules/')) {
            return;
        }

        preg_match_all('/(__|trans_choice)\([\'"]([^\'"]+)/', file_get_contents($file), $matches);

        foreach ($matches[2] as $string) {
            if (str_contains($string, '.') === false) {
                throw new Exception(sprintf('Invalid string %s on file %s', $string, $this->fileRelative($file)));
            }

            [$file, $code] = explode('.', $string, 2);

            if ($file && $code) {
                $this->list[$file][] = $code;
            }
        }
    }

    /**
     * @param array $default
     *
     * @return self
     */
    protected function fill(array $default): self
    {
        foreach (config('app.locales') as $lang) {
            $this->fillLanguage($lang, $default);
        }

        return $this;
    }

    /**
     * @param string $lang
     * @param array $default
     *
     * @return void
     */
    protected function fillLanguage(string $lang, array $default): void
    {
        foreach ($default as $file => $keys) {
            $this->fillLanguageFile($lang, $file, $keys);
        }
    }

    /**
     * @param string $lang
     * @param string $file
     * @param array $keys
     *
     * @return void
     */
    protected function fillLanguageFile(string $lang, string $file, array $keys): void
    {
        $file = base_path('resources/lang/'.$lang.'/'.$file.'.php');
        $values = $this->undot(array_fill_keys($keys, ''));

        if (is_file($file)) {
            $values = array_replace_recursive($values, require $file);
        }

        $this->writeFile($file, $values);
    }
}

```

`app/Domains/CoreTranslation/Service/Fix.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Service;

class Fix extends ServiceAbstract
{
    /**
     * @var string
     */
    protected string $base = 'resources/lang';

    /**
     * @return self
     */
    public function __construct()
    {
        $this->base = base_path($this->base);
    }

    /**
     * @return void
     */
    public function write(): void
    {
        foreach ($this->langs() as $lang) {
            foreach ($this->files($lang) as $file) {
                $this->check($file);
            }
        }
    }

    /**
     * @return array
     */
    protected function langs(): array
    {
        return array_map('basename', glob($this->base.'/*', GLOB_ONLYDIR));
    }

    /**
     * @param string $lang
     *
     * @return array
     */
    protected function files(string $lang): array
    {
        return glob($this->base.'/'.$lang.'/*.php');
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function check(string $file): void
    {
        $this->writeFile($file, $this->filter(require $file));
    }

    /**
     * @param array $values
     *
     * @return array
     */
    protected function filter(array $values): array
    {
        foreach ($values as $key => $value) {
            if (is_array($value)) {
                $values[$key] = $this->filter($value);
            } elseif ($key === $value) {
                $values[$key] = '';
            }
        }

        return $values;
    }
}

```

`app/Domains/CoreTranslation/Service/Fixed.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Service;

class Fixed extends ServiceAbstract
{
    /**
     * @var array
     */
    protected array $pathsExclude;

    /**
     * @param array $paths_exclude = []
     *
     * @return self
     */
    public function __construct(array $paths_exclude = [])
    {
        $this->pathsExclude = array_map(static fn ($value) => realpath(base_path(trim($value, '/'))), $paths_exclude);
    }

    /**
     * @param string $file
     *
     * @return ?array
     */
    protected function file(string $file): ?array
    {
        $file = realpath($file);

        if ($this->fileExcluded($file)) {
            return null;
        }

        $contents = file($file);
        $matches = preg_grep('/[^-]>\w[\w\s]+</', $contents) + preg_grep('/(title|placeholder)="[\w\s]+"/', $contents);

        return $matches ? [$this->fileRelative($file) => $matches] : null;
    }

    /**
     * @param string $file
     *
     * @return bool
     */
    protected function fileExcluded(string $file): bool
    {
        foreach ($this->pathsExclude as $path) {
            if (str_starts_with($file, $path)) {
                return true;
            }
        }

        return false;
    }
}

```

`app/Domains/CoreTranslation/Service/NotTranslated.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Service;

class NotTranslated extends ServiceAbstract
{
    /**
     * @param string $file
     *
     * @return array
     */
    protected function file(string $file): array
    {
        preg_match_all('/(__|trans_choice)\([\'"]([^\'"]+)/', file_get_contents($file), $matches);

        $file = $this->fileRelative($file);
        $empty = [];

        foreach ($matches[2] as $string) {
            if ($string === __($string)) {
                $empty[$file][] = $string;
            }
        }

        return $empty;
    }
}

```

`app/Domains/CoreTranslation/Service/Only.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Service;

class Only extends ServiceAbstract
{
    /**
     * @var string
     */
    protected string $lang = '';

    /**
     * @var string
     */
    protected string $base = 'resources/lang';

    /**
     * @param string $lang
     *
     * @return self
     */
    public function __construct(string $lang)
    {
        $this->lang = $lang;
        $this->base = base_path($this->base);
    }

    /**
     * @return array
     */
    public function scan(): array
    {
        $status = [];
        $langs = $this->langs();

        foreach ($this->files() as $file) {
            if ($matches = $this->check($file, $langs)) {
                array_push($status, ...$matches);
            }
        }

        return $status;
    }

    /**
     * @return array
     */
    protected function langs(): array
    {
        return array_diff(array_map('basename', glob($this->base.'/*', GLOB_ONLYDIR)), [$this->lang]);
    }

    /**
     * @return array
     */
    protected function files(): array
    {
        return glob($this->base.'/'.$this->lang.'/*.php');
    }

    /**
     * @param string $lang
     * @param string $name
     *
     * @return ?array
     */
    protected function file(string $lang, string $name): ?array
    {
        $file = $this->base.'/'.$lang.'/'.$name;

        return is_file($file) ? (require $file) : null;
    }

    /**
     * @param string $file
     * @param array $langs
     *
     * @return array
     */
    protected function check(string $file, array $langs): array
    {
        $status = [];
        $keys = array_dot(array_keys(require $file));
        $name = basename($file);

        foreach ($langs as $lang) {
            $status[] = $this->checkLang($lang, $name, $keys);
        }

        return $status;
    }

    /**
     * @param string $lang
     * @param string $name
     * @param array $keys
     *
     * @return ?string
     */
    protected function checkLang(string $lang, string $name, array $keys): ?string
    {
        if (empty($current = $this->file($lang, $name))) {
            return sprintf('File %s not exists for language "%s"', $name, $lang);
        }

        if ($diff = array_diff($keys, array_dot(array_keys($current)))) {
            return sprintf('This keys do not exists on "%s" (%s): %s', $lang, $name, implode(', ', $diff));
        }

        $current = array_dot(array_keys(array_filter($current)));

        if ($current) {
            return sprintf('This keys are empty on "%s" (%s): %s', $lang, $name, implode(', ', $current));
        }

        return null;
    }
}

```

`app/Domains/CoreTranslation/Service/PlainExport.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Service;

class PlainExport extends ServiceAbstract
{
    /**
     * @var string
     */
    protected string $base = 'resources/lang';

    /**
     * @param string $lang
     *
     * @return self
     */
    public function __construct(protected string $lang)
    {
        $this->base = base_path($this->base);
    }

    /**
     * @return string
     */
    public function generate(): string
    {
        $list = [];

        foreach ($this->files() as $file) {
            $list += $this->contents($file);
        }

        return $this->toString($list);
    }

    /**
     * @return array
     */
    protected function files(): array
    {
        return glob($this->base.'/'.$this->lang.'/*.php');
    }

    /**
     * @param string $file
     *
     * @return array
     */
    protected function contents(string $file): array
    {
        $name = str_replace('.php', '', basename($file));
        $values = [];

        foreach (array_dot(require $file) as $key => $value) {
            $values[$name.'.'.$key] = $value;
        }

        return $values;
    }

    /**
     * @param array $lines
     *
     * @return string
     */
    protected function toString(array $lines): string
    {
        return helper()->jsonEncode($lines);
    }
}

```

`app/Domains/CoreTranslation/Service/PlainImport.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Service;

use Exception;

class PlainImport extends ServiceAbstract
{
    /**
     * @var string
     */
    protected string $base = 'resources/lang';

    /**
     * @var string
     */
    protected string $file;

    /**
     * @var array
     */
    protected array $contents;

    /**
     * @param string $lang
     * @param string $file
     *
     * @return self
     */
    public function __construct(protected string $lang, string $file)
    {
        $this->base();
        $this->file($file);
        $this->contents();
    }

    /**
     * @return void
     */
    protected function base(): void
    {
        $this->base = base_path($this->base);
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function file(string $file): void
    {
        $this->file = base_path($file);

        if (!is_file($this->file)) {
            throw new Exception(sprintf('File %s not found', $file));
        }
    }

    /**
     * @return void
     */
    protected function contents(): void
    {
        $this->contents = $this->undot(json_decode(file_get_contents($this->file), true));
    }

    /**
     * @return void
     */
    public function write(): void
    {
        foreach ($this->contents as $file => $contents) {
            $this->writeFileTarget($file, $contents);
        }
    }

    /**
     * @param string $file
     * @param array $contents
     *
     * @return void
     */
    protected function writeFileTarget(string $file, array $contents): void
    {
        $contents = helper()->arrayFilterRecursive($contents);
        $target = $this->base.'/'.$this->lang.'/'.$file.'.php';

        $contents = array_replace_recursive($this->writeFileTargetContents($target), $contents);

        $this->writeFile($target, $contents);
    }

    /**
     * @param string $file
     *
     * @return array
     */
    protected function writeFileTargetContents(string $file): array
    {
        $target = $this->base.'/'.$this->lang.'/'.$file.'.php';

        if (is_file($target) === false) {
            return [];
        }

        return helper()->arrayFilterRecursive(require $target);
    }
}

```

`app/Domains/CoreTranslation/Service/ServiceAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Service;

use Generator;
use Illuminate\Support\Arr;
use App\Services\Filesystem\Directory as DirectoryService;
use App\Services\Filesystem\File as FileService;

abstract class ServiceAbstract
{
    /**
     * @var array
     */
    protected array $folders = ['app', 'resources/views'];

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param array $folders = []
     *
     * @return self
     */
    public function __construct(array $folders = [])
    {
        if ($folders) {
            $this->folders = $folders;
        }
    }

    /**
     * @return array
     */
    public function scan(): array
    {
        $found = [];

        foreach ($this->folders as $folder) {
            foreach ($this->read(base_path($folder)) as $file) {
                if ($matches = $this->file($file)) {
                    $found[$this->fileRelative($file)] = $matches;
                }
            }
        }

        return $found;
    }

    /**
     * @param string $dir
     *
     * @return \Generator
     */
    protected function read(string $dir): Generator
    {
        return DirectoryService::files($dir, $this->readInclude(), $this->readExclude());
    }

    /**
     * @return string
     */
    protected function readInclude(): string
    {
        return '/\.php$/';
    }

    /**
     * @return string
     */
    protected function readExclude(): string
    {
        return '/\/node_modules\//';
    }

    /**
     * @param array $array
     *
     * @return array
     */
    protected function undot(array $array): array
    {
        ksort($array);

        $values = [];

        foreach ($array as $key => $value) {
            Arr::set($values, $key, $value);
        }

        return $values;
    }

    /**
     * @param string $file
     * @param array $values
     *
     * @return void
     */
    protected function writeFile(string $file, array $values): void
    {
        FileService::write($file, $values, true);
    }

    /**
     * @param string $file
     *
     * @return string
     */
    protected function fileRelative(string $file): string
    {
        return str_replace(base_path(), '', $file);
    }
}

```

`app/Domains/CoreTranslation/Service/Translate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Service;

use App\Services\Translator\TranslatorFactory;

class Translate extends ServiceAbstract
{
    /**
     * @var string
     */
    protected string $base = 'resources/lang';

    /**
     * @param string $from
     * @param array $to
     *
     * @return self
     */
    public function __construct(protected string $from, protected array $to)
    {
        $this->base();
        $this->to();
    }

    /**
     * @return void
     */
    protected function base(): void
    {
        $this->base = base_path($this->base);
    }

    /**
     * @return void
     */
    protected function to(): void
    {
        $locales = config('app.locales');

        if ($this->to[0] === 'all') {
            $to = $locales;
        } else {
            $to = helper()->arrayValuesWhitelist($this->to, $locales);
        }

        $this->to = helper()->arrayValuesBlacklist($to, [$this->from]);
    }

    /**
     * @return void
     */
    public function write(): void
    {
        foreach ($this->files() as $file) {
            foreach ($this->to as $to) {
                $this->translate($to, $file);
            }
        }
    }

    /**
     * @return array
     */
    protected function files(): array
    {
        return glob($this->base.'/'.$this->from.'/*.php');
    }

    /**
     * @param string $to
     * @param string $name
     *
     * @return string
     */
    protected function file(string $to, string $name): string
    {
        return $this->base.'/'.$to.'/'.$name;
    }

    /**
     * @param string $to
     * @param string $from
     *
     * @return void
     */
    protected function translate(string $to, string $from): void
    {
        $file = $this->file($to, basename($from));
        $current = array_dot(is_file($file) ? (require $file) : []);
        $empty = helper()->arrayFilterRecursive($current, static fn ($value) => is_string($value) && empty($value));
        $strings = array_filter(array_intersect_key(array_dot(require $from), $empty));

        if (empty($strings)) {
            return;
        }

        $translated = $this->request($to, $strings);

        if (empty($translated)) {
            return;
        }

        $this->writeFile($file, $this->translateUndot($current, $strings, $translated));
    }

    /**
     * @param array $current
     * @param array $strings
     * @param array $translated
     *
     * @return array
     */
    protected function translateUndot(array $current, array $strings, array $translated): array
    {
        return $this->undot(array_merge($current, array_combine(array_keys($strings), $translated)));
    }

    /**
     * @param string $to
     * @param array $strings
     *
     * @return ?array
     */
    protected function request(string $to, array $strings): ?array
    {
        return TranslatorFactory::get()->array($this->from, $to, $strings);
    }
}

```

`app/Domains/CoreTranslation/Service/Unused.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Service;

use Exception;

class Unused extends ServiceAbstract
{
    /**
     * @var array
     */
    protected array $list = [];

    /**
     * @return self
     */
    public function write(): self
    {
        $this->scan();

        return $this->clean();
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function file(string $file): void
    {
        preg_match_all('/(__|trans_choice)\([\'"]([^\'"]+)/', file_get_contents($file), $matches);

        foreach ($matches[2] as $string) {
            if (str_contains($string, '.') === false) {
                throw new Exception(sprintf('Invalid string %s on file %s', $string, $this->fileRelative($file)));
            }

            [$file, $code] = explode('.', $string, 2);

            $this->list[$file][] = $code;
        }
    }

    /**
     * @return self
     */
    protected function clean(): self
    {
        foreach (config('app.locales') as $lang) {
            $this->cleanLanguage($lang);
        }

        return $this;
    }

    /**
     * @param string $lang
     *
     * @return void
     */
    protected function cleanLanguage(string $lang): void
    {
        foreach (glob(base_path('resources/lang/'.$lang.'/*.php')) as $file) {
            $this->cleanLanguageFile($file);
        }
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function cleanLanguageFile(string $file): void
    {
        $code = str_replace('.php', '', basename($file));

        if (empty($this->list[$code])) {
            unlink($file);
        }
    }
}

```

`app/Domains/CoreTranslation/Validate/Fixed.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Fixed extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'paths-exclude' => ['bail', 'array'],
        ];
    }
}

```

`app/Domains/CoreTranslation/Validate/Only.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Only extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'lang' => ['bail', 'required'],
        ];
    }
}

```

`app/Domains/CoreTranslation/Validate/PlainExport.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class PlainExport extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'lang' => ['bail', 'required'],
        ];
    }
}

```

`app/Domains/CoreTranslation/Validate/PlainImport.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class PlainImport extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'lang' => ['bail', 'required'],
            'file' => ['bail', 'required'],
        ];
    }
}

```

`app/Domains/CoreTranslation/Validate/Translate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Translate extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'from' => ['bail', 'required'],
            'to' => ['bail', 'array', 'required'],
        ];
    }
}

```

`app/Domains/CoreTranslation/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\CoreTranslation\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Country/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\Country\Model\Country as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Country\Model\Country
     */
    protected ?Model $row;
}

```

`app/Domains/Country/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Country\Model\Country as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Country\Model\Country
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\Country\Model\Country
     */
    public function getOrNew(): Model
    {
        return $this->actionHandle(GetOrNew::class, $this->validate()->getOrNew());
    }

    /**
     * @return \App\Domains\Country\Model\Country
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\Country\Model\Country
     */
    public function updateMerge(): Model
    {
        return $this->actionHandle(UpdateMerge::class, $this->validate()->updateMerge());
    }
}

```

`app/Domains/Country/Action/GetOrNew.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Action;

use App\Domains\Country\Model\Country as Model;

class GetOrNew extends ActionAbstract
{
    /**
     * @return \App\Domains\Country\Model\Country
     */
    public function handle(): Model
    {
        $this->row();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = $this->rowByName()
            ?: $this->rowByAlias()
            ?: $this->rowByCreate();
    }

    /**
     * @return ?\App\Domains\Country\Model\Country
     */
    protected function rowByName(): ?Model
    {
        return Model::query()
            ->byCode($this->data['code'])
            ->first();
    }

    /**
     * @return ?\App\Domains\Country\Model\Country
     */
    protected function rowByAlias(): ?Model
    {
        return Model::query()
            ->byAlias($this->data['name'])
            ->first();
    }

    /**
     * @return \App\Domains\Country\Model\Country
     */
    protected function rowByCreate(): Model
    {
        return Model::query()->create([
            'code' => $this->data['code'],
            'name' => $this->data['name'],
        ]);
    }
}

```

`app/Domains/Country/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Action;

use App\Domains\Country\Model\Country as Model;

class Update extends ActionAbstract
{
    /**
     * @return \App\Domains\Country\Model\Country
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataAlias();
    }

    /**
     * @return void
     */
    protected function dataAlias(): void
    {
        $this->data['alias'] = array_filter(array_map('trim', explode(',', $this->data['alias'])));
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkCode();
    }

    /**
     * @return void
     */
    protected function checkCode(): void
    {
        if ($this->checkCodeExists()) {
            $this->exceptionValidator(__('country-update.error.code-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkCodeExists(): bool
    {
        return Model::query()
            ->byIdNot($this->row->id)
            ->byCode($this->data['code'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->code = $this->data['code'];
        $this->row->name = $this->data['name'];
        $this->row->alias = $this->data['alias'];
        $this->row->save();
    }
}

```

`app/Domains/Country/Action/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Action;

use App\Domains\City\Model\City as CityModel;
use App\Domains\Country\Model\Collection\Country as Collection;
use App\Domains\Country\Model\Country as Model;
use App\Domains\State\Model\State as StateModel;

class UpdateMerge extends ActionAbstract
{
    /**
     * @var \App\Domains\Country\Model\Collection\Country
     */
    protected Collection $list;

    /**
     * @return \App\Domains\Country\Model\Country
     */
    public function handle(): Model
    {
        $this->list();
        $this->data();
        $this->check();
        $this->save();
        $this->delete();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function list(): void
    {
        $this->list = Model::query()
            ->byIdNot($this->row->id)
            ->byIds($this->data['ids'])
            ->get();
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataIds();
        $this->dataAlias();
    }

    /**
     * @return void
     */
    protected function dataIds(): void
    {
        $this->data['ids'] = $this->list->pluck('id')->all();
    }

    /**
     * @return void
     */
    protected function dataAlias(): void
    {
        $this->data['alias'] = array_unique(array_filter(array_merge(
            (array)$this->row->alias,
            $this->list->pluck('name')->all(),
            ...array_filter($this->list->pluck('alias')->all())
        )));
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        if ($this->list->isEmpty()) {
            $this->exceptionValidator(__('country-update-merge.error.ids-empty'));
        }
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveState();
        $this->saveCity();
        $this->saveRow();
    }

    /**
     * @return void
     */
    protected function saveState(): void
    {
        StateModel::query()
            ->byCountryIds($this->data['ids'])
            ->update(['country_id' => $this->row->id]);
    }

    /**
     * @return void
     */
    protected function saveCity(): void
    {
        CityModel::query()
            ->byCountryIds($this->data['ids'])
            ->update(['country_id' => $this->row->id]);
    }

    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->row->alias = $this->data['alias'];
        $this->row->save();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        Model::query()
            ->byIds($this->data['ids'])
            ->delete();
    }
}

```

`app/Domains/Country/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\Country\Model\Country as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\Country\Model\Country
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Country\Model\Country
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->firstOr(fn () => $this->exceptionNotFound(__('country.error.not-found')));
    }
}

```

`app/Domains/Country/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Controller;

use Illuminate\Http\Response;
use App\Domains\Country\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('country-index.meta-title'));

        return $this->page('country.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Country/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/Country/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Country\Model\Collection\Country as Collection;
use App\Domains\Country\Model\Country as Model;

class Index extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\Country\Model\Collection\Country
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Country/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Country\Model\Country as Model;

class Update extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Country\Model\Country $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
    }

    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow(data: ['alias' => $this->requestAlias()]);
    }

    /**
     * @return string
     */
    protected function requestAlias(): string
    {
        return $this->request->input('alias')
            ?: implode(',', $this->row->alias ?? []);
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
        ];
    }
}

```

`app/Domains/Country/Controller/Service/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Country\Model\Collection\Country as Collection;
use App\Domains\Country\Model\Country as Model;

class UpdateMerge extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Country\Model\Country $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\Country\Model\Collection\Country
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->byIdNot($this->row->id)
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Country/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Country\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('update')) {
            return $response;
        }

        $this->meta('title', __('country-update.meta-title', ['title' => $this->row->name]));

        return $this->page('country.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('country-update.success'));

        return redirect()->route('country.update', $this->row->id);
    }
}

```

`app/Domains/Country/Controller/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Country\Controller\Service\UpdateMerge as ControllerService;

class UpdateMerge extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('updateMerge')) {
            return $response;
        }

        $this->meta('title', __('country-update-merge.meta-title', ['title' => $this->row->name]));

        return $this->page('country.update-merge', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateMerge(): RedirectResponse
    {
        $this->action()->updateMerge();

        $this->sessionMessage('success', __('country-update-merge.success'));

        return redirect()->route('country.update.merge', $this->row->id);
    }
}

```

`app/Domains/Country/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth-admin-mode']], static function () {
    Route::get('/country', Index::class)->name('country.index');
    Route::any('/country/{id}', Update::class)->name('country.update');
    Route::any('/country/{id}/merge', UpdateMerge::class)->name('country.update.merge');
});

```

`app/Domains/Country/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\Country\Model\Country as Model;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\Country\Model\Country $row
     *
     * @return array
     */
    protected function related(Model $row): array
    {
        return [
            'id' => $row->id,
            'code' => $row->code,
            'name' => $row->name,
        ];
    }
}

```

`app/Domains/Country/Model/Builder/Country.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Model\Builder;

use App\Domains\City\Model\City as CityModel;
use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class Country extends BuilderAbstract
{
    /**
     * @param string $alias
     *
     * @return self
     */
    public function byAlias(string $alias): self
    {
        return $this->whereJsonContains('alias', $alias);
    }

    /**
     * @param string $code
     *
     * @return self
     */
    public function byCode(string $code): self
    {
        return $this->where('code', $code);
    }

    /**
     * @param int $device_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     * @param ?string $start_end
     *
     * @return self
     */
    public function byDeviceIdWhenTripStartUtcAtDateBetween(int $device_id, ?string $before_start_utc_at, ?string $after_start_utc_at, ?string $start_end): self
    {
        return $this->whereIn('id', CityModel::query()->select('country_id')->byDeviceIdWhenTripStartUtcAtDateBetween($device_id, $before_start_utc_at, $after_start_utc_at, $start_end));
    }

    /**
     * @param string $name
     *
     * @return self
     */
    public function byName(string $name): self
    {
        return $this->where('name', $name);
    }

    /**
     * @param int $vehicle_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     * @param ?string $start_end
     *
     * @return self
     */
    public function byVehicleIdWhenTripStartUtcAtDateBetween(int $vehicle_id, ?string $before_start_utc_at, ?string $after_start_utc_at, ?string $start_end): self
    {
        return $this->whereIn('id', CityModel::query()->select('country_id')->byVehicleIdWhenTripStartUtcAtDateBetween($vehicle_id, $before_start_utc_at, $after_start_utc_at, $start_end));
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderBy('name', 'ASC');
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_date_at
     * @param ?string $after_date_at
     *
     * @return self
     */
    public function whenRefuelUserIdVehicleIdDateAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_date_at, ?string $after_date_at): self
    {
        return $this->whereIn('id', CityModel::query()->select('country_id')->whenRefuelUserIdVehicleIdDateAtBetween($user_id, $vehicle_id, $before_date_at, $after_date_at));
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_start_at
     * @param ?string $after_start_at
     *
     * @return self
     */
    public function whenTripUserIdVehicleIdStartAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_start_at, ?string $after_start_at): self
    {
        return $this->whereIn('id', CityModel::query()->select('country_id')->whenTripUserIdVehicleIdStartAtBetween($user_id, $vehicle_id, $before_start_at, $after_start_at));
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     *
     * @return self
     */
    public function whenTripUserIdVehicleIdStartUtcAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_start_utc_at, ?string $after_start_utc_at): self
    {
        return $this->whereIn('id', CityModel::query()->select('country_id')->whenTripUserIdVehicleIdStartUtcAtBetween($user_id, $vehicle_id, $before_start_utc_at, $after_start_utc_at));
    }
}

```

`app/Domains/Country/Model/Collection/Country.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Country extends CollectionAbstract
{
}

```

`app/Domains/Country/Model/Country.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\Country\Model\Builder\Country as Builder;
use App\Domains\Country\Model\Collection\Country as Collection;
use App\Domains\Country\Test\Factory\Country as TestFactory;

class Country extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'country';

    /**
     * @const string
     */
    public const TABLE = 'country';

    /**
     * @const string
     */
    public const FOREIGN = 'country_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'alias' => 'array',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\Country\Model\Collection\Country
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Country\Model\Builder\Country
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Country\Test\Factory\Country
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }
}

```

`app/Domains/Country/Validate/GetOrNew.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class GetOrNew extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'code' => ['bail', 'required'],
        ];
    }
}

```

`app/Domains/Country/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Update extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'code' => ['bail', 'required'],
            'name' => ['bail', 'required'],
            'alias' => ['bail'],
        ];
    }
}

```

`app/Domains/Country/Validate/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdateMerge extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'ids' => ['bail', 'required', 'array'],
        ];
    }
}

```

`app/Domains/Country/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Country\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Dashboard/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Dashboard\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;

abstract class ControllerAbstract extends ControllerWebAbstract
{
}

```

`app/Domains/Dashboard/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Dashboard\Controller;

use Illuminate\Http\Response;
use App\Domains\Dashboard\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('dashboard-index.meta-title'));

        return $this->page('dashboard.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Dashboard/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Dashboard\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/Dashboard/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Dashboard\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Alarm\Model\Alarm as AlarmModel;
use App\Domains\Alarm\Model\Collection\Alarm as AlarmCollection;
use App\Domains\AlarmNotification\Model\AlarmNotification as AlarmNotificationModel;
use App\Domains\AlarmNotification\Model\Collection\AlarmNotification as AlarmNotificationCollection;
use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Server\Model\Server as ServerModel;
use App\Domains\Trip\Model\Collection\Trip as TripCollection;
use App\Domains\Trip\Model\Trip as TripModel;

class Index extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->filters();
    }

    /**
     * @return void
     */
    protected function filters(): void
    {
        $this->filtersUserId();
        $this->filtersVehicleId();
        $this->filtersDeviceId();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'user' => $this->user(),
            'vehicle' => $this->vehicle(),
            'device' => $this->device(),

            'onboarding' => $this->onboarding(),
            'server' => $this->server(),

            'users' => $this->users(),
            'users_multiple' => $this->usersMultiple(),
            'user_empty' => $this->userEmpty(),
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle_empty' => $this->vehicleEmpty(),
            'devices' => $this->devices(),
            'devices_multiple' => $this->devicesMultiple(),
            'device_empty' => $this->deviceEmpty(),
            'trips' => $this->trips(),
            'trip' => $this->trip(),
            'trip_next_id' => $this->tripNextId(),
            'trip_previous_id' => $this->tripPreviousId(),
            'trip_alarm_notifications' => $this->tripAlarmNotifications(),
            'positions' => $this->positions(),
            'alarms' => $this->alarms(),
            'alarm_notifications' => $this->alarmNotifications(),
        ];
    }

    /**
     * @return bool
     */
    protected function onboarding(): bool
    {
        return ($this->vehicles()->count() === 0)
            || ($this->devices()->count() === 0)
            || ($this->trips()->count() === 0);
    }

    /**
     * @return ?\App\Domains\Server\Model\Server
     */
    protected function server(): ?ServerModel
    {
        if ($this->auth->adminMode() === false) {
            return null;
        }

        if ($this->onboarding() === false) {
            return null;
        }

        return $this->cache(
            fn () => ServerModel::query()
                ->enabled()
                ->first()
        );
    }

    /**
     * @return \App\Domains\Trip\Model\Collection\Trip
     */
    protected function trips(): TripCollection
    {
        if ($this->vehicle() === null) {
            return new TripCollection();
        }

        return $this->cache(
            fn () => TripModel::query()
                ->byVehicleId($this->vehicle()->id)
                ->whenDeviceId($this->device()?->id)
                ->listSimple()
                ->limit(50)
                ->get()
        );
    }

    /**
     * @return ?\App\Domains\Trip\Model\Trip
     */
    protected function trip(): ?TripModel
    {
        return $this->cache(
            fn () => $this->trips()->firstWhere('id', $this->request->input('trip_id'))
                ?: $this->trips()->first()
        );
    }

    /**
     * @return ?int
     */
    protected function tripNextId(): ?int
    {
        if ($this->trip() === null) {
            return null;
        }

        return $this->cache(
            fn () => $this->trips()
                ->reverse()
                ->firstWhere('start_utc_at', '>', $this->trip()->start_utc_at)
                ?->id
        );
    }

    /**
     * @return ?int
     */
    protected function tripPreviousId(): ?int
    {
        if ($this->trip() === null) {
            return null;
        }

        return $this->cache(
            fn () => $this->trips()
                ->firstWhere('start_utc_at', '<', $this->trip()->start_utc_at)
                ?->id
        );
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\Collection\AlarmNotification
     */
    protected function tripAlarmNotifications(): AlarmNotificationCollection
    {
        if ($this->trip() === null) {
            return new AlarmNotificationCollection();
        }

        return $this->cache(
            fn () => AlarmNotificationModel::query()
                ->byTripId($this->trip()->id)
                ->withAlarm()
                ->list()
                ->get()
        );
    }

    /**
     * @return \App\Domains\Position\Model\Collection\Position
     */
    protected function positions(): PositionCollection
    {
        if ($this->trip() === null) {
            return new PositionCollection();
        }

        return $this->cache(
            fn () => $this->trip()
                ->positions()
                ->withCityState()
                ->list()
                ->get()
        );
    }

    /**
     * @return \App\Domains\Alarm\Model\Collection\Alarm
     */
    protected function alarms(): AlarmCollection
    {
        if ($this->vehicle() === null) {
            return new AlarmCollection();
        }

        return $this->cache(
            fn () => AlarmModel::query()
                ->byVehicleId($this->vehicle()->id)
                ->enabled()
                ->list()
                ->get()
        );
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\Collection\AlarmNotification
     */
    protected function alarmNotifications(): AlarmNotificationCollection
    {
        if ($this->vehicle() === null) {
            return new AlarmNotificationCollection();
        }

        return $this->cache(
            fn () => AlarmNotificationModel::query()
                ->byVehicleId($this->vehicle()->id)
                ->whereDashboard()
                ->whereClosedAt(false)
                ->withAlarm()
                ->withVehicle()
                ->withPosition()
                ->withTrip()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Dashboard/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Dashboard\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth']], static function () {
    Route::get('/', Index::class)->name('dashboard.index');
});

```

`app/Domains/Device/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\Device\Model\Device as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Device\Model\Device
     */
    protected ?Model $row;
}

```

`app/Domains/Device/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Device\Model\Device as Model;
use App\Domains\DeviceMessage\Model\DeviceMessage as DeviceMessageModel;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Device\Model\Device
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\Device\Model\Device
     */
    public function create(): Model
    {
        return $this->actionHandle(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandle(Delete::class);
    }

    /**
     * @return \App\Domains\Device\Model\Device
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\Device\Model\Device
     */
    public function updateBoolean(): Model
    {
        return $this->actionHandle(UpdateBoolean::class, $this->validate()->updateBoolean());
    }

    /**
     * @return \App\Domains\DeviceMessage\Model\DeviceMessage
     */
    public function updateDeviceMessageCreate(): DeviceMessageModel
    {
        return $this->actionHandle(UpdateDeviceMessageCreate::class);
    }

    /**
     * @return \App\Domains\Device\Model\Device
     */
    public function updateTransfer(): Model
    {
        return $this->actionHandle(UpdateTransfer::class, $this->validate()->updateTransfer());
    }
}

```

`app/Domains/Device/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Action;

use App\Domains\Device\Model\Device as Model;

class Create extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'code' => $this->data['code'],
            'name' => $this->data['name'],
            'model' => $this->data['model'],
            'serial' => $this->data['serial'],
            'phone_number' => $this->data['phone_number'],
            'password' => $this->data['password'],
            'config' => $this->data['config'],
            'enabled' => $this->data['enabled'],
            'shared' => $this->data['shared'],
            'shared_public' => $this->data['shared_public'],
            'vehicle_id' => $this->data['vehicle_id'],
            'user_id' => $this->data['user_id'],
        ]);
    }
}

```

`app/Domains/Device/Action/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Action;

use App\Domains\Device\Model\Device as Model;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

abstract class CreateUpdateAbstract extends ActionAbstract
{
    /**
     * @return void
     */
    abstract protected function save(): void;

    /**
     * @return \App\Domains\Device\Model\Device
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataName();
        $this->dataModel();
        $this->dataSerial();
        $this->dataPassword();
        $this->dataUserId();
    }

    /**
     * @return void
     */
    protected function dataName(): void
    {
        $this->data['name'] = trim($this->data['name']);
    }

    /**
     * @return void
     */
    protected function dataModel(): void
    {
        $this->data['model'] = trim($this->data['model']);
    }

    /**
     * @return void
     */
    protected function dataSerial(): void
    {
        $this->data['serial'] = trim($this->data['serial']);
    }

    /**
     * @return void
     */
    protected function dataPassword(): void
    {
        if (empty($this->data['password'])) {
            $this->data['password'] = $this->row->password ?? '';
        }
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkCode();
        $this->checkSerial();
        $this->checkVehicleId();
    }

    /**
     * @return void
     */
    protected function checkCode(): void
    {
        if ($this->checkCodeExists()) {
            $this->exceptionValidator(__('device-create.error.code-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkCodeExists(): bool
    {
        return Model::query()
            ->byIdNot($this->row->id ?? 0)
            ->byCode($this->data['code'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkSerial(): void
    {
        if ($this->checkSerialExists()) {
            $this->exceptionValidator(__('device-create.error.serial-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkSerialExists(): bool
    {
        return Model::query()
            ->byIdNot($this->row->id ?? 0)
            ->bySerial($this->data['serial'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkVehicleId(): void
    {
        if ($this->data['vehicle_id'] && ($this->checkVehicleIdExists() === false)) {
            $this->exceptionValidator(__('device-create.error.vehicle-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkVehicleIdExists(): bool
    {
        return VehicleModel::query()
            ->byId($this->data['vehicle_id'])
            ->byUserId($this->data['user_id'])
            ->exists();
    }
}

```

`app/Domains/Device/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->delete();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }
}

```

`app/Domains/Device/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Action;

class Update extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->code = $this->data['code'];
        $this->row->name = $this->data['name'];
        $this->row->model = $this->data['model'];
        $this->row->serial = $this->data['serial'];
        $this->row->phone_number = $this->data['phone_number'];
        $this->row->password = $this->data['password'];
        $this->row->config = $this->data['config'];
        $this->row->enabled = $this->data['enabled'];
        $this->row->shared = $this->data['shared'];
        $this->row->shared_public = $this->data['shared_public'];
        $this->row->vehicle_id = $this->data['vehicle_id'];

        $this->row->save();
    }
}

```

`app/Domains/Device/Action/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Action;

use App\Domains\CoreApp\Action\UpdateBoolean as UpdateBooleanCoreApp;
use App\Domains\Device\Model\Device as Model;

class UpdateBoolean extends UpdateBooleanCoreApp
{
    /**
     * @var \App\Domains\Device\Model\Device
     */
    protected Model $row;

    /**
     * @return void
     */
    protected function before(): void
    {
        $this->row->code = $this->row->code ?: helper()->uuid();
    }
}

```

`app/Domains/Device/Action/UpdateDeviceMessageCreate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Action;

use App\Domains\DeviceMessage\Model\DeviceMessage as DeviceMessageModel;

class UpdateDeviceMessageCreate extends ActionAbstract
{
    /**
     * @var \App\Domains\DeviceMessage\Model\DeviceMessage
     */
    protected DeviceMessageModel $message;

    /**
     * @return \App\Domains\DeviceMessage\Model\DeviceMessage
     */
    public function handle(): DeviceMessageModel
    {
        $this->save();

        return $this->message;
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->message = $this->factory('DeviceMessage')->action($this->saveData())->create();
    }

    /**
     * @return array
     */
    protected function saveData(): array
    {
        return ['device_id' => $this->row->id] + $this->request->input();
    }
}

```

`app/Domains/Device/Action/UpdateTransfer.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Action;

use App\Domains\Device\Model\Device as Model;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as TripModel;
use App\Domains\User\Model\User as UserModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class UpdateTransfer extends ActionAbstract
{
    /**
     * @return \App\Domains\Device\Model\Device
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataTrips();
    }

    /**
     * @return void
     */
    protected function dataTrips(): void
    {
        $this->data['trips'] = TripModel::query()
            ->byDeviceId($this->row->id)
            ->exists();
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkTrips();
        $this->checkUserId();
        $this->checkVehicleId();
        $this->checkDeviceId();
    }

    /**
     * @return void
     */
    protected function checkTrips(): void
    {
        if ($this->data['trips'] === false) {
            return;
        }

        if (empty($this->data['vehicle_id']) || empty($this->data['device_id'])) {
            $this->exceptionValidator(__('device-update-transfer.error.trips-exists'));
        }
    }

    /**
     * @return void
     */
    protected function checkUserId(): void
    {
        if ($this->checkUserIdExists() === false) {
            $this->exceptionValidator(__('device-update-transfer.error.user-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkUserIdExists(): bool
    {
        return UserModel::query()
            ->byId($this->data['user_id'])
            ->byIdNot($this->row->user_id)
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkVehicleId(): void
    {
        if ($this->data['trips'] && ($this->checkVehicleIdExists() === false)) {
            $this->exceptionValidator(__('device-update-transfer.error.vehicle-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkVehicleIdExists(): bool
    {
        return VehicleModel::query()
            ->byId($this->data['vehicle_id'])
            ->byUserId($this->row->user_id)
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkDeviceId(): void
    {
        if ($this->data['trips'] && ($this->checkDeviceIdExists() === false)) {
            $this->exceptionValidator(__('device-update-transfer.error.device-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkDeviceIdExists(): bool
    {
        return Model::query()
            ->byId($this->data['device_id'])
            ->byUserId($this->row->user_id)
            ->byIdNot($this->row->id)
            ->exists();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveTrip();
        $this->savePosition();
        $this->saveRow();
    }

    /**
     * @return void
     */
    protected function saveTrip(): void
    {
        if ($this->data['trips'] === false) {
            return;
        }

        TripModel::query()
            ->byDeviceId($this->row->id)
            ->update($this->saveTripData());
    }

    /**
     * @return array
     */
    protected function saveTripData(): array
    {
        return [
            'device_id' => $this->data['device_id'],
            'vehicle_id' => $this->data['vehicle_id'],
        ];
    }

    /**
     * @return void
     */
    protected function savePosition(): void
    {
        if ($this->data['trips'] === false) {
            return;
        }

        PositionModel::query()
            ->byDeviceId($this->row->id)
            ->update($this->savePositionData());
    }

    /**
     * @return array
     */
    protected function savePositionData(): array
    {
        return [
            'device_id' => $this->data['device_id'],
            'vehicle_id' => $this->data['vehicle_id'],
        ];
    }

    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->row->user_id = $this->data['user_id'];
        $this->row->vehicle_id = null;
        $this->row->save();
    }
}

```

`app/Domains/Device/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller;

use App\Domains\Alarm\Model\Alarm as AlarmModel;
use App\Domains\AlarmNotification\Model\AlarmNotification as AlarmNotificationModel;
use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\Device\Model\Device as Model;
use App\Domains\DeviceMessage\Model\DeviceMessage as DeviceMessageModel;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\Device\Model\Device
     */
    protected ?Model $row;

    /**
     * @var ?\App\Domains\Alarm\Model\Alarm
     */
    protected ?AlarmModel $alarm;

    /**
     * @var ?\App\Domains\AlarmNotification\Model\AlarmNotification
     */
    protected ?AlarmNotificationModel $alarmNotification;

    /**
     * @var ?\App\Domains\DeviceMessage\Model\DeviceMessage
     */
    protected ?DeviceMessageModel $message;

    /**
     * @param int $id
     *
     * @return \App\Domains\Device\Model\Device
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('device.error.not-found')));
    }

    /**
     * @param int $alarm_id
     *
     * @return \App\Domains\Alarm\Model\Alarm
     */
    protected function alarm(int $alarm_id): AlarmModel
    {
        return $this->alarm = AlarmModel::query()
            ->byId($alarm_id)
            ->byDeviceId($this->row->id)
            ->firstOr(fn () => $this->exceptionNotFound(__('device.error.not-found')));
    }

    /**
     * @param int $alarm_notification_id
     *
     * @return \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    protected function alarmNotification(int $alarm_notification_id): AlarmNotificationModel
    {
        return $this->alarmNotification = AlarmNotificationModel::query()
            ->byId($alarm_notification_id)
            ->byDeviceId($this->row->id)
            ->firstOr(fn () => $this->exceptionNotFound(__('device.error.not-found')));
    }

    /**
     * @param int $device_message_id
     *
     * @return \App\Domains\DeviceMessage\Model\DeviceMessage
     */
    protected function message(int $device_message_id): DeviceMessageModel
    {
        return $this->message = DeviceMessageModel::query()
            ->byId($device_message_id)
            ->byDeviceId($this->row->id)
            ->firstOr(fn () => $this->exceptionNotFound(__('device.error.not-found')));
    }
}

```

`app/Domains/Device/Controller/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Device\Controller\Service\Create as ControllerService;

class Create extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($response = $this->actionPost('create')) {
            return $response;
        }

        $this->meta('title', __('device-create.meta-title'));

        return $this->page('device.create', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function create(): RedirectResponse
    {
        $this->row = $this->action()->create();

        $this->sessionMessage('success', __('device-create.success'));

        return redirect()->route('device.update', $this->row->id);
    }
}

```

`app/Domains/Device/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller;

use Illuminate\Http\Response;
use App\Domains\Device\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('device-index.meta-title'));

        return $this->page('device.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Device/Controller/Map.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Response;
use App\Domains\Device\Controller\Service\Map as ControllerService;

class Map extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse
     */
    public function __invoke(): Response|JsonResponse
    {
        if ($this->request->wantsJson()) {
            return $this->responseJson();
        }

        $this->meta('title', __('device-map.meta-title'));

        return $this->page('device.map', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->factory()->fractal('map', $this->data()['list']));
    }
}

```

`app/Domains/Device/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/Device/Controller/Service/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;

class Create extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->request();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCreateUpdate();
    }
}

```

`app/Domains/Device/Controller/Service/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller\Service;

abstract class CreateUpdateAbstract extends ControllerAbstract
{
    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow([
            'code' => ($this->row->code ?? helper()->uuid()),
            'user_id' => $this->user()->id,
        ]);
    }

    /**
     * @return array
     */
    protected function dataCreateUpdate(): array
    {
        return $this->dataCore() + [
            'vehicles' => $this->vehicles(),
            'position_filter_distance_default' => app('configuration')->int('position_filter_distance'),
        ];
    }
}

```

`app/Domains/Device/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Device\Model\Collection\Device as Collection;
use App\Domains\Device\Model\Device as Model;

class Index extends ControllerAbstract
{
    /**
     * @var bool
     */
    protected bool $userEmpty = true;

    /**
     * @var bool
     */
    protected bool $vehicleEmpty = true;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->filters();
    }

    /**
     * @return void
     */
    protected function filters(): void
    {
        $this->filtersUserId();
        $this->filtersVehicleId();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCore() + [
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'vehicle_empty' => $this->vehicleEmpty(),
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\Device\Model\Collection\Device
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->whenVehicleId($this->vehicle()?->id)
                ->withMessagesCount()
                ->withMessagesPendingCount()
                ->withUser()
                ->withVehicle()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Device/Controller/Service/Map.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Device\Model\Collection\Device as Collection;
use App\Domains\Device\Model\Device as Model;

class Map extends ControllerAbstract
{
    /**
     * @var bool
     */
    protected bool $userEmpty = true;

    /**
     * @var bool
     */
    protected bool $vehicleEmpty = true;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->filters();
    }

    /**
     * @return void
     */
    protected function filters(): void
    {
        $this->filtersUserId();
        $this->filtersVehicleId();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCore() + [
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'vehicle_empty' => $this->vehicleEmpty(),
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\Device\Model\Collection\Device
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->whenVehicleId($this->vehicle()?->id)
                ->whenIds($this->requestArray('ids'))
                ->whenTripFinished($this->requestBool('finished', null))
                ->withVehicle()
                ->withWhereHasPositionLast()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Device/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Device\Model\Device as Model;

class Update extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Device\Model\Device $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCreateUpdate() + [
            'row' => $this->row,
        ];
    }
}

```

`app/Domains/Device/Controller/Service/UpdateDeviceMessage.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Device\Model\Device as Model;
use App\Domains\DeviceMessage\Model\Collection\DeviceMessage as DeviceMessageCollection;
use App\Domains\DeviceMessage\Model\DeviceMessage as DeviceMessageModel;

class UpdateDeviceMessage extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Device\Model\Device $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCore() + [
            'row' => $this->row,
            'messages' => $this->messages(),
        ];
    }

    /**
     * @return \App\Domains\DeviceMessage\Model\Collection\DeviceMessage
     */
    protected function messages(): DeviceMessageCollection
    {
        return DeviceMessageModel::query()
            ->byDeviceId($this->row->id)
            ->list()
            ->get();
    }
}

```

`app/Domains/Device/Controller/Service/UpdateTransfer.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Device\Model\Collection\Device as Collection;
use App\Domains\Device\Model\Device as Model;
use App\Domains\Trip\Model\Trip as TripModel;
use App\Domains\User\Model\Collection\User as UserCollection;
use App\Domains\User\Model\User as UserModel;
use App\Domains\Vehicle\Model\Collection\Vehicle as VehicleCollection;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class UpdateTransfer extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Device\Model\Device $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'devices' => $this->devices(),
            'users' => $this->users(),
            'vehicles' => $this->vehicles(),
            'trips' => $this->trips(),
        ];
    }

    /**
     * @return \App\Domains\Device\Model\Collection\Device
     */
    protected function devices(): Collection
    {
        return Model::query()
            ->byUserId($this->row->user_id)
            ->byIdNot($this->row->id)
            ->list()
            ->get();
    }

    /**
     * @return \App\Domains\User\Model\Collection\User
     */
    protected function users(): UserCollection
    {
        return UserModel::query()
            ->byIdNot($this->row->user_id)
            ->list()
            ->get();
    }

    /**
     * @return \App\Domains\Vehicle\Model\Collection\Vehicle
     */
    protected function vehicles(): VehicleCollection
    {
        return VehicleModel::query()
            ->byUserId($this->row->user_id)
            ->list()
            ->get();
    }

    /**
     * @return int
     */
    protected function trips(): int
    {
        return TripModel::query()
            ->byDeviceId($this->row->id)
            ->count();
    }
}

```

`app/Domains/Device/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Device\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actions()) {
            return $response;
        }

        $this->meta('title', __('device-update.meta-title', ['title' => $this->row->name]));

        return $this->page('device.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('update')
            ?: $this->actionPost('delete');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('device-update.success'));

        return redirect()->route('device.update', $this->row->id);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function delete(): RedirectResponse
    {
        $this->action()->delete();

        $this->sessionMessage('success', __('device-update.delete-success'));

        return redirect()->route('device.index');
    }
}

```

`app/Domains/Device/Controller/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller;

use Illuminate\Http\JsonResponse;
use App\Domains\Device\Model\Device as Model;

class UpdateBoolean extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(int $id): JsonResponse
    {
        $this->row($id);

        return $this->json($this->fractal($this->action()->updateBoolean()));
    }

    /**
     * @param \App\Domains\Device\Model\Device $row
     *
     * @return array
     */
    protected function fractal(Model $row): array
    {
        return $this->factory()->fractal('simple', $row);
    }
}

```

`app/Domains/Device/Controller/UpdateDeviceMessage.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller;

use Illuminate\Http\Response;
use App\Domains\Device\Controller\Service\UpdateDeviceMessage as ControllerService;

class UpdateDeviceMessage extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response
     */
    public function __invoke(int $id): Response
    {
        $this->row($id);

        $this->meta('title', __('device-update-device-message.meta-title', ['title' => $this->row->name]));

        return $this->page('device.update-device-message', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }
}

```

`app/Domains/Device/Controller/UpdateDeviceMessageCreate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller;

use Illuminate\Http\RedirectResponse;

class UpdateDeviceMessageCreate extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): RedirectResponse
    {
        $this->row($id);

        $this->actionPost('updateDeviceMessageCreate');

        return redirect()->back();
    }

    /**
     * @return void
     */
    protected function updateDeviceMessageCreate(): void
    {
        $this->action()->updateDeviceMessageCreate();

        $this->sessionMessage('success', __('device-update-device-message.create-success'));
    }
}

```

`app/Domains/Device/Controller/UpdateDeviceMessageUpdate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller;

use Illuminate\Http\RedirectResponse;

class UpdateDeviceMessageUpdate extends ControllerAbstract
{
    /**
     * @param int $id
     * @param int $device_message_id
     *
     * @return \Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id, int $device_message_id): RedirectResponse
    {
        $this->row($id);
        $this->message($device_message_id);

        $this->actions();

        return redirect()->back();
    }

    /**
     * @return void
     */
    protected function actions(): void
    {
        $this->actionPost('updateDeviceMessageDuplicate') ?: $this->actionPost('updateDeviceMessageDelete');
    }

    /**
     * @return void
     */
    protected function updateDeviceMessageDelete(): void
    {
        $this->factory('DeviceMessage', $this->message)->action()->delete();

        $this->sessionMessage('success', __('device-update-device-message-update.delete-success'));
    }

    /**
     * @return void
     */
    protected function updateDeviceMessageDuplicate(): void
    {
        $this->factory('DeviceMessage', $this->message)->action()->duplicate();

        $this->sessionMessage('success', __('device-update-device-message-update.duplicate-success'));
    }
}

```

`app/Domains/Device/Controller/UpdateTransfer.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Device\Controller\Service\UpdateTransfer as ControllerService;

class UpdateTransfer extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('updateTransfer')) {
            return $response;
        }

        $this->meta('title', __('device-update-transfer.meta-title', ['title' => $this->row->name]));

        return $this->page('device.update-transfer', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateTransfer(): RedirectResponse
    {
        $this->action()->updateTransfer();

        $this->sessionMessage('success', __('device-update-transfer.success'));

        return redirect()->route('device.index');
    }
}

```

`app/Domains/Device/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth']], static function () {
    Route::get('/device', Index::class)->name('device.index');
    Route::any('/device/create', Create::class)->name('device.create');
    Route::any('/device/map', Map::class)->name('device.map');
    Route::any('/device/{id}', Update::class)->name('device.update');
    Route::any('/device/{id}/boolean/{column}', UpdateBoolean::class)->name('device.update.boolean');
    Route::any('/device/{id}/device-message', UpdateDeviceMessage::class)->name('device.update.device-message');
    Route::any('/device/{id}/device-message/create', UpdateDeviceMessageCreate::class)->name('device.update.device-message.create');
    Route::any('/device/{id}/device-message/{device_message_id}', UpdateDeviceMessageUpdate::class)->name('device.update.device-message.update');
});

Route::group(['middleware' => ['user-auth-manager-mode']], static function () {
    Route::any('/device/{id}/transfer', UpdateTransfer::class)->name('device.update.transfer');
});

```

`app/Domains/Device/ControllerApi/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\ControllerApi;

use App\Domains\CoreApp\Controller\ControllerApiAbstract as CoreControllerApiAbstract;
use App\Domains\Device\Model\Device as Model;

abstract class ControllerApiAbstract extends CoreControllerApiAbstract
{
    /**
     * @var ?\App\Domains\Device\Model\Device
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Device\Model\Device
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('device.error.not-found')));
    }
}

```

`app/Domains/Device/ControllerApi/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Device\Model\Device as Model;
use App\Domains\Device\ControllerApi\Service\Create as ControllerService;

class Create extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('json', $this->execute()));
    }

    /**
     * @return \App\Domains\Device\Model\Device
     */
    protected function execute(): Model
    {
        return $this->action(data: $this->data())->create();
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Device/ControllerApi/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\ControllerApi;

class Delete extends ControllerApiAbstract
{
    /**
     * @param int $id
     *
     * @return void
     */
    public function __invoke(int $id): void
    {
        $this->row($id);
        $this->action()->delete();
    }
}

```

`app/Domains/Device/ControllerApi/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Device\ControllerApi\Service\Index as ControllerService;

class Index extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('json', $this->data()));
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Device/ControllerApi/Service/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\ControllerApi\Service;

use App\Domains\CoreApp\ControllerApi\Service\ControllerApiAbstract as CoreAppControllerApiAbstract;

abstract class ControllerApiAbstract extends CoreAppControllerApiAbstract
{
}

```

`app/Domains/Device/ControllerApi/Service/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;

class Create extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCustom() + $this->dataDefault();
    }

    /**
     * @return array
     */
    protected function dataCustom(): array
    {
        return ['code' => helper()->uuid()];
    }

    /**
     * @return array
     */
    protected function dataDefault(): array
    {
        return $this->request->input();
    }
}

```

`app/Domains/Device/ControllerApi/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Device\Model\Device as Model;

class Index extends ControllerApiAbstract
{
    /**
     * @var bool
     */
    protected bool $userEmpty = true;

    /**
     * @var bool
     */
    protected bool $vehicleEmpty = true;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return Model::query()
            ->byUserOrManager($this->auth)
            ->whenUserId($this->requestInteger('user_id'))
            ->whenVehicleId($this->requestInteger('vehicle_id'))
            ->withSimple('user')
            ->withSimple('vehicle')
            ->list()
            ->get()
            ->all();
    }
}

```

`app/Domains/Device/ControllerApi/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Device\Model\Device as Model;

class Update extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Device\Model\Device $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataDefault()
            + $this->dataRow();
    }

    /**
     * @return array
     */
    protected function dataDefault(): array
    {
        return $this->request->input();
    }

    /**
     * @return array
     */
    protected function dataRow(): array
    {
        return $this->row->toArray();
    }
}

```

`app/Domains/Device/ControllerApi/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Device\Model\Device as Model;
use App\Domains\Device\ControllerApi\Service\Update as ControllerService;

class Update extends ControllerApiAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(int $id): JsonResponse
    {
        $this->row($id);

        return $this->json($this->factory()->fractal('json', $this->execute()));
    }

    /**
     * @return \App\Domains\Device\Model\Device
     */
    protected function execute(): Model
    {
        return $this->action(data: $this->data())->update();
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }
}

```

`app/Domains/Device/ControllerApi/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\ControllerApi;

use Illuminate\Support\Facades\Route;

Route::get('/device', Index::class)->name('device.index');
Route::post('/device/create', Create::class)->name('device.create');
Route::patch('/device/{id}', Update::class)->name('device.update');
Route::delete('/device/{id}', Delete::class)->name('device.delete');

```

`app/Domains/Device/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\Device\Model\Device as Model;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\Device\Model\Device $row
     *
     * @return array
     */
    protected function json(Model $row): array
    {
        return [
            'id' => $row->id,
            'code' => $row->code,
            'name' => $row->name,
            'model' => $row->model,
            'serial' => $row->serial,
            'phone_number' => $row->phone_number,
            'password' => $row->password,
            'enabled' => $row->enabled,
            'shared' => $row->shared,
            'shared_public' => $row->shared_public,
            'user' => $this->from('User', 'related', $row->user),
            'vehicle' => $this->from('Vehicle', 'related', $row->vehicle),
        ];
    }

    /**
     * @param \App\Domains\Device\Model\Device $row
     *
     * @return array
     */
    protected function map(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
            'position' => $this->mapPosition($row->positionLast),
            'vehicle' => $this->mapVehicle($row->vehicle),
        ];
    }

    /**
     * @param ?\App\Domains\Position\Model\Position $position
     *
     * @return ?array
     */
    protected function mapPosition(?PositionModel $position): ?array
    {
        if ($position === null) {
            return null;
        }

        return [
            'id' => $position->id,
            'date_at' => $position->date_at,
            'date_utc_at' => $position->date_utc_at,
            'latitude' => $position->latitude,
            'longitude' => $position->longitude,
            'direction' => $position->direction,
            'speed' => helper()->unit('speed', $position->speed),
            'speed_human' => helper()->unitHuman('speed', $position->speed),
            'city' => $position->city?->name,
            'state' => $position->city?->state->name,
        ];
    }

    /**
     * @param ?\App\Domains\Vehicle\Model\Vehicle $vehicle
     *
     * @return ?array
     */
    protected function mapVehicle(?VehicleModel $vehicle): ?array
    {
        if ($vehicle === null) {
            return null;
        }

        return [
            'id' => $vehicle->id,
            'name' => $vehicle->name,
        ];
    }

    /**
     * @param \App\Domains\Device\Model\Device $row
     *
     * @return array
     */
    protected function related(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
        ];
    }

    /**
     * @param \App\Domains\Device\Model\Device $row
     *
     * @return array
     */
    protected function simple(Model $row): array
    {
        return $row->only('id', 'name', 'shared', 'shared_public');
    }
}

```

`app/Domains/Device/Middleware/Available.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Middleware;

use Closure;
use Illuminate\Http\Request;
use App\Domains\Device\Model\Device as Model;

class Available extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        if ($this->exists($request) === false) {
            return redirect()->route('device.create');
        }

        return $next($request);
    }

    /**
     * @param \Illuminate\Http\Request $request
     *
     * @return bool
     */
    protected function exists(Request $request): bool
    {
        return Model::query()
            ->byUserId($request->user()->id)
            ->exists();
    }
}

```

`app/Domains/Device/Middleware/MiddlewareAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Middleware;

use App\Domains\Core\Middleware\MiddlewareAbstract as MiddlewareAbstractCore;

abstract class MiddlewareAbstract extends MiddlewareAbstractCore
{
}

```

`app/Domains/Device/Model/Builder/Device.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\Trip\Model\Trip as TripModel;

class Device extends BuilderAbstract
{
    /**
     * @param string $code
     *
     * @return self
     */
    public function byCode(string $code): self
    {
        return $this->where('code', $code);
    }

    /**
     * @param string $serial
     *
     * @return self
     */
    public function bySerial(string $serial): self
    {
        return $this->where('serial', $serial);
    }

    /**
     * @return self
     */
    public function listSimple(): self
    {
        return $this->select('id', 'name')->orderBy('name', 'ASC');
    }

    /**
     * @return self
     */
    public function selectRelated(): self
    {
        return $this->select('id', 'name', 'user_id', 'vehicle_id');
    }

    /**
     * @param ?bool $finished
     *
     * @return self
     */
    public function whenTripFinished(?bool $finished): self
    {
        return $this->when(is_bool($finished), fn ($q) => $q->whereTripFinished($finished));
    }

    /**
     * @param ?bool $shared
     *
     * @return self
     */
    public function whenShared(?bool $shared): self
    {
        return $this->when(is_bool($shared), fn ($q) => $q->whereShared($shared));
    }

    /**
     * @param ?bool $shared_public
     *
     * @return self
     */
    public function whenSharedPublic(?bool $shared_public): self
    {
        return $this->when(is_bool($shared_public), fn ($q) => $q->whereSharedPublic($shared_public));
    }

    /**
     * @param bool $finished = true
     *
     * @return self
     */
    public function whereTripFinished(bool $finished = true): self
    {
        return $this->whereIn('id', TripModel::query()->select('device_id')->whereFinished($finished));
    }

    /**
     * @param bool $shared_public = true
     *
     * @return self
     */
    public function whereTripSharedPublic(bool $shared_public = true): self
    {
        return $this->whereIn('id', TripModel::query()->select('device_id')->whereSharedPublic($shared_public));
    }

    /**
     * @param bool $shared = true
     *
     * @return self
     */
    public function whereShared(bool $shared = true): self
    {
        return $this->where('shared', $shared);
    }

    /**
     * @param bool $shared_public = true
     *
     * @return self
     */
    public function whereSharedPublic(bool $shared_public = true): self
    {
        return $this->whereShared()->where('shared_public', $shared_public);
    }

    /**
     * @return self
     */
    public function withMessagesCount(): self
    {
        return $this->withCount('messages');
    }

    /**
     * @return self
     */
    public function withMessagesPendingCount(): self
    {
        return $this->withCount(['messages as messages_pending_count' => fn ($q) => $q->whereResponseAt()]);
    }

    /**
     * @return self
     */
    public function withWhereHasPositionLast(): self
    {
        return $this->withWhereHas('positionLast', fn ($q) => $q->withCityState());
    }

    /**
     * @return self
     */
    public function withTripLastShared(): self
    {
        return $this->with('tripLastShared');
    }

    /**
     * @return self
     */
    public function withTripLastSharedPublic(): self
    {
        return $this->with('tripLastSharedPublic');
    }

    /**
     * @return self
     */
    public function withVehicle(): self
    {
        return $this->with(['vehicle' => fn ($q) => $q->withTimezone()]);
    }

    /**
     * @return self
     */
    public function withWhereHasTripLastSharedPublic(): self
    {
        return $this->withWhereHas('tripLastSharedPublic');
    }
}

```

`app/Domains/Device/Model/Collection/Device.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Device extends CollectionAbstract
{
}

```

`app/Domains/Device/Model/Device.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\HasOne;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\Device\Model\Builder\Device as Builder;
use App\Domains\Device\Model\Collection\Device as Collection;
use App\Domains\Device\Test\Factory\Device as TestFactory;
use App\Domains\DeviceMessage\Model\DeviceMessage as DeviceMessageModel;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as TripModel;
use App\Domains\User\Model\User as UserModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class Device extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'device';

    /**
     * @const string
     */
    public const TABLE = 'device';

    /**
     * @const string
     */
    public const FOREIGN = 'device_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'config' => 'array',
        'enabled' => 'boolean',
        'shared' => 'boolean',
        'shared_public' => 'boolean',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\Device\Model\Collection\Device
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Device\Model\Builder\Device
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Device\Test\Factory\Device
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function positions(): HasMany
    {
        return $this->hasMany(PositionModel::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasOne
     */
    public function positionLast(): HasOne
    {
        return $this->hasOne(PositionModel::class, static::FOREIGN)
            ->ofMany(['date_utc_at' => 'MAX']);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function messages(): HasMany
    {
        return $this->hasMany(DeviceMessageModel::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasOne
     */
    public function tripLast(): HasOne
    {
        return $this->hasOne(TripModel::class, static::FOREIGN)
            ->ofMany(['end_utc_at' => 'MAX']);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasOne
     */
    public function tripLastShared(): HasOne
    {
        return $this->hasOne(TripModel::class, static::FOREIGN)
            ->ofMany(['endutc_at' => 'MAX'], fn ($q) => $q->whereShared());
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasOne
     */
    public function tripLastSharedPublic(): HasOne
    {
        return $this->hasOne(TripModel::class, static::FOREIGN)
            ->ofMany(['end_utc_at' => 'MAX'], fn ($q) => $q->whereSharedPublic());
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function trips(): HasMany
    {
        return $this->hasMany(TripModel::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(UserModel::class, UserModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(VehicleModel::class, VehicleModel::FOREIGN);
    }

    /**
     * @param string $key
     *
     * @return int
     */
    public function config(string $key): int
    {
        return intval($this->config[$key] ?? 0) ?: app('configuration')->int($key);
    }
}

```

`app/Domains/Device/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'code' => ['bail', 'required', 'uuid'],
            'name' => ['bail', 'required', 'string'],
            'model' => ['bail', 'required', 'string'],
            'serial' => ['bail', 'required', 'string'],
            'phone_number' => ['bail', 'string'],
            'password' => ['bail', 'string'],
            'user_id' => ['bail', 'integer'],
            'vehicle_id' => ['bail', 'nullable', 'integer'],
            'enabled' => ['bail', 'boolean'],
            'shared' => ['bail', 'boolean'],
            'shared_public' => ['bail', 'boolean'],
            'config' => ['bail', 'array', 'required'],
            'config.position_filter_distance' => ['bail', 'integer', 'min:0'],
            'config.position_filter_distance_multiplier' => ['bail', 'integer', 'min:0'],
            'config.position_filter_time' => ['bail', 'integer', 'min:0'],
        ];
    }
}

```

`app/Domains/Device/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Validate;

class Update extends Create
{
}

```

`app/Domains/Device/Validate/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Validate;

use App\Domains\CoreApp\Validate\UpdateBoolean as UpdateBooleanCoreApp;

class UpdateBoolean extends UpdateBooleanCoreApp
{
}

```

`app/Domains/Device/Validate/UpdateTransfer.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdateTransfer extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'user_id' => ['bail', 'integer', 'required'],
            'vehicle_id' => ['bail', 'integer'],
            'device_id' => ['bail', 'integer'],
        ];
    }
}

```

`app/Domains/Device/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Device\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/DeviceMessage/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\DeviceMessage\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\DeviceMessage\Model\DeviceMessage as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\DeviceMessage\Model\DeviceMessage
     */
    protected ?Model $row;
}

```

`app/Domains/DeviceMessage/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\DeviceMessage\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\DeviceMessage\Model\DeviceMessage as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\DeviceMessage\Model\DeviceMessage
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\DeviceMessage\Model\DeviceMessage
     */
    public function create(): Model
    {
        return $this->actionHandle(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandle(Delete::class);
    }

    /**
     * @return \App\Domains\DeviceMessage\Model\DeviceMessage
     */
    public function duplicate(): Model
    {
        return $this->actionHandle(Duplicate::class);
    }
}

```

`app/Domains/DeviceMessage/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\DeviceMessage\Action;

use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\DeviceMessage\Model\DeviceMessage as Model;

class Create extends ActionAbstract
{
    /**
     * @return \App\Domains\DeviceMessage\Model\DeviceMessage
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataMessage();
    }

    /**
     * @return void
     */
    protected function dataMessage(): void
    {
        $this->data['message'] = trim($this->data['message']);
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkDeviceId();
    }

    /**
     * @return void
     */
    protected function checkDeviceId(): void
    {
        if ($this->checkDeviceIdExists() === false) {
            $this->exceptionValidator(__('device-message-create.error.device-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkDeviceIdExists(): bool
    {
        return DeviceModel::query()
            ->byId($this->data['device_id'])
            ->byUserOrManager($this->auth)
            ->exists();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'message' => $this->data['message'],
            'device_id' => $this->data['device_id'],
        ]);
    }
}

```

`app/Domains/DeviceMessage/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\DeviceMessage\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->delete();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }
}

```

`app/Domains/DeviceMessage/Action/Duplicate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\DeviceMessage\Action;

use App\Domains\DeviceMessage\Model\DeviceMessage as Model;

class Duplicate extends ActionAbstract
{
    /**
     * @return \App\Domains\DeviceMessage\Model\DeviceMessage
     */
    public function handle(): Model
    {
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'message' => $this->row->message,
            'device_id' => $this->row->device_id,
        ]);
    }
}

```

`app/Domains/DeviceMessage/Model/Builder/DeviceMessage.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\DeviceMessage\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\Device\Model\Device as DeviceModel;

class DeviceMessage extends BuilderAbstract
{
    /**
     * @param string $serial
     *
     * @return self
     */
    public function byDeviceSerial(string $serial): self
    {
        return $this->whereIn('device_id', DeviceModel::query()->select('id')->bySerial($serial));
    }

    /**
     * @param bool $response_at = false
     *
     * @return self
     */
    public function whereResponseAt(bool $response_at = false): self
    {
        return $this->when(
            $response_at,
            fn ($q) => $q->whereNotNull('response_at'),
            fn ($q) => $q->whereNull('response_at')
        );
    }

    /**
     * @param bool $sent_at = false
     *
     * @return self
     */
    public function whereSentAt(bool $sent_at = false): self
    {
        return $this->when(
            $sent_at,
            fn ($q) => $q->whereNotNull('sent_at'),
            fn ($q) => $q->whereNull('sent_at')
        );
    }

    /**
     * @return self
     */
    public function withDevice(): self
    {
        return $this->with('device');
    }
}

```

`app/Domains/DeviceMessage/Model/Collection/DeviceMessage.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\DeviceMessage\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class DeviceMessage extends CollectionAbstract
{
}

```

`app/Domains/DeviceMessage/Model/DeviceMessage.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\DeviceMessage\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\DeviceMessage\Model\Builder\DeviceMessage as Builder;
use App\Domains\DeviceMessage\Model\Collection\DeviceMessage as Collection;
use App\Domains\DeviceMessage\Test\Factory\DeviceMessage as TestFactory;

class DeviceMessage extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'device_message';

    /**
     * @const string
     */
    public const TABLE = 'device_message';

    /**
     * @const string
     */
    public const FOREIGN = 'device_message_id';

    /**
     * @param array $models
     *
     * @return \App\Domains\DeviceMessage\Model\Collection\DeviceMessage
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\DeviceMessage\Model\Builder\DeviceMessage
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\DeviceMessage\Test\Factory\DeviceMessage
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function device(): BelongsTo
    {
        return $this->belongsTo(DeviceModel::class, DeviceModel::FOREIGN);
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return strtr($this->message, [
            '{PASSWORD}' => $this->device->password,
            '{SERIAL}' => $this->device->serial,
        ]);
    }
}

```

`app/Domains/DeviceMessage/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\DeviceMessage\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'message' => ['bail', 'required'],
            'device_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/DeviceMessage/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\DeviceMessage\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Error/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Error\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;

abstract class ControllerAbstract extends ControllerWebAbstract
{
}

```

`app/Domains/Error/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Error\Controller;

use Throwable;
use Illuminate\Http\Request;
use Illuminate\Http\Response;

class Index extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     *
     * @return self
     */
    public function __construct(Request $request)
    {
        $this->request = $request;
        $this->auth = $request->user();

        $this->init();
    }

    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(Throwable $e): Response
    {
        $this->meta('title', __('error.meta-title'));

        return $this->page('error.index', [
            'code' => $e->getCode(),
            'message' => $e->getMessage(),
        ], $e->getCode());
    }
}

```

`app/Domains/File/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Action;

use App\Domains\Core\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\File\Model\File as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\File\Model\File
     */
    protected ?Model $row;
}

```

`app/Domains/File/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\File\Model\Collection\File as Collection;
use App\Domains\File\Model\File as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\File\Model\File
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\File\Model\File
     */
    public function create(): Model
    {
        return $this->actionHandle(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandle(Delete::class);
    }

    /**
     * @return \App\Domains\File\Model\File
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\File\Model\Collection\File
     */
    public function upload(): Collection
    {
        return $this->actionHandle(Upload::class, $this->validate()->upload());
    }
}

```

`app/Domains/File/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Action;

use App\Domains\File\Model\File as Model;

class Create extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->row = Model::query()->create([
            'name' => $this->data['name'],
            'path' => $this->data['path'],
            'size' => $this->data['size'],
            'related_table' => $this->data['related_table'],
            'related_id' => $this->data['related_id'],
            'user_id' => $this->data['user_id'],
        ])->fresh();
    }
}

```

`app/Domains/File/Action/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Action;

use App\Domains\File\Model\File as Model;

abstract class CreateUpdateAbstract extends ActionAbstract
{
    /**
     * @return void
     */
    abstract protected function saveRow(): void;

    /**
     * @return \App\Domains\File\Model\File
     */
    public function handle(): Model
    {
        $this->data();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataRelatedTable();
        $this->dataRelatedId();
        $this->dataName();
        $this->dataPath();
        $this->dataSize();
    }

    /**
     * @return void
     */
    protected function dataRelatedTable(): void
    {
        $this->data['related_table'] ??= $this->row->related_table;
    }

    /**
     * @return void
     */
    protected function dataRelatedId(): void
    {
        $this->data['related_id'] ??= $this->row->related_id;
    }

    /**
     * @return void
     */
    protected function dataName(): void
    {
        $this->data['name'] = $this->data['file']->getClientOriginalName();
    }

    /**
     * @return void
     */
    protected function dataPath(): void
    {
        $this->data['path'] = $this->data['related_table']
            .'/'.$this->data['related_id']
            .'/'.$this->dataPathName();
    }

    /**
     * @return string
     */
    protected function dataPathName(): string
    {
        preg_match('/^(.*)\.([^\.]+)$/i', $this->data['name'], $matches);

        return sprintf('%.4f', microtime(true))
            .'-'.substr(str_slug($matches[1]), 0, 80)
            .'.'.strtolower($matches[2]);
    }

    /**
     * @return void
     */
    protected function dataSize(): void
    {
        $this->data['size'] = $this->data['file']->getSize();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveFile();
        $this->saveRow();
    }

    /**
     * @return void
     */
    protected function saveFile(): void
    {
        Model::fileContentsSet($this->data['path'], $this->data['file']->getContent());
    }
}

```

`app/Domains/File/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->delete();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->deleteRow();
        $this->deleteFile();
    }

    /**
     * @return void
     */
    protected function deleteRow(): void
    {
        $this->row->delete();
    }

    /**
     * @return void
     */
    protected function deleteFile(): void
    {
        $this->row->fileDelete();
    }
}

```

`app/Domains/File/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Action;

class Update extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->row->name = $this->data['name'];
        $this->row->path = $this->data['path'];
        $this->row->size = $this->data['size'];
        $this->row->save();
    }
}

```

`app/Domains/File/Action/Upload.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Action;

use Throwable;
use App\Domains\File\Model\Collection\File as Collection;
use App\Domains\File\Model\File as Model;

class Upload extends ActionAbstract
{
    /**
     * @var \App\Domains\File\Model\Collection\File
     */
    protected Collection $list;

    /**
     * @return \App\Domains\File\Model\Collection\File
     */
    public function handle(): Collection
    {
        $this->list();
        $this->iterate();

        return $this->list;
    }

    /**
     * @return void
     */
    protected function list(): void
    {
        $this->list = new Collection();
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->data['files'] as $file) {
            try {
                $this->file($file);
            } catch (Throwable $e) {
                report($e);
            }
        }
    }

    /**
     * @param array $file
     *
     * @return void
     */
    protected function file(array $file): void
    {
        if (empty($file['id'])) {
            $this->create($file);
        } elseif (empty($file['delete'])) {
            $this->update($file);
        } else {
            $this->delete($file);
        }
    }

    /**
     * @param array $file
     *
     * @return void
     */
    protected function create(array $file): void
    {
        if (empty($file['file'])) {
            return;
        }

        $this->list->push($this->factory('File')->action($this->createData($file))->create());
    }

    /**
     * @param array $file
     *
     * @return array
     */
    protected function createData(array $file): array
    {
        return [
            'file' => $file['file'],
            'related_table' => $this->data['related_table'],
            'related_id' => $this->data['related_id'],
            'user_id' => $this->data['user_id'],
        ];
    }

    /**
     * @param array $file
     *
     * @return void
     */
    protected function update(array $file): void
    {
        if (empty($file['file'])) {
            return;
        }

        $this->list->push($this->factory('File', $this->row($file))->action($this->updateData($file))->update());
    }

    /**
     * @param array $file
     *
     * @return array
     */
    protected function updateData(array $file): array
    {
        return [
            'file' => $file['file'],
        ];
    }

    /**
     * @param array $file
     *
     * @return void
     */
    protected function delete(array $file): void
    {
        $this->factory('File', $this->row($file))->action()->delete();
    }

    /**
     * @param array $file
     *
     * @return \App\Domains\File\Model\File
     */
    protected function row(array $file): Model
    {
        return Model::query()
            ->byRelated($this->data['related_table'], $this->data['related_id'])
            ->byId(intval($file['id']))
            ->firstOrFail();
    }
}

```

`app/Domains/File/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\File\Model\File as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\File\Model\File
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\File\Model\File
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('file.error.not-found')));
    }
}

```

`app/Domains/File/Controller/View.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Controller;

use Symfony\Component\HttpFoundation\BinaryFileResponse;

class View extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Symfony\Component\HttpFoundation\BinaryFileResponse
     */
    public function __invoke(int $id): BinaryFileResponse
    {
        $this->row($id);

        if ($this->row->fileExists() === false) {
            abort(404);
        }

        return response()->file($this->row->filePath());
    }
}

```

`app/Domains/File/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth']], static function () {
    Route::get('/file/{id}/{name}', View::class)->name('file.view');
});

```

`app/Domains/File/Model/Builder/File.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class File extends BuilderAbstract
{
    /**
     * @param string $related_table
     * @param int $related_id
     *
     * @return self
     */
    public function byRelated(string $related_table, int $related_id): self
    {
        return $this->byRelatedTable($related_table)->byRelatedId($related_id);
    }

    /**
     * @param int $related_id
     *
     * @return self
     */
    public function byRelatedId(int $related_id): self
    {
        return $this->where('related_id', $related_id);
    }

    /**
     * @param string $related_table
     *
     * @return self
     */
    public function byRelatedTable(string $related_table): self
    {
        return $this->where('related_table', $related_table);
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderBy('id', 'ASC');
    }
}

```

`app/Domains/File/Model/Collection/File.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class File extends CollectionAbstract
{
}

```

`app/Domains/File/Model/File.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Model;

use Illuminate\Filesystem\FilesystemAdapter;
use Illuminate\Support\Facades\Storage;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\File\Model\Builder\File as Builder;
use App\Domains\File\Model\Collection\File as Collection;

class File extends ModelAbstract
{
    /**
     * @var string
     */
    protected $table = 'file';

    /**
     * @const string
     */
    public const TABLE = 'file';

    /**
     * @const string
     */
    public const FOREIGN = 'file_id';

    /**
     * @param array $models
     *
     * @return \App\Domains\File\Model\Collection\File
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\File\Model\Builder\File
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return bool
     */
    public function fileExists(): bool
    {
        return static::storage()->exists($this->path);
    }

    /**
     * @return string
     */
    public function filePath(): string
    {
        return static::storage()->path($this->path);
    }

    /**
     * @return string
     */
    public function fileContentsGet(): string
    {
        return static::storage()->get($this->path);
    }

    /**
     * @param string $path
     * @param string $contents
     *
     * @return void
     */
    public static function fileContentsSet(string $path, string $contents): void
    {
        static::storage()->put($path, $contents);
    }

    /**
     * @return void
     */
    public function fileDelete(): void
    {
        static::storage()->delete($this->path);
    }

    /**
     * @return \Illuminate\Filesystem\FilesystemAdapter
     */
    protected static function storage(): FilesystemAdapter
    {
        return Storage::disk('private');
    }
}

```

`app/Domains/File/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'file' => ['bail', 'required', 'file', 'mimes:jpg,jpeg,png,pdf,doc,docx'],
            'related_table' => ['bail', 'required', 'string'],
            'related_id' => ['bail', 'required', 'integer'],
            'user_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/File/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Update extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'file' => ['bail', 'required', 'file'],
        ];
    }
}

```

`app/Domains/File/Validate/Upload.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Upload extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'files' => ['bail', 'nullable', 'array'],
            'files.*.id' => ['bail', 'integer', 'nullable'],
            'files.*.file' => ['bail', 'file', 'mimes:jpg,jpeg,png,pdf,doc,docx'],
            'files.*.delete' => ['bail', 'boolean'],
            'related_table' => ['bail', 'required', 'string'],
            'related_id' => ['bail', 'required', 'integer'],
            'user_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/File/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\File\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Help/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Help\Command;

use App\Domains\CoreApp\Command\CommandAbstract as CommandAbstractSahred;

abstract class CommandAbstract extends CommandAbstractSahred
{
}

```

`app/Domains/Help/Command/Show.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Help\Command;

use App\Domains\Help\ControllerApi\Service\Detail as DetailService;
use App\Domains\Help\ControllerApi\Service\Index as IndexService;

class Show extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'help:show {name?}';

    /**
     * @var string
     */
    protected $description = 'Show Base Help';

    /**
     * @return void
     */
    public function handle(): void
    {
        if ($name = $this->argument('name')) {
            $service = DetailService::new($name);
        } else {
            $service = IndexService::new();
        }

        $this->info(helper()->jsonEncode($service->data()));
    }
}

```

`app/Domains/Help/ControllerApi/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Help\ControllerApi;

use App\Domains\CoreApp\Controller\ControllerApiAbstract as CoreControllerApiAbstract;

abstract class ControllerApiAbstract extends CoreControllerApiAbstract
{
}

```

`app/Domains/Help/ControllerApi/Detail.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Help\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Help\ControllerApi\Service\Detail as ControllerService;

class Detail extends ControllerApiAbstract
{
    /**
     * @param string $name
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(string $name): JsonResponse
    {
        return $this->json(ControllerService::new($name)->data());
    }
}

```

`app/Domains/Help/ControllerApi/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Help\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Help\ControllerApi\Service\Index as ControllerService;

class Index extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json(ControllerService::new()->data());
    }
}

```

`app/Domains/Help/ControllerApi/Service/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Help\ControllerApi\Service;

use App\Domains\CoreApp\ControllerApi\Service\ControllerApiAbstract as CoreAppControllerApiAbstract;

abstract class ControllerApiAbstract extends CoreAppControllerApiAbstract
{
}

```

`app/Domains/Help/ControllerApi/Service/Detail.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Help\ControllerApi\Service;

use Illuminate\Routing\Route;
use Illuminate\Routing\Router;

class Detail extends ControllerApiAbstract
{
    /**
     * @var \Illuminate\Routing\Route
     */
    protected Route $route;

    /**
     * @var string
     */
    protected string $domain;

    /**
     * @var string
     */
    protected string $controller;

    /**
     * @param string $name
     *
     * @return self
     */
    public function __construct(protected string $name)
    {
        $this->route();
        $this->domain();
        $this->controller();
    }

    /**
     * @return void
     */
    protected function route(): void
    {
        foreach (app(Router::class)->getRoutes()->getRoutes() as $route) {
            if ($route->getName() === $this->name) {
                $this->route = $route;
                break;
            }
        }

        if (empty($this->route)) {
            abort(404);
        }
    }

    /**
     * @return void
     */
    protected function domain(): void
    {
        $this->domain = explode('\\', $this->route->getControllerClass())[2];
    }

    /**
     * @return void
     */
    protected function controller(): void
    {
        $this->controller = explode('\\', $this->route->getControllerClass())[4];
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->detail();
    }

    /**
     * @return array
     */
    protected function detail(): array
    {
        return array_filter([
            'name' => $this->route->getName(),
            'method' => implode('|', $this->route->methods()),
            'path' => $this->route->uri(),
            'filters' => $this->filters(),
            'validation' => $this->validation(),
        ]);
    }

    /**
     * @return ?array
     */
    protected function filters(): ?array
    {
        if (in_array('GET', $this->route->methods()) === false) {
            return null;
        }

        $contents = $this->fileContents('Service/ControllerApi');

        if (empty($contents)) {
            return null;
        }

        preg_match_all('/this\->request[^\(]+\(\'([^\']+)\'/', $contents, $matches);

        return $matches[1];
    }

    /**
     * @return ?array
     */
    protected function validation(): ?array
    {
        $methods = $this->route->methods();

        if ((in_array('POST', $methods) === false) && (in_array('PATCH', $methods) === false)) {
            return null;
        }

        $class = $this->class('Validate');

        if (empty($class)) {
            return null;
        }

        return (new $class(null, []))->rules();
    }

    /**
     * @param string $path
     *
     * @return ?string
     */
    protected function class(string $path): ?string
    {
        $class = '\\App\\Domains\\'.$this->domain.'\\'.$path.'\\'.$this->controller;

        return class_exists($class) ? $class : null;
    }

    /**
     * @param string $path
     *
     * @return ?string
     */
    protected function file(string $path): ?string
    {
        $file = base_path('app/Domains/'.$this->domain.'/'.$path.'/'.$this->controller.'.php');

        return is_file($file) ? $file : null;
    }

    /**
     * @param string $path
     *
     * @return ?string
     */
    protected function fileContents(string $path): ?string
    {
        $file = $this->file($path);

        return $file ? file_get_contents($file) : null;
    }
}

```

`app/Domains/Help/ControllerApi/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Help\ControllerApi\Service;

use Illuminate\Routing\Route;
use Illuminate\Routing\Router;

class Index extends ControllerApiAbstract
{
    /**
     * @return array
     */
    public function data(): array
    {
        return $this->routes();
    }

    /**
     * @return array
     */
    protected function routes(): array
    {
        return array_values(array_filter(array_map(
            $this->route(...),
            app(Router::class)->getRoutes()->getRoutes(),
        )));
    }

    /**
     * @param \Illuminate\Routing\Route $route
     *
     * @return ?array
     */
    protected function route(Route $route): ?array
    {
        if (str_starts_with($route->getName(), 'api.') === false) {
            return null;
        }

        return [
            'name' => $route->getName(),
            'method' => implode('|', $route->methods()),
            'path' => $route->uri(),
        ];
    }
}

```

`app/Domains/Help/ControllerApi/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Help\ControllerApi;

use Illuminate\Support\Facades\Route;

Route::get('/help', Index::class)->name('help.index');
Route::get('/help/{name}', Detail::class)->name('help.detail');

```

`app/Domains/IpLock/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\IpLock\Model\IpLock as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\IpLock\Model\IpLock
     */
    protected ?Model $row;
}

```

`app/Domains/IpLock/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\IpLock\Model\IpLock as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\IpLock\Model\IpLock
     */
    protected ?Model $row;

    /**
     * @return void
     */
    public function check(): void
    {
        $this->actionHandle(Check::class, $this->validate()->check());
    }

    /**
     * @return \App\Domains\IpLock\Model\IpLock
     */
    public function create(): Model
    {
        return $this->actionHandle(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandle(Delete::class);
    }

    /**
     * @return ?\App\Domains\IpLock\Model\IpLock
     */
    public function lock(): ?Model
    {
        return $this->actionHandle(Lock::class, $this->validate()->lock());
    }

    /**
     * @return \App\Domains\IpLock\Model\IpLock
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\IpLock\Model\IpLock
     */
    public function updateEndAt(): Model
    {
        return $this->actionHandle(UpdateEndAt::class);
    }
}

```

`app/Domains/IpLock/Action/Check.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Action;

use App\Domains\IpLock\Exception\IpLocked as IpLockedException;
use App\Domains\IpLock\Model\IpLock as Model;

class Check extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->data();
        $this->check();
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataIp();
    }

    /**
     * @return void
     */
    protected function dataIp(): void
    {
        $this->data['ip'] ??= $this->request->ip();
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        if (($this->isWhiteList() === false) && $this->exists()) {
            throw new IpLockedException(__('ip-lock.error.locked'));
        }
    }

    /**
     * @return bool
     */
    protected function isWhiteList(): bool
    {
        return ($whitelist = config('auth.lock.whitelist'))
            && in_array($this->data['ip'], $whitelist);
    }

    /**
     * @return bool
     */
    protected function exists(): bool
    {
        return Model::query()
            ->byIp($this->data['ip'])
            ->current()
            ->exists();
    }
}

```

`app/Domains/IpLock/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Action;

use App\Domains\IpLock\Model\IpLock as Model;

class Create extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'ip' => $this->data['ip'],
            'end_at' => $this->data['end_at'],
        ])->fresh();
    }
}

```

`app/Domains/IpLock/Action/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Action;

use App\Domains\IpLock\Model\IpLock as Model;

abstract class CreateUpdateAbstract extends ActionAbstract
{
    /**
     * @return void
     */
    abstract protected function save(): void;

    /**
     * @return \App\Domains\IpLock\Model\IpLock
     */
    public function handle(): Model
    {
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkIp();
    }

    /**
     * @return void
     */
    protected function checkIp(): void
    {
        $this->checkIpSame();
        $this->checkIpExists();
    }

    /**
     * @return void
     */
    protected function checkIpSame(): void
    {
        if ($this->data['ip'] === $this->request->ip()) {
            $this->exceptionValidator(__('ip-lock-create.error.same'));
        }
    }

    /**
     * @return void
     */
    protected function checkIpExists(): void
    {
        if ($this->checkIpExistsResult()) {
            $this->exceptionValidator(__('ip-lock-create.error.exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkIpExistsResult(): bool
    {
        return Model::query()
            ->byIdNot($this->row->id ?? 0)
            ->byIp($this->data['ip'])
            ->exists();
    }
}

```

`app/Domains/IpLock/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->delete();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }
}

```

`app/Domains/IpLock/Action/Lock.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Action;

use App\Domains\IpLock\Model\IpLock as Model;

class Lock extends ActionAbstract
{
    /**
     * @return ?\App\Domains\IpLock\Model\IpLock
     */
    public function handle(): ?Model
    {
        $this->data();

        if ($this->isWhiteList()) {
            return null;
        }

        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataEndAt();
    }

    /**
     * @return void
     */
    protected function dataEndAt(): void
    {
        $this->data['end_at'] = date(
            'Y-m-d H:i:s',
            strtotime('+'.(int)config('auth.lock.check').' seconds')
        );
    }

    /**
     * @return bool
     */
    protected function isWhiteList(): bool
    {
        return ($whitelist = config('auth.lock.whitelist'))
            && in_array($this->data['ip'], $whitelist);
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->current()->updateOrCreate(
            ['ip' => $this->data['ip']],
            ['end_at' => $this->data['end_at']],
        );
    }
}

```

`app/Domains/IpLock/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Action;

class Update extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->ip = $this->data['ip'];
        $this->row->end_at = $this->data['end_at'];
        $this->row->save();
    }
}

```

`app/Domains/IpLock/Action/UpdateEndAt.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Action;

use App\Domains\IpLock\Model\IpLock as Model;

class UpdateEndAt extends ActionAbstract
{
    /**
     * @return \App\Domains\IpLock\Model\IpLock
     */
    public function handle(): Model
    {
        $this->data();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataEndAt();
    }

    /**
     * @return void
     */
    protected function dataEndAt(): void
    {
        if ($this->row->end_at) {
            $this->data['end_at'] = min(date('Y-m-d H:i:s'), $this->row->end_at);
        } else {
            $this->data['end_at'] = date('Y-m-d H:i:s');
        }
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->end_at = $this->data['end_at'];
        $this->row->save();
    }
}

```

`app/Domains/IpLock/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\IpLock\Model\IpLock as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\IpLock\Model\IpLock
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\IpLock\Model\IpLock
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->firstOr(fn () => $this->exceptionNotFound(__('ip-lock.error.not-found')));
    }
}

```

`app/Domains/IpLock/Controller/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;

class Create extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($response = $this->actionPost('create')) {
            return $response;
        }

        $this->meta('title', __('ip-lock-create.meta-title'));

        return $this->page('ip-lock.create');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function create(): RedirectResponse
    {
        $this->row = $this->action()->create();

        $this->sessionMessage('success', __('ip-lock-create.success'));

        return redirect()->route('ip-lock.update', $this->row->id);
    }
}

```

`app/Domains/IpLock/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Controller;

use Illuminate\Http\Response;
use App\Domains\IpLock\Model\Collection\IpLock as Collection;
use App\Domains\IpLock\Model\IpLock as Model;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('ip-lock-index.meta-title'));

        return $this->page('ip-lock.index', [
            'list' => $this->list(),
        ]);
    }

    /**
     * @return \App\Domains\IpLock\Model\Collection\IpLock
     */
    protected function list(): Collection
    {
        return Model::query()
            ->list()
            ->get();
    }
}

```

`app/Domains/IpLock/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actions()) {
            return $response;
        }

        $this->requestMergeWithRow();

        $this->meta('title', __('ip-lock-update.meta-title', ['title' => $this->row->ip]));

        return $this->page('ip-lock.update', [
            'row' => $this->row,
        ]);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('update')
            ?: $this->actionPost('delete');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('ip-lock-update.success'));

        return redirect()->route('ip-lock.update', $this->row->id);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function delete(): RedirectResponse
    {
        $this->action()->delete();

        $this->sessionMessage('success', __('ip-lock-update.delete-success'));

        return redirect()->route('ip-lock.index');
    }
}

```

`app/Domains/IpLock/Controller/UpdateEndAt.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Controller;

use Illuminate\Http\RedirectResponse;

class UpdateEndAt extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): RedirectResponse
    {
        $this->row($id);

        $this->actionCall('updateEndAt');

        return redirect()->back();
    }

    /**
     * @return void
     */
    protected function updateEndAt(): void
    {
        $this->factory()->action()->updateEndAt();
    }
}

```

`app/Domains/IpLock/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth-admin-mode']], static function () {
    Route::get('/ip-lock', Index::class)->name('ip-lock.index');
    Route::any('/ip-lock/create', Create::class)->name('ip-lock.create');
    Route::any('/ip-lock/{id}', Update::class)->name('ip-lock.update');
    Route::any('/ip-lock/{id}/end-at', UpdateEndAt::class)->name('ip-lock.update.end_at');
});

```

`app/Domains/IpLock/Exception/ExceptionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Exception;

use App\Exceptions\GenericException;

abstract class ExceptionAbstract extends GenericException
{
}

```

`app/Domains/IpLock/Exception/IpLocked.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Exception;

class IpLocked extends ExceptionAbstract
{
    /**
     * @var int
     */
    protected $code = 401;

    /**
     * @var ?string
     */
    protected ?string $status = 'ip-locked';
}

```

`app/Domains/IpLock/Middleware/Check.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Middleware;

use Closure;
use Illuminate\Http\Request;

class Check extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        $this->factory()->action($this->actionData($request))->check();

        return $next($request);
    }

    /**
     * @param \Illuminate\Http\Request $request
     *
     * @return array
     */
    protected function actionData(Request $request): array
    {
        return [
            'ip' => $request->ip(),
        ];
    }
}

```

`app/Domains/IpLock/Middleware/MiddlewareAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Middleware;

use App\Domains\Core\Middleware\MiddlewareAbstract as MiddlewareAbstractCore;
use App\Domains\IpLock\Model\IpLock as Model;

abstract class MiddlewareAbstract extends MiddlewareAbstractCore
{
    /**
     * @var ?\App\Domains\IpLock\Model\IpLock
     */
    protected ?Model $row;
}

```

`app/Domains/IpLock/Model/Builder/IpLock.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class IpLock extends BuilderAbstract
{
    /**
     * @param string $ip
     *
     * @return self
     */
    public function byIp(string $ip): self
    {
        return $this->where('ip', $ip);
    }

    /**
     * @return self
     */
    public function current(): self
    {
        return $this->where(fn ($q) => $q->where('end_at', '>=', date('Y-m-d H:i:s'))->orWhereNull('end_at'));
    }
}

```

`app/Domains/IpLock/Model/Collection/IpLock.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class IpLock extends CollectionAbstract
{
}

```

`app/Domains/IpLock/Model/IpLock.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\IpLock\Model\Builder\IpLock as Builder;
use App\Domains\IpLock\Model\Collection\IpLock as Collection;
use App\Domains\IpLock\Test\Factory\IpLock as TestFactory;

class IpLock extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'ip_lock';

    /**
     * @const string
     */
    public const TABLE = 'ip_lock';

    /**
     * @const string
     */
    public const FOREIGN = 'ip_lock_id';

    /**
     * @param array $models
     *
     * @return \App\Domains\IpLock\Model\Collection\IpLock
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\IpLock\Model\Builder\IpLock
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\IpLock\Test\Factory\IpLock
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return string
     */
    public function time(): string
    {
        if (empty($this->end_at)) {
            return '-';
        }

        return helper()->timeHuman(strtotime($this->end_at) - strtotime($this->created_at));
    }

    /**
     * @return bool
     */
    public function finished(): bool
    {
        return $this->end_at
            && ($this->end_at <= date('Y-m-d H:i:s'));
    }
}

```

`app/Domains/IpLock/Validate/Check.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Check extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'ip' => ['bail', 'nullable'],
        ];
    }
}

```

`app/Domains/IpLock/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'ip' => ['bail', 'ip', 'required'],
            'end_at' => ['bail', 'date_format:Y-m-d H:i:s', 'nullable'],
        ];
    }
}

```

`app/Domains/IpLock/Validate/Lock.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Lock extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'ip' => ['bail', 'required', 'ip'],
        ];
    }
}

```

`app/Domains/IpLock/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Validate;

class Update extends Create
{
}

```

`app/Domains/IpLock/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\IpLock\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Language/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\Language\Model\Language as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Language\Model\Language
     */
    protected ?Model $row;
}

```

`app/Domains/Language/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Language\Model\Language as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Language\Model\Language
     */
    protected ?Model $row;

    /**
     * @return void
     */
    public function request(): void
    {
        $this->actionHandle(Request::class);
    }

    /**
     * @return void
     */
    public function set(): void
    {
        $this->actionHandle(Set::class);
    }
}

```

`app/Domains/Language/Action/Request.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\Action;

use App\Domains\Language\Model\Language as Model;

class Request extends ActionAbstract
{
    /**
     * @var string
     */
    protected string $acceptLanguage;

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->acceptLanguage();
        $this->row();
        $this->set();
    }

    /**
     * @return void
     */
    protected function acceptLanguage(): void
    {
        $this->acceptLanguage = strval($this->request->header('Accept-Language'));
    }

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = $this->rowSession()
            ?: $this->rowLocale()
            ?: $this->rowCode()
            ?: $this->rowDefault()
            ?: $this->rowFirst();
    }

    /**
     * @return ?\App\Domains\Language\Model\Language
     */
    protected function rowSession(): ?Model
    {
        if (empty($this->request)) {
            return null;
        }

        if ($this->request->hasSession() === false) {
            return null;
        }

        if (empty($id = $this->request->session()->get('language_id'))) {
            return null;
        }

        return Model::query()->byId($id)->first();
    }

    /**
     * @return ?\App\Domains\Language\Model\Language
     */
    protected function rowLocale(): ?Model
    {
        if (empty($locale = $this->rowLocaleValue())) {
            return null;
        }

        return Model::query()
            ->selectSession()
            ->byLocale($locale)
            ->first();
    }

    /**
     * @return ?string
     */
    protected function rowLocaleValue(): ?string
    {
        return preg_match('/^[a-z]+\-[A-Z]+/', $this->acceptLanguage, $matches)
            ? str_replace('-', '_', $matches[0])
            : null;
    }

    /**
     * @return ?\App\Domains\Language\Model\Language
     */
    protected function rowCode(): ?Model
    {
        return Model::query()
            ->selectSession()
            ->byLocaleCode($this->rowCodeValue())
            ->first();
    }

    /**
     * @return string
     */
    protected function rowCodeValue(): string
    {
        return preg_match('/^[a-zA-Z]+/', $this->acceptLanguage, $matches)
            ? $matches[0]
            : explode('_', config('app.locale'))[0];
    }

    /**
     * @return ?\App\Domains\Language\Model\Language
     */
    protected function rowDefault(): ?Model
    {
        return Model::query()
            ->selectSession()
            ->whereDefault()
            ->first();
    }

    /**
     * @return \App\Domains\Language\Model\Language
     */
    protected function rowFirst(): Model
    {
        return Model::query()
            ->selectSession()
            ->orderByFirst()
            ->first();
    }

    /**
     * @return void
     */
    protected function set(): void
    {
        $this->factory()->action()->set();
    }
}

```

`app/Domains/Language/Action/Set.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\Action;

use App\Domains\Language\Model\Language as Model;

class Set extends ActionAbstract
{
    /**
     * @var string
     */
    protected string $locale;

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->locale();

        if ($this->available() === false) {
            return;
        }

        if ($this->defined()) {
            return;
        }

        $this->row();
        $this->set();
    }

    /**
     * @return void
     */
    protected function locale(): void
    {
        $this->locale = config('app.locale');

        if (str_contains($this->locale, '_')) {
            return;
        }

        $this->locale = match ($this->locale) {
            'en' => 'en_US',
            'pt' => 'pt_BR',
            'he' => 'he_IL',
            'ar' => 'ar_AE',
            default => $this->locale.'_'.strtoupper($this->locale),
        };

        trigger_error(sprintf('Please, configure APP_LOCALE as "%s"', $this->locale), E_USER_DEPRECATED);

        config(['app.locale' => $this->locale]);
    }

    /**
     * @return bool
     */
    protected function available(): bool
    {
        return app('configuration')->available();
    }

    /**
     * @return bool
     */
    protected function defined(): bool
    {
        if (app()->bound('language') === false) {
            return false;
        }

        if ($this->row && ($this->row->locale !== app('language')->locale)) {
            return false;
        }

        return $this->locale === app('language')->locale;
    }

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row ??= $this->rowDefault()
            ?: $this->rowFirst();
    }

    /**
     * @return ?\App\Domains\Language\Model\Language
     */
    protected function rowDefault(): ?Model
    {
        return Model::query()
            ->selectSession()
            ->byLocale($this->locale)
            ->first();
    }

    /**
     * @return ?\App\Domains\Language\Model\Language
     */
    protected function rowFirst(): ?Model
    {
        return Model::query()
            ->selectSession()
            ->orderByFirst()
            ->first();
    }

    /**
     * @return void
     */
    protected function set(): void
    {
        if (empty($this->row)) {
            return;
        }

        $this->setSystem();
        $this->setConfig();
        $this->setLocale();
        $this->setBind();
        $this->setSession();
    }

    /**
     * @return void
     */
    protected function setSystem(): void
    {
        setlocale(LC_COLLATE, $this->row->locale);
        setlocale(LC_CTYPE, $this->row->locale);
        setlocale(LC_MONETARY, $this->row->locale);
        setlocale(LC_TIME, $this->row->locale);

        if (defined('LC_MESSAGES')) {
            setlocale(LC_MESSAGES, $this->row->locale);
        }
    }

    /**
     * @return void
     */
    protected function setConfig(): void
    {
        config(['app.locale' => $this->row->locale]);
    }

    /**
     * @return void
     */
    protected function setLocale(): void
    {
        app()->setLocale($this->row->locale);
    }

    /**
     * @return void
     */
    protected function setBind(): void
    {
        app()->bind('language', fn () => $this->row);
    }

    /**
     * @return void
     */
    protected function setSession(): void
    {
        if ($this->request?->hasSession()) {
            $this->request->session()->put('language_id', $this->row->id);
        }
    }
}

```

`app/Domains/Language/ControllerApi/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\ControllerApi;

use App\Domains\CoreApp\Controller\ControllerApiAbstract as CoreAppControllerApiAbstract;

abstract class ControllerApiAbstract extends CoreAppControllerApiAbstract
{
}

```

`app/Domains/Language/ControllerApi/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Language\Model\Language as Model;

class Index extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('json', Model::query()->list()->get()));
    }
}

```

`app/Domains/Language/ControllerApi/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\ControllerApi;

use Illuminate\Support\Facades\Route;

Route::get('/language', Index::class)->name('language.index');

```

`app/Domains/Language/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\Language\Model\Language as Model;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\Language\Model\Language $row
     *
     * @return array
     */
    protected function json(Model $row): array
    {
        return [
            'id' => $row->id,
            'locale' => $row->locale,
            'name' => $row->name,
            'rtl' => $row->rtl,
        ];
    }

    /**
     * @param \App\Domains\Language\Model\Language $row
     *
     * @return array
     */
    protected function related(Model $row): array
    {
        return [
            'id' => $row->id,
            'locale' => $row->locale,
            'name' => $row->name,
            'rtl' => $row->rtl,
        ];
    }
}

```

`app/Domains/Language/Middleware/Request.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\Middleware;

use Closure;
use Illuminate\Http\Request as RequestVendor;
use App\Domains\Core\Middleware\MiddlewareAbstract;

class Request extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(RequestVendor $request, Closure $next): mixed
    {
        $this->factory()->action()->request();

        return $next($request);
    }
}

```

`app/Domains/Language/Model/Builder/Language.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class Language extends BuilderAbstract
{
    /**
     * @param string $locale
     *
     * @return self
     */
    public function byLocale(string $locale): self
    {
        return $this->where('locale', $locale);
    }

    /**
     * @param string $code
     *
     * @return self
     */
    public function byLocaleCode(string $code): self
    {
        return $this->whereLike('locale', $code.'%');
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderByRaw('IF (`locale` = ?, TRUE, FALSE) DESC', config('app.locale'))
            ->orderBy('name', 'ASC');
    }

    /**
     * @return self
     */
    public function selectSession(): self
    {
        return $this->select('id', 'name', 'locale');
    }

    /**
     * @param ?int $id
     *
     * @return self
     */
    public function whenIdOrDefault(?int $id): self
    {
        return $this->when($id, fn ($q) => $q->byId($id), fn ($q) => $q->whereDefault());
    }

    /**
     * @return self
     */
    public function whereDefault(): self
    {
        return $this->where($this->addTable('locale'), config('app.locale'));
    }
}

```

`app/Domains/Language/Model/Collection/Language.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Language extends CollectionAbstract
{
}

```

`app/Domains/Language/Model/Language.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\Language\Model\Builder\Language as Builder;
use App\Domains\Language\Model\Collection\Language as Collection;
use App\Domains\Language\Test\Factory\Language as TestFactory;

class Language extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'language';

    /**
     * @const string
     */
    public const TABLE = 'language';

    /**
     * @const string
     */
    public const FOREIGN = 'language_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'enabled' => 'boolean',
        'rtl' => 'boolean',
    ];

    /**
     * @return void
     */
    protected static function booted(): void
    {
        static::addGlobalScope('enabled', static fn (Builder $q) => $q->where(static::TABLE.'.enabled', true));
    }

    /**
     * @param array $models
     *
     * @return \App\Domains\Language\Model\Collection\Language
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Language\Model\Builder\Language
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Language\Test\Factory\Language
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }
}

```

`app/Domains/Language/Seeder/Language.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Language\Seeder;

use App\Domains\Core\Seeder\SeederAbstract;
use App\Domains\Language\Model\Language as Model;

class Language extends SeederAbstract
{
    /**
     * @return void
     */
    public function run(): void
    {
        $this->insertWithoutDuplicates(Model::class, 'locale', $this->json('language'));
    }
}

```

`app/Domains/Maintenance/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\Maintenance\Model\Maintenance as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Maintenance\Model\Maintenance
     */
    protected ?Model $row;
}

```

`app/Domains/Maintenance/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Maintenance\Model\Maintenance as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Maintenance\Model\Maintenance
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\Maintenance\Model\Maintenance
     */
    public function create(): Model
    {
        return $this->actionHandleTransaction(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandleTransaction(Delete::class);
    }

    /**
     * @return \App\Domains\Maintenance\Model\Maintenance
     */
    public function update(): Model
    {
        return $this->actionHandleTransaction(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\Maintenance\Model\Maintenance
     */
    public function updateItem(): Model
    {
        return $this->actionHandleTransaction(UpdateItem::class, $this->validate()->updateItem());
    }
}

```

`app/Domains/Maintenance/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Action;

use App\Domains\Maintenance\Model\Maintenance as Model;

class Create extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'date_at' => $this->data['date_at'],
            'name' => $this->data['name'],
            'workshop' => $this->data['workshop'],
            'amount' => $this->data['amount'],
            'distance' => $this->data['distance'],
            'distance_next' => $this->data['distance_next'],
            'description' => $this->data['description'],
            'user_id' => $this->data['user_id'],
            'vehicle_id' => $this->data['vehicle_id'],
        ]);
    }
}

```

`app/Domains/Maintenance/Action/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Action;

use App\Domains\Maintenance\Model\Maintenance as Model;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

abstract class CreateUpdateAbstract extends ActionAbstract
{
    /**
     * @return void
     */
    abstract protected function save(): void;

    /**
     * @return \App\Domains\Maintenance\Model\Maintenance
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->save();
        $this->files();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataUserId();
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkVehicle();
    }

    /**
     * @return void
     */
    protected function checkVehicle(): void
    {
        if ($this->checkVehicleExists() === false) {
            $this->exceptionValidator(__('maintenance-create.error.vehicle-not-found'));
        }
    }

    /**
     * @return bool
     */
    protected function checkVehicleExists(): bool
    {
        return VehicleModel::query()
            ->select('id')
            ->byId($this->data['vehicle_id'])
            ->byUserId($this->data['user_id'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function files(): void
    {
        $this->factory('File')->action($this->filesData())->upload();
    }

    /**
     * @return array
     */
    protected function filesData(): array
    {
        return [
            'files' => $this->request->all('files')['files'],
            'related_table' => $this->row->getTable(),
            'related_id' => $this->row->id,
            'user_id' => $this->data['user_id'],
        ];
    }
}

```

`app/Domains/Maintenance/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->delete();
        $this->files();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }

    /**
     * @return void
     */
    protected function files(): void
    {
        foreach ($this->row->files as $file) {
            $this->factory('File', $file)->action()->delete();
        }
    }
}

```

`app/Domains/Maintenance/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Action;

class Update extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->date_at = $this->data['date_at'];
        $this->row->name = $this->data['name'];
        $this->row->workshop = $this->data['workshop'];
        $this->row->amount = $this->data['amount'];
        $this->row->distance = $this->data['distance'];
        $this->row->distance_next = $this->data['distance_next'];
        $this->row->description = $this->data['description'];
        $this->row->vehicle_id = $this->data['vehicle_id'];

        $this->row->save();
    }
}

```

`app/Domains/Maintenance/Action/UpdateItem.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Action;

use App\Domains\Maintenance\Model\Maintenance as Model;
use App\Domains\Maintenance\Model\MaintenanceMaintenanceItem as MaintenanceMaintenanceItemModel;
use App\Domains\MaintenanceItem\Model\MaintenanceItem as MaintenanceItemModel;

class UpdateItem extends ActionAbstract
{
    /**
     * @var array
     */
    protected array $maintenanceItemIds = [];

    /**
     * @return \App\Domains\Maintenance\Model\Maintenance
     */
    public function handle(): Model
    {
        $this->data();
        $this->maintenanceItemIds();
        $this->lines();
        $this->delete();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataUserId();
    }

    /**
     * @return void
     */
    protected function maintenanceItemIds(): void
    {
        if (empty($this->data['maintenance_item_id'])) {
            return;
        }

        $this->maintenanceItemIds = MaintenanceItemModel::query()
            ->byIds($this->data['maintenance_item_id'])
            ->byUserId($this->data['user_id'])
            ->pluck('id')
            ->all();
    }

    /**
     * @return void
     */
    protected function lines(): void
    {
        $this->data['lines'] = [];

        foreach ($this->data['maintenance_item_id'] as $index => $maintenance_item_id) {
            if ($line = $this->linesIndex($index)) {
                $this->data['lines'][$maintenance_item_id] = $line;
            }
        }
    }

    /**
     * @param int $index
     *
     * @return ?array
     */
    protected function linesIndex(int $index): ?array
    {
        return $this->linesIndexIsValid($data = $this->linesIndexData($index)) ? $data : null;
    }

    /**
     * @param int $index
     *
     * @return array
     */
    protected function linesIndexData(int $index): array
    {
        $data = [
            'maintenance_item_id' => $this->data['maintenance_item_id'][$index] ?? null,
            'quantity' => $this->data['quantity'][$index] ?? 0,
            'amount_gross' => $this->data['amount_gross'][$index] ?? 0,
            'tax_percent' => $this->data['tax_percent'][$index] ?? 0,
        ];

        $data['amount_net'] = $data['amount_gross'] * (1 + $data['tax_percent'] / 100);
        $data['subtotal'] = $data['quantity'] * $data['amount_gross'];
        $data['tax_amount'] = $data['subtotal'] * $data['tax_percent'] / 100;
        $data['total'] = $data['subtotal'] + $data['tax_amount'];

        $data['amount_net'] = round($data['amount_net'], 2);
        $data['subtotal'] = round($data['subtotal'], 2);
        $data['tax_amount'] = round($data['tax_amount'], 2);
        $data['total'] = round($data['total'], 2);

        return $data;
    }

    /**
     * @param array $data
     *
     * @return bool
     */
    protected function linesIndexIsValid(array $data): bool
    {
        return in_array($data['maintenance_item_id'], $this->maintenanceItemIds)
            && $data['quantity']
            && $data['amount_gross'];
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        if (empty($this->data['lines'])) {
            return;
        }

        MaintenanceMaintenanceItemModel::query()
            ->byMaintenanceId($this->row->id)
            ->byMaintenanceItemIdsNot(array_keys($this->data['lines']))
            ->delete();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        foreach ($this->data['lines'] as $line) {
            $this->saveLine($line);
        }
    }

    /**
     * @param array $line
     *
     * @return void
     */
    protected function saveLine(array $line): void
    {
        MaintenanceMaintenanceItemModel::query()->updateOrInsert([
            'maintenance_id' => $this->row->id,
            'maintenance_item_id' => $line['maintenance_item_id'],
        ], [
            'quantity' => $line['quantity'],
            'amount_gross' => $line['amount_gross'],
            'amount_net' => $line['amount_net'],
            'tax_percent' => $line['tax_percent'],
            'tax_amount' => $line['tax_amount'],
            'subtotal' => $line['subtotal'],
            'total' => $line['total'],
        ]);
    }
}

```

`app/Domains/Maintenance/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\Maintenance\Model\Maintenance as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\Maintenance\Model\Maintenance
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Maintenance\Model\Maintenance
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('maintenance.error.not-found')));
    }
}

```

`app/Domains/Maintenance/Controller/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Maintenance\Controller\Service\Create as ControllerService;

class Create extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($response = $this->actionPost('create')) {
            return $response;
        }

        $this->meta('title', __('maintenance-create.meta-title'));

        return $this->page('maintenance.create', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function create(): RedirectResponse
    {
        $this->row = $this->action()->create();

        $this->sessionMessage('success', __('maintenance-create.success'));

        return redirect()->route('maintenance.update', $this->row->id);
    }
}

```

`app/Domains/Maintenance/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller;

use Illuminate\Http\Response;
use App\Domains\Maintenance\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('maintenance-index.meta-title'));

        return $this->page('maintenance.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Maintenance/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/Maintenance/Controller/Service/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\File\Model\Collection\File as FileCollection;

class Create extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->request();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCreateUpdate() + [
            'files' => $this->files(),
        ];
    }

    /**
     * @return \App\Domains\File\Model\Collection\File
     */
    protected function files(): FileCollection
    {
        return new FileCollection();
    }
}

```

`app/Domains/Maintenance/Controller/Service/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller\Service;

abstract class CreateUpdateAbstract extends ControllerAbstract
{
    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow([
            'user_id' => $this->user()->id,
        ]);
    }

    /**
     * @return array
     */
    protected function dataCreateUpdate(): array
    {
        return $this->dataCore() + [
            'vehicles' => $this->vehicles(),
        ];
    }
}

```

`app/Domains/Maintenance/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Maintenance\Model\Collection\Maintenance as Collection;
use App\Domains\Maintenance\Model\Maintenance as Model;

class Index extends ControllerAbstract
{
    /**
     * @var bool
     */
    protected bool $userEmpty = true;

    /**
     * @var bool
     */
    protected bool $vehicleEmpty = true;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->filters();
    }

    /**
     * @return void
     */
    protected function filters(): void
    {
        $this->filtersDates();
        $this->filterIds();
    }

    /**
     * @return void
     */
    protected function filtersDates(): void
    {
        if (preg_match('/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}$/', (string)$this->request->input('start_at')) === 0) {
            $this->request->merge(['start_at' => '']);
        }

        if (preg_match('/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}$/', (string)$this->request->input('end_at')) === 0) {
            $this->request->merge(['end_at' => '']);
        }
    }

    /**
     * @return void
     */
    protected function filterIds(): void
    {
        $this->filtersUserId();
        $this->filtersVehicleId();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCore() + [
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'vehicle_empty' => $this->vehicleEmpty(),
            'list' => $this->list(),
            'date_min' => $this->dateMin(),
            'total' => $this->list()->sum('amount'),
        ];
    }

    /**
     * @return \App\Domains\Maintenance\Model\Collection\Maintenance
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->whenSearch($this->request->input('search'))
                ->whenVehicleId((int)$this->request->input('vehicle_id'))
                ->whenDateAtBetween($this->request->input('start_at'), $this->request->input('end_at'))
                ->withSimple('user')
                ->withSimple('vehicle')
                ->list()
                ->get()
        );
    }

    /**
     * @return ?string
     */
    protected function dateMin(): ?string
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->orderByDateAtAsc()
                ->rawValue('DATE(`date_at`)')
        );
    }
}

```

`app/Domains/Maintenance/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\File\Model\Collection\File as FileCollection;
use App\Domains\File\Model\File as FileModel;
use App\Domains\Maintenance\Model\Maintenance as Model;

class Update extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Maintenance\Model\Maintenance $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCreateUpdate() + [
            'row' => $this->row,
            'files' => $this->files(),
        ];
    }

    /**
     * @return \App\Domains\File\Model\Collection\File
     */
    protected function files(): FileCollection
    {
        return FileModel::query()
            ->byRelated('maintenance', $this->row->id)
            ->list()
            ->get();
    }
}

```

`app/Domains/Maintenance/Controller/Service/UpdateItem.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Maintenance\Model\Collection\MaintenanceMaintenanceItem as MaintenanceMaintenanceItemCollection;
use App\Domains\Maintenance\Model\Maintenance as Model;
use App\Domains\Maintenance\Model\MaintenanceMaintenanceItem as MaintenanceMaintenanceItemModel;
use App\Domains\MaintenanceItem\Model\Collection\MaintenanceItem as MaintenanceItemCollection;
use App\Domains\MaintenanceItem\Model\MaintenanceItem as MaintenanceItemModel;

class UpdateItem extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Maintenance\Model\Maintenance $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'items' => $this->items(),
            'itemsPivot' => $this->itemsPivot(),
            'total' => $this->total(),
        ];
    }

    /**
     * @return \App\Domains\MaintenanceItem\Model\Collection\MaintenanceItem
     */
    protected function items(): MaintenanceItemCollection
    {
        return MaintenanceItemModel::query()
            ->byUserId($this->user()->id)
            ->list()
            ->get()
            ->merge($this->itemsMerge());
    }

    /**
     * @return \App\Domains\MaintenanceItem\Model\Collection\MaintenanceItem
     */
    protected function itemsMerge(): MaintenanceItemCollection
    {
        return new MaintenanceItemCollection([
            new MaintenanceItemModel([
                'id' => 0,
                'name' => __('maintenance-update-item.add'),
            ]),
        ]);
    }

    /**
     * @return \App\Domains\Maintenance\Model\Collection\MaintenanceMaintenanceItem
     */
    protected function itemsPivot(): MaintenanceMaintenanceItemCollection
    {
        return $this->cache(
            fn () => MaintenanceMaintenanceItemModel::query()
                ->byMaintenanceId($this->row->id)
                ->list()
                ->get()
        );
    }

    /**
     * @return array
     */
    protected function total(): array
    {
        $itemsPivot = $this->itemsPivot();

        return [
            'quantity' => $itemsPivot->sum('quantity'),
            'amount_gross' => $itemsPivot->sum('amount_gross'),
            'amount_net' => $itemsPivot->sum('amount_net'),
            'subtotal' => $itemsPivot->sum('subtotal'),
            'tax_amount' => $itemsPivot->sum('tax_amount'),
            'total' => $itemsPivot->sum('total'),
        ];
    }
}

```

`app/Domains/Maintenance/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Maintenance\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actions()) {
            return $response;
        }

        $this->meta('title', __('maintenance-update.meta-title', ['title' => $this->row->name]));

        return $this->page('maintenance.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('update')
            ?: $this->actionPost('delete');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('maintenance-update.success'));

        return redirect()->route('maintenance.update', $this->row->id);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function delete(): RedirectResponse
    {
        $this->action()->delete();

        $this->sessionMessage('success', __('maintenance-update.delete-success'));

        return redirect()->route('maintenance.index');
    }
}

```

`app/Domains/Maintenance/Controller/UpdateItem.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Maintenance\Controller\Service\UpdateItem as ControllerService;

class UpdateItem extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse|\Illuminate\Http\JsonResponse
     */
    public function __invoke(int $id): Response|RedirectResponse|JsonResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('updateItem')) {
            return $response;
        }

        $this->requestMergeWithRow();

        $this->meta('title', __('maintenance-update-item.meta-title', ['title' => $this->row->name]));

        return $this->page('maintenance.update-item', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateItem(): RedirectResponse
    {
        $this->action()->updateItem();

        $this->sessionMessage('success', __('maintenance-update-item.success'));

        return redirect()->route('maintenance.update.item', $this->row->id);
    }
}

```

`app/Domains/Maintenance/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth', 'vehicle.available']], static function () {
    Route::get('/maintenance', Index::class)->name('maintenance.index');
    Route::any('/maintenance/create', Create::class)->name('maintenance.create');
    Route::any('/maintenance/{id}', Update::class)->name('maintenance.update');
    Route::any('/maintenance/{id}/item', UpdateItem::class)->name('maintenance.update.item');
});

```

`app/Domains/Maintenance/Model/Builder/Maintenance.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class Maintenance extends BuilderAbstract
{
    /**
     * @param string $date_at
     *
     * @return self
     */
    public function byDateAtAfter(string $date_at): self
    {
        return $this->whereDate('date_at', '>=', $date_at);
    }

    /**
     * @param string $date_at
     *
     * @return self
     */
    public function byDateAtBefore(string $date_at): self
    {
        return $this->whereDate('date_at', '<=', $date_at);
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderByDateAtDesc();
    }

    /**
     * @return self
     */
    public function orderByDateAtDesc(): self
    {
        return $this->orderBy('date_at', 'DESC');
    }

    /**
     * @return self
     */
    public function orderByDateAtAsc(): self
    {
        return $this->orderBy('date_at', 'ASC');
    }

    /**
     * @param ?string $before_date_at
     * @param ?string $after_date_at
     *
     * @return self
     */
    public function whenDateAtBetween(?string $before_date_at, ?string $after_date_at): self
    {
        return $this->whenDateAtBefore($after_date_at)->whenDateAtAfter($before_date_at);
    }

    /**
     * @param ?string $date_at
     *
     * @return self
     */
    public function whenDateAtAfter(?string $date_at): self
    {
        return $this->when($date_at, fn ($q) => $q->byDateAtAfter($date_at));
    }

    /**
     * @param ?string $date_at
     *
     * @return self
     */
    public function whenDateAtBefore(?string $date_at): self
    {
        return $this->when($date_at, fn ($q) => $q->byDateAtBefore($date_at));
    }

    /**
     * @param ?string $search
     *
     * @return self
     */
    public function whenSearch(?string $search): self
    {
        return $this->when($search, fn ($q) => $q->searchLike(['name', 'workshop', 'description'], $search));
    }

    /**
     * @return self
     */
    public function withVehicle(): self
    {
        return $this->with('vehicle');
    }
}

```

`app/Domains/Maintenance/Model/Builder/MaintenanceMaintenanceItem.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class MaintenanceMaintenanceItem extends BuilderAbstract
{
    /**
     * @param int $maintenance_id
     *
     * @return self
     */
    public function byMaintenanceId(int $maintenance_id): self
    {
        return $this->where('maintenance_id', $maintenance_id);
    }

    /**
     * @param int $maintenance_item_id
     *
     * @return self
     */
    public function byMaintenanceItemId(int $maintenance_item_id): self
    {
        return $this->where('maintenance_item_id', $maintenance_item_id);
    }

    /**
     * @param array $maintenance_item_ids
     *
     * @return self
     */
    public function byMaintenanceItemIds(array $maintenance_item_ids): self
    {
        return $this->whereIntegerInRaw('maintenance_item_id', $maintenance_item_ids);
    }

    /**
     * @param array $maintenance_item_ids
     *
     * @return self
     */
    public function byMaintenanceItemIdsNot(array $maintenance_item_ids): self
    {
        return $this->whereIntegerNotInRaw('maintenance_item_id', $maintenance_item_ids);
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderBy('id', 'ASC');
    }

    /**
     * @return self
     */
    public function selectMaintenanceItemStats(): self
    {
        return $this->select('maintenance_item_id')
            ->selectRaw('MIN(`amount_net`) `amount_net_min`')
            ->selectRaw('MAX(`amount_net`) `amount_net_max`')
            ->selectRaw('AVG(`amount_net`) `amount_net_avg`')
            ->selectRaw('SUM(`quantity`) `quantity_sum`')
            ->selectRaw('SUM(`total`) `total_sum`')
            ->groupBy('maintenance_item_id');
    }

    /**
     * @return self
     */
    public function withItem(): self
    {
        return $this->with('item');
    }

    /**
     * @return self
     */
    public function withMaintenance(): self
    {
        return $this->with('maintenance');
    }

    /**
     * @return self
     */
    public function withMaintenanceWithVehicle(): self
    {
        return $this->with(['maintenance' => fn ($q) => $q->withVehicle()]);
    }
}

```

`app/Domains/Maintenance/Model/Collection/Maintenance.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Maintenance extends CollectionAbstract
{
}

```

`app/Domains/Maintenance/Model/Collection/MaintenanceMaintenanceItem.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class MaintenanceMaintenanceItem extends CollectionAbstract
{
}

```

`app/Domains/Maintenance/Model/Maintenance.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\Relations\HasMany;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\File\Model\File as FileModel;
use App\Domains\Maintenance\Model\Builder\Maintenance as Builder;
use App\Domains\Maintenance\Model\Collection\Maintenance as Collection;
use App\Domains\Maintenance\Test\Factory\Maintenance as TestFactory;
use App\Domains\MaintenanceItem\Model\MaintenanceItem as MaintenanceItemModel;
use App\Domains\User\Model\User as UserModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class Maintenance extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'maintenance';

    /**
     * @const string
     */
    public const TABLE = 'maintenance';

    /**
     * @const string
     */
    public const FOREIGN = 'maintenance_id';

    /**
     * @param array $models
     *
     * @return \App\Domains\Maintenance\Model\Collection\Maintenance
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Maintenance\Model\Builder\Maintenance
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Maintenance\Test\Factory\Maintenance
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function files(): HasMany
    {
        return $this->hasMany(FileModel::class, 'related_id')->byRelatedTable(static::TABLE)->list();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsToMany
     */
    public function items(): BelongsToMany
    {
        return $this->belongsToMany(MaintenanceItemModel::class, MaintenanceMaintenanceItem::TABLE);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function itemsPivot(): HasMany
    {
        return $this->hasMany(MaintenanceMaintenanceItem::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(UserModel::class, UserModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(VehicleModel::class, VehicleModel::FOREIGN)->withTimezone();
    }
}

```

`app/Domains/Maintenance/Model/MaintenanceMaintenanceItem.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Model;

use Illuminate\Database\Eloquent\Relations\BelongsTo;
use App\Domains\CoreApp\Model\PivotAbstract;
use App\Domains\Maintenance\Model\Builder\MaintenanceMaintenanceItem as Builder;
use App\Domains\Maintenance\Model\Collection\MaintenanceMaintenanceItem as Collection;
use App\Domains\MaintenanceItem\Model\MaintenanceItem as MaintenanceItemModel;

class MaintenanceMaintenanceItem extends PivotAbstract
{
    /**
     * @var string
     */
    protected $table = 'maintenance_maintenance_item';

    /**
     * @const string
     */
    public const TABLE = 'maintenance_maintenance_item';

    /**
     * @const string
     */
    public const FOREIGN = 'maintenance_maintenance_item_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'quantity' => 'float',
        'amount_gross' => 'float',
        'amount_net' => 'float',
        'tax_percent' => 'float',
        'subtotal' => 'float',
        'tax_amount' => 'float',
        'total' => 'float',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\Maintenance\Model\Collection\MaintenanceMaintenanceItem
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Maintenance\Model\Builder\MaintenanceMaintenanceItem
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function item(): BelongsTo
    {
        return $this->belongsTo(MaintenanceItemModel::class, MaintenanceItemModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function maintenance(): BelongsTo
    {
        return $this->belongsTo(Maintenance::class, Maintenance::FOREIGN);
    }
}

```

`app/Domains/Maintenance/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'workshop' => ['bail', 'required'],
            'date_at' => ['bail', 'required', 'date_format:Y-m-d'],
            'distance' => ['bail', 'required', 'numeric'],
            'distance_next' => ['bail', 'numeric'],
            'amount' => ['bail', 'numeric'],
            'description' => ['bail'],
            'user_id' => ['bail', 'integer'],
            'vehicle_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/Maintenance/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Validate;

class Update extends Create
{
}

```

`app/Domains/Maintenance/Validate/UpdateItem.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdateItem extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'maintenance_item_id' => ['array'],
            'maintenance_item_id.*' => ['integer'],
            'quantity' => ['array'],
            'quantity.*' => ['numeric', 'min:0'],
            'amount_gross' => ['array'],
            'amount_gross.*' => ['numeric', 'min:0'],
            'tax_percent' => ['array'],
            'tax_percent.*' => ['numeric', 'min:0'],
        ];
    }
}

```

`app/Domains/Maintenance/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Maintenance\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/MaintenanceItem/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\MaintenanceItem\Model\MaintenanceItem as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\MaintenanceItem\Model\MaintenanceItem
     */
    protected ?Model $row;
}

```

`app/Domains/MaintenanceItem/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\MaintenanceItem\Model\MaintenanceItem as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\MaintenanceItem\Model\MaintenanceItem
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\MaintenanceItem\Model\MaintenanceItem
     */
    public function create(): Model
    {
        return $this->actionHandleTransaction(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandleTransaction(Delete::class);
    }

    /**
     * @return \App\Domains\MaintenanceItem\Model\MaintenanceItem
     */
    public function update(): Model
    {
        return $this->actionHandleTransaction(Update::class, $this->validate()->update());
    }
}

```

`app/Domains/MaintenanceItem/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Action;

use App\Domains\MaintenanceItem\Model\MaintenanceItem as Model;

class Create extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'name' => $this->data['name'],
            'user_id' => $this->data['user_id'],
        ])->fresh();
    }
}

```

`app/Domains/MaintenanceItem/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->delete();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }
}

```

`app/Domains/MaintenanceItem/Action/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Action;

use App\Domains\MaintenanceItem\Model\MaintenanceItem as Model;

abstract class CreateUpdateAbstract extends ActionAbstract
{
    /**
     * @return void
     */
    abstract protected function save(): void;

    /**
     * @return \App\Domains\MaintenanceItem\Model\MaintenanceItem
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataName();
        $this->dataUserId();
    }

    /**
     * @return void
     */
    protected function dataName(): void
    {
        $this->data['name'] = trim($this->data['name']);
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkName();
    }

    /**
     * @return void
     */
    protected function checkName(): void
    {
        if ($this->checkNameExists()) {
            $this->exceptionValidator(__('maintenance-item-create.error.exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkNameExists(): bool
    {
        return Model::query()
            ->byIdNot($this->row->id ?? 0)
            ->byName($this->data['name'])
            ->byUserId($this->data['user_id'])
            ->exists();
    }
}

```

`app/Domains/MaintenanceItem/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Action;

class Update extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->name = $this->data['name'];
        $this->row->save();
    }
}

```

`app/Domains/MaintenanceItem/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\MaintenanceItem\Model\MaintenanceItem as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\MaintenanceItem\Model\MaintenanceItem
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\MaintenanceItem\Model\MaintenanceItem
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('maintenance-item.error.not-found')));
    }
}

```

`app/Domains/MaintenanceItem/Controller/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\MaintenanceItem\Controller\Service\Create as ControllerService;

class Create extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse|\Illuminate\Http\JsonResponse
     */
    public function __invoke(): Response|RedirectResponse|JsonResponse
    {
        if ($this->request->wantsJson()) {
            return $this->responseJson();
        }

        if ($response = $this->actionPost('create')) {
            return $response;
        }

        $this->meta('title', __('maintenance-item-create.meta-title'));

        return $this->page('maintenance-item.create', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->factory()->fractal('simple', $this->action()->create()));
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function create(): RedirectResponse
    {
        $this->row = $this->action()->create();

        $this->sessionMessage('success', __('maintenance-item-create.success'));

        return redirect()->route('maintenance-item.update', $this->row->id);
    }
}

```

`app/Domains/MaintenanceItem/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller;

use Illuminate\Http\Response;
use App\Domains\MaintenanceItem\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('maintenance-item-index.meta-title'));

        return $this->page('maintenance-item.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/MaintenanceItem/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/MaintenanceItem/Controller/Service/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;

class Create extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->request();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCreateUpdate();
    }
}

```

`app/Domains/MaintenanceItem/Controller/Service/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller\Service;

abstract class CreateUpdateAbstract extends ControllerAbstract
{
    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow([
            'user_id' => $this->user()->id,
        ]);
    }

    /**
     * @return array
     */
    protected function dataCreateUpdate(): array
    {
        return $this->dataCore();
    }
}

```

`app/Domains/MaintenanceItem/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\MaintenanceItem\Model\Collection\MaintenanceItem as Collection;
use App\Domains\MaintenanceItem\Model\MaintenanceItem as Model;

class Index extends ControllerAbstract
{
    /**
     * @var bool
     */
    protected bool $userEmpty = true;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->filters();
    }

    /**
     * @return void
     */
    protected function filters(): void
    {
        $this->filtersUserId();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCore() + [
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\MaintenanceItem\Model\Collection\MaintenanceItem
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->withMaintenancesCount()
                ->withStats()
                ->withSimple('user')
                ->orderByMaintenancesCount()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/MaintenanceItem/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\MaintenanceItem\Model\MaintenanceItem as Model;

class Update extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\MaintenanceItem\Model\MaintenanceItem $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCreateUpdate() + [
            'row' => $this->row,
        ];
    }
}

```

`app/Domains/MaintenanceItem/Controller/Service/UpdateMaintenance.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Maintenance\Model\Collection\MaintenanceMaintenanceItem as MaintenanceMaintenanceItemCollection;
use App\Domains\Maintenance\Model\MaintenanceMaintenanceItem as MaintenanceMaintenanceItemModel;
use App\Domains\MaintenanceItem\Model\MaintenanceItem as Model;

class UpdateMaintenance extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\MaintenanceItem\Model\MaintenanceItem $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'maintenancesPivot' => $this->maintenancesPivot(),
            'total' => $this->total(),
        ];
    }

    /**
     * @return \App\Domains\Maintenance\Model\Collection\MaintenanceMaintenanceItem
     */
    protected function maintenancesPivot(): MaintenanceMaintenanceItemCollection
    {
        return $this->cache(
            fn () => MaintenanceMaintenanceItemModel::query()
                ->byMaintenanceItemId($this->row->id)
                ->withMaintenanceWithVehicle()
                ->orderByLast()
                ->get()
        );
    }

    /**
     * @return array
     */
    protected function total(): array
    {
        $maintenancesPivot = $this->maintenancesPivot();

        return [
            'quantity' => $maintenancesPivot->sum('quantity'),
            'amount_gross' => $maintenancesPivot->sum('amount_gross'),
            'amount_net' => $maintenancesPivot->sum('amount_net'),
            'subtotal' => $maintenancesPivot->sum('subtotal'),
            'tax_amount' => $maintenancesPivot->sum('tax_amount'),
            'total' => $maintenancesPivot->sum('total'),
        ];
    }
}

```

`app/Domains/MaintenanceItem/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\MaintenanceItem\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actions()) {
            return $response;
        }

        $this->meta('title', __('maintenance-item-update.meta-title', ['title' => $this->row->name]));

        return $this->page('maintenance-item.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('update')
            ?: $this->actionPost('delete');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('maintenance-item-update.success'));

        return redirect()->route('maintenance-item.update', $this->row->id);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function delete(): RedirectResponse
    {
        $this->action()->delete();

        $this->sessionMessage('success', __('maintenance-item-update.delete-success'));

        return redirect()->route('maintenance-item.index');
    }
}

```

`app/Domains/MaintenanceItem/Controller/UpdateMaintenance.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller;

use Illuminate\Http\Response;
use App\Domains\MaintenanceItem\Controller\Service\UpdateMaintenance as ControllerService;

class UpdateMaintenance extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response
     */
    public function __invoke(int $id): Response
    {
        $this->row($id);

        $this->meta('title', __('maintenance-item-update-maintenance.meta-title', ['title' => $this->row->name]));

        return $this->page('maintenance-item.update-maintenance', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }
}

```

`app/Domains/MaintenanceItem/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth']], static function () {
    Route::get('/maintenance-item', Index::class)->name('maintenance-item.index');
    Route::any('/maintenance-item/create', Create::class)->name('maintenance-item.create');
    Route::any('/maintenance-item/{id}', Update::class)->name('maintenance-item.update');
    Route::any('/maintenance-item/{id}/maintenance', UpdateMaintenance::class)->name('maintenance-item.update.maintenance');
});

```

`app/Domains/MaintenanceItem/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\MaintenanceItem\Model\MaintenanceItem as Model;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\MaintenanceItem\Model\MaintenanceItem $row
     *
     * @return array
     */
    protected function simple(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
        ];
    }
}

```

`app/Domains/MaintenanceItem/Model/Builder/MaintenanceItem.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\Maintenance\Model\MaintenanceMaintenanceItem as MaintenanceMaintenanceItemModel;

class MaintenanceItem extends BuilderAbstract
{
    /**
     * @param string $name
     *
     * @return self
     */
    public function byName(string $name): self
    {
        return $this->where('name', $name);
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderBy('name', 'ASC');
    }

    /**
     * @return self
     */
    public function orderByMaintenancesCount(): self
    {
        return $this->orderBy('maintenances_count', 'DESC');
    }

    /**
     * @return self
     */
    public function withMaintenancesCount(): self
    {
        return $this->withCount('maintenances');
    }

    /**
     * @return self
     */
    public function withStats(): self
    {
        return $this->selectRaw('COALESCE(`stats`.`amount_net_min`, 0) AS `amount_net_min`')
            ->selectRaw('COALESCE(`stats`.`amount_net_max`, 0) AS `amount_net_max`')
            ->selectRaw('COALESCE(`stats`.`amount_net_avg`, 0) AS `amount_net_avg`')
            ->selectRaw('COALESCE(`stats`.`quantity_sum`, 0) AS `quantity_sum`')
            ->selectRaw('COALESCE(`stats`.`total_sum`, 0) AS `total_sum`')
            ->leftJoinSub(
                MaintenanceMaintenanceItemModel::query()->selectMaintenanceItemStats(),
                'stats',
                static fn ($join) => $join->on('maintenance_item.id', '=', 'stats.maintenance_item_id')
            );
    }
}

```

`app/Domains/MaintenanceItem/Model/Collection/MaintenanceItem.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class MaintenanceItem extends CollectionAbstract
{
}

```

`app/Domains/MaintenanceItem/Model/MaintenanceItem.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\Relations\HasMany;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\Maintenance\Model\Maintenance as MaintenanceModel;
use App\Domains\Maintenance\Model\MaintenanceMaintenanceItem as MaintenanceMaintenanceItemModel;
use App\Domains\MaintenanceItem\Model\Builder\MaintenanceItem as Builder;
use App\Domains\MaintenanceItem\Model\Collection\MaintenanceItem as Collection;
use App\Domains\MaintenanceItem\Test\Factory\MaintenanceItem as TestFactory;
use App\Domains\User\Model\User as UserModel;

class MaintenanceItem extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'maintenance_item';

    /**
     * @const string
     */
    public const TABLE = 'maintenance_item';

    /**
     * @const string
     */
    public const FOREIGN = 'maintenance_item_id';

    /**
     * @param array $models
     *
     * @return \App\Domains\MaintenanceItem\Model\Collection\MaintenanceItem
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\MaintenanceItem\Model\Builder\MaintenanceItem
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\MaintenanceItem\Test\Factory\MaintenanceItem
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsToMany
     */
    public function maintenances(): BelongsToMany
    {
        return $this->belongsToMany(MaintenanceModel::class, MaintenanceMaintenanceItemModel::TABLE);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function maintenancesPivot(): HasMany
    {
        return $this->hasMany(MaintenanceMaintenanceItemModel::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(UserModel::class, UserModel::FOREIGN);
    }
}

```

`app/Domains/MaintenanceItem/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'user_id' => ['bail', 'integer'],
        ];
    }
}

```

`app/Domains/MaintenanceItem/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Validate;

class Update extends Create
{
}

```

`app/Domains/MaintenanceItem/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\MaintenanceItem\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Monitor/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;

abstract class ActionAbstract extends ActionAbstractCore
{
}

```

`app/Domains/Monitor/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @return void
     */
    public function queueFailedRetry(): void
    {
        $this->actionHandle(QueueFailedRetry::class, $this->validate()->queueFailedRetry());
    }
}

```

`app/Domains/Monitor/Action/QueueFailedRetry.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Action;

use Illuminate\Support\Facades\Artisan;

class QueueFailedRetry extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->retry();
    }

    /**
     * @return void
     */
    protected function retry(): void
    {
        Artisan::call('queue:retry', ['id' => $this->data['id']]);
    }
}

```

`app/Domains/Monitor/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;

abstract class ControllerAbstract extends ControllerWebAbstract
{
}

```

`app/Domains/Monitor/Controller/Database.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller;

use Illuminate\Http\Response;
use App\Domains\Monitor\Controller\Service\Database as ControllerService;

class Database extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('monitor-database.meta-title'));

        return $this->page('monitor.database', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Monitor/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller;

use Illuminate\Http\Response;
use App\Domains\Monitor\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('monitor-index.meta-title'));

        return $this->page('monitor.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Monitor/Controller/Installation.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller;

use Illuminate\Http\Response;
use App\Domains\Monitor\Controller\Service\Installation as ControllerService;

class Installation extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('monitor-installation.meta-title'));

        return $this->page('monitor.installation', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Monitor/Controller/Log.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller;

use Illuminate\Http\Response;
use App\Domains\Monitor\Controller\Service\Log as ControllerService;

class Log extends ControllerAbstract
{
    /**
     * @param string $path
     *
     * @return \Illuminate\Http\Response
     */
    public function __invoke(string $path = ''): Response
    {
        $this->meta('title', __('monitor-log.meta-title'));

        return $this->page('monitor.log.index', $this->data($path));
    }

    /**
     * @param string $path
     *
     * @return array
     */
    protected function data(string $path): array
    {
        return ControllerService::new($this->request, $this->auth, $path)->data();
    }
}

```

`app/Domains/Monitor/Controller/LogFile.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller;

use Illuminate\Http\Response;
use App\Domains\Monitor\Controller\Service\LogFile as ControllerService;

class LogFile extends ControllerAbstract
{
    /**
     * @param string $path
     * @param string $file
     *
     * @return \Illuminate\Http\Response
     */
    public function __invoke(string $path, string $file): Response
    {
        $this->meta('title', __('monitor-log.meta-title'));

        return $this->page('monitor.log.file', $this->data($path, $file));
    }

    /**
     * @param string $path
     * @param string $file
     *
     * @return array
     */
    protected function data(string $path, string $file): array
    {
        return ControllerService::new($this->request, $this->auth, $path, $file)->data();
    }
}

```

`app/Domains/Monitor/Controller/LogFileDownload.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller;

use Symfony\Component\HttpFoundation\StreamedResponse;
use App\Domains\Monitor\Controller\Service\LogFileDownload as ControllerService;

class LogFileDownload extends ControllerAbstract
{
    /**
     * @param string $path
     * @param string $file
     *
     * @return \Symfony\Component\HttpFoundation\StreamedResponse
     */
    public function __invoke(string $path, string $file): StreamedResponse
    {
        return ControllerService::new($this->request, $this->auth, $path, $file)->data();
    }
}

```

`app/Domains/Monitor/Controller/Queue.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Monitor\Controller\Service\Queue as ControllerService;

class Queue extends ControllerAbstract
{
    /**
     * @param string $name = ''
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(string $name = ''): Response|RedirectResponse
    {
        if ($response = $this->actionPost('failedRetry')) {
            return $response;
        }

        $this->meta('title', __('monitor-queue.meta-title'));

        $data = $this->data($name);

        return $this->page('monitor.queue.'.$data['name'], $data);
    }

    /**
     * @param string $name
     *
     * @return array
     */
    protected function data(string $name): array
    {
        return ControllerService::new($this->request, $this->auth, $name)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function failedRetry(): RedirectResponse
    {
        $this->action()->queueFailedRetry();

        $this->sessionMessage('success', __('monitor-queue-failed.retry-success'));

        return redirect()->back();
    }
}

```

`app/Domains/Monitor/Controller/Requirements.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller;

use Illuminate\Http\Response;
use App\Domains\Monitor\Controller\Service\Requirements as ControllerService;

class Requirements extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('monitor-requirements.meta-title'));

        return $this->page('monitor.requirements', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Monitor/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/Monitor/Controller/Service/Database.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Monitor\Service\Database\Database as DatabaseDriver;

class Database extends ControllerAbstract
{
    /**
     * @var \App\Domains\Monitor\Service\Database\Database
     */
    protected DatabaseDriver $driver;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'size' => $this->size(),
            'count' => $this->count(),
        ];
    }

    /**
     * @return \App\Domains\Monitor\Service\Database\Database
     */
    protected function driver(): DatabaseDriver
    {
        return $this->driver ??= new DatabaseDriver();
    }

    /**
     * @return array
     */
    protected function size(): array
    {
        return $this->driver()->size();
    }

    /**
     * @return array
     */
    protected function count(): array
    {
        return $this->driver()->count();
    }
}

```

`app/Domains/Monitor/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Monitor\Service\System\Cpu;
use App\Domains\Monitor\Service\System\Disk;
use App\Domains\Monitor\Service\System\Memory;
use App\Domains\Monitor\Service\System\Summary;

class Index extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'summary' => $this->summary(),
            'cpu' => $this->cpu(),
            'memory' => $this->memory(),
            'disk' => $this->disk(),
        ];
    }

    /**
     * @return ?array
     */
    protected function summary(): ?array
    {
        return Summary::new()->get();
    }

    /**
     * @return ?array
     */
    protected function cpu(): ?array
    {
        return Cpu::new()->get();
    }

    /**
     * @return ?array
     */
    protected function memory(): ?array
    {
        return Memory::new()->get();
    }

    /**
     * @return ?array
     */
    protected function disk(): ?array
    {
        return Disk::new()->get();
    }
}

```

`app/Domains/Monitor/Controller/Service/Installation.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Services\Command\Exec;

class Installation extends ControllerAbstract
{
    /**
     * @var ?string
     */
    protected ?string $git;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->fetch();
    }

    /**
     * @return void
     */
    protected function fetch(): void
    {
        if ($this->available() === false) {
            return;
        }

        exec($this->git().' fetch origin '.$this->branch());
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'available' => $this->available(),
            'updated' => $this->updated(),
            'current' => $this->current(),
            'updated_commits' => $this->updatedCommits(),
            'pending_commits' => $this->pendingCommits(),
            'pending_commits_count' => $this->pendingCommitsCount(),
            'pending_more' => $this->pendingMore(),
        ];
    }

    /**
     * @return bool
     */
    protected function available(): bool
    {
        return $this->cache(fn () => $this->git() && is_dir(base_path('.git')));
    }

    /**
     * @return bool
     */
    protected function updated(): bool
    {
        if ($this->available() === false) {
            return false;
        }

        return $this->cache(fn () => empty($this->logDiff()));
    }

    /**
     * @return ?array
     */
    protected function current(): ?array
    {
        if ($this->available() === false) {
            return null;
        }

        return $this->log()[0] ?? null;
    }

    /**
     * @return ?array
     */
    protected function updatedCommits(): ?array
    {
        if ($this->available() === false) {
            return null;
        }

        return array_slice($this->log(), 1, 6);
    }

    /**
     * @return ?array
     */
    protected function pendingCommits(): ?array
    {
        if ($this->available() === false) {
            return null;
        }

        return array_slice($this->logDiff(), 0, 5);
    }

    /**
     * @return ?int
     */
    protected function pendingCommitsCount(): ?int
    {
        if ($this->available() === false) {
            return null;
        }

        return count($this->logDiff());
    }

    /**
     * @return ?int
     */
    protected function pendingMore(): ?int
    {
        if ($this->available() === false) {
            return null;
        }

        return max(0, count($this->logDiff()) - 5);
    }

    /**
     * @return ?string
     */
    protected function git(): ?string
    {
        return $this->git ??= Exec::available('git');
    }

    /**
     * @return string
     */
    protected function branch(): string
    {
        return $this->cache(function () {
            return str_replace('refs/heads/', '', Exec::cmd($this->git().' rev-parse --symbolic-full-name --verify --quiet HEAD'));
        });
    }

    /**
     * @return array
     */
    protected function log(): array
    {
        return $this->cache(function () {
            $log = Exec::cmdLines($this->git().' log -10 --date=iso --format="%cd: %s" 2>&1');

            return $log ? array_map($this->logLine(...), $log) : [];
        });
    }

    /**
     * @return array
     */
    protected function logDiff(): array
    {
        return $this->cache(function () {
            $log = Exec::cmdLines($this->git().' log -10 --date=iso --format="%cd: %s" HEAD..origin/'.$this->branch().' 2>&1');

            return $log ? array_map($this->logLine(...), $log) : [];
        });
    }

    /**
     * @param string $line
     *
     * @return array
     */
    protected function logLine(string $line): array
    {
        $line = explode(': ', $line, 2) + ['now', ''];

        return [
            'date' => helper()->dateFormattedToTimezone($line[0], $this->auth->timezone->zone),
            'message' => $line[1],
        ];
    }
}

```

`app/Domains/Monitor/Controller/Service/Log.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller\Service;

use DirectoryIterator;
use stdClass;
use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;

class Log extends LogAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(
        protected Request $request,
        protected Authenticatable $auth,
        protected string $path
    ) {
        $this->path();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'path' => $this->path,
            'breadcrumb' => $this->breadcrumb(),
            'list' => $this->list(),
        ];
    }

    /**
     * @return bool
     */
    protected function isFile(): bool
    {
        return false;
    }

    /**
     * @return array
     */
    protected function list(): array
    {
        $list = [];

        foreach (new DirectoryIterator($this->fullpath()) as $fileInfo) {
            if ($this->listContentIsValid($fileInfo)) {
                $list[] = $this->listContent($fileInfo);
            }
        }

        usort($list, [$this, 'listSort']);

        return $list;
    }

    /**
     * @param \stdClass $a
     * @param \stdClass $b
     *
     * @return int
     */
    protected function listSort(stdClass $a, stdClass $b): int
    {
        if ($a->type !== $b->type) {
            return $a->type <=> $b->type;
        }

        if ($a->type === 'file') {
            return $b->name <=> $a->name;
        }

        $aIsNumber = preg_match('/^[0-9]/', $a->name);
        $bIsNumber = preg_match('/^[0-9]/', $b->name);

        if ($aIsNumber !== $bIsNumber) {
            return $aIsNumber ? -1 : 1;
        }

        return $aIsNumber ? ($b->name <=> $a->name) : ($a->name <=> $b->name);
    }

    /**
     * @param \DirectoryIterator $fileInfo
     *
     * @return bool
     */
    protected function listContentIsValid(DirectoryIterator $fileInfo): bool
    {
        if ($fileInfo->isDot()) {
            return false;
        }

        if ($fileInfo->isDir()) {
            return true;
        }

        return in_array($fileInfo->getExtension(), ['csv', 'json', 'log', 'zip']);
    }

    /**
     * @param \DirectoryIterator $fileInfo
     *
     * @return \stdClass
     */
    protected function listContent(DirectoryIterator $fileInfo): stdClass
    {
        return (object)[
            'name' => $fileInfo->getBasename(),
            'size' => $fileInfo->getSize(),
            'type' => $fileInfo->isDir() ? 'dir' : 'file',
            'updated_at' => date('Y-m-d H:i:s', $fileInfo->getMTime()),
            'route' => $this->listContentRoute($fileInfo),
            'route_download' => $this->listContentRouteDownload($fileInfo),
        ];
    }

    /**
     * @param \DirectoryIterator $fileInfo
     *
     * @return string
     */
    protected function listContentRoute(DirectoryIterator $fileInfo): string
    {
        return $fileInfo->isDir()
            ? $this->listContentRouteDir($fileInfo)
            : $this->listContentRouteFile($fileInfo);
    }

    /**
     * @param \DirectoryIterator $fileInfo
     *
     * @return string
     */
    protected function listContentRouteDir(DirectoryIterator $fileInfo): string
    {
        return route('monitor.log.path', $this->pathUrl($fileInfo->getPathName()));
    }

    /**
     * @param \DirectoryIterator $fileInfo
     *
     * @return string
     */
    protected function listContentRouteFile(DirectoryIterator $fileInfo): string
    {
        return route('monitor.log.file', [$this->pathUrl($fileInfo->getPath()), base64_encode($fileInfo->getFilename())]);
    }

    /**
     * @param \DirectoryIterator $fileInfo
     *
     * @return ?string
     */
    protected function listContentRouteDownload(DirectoryIterator $fileInfo): ?string
    {
        if ($fileInfo->isDir()) {
            return null;
        }

        return route('monitor.log.file.download', [$this->pathUrl($fileInfo->getPath()), base64_encode($fileInfo->getFilename())]);
    }

    /**
     * @param string $path
     *
     * @return string
     */
    protected function pathUrl(string $path): string
    {
        return base64_encode(str_replace($this->basepath(), '', $path) ?: '/');
    }
}

```

`app/Domains/Monitor/Controller/Service/LogAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller\Service;

use stdClass;

abstract class LogAbstract extends ControllerAbstract
{
    /**
     * @var string
     */
    protected string $basepath;

    /**
     * @var string
     */
    protected string $fullpath;

    /**
     * @const string
     */
    protected const BASE = 'storage/logs';

    /**
     * @return void
     */
    protected function path(): void
    {
        $this->path = $this->pathValid();
    }

    /**
     * @return string
     */
    protected function pathValid(): string
    {
        $path = base64_decode($this->path);

        if (empty($path)) {
            return '';
        }

        if (preg_match('/^[a-zA-Z0-9_\.\/\-]+$/', $path) === 0) {
            return '';
        }

        if (str_contains($path, '..')) {
            return '';
        }

        $path = preg_replace('/\/+/', '/', trim($path, '/'));

        if (is_dir($this->basepath().'/'.$path) === false) {
            return '';
        }

        return $path;
    }

    /**
     * @return void
     */
    protected function file(): void
    {
        if (empty($file = $this->fileValid())) {
            abort(404);
        }

        $this->file = $file;
    }

    /**
     * @return ?string
     */
    protected function fileValid(): ?string
    {
        $file = base64_decode($this->file);

        if (empty($file)) {
            return null;
        }

        if (preg_match('/\.(csv|json|log|zip)$/i', $file) === 0) {
            return null;
        }

        $fullpath = $this->fullpath().'/'.$file;

        if (is_file($fullpath) === false) {
            return null;
        }

        if (is_readable($fullpath) === false) {
            return null;
        }

        return $file;
    }

    /**
     * @return string
     */
    protected function basepath(): string
    {
        return $this->basepath ??= base_path(static::BASE);
    }

    /**
     * @return string
     */
    protected function fullpath(): string
    {
        return $this->fullpath ??= $this->basepath().'/'.$this->path;
    }

    /**
     * @return array
     */
    protected function breadcrumb(): array
    {
        $breadcrumb = [];
        $acum = [];

        foreach (array_filter(explode('/', $this->path)) as $path) {
            $breadcrumb[] = $this->breadcrumbDir($path, $acum);
        }

        if (isset($this->file)) {
            $breadcrumb[] = $this->breadcrumbFile($acum);
        }

        return $breadcrumb;
    }

    /**
     * @param string $path
     * @param array &$acum
     *
     * @return \stdClass
     */
    protected function breadcrumbDir(string $path, array &$acum): stdClass
    {
        return (object)[
            'name' => $path,
            'route' => route('monitor.log.path', $this->pathUrl(implode('/', ($acum[] = $path) ? $acum : []))),
        ];
    }

    /**
     * @param array $acum
     *
     * @return \stdClass
     */
    protected function breadcrumbFile(array $acum): stdClass
    {
        return (object)[
            'name' => $this->file,
            'route' => route('monitor.log.file', [$this->pathUrl(implode('/', $acum)), base64_encode($this->file)]),
        ];
    }

    /**
     * @param string $path
     *
     * @return string
     */
    protected function pathUrl(string $path): string
    {
        return base64_encode($path ?: '/');
    }
}

```

`app/Domains/Monitor/Controller/Service/LogFile.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Services\Compress\Zip\Contents as ZipContents;

class LogFile extends LogAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param string $path
     * @param string $file
     *
     * @return self
     */
    public function __construct(
        protected Request $request,
        protected Authenticatable $auth,
        protected string $path,
        protected string $file,
    ) {
        $this->path();
        $this->file();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'path' => $this->path,
            'file' => $this->file,
            'breadcrumb' => $this->breadcrumb(),
            'contents' => $this->contents(),
        ];
    }

    /**
     * @return callable
     */
    protected function contents(): callable
    {
        return fn () => $this->contentsRead();
    }

    /**
     * @return void
     */
    protected function contentsRead(): void
    {
        $file = $this->fullpath().'/'.$this->file;

        if (is_file($file) === false) {
            return;
        }

        if (preg_match('/\.zip$/', $file)) {
            echo ZipContents::new($file)->contents();
        } else {
            $this->contentsReadFile($file);
        }
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function contentsReadFile(string $file): void
    {
        $max = 10 * 1024 * 1024;
        $size = filesize($file);
        $start = max($size - $max, 0);

        $handle = fopen($file, 'rb');

        fseek($handle, $start);

        while (feof($handle) === false) {
            $buffer = fread($handle, 8192);

            if ($buffer === false) {
                break;
            }

            echo $buffer;
        }

        fclose($handle);
    }
}

```

`app/Domains/Monitor/Controller/Service/LogFileDownload.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\StreamedResponse;

class LogFileDownload extends LogAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param string $path
     * @param string $file
     *
     * @return self
     */
    public function __construct(
        protected Request $request,
        protected Authenticatable $auth,
        protected string $path,
        protected string $file,
    ) {
        $this->path();
        $this->file();
    }

    /**
     * @return \Symfony\Component\HttpFoundation\StreamedResponse
     */
    public function data(): StreamedResponse
    {
        return response()->stream($this->readfile(...), 200, $this->headers());
    }

    /**
     * @return void
     */
    protected function readfile(): void
    {
        readfile($this->fullpath().'/'.$this->file);
    }

    /**
     * @return array
     */
    protected function headers(): array
    {
        return [
            'Content-Type' => 'application/octet-stream',
            'Content-Disposition' => 'attachment; filename="'.$this->file.'"',
        ];
    }
}

```

`app/Domains/Monitor/Controller/Service/Queue.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Redis;
use App\Domains\QueueFail\Model\Collection\QueueFail as QueueFailCollection;
use App\Domains\QueueFail\Model\QueueFail as QueueFailModel;

class Queue extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(
        protected Request $request,
        protected Authenticatable $auth,
        protected string $name
    ) {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'name' => $this->name(),
            'list' => $this->list(),
        ];
    }

    /**
     * @return string
     */
    protected function name(): string
    {
        return match ($this->name) {
            '', 'pending' => 'pending',
            'delayed' => 'delayed',
            'failed' => 'failed',
            default => $this->exceptionNotFound(),
        };
    }

    /**
     * @return iterable
     */
    protected function list(): iterable
    {
        return match ($this->name) {
            '', 'pending' => $this->pending(),
            'delayed' => $this->delayed(),
            'failed' => $this->failed(),
            default => $this->exceptionNotFound(),
        };
    }

    /**
     * @return array
     */
    protected function pending(): array
    {
        return $this->command('lrange');
    }

    /**
     * @return array
     */
    protected function delayed(): array
    {
        return $this->command('zrange', ':delayed');
    }

    /**
     * @return \App\Domains\QueueFail\Model\Collection\QueueFail
     */
    protected function failed(): QueueFailCollection
    {
        return QueueFailModel::query()
            ->list()
            ->get();
    }

    /**
     * @param string $name
     * @param string $suffix = ''
     *
     * @return array
     */
    protected function command(string $name, string $suffix = ''): array
    {
        return $this->decode(Redis::command($name, ['queues:'.$this->queue($suffix), 0, -1]));
    }

    /**
     * @param array $lines
     *
     * @return array
     */
    protected function decode(array $lines): array
    {
        $lines = array_filter(array_map('json_decode', $lines), 'is_object');

        usort($lines, static fn ($a, $b) => $a->retryUntil <=> $b->retryUntil);

        return $lines;
    }

    /**
     * @param string $suffix = ''
     *
     * @return string
     */
    protected function queue(string $suffix = ''): string
    {
        return config('queue.connections.redis.queue').$suffix;
    }
}

```

`app/Domains/Monitor/Controller/Service/Requirements.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Services\Command\Exec;

class Requirements extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'functions' => $this->functions(),
            'commands' => $this->commands(),
            'phpinfo' => $this->phpinfo(),
        ];
    }

    /**
     * @return array
     */
    protected function functions(): array
    {
        $list = [];

        foreach ($this->functionsList() as $function) {
            $list[$function] = function_exists($function);
        }

        return $list;
    }

    /**
     * @return array
     */
    protected function functionsList(): array
    {
        return [
            'exec',
            'fsockopen',
            'pcntl_signal',
            'shell_exec',
            'stream_socket_server',
        ];
    }

    /**
     * @return array
     */
    protected function commands(): array
    {
        $list = ['php' => Exec::php()];

        foreach ($this->commandsList() as $command) {
            $list[$command] = Exec::available($command);
        }

        return $list;
    }

    /**
     * @return array
     */
    protected function commandsList(): array
    {
        return [
            'df',
            'free',
            'fuser',
            'git',
            'nohup',
            'nproc',
            'ps',
            'top',
        ];
    }

    /**
     * @return string
     */
    protected function phpinfo(): string
    {
        ob_start();

        phpinfo(INFO_ALL & ~INFO_ENVIRONMENT & ~INFO_VARIABLES);

        return base64_encode(ob_get_clean());
    }
}

```

`app/Domains/Monitor/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth-admin']], static function () {
    Route::get('/monitor', Index::class)->name('monitor.index');
    Route::get('/monitor/installation', Installation::class)->name('monitor.installation');
    Route::get('/monitor/database', Database::class)->name('monitor.database');
    Route::get('/monitor/log/{path}/{file}/download', LogFileDownload::class)->name('monitor.log.file.download');
    Route::get('/monitor/log/{path}/{file}', LogFile::class)->name('monitor.log.file');
    Route::get('/monitor/log/{path?}', Log::class)->name('monitor.log.path');
    Route::any('/monitor/queue/{name?}', Queue::class)->name('monitor.queue');
    Route::get('/monitor/requirements', Requirements::class)->name('monitor.requirements');
});

```

`app/Domains/Monitor/Service/Database/Database.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Service\Database;

use InvalidArgumentException;
use App\Domains\Monitor\Service\Database\Driver\DriverAbstract;
use App\Domains\Monitor\Service\Database\Driver\MySQL;
use App\Domains\Monitor\Service\Database\Driver\PgSQL;

class Database
{
    /**
     * @var \App\Domains\Monitor\Service\Database\Driver\DriverAbstract
     */
    protected DriverAbstract $driver;

    /**
     * @return \App\Domains\Monitor\Service\Database\Driver\DriverAbstract
     */
    protected function driver(): DriverAbstract
    {
        if (isset($this->driver)) {
            return $this->driver;
        }

        $driver = config('database.connections.'.config('database.default').'.driver');

        return $this->driver = match ($driver) {
            'pgsql' => new PgSQL(),
            'mysql' => new MySQL(),
            default => throw new InvalidArgumentException(sprintf('Database %s is not supported', $driver)),
        };
    }

    /**
     * @return array
     */
    public function size(): array
    {
        return $this->driver()->size();
    }

    /**
     * @return array
     */
    public function count(): array
    {
        return $this->driver()->count();
    }
}

```

`app/Domains/Monitor/Service/Database/Driver/DriverAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Service\Database\Driver;

use Illuminate\Database\ConnectionInterface;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

abstract class DriverAbstract
{
    /**
     * @return array
     */
    abstract public function size(): array;

    /**
     * @return array
     */
    abstract public function count(): array;

    /**
     * @var \Illuminate\Database\ConnectionInterface
     */
    protected ConnectionInterface $db;

    /**
     * @var array
     */
    protected array $cache = [];

    /**
     * @return \Illuminate\Database\ConnectionInterface
     */
    protected function db(): ConnectionInterface
    {
        return $this->db ??= DB::connection();
    }

    /**
     * @param string $key
     *
     * @return string|int
     */
    protected function config(string $key): string|int
    {
        $this->cache[__FUNCTION__] ??= config('database.connections.'.config('database.default'));

        return $this->cache[__FUNCTION__][$key];
    }

    /**
     * @return array
     */
    protected function tables(): array
    {
        return $this->cache[__FUNCTION__] ??= array_column($this->getTables(), 'name');
    }

    /**
     * @return array
     */
    protected function getTables(): array
    {
        return $this->cache[__FUNCTION__] ??= Schema::getTables(schema: $this->getTablesSchema());
    }

    /**
     * @return string
     */
    protected function getTablesSchema(): string
    {
        return $this->config($this->config('driver') === 'pgsql' ? 'search_path' : 'database');
    }
}

```

`app/Domains/Monitor/Service/Database/Driver/MySQL.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Service\Database\Driver;

use Illuminate\Support\Facades\DB;

class MySQL extends DriverAbstract
{
    /**
     * @return array
     */
    public function size(): array
    {
        if (isset($this->cache[__FUNCTION__])) {
            return $this->cache[__FUNCTION__];
        }

        $this->analyze();

        return $this->cache[__FUNCTION__] = DB::select('
            SELECT
                `TABLE_NAME` AS `table_name`,
                ROUND((`DATA_LENGTH` + `INDEX_LENGTH`) / 1024 / 1024, 2) AS `total_size`,
                ROUND(`DATA_LENGTH` / 1024 / 1024, 2) AS `table_size`,
                ROUND(`INDEX_LENGTH` / 1024 / 1024, 2) AS `index_size`
            FROM
                `information_schema`.`TABLES`
            WHERE
                `TABLE_SCHEMA` = :table_schema
            ORDER BY
                (`DATA_LENGTH` + `INDEX_LENGTH`) DESC;
        ', ['table_schema' => $this->config('database')]);
    }

    /**
     * @return array
     */
    public function count(): array
    {
        return $this->cache[__FUNCTION__] ??= (array)$this->db()->select($this->countSql())[0];
    }

    /**
     * @return string
     */
    protected function countSql(): string
    {
        $sql = [];

        foreach ($this->tables() as $table) {
            $sql[] = '(SELECT COUNT(*) FROM `'.$table.'`) AS `'.$table.'`';
        }

        return 'SELECT '.implode(', ', $sql).';';
    }

    /**
     * @return void
     */
    protected function analyze(): void
    {
        $this->db()->statement('ANALYZE LOCAL TABLE `'.implode('`, `', $this->tables()).'`;');
    }
}

```

`app/Domains/Monitor/Service/Database/Driver/PgSQL.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Service\Database\Driver;

class PgSQL extends DriverAbstract
{
    /**
     * @return array
     */
    public function size(): array
    {
        return $this->db()->select('
            SELECT
                "table_name",
                ROUND(("data_length" + "index_length") / 1024 / 1024, 2) AS "total_size",
                ROUND("data_length" / 1024 / 1024, 2) AS "table_size",
                ROUND("index_length" / 1024 / 1024, 2) AS "index_size"
            FROM
                (
                    SELECT
                        "table_name",
                        pg_total_relation_size(quote_ident("table_schema") || \'.\' || quote_ident("table_name")) AS "data_length",
                        pg_relation_size(quote_ident("table_schema") || \'.\' || quote_ident("table_name")) AS "index_length"
                    FROM
                        "information_schema"."tables"
                    WHERE
                        "table_catalog" = :table_catalog
                        AND "table_schema" = \'public\'
                        AND "table_type" = \'BASE TABLE\'
                ) AS "sizes"
            ORDER BY
                ("data_length" + "index_length") DESC;
        ', ['table_catalog' => $this->config('database')]);
    }

    /**
     * @return array
     */
    public function count(): array
    {
        return $this->cache[__FUNCTION__] ??= (array)$this->db()->select($this->countSql())[0];
    }

    /**
     * @return string
     */
    protected function countSql(): string
    {
        $sql = [];

        foreach ($this->getTables() as $table) {
            $sql[] = '(SELECT COUNT(*) FROM "'.$table['schema'].'"."'.$table['name'].'") AS "'.$table['name'].'"';
        }

        return 'SELECT '.implode(', ', $sql).';';
    }
}

```

`app/Domains/Monitor/Service/System/Cpu.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Service\System;

use App\Services\Command\Exec;

class Cpu extends SystemAbstract
{
    /**
     * @var int
     */
    protected int $cores;

    /**
     * @var array
     */
    protected array $average;

    /**
     * @var float
     */
    protected float $load;

    /**
     * @var float
     */
    protected float $free;

    /**
     * @var float
     */
    protected float $percent;

    /**
     * @var array
     */
    protected array $apps;

    /**
     * @return self
     */
    public function __construct()
    {
        $this->load();
        $this->apps();
    }

    /**
     * @return ?array
     */
    public function get(): ?array
    {
        if ($this->isAvailable() === false) {
            return null;
        }

        return [
            'cores' => $this->cores,
            'average' => $this->average,
            'load' => $this->load,
            'free' => $this->free,
            'percent' => $this->percent,
            'apps' => $this->apps,
        ];
    }

    /**
     * @return bool
     */
    protected function isAvailable(): bool
    {
        return isset(
            $this->cores,
            $this->average,
            $this->load,
            $this->free,
            $this->percent,
            $this->apps,
        );
    }

    /**
     * @return void
     */
    protected function load(): void
    {
        $this->cores = Exec::cmdInt('nproc --all');

        if (empty($this->cores)) {
            return;
        }

        $info = Exec::cmdArray('cat /proc/loadavg');

        if (isset($info[0], $info[1], $info[2]) === false) {
            return;
        }

        $this->average = array_slice($info, 0, 3);
        $this->load = floatval($info[0]);
        $this->free = $this->cores - $this->load;
        $this->percent = intval(round($this->load / $this->cores * 100));
    }

    /**
     * @return void
     */
    protected function apps(): void
    {
        $this->apps = $this->limit(
            $this->sort(
                $this->summary(
                    $this->acum(
                        array_slice($this->top(), 7)
                    )
                )
            )
        );
    }

    /**
     * @param array $lines
     *
     * @return array
     */
    protected function acum(array $lines): array
    {
        $apps = [];

        foreach ($lines as $line) {
            $memory = $this->memorySize($line[5]);

            if (intval($memory) === 0) {
                continue;
            }

            $app = trim($line[11]);

            if ($app === 'top') {
                continue;
            }

            if (empty($apps[$app])) {
                $apps[$app] = [
                    'app' => $app,
                    'memory' => $memory,
                    'count' => 0,
                    'percent' => 0,
                ];
            }

            $apps[$app]['percent'] += floatval(str_replace(',', '.', $line[8]));
            $apps[$app]['count']++;
        }

        return $apps;
    }

    /**
     * @param array $apps
     *
     * @return array
     */
    protected function summary(array $apps): array
    {
        foreach ($apps as $index => $app) {
            $app[$index]['percent'] = round($app['percent'] / $app['count'], 2);
        }

        return $apps;
    }

    /**
     * @param array $apps
     *
     * @return array
     */
    protected function sort(array $apps): array
    {
        usort($apps, static fn ($a, $b) => ($b['percent'] <=> $a['percent']) ?: ($b['memory'] <=> $a['memory']));

        return $apps;
    }

    /**
     * @param array $apps
     *
     * @return array
     */
    protected function limit(array $apps): array
    {
        return array_slice($apps, 0, 10);
    }
}

```

`app/Domains/Monitor/Service/System/Disk.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Service\System;

use App\Services\Command\Exec;

class Disk extends SystemAbstract
{
    /**
     * @var int
     */
    protected int $size;

    /**
     * @var int
     */
    protected int $load;

    /**
     * @var int
     */
    protected int $free;

    /**
     * @var int
     */
    protected int $percent;

    /**
     * @var array
     */
    protected array $mounts;

    /**
     * @return self
     */
    public function __construct()
    {
        $this->load();
        $this->mounts();
    }

    /**
     * @return ?array
     */
    public function get(): ?array
    {
        if ($this->isAvailable() === false) {
            return null;
        }

        return [
            'size' => $this->size,
            'load' => $this->load,
            'free' => $this->free,
            'percent' => $this->percent,
            'mounts' => $this->mounts,
        ];
    }

    /**
     * @return bool
     */
    protected function isAvailable(): bool
    {
        return isset(
            $this->size,
            $this->load,
            $this->free,
            $this->percent,
        );
    }

    /**
     * @return void
     */
    protected function load(): void
    {
        $info = Exec::cmdArrayInt('df . | sed 1d');

        if (isset($info[1], $info[2], $info[3], $info[4]) === false) {
            return;
        }

        $this->size = $info[1] * 1024;
        $this->load = $info[2] * 1024;
        $this->free = $info[3] * 1024;
        $this->percent = $info[4];
    }

    /**
     * @return void
     */
    protected function mounts(): void
    {
        $this->mounts = $this->sort($this->acum($this->lines($this->df())));
    }

    /**
     * @return string
     */
    protected function df(): string
    {
        return Exec::cmd('df | grep -v tmpfs');
    }

    /**
     * @param string $output
     *
     * @return array
     */
    protected function lines(string $output): array
    {
        return array_filter(explode("\n", trim($output)));
    }

    /**
     * @param array $lines
     *
     * @return array
     */
    protected function acum(array $lines): array
    {
        array_shift($lines);

        $mounts = [];

        foreach ($lines as $line) {
            $parts = explode(' ', trim(preg_replace('/\s+/', ' ', $line)), 6);

            if (count($parts) !== 6) {
                continue;
            }

            $mounts[] = [
                'dev' => $parts[0],
                'size' => intval($parts[1]) * 1024,
                'load' => intval($parts[2]) * 1024,
                'free' => intval($parts[3]) * 1024,
                'percent' => intval($parts[4]),
                'path' => $parts[5],
            ];
        }

        return $mounts;
    }

    /**
     * @param array $mounts
     *
     * @return array
     */
    protected function sort(array $mounts): array
    {
        usort($mounts, static fn ($a, $b) => $b['percent'] <=> $a['percent']);

        return $mounts;
    }
}

```

`app/Domains/Monitor/Service/System/Memory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Service\System;

use App\Services\Command\Exec;

class Memory extends SystemAbstract
{
    /**
     * @var int
     */
    protected int $size;

    /**
     * @var float
     */
    protected float $load;

    /**
     * @var float
     */
    protected float $free;

    /**
     * @var float
     */
    protected float $percent;

    /**
     * @var array
     */
    protected array $apps;

    /**
     * @return self
     */
    public function __construct()
    {
        $this->load();
        $this->apps();
    }

    /**
     * @return ?array
     */
    public function get(): ?array
    {
        if ($this->isAvailable() === false) {
            return null;
        }

        return [
            'size' => $this->size,
            'load' => $this->load,
            'free' => $this->free,
            'percent' => $this->percent,
            'apps' => $this->apps,
        ];
    }

    /**
     * @return bool
     */
    protected function isAvailable(): bool
    {
        return isset(
            $this->size,
            $this->load,
            $this->free,
            $this->percent,
            $this->apps,
        );
    }

    /**
     * @return void
     */
    protected function load(): void
    {
        $info = Exec::cmdArrayInt('free -b | grep "Mem:"');

        if (isset($info[1], $info[2], $info[6]) === false) {
            return;
        }

        $this->size = $info[1];
        $this->load = $info[2];
        $this->free = $info[6];
        $this->percent = intval(round($this->load / $this->size * 100));
    }

    /**
     * @return void
     */
    protected function apps(): void
    {
        $this->apps = $this->summary(
            $this->limit(
                $this->sort(
                    $this->acum(
                        array_slice($this->top(), 7)
                    )
                )
            )
        );
    }

    /**
     * @param array $lines
     *
     * @return array
     */
    protected function acum(array $lines): array
    {
        $apps = [];

        foreach ($lines as $line) {
            $size = $this->memorySize($line[5]);

            if ($size === 0) {
                continue;
            }

            $app = trim($line[11]);

            if (empty($apps[$app])) {
                $apps[$app] = [
                    'app' => $app,
                    'size' => 0,
                    'percent' => 0,
                ];
            }

            $apps[$app]['size'] += ($size - $this->memorySize($line[6]));
        }

        return $apps;
    }

    /**
     * @param array $apps
     *
     * @return array
     */
    protected function summary(array $apps): array
    {
        foreach ($apps as $index => $app) {
            $apps[$index]['percent'] = round($app['size'] * 100 / $this->size);
        }

        return $apps;
    }

    /**
     * @param array $apps
     *
     * @return array
     */
    protected function sort(array $apps): array
    {
        usort($apps, static fn ($a, $b) => $b['size'] <=> $a['size']);

        return $apps;
    }

    /**
     * @param array $apps
     *
     * @return array
     */
    protected function limit(array $apps): array
    {
        return array_slice($apps, 0, 10);
    }
}

```

`app/Domains/Monitor/Service/System/Summary.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Service\System;

class Summary extends SystemAbstract
{
    /**
     * @var string
     */
    protected string $uptime;

    /**
     * @var string
     */
    protected string $tasks;

    /**
     * @var string
     */
    protected string $cpus;

    /**
     * @var string
     */
    protected string $memory;

    /**
     * @var string
     */
    protected string $swap;

    /**
     * @return self
     */
    public function __construct()
    {
        $this->load();
    }

    /**
     * @return ?array
     */
    public function get(): ?array
    {
        if ($this->isAvailable() === false) {
            return null;
        }

        return [
            'uptime' => $this->uptime,
            'tasks' => $this->tasks,
            'cpus' => $this->cpus,
            'memory' => $this->memory,
            'swap' => $this->swap,
        ];
    }

    /**
     * @return bool
     */
    protected function isAvailable(): bool
    {
        return isset(
            $this->uptime,
            $this->tasks,
            $this->cpus,
            $this->memory,
            $this->swap,
        );
    }

    /**
     * @return void
     */
    protected function load(): void
    {
        $info = array_slice($this->top(), 0, 5);

        if (isset($info[0], $info[1], $info[2], $info[3], $info[4]) === false) {
            return;
        }

        $this->uptime = implode(' ', array_slice($info[0], 2));
        $this->tasks = implode(' ', $info[1]);
        $this->cpus = implode(' ', $info[2]);
        $this->memory = implode(' ', $info[3]);
        $this->swap = implode(' ', $info[4]);
    }
}

```

`app/Domains/Monitor/Service/System/SystemAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Service\System;

use App\Services\Command\Exec;

abstract class SystemAbstract
{
    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param string $size
     *
     * @return int
     */
    protected function memorySize(string $size): int
    {
        if ($size === '0') {
            return 0;
        }

        if (is_numeric($size)) {
            return intval($size * 1024);
        }

        $unit = substr($size, -1);
        $size = floatval(substr(str_replace(',', '.', $size), 0, -1)) * 1024;

        return match ($unit) {
            'm' => intval($size * 1024),
            'g' => intval($size * 1024 * 1024),
            't' => intval($size * 1024 * 1024 * 1024),
            'p' => intval($size * 1024 * 1024 * 1024),
            default => intval($size),
        };
    }

    /**
     * @return array
     */
    protected function top(): array
    {
        static $cache;

        return $cache ??= Exec::cmdLinesArray('top -b -w 512 -n 1');
    }
}

```

`app/Domains/Monitor/Validate/QueueFailedRetry.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class QueueFailedRetry extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'id' => ['bail', 'integer', 'required'],
        ];
    }
}

```

`app/Domains/Monitor/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Monitor\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Position/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\Position\Model\Position as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Position\Model\Position
     */
    protected ?Model $row;
}

```

`app/Domains/Position/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Position\Model\Position as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Position\Model\Position
     */
    protected ?Model $row;

    /**
     * @return void
     */
    public function create(): void
    {
        $this->actionHandle(Create::class, $this->validate()->create());
    }

    /**
     * @return \App\Domains\Position\Model\Position
     */
    public function updateCity(): Model
    {
        return $this->actionHandle(UpdateCity::class);
    }

    /**
     * @return void
     */
    public function updateCityEmpty(): void
    {
        $this->actionHandle(UpdateCityEmpty::class);
    }
}

```

`app/Domains/Position/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Action;

use App\Domains\Alarm\Job\CheckPosition as AlarmCheckPositionJob;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Position\Job\UpdateCity as UpdateCityJob;
use App\Domains\Position\Model\Position as Model;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\Trip\Model\Trip as TripModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;
use App\Services\Filesystem\Directory;

class Create extends ActionAbstract
{
    /**
     * @var string
     */
    protected string $uuid;

    /**
     * @var ?\App\Domains\Device\Model\Device
     */
    protected ?DeviceModel $device;

    /**
     * @var \App\Domains\Vehicle\Model\Vehicle
     */
    protected VehicleModel $vehicle;

    /**
     * @var \App\Domains\Timezone\Model\Timezone
     */
    protected TimezoneModel $timezone;

    /**
     * @var \App\Domains\Trip\Model\Trip
     */
    protected TripModel $trip;

    /**
     * @var ?\App\Domains\Position\Model\Position
     */
    protected ?Model $previous = null;

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->uuid();
        $this->device();

        if ($this->isValidDevice() === false) {
            return;
        }

        $this->deviceConnected();
        $this->vehicle();
        $this->timezone();
        $this->data();
        $this->previous();

        if ($this->isValid() === false) {
            return;
        }

        $this->trip();
        $this->save();
        $this->job();
    }

    /**
     * @return void
     */
    protected function uuid(): void
    {
        $this->uuid = uniqid();
    }

    /**
     * @return void
     */
    protected function device(): void
    {
        $this->device = DeviceModel::query()
            ->bySerial($this->data['serial'])
            ->enabled()
            ->first();
    }

    /**
     * @return bool
     */
    protected function isValidDevice(): bool
    {
        return boolval($this->device?->vehicle?->enabled);
    }

    /**
     * @return void
     */
    protected function deviceConnected(): void
    {
        $this->device->connected_at = date('Y-m-d H:i:s');
        $this->device->save();
    }

    /**
     * @return void
     */
    protected function vehicle(): void
    {
        $this->vehicle = $this->device->vehicle;
    }

    /**
     * @return void
     */
    protected function timezone(): void
    {
        $this->timezone = $this->timezoneByLatitudeLongitude()
            ?: $this->timezoneByZone()
            ?: $this->vehicle->timezone;
    }

    /**
     * @return ?\App\Domains\Timezone\Model\Timezone
     */
    protected function timezoneByLatitudeLongitude(): ?TimezoneModel
    {
        if ($this->vehicle->timezone_auto === false) {
            return null;
        }

        return TimezoneModel::query()
            ->byLatitudeLongitude($this->data['latitude'], $this->data['longitude'])
            ->first();
    }

    /**
     * @return ?\App\Domains\Timezone\Model\Timezone
     */
    protected function timezoneByZone(): ?TimezoneModel
    {
        if ($this->vehicle->timezone_auto === false) {
            return null;
        }

        return TimezoneModel::query()
            ->byZone($this->data['timezone'])
            ->first();
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataPoint();
        $this->dataTimezoneId();
        $this->dataDateAt();
        $this->dataSpeed();
        $this->dataDebug();
    }

    /**
     * @return void
     */
    protected function dataPoint(): void
    {
        $this->data['point'] = Model::pointFromLatitudeLongitude($this->data['latitude'], $this->data['longitude']);
    }

    /**
     * @return void
     */
    protected function dataTimezoneId(): void
    {
        $this->data['timezone_id'] = $this->timezone->id;
    }

    /**
     * @return void
     */
    protected function dataDateAt(): void
    {
        $this->data['date_at'] = helper()->dateUtcToTimezone('Y-m-d H:i:s', $this->data['date_utc_at'], $this->timezone->zone);
    }

    /**
     * @return void
     */
    protected function dataSpeed(): void
    {
        if ($this->data['speed'] > 999) {
            $this->data['speed'] = 0;
        }
    }

    /**
     * @return void
     */
    protected function dataDebug(): void
    {
        $this->logDebug('DATA', $this->data);
    }

    /**
     * @return void
     */
    protected function previous(): void
    {
        $this->previous = Model::query()
            ->byDeviceId($this->device->id)
            ->byDateUtcAtBeforeEqualNear($this->data['date_utc_at'])
            ->first();
    }

    /**
     * @return bool
     */
    protected function isValid(): bool
    {
        if ($this->isValidSignal() === false) {
            return $this->logDebug('isValidSignal', 'false', false);
        }

        if ($this->isValidNotExists() === false) {
            return $this->logDebug('isValidNotExists', 'false', false);
        }

        if ($this->isValidPreviousDifferent() === false) {
            return $this->logDebug('isValidPreviousDifferent', 'false', false);
        }

        if ($this->isValidPreviousFilterDistance() === false) {
            return $this->logDebug('isValidPreviousFilterDistance', 'false', false);
        }

        if ($this->isValidPreviousFilterTime() === false) {
            return $this->logDebug('isValidPreviousFilterTime', 'false', false);
        }

        return true;
    }

    /**
     * @return bool
     */
    protected function isValidSignal(): bool
    {
        return $this->data['signal']
            || (app('configuration')->bool('position_filter_signal') === false);
    }

    /**
     * @return bool
     */
    protected function isValidNotExists(): bool
    {
        return Model::query()
            ->byDeviceId($this->device->id)
            ->byDateUtcAt($this->data['date_utc_at'])
            ->count() === 0;
    }

    /**
     * @return bool
     */
    protected function isValidPreviousDifferent(): bool
    {
        if (empty($this->previous)) {
            return true;
        }

        $this->logDebug('PREVIOUS', $this->previous->toArray());

        return ((string)$this->previous->speed !== (string)$this->data['speed'])
            || ((string)$this->previous->latitude !== (string)$this->data['latitude'])
            || ((string)$this->previous->longitude !== (string)$this->data['longitude'])
            || ((string)$this->previous->direction !== (string)$this->data['direction']);
    }

    /**
     * @return bool
     */
    protected function isValidPreviousFilterDistance(): bool
    {
        if (empty($this->previous)) {
            return true;
        }

        $distance = $this->device->config('position_filter_distance');

        if ($distance === 0) {
            return true;
        }

        if ($this->isValidPreviousFilterDistanceMovement()) {
            return true;
        }

        return helper()->coordinatesDistance(
            $this->previous->latitude,
            $this->previous->longitude,
            $this->data['latitude'],
            $this->data['longitude'],
        ) >= $this->isValidPreviousFilterDistanceReference($distance);
    }

    /**
     * @return bool
     */
    protected function isValidPreviousFilterDistanceMovement(): bool
    {
        return boolval($this->previous->speed) !== boolval($this->data['speed']);
    }

    /**
     * @param int $distance
     *
     * @return int
     */
    protected function isValidPreviousFilterDistanceReference(int $distance): int
    {
        $speed = $this->data['speed'];

        if ($speed === 0.0) {
            return $distance;
        }

        $multiplier = $this->device->config('position_filter_distance_multiplier');

        if ($multiplier === 0) {
            return $distance;
        }

        $factor = 1.0 + ((100 + $multiplier) / 100.0) * (($speed / 100.0) - 1.0);
        $distance = intval(round($distance * $factor));

        if ($distance < 1) {
            $distance = 1;
        }

        return $distance;
    }

    /**
     * @return bool
     */
    protected function isValidPreviousFilterTime(): bool
    {
        if (empty($this->previous)) {
            return true;
        }

        $time = $this->device->config('position_filter_time');

        if ($time === 0) {
            return true;
        }

        return (strtotime($this->data['date_utc_at']) - strtotime($this->previous->date_utc_at)) > $time;
    }

    /**
     * @return void
     */
    protected function trip(): void
    {
        $this->trip = $this->factory('Trip')->action($this->tripData())->lastOrNew();
    }

    /**
     * @return array
     */
    protected function tripData(): array
    {
        return [
            'date_at' => $this->data['date_at'],
            'date_utc_at' => $this->data['date_utc_at'],
            'speed' => $this->data['speed'],
            'device_id' => $this->device->id,
            'timezone_id' => $this->timezone->id,
        ];
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveRow();
        $this->saveTrip();
        $this->saveDebug();
    }

    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->row = Model::query()->create([
            'point' => $this->data['point'],
            'speed' => $this->data['speed'],
            'direction' => $this->data['direction'],
            'signal' => $this->data['signal'],
            'date_at' => $this->data['date_at'],
            'date_utc_at' => $this->data['date_utc_at'],

            'device_id' => $this->device->id,
            'timezone_id' => $this->timezone->id,
            'trip_id' => $this->trip->id,
            'user_id' => $this->device->user_id,
            'vehicle_id' => $this->vehicle->id,
        ]);
    }

    /**
     * @return void
     */
    protected function saveTrip(): void
    {
        $this->factory('Trip', $this->trip)->action()->updateNameDistanceTime();
    }

    /**
     * @return void
     */
    protected function saveDebug(): void
    {
        if ($this->data['debug']) {
            $this->logDebug('ROW', $this->row->fresh()->toArray());
        }
    }

    /**
     * @return void
     */
    protected function job(): void
    {
        $this->jobAlarm();
        $this->jobCity();
    }

    /**
     * @return void
     */
    protected function jobAlarm(): void
    {
        AlarmCheckPositionJob::dispatch($this->row->id);
    }

    /**
     * @return void
     */
    protected function jobCity(): void
    {
        UpdateCityJob::dispatch($this->row->id);
    }

    /**
     * @param string $title
     * @param mixed $message
     * @param mixed $return = null
     *
     * @return mixed
     */
    protected function logDebug(string $title, mixed $message, mixed $return = null): mixed
    {
        if (empty($this->data['debug'])) {
            return $return;
        }

        $file = $this->logDebugFile();

        Directory::create($file, true);

        file_put_contents($file, $this->logDebugContent($title, $message), LOCK_EX | FILE_APPEND);

        return $return;
    }

    /**
     * @return string
     */
    protected function logDebugFile(): string
    {
        return base_path('storage/logs/position/'.date('Y/m/Y-m-d').'.log');
    }

    /**
     * @param string $title
     * @param mixed $message
     *
     * @return string
     */
    protected function logDebugContent(string $title, mixed $message): string
    {
        if ($message && (is_scalar($message) === false)) {
            $message = json_encode($message, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
        }

        return '['.$this->logDebugContentTimestamp().'] ['.$this->uuid.'] ['.$title.'] '.$message."\n";
    }

    /**
     * @return string
     */
    protected function logDebugContentTimestamp(): string
    {
        return date_create()->format('Y-m-d H:i:s.v P');
    }
}

```

`app/Domains/Position/Action/UpdateCity.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Action;

use App\Domains\City\Model\City as CityModel;
use App\Domains\Position\Model\Position as Model;

class UpdateCity extends ActionAbstract
{
    /**
     * @var ?\App\Domains\City\Model\City
     */
    protected ?CityModel $city;

    /**
     * @return \App\Domains\Position\Model\Position
     */
    public function handle(): Model
    {
        if ($this->row->city_id) {
            return $this->row;
        }

        $this->city();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function city(): void
    {
        $this->city = $this->factory('City')->action($this->cityData())->getOrNew();
    }

    /**
     * @return array
     */
    protected function cityData(): array
    {
        return [
            'latitude' => $this->row->latitude,
            'longitude' => $this->row->longitude,
        ];
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        if (empty($this->city)) {
            return;
        }

        $this->row->city_id = $this->city->id;
        $this->row->save();
    }
}

```

`app/Domains/Position/Action/UpdateCityEmpty.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Action;

use App\Domains\Position\Job\UpdateCity as UpdateCityJob;
use App\Domains\Position\Model\Position as Model;

class UpdateCityEmpty extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->iterate();
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->ids() as $id) {
            UpdateCityJob::dispatch($id);
        }
    }

    /**
     * @return array
     */
    protected function ids(): array
    {
        return Model::query()
            ->withoutCity()
            ->orderByDateUtcAtDesc()
            ->pluck('id')
            ->all();
    }
}

```

`app/Domains/Position/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Command;

use App\Domains\CoreApp\Command\CommandAbstract as CommandAbstractSahred;
use App\Domains\Position\Model\Position as Model;

abstract class CommandAbstract extends CommandAbstractSahred
{
    /**
     * @var \App\Domains\Position\Model\Position
     */
    protected Model $row;

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = Model::query()->findOrFail($this->checkOption('id'));
    }
}

```

`app/Domains/Position/Command/UpdateCity.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Command;

class UpdateCity extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'position:update:city {--id=}';

    /**
     * @var string
     */
    protected $description = 'Update Position with Empty City';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->checkOptions(['id']);
        $this->requestWithOptions();

        $this->row();

        $this->factory()->action()->updateCity();

        $this->info('[END]');
    }
}

```

`app/Domains/Position/Command/UpdateCityEmpty.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Command;

class UpdateCityEmpty extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'position:update:city:empty';

    /**
     * @var string
     */
    protected $description = 'Update All Positions with Empty City';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->factory()->action()->updateCityEmpty();

        $this->info('[END]');
    }
}

```

`app/Domains/Position/ControllerApi/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\ControllerApi;

use App\Domains\CoreApp\Controller\ControllerApiAbstract as CoreControllerApiAbstract;

abstract class ControllerApiAbstract extends CoreControllerApiAbstract
{
}

```

`app/Domains/Position/ControllerApi/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\ControllerApi;

use Illuminate\Http\JsonResponse;
use Illuminate\Pagination\LengthAwarePaginator;
use App\Domains\Position\ControllerApi\Service\Index as ControllerService;

class Index extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('api', $this->data()));
    }

    /**
     * @return \Illuminate\Pagination\LengthAwarePaginator
     */
    protected function data(): LengthAwarePaginator
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Position/ControllerApi/Service/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\ControllerApi\Service;

use App\Domains\CoreApp\ControllerApi\Service\ControllerApiAbstract as CoreAppControllerApiAbstract;

abstract class ControllerApiAbstract extends CoreAppControllerApiAbstract
{
}

```

`app/Domains/Position/ControllerApi/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Pagination\LengthAwarePaginator;
use Illuminate\Http\Request;
use App\Domains\Position\Model\Position as Model;

class Index extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return \Illuminate\Pagination\LengthAwarePaginator
     */
    public function data(): LengthAwarePaginator
    {
        return Model::query()
            ->byUserOrManager($this->auth)
            ->whenUserId($this->requestInteger('user_id'))
            ->whenVehicleId($this->requestInteger('vehicle_id'))
            ->whenDeviceId($this->requestInteger('device_id'))
            ->whenTripId($this->requestInteger('trip_id'))
            ->whenDateAtBetween($this->request->input('start_at'), $this->request->input('end_at'))
            ->listSimple()
            ->withRelations($this->requestArray('with'))
            ->paginate(min($this->requestInteger('limit', 100), 1000));
    }
}

```

`app/Domains/Position/ControllerApi/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\ControllerApi;

use Illuminate\Support\Facades\Route;

Route::get('/position', Index::class)->name('position.index');

```

`app/Domains/Position/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\Position\Model\Position as Model;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\Position\Model\Position $row
     *
     * @return array
     */
    protected function api(Model $row): array
    {
        return [
            'id' => $row->id,
            'latitude' => $row->latitude,
            'longitude' => $row->longitude,
            'speed' => helper()->unit('speed', $row->speed),
            'direction' => $row->direction,
            'signal' => $row->signal,
            'date_at' => $row->date_at,
            'date_utc_at' => $row->date_utc_at,
            'city' => $this->fromIfLoaded('City', 'related', $row, 'city'),
            'device' => $this->fromIfLoaded('Device', 'related', $row, 'device'),
            'timezone' => $this->fromIfLoaded('Timezone', 'related', $row, 'timezone'),
            'trip' => $this->fromIfLoaded('Trip', 'related', $row, 'trip'),
            'user' => $this->fromIfLoaded('User', 'related', $row, 'user'),
            'vehicle' => $this->fromIfLoaded('Vehicle', 'related', $row, 'vehicle'),
        ];
    }

    /**
     * @param \App\Domains\Position\Model\Position $row
     *
     * @return array
     */
    protected function json(Model $row): array
    {
        return [
            'id' => $row->id,
            'date_at' => $row->date_at,
            'date_utc_at' => $row->date_utc_at,
            'latitude' => $row->latitude,
            'longitude' => $row->longitude,
            'direction' => $row->direction,
            'speed' => helper()->unit('speed', $row->speed),
            'city' => $this->from('City', 'related', $row->city),
            'state' => $this->from('State', 'related', $row->city?->state),
            'country' => $this->from('Country', 'related', $row->city?->country),
        ];
    }

    /**
     * @param \App\Domains\Position\Model\Position $row
     *
     * @return array
     */
    protected function map(Model $row): array
    {
        return [
            'id' => $row->id,
            'date_at' => $row->date_at,
            'latitude' => $row->latitude,
            'longitude' => $row->longitude,
            'direction' => $row->direction,
            'speed' => helper()->unit('speed', $row->speed),
            'speed_human' => helper()->unitHuman('speed', $row->speed),
            'city' => $row->city?->name,
            'state' => $row->city?->state?->name,
        ];
    }

    /**
     * @param \App\Domains\Position\Model\Position $row
     *
     * @return array
     */
    protected function related(Model $row): array
    {
        return [
            'id' => $row->id,
            'date_at' => $row->date_at,
            'date_utc_at' => $row->date_utc_at,
            'latitude' => $row->latitude,
            'longitude' => $row->longitude,
            'speed' => $row->speed,
            'direction' => $row->direction,
        ];
    }
}

```

`app/Domains/Position/Job/JobAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Job;

use App\Domains\Core\Job\JobAbstract as JobAbstractCore;
use App\Domains\Position\Model\Position as Model;

abstract class JobAbstract extends JobAbstractCore
{
    /**
     * @var \App\Domains\Position\Model\Position
     */
    protected Model $row;

    /**
     * @param int $id
     *
     * @return void
     */
    public function __construct(protected int $id)
    {
    }

    /**
     * @return array
     */
    public function middleware(): array
    {
        return [$this->middlewareWithoutOverlapping()];
    }

    /**
     * @return \App\Domains\Position\Model\Position
     */
    protected function row(): Model
    {
        return $this->rowOrDeleteAndException(Model::class);
    }
}

```

`app/Domains/Position/Job/UpdateCity.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Job;

class UpdateCity extends JobAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->factory(row: $this->row())->action()->updateCity();
    }
}

```

`app/Domains/Position/Model/Builder/Position.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Model\Builder;

use App\Domains\City\Model\City as CityModel;
use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\CoreApp\Model\Builder\Traits\Gis as GisTrait;
use App\Domains\Refuel\Model\Refuel as RefuelModel;
use App\Domains\Trip\Model\Builder\Trip as TripBuilder;
use App\Domains\Trip\Model\Trip as TripModel;

class Position extends BuilderAbstract
{
    use GisTrait;

    /**
     * @param int $city_id
     *
     * @return self
     */
    public function byCityId(int $city_id): self
    {
        return $this->where('city_id', $city_id);
    }

    /**
     * @param array $city_ids
     *
     * @return self
     */
    public function byCityIds(array $city_ids): self
    {
        return $this->whereIntegerInRaw('city_id', $city_ids);
    }

    /**
     * @param int $country_id
     *
     * @return self
     */
    public function byCountryId(int $country_id): self
    {
        return $this->whereIn('city_id', CityModel::query()->select('id')->byCountryId($country_id));
    }

    /**
     * @param array $country_ids
     *
     * @return self
     */
    public function byCountryIds(array $country_ids): self
    {
        return $this->whereIn('city_id', CityModel::query()->select('id')->byCountryIds($country_ids));
    }

    /**
     * @param string $date_at
     *
     * @return self
     */
    public function byDateAtAfterEqual(string $date_at): self
    {
        return $this->where('date_at', '>=', $date_at);
    }

    /**
     * @param string $date_at
     *
     * @return self
     */
    public function byDateAtBeforeEqual(string $date_at): self
    {
        return $this->where('date_at', '<=', $date_at);
    }

    /**
     * @param string $date_at
     *
     * @return self
     */
    public function byDateAtBeforeEqualNear(string $date_at): self
    {
        return $this->byDateAtBeforeEqual($date_at)->orderByDateAtDesc();
    }

    /**
     * @param string $date_utc_at
     *
     * @return self
     */
    public function byDateUtcAt(string $date_utc_at): self
    {
        return $this->where('date_utc_at', $date_utc_at);
    }

    /**
     * @param string $date_utc_at
     *
     * @return self
     */
    public function byDateUtcAtAfter(string $date_utc_at): self
    {
        return $this->where('date_utc_at', '>', $date_utc_at);
    }

    /**
     * @param string $date_utc_at
     *
     * @return self
     */
    public function byDateUtcAtAfterEqual(string $date_utc_at): self
    {
        return $this->where('date_utc_at', '>=', $date_utc_at);
    }

    /**
     * @param string $date_utc_at
     *
     * @return self
     */
    public function byDateUtcAtBeforeEqual(string $date_utc_at): self
    {
        return $this->where('date_utc_at', '<=', $date_utc_at);
    }

    /**
     * @param string $date_utc_at
     *
     * @return self
     */
    public function byDateUtcAtBeforeEqualNear(string $date_utc_at): self
    {
        return $this->byDateUtcAtBeforeEqual($date_utc_at)->orderByDateUtcAtDesc();
    }

    /**
     * @param int $device_id
     * @param ?string $before_start_at
     * @param ?string $after_start_at
     * @param ?string $start_end
     *
     * @return self
     */
    public function byDeviceIdWhenTripStartAtDateBetween(int $device_id, ?string $before_start_at, ?string $after_start_at, ?string $start_end): self
    {
        return $this->byDeviceId($device_id)
            ->whenTripStartAtDateBetween($before_start_at, $after_start_at)
            ->whenTripStartEnd($start_end);
    }

    /**
     * @param int $device_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     * @param ?string $start_end
     *
     * @return self
     */
    public function byDeviceIdWhenTripStartUtcAtDateBetween(int $device_id, ?string $before_start_utc_at, ?string $after_start_utc_at, ?string $start_end): self
    {
        return $this->byDeviceId($device_id)
            ->whenTripStartUtcAtDateBetween($before_start_utc_at, $after_start_utc_at)
            ->whenTripStartEnd($start_end);
    }

    /**
     * @param float $latitude
     * @param float $longitude
     * @param float $radius
     *
     * @return self
     */
    public function byFence(float $latitude, float $longitude, float $radius): self
    {
        return $this->inRadius($latitude, $longitude, intval($radius * 1000));
    }

    /**
     * @param int $state_id
     *
     * @return self
     */
    public function byStateId(int $state_id): self
    {
        return $this->whereIn('city_id', CityModel::query()->select('id')->byStateId($state_id));
    }

    /**
     * @param array $state_ids
     *
     * @return self
     */
    public function byStateIds(array $state_ids): self
    {
        return $this->whereIn('city_id', CityModel::query()->select('id')->byStateIds($state_ids));
    }

    /**
     * @param int $trip_id
     *
     * @return self
     */
    public function byTripId(int $trip_id): self
    {
        return $this->where('trip_id', $trip_id);
    }

    /**
     * @param array $trip_ids
     *
     * @return self
     */
    public function byTripIds(array $trip_ids): self
    {
        return $this->whereIntegerInRaw('trip_id', $trip_ids);
    }

    /**
     * @param \App\Domains\Trip\Model\Builder\Trip $query
     *
     * @return self
     */
    public function byTripQuery(TripBuilder $query): self
    {
        return $this->whereIn('trip_id', $query->select('id'));
    }

    /**
     * @param ?string $before_start_at
     * @param ?string $after_start_at
     *
     * @return self
     */
    public function byTripStartAtDateBetween(?string $before_start_at, ?string $after_start_at): self
    {
        return $this->whereIn('trip_id', TripModel::query()->select('id')->whenStartAtDateBetween($before_start_at, $after_start_at));
    }

    /**
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     *
     * @return self
     */
    public function byTripStartUtcAtDateBetween(?string $before_start_utc_at, ?string $after_start_utc_at): self
    {
        return $this->whereIn('trip_id', TripModel::query()->select('id')->whenStartUtcAtDateBetween($before_start_utc_at, $after_start_utc_at));
    }

    /**
     * @param int $vehicle_id
     * @param ?string $before_start_at
     * @param ?string $after_start_at
     * @param ?string $start_end
     *
     * @return self
     */
    public function byVehicleIdWhenTripStartAtDateBetween(int $vehicle_id, ?string $before_start_at, ?string $after_start_at, ?string $start_end): self
    {
        return $this->byVehicleId($vehicle_id)
            ->whenTripStartAtDateBetween($before_start_at, $after_start_at)
            ->whenTripStartEnd($start_end);
    }

    /**
     * @param int $vehicle_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     * @param ?string $start_end
     *
     * @return self
     */
    public function byVehicleIdWhenTripStartUtcAtDateBetween(int $vehicle_id, ?string $before_start_utc_at, ?string $after_start_utc_at, ?string $start_end): self
    {
        return $this->byVehicleId($vehicle_id)
            ->whenTripStartUtcAtDateBetween($before_start_utc_at, $after_start_utc_at)
            ->whenTripStartEnd($start_end);
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderByDateUtcAtAsc();
    }

    /**
     * @return self
     */
    public function listSimple(): self
    {
        return $this->selectSimple()->orderByDateUtcAtDesc();
    }

    /**
     * @return self
     */
    public function orderByDateAtDesc(): self
    {
        return $this->orderBy('date_at', 'DESC');
    }

    /**
     * @param string $date_at
     *
     * @return self
     */
    public function orderByDateAtNearest(string $date_at): self
    {
        return $this->orderByRaw('ABS(TIMESTAMPDIFF(SECOND, `date_at`, ?)) ASC', [$date_at]);
    }

    /**
     * @return self
     */
    public function orderByDateUtcAtAsc(): self
    {
        return $this->orderBy('date_utc_at', 'ASC');
    }

    /**
     * @return self
     */
    public function orderByDateUtcAtDesc(): self
    {
        return $this->orderBy('date_utc_at', 'DESC')->orderBy('id', 'DESC');
    }

    /**
     * @return self
     */
    public function selectBoundingBox(): self
    {
        return $this->selectRaw('
            MIN(`position`.`latitude`) AS `latitude_min`,
            MIN(`position`.`longitude`) AS `longitude_min`,
            MAX(`position`.`latitude`) AS `latitude_max`,
            MAX(`position`.`longitude`) AS `longitude_max`
        ');
    }

    /**
     * @return self
     */
    public function selectSimple(): self
    {
        return $this->select(
            'id',
            'latitude',
            'longitude',
            'speed',
            'direction',
            'signal',
            'date_at',
            'date_utc_at',
            'city_id',
            'device_id',
            'timezone_id',
            'trip_id',
            'user_id',
            'vehicle_id'
        )->orderByDateUtcAtDesc();
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_date_at
     * @param ?string $after_date_at
     *
     * @return self
     */
    public function whenRefuelUserIdVehicleIdDateAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_date_at, ?string $after_date_at): self
    {
        return $this->whereIn('id', RefuelModel::query()->select('position_id')->whenUserIdVehicleIdDateAtBetween($user_id, $vehicle_id, $before_date_at, $after_date_at));
    }

    /**
     * @return self
     */
    public function selectRelated(): self
    {
        return $this->select('id', 'date_utc_at', 'longitude', 'latitude', 'trip_id')->orderByDateUtcAtAsc();
    }

    /**
     * @param ?string $start_at
     * @param ?string $end_at
     *
     * @return self
     */
    public function whenDateAtBetween(?string $start_at, ?string $end_at): self
    {
        return $this->whenDateAtAfter($start_at)->whenDateAtBefore($end_at);
    }

    /**
     * @param ?string $start_at
     *
     * @return self
     */
    public function whenDateAtAfter(?string $start_at): self
    {
        return $this->when($start_at, fn ($q) => $q->byDateAtAfterEqual($start_at));
    }

    /**
     * @param ?string $end_at
     *
     * @return self
     */
    public function whenDateAtBefore(?string $end_at): self
    {
        return $this->when($end_at, fn ($q) => $q->byDateAtBeforeEqual($end_at));
    }

    /**
     * @param ?string $start_at
     * @param ?string $end_at
     *
     * @return self
     */
    public function whenDateUtcAtBetween(?string $start_at, ?string $end_at): self
    {
        return $this->whenDateUtcAtAfter($start_at)->whenDateUtcAtBefore($end_at);
    }

    /**
     * @param ?string $start_at
     *
     * @return self
     */
    public function whenDateUtcAtAfter(?string $start_at): self
    {
        return $this->when($start_at, fn ($q) => $q->byDateUtcAtAfterEqual($start_at));
    }

    /**
     * @param ?string $end_at
     *
     * @return self
     */
    public function whenDateUtcAtBefore(?string $end_at): self
    {
        return $this->when($end_at, fn ($q) => $q->byDateUtcAtBeforeEqual($end_at));
    }

    /**
     * @param ?int $trip_id
     *
     * @return self
     */
    public function whenTripId(?int $trip_id): self
    {
        return $this->when($trip_id, fn ($q) => $q->byTripId($trip_id));
    }

    /**
     * @param ?string $start_end
     *
     * @return self
     */
    public function whenTripStartEnd(?string $start_end): self
    {
        return match ($start_end) {
            'start' => $this->whereTripStart(),
            'end' => $this->whereTripEnd(),
            default => $this,
        };
    }

    /**
     * @param ?string $before_start_at
     * @param ?string $after_start_at
     *
     * @return self
     */
    public function whenTripStartAtDateBetween(?string $before_start_at, ?string $after_start_at): self
    {
        return $this->when($before_start_at || $after_start_at, fn ($q) => $q->byTripStartAtDateBetween($before_start_at, $after_start_at));
    }

    /**
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     *
     * @return self
     */
    public function whenTripStartUtcAtDateBetween(?string $before_start_utc_at, ?string $after_start_utc_at): self
    {
        return $this->when($before_start_utc_at || $after_start_utc_at, fn ($q) => $q->byTripStartUtcAtDateBetween($before_start_utc_at, $after_start_utc_at));
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_start_at
     * @param ?string $after_start_at
     *
     * @return self
     */
    public function whenTripUserIdVehicleIdStartAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_start_at, ?string $after_start_at): self
    {
        return $this->whereIn('trip_id', TripModel::query()->select('id')->whenUserIdVehicleIdStartAtBetween($user_id, $vehicle_id, $before_start_at, $after_start_at));
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     *
     * @return self
     */
    public function whenTripUserIdVehicleIdStartUtcAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_start_utc_at, ?string $after_start_utc_at): self
    {
        return $this->whereIn('trip_id', TripModel::query()->select('id')->whenUserIdVehicleIdStartUtcAtBetween($user_id, $vehicle_id, $before_start_utc_at, $after_start_utc_at));
    }

    /**
     * @return self
     */
    public function whereTripEnd(): self
    {
        return $this->whereRaw('`date_utc_at` IN (SELECT MAX(`date_utc_at`) FROM `position` GROUP BY `trip_id`)');
    }

    /**
     * @return self
     */
    public function whereTripStart(): self
    {
        return $this->whereRaw('`date_utc_at` IN (SELECT MIN(`date_utc_at`) FROM `position` GROUP BY `trip_id`)');
    }

    /**
     * @return self
     */
    public function withCity(): self
    {
        return $this->with('city');
    }

    /**
     * @return self
     */
    public function withCityCountryState(): self
    {
        return $this->with(['city' => fn ($q) => $q->withCountry()->withState()]);
    }

    /**
     * @return self
     */
    public function withCityState(): self
    {
        return $this->with(['city' => fn ($q) => $q->withState()]);
    }

    /**
     * @return self
     */
    public function withoutCity(): self
    {
        return $this->whereNull('city_id');
    }

    /**
     * @return self
     */
    public function withDevice(): self
    {
        return $this->with('device');
    }

    /**
     * @param array $with
     *
     * @return self
     */
    public function withRelations(array $with): self
    {
        if (in_array('device', $with, true)) {
            $this->withSimple('device');
        }

        if (in_array('timezone', $with, true)) {
            $this->withSimple('timezone');
        }

        if (in_array('trip', $with, true)) {
            $this->withSimple('trip');
        }

        if (in_array('user', $with, true)) {
            $this->withSimple('user');
        }

        if (in_array('vehicle', $with, true)) {
            $this->withSimple('vehicle');
        }

        return $this;
    }

    /**
     * @return self
     */
    public function withTimezone(): self
    {
        return $this->with('timezone');
    }

    /**
     * @return self
     */
    public function withTrip(): self
    {
        return $this->with('trip');
    }

    /**
     * @return self
     */
    public function withVehicle(): self
    {
        return $this->with('vehicle');
    }
}

```

`app/Domains/Position/Model/Collection/Position.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Position extends CollectionAbstract
{
}

```

`app/Domains/Position/Model/Position.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use App\Domains\City\Model\City as CityModel;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\CoreApp\Model\Traits\Gis as GisTrait;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Position\Model\Builder\Position as Builder;
use App\Domains\Position\Model\Collection\Position as Collection;
use App\Domains\Position\Model\Traits\Query as QueryTrait;
use App\Domains\Position\Model\Traits\SelectRaw as SelectRawTrait;
use App\Domains\Position\Test\Factory\Position as TestFactory;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\Trip\Model\Trip as TripModel;
use App\Domains\User\Model\User as UserModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class Position extends ModelAbstract
{
    use GisTrait;
    use HasFactory;
    use QueryTrait;
    use SelectRawTrait;

    /**
     * @var string
     */
    protected $table = 'position';

    /**
     * @const string
     */
    public const TABLE = 'position';

    /**
     * @const string
     */
    public const FOREIGN = 'position_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'latitude' => 'float',
        'longitude' => 'float',
        'speed' => 'float',
        'direction' => 'integer',
        'signal' => 'integer',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\Position\Model\Collection\Position
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Position\Model\Builder\Position
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Position\Test\Factory\Position
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function city(): BelongsTo
    {
        return $this->belongsTo(CityModel::class, CityModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function device(): BelongsTo
    {
        return $this->belongsTo(DeviceModel::class, DeviceModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function timezone(): BelongsTo
    {
        return $this->belongsTo(TimezoneModel::class, TimezoneModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function trip(): BelongsTo
    {
        return $this->belongsTo(TripModel::class, TripModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(UserModel::class, UserModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(VehicleModel::class, VehicleModel::FOREIGN)->withTimezone();
    }

    /**
     * @return string
     */
    public function latitudeLongitudeUrl(): string
    {
        return sprintf('https://maps.google.com/?q=%s,%s', $this->latitude, $this->longitude);
    }

    /**
     * @return string
     */
    public function latitudeLongitudeLink(): string
    {
        return sprintf(
            '<a href="%s" rel="nofollow noopener noreferrer" target="_blank">%.5f,%.5f</a>',
            $this->latitudeLongitudeUrl(),
            $this->latitude,
            $this->longitude,
        );
    }

    /**
     * @return float
     */
    public function userSpeed(): float
    {
        return match ($this->user->preferences['units']['distance'] ?? null) {
            'knot' => $this->speed * 0.539957,
            'mile' => $this->speed * 0.621371,
            default => $this->speed,
        };
    }
}

```

`app/Domains/Position/Model/Traits/Query.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Model\Traits;

use App\Domains\Position\Model\Position as Model;
use App\Domains\Trip\Model\Builder\Trip as TripBuilder;

trait Query
{
    /**
     * @param \App\Domains\Trip\Model\Builder\Trip $tripBuilder
     *
     * @return array
     */
    public static function tripQueryBoundingBox(TripBuilder $tripBuilder): array
    {
        return (array)Model::query()
            ->selectBoundingBox()
            ->byTripQuery($tripBuilder)
            ->toBase()
            ->first();
    }
}

```

`app/Domains/Position/Model/Traits/SelectRaw.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Model\Traits;

use App\Domains\Trip\Model\Builder\Trip as TripBuilder;

trait SelectRaw
{
    /**
     * @param \App\Domains\Trip\Model\Builder\Trip $tripBuilder
     * @param array $bounding_box = []
     *
     * @return array
     */
    public static function heatmap(TripBuilder $tripBuilder, array $bounding_box = []): array
    {
        $bounding_box = static::heatmapBoundingBox($bounding_box ?: static::tripQueryBoundingBox($tripBuilder));

        if (empty($bounding_box)) {
            return [];
        }

        static::db()->unprepared('
            SET @boundingBox = ST_SRID(ST_MakeEnvelope(
                Point('.$bounding_box['longitude_min'].', '.$bounding_box['latitude_min'].'),
                Point('.$bounding_box['longitude_max'].', '.$bounding_box['latitude_max'].')
            ), 4326);

            SET @distance = ST_Distance_Sphere(
                Point('.$bounding_box['longitude_min'].', '.$bounding_box['latitude_min'].'),
                Point('.$bounding_box['longitude_max'].', '.$bounding_box['latitude_min'].')
            ) / 1000;

            SET @cellSize = GREATEST(0.00001, ROUND(0.00001 * @distance, 5));
        ');

        return static::db()->select('
            SELECT
                ROUND((`position`.`latitude` / @cellSize * @cellSize) + (@cellSize / 2), 5) AS `cell_y`,
                ROUND((`position`.`longitude` / @cellSize * @cellSize) + (@cellSize / 2), 5) AS `cell_x`,
                COUNT(*) AS `value`
            FROM `position`
            WHERE (
                `position`.`trip_id` IN ('.$tripBuilder->select('id')->toRawSql().')
                AND ST_Within(`position`.`point`, @boundingBox)
            )
            GROUP BY `cell_y`, `cell_x`
            ORDER BY `value` DESC
            LIMIT 10000;
        ');
    }

    /**
     * @param array $bounding_box
     *
     * @return ?array
     */
    public static function heatmapBoundingBox(array $bounding_box): ?array
    {
        if (empty($bounding_box)) {
            return null;
        }

        $bounding_box = [
            'latitude_min' => static::heatmapBoundingBoxValue($bounding_box, 'latitude_min'),
            'longitude_min' => static::heatmapBoundingBoxValue($bounding_box, 'longitude_min'),
            'latitude_max' => static::heatmapBoundingBoxValue($bounding_box, 'latitude_max'),
            'longitude_max' => static::heatmapBoundingBoxValue($bounding_box, 'longitude_max'),
        ];

        if (count($bounding_box) !== count(array_filter($bounding_box))) {
            return null;
        }

        return $bounding_box;
    }

    /**
     * @param array $bounding_box
     *
     * @return float
     */
    public static function heatmapBoundingBoxValue(array $bounding_box, string $key): float
    {
        $value = round(floatval($bounding_box[$key] ?? 0), 5);

        if (str_starts_with($key, 'latitude')) {
            $value = helper()->latitude($value);
        }

        if (str_starts_with($key, 'longitude')) {
            $value = helper()->longitude($value);
        }

        return $value;
    }
}

```

`app/Domains/Position/Schedule/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Schedule;

use App\Domains\Core\Schedule\ScheduleAbstract;
use App\Domains\Position\Command\UpdateCityEmpty as UpdateCityEmptyCommand;

class Manager extends ScheduleAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->command(UpdateCityEmptyCommand::class)->everyTenMinutes();
    }
}

```

`app/Domains/Position/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'serial' => ['bail', 'required', 'string'],
            'latitude' => ['bail', 'required', 'numeric', 'between:-90,90'],
            'longitude' => ['bail', 'required', 'numeric', 'between:-180,180'],
            'speed' => ['bail', 'required', 'numeric'],
            'direction' => ['bail', 'required', 'integer'],
            'signal' => ['bail', 'required', 'integer'],
            'date_utc_at' => ['bail', 'required', 'date_format:Y-m-d H:i:s'],
            'timezone' => ['bail', 'nullable'],

            'debug' => ['bail', 'boolean'],
        ];
    }
}

```

`app/Domains/Position/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Position\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Profile/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Action;

use App\Domains\Core\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\User\Model\User as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\User\Model\User
     */
    protected ?Model $row;
}

```

`app/Domains/Profile/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\User\Model\User as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\User\Model\User
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\User\Model\User
     */
    public function update(): Model
    {
        return $this->actionHandleTransaction(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\User\Model\User
     */
    public function updateTelegram(): Model
    {
        return $this->actionHandleTransaction(UpdateTelegram::class, $this->validate()->updateTelegram());
    }

    /**
     * @return \App\Domains\User\Model\User
     */
    public function updateTelegramChatId(): Model
    {
        return $this->actionHandleTransaction(UpdateTelegramChatId::class);
    }

    /**
     * @return \App\Domains\User\Model\User
     */
    public function updateTelegramTest(): Model
    {
        return $this->actionHandle(UpdateTelegramTest::class);
    }
}

```

`app/Domains/Profile/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Action;

use Illuminate\Support\Facades\Hash;
use App\Domains\Language\Model\Language as LanguageModel;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\User\Model\User as Model;

class Update extends ActionAbstract
{
    /**
     * @return \App\Domains\User\Model\User
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataName();
        $this->dataEmail();
        $this->dataPassword();
        $this->dataApiKey();
        $this->dataPreferences();
        $this->dataAdminMode();
        $this->dataManagerMode();
    }

    /**
     * @return void
     */
    protected function dataName(): void
    {
        $this->data['name'] = trim($this->data['name']);
    }

    /**
     * @return void
     */
    protected function dataEmail(): void
    {
        $this->data['email'] = strtolower($this->data['email']);
    }

    /**
     * @return void
     */
    protected function dataPassword(): void
    {
        if ($this->data['password']) {
            $this->data['password'] = Hash::make($this->data['password']);
        } else {
            $this->data['password'] = $this->row->password;
        }
    }

    /**
     * @return void
     */
    protected function dataApiKey(): void
    {
        if (helper()->uuidIsValid($this->data['api_key'])) {
            $this->dataApiKeyValid();
        } else {
            $this->dataApiKeyInvalid();
        }

        $this->dataApiKeyEnabled();
    }

    /**
     * @return void
     */
    protected function dataApiKeyValid(): void
    {
        $this->data['api_key_prefix'] = explode('-', $this->data['api_key'], 2)[0];
        $this->data['api_key'] = hash('sha256', $this->data['api_key']);
    }

    /**
     * @return void
     */
    protected function dataApiKeyInvalid(): void
    {
        $this->data['api_key'] = $this->row->api_key;
        $this->data['api_key_prefix'] = $this->row->api_key_prefix;
    }

    /**
     * @return void
     */
    protected function dataApiKeyEnabled(): void
    {
        if (empty($this->data['api_key'])) {
            $this->data['api_key_enabled'] = false;
        }
    }

    /**
     * @return void
     */
    protected function dataPreferences(): void
    {
        $this->data['preferences'] = array_replace_recursive($this->row->preferences, $this->data['preferences']);
    }

    /**
     * @return void
     */
    protected function dataAdminMode(): void
    {
        $this->data['admin_mode'] = $this->row->admin && $this->data['admin_mode'];
    }

    /**
     * @return void
     */
    protected function dataManagerMode(): void
    {
        $this->data['manager_mode'] = $this->row->manager && $this->data['manager_mode'];
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkEmail();
        $this->checkApiKey();
        $this->checkLanguageId();
        $this->checkTimezoneId();
    }

    /**
     * @return void
     */
    protected function checkEmail(): void
    {
        if ($this->checkEmailExists()) {
            $this->exceptionValidator(__('profile-update.error.email-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkEmailExists(): bool
    {
        return Model::query()
            ->byIdNot($this->row->id)
            ->byEmail($this->data['email'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkApiKey(): void
    {
        if ($this->data['api_key'] && $this->checkApiKeyExists()) {
            $this->exceptionValidator('profile-update.error.api_key-exists');
        }
    }

    /**
     * @return bool
     */
    protected function checkApiKeyExists(): bool
    {
        return Model::query()
            ->byIdNot($this->row->id)
            ->byApiKey($this->data['api_key'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkLanguageId(): void
    {
        if ($this->checkLanguageIdExists() === false) {
            $this->exceptionValidator(__('profile-update.error.language-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkLanguageIdExists(): bool
    {
        return LanguageModel::query()
            ->byId($this->data['language_id'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkTimezoneId(): void
    {
        if ($this->checkTimezoneIdExists() === false) {
            $this->exceptionValidator(__('profile-update.error.timezone-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkTimezoneIdExists(): bool
    {
        return TimezoneModel::query()
            ->byId($this->data['timezone_id'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->name = $this->data['name'];
        $this->row->email = $this->data['email'];
        $this->row->password = $this->data['password'];

        $this->row->api_key = $this->data['api_key'];
        $this->row->api_key_prefix = $this->data['api_key_prefix'];
        $this->row->api_key_enabled = $this->data['api_key_enabled'];

        $this->row->preferences = $this->data['preferences'];

        $this->row->admin_mode = $this->data['admin_mode'];
        $this->row->manager_mode = $this->data['manager_mode'];

        $this->row->language_id = $this->data['language_id'];
        $this->row->timezone_id = $this->data['timezone_id'];

        $this->row->save();
    }
}

```

`app/Domains/Profile/Action/UpdateTelegram.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Action;

use App\Domains\User\Model\User as Model;

class UpdateTelegram extends ActionAbstract
{
    /**
     * @return \App\Domains\User\Model\User
     */
    public function handle(): Model
    {
        $this->data();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataUsername();
        $this->dataChatId();
    }

    /**
     * @return void
     */
    protected function dataUsername(): void
    {
        $this->data['telegram']['username'] = trim(str_replace('@', '', $this->data['telegram']['username']));
    }

    /**
     * @return void
     */
    protected function dataChatId(): void
    {
        if (empty($this->data['telegram']['username'])) {
            $this->data['telegram']['chat_id'] = null;
        }
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->telegram = $this->data['telegram'] + (array)$this->row->telegram;
        $this->row->save();
    }
}

```

`app/Domains/Profile/Action/UpdateTelegramChatId.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Action;

use App\Domains\User\Model\User as Model;
use App\Services\Telegram\Client as TelegramClient;

class UpdateTelegramChatId extends ActionAbstract
{
    /**
     * @return \App\Domains\User\Model\User
     */
    public function handle(): Model
    {
        $this->check();

        if ($this->isValid()) {
            return $this->row;
        }

        $this->data();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkUsername();
    }

    /**
     * @return void
     */
    protected function checkUsername(): void
    {
        if (empty($this->row->telegram['username'])) {
            $this->exceptionValidator(__('profile-update-telegram-chat-id.username'));
        }
    }

    /**
     * @return bool
     */
    protected function isValid(): bool
    {
        return ($this->row->telegram['username'] ?? false)
            && ($this->row->telegram['chat_id'] ?? false);
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataChatId();
    }

    /**
     * @return void
     */
    protected function dataChatId(): void
    {
        $this->data['telegram']['chat_id'] = TelegramClient::new()->chatId($this->row->telegram['username']);
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->telegram = $this->data['telegram'] + (array)$this->row->telegram;
        $this->row->save();
    }
}

```

`app/Domains/Profile/Action/UpdateTelegramTest.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Action;

use App\Domains\User\Model\User as Model;
use App\Services\Telegram\Client as TelegramClient;

class UpdateTelegramTest extends ActionAbstract
{
    /**
     * @var \App\Services\Telegram\Client
     */
    protected TelegramClient $client;

    /**
     * @return \App\Domains\User\Model\User
     */
    public function handle(): Model
    {
        $this->client();
        $this->check();
        $this->send();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function client(): void
    {
        $this->client = new TelegramClient();
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkUsername();
    }

    /**
     * @return void
     */
    protected function checkUsername(): void
    {
        if (empty($this->row->telegram['username'])) {
            $this->exceptionValidator(__('profile-update-telegram-test.error.username'));
        }

        if (empty($this->row->telegram['chat_id'])) {
            $this->exceptionValidator(__('profile-update-telegram-test.error.chat_id'));
        }

        if ($this->client->enabled() === false) {
            $this->exceptionValidator(__('profile-update-telegram-test.error.enabled'));
        }
    }

    /**
     * @return void
     */
    protected function send(): void
    {
        $this->client->message($this->row->telegram['chat_id'], __('profile-update-telegram-test.message'));
    }
}

```

`app/Domains/Profile/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\User\Model\User as Model;
use App\Services\Telegram\Client as TelegramClient;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\User\Model\User
     */
    protected ?Model $row;

    /**
     * @var \App\Services\Telegram\Client
     */
    protected TelegramClient $telegram;

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = $this->auth;
    }

    /**
     * @return \App\Services\Telegram\Client
     */
    protected function telegram(): TelegramClient
    {
        return $this->telegram ??= TelegramClient::new();
    }

    /**
     * @return void
     */
    protected function load(): void
    {
        $this->row();
        $this->loadView();
    }

    /**
     * @return void
     */
    protected function loadView(): void
    {
        view()->share([
            'row' => $this->row,
            'telegram' => $this->telegram()->enabled(),
        ]);
    }
}

```

`app/Domains/Profile/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/Profile/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Language\Model\Collection\Language as LanguageCollection;
use App\Domains\Language\Model\Language as LanguageModel;
use App\Domains\Timezone\Model\Collection\Timezone as TimezoneCollection;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\User\Model\User as Model;

class Update extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\User\Model\User $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
    }

    /**
     * @return void
     */
    public function request(): void
    {
        $this->requestMergeWithRow(['api_key' => $this->requestApiKey()]);
    }

    /**
     * @return string
     */
    public function requestApiKey(): string
    {
        return $this->row->api_key_prefix
            ? ($this->row->api_key_prefix.'-*****-****-****-************')
            : '';
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'admin' => $this->row->admin,
            'manager' => $this->row->manager,
            'languages' => $this->languages(),
            'timezones' => $this->timezones(),
            'preferences_units_distance' => $this->preferencesUnitsDistance(),
            'preferences_units_volume' => $this->preferencesUnitsVolume(),
            'preferences_units_money' => $this->preferencesUnitsMoney(),
            'preferences_units_decimal' => $this->preferencesUnitsDecimal(),
            'preferences_units_thousand' => $this->preferencesUnitsThousand(),
        ];
    }

    /**
     * @return \App\Domains\Language\Model\Collection\Language
     */
    protected function languages(): LanguageCollection
    {
        return LanguageModel::query()
            ->list()
            ->get();
    }

    /**
     * @return \App\Domains\Timezone\Model\Collection\Timezone
     */
    protected function timezones(): TimezoneCollection
    {
        return TimezoneModel::query()
            ->list()
            ->get();
    }

    /**
     * @return array
     */
    protected function preferencesUnitsDistance(): array
    {
        return [
            'kilometer' => __('profile-update.preferences-units-distance-kilometer'),
            'knot' => __('profile-update.preferences-units-distance-knot'),
            'mile' => __('profile-update.preferences-units-distance-mile'),
        ];
    }

    /**
     * @return array
     */
    protected function preferencesUnitsMoney(): array
    {
        return [
            'euro' => __('profile-update.preferences-units-money-euro'),
            'dollar' => __('profile-update.preferences-units-money-dollar'),
            '' => __('profile-update.preferences-units-money-other'),
        ];
    }

    /**
     * @return array
     */
    protected function preferencesUnitsVolume(): array
    {
        return [
            'liter' => __('profile-update.preferences-units-volume-liter'),
            'gallon' => __('profile-update.preferences-units-volume-gallon'),
        ];
    }

    /**
     * @return array
     */
    protected function preferencesUnitsDecimal(): array
    {
        return [
            ',' => __('profile-update.preferences-units-decimal-comma'),
            '.' => __('profile-update.preferences-units-decimal-dot'),
        ];
    }

    /**
     * @return array
     */
    protected function preferencesUnitsThousand(): array
    {
        return [
            '.' => __('profile-update.preferences-units-thousand-dot'),
            ',' => __('profile-update.preferences-units-thousand-comma'),
        ];
    }
}

```

`app/Domains/Profile/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Profile\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        $this->load();

        if ($response = $this->actionPost('update')) {
            return $response;
        }

        $this->meta('title', __('profile-update.meta-title'));

        return $this->page('profile.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('profile-update.success'));

        return redirect()->route('profile.update');
    }
}

```

`app/Domains/Profile/Controller/UpdateTelegram.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;

class UpdateTelegram extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        $telegram = $this->telegram();

        if ($telegram->enabled() !== true) {
            return redirect()->back();
        }

        $this->load();

        if ($response = $this->actions()) {
            return $response;
        }

        $this->requestMergeWithRow();

        $this->meta('title', __('profile-update-telegram.meta-title'));

        return $this->page('profile.update-telegram', [
            'telegram_username' => $this->row->telegram['username'] ?? false,
            'telegram_chat_id' => $this->row->telegram['chat_id'] ?? false,
            'telegram_bot' => $telegram->config('bot'),
            'telegram_bot_link' => $telegram->botLink(),
        ]);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('updateTelegramChatId')
            ?: $this->actionPost('updateTelegram')
            ?: $this->actionPost('updateTelegramTest');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateTelegramChatId(): RedirectResponse
    {
        $this->action()->updateTelegramChatId();

        $this->sessionMessage('success', __('profile-update-telegram.success'));

        return redirect()->back();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateTelegram(): RedirectResponse
    {
        $this->action()->updateTelegram();

        $this->sessionMessage('success', __('profile-update-telegram.success'));

        return redirect()->back();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateTelegramTest(): RedirectResponse
    {
        $this->action()->updateTelegramTest();

        $this->sessionMessage('success', __('profile-update-telegram-test.success'));

        return redirect()->back();
    }
}

```

`app/Domains/Profile/Controller/UpdateUserSession.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Controller;

use Illuminate\Http\Response;
use App\Domains\UserSession\Model\Collection\UserSession as UserSessionCollection;
use App\Domains\UserSession\Model\UserSession as UserSessionModel;

class UpdateUserSession extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->load();

        $this->meta('title', __('profile-update-user-session.meta-title'));

        return $this->page('profile.update-user-session', [
            'sessions' => $this->sessions(),
        ]);
    }

    /**
     * @return \App\Domains\UserSession\Model\Collection\UserSession
     */
    protected function sessions(): UserSessionCollection
    {
        return UserSessionModel::query()
            ->byUser($this->row)
            ->unionUserFailByUser($this->row)
            ->list()
            ->get();
    }
}

```

`app/Domains/Profile/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth']], static function () {
    Route::any('/profile', Update::class)->name('profile.update');
    Route::any('/profile/telegram', UpdateTelegram::class)->name('profile.update.telegram');
    Route::get('/profile/user-session', UpdateUserSession::class)->name('profile.update.user-session');
});

```

`app/Domains/Profile/ControllerApi/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\ControllerApi;

use App\Domains\CoreApp\Controller\ControllerApiAbstract as CoreControllerApiAbstract;

abstract class ControllerApiAbstract extends CoreControllerApiAbstract
{
}

```

`app/Domains/Profile/ControllerApi/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\ControllerApi;

use Illuminate\Http\JsonResponse;

class Index extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory('User')->fractal('json', $this->auth));
    }
}

```

`app/Domains/Profile/ControllerApi/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\ControllerApi;

use Illuminate\Support\Facades\Route;

Route::get('/profile', Index::class)->name('profile.index');

```

`app/Domains/Profile/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Validate;

use Illuminate\Validation\Rule;
use App\Domains\Core\Validate\ValidateAbstract;

class Update extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'email' => ['bail', 'required', 'email:filter'],

            'admin_mode' => ['bail', 'boolean'],
            'manager_mode' => ['bail', 'boolean'],

            'password' => ['bail', 'min:8'],
            'password_current' => ['bail', 'required', 'current_password'],

            'api_key' => ['bail', 'nullable'],
            'api_key_enabled' => ['bail', 'boolean'],

            'preferences' => ['bail', 'required', 'array'],
            'preferences.units' => ['bail', 'required', 'array'],
            'preferences.units.decimal' => ['bail', 'required', Rule::in([',', '.'])],
            'preferences.units.distance' => ['bail', 'required', 'in:kilometer,knot,mile'],
            'preferences.units.money' => ['bail', 'string', 'in:euro,dollar'],
            'preferences.units.thousand' => ['bail', 'required', Rule::in([',', '.'])],
            'preferences.units.volume' => ['bail', 'required', 'in:liter,gallon'],

            'language_id' => ['bail', 'required', 'integer'],
            'timezone_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/Profile/Validate/UpdateTelegram.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdateTelegram extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'telegram' => ['bail', 'required', 'array'],
            'telegram.username' => ['bail', 'string'],
            'password_current' => ['bail', 'required', 'current_password'],
        ];
    }
}

```

`app/Domains/Profile/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Profile\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/QueueFail/Model/Builder/QueueFail.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\QueueFail\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class QueueFail extends BuilderAbstract
{
    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderBy('id', 'ASC');
    }
}

```

`app/Domains/QueueFail/Model/Collection/QueueFail.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\QueueFail\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class QueueFail extends CollectionAbstract
{
}

```

`app/Domains/QueueFail/Model/QueueFail.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\QueueFail\Model;

use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\QueueFail\Model\Builder\QueueFail as Builder;
use App\Domains\QueueFail\Model\Collection\QueueFail as Collection;

class QueueFail extends ModelAbstract
{
    /**
     * @var string
     */
    protected $table = 'queue_fail';

    /**
     * @const string
     */
    public const TABLE = 'queue_fail';

    /**
     * @const string
     */
    public const FOREIGN = 'queue_fail_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'payload' => 'array',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\QueueFail\Model\Collection\QueueFail
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\QueueFail\Model\Builder\QueueFail
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }
}

```

`app/Domains/Refuel/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\Refuel\Model\Refuel as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Refuel\Model\Refuel
     */
    protected ?Model $row;
}

```

`app/Domains/Refuel/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Refuel\Model\Refuel as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Refuel\Model\Refuel
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\Refuel\Model\Refuel
     */
    public function create(): Model
    {
        return $this->actionHandle(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandle(Delete::class);
    }

    /**
     * @return \App\Domains\Refuel\Model\Refuel
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\Refuel\Model\Refuel
     */
    public function updateCity(): Model
    {
        return $this->actionHandle(UpdateCity::class);
    }

    /**
     * @return void
     */
    public function updateCityEmpty(): void
    {
        $this->actionHandle(UpdateCityEmpty::class);
    }
}

```

`app/Domains/Refuel/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Action;

use App\Domains\Refuel\Model\Refuel as Model;

class Create extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'distance' => $this->data['distance'],
            'distance_total' => $this->data['distance_total'],
            'quantity' => $this->data['quantity'],
            'quantity_before' => $this->data['quantity_before'],
            'price' => $this->data['price'],
            'total' => $this->data['total'],
            'point' => $this->data['point'],
            'date_at' => $this->data['date_at'],
            'position_id' => $this->data['position_id'],
            'user_id' => $this->data['user_id'],
            'vehicle_id' => $this->data['vehicle_id'],
        ]);
    }
}

```

`app/Domains/Refuel/Action/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Action;

use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Refuel\Job\UpdateCity as UpdateCityJob;
use App\Domains\Refuel\Model\Refuel as Model;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

abstract class CreateUpdateAbstract extends ActionAbstract
{
    /**
     * @return void
     */
    abstract protected function save(): void;

    /**
     * @return \App\Domains\Refuel\Model\Refuel
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->save();
        $this->job();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataUserId();
        $this->dataPoint();
        $this->dataPositionId();
        $this->dataLocation();
    }

    /**
     * @return void
     */
    protected function dataPoint(): void
    {
        $this->data['point'] = Model::pointFromLatitudeLongitude(
            $this->data['latitude'],
            $this->data['longitude'],
        );
    }

    /**
     * @return void
     */
    protected function dataPositionId(): void
    {
        $this->data['position_id'] = PositionModel::query()
            ->byUserId($this->data['user_id'])
            ->orderByDateAtNearest($this->data['date_at'])
            ->value('id');
    }

    /**
     * @return void
     */
    protected function dataLocation(): void
    {
        $this->data['city_id'] = $this->dataLocationDifferent() ? null : $this->row->city_id;
    }

    /**
     * @return bool
     */
    protected function dataLocationDifferent(): bool
    {
        return empty($this->row)
            || ($this->row->latitude !== $this->data['latitude'])
            || ($this->row->longitude !== $this->data['longitude']);
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkVehicleId();
    }

    /**
     * @return void
     */
    protected function checkVehicleId(): void
    {
        if ($this->checkVehicleIdExists() === false) {
            $this->exceptionValidator(__('refuel-create.error.vehicle-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkVehicleIdExists(): bool
    {
        return VehicleModel::query()
            ->byId($this->data['vehicle_id'])
            ->byUserId($this->data['user_id'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function job(): void
    {
        UpdateCityJob::dispatch($this->row->id);
    }
}

```

`app/Domains/Refuel/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->delete();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }
}

```

`app/Domains/Refuel/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Action;

class Update extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->distance = $this->data['distance'];
        $this->row->distance_total = $this->data['distance_total'];
        $this->row->quantity = $this->data['quantity'];
        $this->row->quantity_before = $this->data['quantity_before'];
        $this->row->price = $this->data['price'];
        $this->row->total = $this->data['total'];
        $this->row->point = $this->data['point'];
        $this->row->date_at = $this->data['date_at'];
        $this->row->city_id = $this->data['city_id'];
        $this->row->position_id = $this->data['position_id'];
        $this->row->vehicle_id = $this->data['vehicle_id'];

        $this->row->save();
    }
}

```

`app/Domains/Refuel/Action/UpdateCity.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Action;

use App\Domains\City\Model\City as CityModel;
use App\Domains\Refuel\Model\Refuel as Model;

class UpdateCity extends ActionAbstract
{
    /**
     * @var ?\App\Domains\City\Model\City
     */
    protected ?CityModel $city;

    /**
     * @return \App\Domains\Refuel\Model\Refuel
     */
    public function handle(): Model
    {
        if ($this->row->city_id) {
            return $this->row;
        }

        $this->city();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function city(): void
    {
        $this->city = $this->factory('City')->action($this->cityData())->getOrNew();
    }

    /**
     * @return array
     */
    protected function cityData(): array
    {
        return [
            'latitude' => $this->row->latitude,
            'longitude' => $this->row->longitude,
        ];
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        if (empty($this->city)) {
            return;
        }

        $this->row->city_id = $this->city->id;
        $this->row->save();
    }
}

```

`app/Domains/Refuel/Action/UpdateCityEmpty.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Action;

use App\Domains\Refuel\Job\UpdateCity as UpdateCityJob;
use App\Domains\Refuel\Model\Refuel as Model;

class UpdateCityEmpty extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->iterate();
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->ids() as $id) {
            UpdateCityJob::dispatch($id);
        }
    }

    /**
     * @return array
     */
    protected function ids(): array
    {
        return Model::query()
            ->withoutCity()
            ->orderByDateAtDesc()
            ->pluck('id')
            ->all();
    }
}

```

`app/Domains/Refuel/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Command;

use App\Domains\CoreApp\Command\CommandAbstract as CommandAbstractSahred;
use App\Domains\Refuel\Model\Refuel as Model;

abstract class CommandAbstract extends CommandAbstractSahred
{
    /**
     * @var \App\Domains\Refuel\Model\Refuel
     */
    protected Model $row;

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = Model::query()->findOrFail($this->checkOption('id'));
    }
}

```

`app/Domains/Refuel/Command/UpdateCity.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Command;

class UpdateCity extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'refuel:update:city {--id=}';

    /**
     * @var string
     */
    protected $description = 'Update Refuel with Empty City';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->checkOptions(['id']);
        $this->requestWithOptions();

        $this->row();

        $this->factory()->action()->updateCity();

        $this->info('[END]');
    }
}

```

`app/Domains/Refuel/Command/UpdateCityEmpty.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Command;

class UpdateCityEmpty extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'refuel:update:city:empty';

    /**
     * @var string
     */
    protected $description = 'Update All Refuels with Empty City';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->factory()->action()->updateCityEmpty();

        $this->info('[END]');
    }
}

```

`app/Domains/Refuel/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\Refuel\Model\Refuel as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\Refuel\Model\Refuel
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Refuel\Model\Refuel
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('refuel.error.not-found')));
    }
}

```

`app/Domains/Refuel/Controller/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Refuel\Controller\Service\Create as ControllerService;

class Create extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($response = $this->actionPost('create')) {
            return $response;
        }

        $this->meta('title', __('refuel-create.meta-title'));

        return $this->page('refuel.create', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function create(): RedirectResponse
    {
        $this->row = $this->action()->create();

        $this->sessionMessage('success', __('refuel-create.success'));

        return redirect()->route('refuel.update', $this->row->id);
    }
}

```

`app/Domains/Refuel/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller;

use Illuminate\Http\Response;
use App\Domains\Refuel\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('refuel-index.meta-title'));

        return $this->page('refuel.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Refuel/Controller/Map.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Response;
use App\Domains\Refuel\Controller\Service\Map as ControllerService;

class Map extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse
     */
    public function __invoke(): Response|JsonResponse
    {
        $this->meta('title', __('refuel-map.meta-title'));

        return $this->page('refuel.map', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Refuel/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/Refuel/Controller/Service/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Refuel\Model\Refuel as Model;

class Create extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->request();
    }

    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow($this->requestMergeWithRowData(), $this->previous());
    }

    /**
     * @return array
     */
    protected function requestMergeWithRowData(): array
    {
        return $this->requestMergeWithRowUserId()
            + $this->requestMergeWithRowLocation();
    }

    /**
     * @return array
     */
    protected function requestMergeWithRowUserId(): array
    {
        return ['user_id' => $this->user()->id];
    }

    /**
     * @return array
     */
    protected function requestMergeWithRowLocation(): array
    {
        return PositionModel::query()
            ->select('latitude', 'longitude')
            ->byUserId($this->user()->id)
            ->orderByLast()
            ->firstOrNew()
            ->only('latitude', 'longitude');
    }

    /**
     * @return \App\Domains\Refuel\Model\Refuel
     */
    protected function previous(): Model
    {
        return Model::query()
            ->select('distance_total', 'price')
            ->byUserId($this->user()->id)
            ->orderByLast()
            ->firstOrNew();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCreateUpdate();
    }
}

```

`app/Domains/Refuel/Controller/Service/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller\Service;

abstract class CreateUpdateAbstract extends ControllerAbstract
{
    /**
     * @return array
     */
    protected function dataCreateUpdate(): array
    {
        return $this->dataCore() + [
            'vehicles' => $this->vehicles(),
        ];
    }
}

```

`app/Domains/Refuel/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller\Service;

use stdClass;
use App\Domains\Refuel\Model\Collection\Refuel as Collection;
use App\Domains\Refuel\Model\Refuel as Model;

class Index extends IndexMapAbstract
{
    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCore() + [
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'vehicle_empty' => $this->vehicleEmpty(),
            'countries' => $this->countries(),
            'country' => $this->country(),
            'states' => $this->states(),
            'state' => $this->state(),
            'cities' => $this->cities(),
            'city' => $this->city(),
            'date_min' => $this->dateMin(),
            'list' => $this->list(),
            'totals' => $this->totals(),
        ];
    }

    /**
     * @return \App\Domains\Refuel\Model\Collection\Refuel
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->whenVehicleId((int)$this->request->input('vehicle_id'))
                ->whenDateAtBetween($this->request->input('start_at'), $this->request->input('end_at'))
                ->whenCityStateCountryId($this->city()?->id, $this->state()?->id, $this->country()?->id)
                ->withSimple('user')
                ->withSimple('vehicle')
                ->list()
                ->get()
        );
    }

    /**
     * @return ?\stdClass
     */
    protected function totals(): ?stdClass
    {
        if ($this->list()->isEmpty()) {
            return null;
        }

        $totals = $this->list()->reduce($this->totalsRow(...), $this->totalsCarry());
        $totals->price = round($totals->total / $totals->quantity, 3);

        return $totals;
    }

    /**
     * @return \stdClass
     */
    protected function totalsCarry(): stdClass
    {
        return (object)[
            'distance' => 0,
            'quantity' => 0,
            'price' => 0,
            'total' => 0,
        ];
    }

    /**
     * @param \stdClass $carry
     * @param \App\Domains\Refuel\Model\Refuel $row
     *
     * @return \stdClass
     */
    protected function totalsRow(stdClass $carry, Model $row): stdClass
    {
        $carry->distance += $row->distance;
        $carry->quantity += $row->quantity;
        $carry->price += $row->price;
        $carry->total += $row->total;

        return $carry;
    }
}

```

`app/Domains/Refuel/Controller/Service/IndexMapAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\City\Model\City as CityModel;
use App\Domains\City\Model\Collection\City as CityCollection;
use App\Domains\Country\Model\Collection\Country as CountryCollection;
use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\Refuel\Model\Refuel as Model;
use App\Domains\State\Model\Collection\State as StateCollection;
use App\Domains\State\Model\State as StateModel;

abstract class IndexMapAbstract extends ControllerAbstract
{
    /**
     * @const string
     */
    protected const DATE_REGEXP = '/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}$/';

    /**
     * @var bool
     */
    protected bool $userEmpty = true;

    /**
     * @var bool
     */
    protected bool $vehicleEmpty = true;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->filters();
    }

    /**
     * @return void
     */
    protected function filters(): void
    {
        $this->filtersDates();
        $this->filtersIds();
    }

    /**
     * @return void
     */
    protected function filtersDates(): void
    {
        $this->filtersDatesStartAt();
        $this->filtersDatesEndAt();
    }

    /**
     * @return void
     */
    protected function filtersDatesStartAt(): void
    {
        $start_at = $this->request->input('start_at');

        if ($start_at === '') {
            return;
        }

        if (is_null($start_at) || (preg_match(static::DATE_REGEXP, $start_at) === 0)) {
            $this->request->merge(['start_at' => date('Y-m-d', strtotime('-1 year'))]);
        }
    }

    /**
     * @return void
     */
    protected function filtersDatesEndAt(): void
    {
        $end_at = $this->request->input('end_at');

        if (is_null($end_at) || (preg_match(static::DATE_REGEXP, $end_at) === 0)) {
            $this->request->merge(['end_at' => '']);
        }
    }

    /**
     * @return void
     */
    protected function filtersIds(): void
    {
        $this->filtersUserId();
        $this->filtersVehicleId();
    }

    /**
     * @return ?string
     */
    protected function dateMin(): ?string
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->orderByDateAtAsc()
                ->rawValue('DATE(`date_at`)')
        );
    }

    /**
     * @return \App\Domains\Country\Model\Collection\Country
     */
    protected function countries(): CountryCollection
    {
        return $this->cache(function () {
            return CountryModel::query()
                ->whenRefuelUserIdVehicleIdDateAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\Country\Model\Country
     */
    protected function country(): ?CountryModel
    {
        return $this->cache(
            fn () => $this->countries()->firstWhere('id', $this->request->input('country_id'))
        );
    }

    /**
     * @return \App\Domains\State\Model\Collection\State
     */
    protected function states(): StateCollection
    {
        return $this->cache(function () {
            if (empty($country_id = intval($this->country()?->id))) {
                return new StateCollection();
            }

            return StateModel::query()
                ->byCountryId($country_id)
                ->whenRefuelUserIdVehicleIdDateAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\State\Model\State
     */
    protected function state(): ?StateModel
    {
        return $this->cache(
            fn () => $this->states()->firstWhere('id', $this->request->input('state_id'))
        );
    }

    /**
     * @return \App\Domains\City\Model\Collection\City
     */
    protected function cities(): CityCollection
    {
        return $this->cache(function () {
            if (empty($state_id = intval($this->state()?->id))) {
                return new CityCollection();
            }

            return CityModel::query()
                ->byStateId($state_id)
                ->whenRefuelUserIdVehicleIdDateAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\City\Model\City
     */
    protected function city(): ?CityModel
    {
        return $this->cache(
            fn () => $this->cities()->firstWhere('id', $this->request->input('city_id'))
        );
    }
}

```

`app/Domains/Refuel/Controller/Service/Map.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller\Service;

use App\Domains\Refuel\Model\Collection\Refuel as Collection;
use App\Domains\Refuel\Model\Refuel as Model;

class Map extends IndexMapAbstract
{
    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCore() + [
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'vehicle_empty' => $this->vehicleEmpty(),
            'countries' => $this->countries(),
            'country' => $this->country(),
            'states' => $this->states(),
            'state' => $this->state(),
            'cities' => $this->cities(),
            'city' => $this->city(),
            'date_min' => $this->dateMin(),
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\Refuel\Model\Collection\Refuel
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->whenVehicleId($this->vehicle()?->id)
                ->whenDateAtBetween($this->request->input('start_at'), $this->request->input('end_at'))
                ->whenCityStateCountryId($this->city()?->id, $this->state()?->id, $this->country()?->id)
                ->withSimple('vehicle')
                ->withCityState()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Refuel/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Refuel\Model\Refuel as Model;

class Update extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Refuel\Model\Refuel $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
    }

    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCreateUpdate() + [
            'row' => $this->row,
        ];
    }
}

```

`app/Domains/Refuel/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Refuel\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actions()) {
            return $response;
        }

        $this->meta('title', __('refuel-update.meta-title', ['title' => $this->row->date_at]));

        return $this->page('refuel.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('update')
            ?: $this->actionPost('delete');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('refuel-update.success'));

        return redirect()->route('refuel.update', $this->row->id);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function delete(): RedirectResponse
    {
        $this->action()->delete();

        $this->sessionMessage('success', __('refuel-update.delete-success'));

        return redirect()->route('refuel.index');
    }
}

```

`app/Domains/Refuel/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth', 'vehicle.available']], static function () {
    Route::get('/refuel', Index::class)->name('refuel.index');
    Route::any('/refuel/create', Create::class)->name('refuel.create');
    Route::any('/refuel/map', Map::class)->name('refuel.map');
    Route::any('/refuel/{id}', Update::class)->name('refuel.update');
});

```

`app/Domains/Refuel/ControllerApi/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\ControllerApi;

use App\Domains\CoreApp\Controller\ControllerApiAbstract as CoreControllerApiAbstract;
use App\Domains\Refuel\Model\Refuel as Model;

abstract class ControllerApiAbstract extends CoreControllerApiAbstract
{
    /**
     * @var ?\App\Domains\Refuel\Model\Refuel
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Refuel\Model\Refuel
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('refuel.error.not-found')));
    }
}

```

`app/Domains/Refuel/ControllerApi/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Refuel\Model\Refuel as Model;
use App\Domains\Refuel\ControllerApi\Service\Create as ControllerService;

class Create extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('json', $this->execute()));
    }

    /**
     * @return \App\Domains\Refuel\Model\Refuel
     */
    protected function execute(): Model
    {
        return $this->action(data: $this->data())->create();
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Refuel/ControllerApi/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\ControllerApi;

class Delete extends ControllerApiAbstract
{
    /**
     * @param int $id
     *
     * @return void
     */
    public function __invoke(int $id): void
    {
        $this->row($id);
        $this->action()->delete();
    }
}

```

`app/Domains/Refuel/ControllerApi/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Refuel\ControllerApi\Service\Index as ControllerService;

class Index extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('json', $this->data()));
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Refuel/ControllerApi/Service/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\ControllerApi\Service;

use App\Domains\CoreApp\ControllerApi\Service\ControllerApiAbstract as CoreAppControllerApiAbstract;

abstract class ControllerApiAbstract extends CoreAppControllerApiAbstract
{
}

```

`app/Domains/Refuel/ControllerApi/Service/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;

class Create extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataDefault();
    }

    /**
     * @return array
     */
    protected function dataDefault(): array
    {
        return $this->request->input();
    }
}

```

`app/Domains/Refuel/ControllerApi/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Refuel\Model\Refuel as Model;

class Index extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return Model::query()
            ->byUserOrManager($this->auth)
            ->whenUserId($this->requestInteger('user_id'))
            ->whenVehicleId($this->requestInteger('vehicle_id'))
            ->withSimple('user')
            ->withSimple('vehicle')
            ->list()
            ->get()
            ->all();
    }
}

```

`app/Domains/Refuel/ControllerApi/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Refuel\Model\Refuel as Model;

class Update extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Refuel\Model\Refuel $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataDefault()
            + $this->dataRow();
    }

    /**
     * @return array
     */
    protected function dataDefault(): array
    {
        return $this->request->input();
    }

    /**
     * @return array
     */
    protected function dataRow(): array
    {
        return $this->row->toArray();
    }
}

```

`app/Domains/Refuel/ControllerApi/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Refuel\Model\Refuel as Model;
use App\Domains\Refuel\ControllerApi\Service\Update as ControllerService;

class Update extends ControllerApiAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(int $id): JsonResponse
    {
        $this->row($id);

        return $this->json($this->factory()->fractal('json', $this->execute()));
    }

    /**
     * @return \App\Domains\Refuel\Model\Refuel
     */
    protected function execute(): Model
    {
        return $this->action(data: $this->data())->update();
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }
}

```

`app/Domains/Refuel/ControllerApi/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\ControllerApi;

use Illuminate\Support\Facades\Route;

Route::get('/refuel', Index::class)->name('refuel.index');
Route::post('/refuel/create', Create::class)->name('refuel.create');
Route::patch('/refuel/{id}', Update::class)->name('refuel.update');
Route::delete('/refuel/{id}', Delete::class)->name('refuel.delete');

```

`app/Domains/Refuel/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\Refuel\Model\Refuel as Model;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\Refuel\Model\Refuel $row
     *
     * @return array
     */
    protected function json(Model $row): array
    {
        return [
            'id' => $row->id,
            'distance' => $row->distance,
            'distance_total' => $row->distance_total,
            'quantity' => $row->quantity,
            'quantity_before' => $row->quantity_before,
            'price' => $row->price,
            'total' => $row->total,
            'latitude' => $row->latitude,
            'longitude' => $row->longitude,
            'date_at' => $row->date_at,
            'user' => $this->from('User', 'related', $row->user),
            'vehicle' => $this->from('Vehicle', 'related', $row->vehicle),
        ];
    }

    /**
     * @param \App\Domains\Refuel\Model\Refuel $row
     *
     * @return array
     */
    protected function related(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
        ];
    }
}

```

`app/Domains/Refuel/Job/JobAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Job;

use App\Domains\Core\Job\JobAbstract as JobAbstractCore;
use App\Domains\Refuel\Model\Refuel as Model;

abstract class JobAbstract extends JobAbstractCore
{
    /**
     * @var \App\Domains\Refuel\Model\Refuel
     */
    protected Model $row;

    /**
     * @param int $id
     *
     * @return void
     */
    public function __construct(protected int $id)
    {
    }

    /**
     * @return array
     */
    public function middleware(): array
    {
        return [$this->middlewareWithoutOverlapping()];
    }

    /**
     * @return \App\Domains\Refuel\Model\Refuel
     */
    protected function row(): Model
    {
        return $this->rowOrDeleteAndException(Model::class);
    }
}

```

`app/Domains/Refuel/Job/UpdateCity.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Job;

class UpdateCity extends JobAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->factory(row: $this->row())->action()->updateCity();
    }
}

```

`app/Domains/Refuel/Model/Builder/Refuel.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Model\Builder;

use App\Domains\City\Model\City as CityModel;
use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class Refuel extends BuilderAbstract
{
    /**
     * @param int $city_id
     *
     * @return self
     */
    public function byCityId(int $city_id): self
    {
        return $this->where('city_id', $city_id);
    }

    /**
     * @param array $city_ids
     *
     * @return self
     */
    public function byCityIds(array $city_ids): self
    {
        return $this->whereIntegerInRaw('city_id', $city_ids);
    }

    /**
     * @param int $country_id
     *
     * @return self
     */
    public function byCountryId(int $country_id): self
    {
        return $this->whereIn('city_id', CityModel::query()->select('id')->byCountryId($country_id));
    }

    /**
     * @param array $country_ids
     *
     * @return self
     */
    public function byCountryIds(array $country_ids): self
    {
        return $this->whereIn('city_id', CityModel::query()->select('id')->byCountryIds($country_ids));
    }

    /**
     * @param string $date_at
     *
     * @return self
     */
    public function byDateAtAfter(string $date_at): self
    {
        return $this->whereDate('date_at', '>=', $date_at);
    }

    /**
     * @param string $date_at
     *
     * @return self
     */
    public function byDateAtBefore(string $date_at): self
    {
        return $this->whereDate('date_at', '<=', $date_at);
    }

    /**
     * @param int $state_id
     *
     * @return self
     */
    public function byStateId(int $state_id): self
    {
        return $this->whereIn('city_id', CityModel::query()->select('id')->byStateId($state_id));
    }

    /**
     * @param array $state_ids
     *
     * @return self
     */
    public function byStateIds(array $state_ids): self
    {
        return $this->whereIn('city_id', CityModel::query()->select('id')->byStateIds($state_ids));
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderByDateAtDesc();
    }

    /**
     * @return self
     */
    public function orderByDateAtDesc(): self
    {
        return $this->orderBy('date_at', 'DESC');
    }

    /**
     * @return self
     */
    public function orderByDateAtAsc(): self
    {
        return $this->orderBy('date_at', 'ASC');
    }

    /**
     * @param ?int $city_id
     *
     * @return self
     */
    public function whenCityId(?int $city_id): self
    {
        return $this->when($city_id, fn ($q) => $q->byCityId($city_id));
    }

    /**
     * @param ?int $city_id
     * @param ?int $state_id
     * @param ?int $country_id
     *
     * @return self
     */
    public function whenCityStateCountryId(?int $city_id, ?int $state_id, ?int $country_id): self
    {
        if ($city_id) {
            return $this->byCityId($city_id);
        }

        if ($state_id) {
            return $this->byStateId($state_id);
        }

        if ($country_id) {
            return $this->byCountryId($country_id);
        }

        return $this;
    }

    /**
     * @param ?int $country_id
     *
     * @return self
     */
    public function whenCountryId(?int $country_id): self
    {
        return $this->when($country_id, fn ($q) => $q->byCountryId($country_id));
    }

    /**
     * @param ?string $before_date_at
     * @param ?string $after_date_at
     *
     * @return self
     */
    public function whenDateAtBetween(?string $before_date_at, ?string $after_date_at): self
    {
        return $this->whenDateAtAfter($before_date_at)->whenDateAtBefore($after_date_at);
    }

    /**
     * @param ?string $date_at
     *
     * @return self
     */
    public function whenDateAtAfter(?string $date_at): self
    {
        return $this->when($date_at, fn ($q) => $q->byDateAtAfter($date_at));
    }

    /**
     * @param ?string $date_at
     *
     * @return self
     */
    public function whenDateAtBefore(?string $date_at): self
    {
        return $this->when($date_at, fn ($q) => $q->byDateAtBefore($date_at));
    }

    /**
     * @param ?int $state_id
     *
     * @return self
     */
    public function whenStateId(?int $state_id): self
    {
        return $this->when($state_id, fn ($q) => $q->byStateId($state_id));
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_date_at
     * @param ?string $after_date_at
     *
     * @return self
     */
    public function whenUserIdVehicleIdDateAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_date_at, ?string $after_date_at): self
    {
        return $this->whenUserId($user_id)
            ->whenVehicleId($vehicle_id)
            ->whenDateAtBetween($before_date_at, $after_date_at);
    }

    /**
     * @return self
     */
    public function withCity(): self
    {
        return $this->with('city');
    }

    /**
     * @return self
     */
    public function withCityState(): self
    {
        return $this->with(['city' => fn ($q) => $q->withState()]);
    }

    /**
     * @return self
     */
    public function withVehicle(): self
    {
        return $this->with('vehicle');
    }

    /**
     * @return self
     */
    public function withWhereHasPosition(): self
    {
        return $this->withWhereHas('position', fn ($q) => $q->withCityState());
    }

    /**
     * @return self
     */
    public function withoutCity(): self
    {
        return $this->whereNull('city_id');
    }
}

```

`app/Domains/Refuel/Model/Collection/Refuel.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Refuel extends CollectionAbstract
{
}

```

`app/Domains/Refuel/Model/Refuel.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use App\Domains\City\Model\City as CityModel;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\CoreApp\Model\Traits\Gis as GisTrait;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Refuel\Model\Builder\Refuel as Builder;
use App\Domains\Refuel\Model\Collection\Refuel as Collection;
use App\Domains\Refuel\Test\Factory\Refuel as TestFactory;
use App\Domains\User\Model\User as UserModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class Refuel extends ModelAbstract
{
    use GisTrait;
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'refuel';

    /**
     * @const string
     */
    public const TABLE = 'refuel';

    /**
     * @const string
     */
    public const FOREIGN = 'refuel_id';

    /**
     * @param array $models
     *
     * @return \App\Domains\Refuel\Model\Collection\Refuel
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Refuel\Model\Builder\Refuel
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Refuel\Test\Factory\Refuel
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function city(): BelongsTo
    {
        return $this->belongsTo(CityModel::class, CityModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function position(): BelongsTo
    {
        return $this->belongsTo(PositionModel::class, PositionModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(UserModel::class, UserModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(VehicleModel::class, VehicleModel::FOREIGN)->withTimezone();
    }
}

```

`app/Domains/Refuel/Schedule/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Schedule;

use App\Domains\Core\Schedule\ScheduleAbstract;
use App\Domains\Refuel\Command\UpdateCityEmpty as UpdateCityEmptyCommand;

class Manager extends ScheduleAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->command(UpdateCityEmptyCommand::class)->everyTenMinutes();
    }
}

```

`app/Domains/Refuel/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'distance' => ['bail', 'required', 'numeric'],
            'distance_total' => ['bail', 'required', 'numeric'],
            'quantity' => ['bail', 'required', 'numeric'],
            'quantity_before' => ['bail', 'numeric'],
            'price' => ['bail', 'required', 'numeric'],
            'total' => ['bail', 'required', 'numeric'],
            'latitude' => ['bail', 'required', 'numeric', 'between:-90,90'],
            'longitude' => ['bail', 'required', 'numeric', 'between:-180,180'],
            'date_at' => ['bail', 'required', 'date_format:Y-m-d H:i:s'],
            'user_id' => ['bail', 'integer'],
            'vehicle_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/Refuel/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Validate;

class Update extends Create
{
}

```

`app/Domains/Refuel/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Refuel\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Server/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\Server\Model\Server as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Server\Model\Server
     */
    protected ?Model $row;
}

```

`app/Domains/Server/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Server\Model\Server as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Server\Model\Server
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\Server\Model\Server
     */
    public function create(): Model
    {
        return $this->actionHandle(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandle(Delete::class);
    }

    /**
     * @return void
     */
    public function logRead(): void
    {
        $this->actionHandle(LogRead::class, $this->validate()->logRead());
    }

    /**
     * @return array
     */
    public function parse(): array
    {
        return $this->actionHandle(Parse::class, $this->validate()->parse());
    }

    /**
     * @return void
     */
    public function startAll(): void
    {
        $this->actionHandle(StartAll::class, $this->validate()->startAll());
    }

    /**
     * @return void
     */
    public function startPort(): void
    {
        $this->actionHandle(StartPort::class, $this->validate()->startPort());
    }

    /**
     * @return void
     */
    public function startPorts(): void
    {
        $this->actionHandle(StartPorts::class, $this->validate()->startPorts());
    }

    /**
     * @return void
     */
    public function stopAll(): void
    {
        $this->actionHandle(StopAll::class);
    }

    /**
     * @return void
     */
    public function stopPorts(): void
    {
        $this->actionHandle(StopPorts::class, $this->validate()->stopPorts());
    }

    /**
     * @return \App\Domains\Server\Model\Server
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\Server\Model\Server
     */
    public function updateBoolean(): Model
    {
        return $this->actionHandle(UpdateBoolean::class, $this->validate()->updateBoolean());
    }
}

```

`app/Domains/Server/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Domains\Server\Model\Server as Model;

class Create extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'port' => $this->data['port'],
            'protocol' => $this->data['protocol'],
            'debug' => $this->data['debug'],
            'enabled' => $this->data['enabled'],
        ]);
    }
}

```

`app/Domains/Server/Action/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Domains\Server\Model\Server as Model;
use App\Services\Protocol\ProtocolFactory;

abstract class CreateUpdateAbstract extends ActionAbstract
{
    /**
     * @return void
     */
    abstract protected function save(): void;

    /**
     * @return \App\Domains\Server\Model\Server
     */
    public function handle(): Model
    {
        $this->check();
        $this->save();
        $this->start();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkPort();
        $this->checkProtocol();
    }

    /**
     * @return void
     */
    protected function checkPort(): void
    {
        if (Model::query()->byIdNot($this->row->id ?? 0)->byPort($this->data['port'])->count()) {
            $this->exceptionValidator(__('server-create.error.port-exists'));
        }
    }

    /**
     * @return void
     */
    protected function checkProtocol(): void
    {
        if (array_key_exists($this->data['protocol'], ProtocolFactory::list()) === false) {
            $this->exceptionValidator(__('server-create.error.protocol-not-exists'));
        }
    }

    /**
     * @return void
     */
    protected function start(): void
    {
        $this->factory()->action($this->startData())->startPorts();
    }

    /**
     * @return array
     */
    protected function startData(): array
    {
        return ['ports' => [$this->row->port]];
    }
}

```

`app/Domains/Server/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Services\Server\Process;

class Delete extends ActionAbstract
{
    /**
     * @var \App\Services\Server\Process
     */
    protected Process $process;

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->process();
        $this->kill();
        $this->delete();
    }

    /**
     * @return void
     */
    protected function process(): void
    {
        $this->process = new Process();
    }

    /**
     * @return void
     */
    protected function kill(): void
    {
        if ($this->killIsRunning()) {
            $this->process->kill($this->row->port);
        }
    }

    /**
     * @return bool
     */
    protected function killIsRunning(): bool
    {
        return $this->process
            ->list()
            ->where('port', $this->row->port)
            ->isNotEmpty();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }
}

```

`app/Domains/Server/Action/LogRead.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Services\Protocol\ProtocolAbstract;
use App\Services\Protocol\ProtocolFactory;
use App\Services\Protocol\Resource\ResourceAbstract;

class LogRead extends ActionAbstract
{
    /**
     * @var string
     */
    protected string $file;

    /**
     * @var \App\Services\Protocol\ProtocolAbstract
     */
    protected ProtocolAbstract $protocol;

    /**
     * @var array
     */
    protected array $resourceData = [];

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->file();
        $this->check();
        $this->protocol();
        $this->iterate();
    }

    /**
     * @return void
     */
    protected function file(): void
    {
        $this->file = base_path($this->data['file']);
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkFile();
    }

    /**
     * @return void
     */
    protected function checkFile(): void
    {
        if (is_file($this->file) === false) {
            $this->exceptionNotFound(__('server-log-read.error.file-not-found'));
        }
    }

    /**
     * @return void
     */
    protected function protocol(): void
    {
        $this->protocol = ProtocolFactory::get($this->data['protocol']);
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach (file($this->file, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES) as $line) {
            if (count($line = explode(' ', trim($line), 2)) === 2) {
                $this->store($line[1]);
            }
        }
    }

    /**
     * @param string $message
     *
     * @return void
     */
    protected function store(string $message): void
    {
        foreach ($this->protocol->resources($message, $this->resourceData) as $resource) {
            $this->save($resource);
        }
    }

    /**
     * @param \App\Services\Protocol\Resource\ResourceAbstract $resource
     *
     * @return void
     */
    protected function save(ResourceAbstract $resource): void
    {
        if ($resource->format() === 'location') {
            $this->factory('Position')->action($this->saveData($resource))->create();
        }

        if ($data = $resource->data()) {
            $this->resourceData = $data;
        }
    }

    /**
     * @param \App\Services\Protocol\Resource\ResourceAbstract $resource
     *
     * @return array
     */
    protected function saveData(ResourceAbstract $resource): array
    {
        return [
            'serial' => $resource->serial(),
            'latitude' => $resource->latitude(),
            'longitude' => $resource->longitude(),
            'speed' => $resource->speed(),
            'direction' => $resource->direction(),
            'signal' => $resource->signal(),
            'date_utc_at' => $resource->datetime(),
            'timezone' => $resource->timezone(),

            'debug' => $this->data['debug'],
        ];
    }
}

```

`app/Domains/Server/Action/Parse.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Domains\Device\Model\Collection\Device as DeviceCollection;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Services\Protocol\ProtocolAbstract;
use App\Services\Protocol\ProtocolFactory;

class Parse extends ActionAbstract
{
    /**
     * @var \App\Domains\Device\Model\Collection\Device
     */
    protected DeviceCollection $devices;

    /**
     * @var array
     */
    protected array $parsed = [];

    /**
     * @var array
     */
    protected array $resourceData = [];

    /**
     * @var \App\Services\Protocol\ProtocolAbstract
     */
    protected ProtocolAbstract $protocol;

    /**
     * @return array
     */
    public function handle(): array
    {
        $this->protocol();
        $this->devices();
        $this->iterate();

        return $this->parsed;
    }

    /**
     * @return void
     */
    protected function protocol(): void
    {
        $this->protocol = ProtocolFactory::get($this->row->protocol);
    }

    /**
     * @return void
     */
    protected function devices(): void
    {
        $this->devices = DeviceModel::query()
            ->get()
            ->keyBy('serial');
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach (explode("\n", $this->data['log']) as $line) {
            $this->line($line);
        }
    }

    /**
     * @param string $line
     *
     * @return void
     */
    protected function line(string $line): void
    {
        [$date_at, $line] = explode(' ', trim($line), 2) + ['', ''];

        $resources = $this->protocol->resources($line, $this->resourceData);

        $this->resourceData = array_merge(
            $this->resourceData,
            $this->lineData($resources)
        );

        $this->parsed[] = [
            'line' => $line,
            'messages' => $this->protocol->messages($line),
            'date_at' => str_replace(['[', ']'], '', $date_at),
            'resources' => $resources,
            'device' => $this->lineDevice($resources),
            'data' => $this->resourceData,
        ];
    }

    /**
     * @param array $resources
     *
     * @return ?\App\Domains\Device\Model\Device
     */
    protected function lineDevice(array $resources): ?DeviceModel
    {
        foreach ($resources as $resource) {
            return $this->devices->get($resource->serial());
        }

        return null;
    }

    /**
     * @param array $resources
     *
     * @return array
     */
    protected function lineData(array $resources): array
    {
        if ($resources) {
            return $resources[0]->data();
        }

        return [];
    }
}

```

`app/Domains/Server/Action/StartAll.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Domains\Server\Model\Collection\Server as Collection;
use App\Domains\Server\Model\Server as Model;
use App\Domains\Server\Service\Command\Generator as CommandGenerator;
use App\Services\Command\Artisan;

class StartAll extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        if ($this->runningUnitTests()) {
            return;
        }

        $this->iterate();
        $this->sleep();
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->list() as $row) {
            $this->command($row);
        }
    }

    /**
     * @return \App\Domains\Server\Model\Collection\Server
     */
    protected function list(): Collection
    {
        return Model::query()
            ->enabled()
            ->get();
    }

    /**
     * @param \App\Domains\Server\Model\Server $row
     *
     * @return void
     */
    protected function command(Model $row): void
    {
        Artisan::new($this->commandString($row))->logDaily()->exec();
    }

    /**
     * @param \App\Domains\Server\Model\Server $row
     *
     * @return string
     */
    protected function commandString(Model $row): string
    {
        return CommandGenerator::serverStartPort(
            $row->port,
            $this->data['reset'],
            $this->data['debug'] || $row->debug
        );
    }

    /**
     * @return void
     */
    protected function sleep(): void
    {
        sleep(1);
    }
}

```

`app/Domains/Server/Action/StartPort.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Domains\Server\Exception\PortBusy as PortBusyException;
use App\Domains\Server\Exception\PortLocked as PortLockedException;
use App\Domains\Server\Model\Server as Model;
use App\Services\Filesystem\Directory;
use App\Services\Protocol\ProtocolAbstract;
use App\Services\Protocol\ProtocolFactory;
use App\Services\Protocol\Resource\ResourceAbstract;
use App\Services\Server\ServerAbstract;

class StartPort extends ActionAbstract
{
    /**
     * @var \App\Services\Protocol\ProtocolAbstract
     */
    protected ProtocolAbstract $protocol;

    /**
     * @var \App\Services\Server\ServerAbstract
     */
    protected ServerAbstract $server;

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->row();
        $this->data();
        $this->protocol();

        if ($this->runningUnitTests()) {
            return;
        }

        $this->server();
        $this->kill();

        if ($this->isBusy()) {
            $this->isBusyError();

            return;
        }

        $this->serve();
    }

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = Model::query()->byPort($this->data['port'])->firstOrFail();
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataDebug();
    }

    /**
     * @return void
     */
    protected function dataDebug(): void
    {
        $this->data['debug'] = $this->data['debug'] || $this->row->debug;
    }

    /**
     * @return void
     */
    protected function protocol(): void
    {
        $this->protocol = ProtocolFactory::get($this->row->protocol);
    }

    /**
     * @return void
     */
    protected function server(): void
    {
        $this->server = $this->protocol
            ->server($this->row->port)
            ->debug($this->data['debug']);
    }

    /**
     * @return void
     */
    protected function kill(): void
    {
        if ($this->data['reset']) {
            $this->killByReset();
        } elseif ($this->server->isLocked()) {
            $this->killByLocked();
        }
    }

    /**
     * @return void
     */
    protected function killByReset(): void
    {
        $this->server->kill();
    }

    /**
     * @return void
     */
    protected function killByLocked(): void
    {
        logger()->error(new PortLockedException(__('server.error.port-locked', ['port' => $this->data['port']])));

        $this->server->kill();
    }

    /**
     * @return bool
     */
    protected function isBusy(): bool
    {
        return $this->server->isBusy();
    }

    /**
     * @return void
     */
    protected function isBusyError(): void
    {
        if ($this->data['reset']) {
            logger()->error(new PortBusyException(__('server.error.port-busy', ['port' => $this->data['port']])));
        }
    }

    /**
     * @return void
     */
    protected function serve(): void
    {
        $this->server->accept($this->store(...));
    }

    /**
     * @param string $message
     * @param array $data = []
     *
     * @return array
     */
    protected function store(string $message, array $data = []): array
    {
        $this->logDebug($message);

        $resources = $this->protocol->resources($message, $data);

        if (empty($resources)) {
            return [];
        }

        $this->log($message);

        foreach ($resources as $resource) {
            $this->save($resource);
        }

        return $resources;
    }

    /**
     * @param \App\Services\Protocol\Resource\ResourceAbstract $resource
     *
     * @return void
     */
    protected function save(ResourceAbstract $resource): void
    {
        $this->logDebug($resource->toJson());

        if ($resource->format() === 'location') {
            $this->factory('Position')->action($this->saveData($resource))->create();
        }
    }

    /**
     * @param \App\Services\Protocol\Resource\ResourceAbstract $resource
     *
     * @return array
     */
    protected function saveData(ResourceAbstract $resource): array
    {
        return [
            'serial' => $resource->serial(),
            'latitude' => $resource->latitude(),
            'longitude' => $resource->longitude(),
            'speed' => $resource->speed(),
            'direction' => $resource->direction(),
            'signal' => $resource->signal(),
            'date_utc_at' => $resource->datetime(),
            'timezone' => $resource->timezone(),

            'debug' => $this->data['debug'],
        ];
    }

    /**
     * @param string $message
     *
     * @return void
     */
    protected function logDebug(string $message): void
    {
        if ($this->data['debug']) {
            $this->log($message, '-debug');
        }
    }

    /**
     * @param string $message
     * @param string $suffix = ''
     *
     * @return void
     */
    protected function log(string $message, string $suffix = ''): void
    {
        $file = $this->logFile($suffix);

        Directory::create($file, true);

        file_put_contents($file, $this->logContent($message), LOCK_EX | FILE_APPEND);
    }

    /**
     * @param string $suffix = ''
     *
     * @return string
     */
    protected function logFile(string $suffix = ''): string
    {
        return base_path('storage/logs/server/'.date('Y/m/d').'/'.$this->row->port.$suffix.'.log');
    }

    /**
     * @param string $message
     *
     * @return string
     */
    protected function logContent(string $message): string
    {
        return '['.date('c').'] '.$message."\n";
    }
}

```

`app/Domains/Server/Action/StartPorts.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Domains\Server\Model\Collection\Server as Collection;
use App\Domains\Server\Model\Server as Model;
use App\Domains\Server\Service\Command\Generator as CommandGenerator;
use App\Services\Command\Artisan;

class StartPorts extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        if ($this->runningUnitTests()) {
            return;
        }

        $this->iterate();
        $this->sleep();
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->list() as $row) {
            $this->command($row);
        }
    }

    /**
     * @return \App\Domains\Server\Model\Collection\Server
     */
    protected function list(): Collection
    {
        return Model::query()
            ->byPorts($this->data['ports'])
            ->enabled()
            ->get();
    }

    /**
     * @param \App\Domains\Server\Model\Server $row
     *
     * @return void
     */
    protected function command(Model $row): void
    {
        Artisan::new($this->commandString($row))->logDaily()->exec();
    }

    /**
     * @param \App\Domains\Server\Model\Server $row
     *
     * @return string
     */
    protected function commandString(Model $row): string
    {
        return CommandGenerator::serverStartPort($row->port, true, $this->data['debug'] || $row->debug);
    }

    /**
     * @return void
     */
    protected function sleep(): void
    {
        sleep(1);
    }
}

```

`app/Domains/Server/Action/StopAll.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Services\Server\Process;

class StopAll extends ActionAbstract
{
    /**
     * @var \App\Services\Server\Process
     */
    protected Process $process;

    /**
     * @return void
     */
    public function handle(): void
    {
        if ($this->runningUnitTests()) {
            return;
        }

        $this->process();
        $this->iterate();
        $this->sleep();
    }

    /**
     * @return void
     */
    protected function process(): void
    {
        $this->process = new Process();
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->process->list() as $process) {
            $this->process->kill($process->port);
        }
    }

    /**
     * @return void
     */
    protected function sleep(): void
    {
        sleep(1);
    }
}

```

`app/Domains/Server/Action/StopPorts.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Services\Server\Process;

class StopPorts extends ActionAbstract
{
    /**
     * @var \App\Services\Server\Process
     */
    protected Process $process;

    /**
     * @return void
     */
    public function handle(): void
    {
        if ($this->runningUnitTests()) {
            return;
        }

        $this->process();
        $this->iterate();
        $this->sleep();
    }

    /**
     * @return void
     */
    protected function process(): void
    {
        $this->process = new Process();
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->process->list() as $process) {
            $this->kill($process->port);
        }
    }

    /**
     * @param int $port
     *
     * @return void
     */
    protected function kill(int $port): void
    {
        if ($this->isValidProcess($port)) {
            $this->killPort($port);
        }
    }

    /**
     * @param int $port
     *
     * @return void
     */
    protected function killPort(int $port): void
    {
        $this->process->kill($port);
    }

    /**
     * @param int $port
     *
     * @return bool
     */
    protected function isValidProcess(int $port): bool
    {
        return in_array($port, $this->data['ports']);
    }

    /**
     * @return void
     */
    protected function sleep(): void
    {
        sleep(1);
    }
}

```

`app/Domains/Server/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

class Update extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->port = $this->data['port'];
        $this->row->protocol = $this->data['protocol'];
        $this->row->debug = $this->data['debug'];
        $this->row->enabled = $this->data['enabled'];

        $this->row->save();
    }
}

```

`app/Domains/Server/Action/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Action;

use App\Domains\CoreApp\Action\UpdateBoolean as UpdateBooleanCoreApp;
use App\Domains\Server\Model\Server as Model;

class UpdateBoolean extends UpdateBooleanCoreApp
{
    /**
     * @var \App\Domains\Server\Model\Server
     */
    protected Model $row;
}

```

`app/Domains/Server/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Command;

use App\Domains\CoreApp\Command\CommandAbstract as CommandAbstractSahred;

abstract class CommandAbstract extends CommandAbstractSahred
{
}

```

`app/Domains/Server/Command/LogRead.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Command;

class LogRead extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'server:log:read {--file=} {--protocol=} {--debug}';

    /**
     * @var string
     */
    protected $description = 'Read Server Log from {--file=} using {--protocol=}';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->middlewares();

        $this->checkOptions(['file', 'protocol']);
        $this->requestWithOptions();

        $this->factory()->action()->logRead();

        $this->info('[END]');
    }
}

```

`app/Domains/Server/Command/StartAll.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Command;

class StartAll extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'server:start:all {--reset} {--debug}';

    /**
     * @var string
     */
    protected $description = 'Start All Configured Servers with {--reset} and {--debug} options.';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('START');

        $this->middlewares();

        $this->requestWithOptions();

        $this->factory()->action()->startAll();

        $this->info('END');
    }
}

```

`app/Domains/Server/Command/StartPort.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Command;

class StartPort extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'server:start:port {--port=} {--reset} {--debug}';

    /**
     * @var string
     */
    protected $description = 'Create a Server on {--port=} with {--reset} and {--debug} options.';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('START');

        $this->middlewares();

        $this->checkOptions(['port']);
        $this->requestWithOptions();

        $this->factory()->action()->startPort();

        $this->info('END');
    }
}

```

`app/Domains/Server/Command/StopAll.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Command;

class StopAll extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'server:stop:all';

    /**
     * @var string
     */
    protected $description = 'Stop All Running Servers.';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('START');

        $this->middlewares();

        $this->factory()->action()->stopAll();

        $this->info('END');
    }
}

```

`app/Domains/Server/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\Server\Model\Server as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\Server\Model\Server
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Server\Model\Server
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->firstOr(fn () => $this->exceptionNotFound(__('server.error.not-found')));
    }
}

```

`app/Domains/Server/Controller/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Services\Protocol\ProtocolFactory;

class Create extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($response = $this->actionPost('create')) {
            return $response;
        }

        $this->requestMergeWithRow();

        $this->meta('title', __('server-create.meta-title'));

        return $this->page('server.create', [
            'protocols' => array_keys(ProtocolFactory::list()),
        ]);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function create(): RedirectResponse
    {
        $this->row = $this->action()->create();

        $this->sessionMessage('success', __('server-create.success'));

        return redirect()->route('server.update', $this->row->id);
    }
}

```

`app/Domains/Server/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Controller;

use Illuminate\Http\Response;
use App\Domains\Server\Model\Server as Model;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('server-index.meta-title'));

        return $this->page('server.index', [
            'list' => Model::query()->list()->get(),
        ]);
    }
}

```

`app/Domains/Server/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Controller\Service;

abstract class ControllerAbstract
{
    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }
}

```

`app/Domains/Server/Controller/Service/Status.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Controller\Service;

use stdClass;
use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use Illuminate\Support\Collection as CollectionGeneric;
use App\Domains\Server\Model\Collection\Server as Collection;
use App\Domains\Server\Model\Server as Model;
use App\Services\Server\Process as ServerProcess;

class Status extends ControllerAbstract
{
    /**
     * @var \App\Domains\Server\Model\Collection\Server
     */
    protected Collection $list;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->list = $this->list();
    }

    /**
     * @return \App\Domains\Server\Model\Collection\Server
     */
    protected function list(): Collection
    {
        return Model::query()->list()->get();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'list' => $this->list,
            'process' => $this->process(),
        ];
    }

    /**
     * @return \Illuminate\Support\Collection
     */
    protected function process(): CollectionGeneric
    {
        return ServerProcess::new()
            ->list()
            ->map($this->processMap(...));
    }

    /**
     * @param \stdClass $process
     *
     * @return \stdClass
     */
    protected function processMap(stdClass $process): stdClass
    {
        $process->command = $this->processMapCommand($process);
        $process->route = $this->processMapRoute($process);
        $process->protocol = $this->processMapProtocol($process);

        return $process;
    }

    /**
     * @param \stdClass $process
     *
     * @return string
     */
    protected function processMapCommand(stdClass $process): string
    {
        return str_replace(base_path('/'), '', strval($process->command));
    }

    /**
     * @param \stdClass $process
     *
     * @return ?string
     */
    protected function processMapRoute(stdClass $process): ?string
    {
        $path = 'server/'.date('Y/m/d');
        $base = storage_path('logs/'.$path);
        $port = $process->port;

        if (is_file($base.'/'.$port.'.log')) {
            $file = $port.'.log';
        } elseif (is_file($base.'/'.$port.'-debug.log')) {
            $file = $port.'-debug.log';
        } elseif (is_file($base.'/'.$port.'-connection.log')) {
            $file = $port.'-connection.log';
        } else {
            $file = null;
        }

        if ($file) {
            return route('monitor.log.file', [base64_encode($path), base64_encode($file)]);
        }

        if (is_dir($base)) {
            return route('monitor.log.path', base64_encode($path));
        }

        return null;
    }

    /**
     * @param \stdClass $process
     *
     * @return ?string
     */
    protected function processMapProtocol(stdClass $process): ?string
    {
        return $this->list->firstWhere('port', $process->port)?->protocol;
    }
}

```

`app/Domains/Server/Controller/Service/UpdateParser.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Server\Model\Server as Model;
use App\Domains\Trip\Model\Trip as TripModel;
use App\Services\Protocol\ProtocolAbstract;
use App\Services\Protocol\ProtocolFactory;

class UpdateParser extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Server\Model\Server $row
     *
     * @return self
     */
    public function __construct(
        protected Request $request,
        protected Authenticatable $auth,
        protected Model $row,
        protected ?array $parsed
    ) {
        $this->log();
    }

    /**
     * @return void
     */
    protected function log(): void
    {
        if ($this->request->input('log')) {
            return;
        }

        $file = $this->request->input('file');

        if (array_key_exists($file, $this->files()) === false) {
            return;
        }

        $file = trim(base64_decode(strtr($file, '-_.', '+/=')), '/');
        $file = base_path('storage/logs/'.$file);

        if (is_file($file) === false) {
            return;
        }

        $this->request->merge(['log' => file_get_contents($file)]);
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'parsed' => $this->parsed,
            'protocol' => $this->protocol(),
            'files' => $this->files(),
            'trip' => $this->trip(),
            'positions' => $this->positions(),
        ];
    }

    /**
     * @return \App\Services\Protocol\ProtocolAbstract
     */
    protected function protocol(): ProtocolAbstract
    {
        return ProtocolFactory::get($this->row->protocol);
    }

    /**
     * @return array
     */
    protected function files(): array
    {
        static $cache;

        if (isset($cache)) {
            return $cache;
        }

        $base = base_path('storage/logs');
        $path = sprintf('%s/server/*/*/*/%s-debug.log', $base, $this->row->port);

        $files = [];

        foreach (glob($path) as $file) {
            $file = str_replace($base, '', $file);
            $files[strtr(base64_encode($file), '+/=', '-_.')] = $file;
        }

        $path = sprintf('%s/server/*/*/*/%s.log', $base, $this->row->port);

        foreach (glob($path) as $file) {
            $file = str_replace($base, '', $file);
            $files[strtr(base64_encode($file), '+/=', '-_.')] = $file;
        }

        arsort($files);

        return $cache = $files;
    }

    /**
     * @return ?\App\Domains\Trip\Model\Trip
     */
    protected function trip(): ?TripModel
    {
        if (empty($this->parsed)) {
            return null;
        }

        return new TripModel([
            'distance' => 0,
            'time' => 0,
        ]);
    }

    /**
     * @return ?\App\Domains\Position\Model\Collection\Position
     */
    protected function positions(): ?PositionCollection
    {
        if (empty($this->parsed)) {
            return null;
        }

        $positions = [];
        $i = 0;

        foreach ($this->parsed as $each) {
            foreach ($each['resources'] as $resource) {
                if ($resource->format() !== 'location') {
                    continue;
                }

                $positions[] = new PositionModel([
                    'id' => ++$i,
                    'latitude' => $resource->latitude(),
                    'longitude' => $resource->longitude(),
                    'speed' => $resource->speed(),
                    'direction' => $resource->direction(),
                    'signal' => $resource->signal(),
                    'date_at' => $resource->datetime(),
                    'date_utc_at' => $resource->datetime(),
                ]);
            }
        }

        return new PositionCollection($positions);
    }
}

```

`app/Domains/Server/Controller/Status.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Server\Controller\Service\Status as ControllerService;

class Status extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($response = $this->actions()) {
            return $response;
        }

        $this->meta('title', __('server-status.meta-title'));

        return $this->page('server.status', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('startPorts')
            ?: $this->actionPost('stopPorts');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function startPorts(): RedirectResponse
    {
        $this->action()->startPorts();

        $this->sessionMessage('success', __('server-status.start-success'));

        return redirect()->back();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function stopPorts(): RedirectResponse
    {
        $this->action()->stopPorts();

        $this->sessionMessage('success', __('server-status.stop-success'));

        return redirect()->back();
    }
}

```

`app/Domains/Server/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Services\Protocol\ProtocolFactory;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actions()) {
            return $response;
        }

        $this->requestMergeWithRow();

        $this->meta('title', __('server-update.meta-title', ['title' => $this->row->port.' - '.$this->row->protocol]));

        return $this->page('server.update', [
            'row' => $this->row,
            'protocols' => array_keys(ProtocolFactory::list()),
        ]);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('update')
            ?: $this->actionPost('delete');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('server-update.success'));

        return redirect()->route('server.update', $this->row->id);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function delete(): RedirectResponse
    {
        $this->action()->delete();

        $this->sessionMessage('success', __('server-update.delete-success'));

        return redirect()->route('server.index');
    }
}

```

`app/Domains/Server/Controller/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;

class UpdateBoolean extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): JsonResponse|RedirectResponse
    {
        $this->row($id);

        return $this->request->wantsJson()
            ? $this->responseJson()
            : $this->responseRedirect();
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->factory()->fractal('simple', $this->action()->updateBoolean()));
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function responseRedirect(): RedirectResponse
    {
        $this->actionCallClosure($this->action()->updateBoolean(...));

        return redirect()->back();
    }
}

```

`app/Domains/Server/Controller/UpdateParser.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Server\Controller\Service\UpdateParser as ControllerService;

class UpdateParser extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        $this->meta('title', __('server-update-parser.meta-title', ['title' => $this->row->port.' - '.$this->row->protocol]));

        return $this->page('server.update-parser', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row, $this->actionPost('parse'))->data();
    }

    /**
     * @return array
     */
    protected function parse(): array
    {
        return $this->action()->parse();
    }
}

```

`app/Domains/Server/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth-admin-mode']], static function () {
    Route::any('/server', Index::class)->name('server.index');
    Route::any('/server/create', Create::class)->name('server.create');
    Route::any('/server/status', Status::class)->name('server.status');
    Route::any('/server/{id}', Update::class)->name('server.update');
    Route::any('/server/{id}/boolean/{column}', UpdateBoolean::class)->name('server.update.boolean');
    Route::any('/server/{id}/parser', UpdateParser::class)->name('server.update.parser');
});

```

`app/Domains/Server/Exception/ExceptionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Exception;

use App\Exceptions\GenericException;

abstract class ExceptionAbstract extends GenericException
{
}

```

`app/Domains/Server/Exception/PortBusy.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Exception;

class PortBusy extends ExceptionAbstract
{
    /**
     * @var int
     */
    protected $code = 412;

    /**
     * @var ?string
     */
    protected ?string $status = 'server-port-busy';
}

```

`app/Domains/Server/Exception/PortLocked.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Exception;

class PortLocked extends ExceptionAbstract
{
    /**
     * @var int
     */
    protected $code = 408;

    /**
     * @var ?string
     */
    protected ?string $status = 'server-port-locked';
}

```

`app/Domains/Server/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\Server\Model\Server as Model;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\Server\Model\Server $row
     *
     * @return array
     */
    protected function simple(Model $row): array
    {
        return $row->only('id', 'port', 'protocol', 'debug', 'enabled');
    }
}

```

`app/Domains/Server/Model/Builder/Server.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class Server extends BuilderAbstract
{
    /**
     * @param int $port
     *
     * @return self
     */
    public function byPort(int $port): self
    {
        return $this->where('port', $port);
    }

    /**
     * @param array $ports
     *
     * @return self
     */
    public function byPorts(array $ports): self
    {
        return $this->whereIntegerInRaw('port', $ports);
    }

    /**
     * @param string $protocol
     *
     * @return self
     */
    public function byProtocol(string $protocol): self
    {
        return $this->where('protocol', $protocol);
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderBy('port', 'ASC');
    }
}

```

`app/Domains/Server/Model/Collection/Server.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Server extends CollectionAbstract
{
}

```

`app/Domains/Server/Model/Server.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\Server\Model\Builder\Server as Builder;
use App\Domains\Server\Model\Collection\Server as Collection;
use App\Domains\Server\Test\Factory\Server as TestFactory;

class Server extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'server';

    /**
     * @const string
     */
    public const TABLE = 'server';

    /**
     * @const string
     */
    public const FOREIGN = 'server_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'debug' => 'boolean',
        'enabled' => 'boolean',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\Server\Model\Collection\Server
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Server\Model\Builder\Server
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Server\Test\Factory\Server
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }
}

```

`app/Domains/Server/Schedule/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Schedule;

use App\Domains\Core\Schedule\ScheduleAbstract;
use App\Domains\Server\Command\StartAll as StartAllCommand;

class Manager extends ScheduleAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->command(StartAllCommand::class)->everyMinute();
    }
}

```

`app/Domains/Server/Seeder/Server.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Seeder;

use App\Domains\Core\Seeder\SeederAbstract;
use App\Domains\Server\Model\Server as Model;

class Server extends SeederAbstract
{
    /**
     * @return void
     */
    public function run(): void
    {
        if (Model::query()->count()) {
            return;
        }

        $this->insertWithoutDuplicates(Model::class, 'port', $this->json('server'));
    }
}

```

`app/Domains/Server/Service/Command/Generator.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Service\Command;

class Generator
{
    /**
     * @param int $port
     * @param bool $reset = false
     * @param bool $debug = false
     *
     * @return string
     */
    public static function serverStartPort(int $port, bool $reset = false, bool $debug = false): string
    {
        return static::command('server:start:port', $port, $reset, $debug);
    }

    /**
     * @param string $command
     * @param int $port
     * @param bool $reset = false
     * @param bool $debug = false
     *
     * @return string
     */
    protected static function command(string $command, int $port, bool $reset, bool $debug): string
    {
        return implode(' ', array_filter([
            $command,
            static::port($port),
            static::reset($reset),
            static::debug($debug),
        ]));
    }

    /**
     * @param int $port
     *
     * @return string
     */
    protected static function port(int $port): string
    {
        return '--port='.$port;
    }

    /**
     * @param bool $reset
     *
     * @return ?string
     */
    protected static function reset(bool $reset): ?string
    {
        return $reset ? '--reset' : null;
    }

    /**
     * @param bool $debug
     *
     * @return ?string
     */
    protected static function debug(bool $debug): ?string
    {
        return $debug ? '--debug' : null;
    }
}

```

`app/Domains/Server/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'port' => ['bail', 'integer', 'required'],
            'protocol' => ['bail', 'string', 'required'],
            'debug' => ['bail', 'boolean'],
            'enabled' => ['bail', 'boolean'],
        ];
    }
}

```

`app/Domains/Server/Validate/LogRead.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class LogRead extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'protocol' => ['bail', 'required'],
            'file' => ['bail', 'required'],

            'debug' => ['bail', 'boolean'],
        ];
    }
}

```

`app/Domains/Server/Validate/Parse.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Parse extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'log' => ['bail', 'required'],
        ];
    }
}

```

`app/Domains/Server/Validate/StartAll.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class StartAll extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'reset' => ['bail', 'boolean'],
            'debug' => ['bail', 'boolean'],
        ];
    }
}

```

`app/Domains/Server/Validate/StartPort.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class StartPort extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'port' => ['bail', 'integer', 'required'],
            'reset' => ['bail', 'boolean'],
            'debug' => ['bail', 'boolean'],
        ];
    }
}

```

`app/Domains/Server/Validate/StartPorts.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class StartPorts extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'ports' => ['bail', 'required', 'array'],
            'ports.*' => ['bail', 'required', 'integer'],
            'reset' => ['bail', 'boolean'],
            'debug' => ['bail', 'boolean'],
        ];
    }
}

```

`app/Domains/Server/Validate/StopPorts.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class StopPorts extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'ports' => ['bail', 'required', 'array'],
            'ports.*' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/Server/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Validate;

class Update extends Create
{
}

```

`app/Domains/Server/Validate/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Validate;

use App\Domains\CoreApp\Validate\UpdateBoolean as UpdateBooleanCoreApp;

class UpdateBoolean extends UpdateBooleanCoreApp
{
}

```

`app/Domains/Server/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Server\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Shared/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Shared\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @param string $slug
     *
     * @return void
     */
    protected function publicIsAvailable(string $slug): void
    {
        if ($this->publicIsAvailableCheck($slug) === false) {
            abort(404);
        }
    }

    /**
     * @param string $slug
     *
     * @return bool
     */
    protected function publicIsAvailableCheck(string $slug): bool
    {
        $configuration = app('configuration');

        return $configuration->bool('shared_enabled')
            && ($configuration->string('shared_slug') === $slug);
    }
}

```

`app/Domains/Shared/Controller/Device.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Shared\Controller;

use Illuminate\Http\Response;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Shared\Controller\Service\Device as ControllerService;

class Device extends ControllerAbstract
{
    /**
     * @var \App\Domains\Device\Model\Device
     */
    protected DeviceModel $device;

    /**
     * @param string $code
     *
     * @return \Illuminate\Http\Response
     */
    public function __invoke(string $code): Response
    {
        $this->device($code);

        $this->meta('title', __('shared-device.meta-title', ['title' => $this->device->name]));

        return $this->page('shared.device', $this->data());
    }

    /**
     * @param string $code
     *
     * @return void
     */
    protected function device(string $code): void
    {
        $this->device = DeviceModel::query()
            ->byCode($code)
            ->whereShared()
            ->firstOr(fn () => $this->exceptionNotFound(__('shared-device.error.not-found')));
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->device)->data();
    }
}

```

`app/Domains/Shared/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Shared\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Response;
use App\Domains\Shared\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @param string $slug = ''
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse
     */
    public function __invoke(string $slug = ''): Response|JsonResponse
    {
        $this->publicIsAvailable($slug);

        if ($this->request->wantsJson()) {
            return $this->responseJson();
        }

        $this->meta('title', __('shared-index.meta-title'));

        return $this->page('shared.index.index', $this->data());
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->factory('Device')->fractal('map', $this->data()['devices']));
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request)->data();
    }
}

```

`app/Domains/Shared/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Shared\Controller\Service;

use App\Domains\Core\Controller\Service\ControllerAbstract as ControllerAbstractCore;
use App\Domains\Core\Traits\Factory;

abstract class ControllerAbstract extends ControllerAbstractCore
{
    use Factory;
}

```

`app/Domains/Shared/Controller/Service/Device.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Shared\Controller\Service;

use Illuminate\Http\Request;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Trip\Model\Collection\Trip as TripCollection;
use App\Domains\Trip\Model\Trip as TripModel;

class Device extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \App\Domains\Device\Model\Device $device
     *
     * @return self
     */
    public function __construct(Request $request, protected DeviceModel $device)
    {
        $this->request = $request;
        $this->setUser();
    }

    /**
     * @return void
     */
    public function setUser(): void
    {
        $this->factory('User', $this->device->user)->action()->set();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'device' => $this->device,
            'trips' => $this->trips(),
            'shared_available' => $this->sharedAvailable(),
        ];
    }

    /**
     * @return \App\Domains\Trip\Model\Collection\Trip
     */
    protected function trips(): TripCollection
    {
        return $this->cache(
            fn () => TripModel::query()
                ->byDeviceId($this->device->id)
                ->whereSharedPublic()
                ->list()
                ->get()
        );
    }

    /**
     * @return bool
     */
    protected function sharedAvailable(): bool
    {
        return $this->device->shared_public
            && app('configuration')->bool('shared_enabled');
    }
}

```

`app/Domains/Shared/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Shared\Controller\Service;

use Illuminate\Http\Request;
use App\Domains\Device\Model\Collection\Device as DeviceCollection;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Trip\Model\Collection\Trip as TripCollection;
use App\Domains\Trip\Model\Trip as TripModel;

class Index extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     *
     * @return self
     */
    public function __construct(Request $request)
    {
        $this->request = $request;

        $this->setUser();
    }

    /**
     * @return void
     */
    public function setUser(): void
    {
        if ($device = $this->device() ?: $this->devices()->first()) {
            $this->factory('User', $device->user)->action()->set();
        }
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'devices' => $this->devices(),
            'device' => $this->device(),
            'trips' => $this->trips(),
            'trip' => $this->trip(),
            'trip_next_code' => $this->tripNextCode(),
            'trip_previous_code' => $this->tripPreviousCode(),
            'positions' => $this->positions(),
        ];
    }

    /**
     * @return \App\Domains\Device\Model\Collection\Device
     */
    protected function devices(): DeviceCollection
    {
        return $this->cache(
            fn () => DeviceModel::query()
                ->whereSharedPublic()
                ->whenIds($this->requestArray('ids'))
                ->whenTripFinished($this->requestBool('finished', null))
                ->withVehicle()
                ->withWhereHasPositionLast()
                ->list()
                ->get()
        );
    }

    /**
     * @return ?\App\Domains\Device\Model\Device
     */
    protected function device(): ?DeviceModel
    {
        return $this->cache(
            fn () => $this->devices()
                ->firstWhere('code', $this->request->input('device_code'))
        );
    }

    /**
     * @return \App\Domains\Trip\Model\Collection\Trip
     */
    protected function trips(): TripCollection
    {
        if ($this->device() === null) {
            return new TripCollection();
        }

        return $this->cache(
            fn () => TripModel::query()
                ->selectSimple()
                ->byDeviceId($this->device()->id)
                ->whereSharedPublic()
                ->list()
                ->limit(100)
                ->get()
        );
    }

    /**
     * @return ?\App\Domains\Trip\Model\Trip
     */
    protected function trip(): ?TripModel
    {
        return $this->cache(
            fn () => $this->trips()
                ->firstWhere('code', $this->request->input('trip_code'))
                ?: $this->trips()->first()
        );
    }

    /**
     * @return ?string
     */
    protected function tripNextCode(): ?string
    {
        if ($this->trip() === null) {
            return null;
        }

        return $this->cache(
            fn () => $this->trips()
                ->reverse()
                ->firstWhere('start_utc_at', '>', $this->trip()->start_utc_at)
                ->code ?? null
        );
    }

    /**
     * @return ?string
     */
    protected function tripPreviousCode(): ?string
    {
        if ($this->trip() === null) {
            return null;
        }

        return $this->cache(
            fn () => $this->trips()
                ->firstWhere('start_utc_at', '<', $this->trip()->start_utc_at)
                ->code ?? null
        );
    }

    /**
     * @return \App\Domains\Position\Model\Collection\Position
     */
    protected function positions(): PositionCollection
    {
        if ($this->trip() === null) {
            return new PositionCollection();
        }

        return $this->cache(
            fn () => $this->trip()
                ->positions()
                ->withCityState()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Shared/Controller/Trip.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Shared\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Response;
use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Trip\Model\Trip as TripModel;

class Trip extends ControllerAbstract
{
    /**
     * @var \App\Domains\Trip\Model\Trip
     */
    protected TripModel $trip;

    /**
     * @param string $code
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse
     */
    public function __invoke(string $code): Response|JsonResponse
    {
        $this->trip($code);

        if ($this->request->wantsJson()) {
            return $this->responseJson();
        }

        $this->meta('title', __('shared-trip.meta-title', ['title' => $this->trip->name]));

        return $this->page('shared.trip', [
            'trip' => $this->trip,
            'device' => $this->trip->device,
            'positions' => $this->positions(),
            'stats' => $this->trip->stats,
        ]);
    }

    /**
     * @param string $code
     *
     * @return void
     */
    protected function trip(string $code): void
    {
        $this->trip = TripModel::query()
            ->byCode($code)
            ->whereShared()
            ->firstOr(fn () => $this->exceptionNotFound(__('shared-trip.error.not-found')));

        $this->factory('User', $this->trip->user)->action()->set();
    }

    /**
     * @return \App\Domains\Position\Model\Collection\Position
     */
    protected function positions(): PositionCollection
    {
        return $this->trip->positions()
            ->withCityState()
            ->list()
            ->get();
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->factory('Trip')->fractal('live', $this->responseJsonList()));
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    protected function responseJsonList(): TripModel
    {
        return $this->trip->setRelation('positions', $this->responseJsonListPositions());
    }

    /**
     * @return \App\Domains\Position\Model\Collection\Position
     */
    protected function responseJsonListPositions(): PositionCollection
    {
        return $this->trip->positions()
            ->byIdNext((int)$this->request->input('id_from'))
            ->withCityState()
            ->list()
            ->get();
    }
}

```

`app/Domains/Shared/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Shared\Controller;

use Illuminate\Support\Facades\Route;

Route::get('/shared/device/{uuid}', Device::class)->name('shared.device');
Route::get('/shared/trip/{uuid}', Trip::class)->name('shared.trip');
Route::get('/shared/{slug?}', Index::class)->name('shared.index');

```

`app/Domains/State/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\State\Model\State as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\State\Model\State
     */
    protected ?Model $row;
}

```

`app/Domains/State/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\State\Model\State as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\State\Model\State
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\State\Model\State
     */
    public function getOrNew(): Model
    {
        return $this->actionHandle(GetOrNew::class, $this->validate()->getOrNew());
    }

    /**
     * @return \App\Domains\State\Model\State
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\State\Model\State
     */
    public function updateMerge(): Model
    {
        return $this->actionHandle(UpdateMerge::class, $this->validate()->updateMerge());
    }
}

```

`app/Domains/State/Action/GetOrNew.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Action;

use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\State\Model\State as Model;

class GetOrNew extends ActionAbstract
{
    /**
     * @var \App\Domains\Country\Model\Country
     */
    protected CountryModel $country;

    /**
     * @return \App\Domains\State\Model\State
     */
    public function handle(): Model
    {
        $this->country();
        $this->row();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function country(): void
    {
        $this->country = CountryModel::query()
            ->findOrFail($this->data['country_id']);
    }

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = $this->rowByName()
            ?: $this->rowByAlias()
            ?: $this->rowByCreate();
    }

    /**
     * @return ?\App\Domains\State\Model\State
     */
    protected function rowByName(): ?Model
    {
        return Model::query()
            ->byName($this->data['name'])
            ->byCountryId($this->country->id)
            ->first();
    }

    /**
     * @return ?\App\Domains\State\Model\State
     */
    protected function rowByAlias(): ?Model
    {
        return Model::query()
            ->byAlias($this->data['name'])
            ->byCountryId($this->country->id)
            ->first();
    }

    /**
     * @return \App\Domains\State\Model\State
     */
    protected function rowByCreate(): Model
    {
        return Model::query()->create([
            'name' => $this->data['name'],
            'country_id' => $this->country->id,
        ]);
    }
}

```

`app/Domains/State/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Action;

use App\Domains\City\Model\City as CityModel;
use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\State\Model\State as Model;

class Update extends ActionAbstract
{
    /**
     * @var bool
     */
    protected bool $relocate;

    /**
     * @return \App\Domains\State\Model\State
     */
    public function handle(): Model
    {
        $this->relocate();
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function relocate(): void
    {
        $this->relocate = ($this->data['country_id'] !== $this->row->country_id);
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataAlias();
    }

    /**
     * @return void
     */
    protected function dataAlias(): void
    {
        $this->data['alias'] = array_filter(array_map('trim', explode(',', $this->data['alias'])));
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkCountryId();
    }

    /**
     * @return void
     */
    protected function checkCountryId(): void
    {
        if ($this->checkCountryIdExists() === false) {
            $this->exceptionValidator(__('state-update.error.country-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkCountryIdExists(): bool
    {
        return CountryModel::query()
            ->byId($this->data['country_id'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveRow();
        $this->saveCity();
    }

    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->row->name = $this->data['name'];
        $this->row->alias = $this->data['alias'];
        $this->row->country_id = $this->data['country_id'];
        $this->row->save();
    }

    /**
     * @return void
     */
    protected function saveCity(): void
    {
        if ($this->relocate === false) {
            return;
        }

        CityModel::query()->byStateId($this->row->id)->update([
            'country_id' => $this->row->country_id,
        ]);
    }
}

```

`app/Domains/State/Action/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Action;

use App\Domains\City\Model\City as CityModel;
use App\Domains\State\Model\Collection\State as Collection;
use App\Domains\State\Model\State as Model;

class UpdateMerge extends ActionAbstract
{
    /**
     * @var \App\Domains\State\Model\Collection\State
     */
    protected Collection $list;

    /**
     * @return \App\Domains\State\Model\State
     */
    public function handle(): Model
    {
        $this->list();
        $this->data();
        $this->check();
        $this->save();
        $this->delete();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function list(): void
    {
        $this->list = Model::query()
            ->byIdNot($this->row->id)
            ->byIds($this->data['ids'])
            ->get();
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataIds();
        $this->dataAlias();
    }

    /**
     * @return void
     */
    protected function dataIds(): void
    {
        $this->data['ids'] = $this->list->pluck('id')->all();
    }

    /**
     * @return void
     */
    protected function dataAlias(): void
    {
        $this->data['alias'] = array_unique(array_filter(array_merge(
            (array)$this->row->alias,
            $this->list->pluck('name')->all(),
            ...array_filter($this->list->pluck('alias')->all())
        )));
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        if ($this->list->isEmpty()) {
            $this->exceptionValidator(__('state-update-merge.error.ids-empty'));
        }
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveCity();
        $this->saveRow();
    }

    /**
     * @return void
     */
    protected function saveCity(): void
    {
        CityModel::query()
            ->byStateIds($this->data['ids'])
            ->update($this->saveCityData());
    }

    /**
     * @return array
     */
    protected function saveCityData(): array
    {
        return [
            'state_id' => $this->row->id,
            'country_id' => $this->row->country_id,
        ];
    }

    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->row->alias = $this->data['alias'];
        $this->row->save();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        Model::query()
            ->byIds($this->data['ids'])
            ->delete();
    }
}

```

`app/Domains/State/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\State\Model\State as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\State\Model\State
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\State\Model\State
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->firstOr(fn () => $this->exceptionNotFound(__('state.error.not-found')));
    }
}

```

`app/Domains/State/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Controller;

use Illuminate\Http\Response;
use App\Domains\State\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('state-index.meta-title'));

        return $this->page('state.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/State/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/State/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\State\Model\Collection\State as Collection;
use App\Domains\State\Model\State as Model;

class Index extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\State\Model\Collection\State
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->withCountry()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/State/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Country\Model\Collection\Country as CountryCollection;
use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\State\Model\State as Model;

class Update extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\State\Model\State $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
    }

    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow(data: ['alias' => $this->requestAlias()]);
    }

    /**
     * @return string
     */
    protected function requestAlias(): string
    {
        return $this->request->input('alias')
            ?: implode(',', $this->row->alias ?? []);
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'countries' => $this->countries(),
        ];
    }

    /**
     * @return \App\Domains\Country\Model\Collection\Country
     */
    protected function countries(): CountryCollection
    {
        return CountryModel::query()
            ->list()
            ->get();
    }
}

```

`app/Domains/State/Controller/Service/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\State\Model\Collection\State as Collection;
use App\Domains\State\Model\State as Model;

class UpdateMerge extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\State\Model\State $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\State\Model\Collection\State
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->byIdNot($this->row->id)
                ->withCountry()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/State/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\State\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('update')) {
            return $response;
        }

        $this->meta('title', __('state-update.meta-title', ['title' => $this->row->name]));

        return $this->page('state.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('state-update.success'));

        return redirect()->route('state.update', $this->row->id);
    }
}

```

`app/Domains/State/Controller/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\State\Controller\Service\UpdateMerge as ControllerService;

class UpdateMerge extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('updateMerge')) {
            return $response;
        }

        $this->meta('title', __('state-update-merge.meta-title', ['title' => $this->row->name]));

        return $this->page('state.update-merge', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateMerge(): RedirectResponse
    {
        $this->action()->updateMerge();

        $this->sessionMessage('success', __('state-update-merge.success'));

        return redirect()->route('state.update.merge', $this->row->id);
    }
}

```

`app/Domains/State/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth-admin-mode']], static function () {
    Route::get('/state', Index::class)->name('state.index');
    Route::any('/state/{id}', Update::class)->name('state.update');
    Route::any('/state/{id}/merge', UpdateMerge::class)->name('state.update.merge');
});

```

`app/Domains/State/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\State\Model\State as Model;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\State\Model\State $row
     *
     * @return array
     */
    protected function related(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
        ];
    }
}

```

`app/Domains/State/Model/Builder/State.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Model\Builder;

use App\Domains\City\Model\City as CityModel;
use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class State extends BuilderAbstract
{
    /**
     * @param string $alias
     *
     * @return self
     */
    public function byAlias(string $alias): self
    {
        return $this->whereJsonContains('alias', $alias);
    }

    /**
     * @param int $country_id
     *
     * @return self
     */
    public function byCountryId(int $country_id): self
    {
        return $this->where('country_id', $country_id);
    }

    /**
     * @param array $country_ids
     *
     * @return self
     */
    public function byCountryIds(array $country_ids): self
    {
        return $this->whereIntegerInRaw('country_id', $country_ids);
    }

    /**
     * @param int $device_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     * @param ?string $start_end
     *
     * @return self
     */
    public function byDeviceIdWhenTripStartUtcAtDateBetween(int $device_id, ?string $before_start_utc_at, ?string $after_start_utc_at, ?string $start_end): self
    {
        return $this->whereIn('id', CityModel::query()->select('state_id')->byDeviceIdWhenTripStartUtcAtDateBetween($device_id, $before_start_utc_at, $after_start_utc_at, $start_end));
    }

    /**
     * @param string $name
     *
     * @return self
     */
    public function byName(string $name): self
    {
        return $this->where('name', $name);
    }

    /**
     * @param int $vehicle_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     * @param ?string $start_end
     *
     * @return self
     */
    public function byVehicleIdWhenTripStartUtcAtDateBetween(int $vehicle_id, ?string $before_start_utc_at, ?string $after_start_utc_at, ?string $start_end): self
    {
        return $this->whereIn('id', CityModel::query()->select('state_id')->byVehicleIdWhenTripStartUtcAtDateBetween($vehicle_id, $before_start_utc_at, $after_start_utc_at, $start_end));
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderBy('name', 'ASC');
    }

    /**
     * @return self
     */
    public function selectRelated(): self
    {
        return $this->select('id', 'name', 'country_id');
    }

    /**
     * @param ?int $country_id
     *
     * @return self
     */
    public function whenCountryId(?int $country_id): self
    {
        return $this->when($country_id, fn ($q) => $q->byCountryId($country_id));
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_date_at
     * @param ?string $after_date_at
     *
     * @return self
     */
    public function whenRefuelUserIdVehicleIdDateAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_date_at, ?string $after_date_at): self
    {
        return $this->whereIn('id', CityModel::query()->select('state_id')->whenRefuelUserIdVehicleIdDateAtBetween($user_id, $vehicle_id, $before_date_at, $after_date_at));
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_start_at
     * @param ?string $after_start_at
     *
     * @return self
     */
    public function whenTripUserIdVehicleIdStartAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_start_at, ?string $after_start_at): self
    {
        return $this->whereIn('id', CityModel::query()->select('state_id')->whenTripUserIdVehicleIdStartAtBetween($user_id, $vehicle_id, $before_start_at, $after_start_at));
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     *
     * @return self
     */
    public function whenTripUserIdVehicleIdStartUtcAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_start_utc_at, ?string $after_start_utc_at): self
    {
        return $this->whereIn('id', CityModel::query()->select('state_id')->whenTripUserIdVehicleIdStartUtcAtBetween($user_id, $vehicle_id, $before_start_utc_at, $after_start_utc_at));
    }

    /**
     * @return self
     */
    public function withCountry(): self
    {
        return $this->with('country');
    }
}

```

`app/Domains/State/Model/Collection/State.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class State extends CollectionAbstract
{
}

```

`app/Domains/State/Model/State.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\State\Model\Builder\State as Builder;
use App\Domains\State\Model\Collection\State as Collection;
use App\Domains\State\Test\Factory\State as TestFactory;

class State extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'state';

    /**
     * @const string
     */
    public const TABLE = 'state';

    /**
     * @const string
     */
    public const FOREIGN = 'state_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'alias' => 'array',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\State\Model\Collection\State
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\State\Model\Builder\State
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\State\Test\Factory\State
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function country(): BelongsTo
    {
        return $this->belongsTo(CountryModel::class, CountryModel::FOREIGN);
    }
}

```

`app/Domains/State/Validate/GetOrNew.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class GetOrNew extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'country_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/State/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Update extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'alias' => ['bail'],
            'country_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/State/Validate/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdateMerge extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'ids' => ['bail', 'required', 'array'],
        ];
    }
}

```

`app/Domains/State/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\State\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Timezone/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\Timezone\Model\Timezone as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Timezone\Model\Timezone
     */
    protected ?Model $row;
}

```

`app/Domains/Timezone/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Timezone\Model\Timezone as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Timezone\Model\Timezone
     */
    protected ?Model $row;

    /**
     * @return void
     */
    public function geojson(): void
    {
        $this->actionHandle(Geojson::class, $this->validate()->geojson());
    }

    /**
     * @return \App\Domains\Timezone\Model\Timezone
     */
    public function updateDefault(): Model
    {
        return $this->actionHandle(UpdateDefault::class);
    }
}

```

`app/Domains/Timezone/Action/Geojson.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Action;

use stdClass;
use Throwable;
use Illuminate\Console\Concerns\InteractsWithIO;
use Symfony\Component\Console\Output\ConsoleOutput;
use App\Domains\Timezone\Model\Timezone as Model;
use App\Exceptions\UnexpectedValueException;
use App\Services\Compress\Zip\Extract as ZipExtract;
use App\Services\Curl\Curl;

class Geojson extends ActionAbstract
{
    use InteractsWithIO;

    /**
     * @const string
     */
    protected const STORAGE_PATH = 'storage/app/timezone';

    /**
     * @const string
     */
    protected const RELEASE_URL = 'https://api.github.com/repos/evansiroky/timezone-boundary-builder/releases/latest';

    /**
     * @const string
     */
    protected const DOWNLOAD_URL = 'https://github.com/evansiroky/timezone-boundary-builder/releases/download/%s/timezones-with-oceans.geojson.zip';

    /**
     * @var \stdClass
     */
    protected stdClass $release;

    /**
     * @var string
     */
    protected string $geojson;

    /**
     * @var string
     */
    protected string $zip;

    /**
     * @var string
     */
    protected string $url;

    /**
     * @var bool
     */
    protected bool $exists;

    /**
     * @var bool
     */
    protected bool $overwrite;

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->output();
        $this->release();
        $this->files();
        $this->exists();
        $this->overwrite();

        if ($this->overwrite === false) {
            $this->skip();

            return;
        }

        $this->download();
        $this->extract();
        $this->replace();
        $this->iterate();
    }

    /**
     * @return void
     */
    protected function output(): void
    {
        $this->output = new ConsoleOutput();
    }

    /**
     * @return void
     */
    protected function release(): void
    {
        $this->print('Checking Releases from %s', static::RELEASE_URL);

        $this->release = Curl::new()->setUrl(static::RELEASE_URL)->send()->getBody('object');

        if (empty($this->release->tag_name)) {
            throw new UnexpectedValueException('Releases can not be loaded');
        }

        $this->print('Last Release %s', $this->release->tag_name);
    }

    /**
     * @return void
     */
    protected function files(): void
    {
        $storage = static::STORAGE_PATH.'/'.$this->release->tag_name;

        $this->url = sprintf(static::DOWNLOAD_URL, $this->release->tag_name);
        $this->zip = base_path($storage.'/timezones-with-oceans.geojson.zip');
        $this->geojson = base_path($storage.'/combined-with-oceans.json');
    }

    /**
     * @return void
     */
    protected function exists(): void
    {
        $this->exists = is_file($this->geojson);
    }

    /**
     * @return void
     */
    protected function overwrite(): void
    {
        $this->overwrite = $this->data['overwrite'] || ($this->exists === false);
    }

    /**
     * @return void
     */
    protected function skip(): void
    {
        $this->print('GeoJSON %s already loaded', $this->fileRelative($this->geojson));
    }

    /**
     * @return void
     */
    protected function download(): void
    {
        $this->print('Downloading %s to %s', $this->url, $this->fileRelative($this->zip));

        helper()->mkdir($this->zip, true);

        file_put_contents($this->zip, fopen($this->url, 'r'));
    }

    /**
     * @return void
     */
    protected function extract(): void
    {
        $this->print('Extracting GeoJSON from ZIP to %s', $this->fileRelative($this->geojson));

        ZipExtract::new($this->zip)->extract(basename($this->geojson));
    }

    /**
     * @return void
     */
    protected function replace(): void
    {
        $this->print('Optimizing GeoJSON %s', $this->fileRelative($this->geojson));

        file_put_contents(
            $this->geojson,
            preg_replace('/([0-9]\.[0-9]{4})[0-9]+/', '$1', file_get_contents($this->geojson)),
            LOCK_EX
        );
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach (json_decode(file_get_contents($this->geojson))->features as $zone) {
            $this->zone($zone);
        }
    }

    /**
     * @param \stdClass $zone
     *
     * @return void
     */
    protected function zone(stdClass $zone): void
    {
        $this->print('Updating %s', $zone->properties->tzid);

        try {
            $this->zoneUpdateOrInsert($zone, 0.005);
        } catch (Throwable $e) {
            $this->printError('Error %s', $zone->properties->tzid.': '.$e->getMessage());
            $this->zoneUpdateOrInsert($zone, 0);
        }
    }

    /**
     * @param \stdClass $zone
     * @param float $simplify
     *
     * @return void
     */
    protected function zoneUpdateOrInsert(stdClass $zone, float $simplify): void
    {
        Model::query()->updateOrInsert(
            ['zone' => $zone->properties->tzid],
            ['geojson' => Model::geomFromGeoJSON($zone->geometry, $simplify)]
        );
    }

    /**
     * @param string $file
     *
     * @return string
     */
    protected function fileRelative(string $file): string
    {
        return str_replace(base_path(), '', $file);
    }

    /**
     * @param string $message
     * @param mixed ...$parameters
     *
     * @return void
     */
    protected function print(string $message, mixed ...$parameters): void
    {
        $this->info(sprintf('[%s] '.$message, date('Y-m-d H:i:s'), ...$parameters));
    }

    /**
     * @param string $message
     * @param mixed ...$parameters
     *
     * @return void
     */
    protected function printError(string $message, mixed ...$parameters): void
    {
        $this->error(sprintf('[%s] '.$message, date('Y-m-d H:i:s'), ...$parameters));
    }
}

```

`app/Domains/Timezone/Action/UpdateDefault.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Action;

use App\Domains\Timezone\Model\Timezone as Model;

class UpdateDefault extends ActionAbstract
{
    /**
     * @return \App\Domains\Timezone\Model\Timezone
     */
    public function handle(): Model
    {
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveRow();
        $this->saveOthers();
    }

    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->row->default = true;
        $this->row->save();
    }

    /**
     * @return void
     */
    protected function saveOthers(): void
    {
        Model::query()
            ->byIdNot($this->row->id)
            ->whereDefault()
            ->update(['default' => false]);
    }
}

```

`app/Domains/Timezone/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Command;

use App\Domains\CoreApp\Command\CommandAbstract as CommandAbstractSahred;
use App\Domains\Timezone\Model\Timezone as Model;

abstract class CommandAbstract extends CommandAbstractSahred
{
    /**
     * @var \App\Domains\Timezone\Model\Timezone
     */
    protected Model $row;
}

```

`app/Domains/Timezone/Command/Geojson.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Command;

class Geojson extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'timezone:geojson {--overwrite}';

    /**
     * @var string
     */
    protected $description = 'Generate Timezones From Remote GeoJSON';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->requestWithOptions();
        $this->factory()->action()->geojson();

        $this->info('[END]');
    }
}

```

`app/Domains/Timezone/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\Timezone\Model\Timezone as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\Timezone\Model\Timezone
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Timezone\Model\Timezone
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->firstOr(fn () => $this->exceptionNotFound(__('timezone.error.not-found')));
    }
}

```

`app/Domains/Timezone/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Controller;

use Illuminate\Http\Response;
use App\Domains\Timezone\Model\Timezone as Model;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('timezone-index.meta-title'));

        return $this->page('timezone.index', [
            'list' => Model::query()->list()->get(),
        ]);
    }
}

```

`app/Domains/Timezone/Controller/UpdateDefault.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;
use App\Domains\Timezone\Model\Timezone as Model;

class UpdateDefault extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): JsonResponse|RedirectResponse
    {
        $this->row($id);

        $this->actionCall('updateDefault');

        if ($this->request->wantsJson()) {
            return $this->responseJson();
        }

        return redirect()->back();
    }

    /**
     * @return \App\Domains\Timezone\Model\Timezone
     */
    protected function updateDefault(): Model
    {
        return $this->action()->updateDefault();
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->factory()->fractal('simple', $this->row));
    }
}

```

`app/Domains/Timezone/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth-admin-mode']], static function () {
    Route::get('/timezone', Index::class)->name('timezone.index');
    Route::any('/timezone/{id}/default', UpdateDefault::class)->name('timezone.update.default');
});

```

`app/Domains/Timezone/ControllerApi/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\ControllerApi;

use App\Domains\CoreApp\Controller\ControllerApiAbstract as CoreControllerApiAbstract;

abstract class ControllerApiAbstract extends CoreControllerApiAbstract
{
}

```

`app/Domains/Timezone/ControllerApi/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Timezone\Model\Timezone as Model;

class Index extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('json', Model::query()->list()->get()));
    }
}

```

`app/Domains/Timezone/ControllerApi/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\ControllerApi;

use Illuminate\Support\Facades\Route;

Route::get('/timezone', Index::class)->name('timezone.index');

```

`app/Domains/Timezone/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\Timezone\Model\Timezone as Model;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\Timezone\Model\Timezone $row
     *
     * @return array
     */
    protected function json(Model $row): array
    {
        return $this->simple($row);
    }

    /**
     * @param \App\Domains\Timezone\Model\Timezone $row
     *
     * @return array
     */
    protected function related(Model $row): array
    {
        return $this->simple($row);
    }

    /**
     * @param \App\Domains\Timezone\Model\Timezone $row
     *
     * @return array
     */
    protected function simple(Model $row): array
    {
        return $row->only('id', 'zone', 'default');
    }
}

```

`app/Domains/Timezone/Model/Builder/Timezone.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\Timezone\Model\Timezone as Model;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class Timezone extends BuilderAbstract
{
    /**
     * @param float $latitude
     * @param float $longitude
     *
     * @return self
     */
    public function byLatitudeLongitude(float $latitude, float $longitude): self
    {
        return $this->whereRaw(sprintf(
            'ST_CONTAINS(`geojson`, POINT(%f, %f))',
            helper()->longitude($longitude),
            helper()->latitude($latitude),
        ));
    }

    /**
     * @param string $zone
     *
     * @return self
     */
    public function byZone(string $zone): self
    {
        return $this->where('zone', $zone);
    }

    /**
     * @param int $vehicle_id
     *
     * @return self
     */
    public function byVehicleId(int $vehicle_id): self
    {
        return $this->whereIn('id', VehicleModel::query()->select('timezone_id')->byId($vehicle_id));
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderBy('default', 'DESC')->orderBy('zone', 'ASC');
    }

    /**
     * @return self
     */
    public function selectRelated(): self
    {
        return $this->select('id', 'zone', 'default');
    }

    /**
     * @param ?int $id
     *
     * @return self
     */
    public function whenIdOrDefault(?int $id): self
    {
        return $this->when($id, fn ($q) => $q->byId($id), fn ($q) => $q->whereDefault(true));
    }

    /**
     * @param bool $default = true
     *
     * @return self
     */
    public function whereDefault(bool $default = true): self
    {
        return $this->where('default', $default);
    }

    /**
     * @return self
     */
    public function whereGeojson(): self
    {
        return $this->whereRaw('`geojson` != '.Model::emptyGeoJSON());
    }
}

```

`app/Domains/Timezone/Model/Collection/Timezone.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Timezone extends CollectionAbstract
{
}

```

`app/Domains/Timezone/Model/Timezone.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\CoreApp\Model\Traits\Gis as GisTrait;
use App\Domains\Timezone\Model\Builder\Timezone as Builder;
use App\Domains\Timezone\Model\Collection\Timezone as Collection;
use App\Domains\Timezone\Test\Factory\Timezone as TestFactory;

class Timezone extends ModelAbstract
{
    use GisTrait;
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'timezone';

    /**
     * @const string
     */
    public const TABLE = 'timezone';

    /**
     * @const string
     */
    public const FOREIGN = 'timezone_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'default' => 'boolean',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\Timezone\Model\Collection\Timezone
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Timezone\Model\Builder\Timezone
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Timezone\Test\Factory\Timezone
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }
}

```

`app/Domains/Timezone/Seeder/Timezone.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Seeder;

use Illuminate\Contracts\Database\Query\Expression;
use App\Domains\Core\Seeder\SeederAbstract;
use App\Domains\Timezone\Model\Timezone as Model;

class Timezone extends SeederAbstract
{
    /**
     * @return void
     */
    public function run(): void
    {
        $this->insertWithoutDuplicates(Model::class, 'zone', $this->map($this->json('timezone')));
    }

    /**
     * @param array $list
     *
     * @return array
     */
    protected function map(array $list): array
    {
        $geojson = $this->geojson();

        return array_map(static fn ($row) => ['geojson' => $geojson] + $row, $list);
    }

    /**
     * @return \Illuminate\Contracts\Database\Query\Expression
     */
    protected function geojson(): Expression
    {
        return Model::db()->raw(Model::emptyGeoJSON());
    }
}

```

`app/Domains/Timezone/Validate/Geojson.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Geojson extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'overwrite' => ['bail', 'boolean'],
        ];
    }
}

```

`app/Domains/Timezone/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Timezone\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Tool/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Tool\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;

abstract class ActionAbstract extends ActionAbstractCore
{
}

```

`app/Domains/Tool/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Tool\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @return void
     */
    public function manifestGenerate(): void
    {
        $this->actionHandle(ManifestGenerate::class);
    }
}

```

`app/Domains/Tool/Action/ManifestGenerate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Tool\Action;

class ManifestGenerate extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->save();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        file_put_contents(public_path('manifest.json'), helper()->jsonEncode($this->contents()));
    }

    /**
     * @return array
     */
    protected function contents(): array
    {
        return [
            'name' => config('app.name'),
            'short_name' => config('app.name'),
            'start_url' => config('app.url'),
            'scope' => config('app.url'),
            'theme_color' => 'white',
            'background_color' => 'white',
            'display' => 'standalone',
            'orientation' => 'any',
            'icons' => [
                [
                    'src' => asset('/build/images/webapp/logo.png'),
                    'type' => 'image/png',
                ],
            ],
            'splash_screens' => [
                [
                    'src' => asset('/build/images/webapp/startup.png'),
                    'type' => 'image/png',
                ],
            ],
        ];
    }
}

```

`app/Domains/Tool/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Tool\Command;

use App\Domains\CoreApp\Command\CommandAbstract as CommandAbstractSahred;

abstract class CommandAbstract extends CommandAbstractSahred
{
}

```

`app/Domains/Tool/Command/ManifestGenerate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Tool\Command;

class ManifestGenerate extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'tool:manifest:generate';

    /**
     * @var string
     */
    protected $description = 'Generate the manifest.json file';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->factory()->action()->manifestGenerate();

        $this->info('[END]');
    }
}

```

`app/Domains/Trip/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\Trip\Model\Trip as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Trip\Model\Trip
     */
    protected ?Model $row;
}

```

`app/Domains/Trip/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use Symfony\Component\HttpFoundation\StreamedResponse;
use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Trip\Model\Trip as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Trip\Model\Trip
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function create(): Model
    {
        return $this->actionHandle(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandle(Delete::class);
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function import(): Model
    {
        return $this->actionHandle(Import::class, $this->validate()->import());
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function lastOrNew(): Model
    {
        return $this->actionHandle(LastOrNew::class, $this->validate()->lastOrNew());
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function updateBoolean(): Model
    {
        return $this->actionHandle(UpdateBoolean::class, $this->validate()->updateBoolean());
    }

    /**
     * @return ?\Symfony\Component\HttpFoundation\StreamedResponse
     */
    public function updateExport(): ?StreamedResponse
    {
        return $this->actionHandle(UpdateExport::class);
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function updateMerge(): Model
    {
        return $this->actionHandle(UpdateMerge::class, $this->validate()->updateMerge());
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function updateNameDistanceTime(): Model
    {
        return $this->actionHandle(UpdateNameDistanceTime::class);
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function updatePositionCreate(): Model
    {
        return $this->actionHandle(UpdatePositionCreate::class, $this->validate()->updatePositionCreate());
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function updatePositionDelete(): Model
    {
        return $this->actionHandle(UpdatePositionDelete::class, $this->validate()->updatePositionDelete());
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function updateStats(): Model
    {
        return $this->actionHandle(UpdateStats::class);
    }

    /**
     * @return void
     */
    public function updateStatsAll(): void
    {
        $this->actionHandle(UpdateStatsAll::class, $this->validate()->updateStatsAll());
    }
}

```

`app/Domains/Trip/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\Trip\Model\Trip as Model;

class Create extends ActionAbstract
{
    /**
     * @var \App\Domains\Device\Model\Device
     */
    protected DeviceModel $device;

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function handle(): Model
    {
        $this->device();
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function device(): void
    {
        $this->device = DeviceModel::query()->findOrFail($this->data['device_id']);
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataCode();
        $this->dataName();
        $this->dataEndAt();
        $this->dataEndUtcAt();
        $this->dataShared();
        $this->dataSharedPublic();
        $this->dataDeviceId();
        $this->dataUserId();
        $this->dataVehicleId();
    }

    /**
     * @return void
     */
    protected function dataCode(): void
    {
        $this->data['code'] = $this->row?->code ?: helper()->uuid();
    }

    /**
     * @return void
     */
    protected function dataName(): void
    {
        $this->data['name'] = $this->data['name'] ?: $this->data['start_at'];
    }

    /**
     * @return void
     */
    protected function dataEndAt(): void
    {
        $this->data['end_at'] = $this->data['end_at'] ?: $this->data['start_at'];
    }

    /**
     * @return void
     */
    protected function dataEndUtcAt(): void
    {
        $this->data['end_utc_at'] = $this->data['end_utc_at'] ?: $this->data['start_utc_at'];
    }

    /**
     * @return void
     */
    protected function dataShared(): void
    {
        $this->data['shared'] = $this->device->shared;
    }

    /**
     * @return void
     */
    protected function dataSharedPublic(): void
    {
        $this->data['shared_public'] = $this->device->shared_public;
    }

    /**
     * @return void
     */
    protected function dataDeviceId(): void
    {
        $this->data['device_id'] = $this->device->id;
    }

    /**
     * @return void
     */
    protected function dataUserId(): void
    {
        $this->data['user_id'] = $this->device->user_id;
    }

    /**
     * @return void
     */
    protected function dataVehicleId(): void
    {
        $this->data['vehicle_id'] = $this->device->vehicle_id;
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkTimezoneId();
    }

    /**
     * @return void
     */
    protected function checkTimezoneId(): void
    {
        if ($this->checkTimezoneIdExists() === false) {
            $this->exceptionValidator(__('trip-create.error.timezone_id-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkTimezoneIdExists(): bool
    {
        return TimezoneModel::query()
            ->byId($this->data['timezone_id'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'code' => $this->data['code'],
            'name' => $this->data['name'],
            'start_at' => $this->data['start_at'],
            'start_utc_at' => $this->data['start_utc_at'],
            'end_at' => $this->data['end_at'],
            'end_utc_at' => $this->data['end_utc_at'],
            'shared' => $this->data['shared'],
            'shared_public' => $this->data['shared_public'],
            'device_id' => $this->data['device_id'],
            'timezone_id' => $this->data['timezone_id'],
            'user_id' => $this->data['user_id'],
            'vehicle_id' => $this->data['vehicle_id'],
        ]);
    }
}

```

`app/Domains/Trip/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->delete();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }
}

```

`app/Domains/Trip/Action/Import.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use Throwable;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\Trip\Model\Trip as Model;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;
use App\Services\Gpx\Read as GpxService;

class Import extends ActionAbstract
{
    /**
     * @var array
     */
    protected array $points = [];

    /**
     * @var \App\Domains\Timezone\Model\Timezone
     */
    protected TimezoneModel $timezone;

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function handle(): Model
    {
        $this->timezone();
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function timezone(): void
    {
        if ($this->data['timezone_id']) {
            $this->timezoneById();
        } else {
            $this->timezoneByVehicle();
        }
    }

    /**
     * @return void
     */
    protected function timezoneById(): void
    {
        $this->timezone = TimezoneModel::query()
            ->select('id', 'zone')
            ->byId($this->data['timezone_id'])
            ->firstOr(fn () => $this->exceptionValidator(__('trip-import.error.timezone_id-exists')));
    }

    /**
     * @return void
     */
    protected function timezoneByVehicle(): void
    {
        $this->timezone = TimezoneModel::query()
            ->select('id', 'zone')
            ->byVehicleId($this->data['vehicle_id'])
            ->firstOr(fn () => $this->exceptionValidator(__('trip-import.error.timezone_id-exists')));
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataUserId();
        $this->dataPoints();
        $this->dataCode();
        $this->dataStartUtcAt();
        $this->dataEndUtcAt();
        $this->dataStartAt();
        $this->dataEndAt();
        $this->dataName();
        $this->dataTimezoneId();
    }

    /**
     * @return void
     */
    protected function dataPoints(): void
    {
        try {
            $this->points = GpxService::new($this->data['file']->getPathName())->toArray();
        } catch (Throwable $e) {
            $this->dataPointsError($e);
        }

        if (empty($this->points)) {
            $this->exceptionValidator(__('trip-import.error.points-empty'));
        }
    }

    /**
     * @param \Throwable $e
     *
     * @return void
     */
    protected function dataPointsError(Throwable $e): void
    {
        report($e);

        $this->exceptionValidator(__('trip-import.error.points-empty'));
    }

    /**
     * @return void
     */
    protected function dataCode(): void
    {
        $this->data['code'] = helper()->uuid();
    }

    /**
     * @return void
     */
    protected function dataStartUtcAt(): void
    {
        $this->data['start_utc_at'] = date('Y-m-d H:i:s', $this->points[array_key_first($this->points)]['timestamp']);
    }

    /**
     * @return void
     */
    protected function dataEndUtcAt(): void
    {
        $this->data['end_utc_at'] = date('Y-m-d H:i:s', $this->points[array_key_last($this->points)]['timestamp']);
    }

    /**
     * @return void
     */
    protected function dataStartAt(): void
    {
        $this->data['start_at'] = helper()->dateUtcToTimezone('Y-m-d H:i:s', $this->data['start_utc_at'], $this->timezone->zone);
    }

    /**
     * @return void
     */
    protected function dataEndAt(): void
    {
        $this->data['end_at'] = helper()->dateUtcToTimezone('Y-m-d H:i:s', $this->data['end_utc_at'], $this->timezone->zone);
    }

    /**
     * @return void
     */
    protected function dataName(): void
    {
        $this->data['name'] = $this->data['start_at'].' - '.$this->data['end_at'];
    }

    /**
     * @return void
     */
    protected function dataTimezoneId(): void
    {
        $this->data['timezone_id'] = $this->timezone->id;
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkDeviceId();
        $this->checkVehicleId();
    }

    /**
     * @return void
     */
    protected function checkDeviceId(): void
    {
        if ($this->checkDeviceIdExists() === false) {
            $this->exceptionValidator(__('trip-import.error.device_id-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkDeviceIdExists(): bool
    {
        return DeviceModel::query()
            ->select('id')
            ->byId($this->data['device_id'])
            ->byUserId($this->data['user_id'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkVehicleId(): void
    {
        if ($this->checkVehicleIdExists() === false) {
            $this->exceptionValidator(__('trip-import.error.vehicle_id-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkVehicleIdExists(): bool
    {
        return VehicleModel::query()
            ->select('id')
            ->byId($this->data['vehicle_id'])
            ->byUserId($this->data['user_id'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveRow();
        $this->savePositions();
        $this->saveDistanceTime();
        $this->saveStats();
    }

    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->row = Model::query()->create([
            'code' => $this->data['code'],
            'name' => $this->data['name'],
            'start_at' => $this->data['start_at'],
            'start_utc_at' => $this->data['start_utc_at'],
            'end_at' => $this->data['end_at'],
            'end_utc_at' => $this->data['end_utc_at'],
            'device_id' => $this->data['device_id'],
            'timezone_id' => $this->data['timezone_id'],
            'user_id' => $this->data['user_id'],
            'vehicle_id' => $this->data['vehicle_id'],
        ])->fresh();
    }

    /**
     * @return void
     */
    protected function savePositions(): void
    {
        foreach (array_chunk($this->points, 1000) as $points) {
            PositionModel::query()->insert(array_map($this->savePositionsData(...), $points));
        }
    }

    /**
     * @param array $point
     *
     * @return array
     */
    protected function savePositionsData(array $point): array
    {
        return [
            'point' => PositionModel::pointFromLatitudeLongitude($point['latitude'], $point['longitude']),
            'speed' => $point['speed'],
            'direction' => $point['direction'],
            'signal' => 1,
            'date_utc_at' => date('Y-m-d H:i:s', $point['timestamp']),
            'date_at' => helper()->dateFormattedToTimezone('@'.$point['timestamp'], $this->timezone->zone),
            'device_id' => $this->data['device_id'],
            'timezone_id' => $this->data['timezone_id'],
            'trip_id' => $this->row->id,
            'user_id' => $this->data['user_id'],
            'vehicle_id' => $this->data['vehicle_id'],
        ];
    }

    /**
     * @return void
     */
    protected function saveDistanceTime(): void
    {
        $this->row->updateDistanceTime();
        $this->row->refresh();
    }

    /**
     * @return void
     */
    protected function saveStats(): void
    {
        $this->factory()->action()->updateStats();
    }
}

```

`app/Domains/Trip/Action/LastOrNew.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Trip\Model\Trip as Model;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class LastOrNew extends ActionAbstract
{
    /**
     * @var \App\Domains\Device\Model\Device
     */
    protected DeviceModel $device;

    /**
     * @var \App\Domains\Vehicle\Model\Vehicle
     */
    protected VehicleModel $vehicle;

    /**
     * @var ?string
     */
    protected ?string $positionDateUtcAt;

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function handle(): Model
    {
        $this->device();
        $this->vehicle();
        $this->row();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function device(): void
    {
        $this->device = DeviceModel::query()
            ->findOrFail($this->data['device_id']);
    }

    /**
     * @return void
     */
    protected function vehicle(): void
    {
        $this->vehicle = $this->device->vehicle;
    }

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = $this->rowByNearEndUtcAtMinutes()
            ?: $this->rowByNearEndUtcAt()
            ?: $this->rowCreate();
    }

    /**
     * @return ?\App\Domains\Trip\Model\Trip
     */
    protected function rowByNearEndUtcAtMinutes(): ?Model
    {
        $waitMinutes = $this->waitMinutes();

        if ($waitMinutes === 0) {
            return null;
        }

        return Model::query()
            ->byDeviceId($this->device->id)
            ->byEndUtcAtNearestMinutes($this->data['date_utc_at'], $waitMinutes)
            ->first();
    }

    /**
     * @return ?\App\Domains\Trip\Model\Trip
     */
    protected function rowByNearEndUtcAt(): ?Model
    {
        $waitMinutes = $this->waitMinutes();

        if ($waitMinutes) {
            return null;
        }

        return Model::query()
            ->byDeviceId($this->device->id)
            ->orderByEndUtcAtNearest($this->data['date_utc_at'])
            ->first();
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    protected function rowCreate(): Model
    {
        return $this->factory()->action($this->rowCreateData())->create();
    }

    /**
     * @return array
     */
    protected function rowCreateData(): array
    {
        return [
            'start_at' => $this->data['date_at'],
            'start_utc_at' => $this->data['date_utc_at'],
            'device_id' => $this->device->id,
            'timezone_id' => $this->data['timezone_id'],
            'vehicle_id' => $this->vehicle->id,
        ];
    }

    /**
     * @return int
     */
    protected function waitMinutes(): int
    {
        return $this->vehicle->config('trip_wait_minutes');
    }
}

```

`app/Domains/Trip/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use App\Domains\Trip\Model\Trip as Model;

class Update extends ActionAbstract
{
    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function handle(): Model
    {
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkCode();
    }

    /**
     * @return void
     */
    protected function checkCode(): void
    {
        if ($this->checkCodeExists()) {
            $this->exceptionValidator(__('trip-update.error.code-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkCodeExists(): bool
    {
        return Model::query()
            ->byIdNot($this->row->id)
            ->byCode($this->data['code'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->name = $this->data['name'];
        $this->row->code = $this->data['code'];
        $this->row->shared = $this->data['shared'];
        $this->row->shared_public = $this->data['shared_public'];
        $this->row->save();
    }
}

```

`app/Domains/Trip/Action/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use App\Domains\CoreApp\Action\UpdateBoolean as UpdateBooleanCoreApp;
use App\Domains\Trip\Model\Trip as Model;

class UpdateBoolean extends UpdateBooleanCoreApp
{
    /**
     * @var \App\Domains\Trip\Model\Trip
     */
    protected Model $row;

    /**
     * @return void
     */
    protected function before(): void
    {
        $this->row->code = $this->row->code ?: helper()->uuid();
    }
}

```

`app/Domains/Trip/Action/UpdateExport.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use Throwable;
use Symfony\Component\HttpFoundation\StreamedResponse;
use App\Services\Gpx\Write as GpxService;

class UpdateExport extends ActionAbstract
{
    /**
     * @return ?\Symfony\Component\HttpFoundation\StreamedResponse
     */
    public function handle(): ?StreamedResponse
    {
        try {
            return $this->response();
        } catch (Throwable $e) {
            return $this->error($e);
        }
    }

    /**
     * @return \Symfony\Component\HttpFoundation\StreamedResponse
     */
    protected function response(): StreamedResponse
    {
        return response()->stream($this->readfile(...), 200, $this->headers());
    }

    /**
     * @return void
     */
    protected function readfile(): void
    {
        echo GpxService::new($this->row)->generate()->toXml();
    }

    /**
     * @return array
     */
    protected function headers(): array
    {
        return [
            'Content-Type' => 'application/gpx+xml',
            'Content-Disposition' => 'attachment; filename="'.$this->row->name.'.gpx"',
        ];
    }

    /**
     * @param \Throwable $e
     *
     * @return void
     */
    protected function error(Throwable $e): void
    {
        report($e);

        $this->exceptionNotFound();
    }
}

```

`app/Domains/Trip/Action/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as Model;

class UpdateMerge extends ActionAbstract
{
    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->save();
        $this->delete();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataIds();
    }

    /**
     * @return void
     */
    protected function dataIds(): void
    {
        $this->data['ids'] = Model::query()
            ->byUserId($this->row->user_id)
            ->byIdNot($this->row->id)
            ->byIds($this->data['ids'])
            ->pluck('id')
            ->all();
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        if (empty($this->data['ids'])) {
            $this->exceptionValidator(__('trip-update-merge.error.ids-empty'));
        }
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->savePosition();
        $this->saveRow();
    }

    /**
     * @return void
     */
    protected function savePosition(): void
    {
        PositionModel::query()
            ->byTripIds($this->data['ids'])
            ->update(['trip_id' => $this->row->id]);
    }

    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->factory()->action()->updateNameDistanceTime();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        Model::query()
            ->byIds($this->data['ids'])
            ->delete();
    }
}

```

`app/Domains/Trip/Action/UpdateNameDistanceTime.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Job\UpdateStats as UpdateStatsJob;
use App\Domains\Trip\Model\Trip as Model;

class UpdateNameDistanceTime extends ActionAbstract
{
    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function handle(): Model
    {
        $this->startAt();
        $this->endAt();
        $this->name();
        $this->save();
        $this->job();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function startAt(): void
    {
        if (empty($position = $this->positionFirst())) {
            return;
        }

        $this->row->start_at = $position->date_at;
        $this->row->start_utc_at = $position->date_utc_at;
    }

    /**
     * @return ?\App\Domains\Position\Model\Position
     */
    protected function positionFirst(): ?PositionModel
    {
        return PositionModel::query()
            ->select('date_at', 'date_utc_at')
            ->byTripId($this->row->id)
            ->orderByDateUtcAtAsc()
            ->first();
    }

    /**
     * @return void
     */
    protected function endAt(): void
    {
        if (empty($position = $this->positionLast())) {
            return;
        }

        $this->row->end_at = $position->date_at;
        $this->row->end_utc_at = $position->date_utc_at;
    }

    /**
     * @return ?\App\Domains\Position\Model\Position
     */
    protected function positionLast(): ?PositionModel
    {
        return PositionModel::query()
            ->select('date_at', 'date_utc_at')
            ->byTripId($this->row->id)
            ->orderByDateUtcAtDesc()
            ->first();
    }

    /**
     * @return void
     */
    protected function name(): void
    {
        if ($this->row->nameIsDefault()) {
            $this->row->name = $this->row->nameFromDates();
        }
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveRow();
        $this->saveDistanceTime();
    }

    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->row->save();
    }

    /**
     * @return void
     */
    protected function saveDistanceTime(): void
    {
        $this->row->updateDistanceTime();
    }

    /**
     * @return void
     */
    protected function job(): void
    {
        UpdateStatsJob::dispatch($this->row->id);
    }
}

```

`app/Domains/Trip/Action/UpdatePositionCreate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as Model;

class UpdatePositionCreate extends ActionAbstract
{
    /**
     * @var \App\Domains\Trip\Model\Trip
     */
    protected Model $new;

    /**
     * @var \App\Domains\Position\Model\Collection\Position
     */
    protected PositionCollection $positions;

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function handle(): Model
    {
        $this->positions();
        $this->check();
        $this->create();
        $this->save();

        return $this->new;
    }

    /**
     * @return void
     */
    protected function positions(): void
    {
        $this->positions = $this->row->positions()
            ->byIds($this->data['position_ids'])
            ->list()
            ->get();
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        if ($this->positions->isEmpty()) {
            $this->exceptionValidator(__('trip-update-position-create.error.position_ids-empty'));
        }
    }

    /**
     * @return void
     */
    protected function create(): void
    {
        $this->new = $this->factory()->action($this->createData())->create();
    }

    /**
     * @return array
     */
    protected function createData(): array
    {
        return [
            'name' => $this->createDataName(),
            'start_at' => $this->createDataStartAt(),
            'start_utc_at' => $this->createDataStartUtcAt(),
            'end_at' => $this->createDataEndAt(),
            'end_utc_at' => $this->createDataEndUtcAt(),
            'device_id' => $this->row->device_id,
            'timezone_id' => $this->row->timezone_id,
            'user_id' => $this->row->user_id,
            'vehicle_id' => $this->row->vehicle_id,
        ];
    }

    /**
     * @return string
     */
    protected function createDataName(): string
    {
        return implode(' - ', array_unique([$this->positions->first()->date_at, $this->positions->last()->date_at]));
    }

    /**
     * @return string
     */
    protected function createDataStartAt(): string
    {
        return $this->positions->first()->date_at;
    }

    /**
     * @return string
     */
    protected function createDataStartUtcAt(): string
    {
        return $this->positions->first()->date_utc_at;
    }

    /**
     * @return string
     */
    protected function createDataEndAt(): string
    {
        return $this->positions->last()->date_at;
    }

    /**
     * @return string
     */
    protected function createDataEndUtcAt(): string
    {
        return $this->positions->last()->date_utc_at;
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveNew();
        $this->saveRow();
    }

    /**
     * @return void
     */
    protected function saveNew(): void
    {
        $this->saveNewPositions();
        $this->saveNewNameDistanceTime();
    }

    /**
     * @return void
     */
    protected function saveNewPositions(): void
    {
        PositionModel::query()
            ->byIds($this->positions->pluck('id')->all())
            ->update(['trip_id' => $this->new->id]);
    }

    /**
     * @return void
     */
    protected function saveNewNameDistanceTime(): void
    {
        $this->factory('Trip', $this->new)->action()->updateNameDistanceTime();
    }

    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->factory()->action()->updateNameDistanceTime();
    }
}

```

`app/Domains/Trip/Action/UpdatePositionDelete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use App\Domains\Trip\Model\Trip as Model;

class UpdatePositionDelete extends ActionAbstract
{
    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function handle(): Model
    {
        $this->delete();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->positions()->byIds($this->data['position_ids'])->delete();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->factory()->action()->updateNameDistanceTime();
    }
}

```

`app/Domains/Trip/Action/UpdateStats.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as Model;

class UpdateStats extends ActionAbstract
{
    /**
     * @var array
     */
    protected array $stats;

    /**
     * @var \App\Domains\Position\Model\Collection\Position
     */
    protected PositionCollection $positions;

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    public function handle(): Model
    {
        $this->stats();
        $this->positions();
        $this->iterate();
        $this->finish();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function stats(): void
    {
        $this->stats = [
            'speed' => [
                'max' => 0,
                'min' => 0,
                'avg' => 0,
                'avg_movement' => 0,

                'max_percent' => 0,
                'min_percent' => 0,
                'avg_percent' => 0,
                'avg_movement_percent' => 0,
            ],

            'time' => [
                'total' => 0,
                'movement' => 0,
                'stopped' => 0,

                'total_percent' => 0,
                'movement_percent' => 0,
                'stopped_percent' => 0,
            ],
        ];
    }

    /**
     * @return void
     */
    protected function positions(): void
    {
        $this->positions = PositionModel::query()
            ->select('speed', 'date_at')
            ->byTripId($this->row->id)
            ->orderByDateUtcAtAsc()
            ->get();
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->positions as $i => $position) {
            $this->position($position, $this->positions->get($i - 1));
        }
    }

    /**
     * @param \App\Domains\Position\Model\Position $position
     * @param ?\App\Domains\Position\Model\Position $previous
     *
     * @return void
     */
    protected function position(PositionModel $position, ?PositionModel $previous): void
    {
        if ($previous) {
            $seconds = strtotime($position->date_at) - strtotime($previous->date_at);
        } else {
            $seconds = 0;
        }

        if (($previous ?: $position)->speed) {
            $this->stats['time']['movement'] += $seconds;
        } else {
            $this->stats['time']['stopped'] += $seconds;
        }
    }

    /**
     * @return void
     */
    protected function finish(): void
    {
        $this->finishTime();
        $this->finishSpeed();
    }

    /**
     * @return void
     */
    protected function finishSpeed(): void
    {
        $max = round($this->positions->max('speed') ?: 0, 2);

        if ($max === 0.0) {
            return;
        }

        $min = round($this->positions->min('speed') ?: 0, 2);

        if ($this->row->time) {
            $avg = round($this->row->distance / $this->row->time * 3.6, 2);
        } else {
            $avg = 0;
        }

        $max_percent = 100;
        $min_percent = (int)round($min * 100 / $max, 0);
        $avg_percent = (int)round($avg * 100 / $max, 0);

        $avg_movement = round($this->positions->filter(fn ($position) => $position->speed)->avg('speed'), 2);
        $avg_movement_percent = (int)round($avg_movement * 100 / $max, 0);

        $this->stats['speed'] = get_defined_vars();
    }

    /**
     * @return void
     */
    protected function finishTime(): void
    {
        $movement = $this->stats['time']['movement'];
        $stopped = $this->stats['time']['stopped'];
        $total = $movement + $stopped;

        if ($total === 0) {
            return;
        }

        $total_percent = 100;
        $movement_percent = (int)round($movement * 100 / $total, 0);
        $stopped_percent = (int)round($stopped * 100 / $total, 0);

        $this->stats['time'] = get_defined_vars();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->stats = $this->stats;
        $this->row->save();
    }
}

```

`app/Domains/Trip/Action/UpdateStatsAll.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Action;

use App\Domains\Trip\Model\Collection\Trip as Collection;
use App\Domains\Trip\Model\Trip as Model;

class UpdateStatsAll extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->iterate();
    }

    /**
     * @return void
     */
    protected function iterate(): void
    {
        foreach ($this->list() as $row) {
            $this->factory(row: $row)->action()->updateStats();
        }
    }

    /**
     * @return \App\Domains\Trip\Model\Collection\Trip
     */
    protected function list(): Collection
    {
        $q = Model::query();

        if ($this->data['force'] === false) {
            $q->whenStatsEmpty();
        }

        return $q->get();
    }
}

```

`app/Domains/Trip/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Command;

use App\Domains\CoreApp\Command\CommandAbstract as CommandAbstractSahred;
use App\Domains\Trip\Model\Trip as Model;

abstract class CommandAbstract extends CommandAbstractSahred
{
    /**
     * @var \App\Domains\Trip\Model\Trip
     */
    protected Model $row;

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = Model::query()->findOrFail($this->checkOption('id'));
    }
}

```

`app/Domains/Trip/Command/Import.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Command;

class Import extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'trip:import {--user_id=} {--device_id=} {--vehicle_id=} {--timezone_id=} {--file=}';

    /**
     * @var string
     */
    protected $description = 'Import CSV Trip File using {--user_id=} {--device_id=} {--vehicle_id=} {--timezone_id=} {--file=}';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->checkOptions(['user_id', 'device_id', 'vehicle_id', 'file']);

        $this->requestWithOptions();
        $this->requestOptionAsFile('file');

        $this->actingAs(intval($this->option('user_id')));

        $this->info($this->factory()->action()->import()->toArray());

        $this->info('[END]');
    }
}

```

`app/Domains/Trip/Command/UpdateStats.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Command;

class UpdateStats extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'trip:update:stats {--id=}';

    /**
     * @var string
     */
    protected $description = 'Update Trip Stats by {--id=}';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->checkOptions(['id']);
        $this->requestWithOptions();

        $this->row();

        $this->update();
        $this->output();

        $this->info('[END]');
    }

    /**
     * @return void
     */
    protected function update(): void
    {
        $this->factory()->action()->updateStats();
    }

    /**
     * @return void
     */
    protected function output(): void
    {
        $this->info(helper()->jsonEncode($this->row->stats));
    }
}

```

`app/Domains/Trip/Command/UpdateStatsAll.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Command;

class UpdateStatsAll extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'trip:update:stats:all {--force}';

    /**
     * @var string
     */
    protected $description = 'Update All Trip Stats with {--force}';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->requestWithOptions();
        $this->factory()->action()->updateStatsAll();

        $this->info('[END]');
    }
}

```

`app/Domains/Trip/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\Trip\Model\Trip as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\Trip\Model\Trip
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Trip\Model\Trip
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('trip.error.not-found')));
    }
}

```

`app/Domains/Trip/Controller/Heatmap.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Response;
use App\Domains\Trip\Controller\Service\Heatmap as ControllerService;

class Heatmap extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse
     */
    public function __invoke(): Response|JsonResponse
    {
        if ($this->request->wantsJson()) {
            return $this->responseJson();
        }

        $this->meta('title', __('trip-heatmap.meta-title'));

        return $this->page('trip.heatmap', $this->data());
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->responseJsonData());
    }

    /**
     * @return array
     */
    protected function responseJsonData(): array
    {
        return ControllerService::new($this->request, $this->auth)->json();
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Trip/Controller/Import.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Trip\Controller\Service\Import as ControllerService;

class Import extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($response = $this->actionPost('import')) {
            return $response;
        }

        $this->meta('title', __('trip-import.meta-title'));

        return $this->page('trip.import', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function import(): RedirectResponse
    {
        $this->row = $this->action()->import();

        $this->sessionMessage('success', __('trip-import.success'));

        return redirect()->route('trip.update', $this->row->id);
    }
}

```

`app/Domains/Trip/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\Response;
use App\Domains\Trip\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('trip-index.meta-title'));

        return $this->page('trip.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Trip/Controller/Map.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Response;
use App\Domains\Trip\Controller\Service\Map as ControllerService;

class Map extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse
     */
    public function __invoke(): Response|JsonResponse
    {
        if ($this->request->wantsJson()) {
            return $this->responseJson();
        }

        $this->meta('title', __('trip-map.meta-title'));

        return $this->page('trip.map', $this->data());
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->responseJsonData());
    }

    /**
     * @return array
     */
    protected function responseJsonData(): array
    {
        return $this->factory()->fractal('map', ControllerService::new($this->request, $this->auth)->json());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Trip/Controller/Search.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\Response;
use App\Domains\Trip\Controller\Service\Search as ControllerService;

class Search extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('trip-search.meta-title'));

        return $this->page('trip.search', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Trip/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/Trip/Controller/Service/Heatmap.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use App\Domains\City\Model\City as CityModel;
use App\Domains\City\Model\Collection\City as CityCollection;
use App\Domains\Country\Model\Collection\Country as CountryCollection;
use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\State\Model\Collection\State as StateCollection;
use App\Domains\State\Model\State as StateModel;
use App\Domains\Trip\Model\Builder\Trip as Builder;
use App\Domains\Trip\Model\Trip as Model;

class Heatmap extends Index
{
    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'users' => $this->users(),
            'users_multiple' => $this->usersMultiple(),
            'user' => $this->user(),
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'devices' => $this->devices(),
            'devices_multiple' => $this->devicesMultiple(),
            'device' => $this->device(),
            'countries' => $this->countries(),
            'country' => $this->country(),
            'states' => $this->states(),
            'state' => $this->state(),
            'cities' => $this->cities(),
            'city' => $this->city(),
            'date_min' => $this->dateMin(),
            'starts_ends' => $this->startsEnds(),
            'bbox' => $this->bbox(),
            'grid' => $this->grid(),
        ];
    }

    /**
     * @return array
     */
    public function json(): array
    {
        return $this->grid();
    }

    /**
     * @return \App\Domains\Country\Model\Collection\Country
     */
    protected function countries(): CountryCollection
    {
        return $this->cache(function () {
            return CountryModel::query()
                ->whenTripUserIdVehicleIdStartAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\Country\Model\Country
     */
    protected function country(): ?CountryModel
    {
        return $this->cache(
            fn () => $this->countries()->firstWhere('id', $this->request->input('country_id'))
        );
    }

    /**
     * @return \App\Domains\State\Model\Collection\State
     */
    protected function states(): StateCollection
    {
        return $this->cache(function () {
            if (empty($country_id = intval($this->country()?->id))) {
                return new StateCollection();
            }

            return StateModel::query()
                ->byCountryId($country_id)
                ->whenTripUserIdVehicleIdStartAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\State\Model\State
     */
    protected function state(): ?StateModel
    {
        return $this->cache(
            fn () => $this->states()->firstWhere('id', $this->request->input('state_id'))
        );
    }

    /**
     * @return \App\Domains\City\Model\Collection\City
     */
    protected function cities(): CityCollection
    {
        return $this->cache(function () {
            if (empty($state_id = intval($this->state()?->id))) {
                return new CityCollection();
            }

            return CityModel::query()
                ->byStateId($state_id)
                ->whenTripUserIdVehicleIdStartAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\City\Model\City
     */
    protected function city(): ?CityModel
    {
        return $this->cache(
            fn () => $this->cities()->firstWhere('id', $this->request->input('city_id'))
        );
    }

    /**
     * @return ?array
     */
    protected function bbox(): ?array
    {
        return $this->cache(function () {
            $query = $this->listQuery();

            if (empty($query)) {
                return;
            }

            return PositionModel::tripQueryBoundingBox($query);
        });
    }

    /**
     * @return ?array
     */
    protected function grid(): ?array
    {
        return $this->cache(function () {
            $query = $this->listQuery();

            if (empty($query)) {
                return;
            }

            $grid = PositionModel::heatmap($query, $this->requestArray('bounding_box') ?: $this->bbox());

            return array_map(static fn ($point) => array_map('floatval', (array)$point), $grid);
        });
    }

    /**
     * @return ?\App\Domains\Trip\Model\Builder\Trip
     */
    protected function listQuery(): ?Builder
    {
        if ($this->listIsValid() === false) {
            return null;
        }

        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->whenVehicleId($this->vehicle()?->id)
                ->whenDeviceId($this->device()?->id)
                ->whenStartAtDateBetween($this->request->input('start_at'), $this->request->input('end_at'))
                ->whenCityStateCountry($this->city()?->id, $this->state()?->id, $this->country()?->id, $this->request->input('start_end'))
        );
    }

    /**
     * @return bool
     */
    protected function listIsValid(): bool
    {
        return boolval(array_filter($this->request->except('vehicle_id', 'device_id')));
    }
}

```

`app/Domains/Trip/Controller/Service/Import.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Timezone\Model\Collection\Timezone as TimezoneCollection;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\Trip\Model\Trip as Model;

class Import extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->request();
    }

    /**
     * @return void
     */
    protected function request(): void
    {
        $this->request->merge([
            'user_id' => $this->user()->id,
            'timezone_id' => $this->requestTimezoneId(),
        ]);
    }

    /**
     * @return ?int
     */
    protected function requestTimezoneId(): ?int
    {
        return $this->requestInteger('timezone_id')
            ?: $this->requestTimezoneIdLast();
    }

    /**
     * @return ?int
     */
    protected function requestTimezoneIdLast(): ?int
    {
        return Model::query()
            ->byUserId($this->user()->id)
            ->orderByLast()
            ->value('timezone_id');
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'users' => $this->users(),
            'users_multiple' => $this->usersMultiple(),
            'user' => $this->user(),
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'devices' => $this->devices(),
            'devices_multiple' => $this->devicesMultiple(),
            'device' => $this->device(),
            'timezones' => $this->timezones(),
        ];
    }

    /**
     * @return \App\Domains\Timezone\Model\Collection\Timezone
     */
    protected function timezones(): TimezoneCollection
    {
        return TimezoneModel::query()
            ->list()
            ->get();
    }
}

```

`app/Domains/Trip/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Trip\Model\Collection\Trip as Collection;
use App\Domains\Trip\Model\Trip as Model;

class Index extends ControllerAbstract
{
    /**
     * @const string
     */
    protected const DATE_REGEXP = '/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}$/';

    /**
     * @const string
     */
    protected const START_AT_DEFAULT = '-7 days';

    /**
     * @var bool
     */
    protected bool $userEmpty = true;

    /**
     * @var bool
     */
    protected bool $vehicleEmpty = true;

    /**
     * @var bool
     */
    protected bool $deviceEmpty = true;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->filters();
    }

    /**
     * @return void
     */
    protected function filters(): void
    {
        $this->filtersDates();
        $this->filtersIds();
    }

    /**
     * @return void
     */
    protected function filtersDates(): void
    {
        $this->filtersDatesStartAt();
        $this->filtersDatesEndAt();
    }

    /**
     * @return void
     */
    protected function filtersDatesStartAt(): void
    {
        $start_at = $this->request->input('start_at');

        if ($start_at === '') {
            return;
        }

        if (is_null($start_at) || (preg_match(static::DATE_REGEXP, $start_at) === 0)) {
            $this->request->merge(['start_at' => date('Y-m-d', strtotime(static::START_AT_DEFAULT))]);
        }
    }

    /**
     * @return void
     */
    protected function filtersDatesEndAt(): void
    {
        $end_at = $this->request->input('end_at');

        if (is_null($end_at) || (preg_match(static::DATE_REGEXP, $end_at) === 0)) {
            $this->request->merge(['end_at' => '']);
        }
    }

    /**
     * @return void
     */
    protected function filtersIds(): void
    {
        $this->filtersUserId();
        $this->filtersVehicleId();
        $this->filtersDeviceId();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'users' => $this->users(),
            'users_multiple' => $this->usersMultiple(),
            'user' => $this->user(),
            'user_empty' => $this->userEmpty(),
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'vehicle_empty' => $this->vehicleEmpty(),
            'devices' => $this->devices(),
            'devices_multiple' => $this->devicesMultiple(),
            'device' => $this->device(),
            'device_empty' => $this->deviceEmpty(),
            'date_min' => $this->dateMin(),
            'starts_ends' => $this->startsEnds(),
            'shared' => $this->shared(),
            'shared_public' => $this->sharedPublic(),
            'list' => $this->list(),
        ];
    }

    /**
     * @return ?string
     */
    protected function dateMin(): ?string
    {
        if ($device = $this->device()) {
            $ids = [$device->id];
        } else {
            $ids = $this->devices()->pluck('id')->all();
        }

        return Model::query()
            ->byDeviceIds($ids)
            ->orderByStartAtAsc()
            ->rawValue('DATE(`start_utc_at`)');
    }

    /**
     * @return array
     */
    protected function startsEnds(): array
    {
        return [
            'start' => __('trip-index.start'),
            'end' => __('trip-index.end'),
        ];
    }

    /**
     * @return array
     */
    protected function shared(): array
    {
        return [
            '' => __('trip-index.shared-all'),
            '1' => __('trip-index.shared-yes'),
            '0' => __('trip-index.shared-no'),
        ];
    }

    /**
     * @return array
     */
    protected function sharedPublic(): array
    {
        return [
            '' => __('trip-index.shared_public-all'),
            '1' => __('trip-index.shared_public-yes'),
            '0' => __('trip-index.shared_public-no'),
        ];
    }

    /**
     * @return \App\Domains\Trip\Model\Collection\Trip
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->selectSimple()
                ->whenUserId($this->user()?->id)
                ->whenVehicleId($this->vehicle()?->id)
                ->whenDeviceId($this->device()?->id)
                ->whenStartAtDateBetween($this->request->input('start_at'), $this->request->input('end_at'))
                ->whenShared($this->requestBool('shared', null))
                ->whenSharedPublic($this->requestBool('shared_public', null))
                ->withSimple('device')
                ->withSimple('user')
                ->withSimple('vehicle')
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Trip/Controller/Service/Map.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use App\Domains\City\Model\City as CityModel;
use App\Domains\City\Model\Collection\City as CityCollection;
use App\Domains\Country\Model\Collection\Country as CountryCollection;
use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\State\Model\Collection\State as StateCollection;
use App\Domains\State\Model\State as StateModel;
use App\Domains\Trip\Model\Collection\Trip as Collection;
use App\Domains\Trip\Model\Trip as Model;

class Map extends Index
{
    /**
     * @const string
     */
    protected const START_AT_DEFAULT = '-1 days';

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'users' => $this->users(),
            'users_multiple' => $this->usersMultiple(),
            'user' => $this->user(),
            'user_show' => $this->userShow(),
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'vehicle_show' => $this->vehicleShow(),
            'devices' => $this->devices(),
            'devices_multiple' => $this->devicesMultiple(),
            'device' => $this->device(),
            'device_show' => $this->deviceShow(),
            'countries' => $this->countries(),
            'country' => $this->country(),
            'states' => $this->states(),
            'state' => $this->state(),
            'cities' => $this->cities(),
            'city' => $this->city(),
            'date_min' => $this->dateMin(),
            'starts_ends' => $this->startsEnds(),
            'filter_finished' => $this->filterFinished(),
        ];
    }

    /**
     * @return \App\Domains\Trip\Model\Collection\Trip
     */
    public function json(): Collection
    {
        return $this->list();
    }

    /**
     * @return bool
     */
    public function userShow(): bool
    {
        return empty($this->user()) && (count($this->users()) > 1);
    }

    /**
     * @return bool
     */
    public function vehicleShow(): bool
    {
        return empty($this->vehicle()) && (count($this->vehicles()) > 1);
    }

    /**
     * @return bool
     */
    public function deviceShow(): bool
    {
        return empty($this->device()) && (count($this->devices()) > 1);
    }

    /**
     * @return \App\Domains\Country\Model\Collection\Country
     */
    protected function countries(): CountryCollection
    {
        return $this->cache(function () {
            return CountryModel::query()
                ->whenTripUserIdVehicleIdStartAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\Country\Model\Country
     */
    protected function country(): ?CountryModel
    {
        return $this->cache(
            fn () => $this->countries()->firstWhere('id', $this->request->input('country_id'))
        );
    }

    /**
     * @return \App\Domains\State\Model\Collection\State
     */
    protected function states(): StateCollection
    {
        return $this->cache(function () {
            if (empty($country_id = intval($this->country()?->id))) {
                return new StateCollection();
            }

            return StateModel::query()
                ->byCountryId($country_id)
                ->whenTripUserIdVehicleIdStartAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\State\Model\State
     */
    protected function state(): ?StateModel
    {
        return $this->cache(
            fn () => $this->states()->firstWhere('id', $this->request->input('state_id'))
        );
    }

    /**
     * @return \App\Domains\City\Model\Collection\City
     */
    protected function cities(): CityCollection
    {
        return $this->cache(function () {
            if (empty($state_id = intval($this->state()?->id))) {
                return new CityCollection();
            }

            return CityModel::query()
                ->byStateId($state_id)
                ->whenTripUserIdVehicleIdStartAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\City\Model\City
     */
    protected function city(): ?CityModel
    {
        return $this->cache(
            fn () => $this->cities()->firstWhere('id', $this->request->input('city_id'))
        );
    }

    /**
     * @return \App\Domains\Trip\Model\Collection\Trip
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->whenVehicleId($this->vehicle()?->id)
                ->whenDeviceId($this->device()?->id)
                ->whenStartAtDateBetween($this->request->input('start_at'), $this->request->input('end_at'))
                ->whenCityStateCountry($this->city()?->id, $this->state()?->id, $this->country()?->id, $this->request->input('start_end'))
                ->whenPositionIdFrom($this->requestInteger('position_id_from'))
                ->whenFinished($this->requestBool('finished', null))
                ->withSimpleWhen('device', $this->device() === null)
                ->withSimpleWhen('user', $this->user() === null)
                ->withSimpleWhen('vehicle', $this->vehicle() === null)
                ->withSimple('positions')
                ->listSimple()
                ->get()
        );
    }

    /**
     * @return array
     */
    protected function filterFinished(): array
    {
        return [
            '' => __('trip-map.filter-finished-all'),
            '0' => __('trip-map.filter-finished-no'),
            '1' => __('trip-map.filter-finished-yes'),
        ];
    }
}

```

`app/Domains/Trip/Controller/Service/Search.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use App\Domains\City\Model\City as CityModel;
use App\Domains\City\Model\Collection\City as CityCollection;
use App\Domains\Country\Model\Collection\Country as CountryCollection;
use App\Domains\Country\Model\Country as CountryModel;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\State\Model\Collection\State as StateCollection;
use App\Domains\State\Model\State as StateModel;
use App\Domains\Trip\Model\Collection\Trip as Collection;
use App\Domains\Trip\Model\Trip as Model;

class Search extends Index
{
    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'users' => $this->users(),
            'users_multiple' => $this->usersMultiple(),
            'user' => $this->user(),
            'vehicles' => $this->vehicles(),
            'vehicles_multiple' => $this->vehiclesMultiple(),
            'vehicle' => $this->vehicle(),
            'devices' => $this->devices(),
            'devices_multiple' => $this->devicesMultiple(),
            'device' => $this->device(),
            'countries' => $this->countries(),
            'country' => $this->country(),
            'states' => $this->states(),
            'state' => $this->state(),
            'cities' => $this->cities(),
            'city' => $this->city(),
            'date_min' => $this->dateMin(),
            'starts_ends' => $this->startsEnds(),
            'shared' => $this->shared(),
            'shared_public' => $this->sharedPublic(),
            'position' => $this->position(),
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\Country\Model\Collection\Country
     */
    protected function countries(): CountryCollection
    {
        return $this->cache(function () {
            return CountryModel::query()
                ->whenTripUserIdVehicleIdStartAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\Country\Model\Country
     */
    protected function country(): ?CountryModel
    {
        return $this->cache(
            fn () => $this->countries()->firstWhere('id', $this->request->input('country_id'))
        );
    }

    /**
     * @return \App\Domains\State\Model\Collection\State
     */
    protected function states(): StateCollection
    {
        return $this->cache(function () {
            if (empty($country_id = intval($this->country()?->id))) {
                return new StateCollection();
            }

            return StateModel::query()
                ->byCountryId($country_id)
                ->whenTripUserIdVehicleIdStartAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\State\Model\State
     */
    protected function state(): ?StateModel
    {
        return $this->cache(
            fn () => $this->states()->firstWhere('id', $this->request->input('state_id'))
        );
    }

    /**
     * @return \App\Domains\City\Model\Collection\City
     */
    protected function cities(): CityCollection
    {
        return $this->cache(function () {
            if (empty($state_id = intval($this->state()?->id))) {
                return new CityCollection();
            }

            return CityModel::query()
                ->byStateId($state_id)
                ->whenTripUserIdVehicleIdStartAtBetween($this->user()?->id, $this->vehicle()?->id, $this->request->input('start_at'), $this->request->input('end_at'))
                ->list()
                ->get();
        });
    }

    /**
     * @return ?\App\Domains\City\Model\City
     */
    protected function city(): ?CityModel
    {
        return $this->cache(
            fn () => $this->cities()->firstWhere('id', $this->request->input('city_id'))
        );
    }

    /**
     * @return ?\App\Domains\Position\Model\Position
     */
    protected function position(): ?PositionModel
    {
        return $this->cache(
            fn () => PositionModel::query()
                ->whenUserId($this->user()?->id)
                ->orderByDateUtcAtDesc()
                ->first()
        );
    }

    /**
     * @return \App\Domains\Trip\Model\Collection\Trip
     */
    protected function list(): Collection
    {
        if ($this->listIsValid() === false) {
            return new Collection();
        }

        return $this->cache(
            fn () => Model::query()
                ->selectSimple()
                ->whenUserId($this->user()?->id)
                ->whenVehicleId($this->vehicle()?->id)
                ->whenDeviceId($this->device()?->id)
                ->whenStartAtDateBetween($this->request->input('start_at'), $this->request->input('end_at'))
                ->whenCityStateCountry($this->city()?->id, $this->state()?->id, $this->country()?->id, $this->request->input('start_end'))
                ->whenShared($this->requestBool('shared', null))
                ->whenSharedPublic($this->requestBool('shared_public', null))
                ->whenFence($this->request->float('fence_latitude'), $this->request->float('fence_longitude'), $this->request->float('fence_radius'))
                ->withDevice()
                ->withUser()
                ->withVehicle()
                ->list()
                ->get()
        );
    }

    /**
     * @return bool
     */
    protected function listIsValid(): bool
    {
        return boolval(array_filter($this->request->except('vehicle_id', 'device_id')));
    }
}

```

`app/Domains/Trip/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Trip\Model\Trip as Model;

class Update extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
    }

    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCore() + [
            'row' => $this->row,
        ];
    }
}

```

`app/Domains/Trip/Controller/Service/UpdateAlarmNotification.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\AlarmNotification\Model\AlarmNotification as AlarmNotificationModel;
use App\Domains\AlarmNotification\Model\Collection\AlarmNotification as AlarmNotificationCollection;
use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as Model;

class UpdateAlarmNotification extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'positions' => $this->positions(),
            'notifications' => $this->notifications(),
        ];
    }

    /**
     * @return \App\Domains\Position\Model\Collection\Position
     */
    protected function positions(): PositionCollection
    {
        return $this->cache(
            fn () => PositionModel::query()
                ->byTripId($this->row->id)
                ->withCityState()
                ->list()
                ->get()
        );
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\Collection\AlarmNotification
     */
    protected function notifications(): AlarmNotificationCollection
    {
        return $this->cache(
            fn () => AlarmNotificationModel::query()
                ->byTripId($this->row->id)
                ->withAlarm()
                ->withVehicle()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Trip/Controller/Service/UpdateMap.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Alarm\Model\Alarm as AlarmModel;
use App\Domains\Alarm\Model\Collection\Alarm as AlarmCollection;
use App\Domains\AlarmNotification\Model\AlarmNotification as AlarmNotificationModel;
use App\Domains\AlarmNotification\Model\Collection\AlarmNotification as AlarmNotificationCollection;
use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as Model;

class UpdateMap extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'alarms' => $this->alarms(),
            'positions' => $this->positions(),
            'notifications' => $this->notifications(),
        ];
    }

    /**
     * @return \App\Domains\Position\Model\Collection\Position
     */
    protected function positions(): PositionCollection
    {
        return $this->cache(
            fn () => PositionModel::query()
                ->byTripId($this->row->id)
                ->withCityState()
                ->list()
                ->get()
        );
    }

    /**
     * @return \App\Domains\Alarm\Model\Collection\Alarm
     */
    protected function alarms(): AlarmCollection
    {
        return $this->cache(
            fn () => AlarmModel::query()
                ->byVehicleId($this->row->vehicle->id)
                ->enabled()
                ->list()
                ->get()
        );
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\Collection\AlarmNotification
     */
    protected function notifications(): AlarmNotificationCollection
    {
        return $this->cache(
            fn () => AlarmNotificationModel::query()
                ->byTripId($this->row->id)
                ->withAlarm()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Trip/Controller/Service/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Trip\Model\Collection\Trip as Collection;
use App\Domains\Trip\Model\Trip as Model;

class UpdateMerge extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\Trip\Model\Collection\Trip
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->selectSimple()
                ->byUserId($this->row->user_id)
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Trip/Controller/Service/UpdatePosition.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Alarm\Model\Alarm as AlarmModel;
use App\Domains\Alarm\Model\Collection\Alarm as AlarmCollection;
use App\Domains\AlarmNotification\Model\AlarmNotification as AlarmNotificationModel;
use App\Domains\AlarmNotification\Model\Collection\AlarmNotification as AlarmNotificationCollection;
use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as Model;

class UpdatePosition extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'alarms' => $this->alarms(),
            'positions' => $this->positions(),
            'notifications' => $this->notifications(),
        ];
    }

    /**
     * @return \App\Domains\Position\Model\Collection\Position
     */
    protected function positions(): PositionCollection
    {
        return $this->cache(
            fn () => PositionModel::query()
                ->byTripId($this->row->id)
                ->withCityState()
                ->list()
                ->get()
        );
    }

    /**
     * @return \App\Domains\Alarm\Model\Collection\Alarm
     */
    protected function alarms(): AlarmCollection
    {
        return $this->cache(
            fn () => AlarmModel::query()
                ->byVehicleId($this->row->vehicle->id)
                ->enabled()
                ->list()
                ->get()
        );
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\Collection\AlarmNotification
     */
    protected function notifications(): AlarmNotificationCollection
    {
        return $this->cache(
            fn () => AlarmNotificationModel::query()
                ->byTripId($this->row->id)
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Trip/Controller/Service/UpdateStat.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Trip\Model\Trip as Model;

class UpdateStat extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'stats' => $this->stats(),
        ];
    }

    /**
     * @return ?array
     */
    protected function stats(): ?array
    {
        return $this->row->stats;
    }
}

```

`app/Domains/Trip/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Trip\Controller\Service\Update as ControllerService;

class Update extends UpdateAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->load($id);

        if ($response = $this->actions()) {
            return $response;
        }

        $this->meta('title', __('trip-update.meta-title', ['title' => $this->row->name]));

        return $this->page('trip.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('update')
            ?: $this->actionPost('delete');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('trip-update.success'));

        return redirect()->route('trip.update', $this->row->id);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function delete(): RedirectResponse
    {
        $this->action()->delete();

        $this->sessionMessage('success', __('trip-update.delete-success'));

        return redirect()->route('trip.index');
    }
}

```

`app/Domains/Trip/Controller/UpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

abstract class UpdateAbstract extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return void
     */
    protected function load(int $id): void
    {
        $this->row($id);
        $this->loadView();
    }

    /**
     * @return void
     */
    protected function loadView(): void
    {
        view()->share([
            'row' => $this->row,
            'previous' => $this->row->previous(),
            'next' => $this->row->next(),
        ]);
    }
}

```

`app/Domains/Trip/Controller/UpdateAlarmNotification.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\Response;
use App\Domains\Trip\Controller\Service\UpdateAlarmNotification as ControllerService;

class UpdateAlarmNotification extends UpdateAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response
     */
    public function __invoke(int $id): Response
    {
        $this->load($id);

        $this->meta('title', __('trip-update-alarm-notification.meta-title', ['title' => $this->row->name]));

        return $this->page('trip.update-alarm-notification', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }
}

```

`app/Domains/Trip/Controller/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\JsonResponse;
use App\Domains\Trip\Model\Trip as Model;

class UpdateBoolean extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(int $id): JsonResponse
    {
        $this->row($id);

        return $this->json($this->fractal($this->action()->updateBoolean()));
    }

    /**
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return array
     */
    protected function fractal(Model $row): array
    {
        return $this->factory()->fractal('simple', $row);
    }
}

```

`app/Domains/Trip/Controller/UpdateExport.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Symfony\Component\HttpFoundation\StreamedResponse;

class UpdateExport extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Symfony\Component\HttpFoundation\StreamedResponse
     */
    public function __invoke(int $id): StreamedResponse
    {
        $this->row($id);

        return $this->action()->updateExport();
    }
}

```

`app/Domains/Trip/Controller/UpdateMap.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Trip\Controller\Service\UpdateMap as ControllerService;

class UpdateMap extends UpdateAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->load($id);

        $this->meta('title', __('trip-update-map.meta-title', ['title' => $this->row->name]));

        return $this->page('trip.update-map', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }
}

```

`app/Domains/Trip/Controller/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Trip\Controller\Service\UpdateMerge as ControllerService;

class UpdateMerge extends UpdateAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->load($id);

        if ($response = $this->actionPost('updateMerge')) {
            return $response;
        }

        $this->meta('title', __('trip-update-merge.meta-title', ['title' => $this->row->name]));

        return $this->page('trip.update-merge', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateMerge(): RedirectResponse
    {
        $this->action()->updateMerge();

        $this->sessionMessage('success', __('trip-update-merge.success'));

        return redirect()->route('trip.update.map', $this->row->id);
    }
}

```

`app/Domains/Trip/Controller/UpdatePosition.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as Model;
use App\Domains\Trip\Controller\Service\UpdatePosition as ControllerService;

class UpdatePosition extends UpdateAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|JsonResponse|RedirectResponse
    {
        $this->load($id);

        if ($this->request->wantsJson()) {
            return $this->responseJson();
        }

        if ($response = $this->actions()) {
            return $response;
        }

        $this->meta('title', __('trip-update-position.meta-title', ['title' => $this->row->name]));

        return $this->page('trip.update-position', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->factory()->fractal('live', $this->responseJsonList()));
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    protected function responseJsonList(): Model
    {
        return $this->row->setRelation('positions', $this->responseJsonListPositions());
    }

    /**
     * @return \App\Domains\Position\Model\Collection\Position
     */
    protected function responseJsonListPositions(): PositionCollection
    {
        return PositionModel::query()
            ->byTripId($this->row->id)
            ->byIdNext((int)$this->request->input('id_from'))
            ->withCityState()
            ->list()
            ->get();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('updatePositionCreate')
            ?: $this->actionPost('updatePositionDelete');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updatePositionCreate(): RedirectResponse
    {
        $this->row = $this->action()->updatePositionCreate();

        $this->sessionMessage('success', __('trip-update-position.create-success'));

        return redirect()->route('trip.update.position', $this->row->id);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updatePositionDelete(): RedirectResponse
    {
        $this->action()->updatePositionDelete();

        $this->sessionMessage('success', __('trip-update-position.delete-success'));

        return redirect()->route('trip.update.position', $this->row->id);
    }
}

```

`app/Domains/Trip/Controller/UpdateStat.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Trip\Controller\Service\UpdateStat as ControllerService;

class UpdateStat extends UpdateAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->load($id);

        if (empty($this->row->stats)) {
            $this->actionCall('updateStats');
        }

        $this->meta('title', __('trip-update-stat.meta-title', ['title' => $this->row->name]));

        return $this->page('trip.update-stat', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return void
     */
    protected function updateStats(): void
    {
        $this->factory()->action()->updateStats();
    }
}

```

`app/Domains/Trip/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth', 'vehicle.available']], static function () {
    Route::get('/trip', Index::class)->name('trip.index');
    Route::any('/trip/import', Import::class)->name('trip.import');
    Route::any('/trip/heatmap', Heatmap::class)->name('trip.heatmap');
    Route::any('/trip/map', Map::class)->name('trip.map');
    Route::any('/trip/search', Search::class)->name('trip.search');
    Route::any('/trip/{id}', Update::class)->name('trip.update');
    Route::any('/trip/{id}/alarm-notification', UpdateAlarmNotification::class)->name('trip.update.alarm-notification');
    Route::any('/trip/{id}/boolean/{column}', UpdateBoolean::class)->name('trip.update.boolean');
    Route::any('/trip/{id}/export', UpdateExport::class)->name('trip.update.export');
    Route::any('/trip/{id}/map', UpdateMap::class)->name('trip.update.map');
    Route::any('/trip/{id}/merge', UpdateMerge::class)->name('trip.update.merge');
    Route::any('/trip/{id}/position', UpdatePosition::class)->name('trip.update.position');
    Route::any('/trip/{id}/stat', UpdateStat::class)->name('trip.update.stat');
});

```

`app/Domains/Trip/ControllerApi/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\ControllerApi;

use App\Domains\CoreApp\Controller\ControllerApiAbstract as CoreControllerApiAbstract;
use App\Domains\Trip\Model\Trip as Model;

abstract class ControllerApiAbstract extends CoreControllerApiAbstract
{
    /**
     * @var ?\App\Domains\Trip\Model\Trip
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Trip\Model\Trip
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('trip.error.not-found')));
    }
}

```

`app/Domains/Trip/ControllerApi/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\ControllerApi;

class Delete extends ControllerApiAbstract
{
    /**
     * @param int $id
     *
     * @return void
     */
    public function __invoke(int $id): void
    {
        $this->row($id);
        $this->action()->delete();
    }
}

```

`app/Domains/Trip/ControllerApi/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Trip\ControllerApi\Service\Index as ControllerService;

class Index extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('json', $this->data()));
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Trip/ControllerApi/Position.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Trip\ControllerApi\Service\Position as ControllerService;

class Position extends ControllerApiAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(int $id): JsonResponse
    {
        $this->row($id);

        return $this->json($this->factory('Position')->fractal('json', $this->data()));
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }
}

```

`app/Domains/Trip/ControllerApi/Service/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\ControllerApi\Service;

use App\Domains\CoreApp\ControllerApi\Service\ControllerApiAbstract as CoreAppControllerApiAbstract;

abstract class ControllerApiAbstract extends CoreAppControllerApiAbstract
{
}

```

`app/Domains/Trip/ControllerApi/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Trip\Model\Trip as Model;

class Index extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return Model::query()
            ->byUserOrManager($this->auth)
            ->whenUserId($this->requestInteger('user_id'))
            ->whenVehicleId($this->requestInteger('vehicle_id'))
            ->whenDeviceId($this->requestInteger('device_id'))
            ->whenStartAtDateBetween($this->request->input('start_at'), $this->request->input('end_at'))
            ->whenShared($this->requestBool('shared', null))
            ->whenSharedPublic($this->requestBool('shared_public', null))
            ->withSimple('device')
            ->withSimple('timezone')
            ->withSimple('user')
            ->withSimple('vehicle')
            ->listSimple()
            ->get()
            ->all();
    }
}

```

`app/Domains/Trip/ControllerApi/Service/Position.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as Model;

class Position extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return PositionModel::query()
            ->byTripId($this->row->id)
            ->withCityCountryState()
            ->list()
            ->get()
            ->all();
    }
}

```

`app/Domains/Trip/ControllerApi/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Trip\Model\Trip as Model;

class Update extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataDefault()
            + $this->dataRow();
    }

    /**
     * @return array
     */
    protected function dataDefault(): array
    {
        return $this->request->input();
    }

    /**
     * @return array
     */
    protected function dataRow(): array
    {
        return $this->row->toArray();
    }
}

```

`app/Domains/Trip/ControllerApi/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Trip\Model\Trip as Model;
use App\Domains\Trip\ControllerApi\Service\Update as ControllerService;

class Update extends ControllerApiAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(int $id): JsonResponse
    {
        $this->row($id);

        return $this->json($this->factory()->fractal('json', $this->execute()));
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    protected function execute(): Model
    {
        return $this->action(data: $this->data())->update();
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }
}

```

`app/Domains/Trip/ControllerApi/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\ControllerApi;

use Illuminate\Support\Facades\Route;

Route::get('/trip', Index::class)->name('trip.index');
Route::get('/trip/{id}/position', Position::class)->name('trip.position');
Route::patch('/trip/{id}', Update::class)->name('trip.update');
Route::delete('/trip/{id}', Delete::class)->name('trip.delete');

```

`app/Domains/Trip/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\Trip\Model\Trip as Model;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return array
     */
    protected function json(Model $row): array
    {
        return [
            'id' => $row->id,
            'code' => $row->code,
            'name' => $row->name,
            'start_at' => $row->start_at,
            'start_utc_at' => $row->start_utc_at,
            'end_at' => $row->end_at,
            'end_utc_at' => $row->end_utc_at,
            'distance' => helper()->unit('distance', $row->distance),
            'time' => $row->time,
            'device' => $this->from('Device', 'related', $row->device),
            'timezone' => $this->from('Timezone', 'related', $row->timezone),
            'user' => $this->from('User', 'related', $row->user),
            'vehicle' => $this->from('Vehicle', 'related', $row->vehicle),
        ];
    }

    /**
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return array
     */
    protected function live(Model $row): array
    {
        return [
            'code' => $row->code,
            'name' => $row->name,
            'start_at' => $row->start_at,
            'start_utc_at' => $row->start_utc_at,
            'end_at' => $row->end_at,
            'end_utc_at' => $row->end_utc_at,
            'distance' => helper()->unit('distance', $row->distance),
            'distance_human' => helper()->unitHuman('distance', $row->distance),
            'time' => $row->time,
            'positions' => $this->from('Position', 'map', $row->positions),
        ];
    }

    /**
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return array
     */
    protected function map(Model $row): array
    {
        return [
            'id' => $row->id,
            'code' => $row->code,
            'name' => $row->name,
            'start_at' => $row->start_at,
            'start_utc_at' => $row->start_utc_at,
            'end_at' => $row->end_at,
            'end_utc_at' => $row->end_utc_at,
            'distance' => helper()->unit('distance', $row->distance),
            'distance_human' => helper()->unitHuman('distance', $row->distance),
            'time' => $row->time,
            'time_human' => helper()->timeHuman($row->time),
            'device' => $this->fromIfLoaded('Device', 'related', $row, 'device'),
            'vehicle' => $this->fromIfLoaded('Vehicle', 'related', $row, 'vehicle'),
            'user' => $this->fromIfLoaded('User', 'related', $row, 'user'),
            'positions' => $this->from('Position', 'related', $row->positions),
        ];
    }

    /**
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return array
     */
    protected function simple(Model $row): array
    {
        return [
            'id' => $row->id,
            'code' => $row->code,
            'name' => $row->name,
            'start_at' => $row->start_at,
            'end_at' => $row->end_at,
            'distance' => helper()->unit('distance', $row->distance),
            'distance_human' => helper()->unitHuman('distance', $row->distance),
            'time' => $row->time,
            'time_human' => helper()->timeHuman($row->time),
            'shared' => $row->shared,
            'shared_public' => $row->shared_public,
        ];
    }

    /**
     * @param \App\Domains\Trip\Model\Trip $row
     *
     * @return array
     */
    protected function related(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
            'start_at' => $row->start_at,
            'end_at' => $row->end_at,
            'distance' => helper()->unit('distance', $row->distance),
            'distance_human' => helper()->unitHuman('distance', $row->distance),
            'time' => $row->time,
            'time_human' => helper()->timeHuman($row->time),
        ];
    }
}

```

`app/Domains/Trip/Job/JobAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Job;

use App\Domains\Core\Job\JobAbstract as JobAbstractCore;
use App\Domains\Trip\Model\Trip as Model;

abstract class JobAbstract extends JobAbstractCore
{
    /**
     * @var \App\Domains\Trip\Model\Trip
     */
    protected Model $row;

    /**
     * @param int $id
     *
     * @return void
     */
    public function __construct(protected int $id)
    {
    }

    /**
     * @return array
     */
    public function middleware(): array
    {
        return [$this->middlewareWithoutOverlapping()->expireAfter(30)];
    }

    /**
     * @return \App\Domains\Trip\Model\Trip
     */
    protected function row(): Model
    {
        return $this->rowOrDeleteAndException(Model::class);
    }
}

```

`app/Domains/Trip/Job/UpdateStats.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Job;

class UpdateStats extends JobAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->factory(row: $this->row())->action()->updateStats();
    }
}

```

`app/Domains/Trip/Model/Builder/Trip.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\Position\Model\Position as PositionModel;

class Trip extends BuilderAbstract
{
    /**
     * @param int $city_id
     * @param ?string $start_end = null
     *
     * @return self
     */
    public function byCityId(int $city_id, ?string $start_end = null): self
    {
        return $this->whereIn('id', PositionModel::query()->select('trip_id')->byCityId($city_id)->whenTripStartEnd($start_end));
    }

    /**
     * @param string $code
     *
     * @return self
     */
    public function byCode(string $code): self
    {
        return $this->where('code', $code);
    }

    /**
     * @param int $country_id
     * @param ?string $start_end = null
     *
     * @return self
     */
    public function byCountryId(int $country_id, ?string $start_end = null): self
    {
        return $this->whereIn('id', PositionModel::query()->select('trip_id')->byCountryId($country_id)->whenTripStartEnd($start_end));
    }

    /**
     * @param int $device_id
     *
     * @return self
     */
    public function byDeviceId(int $device_id): self
    {
        return $this->where('device_id', $device_id);
    }

    /**
     * @param string $end_utc_at
     * @param int $minutes
     *
     * @return self
     */
    public function byEndUtcAtNearestMinutes(string $end_utc_at, int $minutes): self
    {
        return $this->whereRaw('ABS(TIMESTAMPDIFF(MINUTE, `end_utc_at`, ?)) < ?', [$end_utc_at, $minutes])
            ->orderByEndUtcAtNearest($end_utc_at);
    }

    /**
     * @param float $latitude
     * @param float $longitude
     * @param float $radius
     *
     * @return self
     */
    public function byFence(float $latitude, float $longitude, float $radius): self
    {
        return $this->whereIn('id', PositionModel::query()->select('trip_id')->byFence($latitude, $longitude, $radius));
    }

    /**
     * @param string $start_at
     *
     * @return self
     */
    public function byStartAtAfterEqualNear(string $start_at): self
    {
        return $this->where('start_at', '>=', $start_at)->orderByStartAtAsc();
    }

    /**
     * @param string $start_at
     *
     * @return self
     */
    public function byStartAtBeforeEqualNear(string $start_at): self
    {
        return $this->where('start_at', '<=', $start_at)->orderByStartAtDesc();
    }

    /**
     * @param string $start_at
     *
     * @return self
     */
    public function byStartAtDateAfterEqual(string $start_at): self
    {
        return $this->whereDate('start_at', '>=', $start_at);
    }

    /**
     * @param string $start_at
     *
     * @return self
     */
    public function byStartAtDateBeforeEqual(string $start_at): self
    {
        return $this->whereDate('start_at', '<=', $start_at);
    }

    /**
     * @param string $start_at
     *
     * @return self
     */
    public function byStartAtAfter(string $start_at): self
    {
        return $this->where('start_at', '>', $start_at)->orderByStartAtAsc();
    }

    /**
     * @param string $start_at
     *
     * @return self
     */
    public function byStartAtBefore(string $start_at): self
    {
        return $this->where('start_at', '<', $start_at)->orderByStartAtDesc();
    }

    /**
     * @param string $start_utc_at
     *
     * @return self
     */
    public function byStartUtcAtAfterEqualNear(string $start_utc_at): self
    {
        return $this->where('start_utc_at', '>=', $start_utc_at)->orderByStartUtcAtAsc();
    }

    /**
     * @param string $start_utc_at
     *
     * @return self
     */
    public function byStartUtcAtBeforeEqualNear(string $start_utc_at): self
    {
        return $this->where('start_utc_at', '<=', $start_utc_at)->orderByStartUtcAtDesc();
    }

    /**
     * @param string $start_utc_at
     *
     * @return self
     */
    public function byStartUtcAtDateAfterEqual(string $start_utc_at): self
    {
        return $this->whereDate('start_utc_at', '>=', $start_utc_at);
    }

    /**
     * @param string $start_utc_at
     *
     * @return self
     */
    public function byStartUtcAtDateBeforeEqual(string $start_utc_at): self
    {
        return $this->whereDate('start_utc_at', '<=', $start_utc_at);
    }

    /**
     * @param string $start_utc_at
     *
     * @return self
     */
    public function byStartUtcAtAfter(string $start_utc_at): self
    {
        return $this->where('start_utc_at', '>', $start_utc_at)->orderByStartUtcAtAsc();
    }

    /**
     * @param string $start_utc_at
     *
     * @return self
     */
    public function byStartUtcAtBefore(string $start_utc_at): self
    {
        return $this->where('start_utc_at', '<', $start_utc_at)->orderByStartUtcAtDesc();
    }

    /**
     * @param int $position_id
     *
     * @return self
     */
    public function byPositionIdFrom(int $position_id): self
    {
        return $this->whereIn('id', PositionModel::query()->select('trip_id')->byIdNext($position_id));
    }

    /**
     * @param int $state_id
     * @param ?string $start_end = null
     *
     * @return self
     */
    public function byStateId(int $state_id, ?string $start_end = null): self
    {
        return $this->whereIn('id', PositionModel::query()->select('trip_id')->byStateId($state_id)->whenTripStartEnd($start_end));
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderByStartAtDesc();
    }

    /**
     * @return self
     */
    public function orderByStartAtAsc(): self
    {
        return $this->orderBy('start_at', 'ASC');
    }

    /**
     * @return self
     */
    public function orderByStartAtDesc(): self
    {
        return $this->orderBy('start_at', 'DESC');
    }

    /**
     * @return self
     */
    public function orderByStartUtcAtAsc(): self
    {
        return $this->orderBy('start_utc_at', 'ASC');
    }

    /**
     * @return self
     */
    public function orderByStartUtcAtDesc(): self
    {
        return $this->orderBy('start_utc_at', 'DESC');
    }

    /**
     * @param string $end_utc_at
     *
     * @return self
     */
    public function orderByEndUtcAtNearest(string $end_utc_at): self
    {
        return $this->orderByRaw('ABS(TIMESTAMPDIFF(MINUTE, `end_utc_at`, ?)) ASC', [$end_utc_at]);
    }

    /**
     * @return self
     */
    public function selectRelated(): self
    {
        return $this->select(
            'id',
            'name',
            'start_at',
            'start_utc_at',
            'end_at',
            'end_utc_at',
            'time',
            'distance',
        );
    }

    /**
     * @return self
     */
    public function selectSimple(): self
    {
        return $this->select(
            'id',
            'name',
            'code',
            'start_at',
            'start_utc_at',
            'end_at',
            'end_utc_at',
            'time',
            'distance',
            'shared',
            'shared_public',
            'device_id',
            'user_id',
            'vehicle_id'
        );
    }

    /**
     * @return self
     */
    public function listSimple(): self
    {
        return $this->selectSimple()->orderByStartAtDesc();
    }

    /**
     * @param ?int $city_id
     * @param ?int $state_id
     * @param ?int $country_id
     * @param ?string $start_end = null
     *
     * @return self
     */
    public function whenCityStateCountry(?int $city_id, ?int $state_id, ?int $country_id, ?string $start_end = null): self
    {
        return match (true) {
            boolval($city_id) => $this->byCityId($city_id, $start_end),
            boolval($state_id) => $this->byStateId($state_id, $start_end),
            boolval($country_id) => $this->byCountryId($country_id, $start_end),
            default => $this,
        };
    }

    /**
     * @param float $latitude
     * @param float $longitude
     * @param float $radius
     *
     * @return self
     */
    public function whenFence(float $latitude, float $longitude, float $radius): self
    {
        return $this->when(
            $latitude && $longitude && $radius,
            fn ($q) => $q->byFence($latitude, $longitude, $radius)
        );
    }

    /**
     * @param ?bool $finished
     *
     * @return self
     */
    public function whenFinished(?bool $finished): self
    {
        return $this->when(is_bool($finished), fn ($q) => $q->whereFinished($finished));
    }

    /**
     * @param ?int $position_id
     *
     * @return self
     */
    public function whenPositionIdFrom(?int $position_id): self
    {
        return $this->when($position_id, fn ($q) => $q->byPositionIdFrom($position_id));
    }

    /**
     * @param ?bool $shared
     *
     * @return self
     */
    public function whenShared(?bool $shared): self
    {
        return $this->when(is_bool($shared), fn ($q) => $q->whereShared($shared));
    }

    /**
     * @param ?bool $shared_public
     *
     * @return self
     */
    public function whenSharedPublic(?bool $shared_public): self
    {
        return $this->when(is_bool($shared_public), fn ($q) => $q->whereSharedPublic($shared_public));
    }

    /**
     * @param ?string $before_start_at
     * @param ?string $after_start_at
     *
     * @return self
     */
    public function whenStartAtDateBetween(?string $before_start_at, ?string $after_start_at): self
    {
        return $this->whenStartAtDateAfter($before_start_at)->whenStartAtDateBefore($after_start_at);
    }

    /**
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     *
     * @return self
     */
    public function whenStartUtcAtDateBetween(?string $before_start_utc_at, ?string $after_start_utc_at): self
    {
        return $this->whenStartUtcAtDateAfter($before_start_utc_at)->whenStartUtcAtDateBefore($after_start_utc_at);
    }

    /**
     * @param ?string $start_at
     *
     * @return self
     */
    public function whenStartAtDateAfter(?string $start_at): self
    {
        return $this->when($start_at, fn ($q) => $q->byStartAtDateAfterEqual($start_at));
    }

    /**
     * @param ?string $start_at
     *
     * @return self
     */
    public function whenStartAtDateBefore(?string $start_at): self
    {
        return $this->when($start_at, fn ($q) => $q->byStartAtDateBeforeEqual($start_at));
    }

    /**
     * @param ?string $start_utc_at
     *
     * @return self
     */
    public function whenStartUtcAtDateAfter(?string $start_utc_at): self
    {
        return $this->when($start_utc_at, fn ($q) => $q->byStartUtcAtDateAfterEqual($start_utc_at));
    }

    /**
     * @param ?string $start_utc_at
     *
     * @return self
     */
    public function whenStartUtcAtDateBefore(?string $start_utc_at): self
    {
        return $this->when($start_utc_at, fn ($q) => $q->byStartUtcAtDateBeforeEqual($start_utc_at));
    }

    /**
     * @return self
     */
    public function whenStatsEmpty(): self
    {
        return $this->whereNull('stats');
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_start_at
     * @param ?string $after_start_at
     *
     * @return self
     */
    public function whenUserIdVehicleIdStartAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_start_at, ?string $after_start_at): self
    {
        return $this->whenUserId($user_id)
            ->whenVehicleId($vehicle_id)
            ->whenStartAtDateBetween($before_start_at, $after_start_at);
    }

    /**
     * @param ?int $user_id
     * @param ?int $vehicle_id
     * @param ?string $before_start_utc_at
     * @param ?string $after_start_utc_at
     *
     * @return self
     */
    public function whenUserIdVehicleIdStartUtcAtBetween(?int $user_id, ?int $vehicle_id, ?string $before_start_utc_at, ?string $after_start_utc_at): self
    {
        return $this->whenUserId($user_id)
            ->whenVehicleId($vehicle_id)
            ->whenStartUtcAtDateBetween($before_start_utc_at, $after_start_utc_at);
    }

    /**
     * @param bool $finished = true
     *
     * @return self
     */
    public function whereFinished(bool $finished = true): self
    {
        $time = strtotime('-'.app('configuration')->int('trip_wait_minutes').' minutes');
        $date = gmdate('Y-m-d H:i:s', $time);

        return $this->where('end_utc_at', $finished ? '<=' : '>=', $date);
    }

    /**
     * @param bool $shared = true
     *
     * @return self
     */
    public function whereShared(bool $shared = true): self
    {
        return $this->where('shared', $shared);
    }

    /**
     * @param bool $shared_public = true
     *
     * @return self
     */
    public function whereSharedPublic(bool $shared_public = true): self
    {
        return $this->whereShared()->where('shared_public', $shared_public);
    }

    /**
     * @return self
     */
    public function withDevice(): self
    {
        return $this->with('device');
    }

    /**
     * @param string $relation
     * @param bool $condition
     *
     * @return self
     */
    public function withSimpleWhen(string $relation, bool $condition): self
    {
        return $this->when($condition, fn ($q) => $q->withSimple($relation));
    }

    /**
     * @return self
     */
    public function withTimezone(): self
    {
        return $this->with('timezone');
    }

    /**
     * @return self
     */
    public function withVehicle(): self
    {
        return $this->with('vehicle');
    }
}

```

`app/Domains/Trip/Model/Collection/Trip.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Trip extends CollectionAbstract
{
}

```

`app/Domains/Trip/Model/Traits/Query.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Model\Traits;

use App\Domains\Trip\Model\Trip as Model;

trait Query
{
    /**
     * @return ?\App\Domains\Trip\Model\Trip
     */
    public function next(): ?Model
    {
        return self::query()
            ->selectSimple()
            ->byVehicleId($this->vehicle->id)
            ->byStartUtcAtAfter($this->start_utc_at)
            ->first();
    }

    /**
     * @return ?\App\Domains\Trip\Model\Trip
     */
    public function previous(): ?Model
    {
        return self::query()
            ->selectSimple()
            ->byVehicleId($this->vehicle->id)
            ->byStartUtcAtBefore($this->start_utc_at)
            ->first();
    }
}

```

`app/Domains/Trip/Model/Traits/Statement.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Model\Traits;

trait Statement
{
    /**
     * @return void
     */
    public function updateDistanceTime(): void
    {
        static::db()->statement('
            UPDATE `trip`, (
                WITH `summary` AS (
                    SELECT `trip_id`, ST_Distance(
                        LAG(`point`) OVER (PARTITION BY `trip_id` ORDER BY `date_utc_at` ASC),
                        `point`
                    ) AS `distance`
                    FROM `position`
                    WHERE `trip_id` = :trip_id
                    ORDER BY `date_utc_at` ASC
                )
                SELECT `trip_id`, ROUND(COALESCE(SUM(`distance`), 0)) `distance`
                FROM `summary`
                GROUP BY `trip_id`
            ) `summary`
            SET
                `trip`.`distance` = `summary`.`distance`,
                `trip`.`time` = UNIX_TIMESTAMP(`trip`.`end_utc_at`) - UNIX_TIMESTAMP(`trip`.`start_utc_at`)
            WHERE
                `trip`.`id` = `summary`.`trip_id`;
        ', ['trip_id' => $this->id]);
    }
}

```

`app/Domains/Trip/Model/Trip.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\Trip\Model\Builder\Trip as Builder;
use App\Domains\Trip\Model\Collection\Trip as Collection;
use App\Domains\Trip\Model\Traits\Query as QueryTrait;
use App\Domains\Trip\Model\Traits\Statement as StatementTrait;
use App\Domains\Trip\Test\Factory\Trip as TestFactory;
use App\Domains\User\Model\User as UserModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class Trip extends ModelAbstract
{
    use HasFactory;
    use QueryTrait;
    use StatementTrait;

    /**
     * @var string
     */
    protected $table = 'trip';

    /**
     * @const string
     */
    public const TABLE = 'trip';

    /**
     * @const string
     */
    public const FOREIGN = 'trip_id';

    /**
     * @const string
     */
    protected const DATE_REGEXP = '[0-9]{4}\-[0-9]{2}\-[0-9]{2}\s[0-9]{2}:[0-9]{2}:[0-9]{2}';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'stats' => 'array',
        'shared' => 'boolean',
        'shared_public' => 'boolean',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\Trip\Model\Collection\Trip
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Trip\Model\Builder\Trip
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Trip\Test\Factory\Trip
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function device(): BelongsTo
    {
        return $this->belongsTo(DeviceModel::class, DeviceModel::FOREIGN)->withDefault();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function positions(): HasMany
    {
        return $this->hasMany(PositionModel::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function timezone(): BelongsTo
    {
        return $this->belongsTo(TimezoneModel::class, TimezoneModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(UserModel::class, UserModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function vehicle(): BelongsTo
    {
        return $this->belongsTo(VehicleModel::class, VehicleModel::FOREIGN)->withTimezone();
    }

    /**
     * @return bool
     */
    public function nameIsDefault(): bool
    {
        return (bool)preg_match('/^'.static::DATE_REGEXP.'(\s\-\s'.static::DATE_REGEXP.')?$/', $this->getOriginal('name') ?: $this->name);
    }

    /**
     * @return string
     */
    public function nameFromDates(): string
    {
        return implode(' - ', array_filter(array_unique([$this->start_at, $this->end_at])));
    }

    /**
     * @return bool
     */
    public function finished(): bool
    {
        $wait = app('configuration')->int('trip_wait_minutes');
        $time = strtotime($this->end_utc_at);

        return $wait >= ((time() - $time) / 60);
    }
}

```

`app/Domains/Trip/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'string'],
            'start_at' => ['bail', 'required', 'date_format:Y-m-d H:i:s'],
            'start_utc_at' => ['bail', 'required', 'date_format:Y-m-d H:i:s'],
            'end_at' => ['bail', 'nullable', 'date_format:Y-m-d H:i:s'],
            'end_utc_at' => ['bail', 'nullable', 'date_format:Y-m-d H:i:s'],
            'device_id' => ['bail', 'required', 'integer'],
            'timezone_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/Trip/Validate/Import.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Import extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'user_id' => ['bail', 'integer'],
            'device_id' => ['bail', 'required', 'integer'],
            'vehicle_id' => ['bail', 'required', 'integer'],
            'timezone_id' => ['bail', 'nullable', 'integer'],
            'file' => ['bail', 'required', 'file', 'mimes:xml,gpx', 'extensions:gpx'],
        ];
    }
}

```

`app/Domains/Trip/Validate/LastOrNew.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class LastOrNew extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'speed' => ['bail', 'required', 'numeric'],
            'date_at' => ['bail', 'required', 'date_format:Y-m-d H:i:s'],
            'date_utc_at' => ['bail', 'required', 'date_format:Y-m-d H:i:s'],
            'device_id' => ['bail', 'required', 'integer'],
            'timezone_id' => ['bail', 'required', 'integer'],
        ];
    }
}

```

`app/Domains/Trip/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Update extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'code' => ['bail', 'required', 'uuid'],
            'name' => ['bail', 'required', 'string'],
            'shared' => ['bail', 'boolean'],
            'shared_public' => ['bail', 'boolean'],
        ];
    }
}

```

`app/Domains/Trip/Validate/UpdateBoolean.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Validate;

use App\Domains\CoreApp\Validate\UpdateBoolean as UpdateBooleanCoreApp;

class UpdateBoolean extends UpdateBooleanCoreApp
{
}

```

`app/Domains/Trip/Validate/UpdateMerge.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdateMerge extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'ids' => ['bail', 'required', 'array'],
        ];
    }
}

```

`app/Domains/Trip/Validate/UpdatePositionCreate.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdatePositionCreate extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'position_ids' => ['bail', 'required', 'array'],
        ];
    }
}

```

`app/Domains/Trip/Validate/UpdatePositionDelete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdatePositionDelete extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'position_ids' => ['bail', 'required', 'array'],
        ];
    }
}

```

`app/Domains/Trip/Validate/UpdateStatsAll.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdateStatsAll extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'force' => ['bail', 'boolean'],
        ];
    }
}

```

`app/Domains/Trip/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Trip\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/User/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

use App\Domains\Core\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\User\Model\User as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\User\Model\User
     */
    protected ?Model $row;
}

```

`app/Domains/User/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\User\Model\User as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\User\Model\User
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\User\Model\User
     */
    public function authApi(): Model
    {
        return $this->actionHandle(AuthApi::class);
    }

    /**
     * @return \App\Domains\User\Model\User
     */
    public function authCredentials(): Model
    {
        return $this->actionHandle(AuthCredentials::class, $this->validate()->authCredentials());
    }

    /**
     * @return \App\Domains\User\Model\User
     */
    public function authModel(): Model
    {
        return $this->actionHandle(AuthModel::class);
    }

    /**
     * @return \App\Domains\User\Model\User
     */
    public function create(): Model
    {
        return $this->actionHandleTransaction(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandle(Delete::class);
    }

    /**
     * @return void
     */
    public function logout(): void
    {
        $this->actionHandle(Logout::class);
    }

    /**
     * @return \App\Domains\User\Model\User
     */
    public function request(): Model
    {
        return $this->actionHandle(Request::class);
    }

    /**
     * @return \App\Domains\User\Model\User
     */
    public function set(): Model
    {
        return $this->actionHandle(Set::class);
    }

    /**
     * @return \App\Domains\User\Model\User
     */
    public function update(): Model
    {
        return $this->actionHandleTransaction(Update::class, $this->validate()->update());
    }
}

```

`app/Domains/User/Action/AuthApi.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

use App\Domains\User\Exception\AuthFailed;
use App\Domains\User\Model\User as Model;

class AuthApi extends ActionAbstract
{
    /**
     * @return \App\Domains\User\Model\User
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->row();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataApiKey();
        $this->dataApiHash();
        $this->dataApiPrefix();
    }

    /**
     * @return void
     */
    protected function dataApiKey(): void
    {
        $this->data['api_key'] = strval($this->request->header('Authorization'));
        $this->data['api_key'] = preg_replace('/^\s*bearer\s+/i', '', $this->data['api_key']);
    }

    /**
     * @return void
     */
    protected function dataApiHash(): void
    {
        $this->data['api_key_hash'] = hash('sha256', $this->data['api_key']);
    }

    /**
     * @return void
     */
    protected function dataApiPrefix(): void
    {
        $this->data['api_key_prefix'] = explode('-', $this->data['api_key'], 2)[0];
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkApiKey();
        $this->checkIp();
    }

    /**
     * @return void
     */
    protected function checkApiKey(): void
    {
        if (helper()->uuidIsValid($this->data['api_key']) === false) {
            $this->fail();
        }
    }

    /**
     * @return void
     */
    protected function checkIp(): void
    {
        $this->factory('IpLock')->action()->check();
    }

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = Model::query()
            ->byApiKey($this->data['api_key_hash'])
            ->byApiKeyPrefix($this->data['api_key_prefix'])
            ->whereApiKeyEnabled()
            ->enabled()
            ->firstOr(fn () => $this->fail());
    }

    /**
     * @throws \App\Domains\User\Exception\AuthFailed
     *
     * @return void
     */
    protected function fail(): void
    {
        $this->factory('UserFail')->action($this->failData())->create();

        throw new AuthFailed(__('user-auth-api.error.auth-fail'));
    }

    /**
     * @return array
     */
    protected function failData(): array
    {
        return [
            'type' => 'user-auth-api',
            'text' => $this->data['api_key'],
            'ip' => $this->request->ip(),
            'user_id' => $this->row?->id,
        ];
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveSet();
        $this->saveAuth();
        $this->saveUserSession();
    }

    /**
     * @return void
     */
    protected function saveSet(): void
    {
        $this->factory()->action()->set();
    }

    /**
     * @return void
     */
    protected function saveAuth(): void
    {
        $this->auth = $this->row;
    }

    /**
     * @return void
     */
    protected function saveUserSession(): void
    {
        $this->factory('UserSession')->action($this->saveUserSessionData())->create();
    }

    /**
     * @return array
     */
    protected function saveUserSessionData(): array
    {
        return [
            'auth' => $this->row->email,
            'ip' => $this->request->ip(),
            'user_id' => $this->row->id,
        ];
    }
}

```

`app/Domains/User/Action/AuthCredentials.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

use Illuminate\Support\Facades\Hash;
use App\Domains\User\Exception\AuthFailed;
use App\Domains\User\Model\User as Model;

class AuthCredentials extends ActionAbstract
{
    /**
     * @return \App\Domains\User\Model\User
     */
    public function handle(): Model
    {
        $this->checkIp();
        $this->row();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function checkIp(): void
    {
        $this->factory('IpLock')->action()->check();
    }

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = Model::query()
            ->byEmail($this->data['email'])
            ->enabled()
            ->firstOr(fn () => $this->fail());
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkPassword();
    }

    /**
     * @return void
     */
    protected function checkPassword(): void
    {
        if (Hash::check($this->data['password'], $this->row->password) === false) {
            $this->fail();
        }
    }

    /**
     * @throws \App\Domains\User\Exception\AuthFailed
     *
     * @return void
     */
    protected function fail(): void
    {
        $this->factory('UserFail')->action($this->failData())->create();

        throw new AuthFailed(__('user-auth-credentials.error.auth-fail'));
    }

    /**
     * @return array
     */
    protected function failData(): array
    {
        return [
            'type' => 'user-auth-credentials',
            'text' => $this->data['email'],
            'ip' => $this->request->ip(),
            'user_id' => $this->row?->id,
        ];
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveSet();
        $this->saveAuth();
        $this->saveUserSession();
    }

    /**
     * @return void
     */
    protected function saveSet(): void
    {
        $this->factory()->action()->set();
    }

    /**
     * @return void
     */
    protected function saveAuth(): void
    {
        $this->auth = $this->row;
    }

    /**
     * @return void
     */
    protected function saveUserSession(): void
    {
        $this->factory('UserSession')->action($this->saveUserSessionData())->create();
    }

    /**
     * @return array
     */
    protected function saveUserSessionData(): array
    {
        return [
            'auth' => $this->data['email'],
            'ip' => $this->request->ip(),
            'user_id' => $this->row->id,
        ];
    }
}

```

`app/Domains/User/Action/AuthModel.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

use Illuminate\Support\Facades\Auth;
use App\Domains\User\Model\User as Model;

class AuthModel extends ActionAbstract
{
    /**
     * @return \App\Domains\User\Model\User
     */
    public function handle(): Model
    {
        $this->login();
        $this->auth();
        $this->userSession();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function login(): void
    {
        Auth::login($this->row, true);
    }

    /**
     * @return void
     */
    protected function auth(): void
    {
        $this->row = $this->auth = Auth::user();
    }

    /**
     * @return void
     */
    protected function userSession(): void
    {
        $this->factory('UserSession')->action($this->saveUserSessionData())->create();
    }

    /**
     * @return array
     */
    protected function saveUserSessionData(): array
    {
        return [
            'auth' => $this->data['email'],
            'ip' => $this->request->ip(),
            'user_id' => $this->row->id,
        ];
    }
}

```

`app/Domains/User/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

use App\Domains\User\Model\User as Model;

class Create extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'name' => $this->data['name'],
            'email' => $this->data['email'],
            'password' => $this->data['password'],

            'api_key' => $this->data['api_key'],
            'api_key_prefix' => $this->data['api_key_prefix'],
            'api_key_enabled' => $this->data['api_key_enabled'],

            'preferences' => $this->data['preferences'],

            'admin' => $this->data['admin'],
            'admin_mode' => $this->data['admin'],
            'manager' => $this->data['manager'],
            'manager_mode' => $this->data['manager'],
            'enabled' => $this->data['enabled'],

            'language_id' => $this->data['language_id'],
            'timezone_id' => $this->data['timezone_id'],
        ])->fresh();
    }
}

```

`app/Domains/User/Action/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

use Illuminate\Support\Facades\Hash;
use App\Domains\Language\Model\Language as LanguageModel;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\User\Model\User as Model;

abstract class CreateUpdateAbstract extends ActionAbstract
{
    /**
     * @return void
     */
    abstract protected function save(): void;

    /**
     * @return \App\Domains\User\Model\User
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataName();
        $this->dataEmail();
        $this->dataPassword();
        $this->dataApiKey();
        $this->dataPreferences();
        $this->dataLanguageId();
        $this->dataTimezoneId();
    }

    /**
     * @return void
     */
    protected function dataName(): void
    {
        $this->data['name'] = trim($this->data['name']);
    }

    /**
     * @return void
     */
    protected function dataEmail(): void
    {
        $this->data['email'] = strtolower($this->data['email']);
    }

    /**
     * @return void
     */
    protected function dataPassword(): void
    {
        if ($this->data['password']) {
            $this->data['password'] = Hash::make($this->data['password']);
        } else {
            $this->data['password'] = $this->row->password;
        }
    }

    /**
     * @return void
     */
    protected function dataApiKey(): void
    {
        if (helper()->uuidIsValid($this->data['api_key'])) {
            $this->dataApiKeyValid();
        } else {
            $this->dataApiKeyInvalid();
        }

        $this->dataApiKeyEnabled();
    }

    /**
     * @return void
     */
    protected function dataApiKeyValid(): void
    {
        $this->data['api_key_prefix'] = explode('-', $this->data['api_key'], 2)[0];
        $this->data['api_key'] = hash('sha256', $this->data['api_key']);
    }

    /**
     * @return void
     */
    protected function dataApiKeyInvalid(): void
    {
        $this->data['api_key'] = $this->row?->api_key;
        $this->data['api_key_prefix'] = $this->row?->api_key_prefix;
    }

    /**
     * @return void
     */
    protected function dataApiKeyEnabled(): void
    {
        if (empty($this->data['api_key'])) {
            $this->data['api_key_enabled'] = false;
        }
    }

    /**
     * @return void
     */
    protected function dataPreferences(): void
    {
        $this->data['preferences'] = array_replace_recursive(
            $this->row->preferences ?? [],
            $this->data['preferences']
        );
    }

    /**
     * @return void
     */
    protected function dataLanguageId(): void
    {
        if ($this->data['language_id']) {
            return;
        }

        $this->data['language_id'] = $this->row->language_id ?? $this->dataLanguageIdDefault();
    }

    /**
     * @return int
     */
    protected function dataLanguageIdDefault(): int
    {
        return LanguageModel::query()
            ->whereDefault()
            ->value('id');
    }

    /**
     * @return void
     */
    protected function dataTimezoneId(): void
    {
        if ($this->data['timezone_id']) {
            return;
        }

        $this->data['timezone_id'] = $this->row->timezone_id ?? $this->dataTimezoneIdDefault();
    }

    /**
     * @return int
     */
    protected function dataTimezoneIdDefault(): int
    {
        return TimezoneModel::query()
            ->whereDefault()
            ->value('id');
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkEmail();
        $this->checkStatus();
        $this->checkApiKey();
        $this->checkLanguageId();
        $this->checkTimezoneId();
    }

    /**
     * @return void
     */
    protected function checkEmail(): void
    {
        if ($this->checkEmailExists()) {
            $this->exceptionValidator(__('user-create.error.email-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkEmailExists(): bool
    {
        return Model::query()
            ->byIdNot($this->row->id ?? 0)
            ->byEmail($this->data['email'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkStatus(): void
    {
        if (empty($this->row->id) || ($this->row->id !== $this->auth?->id)) {
            return;
        }

        if (empty($this->data['admin'])) {
            $this->exceptionValidator(__('user-create.error.admin-own'));
        }

        if (empty($this->data['enabled'])) {
            $this->exceptionValidator(__('user-create.error.enabled-own'));
        }
    }

    /**
     * @return void
     */
    protected function checkApiKey(): void
    {
        if ($this->data['api_key'] && $this->checkApiKeyExists()) {
            $this->exceptionValidator('user-create.error.api_key-exists');
        }
    }

    /**
     * @return bool
     */
    protected function checkApiKeyExists(): bool
    {
        return Model::query()
            ->byIdNot($this->row->id ?? 0)
            ->byApiKey($this->data['api_key'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkLanguageId(): void
    {
        if ($this->checkLanguageIdExists() === false) {
            $this->exceptionValidator(__('user-create.error.language-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkLanguageIdExists(): bool
    {
        return LanguageModel::query()
            ->byId($this->data['language_id'])
            ->exists();
    }

    /**
     * @return void
     */
    protected function checkTimezoneId(): void
    {
        if ($this->checkTimezoneIdExists() === false) {
            $this->exceptionValidator(__('user-create.error.timezone-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkTimezoneIdExists(): bool
    {
        return TimezoneModel::query()
            ->byId($this->data['timezone_id'])
            ->exists();
    }
}

```

`app/Domains/User/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->check();
        $this->delete();
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        if ($this->row->id === $this->auth->id) {
            $this->exceptionValidator(__('user-delete.error.current'));
        }
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }
}

```

`app/Domains/User/Action/Logout.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

use Illuminate\Support\Facades\Auth;

class Logout extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->logout();
        $this->session();
    }

    /**
     * @return void
     */
    protected function logout(): void
    {
        Auth::logout();
    }

    /**
     * @return void
     */
    protected function session(): void
    {
        $this->request->session()->flush();
    }
}

```

`app/Domains/User/Action/Request.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

use App\Domains\User\Exception\AuthFailed;
use App\Domains\User\Model\User as Model;

class Request extends ActionAbstract
{
    /**
     * @return \App\Domains\User\Model\User
     */
    public function handle(): Model
    {
        $this->row();
        $this->check();
        $this->set();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = $this->request->user();
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        if (empty($this->row)) {
            throw new AuthFailed(__('user-auth.error.empty'));
        }
    }

    /**
     * @return void
     */
    protected function set(): void
    {
        $this->factory(row: $this->row)->action()->set();
    }
}

```

`app/Domains/User/Action/Set.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

use Illuminate\Support\Facades\Auth;
use App\Domains\User\Model\User as Model;

class Set extends ActionAbstract
{
    /**
     * @return \App\Domains\User\Model\User
     */
    public function handle(): Model
    {
        $this->set();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function set(): void
    {
        $this->setAuth();
        $this->setRow();
        $this->setLanguage();
    }

    /**
     * @return void
     */
    protected function setAuth(): void
    {
        Auth::login($this->row, true);
    }

    /**
     * @return void
     */
    protected function setRow(): void
    {
        app()->bind('user', fn () => $this->row);
    }

    /**
     * @return void
     */
    protected function setLanguage(): void
    {
        $this->factory('Language', $this->row->language)->action()->set();
    }
}

```

`app/Domains/User/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Action;

class Update extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->name = $this->data['name'];
        $this->row->email = $this->data['email'];
        $this->row->password = $this->data['password'];

        $this->row->api_key = $this->data['api_key'];
        $this->row->api_key_prefix = $this->data['api_key_prefix'];
        $this->row->api_key_enabled = $this->data['api_key_enabled'];

        $this->row->preferences = $this->data['preferences'];

        $this->row->admin = $this->data['admin'];
        $this->row->admin_mode = $this->data['admin'];
        $this->row->manager = $this->data['manager'];
        $this->row->manager_mode = $this->data['manager'];
        $this->row->enabled = $this->data['enabled'];

        $this->row->language_id = $this->data['language_id'];
        $this->row->timezone_id = $this->data['timezone_id'];

        $this->row->save();
    }
}

```

`app/Domains/User/Command/CommandAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Command;

use App\Domains\Core\Command\CommandAbstract as CommandAbstractSahred;
use App\Domains\User\Model\User as Model;

abstract class CommandAbstract extends CommandAbstractSahred
{
    /**
     * @var \App\Domains\User\Model\User
     */
    protected Model $row;

    /**
     * @return void
     */
    protected function row(): void
    {
        $this->row = Model::query()->findOrFail($this->checkOption('id'));
        $this->actingAs($this->row);
    }
}

```

`app/Domains/User/Command/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Command;

class Create extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'user:create {--email=} {--name=} {--password=} {--admin} {--manager} {--enabled}';

    /**
     * @var string
     */
    protected $description = 'Create User with {--email=} {--name=} {--password=} {--admin} {--manager} {--enabled}';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->checkOptions(['email', 'name', 'password']);
        $this->requestWithOptions();

        $this->info($this->factory()->action()->create()->only('id', 'email', 'name', 'admin', 'manager', 'enabled'));

        $this->info('[END]');
    }
}

```

`app/Domains/User/Command/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Command;

class Update extends CommandAbstract
{
    /**
     * @var string
     */
    protected $signature = 'user:update {--id=} {--name=} {--email=} {--password=} {--admin} {--manager} {--enabled}';

    /**
     * @var string
     */
    protected $description = 'Update User with {--name=} {--email=} {--password=} {--admin} {--manager} {--enabled}';

    /**
     * @return void
     */
    public function handle(): void
    {
        $this->info('[START]');

        $this->checkOptions(['id']);
        $this->requestWithOptions();

        $this->row();

        $this->requestMergeRow();

        $this->update();
        $this->output();

        $this->info('[END]');
    }

    /**
     * @return void
     */
    protected function update(): void
    {
        $this->row = $this->factory()->action()->update();
    }

    /**
     * @return void
     */
    protected function output(): void
    {
        $this->info(helper()->jsonEncode($this->row->only('id', 'name', 'email', 'admin', 'manager', 'enabled')));
    }
}

```

`app/Domains/User/Controller/AuthCredentials.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Services\Captcha\Captcha;

class AuthCredentials extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($response = $this->actionPost('authCredentials')) {
            return $response;
        }

        $this->meta('title', __('user-auth-credentials.meta-title'));

        return $this->page('user.auth-credentials', [
            'captcha' => Captcha::new()->requiredAuth(),
        ]);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function authCredentials(): RedirectResponse
    {
        $this->action()->authCredentials();

        return redirect()->route('dashboard.index');
    }
}

```

`app/Domains/User/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\User\Model\User as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\User\Model\User
     */
    protected ?Model $row;

    /**
     * @return void
     */
    protected function rowAuth(): void
    {
        $this->row = $this->auth;
    }

    /**
     * @param int $id
     *
     * @return \App\Domains\User\Model\User
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->firstOr(fn () => $this->exceptionNotFound(__('user.error.not-found')));
    }
}

```

`app/Domains/User/Controller/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\User\Controller\Service\Create as ControllerService;

class Create extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($response = $this->actionPost('create')) {
            return $response;
        }

        $this->meta('title', __('user-create.meta-title'));

        return $this->page('user.create', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function create(): RedirectResponse
    {
        $this->row = $this->action()->create();

        $this->sessionMessage('success', __('user-create.success'));

        return redirect()->route('user.update', $this->row->id);
    }
}

```

`app/Domains/User/Controller/Disabled.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;

class Disabled extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($this->auth->enabled) {
            return redirect()->route('dashboard.index');
        }

        $this->meta('title', __('user-disabled.meta-title'));

        return $this->page('user.disabled');
    }
}

```

`app/Domains/User/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller;

use Illuminate\Http\Response;
use App\Domains\User\Model\User as Model;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('user-index.meta-title'));

        return $this->page('user.index', [
            'list' => Model::query()->list()->get(),
        ]);
    }
}

```

`app/Domains/User/Controller/Logout.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller;

use Illuminate\Http\RedirectResponse;

class Logout extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    public function __invoke(): RedirectResponse
    {
        $this->action($this->auth)->logout();

        return redirect()->route('user.auth.credentials');
    }
}

```

`app/Domains/User/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/User/Controller/Service/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;

class Create extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->request();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCommon();
    }
}

```

`app/Domains/User/Controller/Service/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller\Service;

use App\Domains\Language\Model\Collection\Language as LanguageCollection;
use App\Domains\Language\Model\Language as LanguageModel;
use App\Domains\Timezone\Model\Collection\Timezone as TimezoneCollection;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;

abstract class CreateUpdateAbstract extends ControllerAbstract
{
    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow();
    }

    /**
     * @return array
     */
    protected function dataCommon(): array
    {
        return $this->dataCore() + [
            'languages' => $this->languages(),
            'timezones' => $this->timezones(),
            'preferences_units_distance' => $this->preferencesUnitsDistance(),
            'preferences_units_volume' => $this->preferencesUnitsVolume(),
            'preferences_units_money' => $this->preferencesUnitsMoney(),
            'preferences_units_decimal' => $this->preferencesUnitsDecimal(),
            'preferences_units_thousand' => $this->preferencesUnitsThousand(),
        ];
    }

    /**
     * @return \App\Domains\Language\Model\Collection\Language
     */
    protected function languages(): LanguageCollection
    {
        return LanguageModel::query()
            ->list()
            ->get();
    }

    /**
     * @return \App\Domains\Timezone\Model\Collection\Timezone
     */
    protected function timezones(): TimezoneCollection
    {
        return TimezoneModel::query()
            ->list()
            ->get();
    }

    /**
     * @return array
     */
    protected function preferencesUnitsDistance(): array
    {
        return [
            'kilometer' => __('user-create.preferences-units-distance-kilometer'),
            'knot' => __('user-create.preferences-units-distance-knot'),
            'mile' => __('user-create.preferences-units-distance-mile'),
        ];
    }

    /**
     * @return array
     */
    protected function preferencesUnitsMoney(): array
    {
        return [
            'euro' => __('user-create.preferences-units-money-euro'),
            'dollar' => __('user-create.preferences-units-money-dollar'),
            '' => __('user-create.preferences-units-money-other'),
        ];
    }

    /**
     * @return array
     */
    protected function preferencesUnitsVolume(): array
    {
        return [
            'liter' => __('user-create.preferences-units-volume-liter'),
            'gallon' => __('user-create.preferences-units-volume-gallon'),
        ];
    }

    /**
     * @return array
     */
    protected function preferencesUnitsDecimal(): array
    {
        return [
            ',' => __('user-create.preferences-units-decimal-comma'),
            '.' => __('user-create.preferences-units-decimal-dot'),
        ];
    }

    /**
     * @return array
     */
    protected function preferencesUnitsThousand(): array
    {
        return [
            '.' => __('user-create.preferences-units-thousand-dot'),
            ',' => __('user-create.preferences-units-thousand-comma'),
        ];
    }
}

```

`app/Domains/User/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\User\Model\User as Model;

class Update extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\User\Model\User $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
    }

    /**
     * @return void
     */
    public function request(): void
    {
        $this->requestMergeWithRow(['api_key' => $this->requestApiKey()]);
    }

    /**
     * @return string
     */
    public function requestApiKey(): string
    {
        return $this->row->api_key_prefix
            ? ($this->row->api_key_prefix.'-*****-****-****-************')
            : '';
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCommon() + [
            'row' => $this->row,
            'can_be_deleted' => ($this->row->id !== $this->auth->id),
        ];
    }
}

```

`app/Domains/User/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\User\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actions()) {
            return $response;
        }

        $this->meta('title', __('user-update.meta-title', ['title' => $this->row->name]));

        return $this->page('user.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('update')
            ?: $this->actionPost('delete');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('user-update.success'));

        return redirect()->route('user.update', $this->row->id);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function delete(): RedirectResponse
    {
        $this->action()->delete();

        $this->sessionMessage('success', __('user-update.delete-success'));

        return redirect()->route('user.index');
    }
}

```

`app/Domains/User/Controller/UpdateUserSession.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller;

use Illuminate\Http\Response;
use App\Domains\UserSession\Model\Collection\UserSession as UserSessionCollection;
use App\Domains\UserSession\Model\UserSession as UserSessionModel;

class UpdateUserSession extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response
     */
    public function __invoke(int $id): Response
    {
        $this->row($id);

        $this->meta('title', __('user-update-user-session.meta-title', ['title' => $this->row->name]));

        return $this->page('user.update-user-session', [
            'row' => $this->row,
            'sessions' => $this->sessions(),
        ]);
    }

    /**
     * @return \App\Domains\UserSession\Model\Collection\UserSession
     */
    protected function sessions(): UserSessionCollection
    {
        return UserSessionModel::query()
            ->byUser($this->row)
            ->unionUserFailByUser($this->row)
            ->list()
            ->get();
    }
}

```

`app/Domains/User/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user.auth.redirect']], static function () {
    Route::any('/user/auth', AuthCredentials::class)->name('user.auth.credentials');
});

Route::group(['middleware' => ['user.request']], static function () {
    Route::get('/user/logout', Logout::class)->name('user.logout');
});

Route::group(['middleware' => ['user-auth']], static function () {
    Route::any('/user/disabled', Disabled::class)->name('user.disabled');
});

Route::group(['middleware' => ['user-auth-admin-mode']], static function () {
    Route::get('/user', Index::class)->name('user.index');
    Route::any('/user/create', Create::class)->name('user.create');
    Route::any('/user/{id}', Update::class)->name('user.update');
    Route::get('/user/{id}/user-session', UpdateUserSession::class)->name('user.update.user-session');
});

```

`app/Domains/User/ControllerApi/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\ControllerApi;

use App\Domains\CoreApp\Controller\ControllerApiAbstract as CoreControllerApiAbstract;
use App\Domains\User\Model\User as Model;

abstract class ControllerApiAbstract extends CoreControllerApiAbstract
{
    /**
     * @var ?\App\Domains\User\Model\User
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\User\Model\User
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->firstOr(fn () => $this->exceptionNotFound(__('user.error.not-found')));
    }
}

```

`app/Domains/User/ControllerApi/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\ControllerApi;

use Illuminate\Http\JsonResponse;

class Create extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('json', $this->action()->create()));
    }
}

```

`app/Domains/User/ControllerApi/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\ControllerApi;

class Delete extends ControllerApiAbstract
{
    /**
     * @param int $id
     *
     * @return void
     */
    public function __invoke(int $id): void
    {
        $this->row($id);
        $this->action()->delete();
    }
}

```

`app/Domains/User/ControllerApi/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\User\Model\Collection\User as Collection;
use App\Domains\User\Model\User as Model;

class Index extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('json', $this->data()));
    }

    /**
     * @return \App\Domains\User\Model\Collection\User
     */
    protected function data(): Collection
    {
        return Model::query()->list()->get();
    }
}

```

`app/Domains/User/ControllerApi/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\ControllerApi;

use Illuminate\Http\JsonResponse;

class Update extends ControllerApiAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(int $id): JsonResponse
    {
        $this->row($id);

        return $this->json($this->factory()->fractal('json', $this->action()->update()));
    }
}

```

`app/Domains/User/ControllerApi/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\ControllerApi;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth-admin-mode']], static function () {
    Route::get('/user', Index::class)->name('user.index');
    Route::post('/user/create', Create::class)->name('user.create');
    Route::patch('/user/{id}', Update::class)->name('user.update');
    Route::delete('/user/{id}', Delete::class)->name('user.delete');
});

```

`app/Domains/User/Exception/AuthFailed.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Exception;

use App\Exceptions\AuthenticationException;

class AuthFailed extends AuthenticationException
{
    /**
     * @var int
     */
    protected $code = 401;

    /**
     * @var ?string
     */
    protected ?string $status = 'user-auth-failed';
}

```

`app/Domains/User/Exception/ExceptionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Exception;

use App\Exceptions\GenericException;

abstract class ExceptionAbstract extends GenericException
{
}

```

`app/Domains/User/Exception/NotEnabled.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Exception;

class NotEnabled extends ExceptionAbstract
{
    /**
     * @var int
     */
    protected $code = 403;

    /**
     * @var ?string
     */
    protected ?string $status = 'user-not-enabled';
}

```

`app/Domains/User/Exception/NotLogged.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Exception;

class NotLogged extends ExceptionAbstract
{
    /**
     * @var int
     */
    protected $code = 401;

    /**
     * @var ?string
     */
    protected ?string $status = 'user-not-logged';
}

```

`app/Domains/User/Exception/SessionEmpty.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Exception;

class SessionEmpty extends ExceptionAbstract
{
    /**
     * @var int
     */
    protected $code = 401;

    /**
     * @var ?string
     */
    protected ?string $status = 'user-session-empty';
}

```

`app/Domains/User/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\User\Model\User as Model;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\User\Model\User $row
     *
     * @return array
     */
    protected function json(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
            'email' => $row->email,
            'admin' => $row->admin,
            'manager' => $row->manager,
            'enabled' => $row->enabled,

            'api_key_enabled' => $row->api_key_enabled,

            'preferences' => ['units' => $row->preferences['units']],

            'language' => $this->from('Language', 'related', $row->language),
            'timezone' => $this->from('Timezone', 'related', $row->timezone),
        ];
    }

    /**
     * @param \App\Domains\User\Model\User $row
     *
     * @return array
     */
    protected function related(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
        ];
    }
}

```

`app/Domains/User/Middleware/Admin.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Middleware;

use Closure;
use Illuminate\Http\Request;

class Admin extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        $this->load($request);

        if (empty($this->auth->admin)) {
            abort(404);
        }

        return $next($request);
    }
}

```

`app/Domains/User/Middleware/AdminMode.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Middleware;

use Closure;
use Illuminate\Http\Request;

class AdminMode extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        $this->load($request);

        if (empty($this->auth->adminMode())) {
            abort(404);
        }

        return $next($request);
    }
}

```

`app/Domains/User/Middleware/AuthApi.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Middleware;

use Closure;
use Exception;
use Illuminate\Http\Request as RequestVendor;
use Illuminate\Http\Response;

class AuthApi extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(RequestVendor $request, Closure $next): mixed
    {
        try {
            $this->factory()->action()->authApi();
        } catch (Exception $e) {
            return $this->fail($e);
        }

        return $next($request);
    }

    /**
     * @param \Exception $e
     *
     * @return \Illuminate\Http\Response
     */
    protected function fail(Exception $e): Response
    {
        if (helper()->isExceptionSystem($e)) {
            report($e);
        }

        return response(null, 401);
    }
}

```

`app/Domains/User/Middleware/AuthRedirect.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Middleware;

use Closure;
use Illuminate\Http\Request;

class AuthRedirect extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        $this->load($request);

        if (empty($this->auth)) {
            return $next($request);
        }

        if (empty($this->auth->enabled)) {
            return redirect()->route('user.disabled');
        }

        return redirect()->route('dashboard.index');
    }
}

```

`app/Domains/User/Middleware/Enabled.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Middleware;

use Closure;
use Illuminate\Http\Request;

class Enabled extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        $this->load($request);

        if (empty($this->auth->enabled) && ($request->route()->getName() !== 'user.disabled')) {
            return redirect()->route('user.disabled');
        }

        return $next($request);
    }
}

```

`app/Domains/User/Middleware/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Middleware;

use Closure;
use Illuminate\Http\Request;

class Manager extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        $this->load($request);

        if (empty($this->auth->manager)) {
            abort(404);
        }

        return $next($request);
    }
}

```

`app/Domains/User/Middleware/ManagerMode.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Middleware;

use Closure;
use Illuminate\Http\Request;

class ManagerMode extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        $this->load($request);

        if (empty($this->auth->managerMode())) {
            abort(404);
        }

        return $next($request);
    }
}

```

`app/Domains/User/Middleware/MiddlewareAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Middleware;

use Illuminate\Http\Request;
use App\Domains\Core\Middleware\MiddlewareAbstract as MiddlewareAbstractCore;
use App\Domains\User\Model\User as Model;

abstract class MiddlewareAbstract extends MiddlewareAbstractCore
{
    /**
     * @var ?\App\Domains\User\Model\User
     */
    protected ?Model $row;

    /**
     * @param \Illuminate\Http\Request $request
     *
     * @return void
     */
    protected function load(Request $request): void
    {
        $this->auth = $this->row = $request->user();
    }
}

```

`app/Domains/User/Middleware/Request.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Middleware;

use Closure;
use Exception;
use Illuminate\Http\Request as RequestVendor;

class Request extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(RequestVendor $request, Closure $next): mixed
    {
        try {
            $this->factory()->action()->request();
        } catch (Exception $e) {
            return $this->fail($request, $e);
        }

        return $next($request);
    }

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Exception $e
     *
     * @return mixed
     */
    protected function fail(RequestVendor $request, Exception $e): mixed
    {
        if (helper()->isExceptionSystem($e)) {
            report($e);
        }

        if ($request->ajax() || $request->wantsJson()) {
            return response('Unauthorized.', 401);
        }

        return redirect()->route('user.auth.credentials');
    }
}

```

`app/Domains/User/Model/Builder/User.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;

class User extends BuilderAbstract
{
    /**
     * @param string $api_key
     *
     * @return self
     */
    public function byApiKey(string $api_key): self
    {
        return $this->where('api_key', $api_key);
    }

    /**
     * @param string $api_key_prefix
     *
     * @return self
     */
    public function byApiKeyPrefix(string $api_key_prefix): self
    {
        return $this->where('api_key_prefix', $api_key_prefix);
    }

    /**
     * @param string $email
     *
     * @return self
     */
    public function byEmail(string $email): self
    {
        return $this->where('email', strtolower($email));
    }

    /**
     * @return self
     */
    public function selectRelated(): self
    {
        return $this->select('id', 'name');
    }

    /**
     * @return self
     */
    public function listSimple(): self
    {
        return $this->selectRelated()->orderBy('name', 'ASC');
    }

    /**
     * @param bool $api_key_enabled = true
     *
     * @return self
     */
    public function whereApiKeyEnabled(bool $api_key_enabled = true): self
    {
        return $this->where('api_key_enabled', $api_key_enabled);
    }
}

```

`app/Domains/User/Model/Collection/User.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class User extends CollectionAbstract
{
}

```

`app/Domains/User/Model/Traits/Preferences.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Model\Traits;

trait Preferences
{
    /**
     * @param string $key
     * @param mixed $input = null
     * @param mixed $default = null
     *
     * @return mixed
     */
    public function preference(string $key, mixed $input = null, mixed $default = null): mixed
    {
        if ($input !== null) {
            return $this->preferenceSet($key, $input);
        }

        if (($value = $this->preferences[$key] ?? null) !== null) {
            return $value;
        }

        if (isset($default)) {
            return $this->preferenceSet($key, $default);
        }

        return null;
    }

    /**
     * @param string $key
     * @param mixed $value
     *
     * @return mixed
     */
    public function preferenceSet(string $key, mixed $value): mixed
    {
        $preferences = (array)$this->preferences;

        if (($preferences[$key] ?? null) !== $value) {
            $this->preferences = [$key => $value] + $preferences;
            $this->save();
        }

        return $value;
    }
}

```

`app/Domains/User/Model/User.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Model;

use Illuminate\Auth\Authenticatable as AuthenticatableTrait;
use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\Language\Model\Language as LanguageModel;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\User\Model\Builder\User as Builder;
use App\Domains\User\Model\Collection\User as Collection;
use App\Domains\User\Model\Traits\Preferences as PreferencesTrait;
use App\Domains\User\Test\Factory\User as TestFactory;
use App\Domains\UserSession\Model\UserSession as UserSessionModel;

class User extends ModelAbstract implements Authenticatable
{
    use AuthenticatableTrait;
    use HasFactory;
    use PreferencesTrait;

    /**
     * @var string
     */
    protected $table = 'user';

    /**
     * @const string
     */
    public const TABLE = 'user';

    /**
     * @const string
     */
    public const FOREIGN = 'user_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'preferences' => 'array',
        'telegram' => 'array',
        'enabled' => 'boolean',
    ];

    /**
     * @var list<string>
     */
    protected $hidden = ['password'];

    /**
     * @param array $models
     *
     * @return \App\Domains\User\Model\Collection\User
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\User\Model\Builder\User
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\User\Test\Factory\User
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function language(): BelongsTo
    {
        return $this->belongsTo(LanguageModel::class, LanguageModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function sessions(): HasMany
    {
        return $this->hasMany(UserSessionModel::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function timezone(): BelongsTo
    {
        return $this->belongsTo(TimezoneModel::class, TimezoneModel::FOREIGN);
    }

    /**
     * @return bool
     */
    public function adminMode(): bool
    {
        return $this->admin && $this->admin_mode;
    }

    /**
     * @return bool
     */
    public function managerMode(): bool
    {
        return $this->manager && $this->manager_mode;
    }
}

```

`app/Domains/User/Validate/AuthCredentials.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class AuthCredentials extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'email' => ['bail', 'email:filter', 'required'],
            'password' => ['bail', 'required'],
        ];
    }
}

```

`app/Domains/User/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Validate;

use Illuminate\Validation\Rule;
use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'email' => ['bail', 'required', 'email:filter'],
            'password' => ['bail', 'required', 'min:8'],
            'admin' => ['bail', 'boolean'],
            'manager' => ['bail', 'boolean'],
            'enabled' => ['bail', 'boolean'],

            'api_key' => ['bail', 'nullable'],
            'api_key_enabled' => ['bail', 'boolean'],

            'preferences' => ['bail', 'array'],
            'preferences.units' => ['bail', 'array'],
            'preferences.units.decimal' => ['bail', Rule::in([',', '.'])],
            'preferences.units.distance' => ['bail', 'string', 'in:kilometer,knot,mile'],
            'preferences.units.money' => ['bail', 'string', 'in:euro,dollar'],
            'preferences.units.thousand' => ['bail', Rule::in([',', '.'])],
            'preferences.units.volume' => ['bail', 'in:liter,gallon'],

            'language_id' => ['bail', 'nullable', 'integer'],
            'timezone_id' => ['bail', 'nullable', 'integer'],
        ];
    }
}

```

`app/Domains/User/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Validate;

use Illuminate\Validation\Rule;
use App\Domains\Core\Validate\ValidateAbstract;

class Update extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'email' => ['bail', 'required', 'email:filter'],
            'password' => ['bail', 'min:8'],
            'admin' => ['bail', 'boolean'],
            'manager' => ['bail', 'boolean'],
            'enabled' => ['bail', 'boolean'],

            'api_key' => ['bail', 'nullable'],
            'api_key_enabled' => ['bail', 'boolean'],

            'preferences' => ['bail', 'array'],
            'preferences.units' => ['bail', 'array'],
            'preferences.units.decimal' => ['bail', Rule::in([',', '.'])],
            'preferences.units.distance' => ['bail', 'string', 'in:kilometer,knot,mile'],
            'preferences.units.money' => ['bail', 'string', 'in:euro,dollar'],
            'preferences.units.thousand' => ['bail', Rule::in([',', '.'])],
            'preferences.units.volume' => ['bail', 'in:liter,gallon'],

            'language_id' => ['bail', 'nullable', 'integer'],
            'timezone_id' => ['bail', 'nullable', 'integer'],
        ];
    }
}

```

`app/Domains/User/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\User\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/UserFail/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserFail\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\User\Model\User as UserModel;
use App\Domains\UserFail\Model\UserFail as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\UserFail\Model\UserFail
     */
    protected ?Model $row;

    /**
     * @var \App\Domains\User\Model\User
     */
    protected UserModel $user;
}

```

`app/Domains/UserFail/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserFail\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\UserFail\Model\UserFail as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\UserFail\Model\UserFail
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\UserFail\Model\UserFail
     */
    public function create(): Model
    {
        return $this->actionHandle(Create::class, $this->validate()->create());
    }
}

```

`app/Domains/UserFail/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserFail\Action;

use App\Domains\User\Model\User as UserModel;
use App\Domains\UserFail\Model\UserFail as Model;

class Create extends ActionAbstract
{
    /**
     * @return \App\Domains\UserFail\Model\UserFail
     */
    public function handle(): Model
    {
        $this->data();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataIp();
        $this->dataUserId();
    }

    /**
     * @return void
     */
    protected function dataIp(): void
    {
        $this->data['ip'] ??= $this->request->ip();
    }

    /**
     * @return void
     */
    protected function dataUserId(): void
    {
        if ($this->data['user_id'] === null) {
            return;
        }

        $this->data['user_id'] = UserModel::query()
            ->byId($this->data['user_id'])
            ->valueOrFail('id');
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveRow();
        $this->saveIpLock();
    }

    /**
     * @return void
     */
    protected function saveRow(): void
    {
        $this->row = Model::query()->create([
            'type' => $this->data['type'],
            'text' => $this->data['text'],
            'ip' => $this->data['ip'],
            'user_id' => $this->data['user_id'],
        ])->fresh();
    }

    /**
     * @return void
     */
    protected function saveIpLock(): void
    {
        if ($this->saveIpLockCurrent() === false) {
            return;
        }

        $action = $this->factory('IpLock')->action($this->saveIpLockData());

        $action->lock();
        $action->check();
    }

    /**
     * @return array
     */
    protected function saveIpLockData(): array
    {
        return [
            'ip' => $this->data['ip'],
        ];
    }

    /**
     * @return bool
     */
    protected function saveIpLockCurrent(): bool
    {
        return $this->saveIpLockCount() > (int)config('auth.lock.allowed');
    }

    /**
     * @return int
     */
    protected function saveIpLockCount(): int
    {
        return Model::query()
            ->byIp($this->data['ip'])
            ->byCreatedAtAfter($this->saveIpLockCountDate())
            ->count();
    }

    /**
     * @return string
     */
    protected function saveIpLockCountDate(): string
    {
        return date('Y-m-d H:i:s', strtotime('-'.(int)config('auth.lock.check').' seconds'));
    }
}

```

`app/Domains/UserFail/Model/Builder/UserFail.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserFail\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\User\Model\User as UserModel;

class UserFail extends BuilderAbstract
{
    /**
     * @param string $ip
     *
     * @return self
     */
    public function byIp(string $ip): self
    {
        return $this->where($this->addTable('ip'), $ip);
    }

    /**
     * @param \App\Domains\User\Model\User $user
     *
     * @return self
     */
    public function byUser(UserModel $user): self
    {
        return $this->orWhere(static function ($q) use ($user) {
            return $q->where($q->addTable('text'), $user->email)
                ->orWhere($q->addTable('user_id'), $user->id);
        });
    }

    /**
     * @return self
     */
    public function withUser(): self
    {
        return $this->with('user');
    }
}

```

`app/Domains/UserFail/Model/Collection/UserFail.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserFail\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class UserFail extends CollectionAbstract
{
}

```

`app/Domains/UserFail/Model/UserFail.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserFail\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\User\Model\User as UserModel;
use App\Domains\UserFail\Model\Builder\UserFail as Builder;
use App\Domains\UserFail\Model\Collection\UserFail as Collection;
use App\Domains\UserFail\Test\Factory\UserFail as TestFactory;

class UserFail extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'user_fail';

    /**
     * @const string
     */
    public const TABLE = 'user_fail';

    /**
     * @const string
     */
    public const FOREIGN = 'user_fail_id';

    /**
     * @param array $models
     *
     * @return \App\Domains\UserFail\Model\Collection\UserFail
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\UserFail\Model\Builder\UserFail
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\UserFail\Test\Factory\UserFail
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(UserModel::class, UserModel::FOREIGN);
    }
}

```

`app/Domains/UserFail/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserFail\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'type' => ['bail', 'required'],
            'text' => ['bail', 'required'],
            'ip' => ['bail', 'nullable'],
            'user_id' => ['bail', 'integer', 'nullable'],
        ];
    }
}

```

`app/Domains/UserFail/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserFail\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/UserSession/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserSession\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\User\Model\User as UserModel;
use App\Domains\UserSession\Model\UserSession as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\UserSession\Model\UserSession
     */
    protected ?Model $row;

    /**
     * @var \App\Domains\User\Model\User
     */
    protected UserModel $user;
}

```

`app/Domains/UserSession/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserSession\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\UserSession\Model\UserSession as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\UserSession\Model\UserSession
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\UserSession\Model\UserSession
     */
    public function create(): Model
    {
        return $this->actionHandle(Create::class, $this->validate()->create());
    }
}

```

`app/Domains/UserSession/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserSession\Action;

use App\Domains\User\Model\User as UserModel;
use App\Domains\UserSession\Model\UserSession as Model;

class Create extends ActionAbstract
{
    /**
     * @return \App\Domains\UserSession\Model\UserSession
     */
    public function handle(): Model
    {
        $this->data();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataIp();
        $this->dataUserId();
    }

    /**
     * @return void
     */
    protected function dataIp(): void
    {
        $this->data['ip'] ??= $this->request->ip();
    }

    /**
     * @return void
     */
    protected function dataUserId(): void
    {
        $this->data['user_id'] = UserModel::query()
            ->select('id')
            ->byId($this->data['user_id'])
            ->valueOrFail('id');
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'auth' => $this->data['auth'],
            'ip' => $this->data['ip'],
            'user_id' => $this->data['user_id'],
        ])->fresh();
    }
}

```

`app/Domains/UserSession/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserSession\Controller;

use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\UserSession\Model\UserSession as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\UserSession\Model\UserSession
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\UserSession\Model\UserSession
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->firstOr(fn () => $this->exceptionNotFound(__('user-sessoin.error.not-found')));
    }
}

```

`app/Domains/UserSession/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserSession\Controller;

use Illuminate\Http\Response;
use App\Domains\UserSession\Model\Collection\UserSession as Collection;
use App\Domains\UserSession\Model\UserSession as Model;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('user-session-index.meta-title'));

        return $this->page('user-session.index', [
            'list' => $this->list(),
        ]);
    }

    /**
     * @return \App\Domains\UserSession\Model\Collection\UserSession
     */
    protected function list(): Collection
    {
        return Model::query()
            ->unionUserFail()
            ->withUser()
            ->list()
            ->get();
    }
}

```

`app/Domains/UserSession/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserSession\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth-admin-mode']], static function () {
    Route::get('/user-session', Index::class)->name('user-session.index');
});

```

`app/Domains/UserSession/Model/Builder/UserSession.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserSession\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\User\Model\User as UserModel;
use App\Domains\UserFail\Model\Builder\UserFail as UserFailBuilder;
use App\Domains\UserFail\Model\UserFail as UserFailModel;

class UserSession extends BuilderAbstract
{
    /**
     * @param string $auth
     *
     * @return self
     */
    public function byAuth(string $auth): self
    {
        return $this->where('auth', $auth);
    }

    /**
     * @param string $ip
     *
     * @return self
     */
    public function byIp(string $ip): self
    {
        return $this->where('ip', $ip);
    }

    /**
     * @param \App\Domains\User\Model\User $user
     *
     * @return self
     */
    public function byUser(UserModel $user): self
    {
        return $this->orWhere(static function ($q) use ($user) {
            return $q->where('auth', $user->email)
                ->orWhere('user_id', $user->id);
        });
    }

    /**
     * @return self
     */
    public function list(): self
    {
        return $this->orderBy('created_at', 'DESC');
    }

    /**
     * @return self
     */
    public function unionUserFail(): self
    {
        return $this->selectRaw('`auth`, `ip`, TRUE AS `success`, `created_at`, `user_id`')
            ->union($this->unionUserFailQuery());
    }

    /**
     * @return \App\Domains\UserFail\Model\Builder\UserFail
     */
    public function unionUserFailQuery(): UserFailBuilder
    {
        return UserFailModel::query()
            ->selectRaw('`text` AS `auth`, `ip`, FALSE AS `success`, `created_at`, `user_id`');
    }

    /**
     * @param \App\Domains\User\Model\User $user
     *
     * @return self
     */
    public function unionUserFailByUser(UserModel $user): self
    {
        return $this->selectRaw('`auth`, `ip`, TRUE AS `success`, `created_at`, `user_id`')
            ->union($this->unionUserFailQueryByUser($user));
    }

    /**
     * @param \App\Domains\User\Model\User $user
     *
     * @return \App\Domains\UserFail\Model\Builder\UserFail
     */
    public function unionUserFailQueryByUser(UserModel $user): UserFailBuilder
    {
        return UserFailModel::query()
            ->selectRaw('`text` AS `auth`, `ip`, FALSE AS `success`, `created_at`, `user_id`')
            ->byUser($user);
    }

    /**
     * @return self
     */
    public function withUser(): self
    {
        return $this->with('user');
    }
}

```

`app/Domains/UserSession/Model/Collection/UserSession.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserSession\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class UserSession extends CollectionAbstract
{
}

```

`app/Domains/UserSession/Model/UserSession.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserSession\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\User\Model\User as UserModel;
use App\Domains\UserSession\Model\Builder\UserSession as Builder;
use App\Domains\UserSession\Model\Collection\UserSession as Collection;
use App\Domains\UserSession\Test\Factory\UserSession as TestFactory;

class UserSession extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'user_session';

    /**
     * @const string
     */
    public const TABLE = 'user_session';

    /**
     * @const string
     */
    public const FOREIGN = 'user_session_id';

    /**
     * @param array $models
     *
     * @return \App\Domains\UserSession\Model\Collection\UserSession
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\UserSession\Model\Builder\UserSession
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\UserSession\Test\Factory\UserSession
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(UserModel::class, UserModel::FOREIGN);
    }
}

```

`app/Domains/UserSession/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserSession\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'auth' => ['bail', 'required'],
            'ip' => ['bail', 'nullable'],
            'user_id' => ['bail', 'integer', 'required'],
        ];
    }
}

```

`app/Domains/UserSession/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\UserSession\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Domains/Vehicle/Action/ActionAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Action;

use App\Domains\CoreApp\Action\ActionAbstract as ActionAbstractCore;
use App\Domains\Vehicle\Model\Vehicle as Model;

abstract class ActionAbstract extends ActionAbstractCore
{
    /**
     * @var ?\App\Domains\Vehicle\Model\Vehicle
     */
    protected ?Model $row;
}

```

`app/Domains/Vehicle/Action/ActionFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Action;

use App\Domains\Core\Action\ActionFactoryAbstract;
use App\Domains\Vehicle\Model\Vehicle as Model;

class ActionFactory extends ActionFactoryAbstract
{
    /**
     * @var ?\App\Domains\Vehicle\Model\Vehicle
     */
    protected ?Model $row;

    /**
     * @return \App\Domains\Vehicle\Model\Vehicle
     */
    public function create(): Model
    {
        return $this->actionHandle(Create::class, $this->validate()->create());
    }

    /**
     * @return void
     */
    public function delete(): void
    {
        $this->actionHandle(Delete::class);
    }

    /**
     * @return \App\Domains\Vehicle\Model\Vehicle
     */
    public function update(): Model
    {
        return $this->actionHandle(Update::class, $this->validate()->update());
    }

    /**
     * @return \App\Domains\Vehicle\Model\Vehicle
     */
    public function updateAlarm(): Model
    {
        return $this->actionHandle(UpdateAlarm::class, $this->validate()->updateAlarm());
    }

    /**
     * @return \App\Domains\Vehicle\Model\Vehicle
     */
    public function updateDevice(): Model
    {
        return $this->actionHandle(UpdateDevice::class, $this->validate()->updateDevice());
    }
}

```

`app/Domains/Vehicle/Action/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Action;

use App\Domains\Vehicle\Model\Vehicle as Model;

class Create extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row = Model::query()->create([
            'name' => $this->data['name'],
            'plate' => $this->data['plate'],
            'config' => $this->data['config'],
            'timezone_auto' => $this->data['timezone_auto'],
            'enabled' => $this->data['enabled'],
            'timezone_id' => $this->data['timezone_id'],
            'user_id' => $this->data['user_id'],
        ]);
    }
}

```

`app/Domains/Vehicle/Action/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Action;

use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\Vehicle\Model\Vehicle as Model;

abstract class CreateUpdateAbstract extends ActionAbstract
{
    /**
     * @return void
     */
    abstract protected function save(): void;

    /**
     * @return \App\Domains\Vehicle\Model\Vehicle
     */
    public function handle(): Model
    {
        $this->data();
        $this->check();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->dataName();
        $this->dataPlate();
        $this->dataUserId();
    }

    /**
     * @return void
     */
    protected function dataName(): void
    {
        $this->data['name'] = trim($this->data['name']);
    }

    /**
     * @return void
     */
    protected function dataPlate(): void
    {
        $this->data['plate'] = trim($this->data['plate']);
    }

    /**
     * @return void
     */
    protected function check(): void
    {
        $this->checkTimezone();
    }

    /**
     * @return void
     */
    protected function checkTimezone(): void
    {
        if ($this->checkTimezoneExists() === false) {
            $this->exceptionValidator(__('vehicle-create.error.timezone-exists'));
        }
    }

    /**
     * @return bool
     */
    protected function checkTimezoneExists(): bool
    {
        return TimezoneModel::query()
            ->byId($this->data['timezone_id'])
            ->exists();
    }
}

```

`app/Domains/Vehicle/Action/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Action;

class Delete extends ActionAbstract
{
    /**
     * @return void
     */
    public function handle(): void
    {
        $this->delete();
    }

    /**
     * @return void
     */
    protected function delete(): void
    {
        $this->row->delete();
    }
}

```

`app/Domains/Vehicle/Action/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Action;

class Update extends CreateUpdateAbstract
{
    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->name = $this->data['name'];
        $this->row->plate = $this->data['plate'];
        $this->row->config = $this->data['config'];
        $this->row->timezone_auto = $this->data['timezone_auto'];
        $this->row->enabled = $this->data['enabled'];
        $this->row->timezone_id = $this->data['timezone_id'];

        $this->row->save();
    }
}

```

`app/Domains/Vehicle/Action/UpdateAlarm.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Action;

use App\Domains\Alarm\Model\Alarm as AlarmModel;
use App\Domains\Vehicle\Model\Vehicle as Model;

class UpdateAlarm extends ActionAbstract
{
    /**
     * @return \App\Domains\Vehicle\Model\Vehicle
     */
    public function handle(): Model
    {
        $this->data();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->data['related'] = AlarmModel::query()
            ->byUserId($this->row->user_id)
            ->byIds($this->data['related'])
            ->pluck('id')
            ->all();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->row->alarms()->sync($this->data['related']);
    }
}

```

`app/Domains/Vehicle/Action/UpdateDevice.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Action;

use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Vehicle\Model\Vehicle as Model;

class UpdateDevice extends ActionAbstract
{
    /**
     * @return \App\Domains\Vehicle\Model\Vehicle
     */
    public function handle(): Model
    {
        $this->data();
        $this->save();

        return $this->row;
    }

    /**
     * @return void
     */
    protected function data(): void
    {
        $this->data['related'] = DeviceModel::query()
            ->byUserId($this->row->user_id)
            ->byIds($this->data['related'])
            ->pluck('id')
            ->all();
    }

    /**
     * @return void
     */
    protected function save(): void
    {
        $this->saveUnrelate();
        $this->saveRelate();
    }

    /**
     * @return void
     */
    protected function saveUnrelate(): void
    {
        DeviceModel::query()
            ->byVehicleId($this->row->id)
            ->update(['vehicle_id' => null]);
    }

    /**
     * @return void
     */
    protected function saveRelate(): void
    {
        if (empty($this->data['related'])) {
            return;
        }

        DeviceModel::query()
            ->byIds($this->data['related'])
            ->update(['vehicle_id' => $this->row->id]);
    }
}

```

`app/Domains/Vehicle/Controller/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller;

use App\Domains\Alarm\Model\Alarm as AlarmModel;
use App\Domains\AlarmNotification\Model\AlarmNotification as AlarmNotificationModel;
use App\Domains\CoreApp\Controller\ControllerWebAbstract;
use App\Domains\Vehicle\Model\Vehicle as Model;

abstract class ControllerAbstract extends ControllerWebAbstract
{
    /**
     * @var ?\App\Domains\Vehicle\Model\Vehicle
     */
    protected ?Model $row;

    /**
     * @var ?\App\Domains\Alarm\Model\Alarm
     */
    protected ?AlarmModel $alarm;

    /**
     * @var ?\App\Domains\AlarmNotification\Model\AlarmNotification
     */
    protected ?AlarmNotificationModel $alarmNotification;

    /**
     * @param int $id
     *
     * @return \App\Domains\Vehicle\Model\Vehicle
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('vehicle.error.not-found')));
    }

    /**
     * @param int $alarm_id
     *
     * @return \App\Domains\Alarm\Model\Alarm
     */
    protected function alarm(int $alarm_id): AlarmModel
    {
        return $this->alarm = AlarmModel::query()
            ->byId($alarm_id)
            ->byVehicleId($this->row->id)
            ->firstOr(fn () => $this->exceptionNotFound(__('vehicle.error.not-found')));
    }

    /**
     * @param int $alarm_notification_id
     *
     * @return \App\Domains\AlarmNotification\Model\AlarmNotification
     */
    protected function alarmNotification(int $alarm_notification_id): AlarmNotificationModel
    {
        return $this->alarmNotification = AlarmNotificationModel::query()
            ->byId($alarm_notification_id)
            ->byVehicleId($this->row->id)
            ->firstOr(fn () => $this->exceptionNotFound(__('vehicle.error.not-found')));
    }
}

```

`app/Domains/Vehicle/Controller/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Vehicle\Controller\Service\Create as ControllerService;

class Create extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(): Response|RedirectResponse
    {
        if ($response = $this->actionPost('create')) {
            return $response;
        }

        $this->meta('title', __('vehicle-create.meta-title'));

        return $this->page('vehicle.create', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function create(): RedirectResponse
    {
        $this->row = $this->action()->create();

        $this->sessionMessage('success', __('vehicle-create.success'));

        return redirect()->route('vehicle.update', $this->row->id);
    }
}

```

`app/Domains/Vehicle/Controller/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller;

use Illuminate\Http\Response;
use App\Domains\Vehicle\Controller\Service\Index as ControllerService;

class Index extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response
     */
    public function __invoke(): Response
    {
        $this->meta('title', __('vehicle-index.meta-title'));

        return $this->page('vehicle.index', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Vehicle/Controller/Map.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Response;
use App\Domains\Vehicle\Controller\Service\Map as ControllerService;

class Map extends ControllerAbstract
{
    /**
     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse
     */
    public function __invoke(): Response|JsonResponse
    {
        if ($this->request->wantsJson()) {
            return $this->responseJson();
        }

        $this->meta('title', __('vehicle-map.meta-title'));

        return $this->page('vehicle.map', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }

    /**
     * @return \Illuminate\Http\JsonResponse
     */
    protected function responseJson(): JsonResponse
    {
        return $this->json($this->factory()->fractal('map', $this->data()['list']));
    }
}

```

`app/Domains/Vehicle/Controller/Service/ControllerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller\Service;

use App\Domains\CoreApp\Controller\Service\ControllerAbstract as ControllerAbstractCore;

abstract class ControllerAbstract extends ControllerAbstractCore
{
}

```

`app/Domains/Vehicle/Controller/Service/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;

class Create extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->request();
    }

    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow([
            'user_id' => $this->user()->id,
            'timezone_id' => $this->timezoneId(),
        ]);
    }

    /**
     * @return int
     */
    protected function timezoneId(): int
    {
        return $this->cache(
            fn () => TimezoneModel::query()
                ->whereDefault()
                ->value('id')
        );
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCreateUpdate();
    }
}

```

`app/Domains/Vehicle/Controller/Service/CreateUpdateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller\Service;

use App\Domains\Timezone\Model\Collection\Timezone as TimezoneCollection;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;

abstract class CreateUpdateAbstract extends ControllerAbstract
{
    /**
     * @return array
     */
    protected function dataCreateUpdate(): array
    {
        return $this->dataCore() + [
            'timezones' => $this->timezones(),
            'trip_wait_minutes_default' => app('configuration')->int('trip_wait_minutes'),
        ];
    }

    /**
     * @return \App\Domains\Timezone\Model\Collection\Timezone
     */
    protected function timezones(): TimezoneCollection
    {
        return $this->cache(
            fn () => TimezoneModel::query()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Vehicle/Controller/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Vehicle\Model\Collection\Vehicle as Collection;
use App\Domains\Vehicle\Model\Vehicle as Model;

class Index extends ControllerAbstract
{
    /**
     * @var bool
     */
    protected bool $userEmpty = true;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->filters();
    }

    /**
     * @return void
     */
    protected function filters(): void
    {
        $this->filtersUserId();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCore() + [
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\Vehicle\Model\Collection\Vehicle
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->withAlarmsCount()
                ->withAlarmsNotificationsCount()
                ->withAlarmsNotificationsPendingCount()
                ->withDevicesCount()
                ->withTimezone()
                ->withUser()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Vehicle/Controller/Service/Map.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Vehicle\Model\Collection\Vehicle as Collection;
use App\Domains\Vehicle\Model\Vehicle as Model;

class Map extends ControllerAbstract
{
    /**
     * @var bool
     */
    protected bool $userEmpty = true;

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
        $this->filters();
    }

    /**
     * @return void
     */
    protected function filters(): void
    {
        $this->filtersUserId();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCore() + [
            'list' => $this->list(),
        ];
    }

    /**
     * @return \App\Domains\Vehicle\Model\Collection\Vehicle
     */
    protected function list(): Collection
    {
        return $this->cache(
            fn () => Model::query()
                ->whenUserId($this->user()?->id)
                ->whenIds($this->requestArray('ids'))
                ->whenTripFinished($this->requestBool('finished', null))
                ->withWhereHasPositionLast()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Vehicle/Controller/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Vehicle\Model\Vehicle as Model;

class Update extends CreateUpdateAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Vehicle\Model\Vehicle $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
        $this->request();
    }

    /**
     * @return void
     */
    protected function request(): void
    {
        $this->requestMergeWithRow();
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCreateUpdate() + [
            'row' => $this->row,
        ];
    }
}

```

`app/Domains/Vehicle/Controller/Service/UpdateAlarm.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Alarm\Model\Alarm as AlarmModel;
use App\Domains\Alarm\Model\Collection\Alarm as AlarmCollection;
use App\Domains\Vehicle\Model\Vehicle as Model;

class UpdateAlarm extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Vehicle\Model\Vehicle $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'alarms' => $this->alarms(),
        ];
    }

    /**
     * @return \App\Domains\Alarm\Model\Collection\Alarm
     */
    protected function alarms(): AlarmCollection
    {
        return $this->cache(
            fn () => AlarmModel::query()
                ->byUserId($this->user()->id)
                ->withVehiclePivot($this->row->id)
                ->list()
                ->get()
                ->sortByDesc('vehiclePivot')
        );
    }
}

```

`app/Domains/Vehicle/Controller/Service/UpdateAlarmNotification.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\AlarmNotification\Model\AlarmNotification as AlarmNotificationModel;
use App\Domains\AlarmNotification\Model\Collection\AlarmNotification as AlarmNotificationCollection;
use App\Domains\Vehicle\Model\Vehicle as Model;

class UpdateAlarmNotification extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Vehicle\Model\Vehicle $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'notifications' => $this->notifications(),
        ];
    }

    /**
     * @return \App\Domains\AlarmNotification\Model\Collection\AlarmNotification
     */
    protected function notifications(): AlarmNotificationCollection
    {
        return $this->cache(
            fn () => AlarmNotificationModel::query()
                ->byVehicleId($this->row->id)
                ->withAlarm()
                ->withPosition()
                ->withTrip()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Vehicle/Controller/Service/UpdateDevice.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Device\Model\Collection\Device as DeviceCollection;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Vehicle\Model\Vehicle as Model;

class UpdateDevice extends ControllerAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Vehicle\Model\Vehicle $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return [
            'row' => $this->row,
            'devices' => $this->devices(),
        ];
    }

    /**
     * @return \App\Domains\Device\Model\Collection\Device
     */
    protected function devices(): DeviceCollection
    {
        return $this->cache(
            fn () => DeviceModel::query()
                ->byUserId($this->user()->id)
                ->withVehicle()
                ->list()
                ->get()
        );
    }
}

```

`app/Domains/Vehicle/Controller/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Vehicle\Controller\Service\Update as ControllerService;

class Update extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actions()) {
            return $response;
        }

        $this->meta('title', __('vehicle-update.meta-title', ['title' => $this->row->name]));

        return $this->page('vehicle.update', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse|false|null
     */
    protected function actions(): RedirectResponse|false|null
    {
        return $this->actionPost('update')
            ?: $this->actionPost('delete');
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function update(): RedirectResponse
    {
        $this->action()->update();

        $this->sessionMessage('success', __('vehicle-update.success'));

        return redirect()->route('vehicle.update', $this->row->id);
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function delete(): RedirectResponse
    {
        $this->action()->delete();

        $this->sessionMessage('success', __('vehicle-update.delete-success'));

        return redirect()->route('vehicle.index');
    }
}

```

`app/Domains/Vehicle/Controller/UpdateAlarm.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Vehicle\Controller\Service\UpdateAlarm as ControllerService;

class UpdateAlarm extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('updateAlarm')) {
            return $response;
        }

        $this->meta('title', __('vehicle-update-alarm.meta-title', ['title' => $this->row->name]));

        return $this->page('vehicle.update-alarm', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateAlarm(): RedirectResponse
    {
        $this->action()->updateAlarm();

        $this->sessionMessage('success', __('vehicle-update-alarm.success'));

        return redirect()->route('vehicle.update.alarm', $this->row->id);
    }
}

```

`app/Domains/Vehicle/Controller/UpdateAlarmNotification.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller;

use Illuminate\Http\Response;
use App\Domains\Vehicle\Controller\Service\UpdateAlarmNotification as ControllerService;

class UpdateAlarmNotification extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response
     */
    public function __invoke(int $id): Response
    {
        $this->row($id);

        $this->meta('title', __('vehicle-update-alarm-notification.meta-title', ['title' => $this->row->name]));

        return $this->page('vehicle.update-alarm-notification', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }
}

```

`app/Domains/Vehicle/Controller/UpdateDevice.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller;

use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Response;
use App\Domains\Vehicle\Controller\Service\UpdateDevice as ControllerService;

class UpdateDevice extends ControllerAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\RedirectResponse
     */
    public function __invoke(int $id): Response|RedirectResponse
    {
        $this->row($id);

        if ($response = $this->actionPost('updateDevice')) {
            return $response;
        }

        $this->meta('title', __('vehicle-update-device.meta-title', ['title' => $this->row->name]));

        return $this->page('vehicle.update-device', $this->data());
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }

    /**
     * @return \Illuminate\Http\RedirectResponse
     */
    protected function updateDevice(): RedirectResponse
    {
        $this->action()->updateDevice();

        $this->sessionMessage('success', __('vehicle-update-device.success'));

        return redirect()->route('vehicle.update.device', $this->row->id);
    }
}

```

`app/Domains/Vehicle/Controller/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Controller;

use Illuminate\Support\Facades\Route;

Route::group(['middleware' => ['user-auth']], static function () {
    Route::get('/vehicle', Index::class)->name('vehicle.index');
    Route::any('/vehicle/create', Create::class)->name('vehicle.create');
    Route::any('/vehicle/map', Map::class)->name('vehicle.map');
    Route::any('/vehicle/{id}', Update::class)->name('vehicle.update');
    Route::any('/vehicle/{id}/alarm', UpdateAlarm::class)->name('vehicle.update.alarm');
    Route::any('/vehicle/{id}/alarm-notification', UpdateAlarmNotification::class)->name('vehicle.update.alarm-notification');
    Route::any('/vehicle/{id}/device', UpdateDevice::class)->name('vehicle.update.device');
});

```

`app/Domains/Vehicle/ControllerApi/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\ControllerApi;

use App\Domains\CoreApp\Controller\ControllerApiAbstract as CoreControllerApiAbstract;
use App\Domains\Vehicle\Model\Vehicle as Model;

abstract class ControllerApiAbstract extends CoreControllerApiAbstract
{
    /**
     * @var ?\App\Domains\Vehicle\Model\Vehicle
     */
    protected ?Model $row;

    /**
     * @param int $id
     *
     * @return \App\Domains\Vehicle\Model\Vehicle
     */
    protected function row(int $id): Model
    {
        return $this->row = Model::query()
            ->byId($id)
            ->byUserOrManager($this->auth)
            ->firstOr(fn () => $this->exceptionNotFound(__('vehicle.error.not-found')));
    }
}

```

`app/Domains/Vehicle/ControllerApi/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Vehicle\Model\Vehicle as Model;
use App\Domains\Vehicle\ControllerApi\Service\Create as ControllerService;

class Create extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('json', $this->execute()));
    }

    /**
     * @return \App\Domains\Vehicle\Model\Vehicle
     */
    protected function execute(): Model
    {
        return $this->action(data: $this->data())->create();
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Vehicle/ControllerApi/Delete.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\ControllerApi;

class Delete extends ControllerApiAbstract
{
    /**
     * @param int $id
     *
     * @return void
     */
    public function __invoke(int $id): void
    {
        $this->row($id);
        $this->action()->delete();
    }
}

```

`app/Domains/Vehicle/ControllerApi/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Vehicle\ControllerApi\Service\Index as ControllerService;

class Index extends ControllerApiAbstract
{
    /**
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(): JsonResponse
    {
        return $this->json($this->factory()->fractal('json', $this->data()));
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth)->data();
    }
}

```

`app/Domains/Vehicle/ControllerApi/Service/ControllerApiAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\ControllerApi\Service;

use App\Domains\CoreApp\ControllerApi\Service\ControllerApiAbstract as CoreAppControllerApiAbstract;

abstract class ControllerApiAbstract extends CoreAppControllerApiAbstract
{
}

```

`app/Domains/Vehicle/ControllerApi/Service/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;

class Create extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataCustom() + $this->dataDefault();
    }

    /**
     * @return array
     */
    protected function dataCustom(): array
    {
        return ['timezone_id' => $this->dataCustomTimezoneId()];
    }

    /**
     * @return int
     */
    protected function dataCustomTimezoneId(): int
    {
        return $this->requestInteger('timezone_id', $this->auth->timezone_id);
    }

    /**
     * @return array
     */
    protected function dataDefault(): array
    {
        return $this->request->input();
    }
}

```

`app/Domains/Vehicle/ControllerApi/Service/Index.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Vehicle\Model\Vehicle as Model;

class Index extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return Model::query()
            ->byUserOrManager($this->auth)
            ->whenUserId($this->requestInteger('user_id'))
            ->withSimple('devices')
            ->withSimple('user')
            ->withSimple('timezone')
            ->list()
            ->get()
            ->all();
    }
}

```

`app/Domains/Vehicle/ControllerApi/Service/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\ControllerApi\Service;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Http\Request;
use App\Domains\Vehicle\Model\Vehicle as Model;

class Update extends ControllerApiAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Illuminate\Contracts\Auth\Authenticatable $auth
     * @param \App\Domains\Vehicle\Model\Vehicle $row
     *
     * @return self
     */
    public function __construct(protected Request $request, protected Authenticatable $auth, protected Model $row)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->dataDefault()
            + $this->dataRow();
    }

    /**
     * @return array
     */
    protected function dataDefault(): array
    {
        return $this->request->input();
    }

    /**
     * @return array
     */
    protected function dataRow(): array
    {
        return $this->row->toArray();
    }
}

```

`app/Domains/Vehicle/ControllerApi/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\ControllerApi;

use Illuminate\Http\JsonResponse;
use App\Domains\Vehicle\Model\Vehicle as Model;
use App\Domains\Vehicle\ControllerApi\Service\Update as ControllerService;

class Update extends ControllerApiAbstract
{
    /**
     * @param int $id
     *
     * @return \Illuminate\Http\JsonResponse
     */
    public function __invoke(int $id): JsonResponse
    {
        $this->row($id);

        return $this->json($this->factory()->fractal('json', $this->execute()));
    }

    /**
     * @return \App\Domains\Vehicle\Model\Vehicle
     */
    protected function execute(): Model
    {
        return $this->action(data: $this->data())->update();
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ControllerService::new($this->request, $this->auth, $this->row)->data();
    }
}

```

`app/Domains/Vehicle/ControllerApi/router.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\ControllerApi;

use Illuminate\Support\Facades\Route;

Route::get('/vehicle', Index::class)->name('vehicle.index');
Route::post('/vehicle/create', Create::class)->name('vehicle.create');
Route::patch('/vehicle/{id}', Update::class)->name('vehicle.update');
Route::delete('/vehicle/{id}', Delete::class)->name('vehicle.delete');

```

`app/Domains/Vehicle/Fractal/FractalFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Fractal;

use App\Domains\Core\Fractal\FractalAbstract;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Vehicle\Model\Vehicle as Model;

class FractalFactory extends FractalAbstract
{
    /**
     * @param \App\Domains\Vehicle\Model\Vehicle $row
     *
     * @return array
     */
    protected function json(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
            'plate' => $row->plate,
            'timezone_auto' => $row->timezone_auto,
            'enabled' => $row->enabled,
            'devices' => $this->from('Device', 'related', $row->devices),
            'timezone' => $this->from('Timezone', 'related', $row->timezone),
            'user' => $this->from('User', 'related', $row->user),
        ];
    }

    /**
     * @param \App\Domains\Vehicle\Model\Vehicle $row
     *
     * @return array
     */
    protected function map(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
            'plate' => $row->plate,
            'position' => $this->mapPosition($row->positionLast),
        ];
    }

    /**
     * @param ?\App\Domains\Position\Model\Position $position
     *
     * @return ?array
     */
    protected function mapPosition(?PositionModel $position): ?array
    {
        if ($position === null) {
            return null;
        }

        return [
            'id' => $position->id,
            'date_at' => $position->date_at,
            'date_utc_at' => $position->date_utc_at,
            'latitude' => $position->latitude,
            'longitude' => $position->longitude,
            'direction' => $position->direction,
            'speed' => helper()->unit('speed', $position->speed),
            'speed_human' => helper()->unitHuman('speed', $position->speed),
            'city' => $position->city?->name,
            'state' => $position->city?->state->name,
        ];
    }

    /**
     * @param \App\Domains\Vehicle\Model\Vehicle $row
     *
     * @return array
     */
    protected function related(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
            'plate' => $row->plate,
        ];
    }

    /**
     * @param \App\Domains\Vehicle\Model\Vehicle $row
     *
     * @return array
     */
    protected function simple(Model $row): array
    {
        return [
            'id' => $row->id,
            'name' => $row->name,
            'plate' => $row->plate,
        ];
    }
}

```

`app/Domains/Vehicle/Middleware/Available.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Middleware;

use Closure;
use Illuminate\Http\Request;
use App\Domains\Vehicle\Model\Vehicle as Model;

class Available extends MiddlewareAbstract
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        if ($this->exists($request) === false) {
            return redirect()->route('vehicle.create');
        }

        return $next($request);
    }

    /**
     * @param \Illuminate\Http\Request $request
     *
     * @return bool
     */
    protected function exists(Request $request): bool
    {
        return Model::query()
            ->byUserId($request->user()->id)
            ->exists();
    }
}

```

`app/Domains/Vehicle/Middleware/MiddlewareAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Middleware;

use App\Domains\Core\Middleware\MiddlewareAbstract as MiddlewareAbstractCore;

abstract class MiddlewareAbstract extends MiddlewareAbstractCore
{
}

```

`app/Domains/Vehicle/Model/Builder/Vehicle.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Model\Builder;

use App\Domains\CoreApp\Model\Builder\BuilderAbstract;
use App\Domains\Trip\Model\Trip as TripModel;

class Vehicle extends BuilderAbstract
{
    /**
     * @return self
     */
    public function listSimple(): self
    {
        return $this->select('id', 'name')->orderBy('name', 'ASC');
    }

    /**
     * @return self
     */
    public function selectRelated(): self
    {
        return $this->select('id', 'name', 'plate', 'user_id');
    }

    /**
     * @return self
     */
    public function selectSimple(): self
    {
        return $this->select('id', 'name', 'plate', 'enabled', 'timezone_id', 'user_id');
    }

    /**
     * @param ?bool $finished
     *
     * @return self
     */
    public function whenTripFinished(?bool $finished): self
    {
        return $this->when(is_bool($finished), fn ($q) => $q->whereTripFinished($finished));
    }

    /**
     * @param bool $finished = true
     *
     * @return self
     */
    public function whereTripFinished(bool $finished = true): self
    {
        return $this->whereIn('id', TripModel::query()->select('vehicle_id')->whereFinished($finished));
    }

    /**
     * @param int $alarm_id
     *
     * @return self
     */
    public function withAlarmPivot(int $alarm_id): self
    {
        return $this->with(['alarmPivot' => fn ($q) => $q->byAlarmId($alarm_id)]);
    }

    /**
     * @return self
     */
    public function withAlarmsCount(): self
    {
        return $this->withCount('alarms');
    }

    /**
     * @return self
     */
    public function withAlarmsNotificationsCount(): self
    {
        return $this->withCount('alarmsNotifications as alarms_notifications_count');
    }

    /**
     * @return self
     */
    public function withAlarmsNotificationsPendingCount(): self
    {
        return $this->withCount([
            'alarmsNotifications as alarms_notifications_pending_count' => fn ($q) => $q->whereClosedAt(false),
        ]);
    }

    /**
     * @return self
     */
    public function withDevices(): self
    {
        return $this->with('devices');
    }

    /**
     * @return self
     */
    public function withDevicesCount(): self
    {
        return $this->withCount('devices');
    }

    /**
     * @return self
     */
    public function withTimezone(): self
    {
        return $this->with('timezone');
    }

    /**
     * @return self
     */
    public function withWhereHasPositionLast(): self
    {
        return $this->withWhereHas('positionLast', fn ($q) => $q->withCityState());
    }
}

```

`app/Domains/Vehicle/Model/Collection/Vehicle.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Model\Collection;

use App\Domains\CoreApp\Model\Collection\CollectionAbstract;

class Vehicle extends CollectionAbstract
{
}

```

`app/Domains/Vehicle/Model/Vehicle.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Model;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\HasOne;
use App\Domains\Alarm\Model\Alarm as AlarmModel;
use App\Domains\Alarm\Model\AlarmVehicle as AlarmVehicleModel;
use App\Domains\AlarmNotification\Model\AlarmNotification as AlarmNotificationModel;
use App\Domains\CoreApp\Model\ModelAbstract;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Timezone\Model\Timezone as TimezoneModel;
use App\Domains\Trip\Model\Trip as TripModel;
use App\Domains\User\Model\User as UserModel;
use App\Domains\Vehicle\Model\Builder\Vehicle as Builder;
use App\Domains\Vehicle\Model\Collection\Vehicle as Collection;
use App\Domains\Vehicle\Test\Factory\Vehicle as TestFactory;

class Vehicle extends ModelAbstract
{
    use HasFactory;

    /**
     * @var string
     */
    protected $table = 'vehicle';

    /**
     * @const string
     */
    public const TABLE = 'vehicle';

    /**
     * @const string
     */
    public const FOREIGN = 'vehicle_id';

    /**
     * @var array<string, string>
     */
    protected $casts = [
        'config' => 'array',
        'timezone_auto' => 'boolean',
        'enabled' => 'boolean',
    ];

    /**
     * @param array $models
     *
     * @return \App\Domains\Vehicle\Model\Collection\Vehicle
     */
    public function newCollection(array $models = []): Collection
    {
        return new Collection($models);
    }

    /**
     * @param \Illuminate\Database\Query\Builder $query
     *
     * @return \App\Domains\Vehicle\Model\Builder\Vehicle
     */
    public function newEloquentBuilder($query): Builder
    {
        return new Builder($query);
    }

    /**
     * @return \App\Domains\Vehicle\Test\Factory\Vehicle
     */
    protected static function newFactory(): TestFactory
    {
        return TestFactory::new();
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasOne
     */
    public function alarmPivot(): HasOne
    {
        return $this->hasOne(AlarmVehicleModel::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsToMany
     */
    public function alarms(): BelongsToMany
    {
        return $this->belongsToMany(AlarmModel::class, AlarmVehicleModel::TABLE);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function alarmsNotifications(): HasMany
    {
        return $this->hasMany(AlarmNotificationModel::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function devices(): HasMany
    {
        return $this->hasMany(DeviceModel::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasOne
     */
    public function positionLast(): HasOne
    {
        return $this->hasOne(PositionModel::class, static::FOREIGN)
            ->ofMany(['date_utc_at' => 'MAX']);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function timezone(): BelongsTo
    {
        return $this->belongsTo(TimezoneModel::class, TimezoneModel::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\HasMany
     */
    public function trips(): HasMany
    {
        return $this->hasMany(TripModel::class, static::FOREIGN);
    }

    /**
     * @return \Illuminate\Database\Eloquent\Relations\BelongsTo
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(UserModel::class, UserModel::FOREIGN);
    }

    /**
     * @param string $key
     *
     * @return int
     */
    public function config(string $key): int
    {
        return intval($this->config[$key] ?? 0) ?: app('configuration')->int($key);
    }
}

```

`app/Domains/Vehicle/Validate/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class Create extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'name' => ['bail', 'required'],
            'plate' => ['bail'],
            'timezone_auto' => ['bail', 'boolean'],
            'enabled' => ['bail', 'boolean'],
            'timezone_id' => ['bail', 'required', 'integer'],
            'user_id' => ['bail', 'integer'],
            'config' => ['bail', 'array', 'required'],
            'config.trip_wait_minutes' => ['bail', 'integer', 'min:0'],
        ];
    }
}

```

`app/Domains/Vehicle/Validate/Update.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Validate;

class Update extends Create
{
}

```

`app/Domains/Vehicle/Validate/UpdateAlarm.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdateAlarm extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'related' => ['bail', 'array'],
            'related.*' => ['bail', 'integer'],
        ];
    }
}

```

`app/Domains/Vehicle/Validate/UpdateDevice.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Validate;

use App\Domains\Core\Validate\ValidateAbstract;

class UpdateDevice extends ValidateAbstract
{
    /**
     * @return array
     */
    public function rules(): array
    {
        return [
            'related' => ['bail', 'array'],
            'related.*' => ['bail', 'integer'],
        ];
    }
}

```

`app/Domains/Vehicle/Validate/ValidateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Domains\Vehicle\Validate;

use App\Domains\Core\Validate\ValidateFactoryAbstract;

class ValidateFactory extends ValidateFactoryAbstract
{
}

```

`app/Exceptions/AuthenticationException.php:`

```php
<?php declare(strict_types=1);

namespace App\Exceptions;

use Illuminate\Auth\AuthenticationException as AuthenticationExceptionVendor;

class AuthenticationException extends AuthenticationExceptionVendor
{
    /**
     * @var int
     */
    protected $code = 401;
}

```

`app/Exceptions/GenericException.php:`

```php
<?php declare(strict_types=1);

namespace App\Exceptions;

use Exception;
use Throwable;

class GenericException extends Exception
{
    /**
     * @var ?string
     */
    protected ?string $status;

    /**
     * @var ?array
     */
    protected ?array $details;

    /**
     * @param string $message = null
     * @param int $code = 0
     * @param ?\Throwable $previous = null
     * @param ?string $status = null
     * @param ?array $details = null
     *
     * @return self
     */
    public function __construct(
        string $message = '',
        int $code = 0,
        ?Throwable $previous = null,
        ?string $status = null,
        ?array $details = null
    ) {
        parent::__construct($message, $code ?: $this->code ?? 0, $previous);

        $this->setStatus($status);
        $this->setDetails($details);
    }

    /**
     * @param ?string $status
     *
     * @return void
     */
    final public function setStatus(?string $status): void
    {
        $this->status = $status;
    }

    /**
     * @return ?string
     */
    final public function getStatus(): ?string
    {
        return $this->status;
    }

    /**
     * @param int $code
     *
     * @return void
     */
    final public function setStatusCode(int $code): void
    {
        $this->code = $code;
    }

    /**
     * @return int
     */
    final public function getStatusCode(): int
    {
        return $this->code;
    }

    /**
     * @param ?array $details
     *
     * @return void
     */
    final public function setDetails(?array $details): void
    {
        $this->details = $details;
    }

    /**
     * @return ?array
     */
    final public function getDetails(): ?array
    {
        return $this->details;
    }
}

```

`app/Exceptions/Handler.php:`

```php
<?php declare(strict_types=1);

namespace App\Exceptions;

use Sentry;
use Throwable;
use Illuminate\Foundation\Exceptions\Handler as HandlerVendor;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Response as HttpResponse;
use App\Domains\Error\Controller\Index as ErrorController;

class Handler extends HandlerVendor
{
    /**
     * @var array<int, class-string<\Throwable>>
     */
    protected $dontReport = [
        AuthenticationException::class,
        ValidatorException::class,
    ];

    /**
     * @return void
     */
    public function register(): void
    {
        $this->reportable(static function (Throwable $e) {
            Sentry\captureException($e);
        });
    }

    /**
     * @return array
     */
    protected function context(): array
    {
        return parent::context() + [
            'url' => request()->fullUrl(),
            'method' => request()->getMethod(),
        ];
    }

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Throwable $e
     *
     * @return \Illuminate\Http\Response|\Illuminate\Http\JsonResponse
     */
    public function render($request, Throwable $e): HttpResponse|JsonResponse
    {
        $e = Response::new($e)->exception();

        if ($request->ajax() || $request->wantsJson()) {
            return $this->renderJson($e);
        }

        if (config('app.debug')) {
            return parent::render($request, $e->getPrevious() ?: $e);
        }

        return app(ErrorController::class)($e);
    }

    /**
     * @param \Throwable $e
     *
     * @return \Illuminate\Http\JsonResponse
     */
    protected function renderJson(Throwable $e): JsonResponse
    {
        return response()->json($this->renderJsonData($e), $e->getCode());
    }

    /**
     * @param \Throwable $e
     *
     * @return array
     */
    protected function renderJsonData(Throwable $e): array
    {
        return [
            'code' => $e->getCode(),
            'status' => $e->getStatus(),
            'message' => $e->getMessage(),
            'details' => $e->getDetails(),
        ];
    }
}

```

`app/Exceptions/NotAllowedException.php:`

```php
<?php declare(strict_types=1);

namespace App\Exceptions;

class NotAllowedException extends GenericException
{
    /**
     * @var int
     */
    protected $code = 403;
}

```

`app/Exceptions/NotFoundException.php:`

```php
<?php declare(strict_types=1);

namespace App\Exceptions;

class NotFoundException extends GenericException
{
    /**
     * @var int
     */
    protected $code = 404;
}

```

`app/Exceptions/Response.php:`

```php
<?php declare(strict_types=1);

namespace App\Exceptions;

use Throwable;
use Illuminate\Auth\AuthenticationException as AuthenticationExceptionVendor;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Database\QueryException;
use Symfony\Component\HttpKernel\Exception\MethodNotAllowedHttpException;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;

class Response
{
    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param \Throwable $e
     *
     * @return self
     */
    public function __construct(protected Throwable $e)
    {
    }

    /**
     * @return \App\Exceptions\GenericException
     */
    public function exception(): GenericException
    {
        $class = $this->class();

        return new $class($this->message(), $this->code(), $this->previous(), $this->status(), $this->details());
    }

    /**
     * @return string
     */
    protected function class(): string
    {
        if ($this->e instanceof GenericException) {
            return $this->e::class;
        }

        return GenericException::class;
    }

    /**
     * @return string
     */
    protected function message(): string
    {
        $message = $this->e->getMessage();

        if (config('app.debug')) {
            return $message;
        }

        if ($this->e instanceof AuthenticationException) {
            return $message ?: __('user-auth.error.auth');
        }

        if ($this->e instanceof AuthenticationExceptionVendor) {
            return __('user-auth.error.empty');
        }

        if ($this->e instanceof NotFoundHttpException) {
            return $message ?: __('common.error.not-found');
        }

        if ($this->e instanceof ModelNotFoundException) {
            return $message ?: __('common.error.not-found-model');
        }

        if ($this->e instanceof MethodNotAllowedHttpException) {
            return __('common.error.method-not-allowed');
        }

        if ($this->e instanceof QueryException) {
            return __('common.error.query');
        }

        if ($this->isExceptionSystem()) {
            return __('common.error.system');
        }

        return $message;
    }

    /**
     * @return int
     */
    protected function code(): int
    {
        if ($this->isExceptionNotFound()) {
            return 404;
        }

        if ($this->isExceptionAuth()) {
            return 401;
        }

        if (method_exists($this->e, 'getStatusCode')) {
            $code = (int)$this->e->getStatusCode();
        } else {
            $code = (int)$this->e->getCode();
        }

        return (($code >= 400) && ($code < 600)) ? $code : 500;
    }

    /**
     * @return \Throwable
     */
    protected function previous(): Throwable
    {
        return $this->e;
    }

    /**
     * @return string
     */
    protected function status(): string
    {
        if (method_exists($this->e, 'getStatus') && ($status = $this->e->getStatus())) {
            return $status;
        }

        if ($this->e instanceof AuthenticationException) {
            return 'user_error';
        }

        if ($this->e instanceof AuthenticationExceptionVendor) {
            return 'user_auth';
        }

        if ($this->e instanceof NotFoundHttpException) {
            return 'not_found';
        }

        if ($this->e instanceof ModelNotFoundException) {
            return 'not_available';
        }

        if ($this->e instanceof MethodNotAllowedHttpException) {
            return 'method_not_allowed';
        }

        if ($this->e instanceof NotAllowedException) {
            return 'not_allowed';
        }

        if ($this->e instanceof ValidatorException) {
            return 'validator_error';
        }

        if ($this->e instanceof QueryException) {
            return 'query_error';
        }

        if ($this->isExceptionSystem()) {
            return 'system_error';
        }

        return 'error';
    }

    /**
     * @return ?array
     */
    protected function details(): ?array
    {
        if (method_exists($this->e, 'getDetails')) {
            return $this->e->getDetails();
        }

        return null;
    }

    /**
     * @return bool
     */
    protected function isExceptionNotFound(): bool
    {
        return ($this->e instanceof ModelNotFoundException)
            || ($this->e instanceof NotFoundHttpException);
    }

    /**
     * @return bool
     */
    protected function isExceptionAuth(): bool
    {
        return $this->e instanceof AuthenticationExceptionVendor;
    }

    /**
     * @return bool
     */
    protected function isExceptionSystem(): bool
    {
        return helper()->isExceptionSystem($this->e);
    }
}

```

`app/Exceptions/UnexpectedValueException.php:`

```php
<?php declare(strict_types=1);

namespace App\Exceptions;

class UnexpectedValueException extends GenericException
{
    /**
     * @var int
     */
    protected $code = 412;
}

```

`app/Exceptions/ValidatorException.php:`

```php
<?php declare(strict_types=1);

namespace App\Exceptions;

class ValidatorException extends GenericException
{
    /**
     * @var int
     */
    protected $code = 422;
}

```

`app/Http/Kernel.php:`

```php
<?php declare(strict_types=1);

namespace App\Http;

use Illuminate\Foundation\Http\Kernel as KernelVendor;
use App\Domains\IpLock\Middleware\Check as IpLockCheck;
use App\Domains\Language\Middleware\Request as LanguageRequest;
use App\Domains\User\Middleware\Admin as UserAdmin;
use App\Domains\User\Middleware\AdminMode as UserAdminMode;
use App\Domains\User\Middleware\AuthApi as UserAuthApi;
use App\Domains\User\Middleware\AuthRedirect as UserAuthRedirect;
use App\Domains\User\Middleware\Enabled as UserEnabled;
use App\Domains\User\Middleware\ManagerMode as UserManagerMode;
use App\Domains\User\Middleware\Request as UserRequest;
use App\Domains\Vehicle\Middleware\Available as VehicleAvailable;
use App\Http\Middleware\Https;
use App\Http\Middleware\MessagesShareFromSession;
use App\Http\Middleware\RequestLogger;
use App\Http\Middleware\Reset;
use App\Http\Middleware\TrustProxies;

class Kernel extends KernelVendor
{
    /**
     * @var array<int, string>
     */
    protected $middleware = [
        TrustProxies::class,
        Https::class,
        \Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class,
        \Illuminate\Cookie\Middleware\EncryptCookies::class,
        \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
        \Illuminate\Session\Middleware\StartSession::class,
        \Illuminate\Foundation\Http\Middleware\TrimStrings::class,
        RequestLogger::class,
        Reset::class,
        MessagesShareFromSession::class,
        LanguageRequest::class,
    ];

    /**
     * @var array<string, array<int, string>>
     */
    protected $middlewareGroups = [
        'user-auth' => [
            IpLockCheck::class,
            UserRequest::class,
            UserEnabled::class,
        ],

        'user-auth-api' => [
            UserAuthApi::class,
        ],

        'user-auth-admin' => [
            IpLockCheck::class,
            UserRequest::class,
            UserEnabled::class,
            UserAdmin::class,
        ],

        'user-auth-admin-mode' => [
            IpLockCheck::class,
            UserRequest::class,
            UserEnabled::class,
            UserAdminMode::class,
        ],

        'user-auth-manager-mode' => [
            IpLockCheck::class,
            UserRequest::class,
            UserEnabled::class,
            UserManagerMode::class,
        ],
    ];

    /**
     * @var array<string, string>
     */
    protected $middlewareAliases = [
        'vehicle.available' => VehicleAvailable::class,
        'user.admin' => UserAdmin::class,
        'user.admin-mode' => UserAdminMode::class,
        'user.auth.api' => UserAuthApi::class,
        'user.auth.redirect' => UserAuthRedirect::class,
        'user.enabled' => UserEnabled::class,
        'user.manager-mode' => UserManagerMode::class,
        'user.request' => UserRequest::class,
    ];
}

```

`app/Http/Middleware/Https.php:`

```php
<?php declare(strict_types=1);

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\URL;

class Https
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        if (str_starts_with(config('app.url'), 'https')) {
            URL::forceScheme('https');
        }

        return $next($request);
    }
}

```

`app/Http/Middleware/MessagesShareFromSession.php:`

```php
<?php declare(strict_types=1);

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;

class MessagesShareFromSession
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next)
    {
        $message = service()->message()->instance();

        $message->request($request);
        $message->session($request->session());

        return $next($request);
    }
}

```

`app/Http/Middleware/RequestLogger.php:`

```php
<?php declare(strict_types=1);

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;
use App\Services\Request\Logger;

class RequestLogger
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        return $next($request);
    }

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Symfony\Component\HttpFoundation\Response $response
     *
     * @return void
     */
    public function terminate(Request $request, Response $response): void
    {
        Logger::fromRequestAndResponse($request, $response);
    }
}

```

`app/Http/Middleware/Reset.php:`

```php
<?php declare(strict_types=1);

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use App\Services\Request\Response;

class Reset
{
    /**
     * @param \Illuminate\Http\Request $request
     * @param \Closure $next
     *
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        $this->response();
        $this->message();

        return $next($request);
    }

    /**
     * @return void
     */
    protected function response(): void
    {
        Response::status(200);
    }

    /**
     * @return void
     */
    protected function message(): void
    {
        service()->message()->reset();
    }
}

```

`app/Http/Middleware/TrustProxies.php:`

```php
<?php declare(strict_types=1);

namespace App\Http\Middleware;

use Illuminate\Http\Middleware\TrustProxies as Middleware;
use Illuminate\Http\Request;

class TrustProxies extends Middleware
{
    /**
     * @var array<int, string>|string|null
     */
    protected $proxies = '*';

    /**
     * The headers that should be used to detect proxies.
     *
     * @var int
     */
    protected $headers = Request::HEADER_X_FORWARDED_FOR | Request::HEADER_X_FORWARDED_HOST | Request::HEADER_X_FORWARDED_PORT | Request::HEADER_X_FORWARDED_PROTO;
}

```

`app/Providers/App.php:`

```php
<?php declare(strict_types=1);

namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use App\Domains\Core\Traits\Factory;

class App extends ServiceProvider
{
    use Factory;

    /**
     * @return void
     */
    public function boot(): void
    {
        $this->configuration();
        $this->language();
    }

    /**
     * @return void
     */
    protected function configuration(): void
    {
        $this->factory('Configuration')->action()->appBind();
    }

    /**
     * @return void
     */
    protected function language(): void
    {
        $this->factory('Language')->action()->set();
    }
}

```

`app/Providers/Debug.php:`

```php
<?php declare(strict_types=1);

namespace App\Providers;

use Illuminate\Queue\Events\JobFailed;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Queue;
use Illuminate\Support\ServiceProvider;
use Symfony\Component\VarDumper\Cloner\VarCloner;
use Symfony\Component\VarDumper\Dumper\CliDumper;
use Symfony\Component\VarDumper\Dumper\HtmlDumper;
use Symfony\Component\VarDumper\VarDumper;
use App\Services\Database\Logger as LoggerDatabase;

class Debug extends ServiceProvider
{
    /**
     * @return void
     */
    public function boot(): void
    {
        $this->queue();
        $this->logging();
        $this->dumper();
    }

    /**
     * @return void
     */
    protected function queue(): void
    {
        Queue::failing(static function (JobFailed $event) {
            report($event->exception);
        });
    }

    /**
     * @return void
     */
    protected function logging(): void
    {
        $this->loggingDatabase();
        $this->disableQueryLog();
    }

    /**
     * @return void
     */
    protected function loggingDatabase(): void
    {
        LoggerDatabase::new()->listen();
    }

    /**
     * @return void
     */
    protected function disableQueryLog(): void
    {
        if ($this->app->isProduction()) {
            DB::connection()->disableQueryLog();
        }
    }

    /**
     * @return void
     */
    protected function dumper(): void
    {
        VarDumper::setHandler(static function ($var) {
            $cloner = new VarCloner();
            $cloner->setMaxItems(-1);

            $dumper = (PHP_SAPI === 'cli') ? new CliDumper() : new HtmlDumper();
            $dumper->dump($cloner->cloneVar($var));
        });
    }
}

```

`app/Providers/Route.php:`

```php
<?php declare(strict_types=1);

namespace App\Providers;

use Illuminate\Foundation\Support\Providers\RouteServiceProvider;
use Illuminate\Support\Facades\Route as RouteFacade;

class Route extends RouteServiceProvider
{
    /**
     * @return void
     */
    public function boot(): void
    {
        $this->patterns();

        parent::boot();
    }

    /**
     * @return void
     */
    protected function patterns(): void
    {
        RouteFacade::pattern('id', '[0-9]+');
        RouteFacade::pattern('uuid', '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}');
    }

    /**
     * @return void
     */
    public function map(): void
    {
        $this->mapWeb();
        $this->mapApi();
    }

    /**
     * @return void
     */
    protected function mapWeb(): void
    {
        $this->mapLoadRouter('Controller');
    }

    /**
     * @return void
     */
    protected function mapApi(): void
    {
        Route::middleware('user-auth-api')
            ->name('api.')
            ->prefix('api')
            ->group(fn () => $this->mapLoadRouter('ControllerApi'));
    }

    /**
     * @param string $path
     *
     * @return void
     */
    protected function mapLoadRouter(string $path): void
    {
        foreach (glob(app_path('Domains/*/'.$path.'/router.php')) as $file) {
            require $file;
        }
    }
}

```

`app/Providers/View.php:`

```php
<?php declare(strict_types=1);

namespace App\Providers;

use Illuminate\Pagination\Paginator;
use Illuminate\Support\Facades\Blade;
use Illuminate\Support\ServiceProvider;

class View extends ServiceProvider
{
    /**
     * @return void
     */
    public function boot(): void
    {
        $this->blade();
        $this->pagination();
    }

    /**
     * @return void
     */
    protected function blade(): void
    {
        Blade::directive('arrayAsBadges', function (string $expression) {
            return "<?= \App\Services\Html\Html::arrayAsBadges($expression); ?>";
        });

        Blade::directive('arrayAsText', function (string $expression) {
            return "<?= \App\Services\Html\Html::arrayAsText($expression); ?>";
        });

        Blade::directive('asset', function (string $expression) {
            return "<?= \App\Services\Html\Html::asset($expression); ?>";
        });

        Blade::directive('cut', function (string $expression) {
            return "<?= \App\Services\Html\Html::cut($expression); ?>";
        });

        Blade::directive('dateLocal', function (string $expression) {
            return "<?= helper()->dateLocal($expression); ?>";
        });

        Blade::directive('dateWithTimezone', function (string $expression) {
            return "<?= \App\Services\Html\Html::dateWithTimezone($expression); ?>";
        });

        Blade::directive('dateWithUserTimezone', function (string $expression) {
            return "<?= \App\Services\Html\Html::dateWithUserTimezone($expression); ?>";
        });

        Blade::directive('distanceHuman', function (string $expression) {
            return "<?= helper()->distanceHuman($expression); ?>";
        });

        Blade::directive('icon', function (string $expression) {
            return "<?= \App\Services\Html\Html::icon($expression); ?>";
        });

        Blade::directive('image', function (string $expression) {
            return "<?= \App\Services\Html\Html::image($expression); ?>";
        });

        Blade::directive('inline', function (string $expression) {
            return "<?= \App\Services\Html\Html::inline($expression); ?>";
        });

        Blade::directive('money', function (string $expression) {
            return "<?= helper()->money($expression); ?>";
        });

        Blade::directive('number', function (string $expression) {
            return "<?= helper()->number($expression); ?>";
        });

        Blade::directive('progressbar', function (string $expression) {
            return "<?= \App\Services\Html\Html::progressbar($expression); ?>";
        });

        Blade::directive('query', function (string $expression) {
            return "<?= helper()->query($expression); ?>";
        });

        Blade::directive('sizeHuman', function (string $expression) {
            return "<?= helper()->sizeHuman($expression); ?>";
        });

        Blade::directive('status', function (string $expression) {
            return "<?= \App\Services\Html\Html::status($expression); ?>";
        });

        Blade::directive('svg', function (string $expression) {
            return "<?= \App\Services\Html\Html::svg($expression); ?>";
        });

        Blade::directive('timeHuman', function (string $expression) {
            return "<?= helper()->timeHuman($expression); ?>";
        });

        Blade::directive('unit', function (string $expression) {
            return "<?= helper()->unit($expression); ?>";
        });

        Blade::directive('unitHuman', function (string $expression) {
            return "<?= helper()->unitHuman($expression); ?>";
        });

        Blade::directive('unitHumanRaw', function (string $expression) {
            return "<?= helper()->unitHumanRaw($expression); ?>";
        });
    }

    /**
     * @return void
     */
    protected function pagination(): void
    {
        Paginator::defaultView('molecules.pagination');
    }
}

```

`app/Services/Buffer/Bcd.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Buffer;

class Bcd
{
    /**
     * @param string $bcd
     *
     * @return int
     */
    public static function readInteger(string $bcd): int
    {
        $int = 0;
        $length = strlen($bcd);

        for ($i = 0; $i < $length; $i++) {
            $int = $int * 10 + hexdec($bcd[$i]);
        }

        return $int;
    }
}

```

`app/Services/Buffer/Bit.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Buffer;

class Bit
{
    /**
     * @param int $number
     * @param int $index
     *
     * @return bool
     */
    public static function check(int $number, int $index): bool
    {
        return ($number & (1 << $index)) !== 0;
    }

    /**
     * @param int $number
     * @param int $from
     * @param int $to
     *
     * @return int
     */
    public static function between(int $number, int $from, int $to): int
    {
        return ($number >> $from) & ((1 << ($to - $from)) - 1);
    }

    /**
     * @param int $number
     * @param int $to
     *
     * @return int
     */
    public static function to(int $number, int $to): int
    {
        return static::between($number, 0, $to);
    }
}

```

`app/Services/Buffer/Byte.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Buffer;

class Byte
{
    /**
     * @var int
     */
    protected int $index = 0;

    /**
     * @var bool
     */
    protected bool $tracking = false;

    /**
     * @var string
     */
    protected string $track = '';

    /**
     * @param string $buffer
     *
     * @return self
     */
    public function __construct(protected string $buffer)
    {
    }

    /**
     * @param ?int $length = null
     * @param ?int $index = null
     *
     * @return self
     */
    public function new(?int $length = null, ?int $index = null): self
    {
        return new static($this->string($length, $index));
    }

    /**
     * @param int $index
     *
     * @return self
     */
    public function index(int $index): self
    {
        $this->index = $index * 2;

        return $this;
    }

    /**
     * @return self
     */
    public function trackStart(): self
    {
        $this->tracking = true;
        $this->track = '';

        return $this;
    }

    /**
     * @return string
     */
    public function trackEnd(): string
    {
        $this->tracking = false;

        return $this->track;
    }

    /**
     * @param ?int $length = null
     * @param ?int $index = null
     *
     * @return string
     */
    public function string(?int $length = null, ?int $index = null): string
    {
        $index = ($index === null) ? $this->index : ($index * 2);
        $length = $length ? ($length * 2) : null;

        $value = substr($this->buffer, $index, $length);

        $this->index = $index + strlen($value);

        if ($this->tracking) {
            $this->track .= $value;
        }

        return $value;
    }

    /**
     * @param ?int $length = null
     * @param ?int $index = null
     *
     * @return int
     */
    public function int(?int $length = null, ?int $index = null): int
    {
        return hexdec($this->string($length, $index));
    }

    /**
     * @param ?int $length = null
     * @param ?int $index = null
     *
     * @return int
     */
    public function intSigned(?int $length = null, ?int $index = null): int
    {
        $value = $this->int($length, $index);
        $bits = $length * 8;

        if ($value >= (1 << ($bits - 1))) {
            $value -= (1 << $bits);
        }

        return $value;
    }

    /**
     * @param mixed $value
     * @param array $values
     *
     * @return int
     */
    public function intIf(mixed $value, array $values): int
    {
        foreach ($values as $each) {
            if ($each === $value) {
                return $this->int(2);
            }
        }

        return $this->int(1);
    }

    /**
     * @return int
     */
    public function length(): int
    {
        return strlen(substr($this->buffer, $this->index)) / 2;
    }

    /**
     * @param int $offset
     *
     * @return int
     */
    public function peek(int $offset = 0): int
    {
        return hexdec(substr($this->buffer, $this->index + ($offset * 2), 2));
    }
}

```

`app/Services/Captcha/Captcha.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Captcha;

use Eusonlito\Captcha\Captcha as CaptchaVendor;
use App\Domains\UserFail\Model\UserFail as UserFailModel;

class Captcha
{
    /**
     * @const array
     */
    protected const LETTERS = [5, 7];

    /**
     * @const array
     */
    protected const DOTS = [8, 15];

    /**
     * @const array
     */
    protected const LINES = [5, 8];

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @return self
     */
    public function __construct()
    {
        CaptchaVendor::setNoise(static::DOTS, static::LINES);
    }

    /**
     * @return bool
     */
    public function requiredAuth(): bool
    {
        return $this->requiredAuthIpDay();
    }

    /**
     * @return bool
     */
    public function requiredAuthIpDay(): bool
    {
        return UserFailModel::query()
            ->byIp(request()->ip())
            ->byCreatedAtAfter(date('Y-m-d H:i:s', strtotime('-1 day')))
            ->count() >= 2;
    }

    /**
     * @param int $width
     * @param int $height
     *
     * @return string
     */
    public function source(int $width, int $height): string
    {
        $image = CaptchaVendor::source(static::LETTERS, $width, $height);

        session(['captcha' => strtolower(CaptchaVendor::string())]);

        return $image;
    }

    /**
     * @return ?string
     */
    public function sessionValue(): ?string
    {
        return session('captcha');
    }
}

```

`app/Services/Chrono/Chrono.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Chrono;

use InvalidArgumentException;

class Chrono
{
    /**
     * @var array
     */
    protected static array $chronos = [];

    /**
     * @param bool $memory = false
     */
    public static function reset(bool $memory = false): void
    {
        self::$chronos = [];

        if ($memory) {
            memory_reset_peak_usage();
        }
    }

    /**
     * @param string $name
     * @param mixed $data = null
     *
     * @return void
     */
    public static function start(string $name, mixed $data = null): void
    {
        self::$chronos[$name] ??= [
            'time_total' => 0,
            'time_average' => 0,
            'memory_average' => 0,
            'measures' => [],
        ];

        self::$chronos[$name]['measures'][] = [
            'action' => 'start',
            'time_absolute' => microtime(true),
            'memory_absolute' => round(memory_get_peak_usage(true) / 1024 / 1024, 4),
            'data' => $data,
        ];
    }

    /**
     * @param string $name
     * @param mixed $data = null
     *
     * @return void
     */
    public static function stop(string $name, mixed $data = null): void
    {
        if (empty(self::$chronos[$name])) {
            throw new InvalidArgumentException(sprintf('Chrono %s not started', $name));
        }

        $time = microtime(true);
        $previous = end(self::$chronos[$name]['measures']);
        $memory = round(memory_get_peak_usage(true) / 1024 / 1024, 4);

        self::$chronos[$name]['measures'][] = [
            'action' => 'stop',
            'time_absolute' => $time,
            'time_relative' => round($time - $previous['time_absolute'], 5),
            'memory_absolute' => $memory,
            'memory_relative' => round($memory - $previous['memory_absolute'], 4),
            'data' => $data,
            'previous' => $previous,
        ];
    }

    /**
     * @return array
     */
    public static function all(): array
    {
        return self::$chronos;
    }

    /**
     * @param ?string $sort = 'time_total'
     * @param bool $detail = false
     *
     * @return array
     */
    public static function summary(?string $sort = 'time_total', bool $detail = false): array
    {
        $chronos = [];

        foreach (array_keys(self::$chronos) as $name) {
            $chronos[$name] = static::chronoSummary($name, $detail);
        }

        $chronos = self::summaryPercent($chronos);

        if ($sort) {
            $chronos = self::summarySort($chronos, $sort);
        }

        return $chronos;
    }

    /**
     * @param array $chronos
     * @param string $sort
     *
     * @return array
     */
    protected static function summarySort(array $chronos, string $sort): array
    {
        if (in_array($sort, ['time_total', 'time_average', 'memory_average', 'measures_count']) === false) {
            throw new InvalidArgumentException(sprintf('Invalid sort %s', $sort));
        }

        uasort($chronos, static fn ($a, $b) => $b[$sort] <=> $a[$sort]);

        return $chronos;
    }

    /**
     * @param array $chronos
     *
     * @return array
     */
    protected static function summaryPercent(array $chronos): array
    {
        $time_total = max(array_column($chronos, 'time_total'));
        $memory_average = max(array_column($chronos, 'memory_average'));

        foreach ($chronos as &$value) {
            $value['time_total_percent'] = intval($value['time_total'] * 100 / $time_total);
            $value['memory_average_percent'] = intval($value['memory_average'] * 100 / $memory_average);
        }

        unset($value);

        return $chronos;
    }

    /**
     * @param string $name
     * @param bool $detail = false
     *
     * @return array
     */
    public static function chronoSummary(string $name, bool $detail = false): array
    {
        $chrono = self::$chronos[$name] ?? null;

        if (empty($chrono)) {
            throw new InvalidArgumentException(sprintf('Chrono %s not exists', $name));
        }

        $measures = array_filter(
            $chrono['measures'],
            static fn ($measure) => $measure['action'] === 'stop'
        );

        $time = array_sum(array_column($measures, 'time_relative'));
        $memory = array_sum(array_column($measures, 'memory_relative'));
        $count = count($measures) ?: 1;

        $summary = [
            'time_total' => $time,
            'time_average' => round($time / $count, 5),
            'memory_average' => round($memory / $count, 4),
            'measures_count' => $count,
        ];

        if ($detail) {
            $summary['measures'] = $chrono['measures'];
        }

        return $summary;
    }
}

```

`app/Services/Command/Artisan.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Command;

use App\Services\Filesystem\Directory;

class Artisan
{
    /**
     * @const string
     */
    protected const LOG = '/dev/null';

    /**
     * @var string
     */
    protected string $log = '/dev/null';

    /**
     * @var bool
     */
    protected bool $logDaily = false;

    /**
     * @var string
     */
    protected string $cmd;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param string $command
     *
     * @return self
     */
    public function __construct(protected string $command)
    {
    }

    /**
     * @param string|bool $path = true
     *
     * @return self
     */
    public function log(string|bool $path = true): self
    {
        $this->logFile($path);

        return $this;
    }

    /**
     * @param bool $logDaily = true
     *
     * @return self
     */
    public function logDaily(bool $logDaily = true): self
    {
        $this->logDaily = $logDaily;
        $this->log($logDaily);

        return $this;
    }

    /**
     * @return void
     */
    public function exec(): void
    {
        $this->cmd();
        $this->logOpen();
        $this->launch();
    }

    /**
     * @param string|bool $path
     *
     * @return string
     */
    protected function logFile(string|bool $path): string
    {
        $this->log = $this->logFilePath($path);

        Directory::create($this->log, true);

        return $this->log;
    }

    /**
     * @param string|bool $path
     *
     * @return string
     */
    protected function logFilePath(string|bool $path): string
    {
        if (empty($path)) {
            return static::LOG;
        }

        if ($path === true) {
            $path = $this->command;
        }

        if (str_starts_with($path, '/')) {
            return $path;
        }

        return storage_path('logs/artisan/'.$this->logFileDatePrefix().$this->logFileCommand($path));
    }

    /**
     * @return string
     */
    protected function logFileDatePrefix(): string
    {
        return date_create()->format('Y/m/d/'.($this->logDaily ? '' : 'H_i_s_u-'));
    }

    /**
     * @param string $path
     *
     * @return string
     */
    protected function logFileCommand(string $path): string
    {
        return str_slug(preg_replace('/\W/', '-', $path)).'.log';
    }

    /**
     * @return void
     */
    protected function cmd(): void
    {
        $this->cmd = sprintf(
            'nohup %s %s %s >> %s 2>&1 &',
            Exec::php(),
            escapeshellcmd(base_path('artisan')),
            escapeshellcmd($this->command),
            escapeshellcmd($this->log)
        );
    }

    /**
     * @return void
     */
    protected function logOpen(): void
    {
        file_put_contents($this->log, $this->logContents(), FILE_APPEND);
    }

    /**
     * @return string
     */
    protected function logContents(): string
    {
        return "\n".'['.$this->timestamp().'] '.$this->cmd."\n\n";
    }

    /**
     * @return string
     */
    protected function timestamp(): string
    {
        return date_create()->format('Y-m-d H:i:s.v P');
    }

    /**
     * @return void
     */
    protected function launch(): void
    {
        exec($this->cmd);
    }
}

```

`app/Services/Command/Exec.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Command;

class Exec
{
    /**
     * @param string $command
     *
     * @return ?string
     */
    public static function available(string $command): ?string
    {
        return static::cmd('/bin/sh -c "command -v '.escapeshellarg($command).'" 2>/dev/null') ?: null;
    }

    /**
     * @param string $command
     *
     * @return string
     */
    public static function cmd(string $command): string
    {
        return trim(strval(shell_exec($command)));
    }

    /**
     * @param string $command
     *
     * @return array
     */
    public static function cmdArray(string $command): array
    {
        return static::toArray(static::cmd($command));
    }

    /**
     * @param string $command
     *
     * @return array
     */
    public static function cmdArrayInt(string $command): array
    {
        return array_map('intval', static::toArray(static::cmd($command)));
    }

    /**
     * @param string $command
     *
     * @return float
     */
    public static function cmdFloat(string $command): float
    {
        return intval(static::cmd($command));
    }

    /**
     * @param string $command
     *
     * @return int
     */
    public static function cmdInt(string $command): int
    {
        return intval(static::cmd($command));
    }

    /**
     * @param string $command
     *
     * @return array
     */
    public static function cmdLines(string $command): array
    {
        return static::toLines(static::cmd($command));
    }

    /**
     * @param string $command
     *
     * @return array
     */
    public static function cmdLinesArray(string $command): array
    {
        return static::filter(array_map(
            static fn ($line) => static::toArray($line),
            static::cmdLines($command)
        ));
    }

    /**
     * @return string
     */
    public static function php(): string
    {
        if ($php = env('PHP_BINARY')) {
            return $php;
        }

        if (static::phpIsCli()) {
            return PHP_BINARY;
        }

        $version = PHP_MAJOR_VERSION.'.'.PHP_MINOR_VERSION;

        return static::available('php'.$version) ?: static::available('php');
    }

    /**
     * @return bool
     */
    protected static function phpIsCli(): bool
    {
        return (PHP_SAPI === 'cli') || defined('STDIN');
    }

    /**
     * @param string $output
     *
     * @return array
     */
    protected static function toArray(string $output): array
    {
        return static::explode(' ', preg_replace('/\s+/', ' ', $output));
    }

    /**
     * @param string $output
     *
     * @return array
     */
    protected static function toLines(string $output): array
    {
        return static::explode("\n", $output);
    }

    /**
     * @param string $delimiter
     * @param string $output
     *
     * @return array
     */
    protected static function explode(string $delimiter, string $output): array
    {
        return static::filter(explode($delimiter, $output));
    }

    /**
     * @param array $output
     *
     * @return array
     */
    protected static function filter(array $output): array
    {
        return array_values(array_filter($output, static function ($value) {
            return is_string($value) ? strlen($value) : $value;
        }));
    }
}

```

`app/Services/Compress/Zip/Contents.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Compress\Zip;

use ZipArchive;

class Contents
{
    /**
     * @var \ZipArchive
     */
    protected ZipArchive $zip;

    /**
     * @var bool
     */
    protected bool $open;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param string $file
     *
     * @return self
     */
    public function __construct(protected string $file)
    {
        $this->open();
    }

    /**
     * @return void
     */
    protected function open(): void
    {
        $this->zip = new ZipArchive();
        $this->open = $this->zip->open($this->file, ZipArchive::RDONLY);
    }

    /**
     * @param int $index = 0
     *
     * @return ?string
     */
    public function contents(int $index = 0): ?string
    {
        if ($this->contentsIsValid($index) === false) {
            return null;
        }

        return $this->zip->getFromIndex($index);
    }

    /**
     * @param int $index
     *
     * @return bool
     */
    protected function contentsIsValid(int $index): bool
    {
        return $this->open
            && ($index >= 0)
            && ($index < $this->zip->numFiles);
    }
}

```

`app/Services/Compress/Zip/Create.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Compress\Zip;

use UnexpectedValueException;
use ZipArchive;

class Create
{
    /**
     * @var \ZipArchive
     */
    protected ZipArchive $zip;

    /**
     * @var ?string
     */
    protected ?string $password = null;

    /**
     * @return self
     */
    public function __construct(protected string $file)
    {
        $this->open();
    }

    /**
     * @return self
     */
    protected function open(): self
    {
        $this->zip = new ZipArchive();

        if ($this->zip->open($this->file, ZipArchive::CREATE) !== true) {
            throw new UnexpectedValueException('Invalid ZIP File');
        }

        return $this;
    }

    /**
     * @param ?string $password
     *
     * @return self
     */
    public function setPassword(?string $password): self
    {
        $this->password = $password;

        return $this;
    }

    /**
     * @param string $file
     * @param string $name = ''
     *
     * @return self
     */
    public function addFile(string $file, string $name = ''): self
    {
        $this->zip->addFile($file, trim($name ?: basename($file), '/'));

        if ($this->password) {
            $this->zip->setEncryptionName($file, ZipArchive::EM_AES_256, $this->password);
        }

        return $this;
    }

    /**
     * @return self
     */
    public function close(): self
    {
        $this->zip->close();

        return $this;
    }
}

```

`app/Services/Compress/Zip/Extract.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Compress\Zip;

use ZipArchive;

class Extract
{
    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param string $file
     *
     * @return self
     */
    public function __construct(protected string $file)
    {
    }

    /**
     * @param string|array|null $files = null
     *
     * @return void
     */
    public function extract(string|array|null $files = null): void
    {
        $zip = new ZipArchive();

        if ($zip->open($this->file, ZipArchive::RDONLY) !== true) {
            return;
        }

        $zip->extractTo(dirname($this->file), $files);
        $zip->close();
    }
}

```

`app/Services/Compress/Zip/File.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Compress\Zip;

use ZipArchive;
use App\Services\Filesystem\Directory;

class File
{
    /**
     * @var string
     */
    protected string $folder;

    /**
     * @var array
     */
    protected array $extensions = [];

    /**
     * @var array
     */
    protected array $exclude = [];

    /**
     * @var int
     */
    protected int $fromTime = 0;

    /**
     * @var int
     */
    protected int $toTime = 0;

    /**
     * @param string $folder
     *
     * @return self
     */
    public function __construct(string $folder)
    {
        $this->folder = $folder;
    }

    /**
     * @param array|string $extensions
     *
     * @return self
     */
    public function extensions(array|string $extensions): self
    {
        $this->extensions = (array)$extensions;

        return $this;
    }

    /**
     * @param array $exclude
     *
     * @return self
     */
    public function exclude(array $exclude): self
    {
        $this->exclude = $exclude;

        return $this;
    }

    /**
     * @param string $date
     *
     * @return self
     */
    public function fromDate(string $date): self
    {
        $this->fromTime = strtotime($date);

        return $this;
    }

    /**
     * @param string $date
     *
     * @return self
     */
    public function toDate(string $date): self
    {
        $this->toTime = strtotime($date);

        return $this;
    }

    /**
     * @param int $time
     *
     * @return self
     */
    public function fromTime(int $time): self
    {
        $this->fromTime = $time;

        return $this;
    }

    /**
     * @param int $time
     *
     * @return self
     */
    public function toTime(int $time): self
    {
        $this->toTime = $time;

        return $this;
    }

    /**
     * @return self
     */
    public function compress(): self
    {
        foreach (Directory::files($this->folder, $this->compressInclude(), $this->compressExclude()) as $file) {
            $this->file($file);
        }

        return $this;
    }

    /**
     * @return ?string
     */
    public function compressInclude(): ?string
    {
        if (empty($this->extensions)) {
            return null;
        }

        return '/\.('.implode('|', $this->extensions).')$/i';
    }

    /**
     * @return string
     */
    public function compressExclude(): string
    {
        return '/('.implode('|', array_filter(array_unique(array_merge($this->exclude, ['\.zip$'])))).')/';
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function file(string $file): void
    {
        if ($this->fileIsValid($file)) {
            $this->pack($file);
        }
    }

    /**
     * @param string $file
     *
     * @return bool
     */
    protected function fileIsValid(string $file): bool
    {
        $time = filemtime($file);

        return (($this->fromTime === 0) || ($time >= $this->fromTime))
            && (($this->toTime === 0) || ($time <= $this->toTime));
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function pack(string $file): void
    {
        $zip = new ZipArchive();

        if ($zip->open($file.'.zip', ZipArchive::CREATE) !== true) {
            return;
        }

        $zip->addFile($file, basename($file));

        if ($zip->close()) {
            unlink($file);
        }
    }
}

```

`app/Services/Compress/Zip/Folder.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Compress\Zip;

use Exception;
use ZipArchive;
use App\Services\Filesystem\Directory;

class Folder
{
    /**
     * @var string
     */
    protected string $source;

    /**
     * @var string
     */
    protected string $target;

    /**
     * @var \ZipArchive
     */
    protected ZipArchive $zip;

    /**
     * @var array
     */
    protected array $extensions = [];

    /**
     * @var array
     */
    protected array $exclude = [];

    /**
     * @var int
     */
    protected int $fromTime = 0;

    /**
     * @var int
     */
    protected int $toTime = 0;

    /**
     * @param string $source
     * @param string $source = ''
     *
     * @return self
     */
    public function __construct(string $source, string $target = '')
    {
        $this->source = $this->source($source);
        $this->target = $this->target($target ?: $source);
    }

    /**
     * @param array $extensions
     *
     * @return self
     */
    public function extensions(array $extensions): self
    {
        $this->extensions = $extensions;

        return $this;
    }

    /**
     * @param array $exclude
     *
     * @return self
     */
    public function exclude(array $exclude): self
    {
        $this->exclude = $exclude;

        return $this;
    }

    /**
     * @param string $date
     *
     * @return self
     */
    public function fromDate(string $date): self
    {
        $this->fromTime = strtotime($date);

        return $this;
    }

    /**
     * @param string $date
     *
     * @return self
     */
    public function toDate(string $date): self
    {
        $this->toTime = strtotime($date);

        return $this;
    }

    /**
     * @param int $time
     *
     * @return self
     */
    public function fromTime(int $time): self
    {
        $this->fromTime = $time;

        return $this;
    }

    /**
     * @param int $time
     *
     * @return self
     */
    public function toTime(int $time): self
    {
        $this->toTime = $time;

        return $this;
    }

    /**
     * @return self
     */
    public function compress(): self
    {
        $this->open();

        foreach (Directory::files($this->source, $this->compressInclude(), $this->compressExclude()) as $file) {
            $this->file($file);
        }

        $this->close();

        return $this;
    }

    /**
     * @return ?string
     */
    public function compressInclude(): ?string
    {
        if (empty($this->extensions)) {
            return null;
        }

        return '/\.('.implode('|', $this->extensions).')$/i';
    }

    /**
     * @return ?string
     */
    public function compressExclude(): ?string
    {
        if (empty($this->exclude)) {
            return null;
        }

        return '/\.('.implode('|', $this->exclude).')$/';
    }

    /**
     * @param string $source
     *
     * @return string
     */
    protected function source(string $source): string
    {
        if (str_starts_with($source, '/') === false) {
            $source = base_path($source);
        }

        if (is_dir($source) === false) {
            throw new Exception(sprintf('Folder %s is not a valid source', $source));
        }

        return $source;
    }

    /**
     * @param string $target
     *
     * @return string
     */
    protected function target(string $target): string
    {
        if (is_dir($target)) {
            $target = rtrim($target, '/').'.zip';
        }

        if (str_starts_with($target, '/') === false) {
            $target = base_path($target);
        }

        Directory::create($target, true);

        return $target;
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function file(string $file): void
    {
        if ($this->fileIsValid($file)) {
            $this->addFile($file);
        }
    }

    /**
     * @param string $file
     *
     * @return bool
     */
    protected function fileIsValid(string $file): bool
    {
        $time = filemtime($file);

        return (($this->fromTime === 0) || ($time >= $this->fromTime))
            && (($this->toTime === 0) || ($time <= $this->toTime));
    }

    /**
     * @return void
     */
    protected function open(): void
    {
        $this->zip = new ZipArchive();
        $this->zip->open($this->target, ZipArchive::CREATE);
    }

    /**
     * @param string $file
     *
     * @return void
     */
    protected function addFile(string $file): void
    {
        $this->zip->addFile($file, str_replace($this->source, '', $file));
    }

    /**
     * @return void
     */
    protected function close(): void
    {
        $this->zip->close();
    }
}

```

`app/Services/Csv/Read.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Csv;

use UnexpectedValueException;

class Read
{
    /**
     * @var mixed
     */
    protected mixed $fp;

    /**
     * @var array
     */
    protected array $lines;

    /**
     * @var array
     */
    protected array $header;

    /**
     * @param string $csv
     * @param string $delimiter = ';'
     *
     * @return self
     */
    public static function fromString(string $csv, string $delimiter = ';'): self
    {
        return static::new(static::stringToFile($csv), $delimiter);
    }

    /**
     * @param string $csv
     *
     * @return string
     */
    public static function stringToFile(string $csv): string
    {
        $file = tempnam(sys_get_temp_dir(), 'csv-read');

        file_put_contents($file, $csv);

        return $file;
    }

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param string $file
     * @param string $delimiter = ';'
     *
     * @return self
     */
    public function __construct(protected string $file, protected string $delimiter = ';')
    {
    }

    /**
     * @param array $header
     *
     * @return self
     */
    public function map(array $header): self
    {
        $this->header = $header;

        return $this;
    }

    /**
     * @return array
     */
    public function get(): array
    {
        $this->fopen();
        $this->lines();
        $this->fclose();
        $this->header();

        return array_map($this->line(...), $this->lines);
    }

    /**
     * @return self
     */
    public function fopen(): self
    {
        if (is_readable($this->file) === false) {
            throw new UnexpectedValueException(sprintf('Invalid CSV File %s', $this->file));
        }

        $this->fp = fopen($this->file, 'r');

        if ($this->fp === false) {
            throw new UnexpectedValueException(sprintf('Invalid CSV File %s', $this->file));
        }

        // UTF-8 BOM Remove
        if (fgets($this->fp, 4) !== "\xef\xbb\xbf") {
            rewind($this->fp);
        }

        return $this;
    }

    /**
     * @return void
     */
    protected function lines(): void
    {
        $this->lines = [];

        while (($each = fgetcsv($this->fp, 0, $this->delimiter)) !== false) {
            $this->lines[] = $each;
        }
    }

    /**
     * @return self
     */
    public function fclose(): self
    {
        fclose($this->fp);

        return $this;
    }

    /**
     * @return void
     */
    protected function header(): void
    {
        $header = array_shift($this->lines);

        $this->header ??= $header ?? [];
    }

    /**
     * @param array $line
     *
     * @return array
     */
    protected function line(array $line): array
    {
        $line = array_map($this->value(...), $line);
        $combined = [];

        foreach ($this->header as $index => $name) {
            $combined[$name] = $line[$index] ?? '';
        }

        return $combined;
    }

    /**
     * @param string|null $value
     *
     * @return string
     */
    protected function value(?string $value): string
    {
        return trim($this->utf8(strval($value)));
    }

    /**
     * @param string $string
     *
     * @return string
     */
    protected function utf8(string $string): string
    {
        if (preg_match('#[\x80-\x{1FF}\x{2000}-\x{3FFF}]#u', $string)) {
            return $string;
        }

        if (preg_match('#[\x7F-\x9F\xBC]#', $string)) {
            return iconv('WINDOWS-1250', 'UTF-8', $string);
        }

        return iconv('ISO-8859-15', 'UTF-8', $string);
    }
}

```

`app/Services/Csv/Write.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Csv;

class Write
{
    /**
     * @var ?string
     */
    protected ?string $file = null;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param array $data
     *
     * @return self
     */
    public function __construct(protected array $data)
    {
    }

    /**
     * @param string $file
     *
     * @return self
     */
    public function file(string $file): self
    {
        $this->file = $file;

        return $this;
    }

    /**
     * @return self
     */
    public function fileTmp(): self
    {
        $this->file = tempnam(sys_get_temp_dir(), 'csv-export');

        return $this;
    }

    /**
     * @return string
     */
    public function get(): string
    {
        if ($this->file) {
            helper()->mkdir($this->file, true);
        }

        $fp = fopen($this->file ?: 'php://memory', 'w');

        // Added UTF-8 BOM fix in Excel
        fwrite($fp, chr(0xEF).chr(0xBB).chr(0xBF));

        fputcsv($fp, array_keys(reset($this->data) ?: []));

        foreach ($this->data as $line) {
            fputcsv($fp, $line);
        }

        if ($this->file) {
            $response = $this->file;
        } else {
            rewind($fp);

            $response = stream_get_contents($fp);
        }

        fclose($fp);

        return $response;
    }
}

```

`app/Services/Curl/Cache.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Curl;

class Cache
{
    /**
     * @var int
     */
    protected int $ttl = 0;

    /**
     * @var string
     */
    protected string $key = '';

    /**
     * @var string
     */
    protected string $path;

    /**
     * @return self
     */
    public function __construct()
    {
        $this->setup();
    }

    /**
     * @return self
     */
    protected function setup(): self
    {
        $this->path = storage_path('cache/curl');

        helper()->mkdir($this->path);

        return $this;
    }

    /**
     * @param int $ttl
     *
     * @return self
     */
    public function setTTL(int $ttl): self
    {
        $this->ttl = $ttl;

        return $this;
    }

    /**
     * @param array $data
     *
     * @return self
     */
    public function setData(array $data): self
    {
        unset($data['ttl'], $data['sleep']);

        $this->keyGenerate($data);

        return $this;
    }

    /**
     * @return bool
     */
    public function getEnabled(): bool
    {
        return (bool)$this->ttl;
    }

    /**
     * @param array $data
     *
     * @return self
     */
    protected function keyGenerate(array $data): self
    {
        $this->key = md5(json_encode($data, JSON_PARTIAL_OUTPUT_ON_ERROR));

        return $this;
    }

    /**
     * @return bool
     */
    public function exists(): bool
    {
        return is_file($file = $this->file())
            && (filemtime($file) > time());
    }

    /**
     * @return ?array
     */
    public function get(): ?array
    {
        return $this->exists() ? json_decode(file_get_contents($this->file()), true) : null;
    }

    /**
     * @param array $data
     *
     * @return void
     */
    public function set(array $data): void
    {
        $file = $this->file();

        file_put_contents($file, helper()->jsonEncode($data), LOCK_EX);

        touch($file, time() + $this->ttl);
    }

    /**
     * @return string
     */
    public function file(): string
    {
        return $this->path.'/'.$this->key.'.json';
    }
}

```

`app/Services/Curl/Curl.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Curl;

use Closure;
use CurlFile;
use CurlHandle;
use Throwable;

class Curl
{
    /**
     * @var ?string
     */
    protected static ?string $fake = null;

    /**
     * @var \CurlHandle
     */
    protected CurlHandle $curl;

    /**
     * @var int
     */
    protected int $timeout = 30;

    /**
     * @var string
     */
    protected string $url = '';

    /**
     * @var string
     */
    protected string $urlRequest = '';

    /**
     * @var string
     */
    protected string $method = 'GET';

    /**
     * @var array
     */
    protected array $headers = [];

    /**
     * @var array
     */
    protected array $query = [];

    /**
     * @var bool
     */
    protected bool $cachePost = false;

    /**
     * @var \App\Services\Curl\Cache
     */
    protected Cache $cache;

    /**
     * @var mixed
     */
    protected mixed $body;

    /**
     * @var array
     */
    protected array $bodyFiles = [];

    /**
     * @var mixed
     */
    protected mixed $bodyRequest;

    /**
     * @var int
     */
    protected int $sleep = 0;

    /**
     * @var bool
     */
    protected bool $isJson = false;

    /**
     * @var bool
     */
    protected bool $isJsonResponse = false;

    /**
     * @var bool
     */
    protected bool $isMultipart = false;

    /**
     * @var string
     */
    protected string $boundary;

    /**
     * @var bool
     */
    protected bool $exception = true;

    /**
     * @var bool
     */
    protected bool $errorReport = true;

    /**
     * @var bool
     */
    protected bool $log = false;

    /**
     * @var bool
     */
    protected bool $logContents = true;

    /**
     * @var bool
     */
    protected bool $logBody = true;

    /**
     * @var ?\Closure
     */
    protected ?Closure $sendSuccess = null;

    /**
     * @var int
     */
    protected int $retry = 0;

    /**
     * @var int
     */
    protected int $retryWait = 1000;

    /**
     * @var ?int
     */
    protected ?int $retryCount = null;

    /**
     * @var ?string
     */
    protected ?string $response = '';

    /**
     * @var array
     */
    protected array $responseHeaders = [];

    /**
     * @var array
     */
    protected array $info = [];

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param ?string $fake = null
     *
     * @return void
     */
    public static function fake(?string $fake = null): void
    {
        static::$fake = $fake;
    }

    /**
     * @return self
     */
    public function __construct()
    {
        $this->initCurl();
        $this->initCache();
    }

    /**
     * @return self
     */
    protected function initCurl(): self
    {
        $this->curl = curl_init();

        $this->setOption(CURLOPT_COOKIESESSION, false);
        $this->setOption(CURLOPT_FOLLOWLOCATION, true);
        $this->setOption(CURLOPT_FORBID_REUSE, true);
        $this->setOption(CURLOPT_FRESH_CONNECT, true);
        $this->setOption(CURLOPT_HEADER, true);
        $this->setOption(CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_1);
        $this->setOption(CURLOPT_MAXREDIRS, 5);
        $this->setOption(CURLOPT_RETURNTRANSFER, true);
        $this->setOption(CURLOPT_SSL_VERIFYPEER, false);
        $this->setOption(CURLOPT_SSL_VERIFYHOST, false);
        $this->setOption(CURLOPT_TIMEOUT, $this->timeout);

        $this->setHeader('User-Agent', 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.96 Safari/537.36');
        $this->setHeader('Connection', 'close');

        return $this;
    }

    /**
     * @return self
     */
    protected function initCache(): self
    {
        $this->cache = new Cache();

        return $this;
    }

    /**
     * @param int $option
     * @param mixed $value
     *
     * @return self
     */
    public function setOption(int $option, $value): self
    {
        curl_setopt($this->curl, $option, $value);

        return $this;
    }

    /**
     * @param string $method
     *
     * @return self
     */
    public function setMethod(string $method): self
    {
        $this->method = strtoupper($method);

        $this->setOption(CURLOPT_CUSTOMREQUEST, $this->method);

        return $this;
    }

    /**
     * @param string $url
     *
     * @return self
     */
    public function setUrl(string $url): self
    {
        $this->url = $url;

        return $this;
    }

    /**
     * @param array $query
     *
     * @return self
     */
    public function setQuery(array $query): self
    {
        $this->query = array_merge($this->query, $query);

        return $this;
    }

    /**
     * @param mixed $body
     *
     * @return self
     */
    public function setBody(mixed $body): self
    {
        $this->body = $body;

        return $this;
    }

    /**
     * @param bool $body
     *
     * @return self
     */
    public function setNoBody(bool $body): self
    {
        $this->setOption(CURLOPT_NOBODY, $body);

        return $this;
    }

    /**
     * @param string $name
     * @param string $file
     * @param ?string $mime = null
     *
     * @return self
     */
    public function setBodyFile(string $name, string $file, ?string $mime = null): self
    {
        $this->bodyFiles[] = [
            'name' => $name,
            'file' => $file,
            'mime' => (($mime === null) ? mime_content_type($file) : $mime),
        ];

        return $this;
    }

    /**
     * @param array $headers
     *
     * @return self
     */
    public function setHeaders(array $headers): self
    {
        $this->headers = array_merge($this->headers, $headers);

        return $this;
    }

    /**
     * @param string $key
     * @param mixed $value
     *
     * @return self
     */
    public function setHeader(string $key, $value): self
    {
        $this->headers[$key] = $value;

        return $this;
    }

    /**
     * @param callable $function
     *
     * @return self
     */
    public function setHeaderFunction(callable $function): self
    {
        $this->setOption(CURLOPT_HEADERFUNCTION, $function);

        return $this;
    }

    /**
     * @param string $file
     *
     * @return self
     */
    public function setCookieFile(string $file): self
    {
        $this->setOption(CURLOPT_COOKIESESSION, true);
        $this->setOption(CURLOPT_COOKIEFILE, $file);
        $this->setOption(CURLOPT_COOKIEJAR, $file);

        return $this;
    }

    /**
     * @param ?string $token
     * @param bool $bearer = true
     *
     * @return self
     */
    public function setAuthorization(?string $token, bool $bearer = true): self
    {
        if ($token) {
            $this->setHeader('Authorization', ($bearer ? 'Bearer ' : '').$token);
        }

        return $this;
    }

    /**
     * @param string $user
     * @param string $password
     *
     * @return self
     */
    public function setUserPassword(string $user, string $password): self
    {
        $this->setOption(CURLOPT_USERPWD, $user.':'.$password);

        return $this;
    }

    /**
     * @param bool $json = true
     *
     * @return self
     */
    public function setJson(bool $json = true): self
    {
        $this->isJson = $json;

        if ($this->isJson) {
            $this->setHeader('Content-Type', 'application/json');
        }

        $this->setJsonResponse($json);

        return $this;
    }

    /**
     * @param bool $jsonResponse = true
     *
     * @return self
     */
    public function setJsonResponse(bool $jsonResponse = true): self
    {
        $this->isJsonResponse = $jsonResponse;

        if ($this->isJsonResponse) {
            $this->setHeader('Accept', 'application/json');
        }

        return $this;
    }

    /**
     * @param bool $multipart = true
     *
     * @return self
     */
    public function setMultipart(bool $multipart = true): self
    {
        $this->isMultipart = $multipart;
        $this->boundary = md5(uniqid());

        $this->setHeader('Content-Type', 'multipart/form-data; boundary='.$this->boundary);

        return $this;
    }

    /**
     * @param int $timeout
     *
     * @return self
     */
    public function setTimeOut(int $timeout): self
    {
        $this->setOption(CURLOPT_TIMEOUT, $this->timeout = $timeout);

        return $this;
    }

    /**
     * @return self
     */
    public function setStream(): self
    {
        $this->setHeader('Content-Type', 'application/octet-stream');

        $this->setOption(CURLOPT_WRITEFUNCTION, [$this, 'setStreamWriteFunction']);

        return $this;
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param \CurlHandle $curl
     * @param string $string
     *
     * @return int
     */
    protected function setStreamWriteFunction(CurlHandle $curl, string $string): int
    {
        echo $string;

        return strlen($string);
    }

    /**
     * @param resource $fp
     * @param ?int $size = null
     *
     * @return self
     */
    public function setFile($fp, ?int $size = null): self
    {
        $this->setOption(CURLOPT_UPLOAD, true);
        $this->setOption(CURLOPT_INFILE, $fp);
        $this->setOption(CURLOPT_BINARYTRANSFER, true);

        if ($size !== null) {
            $this->setOption(CURLOPT_INFILESIZE, $size);
        }

        return $this;
    }

    /**
     * @param int $sleep
     *
     * @return self
     */
    public function setSleep(int $sleep): self
    {
        $this->sleep = $sleep;

        return $this;
    }

    /**
     * @param bool $exception = true
     *
     * @return self
     */
    public function setException(bool $exception = true): self
    {
        $this->exception = $exception;

        return $this;
    }

    /**
     * @param bool $errorReport = true
     *
     * @return self
     */
    public function setErrorReport(bool $errorReport = true): self
    {
        $this->errorReport = $errorReport;

        return $this;
    }

    /**
     * @param int $ttl
     *
     * @return self
     */
    public function setCache(int $ttl): self
    {
        $this->cache->setTTL($ttl);

        return $this;
    }

    /**
     * @param bool $cache = true
     *
     * @return self
     */
    public function setCachePost(bool $cache = true): self
    {
        $this->cachePost = $cache;

        return $this;
    }

    /**
     * @param bool $log = true
     *
     * @return self
     */
    public function setLog(bool $log = true): self
    {
        $this->log = $log;

        return $this;
    }

    /**
     * @param bool $logContents = true
     *
     * @return self
     */
    public function setLogContents(bool $logContents = true): self
    {
        $this->logContents = $logContents;

        return $this;
    }

    /**
     * @param bool $logBody = true
     *
     * @return self
     */
    public function setLogBody(bool $logBody = true): self
    {
        $this->logBody = $logBody;

        return $this;
    }

    /**
     * @param ?callable $sendSuccess
     *
     * @return self
     */
    public function setSendSuccess(?callable $sendSuccess): self
    {
        $this->sendSuccess = $sendSuccess;

        return $this;
    }

    /**
     * @param int $ttl
     * @param int $wait = 1000
     *
     * @return self
     */
    public function setRetry(int $ttl, int $wait = 1000): self
    {
        $this->retry = $ttl;
        $this->retryWait = ($wait > 10) ? $wait : ($wait * 1000);

        return $this;
    }

    /**
     * @return self
     */
    public function writeHeaders(): self
    {
        $this->headers = array_filter($this->headers);

        if (empty($this->headers)) {
            return $this;
        }

        $this->setOption(CURLOPT_HTTPHEADER, array_map(static function (string $key, $value): string {
            return $key.': '.(is_array($value) ? json_encode($value) : $value);
        }, array_keys($this->headers), $this->headers));

        return $this;
    }

    /**
     * @return self
     */
    public function send(): self
    {
        $this->cacheSetData();

        if ($this->cacheGet() === false) {
            $this->sendExec();
        }

        if ($this->sendSuccess()) {
            $this->success();
        } else {
            $this->error();
        }

        curl_close($this->curl);

        return $this;
    }

    /**
     * @return self
     */
    protected function sendExec(): self
    {
        if ($this->sleep) {
            sleep($this->sleep);
        }

        $this->writeHeaders();

        $this->sendUrl();
        $this->sendPost();

        if ($response = static::$fake) {
            $this->info = [];
        } else {
            $response = curl_exec($this->curl);
            $this->info = curl_getinfo($this->curl);
        }

        $this->responseHeaders = [];

        if (is_string($response) === false) {
            return $this;
        }

        [$headers, $this->response] = explode("\r\n\r\n", $response, 2) + ['', null];

        $this->responseHeaders($headers);

        return $this;
    }

    /**
     * @param string $headers
     *
     * @return void
     */
    protected function responseHeaders(string $headers): void
    {
        $this->responseHeaders = [];

        $headers = explode("\n", $headers);

        array_shift($headers);

        foreach ($headers as $header) {
            if (preg_match('#^([^:]+):\s*(.+)$#', $header, $matches)) {
                $this->responseHeaders[strtolower($matches[1])] = trim($matches[2]);
            }
        }
    }

    /**
     * @return bool
     */
    public function sendSuccess(): bool
    {
        if ($this->sendSuccessCheck() === false) {
            return false;
        }

        if (empty($this->info)) {
            return true;
        }

        return in_array($this->info['http_code'], [200, 201, 204, 304]);
    }

    /**
     * @return bool
     */
    public function sendSuccessCheck(): bool
    {
        if ($this->sendSuccess === null) {
            return true;
        }

        return call_user_func($this->sendSuccess, $this->getBody());
    }

    /**
     * @param ?string $format = null
     *
     * @return mixed
     */
    public function getBody(?string $format = null): mixed
    {
        if (empty($this->response)) {
            return null;
        }

        if ($this->isJsonResponse && ($format === null)) {
            $format = 'object';
        }

        return match ($format) {
            'array' => json_decode($this->response, true),
            'object' => json_decode($this->response),
            default => $this->response,
        };
    }

    /**
     * @param string $key = ''
     *
     * @return mixed
     */
    public function getHeaders(string $key = ''): mixed
    {
        return $key ? ($this->responseHeaders[$key] ?? null) : $this->responseHeaders;
    }

    /**
     * @param string $key = ''
     *
     * @return mixed
     */
    public function getInfo(string $key = ''): mixed
    {
        return $key ? ($this->info[$key] ?? null) : $this->info;
    }

    /**
     * @return self
     */
    protected function sendUrl(): self
    {
        $this->setOption(CURLOPT_URL, $this->sendUrlString());

        return $this;
    }

    /**
     * @return string
     */
    protected function sendUrlString(): string
    {
        return $this->urlRequest = $this->urlWithQuery($this->url, $this->query);
    }

    /**
     * @param string $url
     * @param array $query
     *
     * @return string
     */
    protected function urlWithQuery(string $url, array $query): string
    {
        if ($query) {
            $url .= (str_contains($url, '?') ? '&' : '?').http_build_query($query, '', '&');
        }

        return $url;
    }

    /**
     * @return self
     */
    protected function sendPost(): self
    {
        if (in_array($this->method, ['POST', 'PUT']) === false) {
            return $this;
        }

        if (empty($this->body)) {
            return $this;
        }

        return match (gettype($this->body)) {
            'string' => $this->sendPostString(),
            'boolean' => $this->sendPostBoolean(),
            default => $this->sendPostArray(),
        };
    }

    /**
     * @return self
     */
    protected function sendPostString(): self
    {
        return $this->setOption(CURLOPT_POSTFIELDS, $this->body);
    }

    /**
     * @return self
     */
    protected function sendPostArray(): self
    {
        if ($this->bodyFiles) {
            $this->bodyRequest = $this->sendPostArrayFiles();
        } elseif ($this->isJson) {
            $this->bodyRequest = $this->sendPostArrayJson();
        } elseif ($this->isMultipart) {
            $this->bodyRequest = $this->sendPostArrayMultipart();
        } else {
            $this->bodyRequest = $this->sendPostArrayString();
        }

        return $this->setOption(CURLOPT_POSTFIELDS, $this->bodyRequest);
    }

    /**
     * @return array
     */
    protected function sendPostArrayFiles(): array
    {
        $files = [];

        foreach ($this->bodyFiles as $file) {
            $files[$file['name']] = new CurlFile($file['file'], $file['mime']);
        }

        return $files + $this->body;
    }

    /**
     * @return string
     */
    protected function sendPostArrayJson(): string
    {
        return json_encode($this->body);
    }

    /**
     * @return string
     */
    protected function sendPostArrayMultipart(): string
    {
        $body = '';

        foreach ($this->body as $name => $value) {
            $body .= $this->sendPostArrayMultipartInput($name, $value);
        }

        return $body;
    }

    /**
     * @param string $name
     * @param mixed $value
     *
     * @return string
     */
    protected function sendPostArrayMultipartInput(string $name, mixed $value): string
    {
        $header = '--'.$this->boundary."\r\n"
            .'Content-Disposition: form-data; name="'.$name.'"'."\r\n";

        if (is_array($value) || is_object($value)) {
            $header .= 'Content-Type: application/json;charset=utf-8'."\r\n";
            $value = json_encode($value);
        } elseif (is_bool($value)) {
            $value = $value ? 'true' : 'false';
        } else {
            $value = strval($value);
        }

        return $header."\r\n".$value."\r\n".'--'.$this->boundary.'--'."\r\n";
    }

    /**
     * @return string
     */
    protected function sendPostArrayString(): string
    {
        return http_build_query($this->body, '', '&');
    }

    /**
     * @return self
     */
    protected function sendPostBoolean(): self
    {
        return $this;
    }

    /**
     * @return bool
     */
    protected function cacheEnabled(): bool
    {
        return (($this->method === 'GET') || $this->cachePost)
            && $this->cache->getEnabled();
    }

    /**
     * @return void
     */
    protected function cacheSetData(): void
    {
        if ($this->cacheEnabled()) {
            $this->cache->setData($this->getVars());
        }
    }

    /**
     * @return bool
     */
    protected function cacheGet(): bool
    {
        if ($this->cacheGetEnabled() === false) {
            return false;
        }

        $cached = $this->cache->get();

        $this->response = $cached['response'] ?? null;
        $this->responseHeaders = $cached['responseHeaders'] ?? null;
        $this->info = $cached['info'] ?? null;

        return true;
    }

    /**
     * @return bool
     */
    protected function cacheGetEnabled(): bool
    {
        return $this->cacheEnabled()
            && $this->cache->exists();
    }

    /**
     * @return void
     */
    protected function cacheSet(): void
    {
        if ($this->cacheSetEnabled()) {
            $this->cache->set($this->getVars());
        }
    }

    /**
     * @return bool
     */
    protected function cacheSetEnabled(): bool
    {
        return $this->cacheEnabled()
            && is_string($this->response)
            && ($this->cache->exists() === false);
    }

    /**
     * @return void
     */
    protected function success(): void
    {
        $this->logSet();
        $this->cacheSet();
    }

    /**
     * @return void
     */
    protected function error(): void
    {
        $this->logSet('error', true, $e = $this->exception());

        if ($this->errorReport) {
            report($e);
        }

        $this->retry($e);
    }

    /**
     * @param \App\Services\Curl\CurlException $e
     *
     * @return void
     */
    protected function retry(CurlException $e): void
    {
        if (is_int($this->retryCount)) {
            return;
        }

        $success = false;

        for ($this->retryCount = 0; $this->retryCount < $this->retry; $this->retryCount++) {
            if ($success = $this->retryExec()) {
                break;
            }

            usleep($this->retryWait * 1000);
        }

        $this->retryCount = null;

        if (($success === false) && $this->exception) {
            throw $e;
        }
    }

    /**
     * @return bool
     */
    protected function retryExec(): bool
    {
        $this->sendExec();

        if ($success = $this->sendSuccess()) {
            $this->success();
        } else {
            $this->error();
        }

        return $success;
    }

    /**
     * @return array
     */
    protected function getVars(): array
    {
        $vars = get_object_vars($this);

        unset($vars['curl']);

        return $vars;
    }

    /**
     * @return \App\Services\Curl\CurlException
     */
    protected function exception(): CurlException
    {
        $message = $this->exceptionMessage(strval($this->response));
        $code = $this->exceptionCode(strval($this->response), $this->info['http_code']);

        return new CurlException(substr($message, 0, 1024), $code);
    }

    /**
     * @param string $message
     *
     * @return string
     */
    protected function exceptionMessage(string $message): string
    {
        if (str_starts_with($message, '{') === false) {
            return $message;
        }

        if (empty($json = json_decode($message, true))) {
            return $message;
        }

        return $json['message']
            ?? $json['error']['message']
            ?? $json['error']
            ?? $json['msg']
            ?? $message;
    }

    /**
     * @param string $message
     * @param int $code
     *
     * @return int
     */
    protected function exceptionCode(string $message, int $code): int
    {
        if ($code !== 400) {
            return $code;
        }

        if ($this->isAuthException($message)) {
            return 401;
        }

        return $code;
    }

    /**
     * @param string $message
     *
     * @return bool
     */
    protected function isAuthException(string $message): bool
    {
        return str_contains($message, 'invalid_grant')
            || str_contains($message, 'invalid_request')
            || str_contains($message, 'unsupported_grant_type')
            || str_contains($message, 'unauthorized_client');
    }

    /**
     * @param string $status = 'success'
     * @param bool $force = false
     * @param ?\Throwable $e = null
     *
     * @return void
     */
    protected function logSet(string $status = 'success', bool $force = false, ?Throwable $e = null): void
    {
        $this->logFile($status, $force);

        if ($e) {
            report($e);
        }
    }

    /**
     * @param string $status
     * @param bool $force = false
     *
     * @return void
     */
    protected function logFile(string $status, bool $force = false): void
    {
        if (($this->log === false) && ($force === false)) {
            return;
        }

        $data = $this->getVars();

        if ($this->logBody === false) {
            $data['body'] = 'NO-LOG-BODY';
        }

        if ($this->logContents === false) {
            $data['response'] = 'NO-LOG-CONTENTS';
        } elseif ($this->isJsonResponse && $data['response']) {
            $data['response'] = json_decode($data['response']);
        }

        Log::write($this->url, $status, $data);
    }
}

```

`app/Services/Curl/CurlException.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Curl;

use Exception;

class CurlException extends Exception
{
}

```

`app/Services/Curl/Log.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Curl;

class Log
{
    /**
     * @param string $url
     * @param string $status
     * @param array $data
     *
     * @return void
     */
    public static function write(string $url, string $status, array $data): void
    {
        $dir = storage_path('logs/curl/'.date('Y/m/d'));

        $file = preg_replace(['/[^a-z0-9\-]/', '/\-{2,}/'], ['-', '-'], strtolower($url));
        $file = date('H-i-s').'-'.sprintf('%.4f', microtime(true)).'-'.$status.'-'.substr($file, 0, 200).'.json';

        helper()->mkdir($dir);

        file_put_contents($dir.'/'.$file, helper()->jsonEncode($data), LOCK_EX);
    }
}

```

`app/Services/Database/Logger.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Database;

use DateTime;
use Illuminate\Database\Events\QueryExecuted;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Request;

class Logger
{
    /**
     * @var bool
     */
    protected static bool $listen = false;

    /**
     * @var string
     */
    protected string $base;

    /**
     * @var array
     */
    protected array $files = [];

    /**
     * @var array
     */
    protected array $connections = [];

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @return self
     */
    public function __construct()
    {
        $this->base();
        $this->connections();
    }

    /**
     * @return void
     */
    protected function base(): void
    {
        $this->base = base_path();
    }

    /**
     * @return void
     */
    protected function connections(): void
    {
        if ($this->enabled() !== true) {
            return;
        }

        foreach (config('database.connections') as $name => $config) {
            if ($this->connectionEnabled($config)) {
                $this->connections[$name] = $config;
            }
        }
    }

    /**
     * @return bool
     */
    protected function enabled(): bool
    {
        return (static::$listen === false)
            && (config('logging.channels.database.enabled') === true);
    }

    /**
     * @param array $config
     *
     * @return bool
     */
    protected function connectionEnabled(array $config): bool
    {
        return ($config['log'] ?? false) === true;
    }

    /**
     * @return void
     */
    public function listen(): void
    {
        $this->listenSetup();
        $this->listenStart();

        static::$listen = true;
    }

    /**
     * @return void
     */
    protected function listenSetup(): void
    {
        foreach (array_keys($this->connections) as $name) {
            $this->listenSetupConnection($name);
        }
    }

    /**
     * @param string $name
     *
     * @return void
     */
    protected function listenSetupConnection(string $name): void
    {
        $this->file($name);

        helper()->mkdir($this->files[$name], true);

        $this->write($name, '['.date('Y-m-d H:i:s').'] ['.Request::method().'] '.Request::fullUrl());
    }

    /**
     * @return void
     */
    public function listenStart(): void
    {
        DB::listen(fn ($query) => $this->listenConnectionLog($query->connectionName, $query));
    }

    /**
     * @param string $name
     * @param \Illuminate\Database\Events\QueryExecuted $query
     *
     * @return void
     */
    protected function listenConnectionLog(string $name, QueryExecuted $query): void
    {
        $connection = $this->connections[$name] ?? null;

        if (empty($connection)) {
            return;
        }

        $sql = $query->sql;
        $bindings = $query->bindings;

        foreach ($bindings as $i => $binding) {
            if ($binding instanceof DateTime) {
                $bindings[$i] = $binding->format('Y-m-d H:i:s');
            } elseif (is_string($binding)) {
                $bindings[$i] = "'{$binding}'";
            } elseif (is_bool($binding)) {
                $bindings[$i] = $binding ? 'true' : 'false';
            }

            if (is_string($i)) {
                $sql = str_replace(':'.$i, (string)$bindings[$i], $sql);
            }
        }

        $log = [];

        if ($connection['log_backtrace']) {
            $log[] = '# '.$this->backtrace();
        }

        if ($connection['log_time']) {
            $log[] = '# Time: '.sprintf('%0.5f', $query->time / 1000);
        }

        $log[] = "\n".$this->normalizeSql($sql, $bindings);

        $this->write($name, implode("\n", $log));
    }

    /**
     * @return string
     */
    protected function backtrace(): string
    {
        $backtrace = current(array_filter(debug_backtrace(2), fn ($line) => $this->backtraceIsValid($line)));

        if (empty($backtrace)) {
            return '';
        }

        return str_replace($this->base, '', $backtrace['file']).'#'.$backtrace['line'];
    }

    /**
     * @param array $line
     *
     * @return bool
     */
    protected function backtraceIsValid(array $line): bool
    {
        $file = $line['file'] ?? null;

        if (empty($file) || ($file === __FILE__)) {
            return false;
        }

        return str_starts_with($file, $this->base.'/app/')
            || str_starts_with($file, $this->base.'/config/')
            || str_starts_with($file, $this->base.'/database/');
    }

    /**
     * @param string $sql
     * @param array $bindings
     *
     * @return string
     */
    protected function normalizeSql(string $sql, array $bindings): string
    {
        return preg_replace(["/\n+/", "/\n\s+/"], ["\n", ' '], vsprintf(str_replace(['%', '?'], ['%%', '%s'], $sql), $bindings));
    }

    /**
     * @param string $name
     *
     * @return void
     */
    protected function file(string $name): void
    {
        $file = array_filter(explode('-', preg_replace('/[^a-z0-9]+/i', '-', Request::path())));
        $file = implode('-', array_map(fn ($value) => substr($value, 0, 20), $file)) ?: '-';

        $this->files[$name] = storage_path('logs/query/'.$name.'/'.date('Y/m/d').'/'.substr($file, 0, 150).'.log');
    }

    /**
     * @param string $name
     * @param string $message
     *
     * @return void
     */
    protected function write(string $name, string $message): void
    {
        file_put_contents($this->files[$name], "\n".$message."\n", FILE_APPEND | LOCK_EX);
    }
}

```

`app/Services/Filesystem/Directory.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Filesystem;

use Generator;
use RecursiveDirectoryIterator;
use RecursiveIteratorIterator;
use RegexIterator;
use SplFileInfo;

class Directory
{
    /**
     * @param string $dir
     * @param ?string $include = null
     * @param ?string $exclude = null
     *
     * @return \Generator
     */
    public static function files(string $dir, ?string $include = null, ?string $exclude = null): Generator
    {
        if (is_dir($dir) === false) {
            return [];
        }

        foreach (static::directoryIterator($dir, $include) as $file) {
            if (static::filesValid($file, $exclude)) {
                yield $file->getPathName();
            }
        }
    }

    /**
     * @param string $dir
     * @param ?string $include = null
     * @param ?string $exclude = null
     *
     * @return array
     */
    public static function directories(string $dir, ?string $include = null, ?string $exclude = null): array
    {
        if (is_dir($dir) === false) {
            return [];
        }

        $directories = [];

        foreach (static::directoryIterator($dir, $include) as $file) {
            if (static::directoriesValid($file, $exclude)) {
                $directories[] = $file->getPathName();
            }
        }

        return $directories;
    }

    /**
     * @param string $dir
     * @param ?string $include
     *
     * @return \RecursiveIteratorIterator|\RegexIterator
     */
    protected static function directoryIterator(string $dir, ?string $include): RecursiveIteratorIterator|RegexIterator
    {
        $iterator = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($dir), RecursiveIteratorIterator::SELF_FIRST);

        if ($include) {
            $iterator = new RegexIterator($iterator, $include);
        }

        return $iterator;
    }

    /**
     * @param \SplFileInfo $file
     * @param ?string $exclude
     *
     * @return bool
     */
    protected static function filesValid(SplFileInfo $file, ?string $exclude): bool
    {
        if ($file->isDir()) {
            return false;
        }

        return empty($exclude)
            || (preg_match($exclude, $file->getPathName()) === 0);
    }

    /**
     * @param \SplFileInfo $file
     * @param ?string $exclude
     *
     * @return bool
     */
    protected static function directoriesValid(SplFileInfo $file, ?string $exclude): bool
    {
        if ($file->isFile()) {
            return false;
        }

        return empty($exclude)
            || (preg_match($exclude, $file->getPathName()) === 0);
    }

    /**
     * @param string $dir
     * @param bool $file = false
     *
     * @return string
     */
    public static function create(string $dir, bool $file = false): string
    {
        return helper()->mkdir($dir, $file);
    }
}

```

`app/Services/Filesystem/File.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Filesystem;

class File
{
    /**
     * @param string $file
     * @param string|array $contents
     * @param bool $array = false
     *
     * @return void
     */
    public static function write(string $file, $contents, bool $array = false): void
    {
        Directory::create($file, true);

        file_put_contents($file, $array ? static::array($contents) : $contents, LOCK_EX);
    }

    /**
     * @param array $array
     *
     * @return string
     */
    protected static function array(array $array): string
    {
        $array = static::ksort($array);

        $export = var_export($array, true);
        $export = preg_replace('/^([ ]*)(.*)/m', '$1$1$2', $export);

        $export = preg_split('/\r\n|\n|\r/', $export);
        $export = preg_replace(['/\s*array\s\($/', '/\)(,)?$/', '/\s=>\s$/'], [null, ']$1', ' => ['], $export);

        $export = implode(PHP_EOL, array_filter(['['] + (array)$export));
        $export = preg_replace('(\d+\s=>\s)', '', $export);

        return '<?php return '.trim($export).';'."\n";
    }

    /**
     * @param array $array
     *
     * @return array
     */
    protected static function ksort(array $array): array
    {
        ksort($array);

        return array_map(static fn ($value) => is_array($value) ? static::ksort($value) : $value, $array);
    }
}

```

`app/Services/Gpx/Read.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Gpx;

use phpGPX\Models\GpxFile;
use phpGPX\Models\Point;
use phpGPX\phpGPX;

class Read
{
    /**
     * @var \phpGPX\Models\GpxFile
     */
    protected GpxFile $gpx;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param string $file
     *
     * @return self
     */
    public function __construct(protected string $file)
    {
        $this->gpx = (new phpGPX())->load($this->file);
    }

    /**
     * @return array
     */
    public function toArray(): array
    {
        return $this->map($this->sort($this->getPoints()));
    }

    /**
     * @return array
     */
    protected function getPoints(): array
    {
        $points = [];

        foreach ($this->gpx->tracks as $track) {
            foreach ($track->segments as $segment) {
                foreach ($segment->points as $point) {
                    if ($this->pointIsValid($point)) {
                        $points[] = $point;
                    }
                }
            }
        }

        return $points;
    }

    /**
     * @param \phpGPX\Models\Point $point
     *
     * @return bool
     */
    protected function pointIsValid(Point $point): bool
    {
        return $point->latitude
            && $point->longitude
            && $point->time;
    }

    /**
     * @param array $points
     *
     * @return array
     */
    protected function sort(array $points): array
    {
        usort($points, static fn ($a, $b) => $a->time->getTimestamp() <=> $b->time->getTimestamp());

        return $points;
    }

    /**
     * @param array $points
     *
     * @return array
     */
    protected function map(array $points): array
    {
        $data = [];

        foreach ($points as $i => $point) {
            $data[] = $this->mapPoint($point, $points[$i - 1] ?? null, $points[$i + 1] ?? null);
        }

        return $data;
    }

    /**
     * @param \phpGPX\Models\Point $point
     * @param ?\phpGPX\Models\Point $previous
     * @param ?\phpGPX\Models\Point $next
     *
     * @return array
     */
    protected function mapPoint(Point $point, ?Point $previous, ?Point $next): array
    {
        return [
            'latitude' => $point->latitude,
            'longitude' => $point->longitude,
            'timestamp' => $point->time->getTimestamp(),
            'speed' => $this->mapPointSpeed($point, $previous),
            'direction' => $this->mapPointDirection($point, $previous, $next),
        ];
    }

    /**
     * @param \phpGPX\Models\Point $point
     * @param ?\phpGPX\Models\Point $previous
     *
     * @return float
     */
    protected function mapPointSpeed(Point $point, ?Point $previous): float
    {
        if ($speed = $point->extensions->trackPointExtension?->speed) {
            return $speed;
        }

        if ($previous === null) {
            return 0;
        }

        $distance = helper()->coordinatesDistance(
            $previous->latitude,
            $previous->longitude,
            $point->latitude,
            $point->longitude,
        );

        $time = $point->time->getTimestamp() - $previous->time->getTimestamp();

        return round($distance / $time * 3.6, 2);
    }

    /**
     * @param \phpGPX\Models\Point $point
     * @param ?\phpGPX\Models\Point $previous
     * @param ?\phpGPX\Models\Point $next
     *
     * @return int
     */
    protected function mapPointDirection(Point $point, ?Point $previous, ?Point $next): int
    {
        if ($course = $point->extensions->trackPointExtension?->course) {
            return $course;
        }

        if ($next) {
            return helper()->coordinatesDirection(
                $point->latitude,
                $point->longitude,
                $next->latitude,
                $next->longitude,
            );
        }

        if ($previous) {
            return helper()->coordinatesDirection(
                $previous->latitude,
                $previous->longitude,
                $point->latitude,
                $point->longitude,
            );
        }

        return 0;
    }
}

```

`app/Services/Gpx/Write.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Gpx;

use DateTime;
use DateTimeZone;
use phpGPX\Models\Extensions;
use phpGPX\Models\Extensions\TrackPointExtension;
use phpGPX\Models\GpxFile;
use phpGPX\Models\Metadata;
use phpGPX\Models\Point;
use phpGPX\Models\Segment;
use phpGPX\Models\Track;
use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as TripModel;

class Write
{
    /**
     * @var \phpGPX\Models\GpxFile
     */
    protected GpxFile $gpx;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param \App\Domains\Trip\Model\Trip $trip
     *
     * @return self
     */
    public function __construct(protected TripModel $trip)
    {
    }

    /**
     * @return self
     */
    public function generate(): self
    {
        $this->gpx();
        $this->track();

        return $this;
    }

    /**
     * @return string
     */
    public function toXml(): string
    {
        return $this->gpx->toXML()->saveXML();
    }

    /**
     * @return self
     */
    protected function gpx(): self
    {
        $this->gpx = new GpxFile();
        $this->gpx->metadata = new Metadata();
        $this->gpx->metadata->time = $this->datetime($this->trip->start_at, $this->trip->timezone->zone);
        $this->gpx->metadata->description = $this->trip->name;

        return $this;
    }

    /**
     * @return self
     */
    protected function track(): self
    {
        $track = new Track();
        $track->name = $this->trip->name;
        $track->source = 'eusonlito/GPS-Tracker';

        $segment = new Segment();

        foreach ($this->positions() as $position) {
            $segment->points[] = $this->point($position);
        }

        $track->segments[] = $segment;
        $track->recalculateStats();

        $this->gpx->tracks[] = $track;

        return $this;
    }

    /**
     * @return \App\Domains\Position\Model\Collection\Position
     */
    protected function positions(): PositionCollection
    {
        return $this->trip
            ->positions()
            ->orderByDateUtcAtAsc()
            ->withTimezone()
            ->get();
    }

    /**
     * @param \App\Domains\Position\Model\Position $position
     *
     * @return \phpGPX\Models\Point
     */
    protected function point(PositionModel $position): Point
    {
        $point = new Point(Point::TRACKPOINT);
        $point->latitude = $position->latitude;
        $point->longitude = $position->longitude;
        $point->time = $this->datetime($position->date_at, $position->timezone->zone);

        $trackPointExtension = new TrackPointExtension();
        $trackPointExtension->speed = $position->speed;
        $trackPointExtension->course = $position->direction;

        $extensions = new Extensions();
        $extensions->trackPointExtension = $trackPointExtension;

        $point->extensions = $extensions;

        return $point;
    }

    /**
     * @param string $date
     * @param string $timezone
     *
     * @return \DateTime
     */
    protected function datetime(string $date, string $timezone): DateTime
    {
        return new DateTime($date, new DateTimeZone($timezone));
    }
}

```

`app/Services/Helper/Helper.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Helper;

use App\Services\Helper\Traits\Arrays as ArraysTrait;
use App\Services\Helper\Traits\Custom as CustomTrait;
use App\Services\Helper\Traits\Date as DateTrait;
use App\Services\Helper\Traits\Exception as ExceptionTrait;
use App\Services\Helper\Traits\File as FileTrait;
use App\Services\Helper\Traits\Geo as GeoTrait;
use App\Services\Helper\Traits\Misc as MiscTrait;
use App\Services\Helper\Traits\Number as NumberTrait;
use App\Services\Helper\Traits\Unit as UnitTrait;

class Helper
{
    use ArraysTrait;
    use CustomTrait;
    use DateTrait;
    use ExceptionTrait;
    use FileTrait;
    use GeoTrait;
    use MiscTrait;
    use NumberTrait;
    use UnitTrait;

    /**
     * @var array
     */
    protected array $cache = [];
}

```

`app/Services/Helper/Service.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Helper;

use App\Services\View\Message;

class Service
{
    /**
     * @return \App\Services\View\Message
     */
    public function message(): Message
    {
        return Message::instance();
    }
}

```

`app/Services/Helper/Traits/Arrays.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Helper\Traits;

use RecursiveArrayIterator;
use RecursiveIteratorIterator;
use Stringable;

trait Arrays
{
    /**
     * @param array $array
     * @param string $key
     *
     * @return array
     */
    public function arrayColumnUniqueFilter(array $array, string $key): array
    {
        return $this->arrayUniqueFilter(array_column($array, $key));
    }

    /**
     * @param array $array
     *
     * @return array
     */
    public function arrayUniqueFilter(array $array): array
    {
        return array_values(array_filter(array_unique($array)));
    }

    /**
     * @param string $key
     *
     * @return string
     */
    public function arrayKeyDot(string $key): string
    {
        return rtrim(str_replace(['][', '[', ']'], ['.', '.', ''], $key), '.');
    }

    /**
     * @param array $array
     * @param array $keys
     *
     * @return array
     */
    public function arrayKeysWhitelist(array $array, array $keys): array
    {
        return array_intersect_key($array, array_flip($keys));
    }

    /**
     * @param array $array
     * @param array $keys
     *
     * @return array
     */
    public function arrayKeysBlacklist(array $array, array $keys): array
    {
        return array_diff_key($array, array_flip($keys));
    }

    /**
     * @param array $array
     * @param array $values
     *
     * @return array
     */
    public function arrayValuesWhitelist(array $array, array $values): array
    {
        return array_intersect($array, $values);
    }

    /**
     * @param array $array
     * @param array $values
     *
     * @return array
     */
    public function arrayValuesBlacklist(array $array, array $values): array
    {
        return array_diff($array, $values);
    }

    /**
     * @param array $array
     * @param ?callable $callback = null
     *
     * @return array
     */
    public function arrayFilterRecursive(array $array, ?callable $callback = null): array
    {
        $callback ??= static fn ($value) => (bool)$value;

        return array_filter(array_map(fn ($value) => is_array($value) ? $this->arrayFilterRecursive($value, $callback) : $value, $array), $callback);
    }

    /**
     * @param array $array
     * @param callable $callback
     * @param bool $values_only = true
     *
     * @return array
     */
    public function arrayMapRecursive(array $array, callable $callback, bool $values_only = true): array
    {
        $keys = array_keys($array);

        $map = function ($value, $key) use ($callback, $values_only) {
            if (is_array($value) === false) {
                return $callback($value, $key);
            }

            if ($values_only) {
                return $this->arrayMapRecursive($value, $callback, $values_only);
            }

            return $this->arrayMapRecursive($callback($value, $key), $callback, $values_only);
        };

        return array_combine($keys, array_map($map, $array, $keys));
    }

    /**
     * @param array $array
     * @param callable $callback
     *
     * @return array
     */
    public function arrayMapKeyValue(array $array, callable $callback): array
    {
        return array_combine($keys = array_keys($array), array_map($callback, $keys, $array));
    }

    /**
     * @param array $array
     *
     * @return array
     */
    public function arrayFlatten(array $array): array
    {
        return iterator_to_array(new RecursiveIteratorIterator(new RecursiveArrayIterator($array)), true);
    }

    /**
     * @param array $array
     * @param array $exclude = []
     * @param array $include = []
     *
     * @return array
     */
    public function arrayValuesRecursive(array $array, array $exclude = [], array $include = []): array
    {
        $result = [];

        foreach ($array as $key => $value) {
            if ($exclude && in_array($key, $exclude)) {
                continue;
            }

            if (is_array($value)) {
                $result = array_merge($result, $this->arrayValuesRecursive($value, $exclude, $include));
            } elseif (empty($include) || in_array($key, $include)) {
                $result[] = $value;
            }
        }

        return $result;
    }

    /**
     * @param array $array
     *
     * @return bool
     */
    public function arrayIsAssociative(array $array): bool
    {
        return ($keys = array_keys($array)) !== array_keys($keys);
    }

    /**
     * @param array $array
     *
     * @return string
     */
    public function arrayHtmlAttributes(array $array): string
    {
        return implode(' ', array_filter(array_map(function ($key, $value) {
            if (is_bool($value)) {
                return $key;
            }

            if (is_string($value) || ($value instanceof Stringable)) {
                return $key.'='.htmlentities((string)$value);
            }

            return '';
        }, array_keys($array), $array)));
    }

    /**
     * @param string $string
     * @param array $list
     *
     * @return bool
     */
    public function startsWithArray(string $string, array $list): bool
    {
        foreach ($list as $each) {
            if (str_starts_with($string, $each)) {
                return true;
            }
        }

        return false;
    }
}

```

`app/Services/Helper/Traits/Custom.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Helper\Traits;

trait Custom
{
    /**
     * @param int $meters
     * @param int $decimals = 2
     *
     * @return string
     */
    public function distanceHuman(int $meters, int $decimals = 2): string
    {
        if ($meters >= 1000) {
            $meters /= 1000;
            $units = 'km';
        } else {
            $decimals = 0;
            $units = 'm';
        }

        return $this->number($meters, $decimals).' '.$units;
    }
}

```

`app/Services/Helper/Traits/Date.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Helper\Traits;

use DateTime;
use DateTimeZone;
use IntlDateFormatter;
use Throwable;

trait Date
{
    /**
     * @param int $seconds
     *
     * @return string
     */
    public function timeHuman(int $seconds): string
    {
        return sprintf('%02d:%02d:%02d', floor($seconds / 3600), fmod(floor($seconds / 60), 60), floor(fmod($seconds, 60)));
    }

    /**
     * @param ?string $date
     * @param bool $hour = true
     * @param bool $second = false
     * @param ?string $default = '-'
     *
     * @return ?string
     */
    public function dateLocal(?string $date, bool $hour = true, bool $second = false, ?string $default = '-'): ?string
    {
        if (empty($date)) {
            return $default;
        }

        $time = strtotime($date);

        if ($time === false) {
            return $default;
        }

        $format = 'd/m/Y';

        if (str_contains($date, ' ')) {
            $format .= $hour ? ' H:i' : '';
            $format .= ($hour && $second) ? ':s' : '';
        }

        return date($format, $time);
    }

    /**
     * @param ?string $date
     * @param ?string $default = null
     *
     * @return ?string
     */
    public function dateToDate(?string $date, ?string $default = null): ?string
    {
        if (empty($date)) {
            return $default;
        }

        [$day, $time] = explode(' ', $date) + ['', ''];

        if (str_contains($day, ':')) {
            [$day, $time] = [$time, $day];
        }

        if (!preg_match('#^[0-9]{1,4}[/\-][0-9]{1,2}[/\-][0-9]{1,4}$#', $day)) {
            return $default;
        }

        if ($time) {
            if (substr_count($time, ':') === 1) {
                $time .= ':00';
            }

            if (!preg_match('#^[0-9]{1,2}:[0-9]{1,2}:[0-9]{1,2}$#', $time)) {
                return $default;
            }
        }

        $day = preg_split('#[/\-]#', $day);

        if (strlen($day[0]) !== 4) {
            $day = array_reverse($day);
        }

        return trim(implode('-', $day).' '.$time);
    }

    /**
     * @param string $format_from
     * @param string $date
     * @param string $timezone
     * @param string $format_to = 'Y-m-d H:i:s'
     *
     * @return string
     */
    public function dateUtcToTimezone(string $format_from, string $date, string $timezone, string $format_to = 'Y-m-d H:i:s'): string
    {
        return $this->dateToTimezone($format_from, $date, 'UTC', $timezone, $format_to);
    }

    /**
     * @param string $format_from
     * @param string $date
     * @param string $timezone
     * @param string $format_to = 'Y-m-d H:i:s'
     *
     * @return string
     */
    public function dateTimezoneToUtc(string $format_from, string $date, string $timezone, string $format_to = 'Y-m-d H:i:s'): string
    {
        return $this->dateToTimezone($format_from, $date, $timezone, 'UTC', $format_to);
    }

    /**
     * @param string $format_from
     * @param string $date
     * @param string $timezone_from
     * @param string $timezone_to
     * @param string $format_to = 'c'
     *
     * @return string
     */
    public function dateToTimezone(
        string $format_from,
        string $date,
        string $timezone_from,
        string $timezone_to,
        string $format_to = 'c'
    ): string {
        if ((substr_count($date, ':') === 1) && (substr_count($format_from, ':') === 2)) {
            $date .= ':00';
        }

        if (str_starts_with($format_from, 'Y') && preg_match('/^[0-9]{2}[\/\-]/', $date)) {
            $date = $this->dateToDate($date);
        }

        if (str_contains($date, '+') && (str_contains($format_from, '+') === false)) {
            $format_from .= 'O';
        }

        $timezone = $this->dateTimeZone($timezone_from);
        $datetime = DateTime::createFromFormat($format_from, $date, $timezone);

        try {
            $datetime = $datetime ?: new DateTime($date, $timezone);
        } catch (Throwable $e) {
            $datetime = new DateTime('now', $timezone);
        }

        return $datetime->setTimezone($this->dateTimeZone($timezone_to))->format($format_to);
    }

    /**
     * @param ?string $date = null
     * @param ?string $timezone = null
     *
     * @return \Datetime
     */
    public function dateTimeWithTimezone(?string $date = null, ?string $timezone = null): Datetime
    {
        $timezone = $this->dateTimeZone($timezone);

        try {
            return new DateTime($date ?: 'now', $timezone);
        } catch (Throwable $e) {
            return new DateTime('now', $timezone);
        }
    }

    /**
     * @param string $date
     * @param string $timezone
     * @param string $format = 'Y-m-d H:i:s'
     *
     * @return string
     */
    public function dateFormattedToTimezone(string $date, string $timezone, string $format = 'Y-m-d H:i:s'): string
    {
        return $this->dateTimeWithTimezone($date, $timezone)->format($format);
    }

    /**
     * @param string $timezone
     *
     * @return \DateTimeZone
     */
    public function dateTimeZone(string $timezone): DateTimeZone
    {
        static $cache;

        return $cache[$timezone] ??= new DateTimeZone($timezone);
    }

    /**
     * @param ?string $country
     *
     * @return array
     */
    public function countryTimezones(?string $country): array
    {
        if ($country === null) {
            return DateTimeZone::listIdentifiers();
        }

        return DateTimeZone::listIdentifiers(DateTimeZone::PER_COUNTRY, strtoupper($country))
            ?: DateTimeZone::listIdentifiers();
    }

    /**
     * @param string $locale = 'es_ES'
     *
     * @return array
     */
    public function months(string $locale = 'es_ES'): array
    {
        static $cache = [];

        if (isset($cache[$locale])) {
            return $cache[$locale];
        }

        $format = function ($index) use ($locale) {
            $formatter = new IntlDateFormatter($locale);
            $formatter->setPattern('MMMM');

            return ucfirst($formatter->format(mktime(0, 0, 0, $index)));
        };

        return $cache[$locale] = array_combine(
            range(1, 12),
            array_map(static fn ($index) => $format($index), range(1, 12))
        );
    }
}

```

`app/Services/Helper/Traits/Exception.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Helper\Traits;

use Error;
use ErrorException;
use LogicException;
use RuntimeException;
use Throwable;
use App\Exceptions\NotFoundException;

trait Exception
{
    /**
     * @param string $message = ''
     * @param string $code = ''
     *
     * @throws \App\Exceptions\NotFoundException
     *
     * @return void
     */
    public function notFound(string $message = '', string $code = ''): void
    {
        throw new NotFoundException($message ?: __('common.error.not-found'), 404, null, $code);
    }

    /**
     * @param \Throwable $e
     *
     * @return bool
     */
    public function isExceptionSystem(Throwable $e): bool
    {
        return ($e instanceof Error)
            || ($e instanceof ErrorException)
            || ($e instanceof LogicException)
            || ($e instanceof RuntimeException);
    }
}

```

`app/Services/Helper/Traits/File.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Helper\Traits;

use Exception;

trait File
{
    /**
     * @param string $dir
     * @param bool $file = false
     *
     * @return string
     */
    public function mkdir(string $dir, bool $file = false): string
    {
        if ($file) {
            $dir = dirname($dir);
        }

        clearstatcache(true, $dir);

        if (is_dir($dir)) {
            return $dir;
        }

        try {
            mkdir($dir, 0o755, true);
        } catch (Exception $e) {
            report($e);
        }

        return $dir;
    }

    /**
     * @param string $file
     * @param string $contents
     *
     * @return void
     */
    public function filePutContents(string $file, string $contents): void
    {
        $this->mkdir($file, true);

        file_put_contents($file, $contents, LOCK_EX);
    }
}

```

`app/Services/Helper/Traits/Geo.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Helper\Traits;

use DateTimeZone;
use stdClass;

trait Geo
{
    /**
     * @param float $latitude
     *
     * @return float
     */
    public function latitude(float $latitude): float
    {
        return max(-89.99999, min(89.99999, $latitude));
    }

    /**
     * @param float $longitude
     *
     * @return float
     */
    public function longitude(float $longitude): float
    {
        return max(-179.99999, min(179.99999, $longitude));
    }

    /**
     * @param float $lat1
     * @param float $lng1
     * @param float $lat2
     * @param float $lng2
     *
     * @return float
     */
    public function coordinatesDistance(float $lat1, float $lng1, float $lat2, float $lng2): float
    {
        static $x = M_PI / 180;

        $lat1 *= $x;
        $lng1 *= $x;
        $lat2 *= $x;
        $lng2 *= $x;

        $distance = 2 * asin(sqrt(pow(sin(($lat1 - $lat2) / 2), 2) + cos($lat1) * cos($lat2) * pow(sin(($lng1 - $lng2) / 2), 2)));

        return $distance * 6378137;
    }

    /**
     * @param float $lat1
     * @param float $lng1
     * @param float $lat2
     * @param float $lng2
     *
     * @return int
     */
    public function coordinatesDirection(float $lat1, float $lng1, float $lat2, float $lng2): int
    {
        static $x = M_PI / 180;

        $lat1 *= $x;
        $lng1 *= $x;
        $lat2 *= $x;
        $lng2 *= $x;

        $delta = $lng2 - $lng1;

        $y = sin($delta) * cos($lat2);
        $x = cos($lat1) * sin($lat2) - sin($lat1) * cos($lat2) * cos($delta);

        return round(rad2deg(atan2($y, $x)) + 360) % 360;
    }

    /**
     * @param array $geojson
     *
     * @return array
     */
    public function geoJsonBoundingBox(array $geojson): array
    {
        $polygon = $geojson['features'][0]['geometry']['coordinates'] ?? null;

        if (empty($polygon)) {
            return [[0, 0], [0, 0]];
        }

        $minLat = INF;
        $maxLat = -INF;
        $minLng = INF;
        $maxLng = -INF;

        foreach ($polygon as $contour) {
            foreach ($contour as $coordinates) {
                $lng = $coordinates[0];
                $lat = $coordinates[1];

                $minLat = min($minLat, $lat);
                $maxLat = max($maxLat, $lat);
                $minLng = min($minLng, $lng);
                $maxLng = max($maxLng, $lng);
            }
        }

        return [[$minLng, $minLat], [$maxLng, $maxLat]];
    }

    /**
     * @param float $latitude
     * @param float $longitude
     * @param array $bbox
     *
     * @return bool
     */
    public function latitudeLongitudeInBoundingBox(float $latitude, float $longitude, array $bbox): bool
    {
        return ($bbox[0][0] <= $longitude)
            && ($bbox[0][1] <= $latitude)
            && ($bbox[1][0] >= $longitude)
            && ($bbox[1][1] >= $latitude);
    }

    /**
     * @param float $latitude
     * @param float $longitude
     * @param array $geojson
     *
     * @return bool
     */
    public function latitudeLongitudeInGeoJsonBoundingBox(float $latitude, float $longitude, array $geojson): bool
    {
        return $this->latitudeLongitudeInBoundingBox($latitude, $longitude, $this->geoJsonBoundingBox($geojson));
    }

    /**
     * @param float $latitude
     * @param float $longitude
     * @param array $geojson
     *
     * @return ?bool
     */
    public function latitudeLongitudeInsideGeoJson(float $latitude, float $longitude, array $geojson): ?bool
    {
        $coordinates = $geojson['features'][0]['geometry']['coordinates'][0] ?? null;

        if (empty($coordinates)) {
            return null;
        }

        if ($this->latitudeLongitudeInGeoJsonBoundingBox($latitude, $longitude, $geojson) === false) {
            return false;
        }

        $inside = false;
        $n = count($coordinates);

        for ($i = 0, $j = $n - 1; $i < $n; $j = $i++) {
            $xi = $coordinates[$i][0];
            $yi = $coordinates[$i][1];
            $xj = $coordinates[$j][0];
            $yj = $coordinates[$j][1];

            if ((($yi > $latitude) !== ($yj > $latitude)) && ($longitude < ($xj - $xi) * ($latitude - $yi) / ($yj - $yi) + $xi)) {
                $inside = $inside === false;
            }
        }

        return $inside;
    }

    /**
     * @param float $latitude
     * @param float $longitude
     * @param ?string $country = null
     *
     * @return string
     */
    public function latitudeLongitudeTimezone(float $latitude, float $longitude, ?string $country = null): string
    {
        $timezones = $this->countryTimezones($country);

        if (count($timezones) === 1) {
            return $timezones[0];
        }

        $timezone = null;
        $tz_distance = 0;

        foreach ($timezones as $id) {
            $location = timezone_location_get(new DateTimeZone($id));

            $distance = (sin(deg2rad($latitude)) * sin(deg2rad($location['latitude'])))
                + (cos(deg2rad($latitude)) * cos(deg2rad($location['latitude'])) * cos(deg2rad($longitude - $location['longitude'])));

            $distance = abs(rad2deg(acos($distance)));

            if ($timezone && ($tz_distance < $distance)) {
                continue;
            }

            $timezone = $id;
            $tz_distance = $distance;
        }

        return $timezone;
    }

    /**
     * @param int $mcc
     * @param int $mnc
     *
     * @return ?\stdClass
     */
    public function mcc(int $mcc, int $mnc): ?stdClass
    {
        static $cache = [];

        if (isset($cache[$mcc][$mnc])) {
            return $cache[$mcc][$mnc];
        }

        $country = [];

        foreach ($this->mccs() as $each) {
            if ($each->mcc !== $mcc) {
                continue;
            }

            if ($each->mnc === $mnc) {
                return $cache[$mcc][$mnc] = $each;
            }

            $country[$each->iso][] = $each;
        }

        if (empty($country)) {
            return null;
        }

        usort($country, static fn ($a, $b) => count($a) > count($b) ? -1 : 1);

        return $cache[$mcc][$mnc] = $country[0][0];
    }

    /**
     * @return array
     */
    public function mccs(): array
    {
        static $cache;

        return $cache ??= json_decode(file_get_contents(base_path('resources/app/mcc/mcc.json')));
    }
}

```

`app/Services/Helper/Traits/Misc.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Helper\Traits;

trait Misc
{
    /**
     * @return string
     */
    public function uuid(): string
    {
        $data = random_bytes(16);

        $data[6] = chr(ord($data[6]) & 0x0F | 0x40);
        $data[8] = chr(ord($data[8]) & 0x3F | 0x80);

        return vsprintf('%s%s-%s-%s-%s-%s%s%s', str_split(bin2hex($data), 4));
    }

    /**
     * @param mixed $uuid
     *
     * @return bool
     */
    public function uuidIsValid(mixed $uuid): bool
    {
        return is_string($uuid) && preg_match('/^[a-f\d]{8}(-[a-f\d]{4}){4}[a-f\d]{8}$/i', $uuid);
    }

    /**
     * @param int $length
     * @param bool $safe = false
     * @param ?string $case = null
     *
     * @return string
     */
    public function uniqidReal(int $length, bool $safe = false, ?string $case = null): string
    {
        if ($safe) {
            $string = '23456789bcdfghjkmnpqrstwxyzBCDFGHJKMNPQRSTWXYZ';
        } else {
            $string = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
        }

        $string = match ($case) {
            'lower' => strtolower($string),
            'upper' => strtoupper($string),
            default => $string,
        };

        return substr(str_shuffle(str_repeat($string, rand((int)($length / 2), $length))), 0, $length);
    }

    /**
     * @param mixed $value
     *
     * @return ?string
     */
    public function jsonEncode($value): ?string
    {
        if ($value === null) {
            return null;
        }

        return json_encode($value, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE | JSON_PARTIAL_OUTPUT_ON_ERROR);
    }

    /**
     * @param array $query
     *
     * @return string
     */
    public function query(array $query): string
    {
        return http_build_query($query + request()->query());
    }

    /**
     * @param string $string
     *
     * @return string
     */
    public function simpleName(string $string): string
    {
        return ucwords($this->simpleString($string), ' ');
    }

    /**
     * @param string $string
     *
     * @return string
     */
    public function simpleString(string $string): string
    {
        return str_slug($string, ' ');
    }
}

```

`app/Services/Helper/Traits/Number.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Helper\Traits;

trait Number
{
    /**
     * @param ?float $value
     * @param int $decimals = 2
     * @param ?string $default = '-'
     *
     * @return ?string
     */
    public function number(?float $value, int $decimals = 2, ?string $default = '-'): ?string
    {
        if ($value === null) {
            return $default;
        }

        return number_format($value, $decimals, ',', '.');
    }

    /**
     * @param ?float $value
     * @param int $decimals = 2
     * @param string $symbol = '€'
     *
     * @return ?string
     */
    public function money(?float $value, int $decimals = 2, string $symbol = '€'): ?string
    {
        return $this->number($value, $decimals).' '.$symbol;
    }

    /**
     * @param float $bytes
     * @param int $decimals = 2
     *
     * @return string
     */
    public function sizeHuman(float $bytes, int $decimals = 2): string
    {
        if ($bytes === 0.0) {
            return '0 B';
        }

        $e = floor(log($bytes, 1024));
        $pow = pow(1024, $e) ?: 1;
        $size = round($bytes / $pow, $decimals);
        $unit = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'][$e];

        return number_format($size, $decimals, ',', '.').' '.$unit;
    }
}

```

`app/Services/Helper/Traits/Unit.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Helper\Traits;

use UnexpectedValueException;

trait Unit
{
    /**
     * @param string $type
     * @param float $value
     * @param int $round = 2
     *
     * @return float
     */
    public function unit(string $type, float $value, int $round = 2): float
    {
        return match ($type) {
            'money' => $this->unitMoney($value, $round),
            'volume' => $this->unitVolume($value, $round),
            'distance' => $this->unitDistance($value, $round),
            'speed' => $this->unitSpeed($value, $round),
            default => $this->unitException($type),
        };
    }

    /**
     * @param string $type
     * @param float $value
     * @param int $round = 2
     *
     * @return string
     */
    public function unitHuman(string $type, float $value, int $round = 2): string
    {
        return match ($type) {
            'money' => $this->unitMoneyHuman($value, $round),
            'volume' => $this->unitVolumeHuman($value, $round),
            'distance' => $this->unitDistanceHuman($value, $round),
            'speed' => $this->unitSpeedHuman($value, $round),
            default => $this->unitException($type),
        };
    }

    /**
     * @param string $type
     * @param float $value
     * @param int $round = 2
     *
     * @return string
     */
    public function unitHumanRaw(string $type, float $value, int $round = 2): string
    {
        return match ($type) {
            'money' => $this->unitMoneyHumanRaw($value, $round),
            'volume' => $this->unitVolumeHumanRaw($value, $round),
            'distance' => $this->unitDistanceHumanRaw($value, $round),
            'speed' => $this->unitSpeedHumanRaw($value, $round),
            default => $this->unitException($type),
        };
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return float
     */
    public function unitMoney(float $value, int $round = 2): float
    {
        return round($value, $round);
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return string
     */
    public function unitMoneyHuman(float $value, int $round = 2): string
    {
        $value = $this->unitFormat($this->unitMoney($value, $round), $round);

        return match ($this->unitPreferences()['money']) {
            'euro' => $value.' €',
            'dollar' => '$'.$value,
            default => strval($value),
        };
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return string
     */
    public function unitMoneyHumanRaw(float $value, int $round = 2): string
    {
        $value = $this->unitFormat($value, $round);

        return match ($this->unitPreferences()['money']) {
            'euro' => $value.' €',
            'dollar' => '$'.$value,
            default => strval($value),
        };
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return float
     */
    public function unitVolume(float $value, int $round = 2): float
    {
        return round(match ($this->unitPreferences()['volume']) {
            'gallon' => $value * 0.264172,
            default => $value,
        }, $round);
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return string
     */
    public function unitVolumeHuman(float $value, int $round = 2): string
    {
        $value = $this->unitFormat($this->unitVolume($value, $round), $round);

        return match ($this->unitPreferences()['volume']) {
            'liter' => $value.' L',
            'gallon' => $value.' gal',
            default => strval($value),
        };
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return string
     */
    public function unitVolumeHumanRaw(float $value, int $round = 2): string
    {
        $value = $this->unitFormat($value, $round);

        return match ($this->unitPreferences()['volume']) {
            'liter' => $value.' L',
            'gallon' => $value.' gal',
            default => strval($value),
        };
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return float
     */
    public function unitDistance(float $value, int $round = 2): float
    {
        return round(match ($this->unitPreferences()['distance']) {
            'knot' => $value * 0.539957,
            'mile' => $value * 0.621371,
            default => $value,
        } / 1000, $round);
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return string
     */
    public function unitDistanceHuman(float $value, int $round = 2): string
    {
        $value = $this->unitFormat($this->unitDistance($value, $round), $round);

        return match ($this->unitPreferences()['distance']) {
            'kilometer' => $value.' km',
            'knot' => $value.' nm',
            'mile' => $value.' mi',
            default => strval($value),
        };
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return string
     */
    public function unitDistanceHumanRaw(float $value, int $round = 2): string
    {
        $value = $this->unitFormat($value, $round);

        return match ($this->unitPreferences()['distance']) {
            'kilometer' => $value.' km',
            'knot' => $value.' nm',
            'mile' => $value.' mi',
            default => strval($value),
        };
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return float
     */
    public function unitSpeed(float $value, int $round = 2): float
    {
        return round(match ($this->unitPreferences()['distance']) {
            'knot' => $value * 0.539957,
            'mile' => $value * 0.621371,
            default => $value,
        }, $round);
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return string
     */
    public function unitSpeedHuman(float $value, int $round = 2): string
    {
        $value = $this->unitFormat($this->unitSpeed($value, $round), $round);

        return match ($this->unitPreferences()['distance']) {
            'kilometer' => $value.' km/h',
            'knot' => $value.' kn',
            'mile' => $value.' mi/h',
            default => strval($value),
        };
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return string
     */
    public function unitSpeedHumanRaw(float $value, int $round = 2): string
    {
        $value = $this->unitFormat($value, $round);

        return match ($this->unitPreferences()['distance']) {
            'kilometer' => $value.' km/h',
            'knot' => $value.' kn',
            'mile' => $value.' mi/h',
            default => strval($value),
        };
    }

    /**
     * @param float $value
     * @param int $round = 2
     *
     * @return string
     */
    public function unitFormat(float $value, int $round = 2): string
    {
        $preferences = $this->unitPreferences();

        return number_format($value, $round, $preferences['decimal'], $preferences['thousand']);
    }

    /**
     * @return array
     */
    protected function unitPreferences(): array
    {
        return $this->cache[__FUNCTION__] ??= (app('user')->preferences['units'] ?? []) + [
            'money' => 'euro',
            'volume' => 'liter',
            'decimal' => ',',
            'distance' => 'kilometer',
            'thousand' => '.',
        ];
    }

    /**
     * @param string $type
     *
     * @return void
     */
    protected function unitException(string $type): void
    {
        throw new UnexpectedValueException(__('unit.error.invalid', ['unit' => $type]));
    }
}

```

`app/Services/Helper/functions.php:`

```php
<?php declare(strict_types=1);

/**
 * @return \App\Services\Helper\Helper
 */
function helper(): App\Services\Helper\Helper
{
    static $helper;

    return $helper ??= new App\Services\Helper\Helper();
}

/**
 * @return \App\Services\Helper\Service
 */
function service(): App\Services\Helper\Service
{
    static $service;

    return $service ??= new App\Services\Helper\Service();
}

```

`app/Services/Html/Alert.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Html;

use Throwable;
use Illuminate\Http\Request;
use App\Services\Request\Response;

class Alert
{
    /**
     * @const int
     */
    protected const TRACE = 10;

    /**
     * @param string $message
     *
     * @return bool
     */
    public static function success(string $message): bool
    {
        static::setMessage(__FUNCTION__, $message);

        return true;
    }

    /**
     * @param string $message
     *
     * @return bool
     */
    public static function error(string $message): bool
    {
        static::setMessage(__FUNCTION__, $message);

        return false;
    }

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Throwable $e
     *
     * @throws \Exception
     *
     * @return bool
     */
    public static function exception(Request $request, Throwable $e): bool
    {
        if (helper()->isExceptionSystem($e)) {
            report($e);
        }

        if ($request->ajax() || $request->wantsJson()) {
            throw $e;
        }

        $message = static::messageFromException($e);

        if (config('app.debug')) {
            $message = static::debug($e, $message);
        } else {
            $message = static::messageFix($message);
        }

        Response::status(intval(method_exists($e, 'getStatusCode') ? $e->getStatusCode() : $e->getCode()));

        return static::error($message);
    }

    /**
     * @param \Throwable $e
     * @param string $message
     *
     * @return string
     */
    protected static function debug(Throwable $e, string $message): string
    {
        $base = base_path();
        $trace = ['['.str_replace($base, '', $e->getFile()).' - '.$e->getLine().'] '.$message];

        foreach ($e->getTrace() as $line) {
            if (empty($line['file']) || str_contains($line['file'], '/vendor/')) {
                continue;
            }

            $trace[] = '» '.str_replace($base, '', $line['file']).' - '.$line['line'];

            if (count($trace) === static::TRACE) {
                break;
            }
        }

        return implode("\n<br />", $trace);
    }

    /**
     * @param \Throwable $e
     *
     * @return string
     */
    protected static function messageFromException(Throwable $e): string
    {
        $message = $e->getMessage();

        if (str_starts_with($message, '{') === false) {
            return $message;
        }

        if (empty($json = json_decode($message, true))) {
            return $message;
        }

        if (isset($json['message'])) {
            return $json['message'];
        }

        return json_encode(array_values($json));
    }

    /**
     * @param string $message
     *
     * @return string
     */
    protected static function messageFix(string $message): string
    {
        if (str_contains($message, 'SQLSTATE') === false) {
            return $message;
        }

        return __('error.generic');
    }

    /**
     * @param string $status
     * @param string $message
     *
     * @return void
     */
    protected static function setMessage(string $status, string $message)
    {
        service()->message()->$status($message);
    }
}

```

`app/Services/Html/Html.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Html;

use App\Services\Html\Traits\Custom as CustomTrait;

class Html
{
    use CustomTrait;

    /**
     * @param ?string $path
     *
     * @return string
     */
    public static function asset(?string $path): string
    {
        static $cache = [];

        if (empty($path)) {
            return '';
        }

        if (str_starts_with($path, 'data:')) {
            return $path;
        }

        if (isset($cache[$path])) {
            return $cache[$path];
        }

        if (is_file($file = public_path($path))) {
            $path .= '?v'.filemtime($file);
        }

        return $cache[$path] = asset($path);
    }

    /**
     * @param string $path
     *
     * @return string
     */
    public static function assetManifest(string $path): string
    {
        if (config('app.debug')) {
            return $path;
        }

        $manifest = public_path('build/rev-manifest.json');

        if (is_file($manifest) === false) {
            return asset($path);
        }

        return json_decode(file_get_contents($manifest), true)[$path] ?? asset($path);
    }

    /**
     * @param ?string $path
     * @param bool $image = false
     *
     * @return string
     */
    public static function inline(?string $path, bool $image = false): string
    {
        static $cache = [];

        if (empty($path)) {
            return '';
        }

        $key = serialize(func_get_args());

        if (isset($cache[$key])) {
            return $cache[$key];
        }

        $file = public_path($path);
        $contents = is_file($file) ? file_get_contents($file) : '';

        if ($image) {
            return 'data:image/'.pathinfo($file, PATHINFO_EXTENSION).';base64,'.base64_encode($contents);
        }

        return $cache[$key] = $contents;
    }

    /**
     * @param string $text
     * @param int $limit = 140
     * @param string $end = '...'
     *
     * @return string
     */
    public static function cut(string $text, int $limit = 140, string $end = '...'): string
    {
        if (strlen($text) <= (int)$limit) {
            return $text;
        }

        $length = strlen($text);
        $num = 0;
        $tag = 0;

        for ($n = 0; $n < $length; $n++) {
            if ($text[$n] === '<') {
                $tag++;

                continue;
            }

            if ($text[$n] === '>') {
                $tag--;

                continue;
            }

            if ($tag !== 0) {
                continue;
            }

            $num++;

            if ($num < $limit) {
                continue;
            }

            $text = substr($text, 0, $n);

            if ($space = strrpos($text, ' ')) {
                $text = substr($text, 0, $space);
            }

            break;
        }

        if (strlen($text) === $length) {
            return $text;
        }

        $text .= $end;

        if (!preg_match_all('|(<([\w]+)[^>]*>)|', $text, $aBuffer) || empty($aBuffer[1])) {
            return $text;
        }

        preg_match_all('|</([a-zA-Z]+)>|', $text, $aBuffer2);

        if (count($aBuffer[2]) === count($aBuffer2[1])) {
            return $text;
        }

        foreach ($aBuffer[2] as $k => $tag) {
            if (empty($aBuffer2[1][$k]) || ($tag !== $aBuffer2[1][$k])) {
                $text .= '</'.$tag.'>';
            }
        }

        return $text;
    }
}

```

`app/Services/Html/Traits/Custom.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Html\Traits;

use App\Domains\Timezone\Model\Timezone as TimezoneModel;

trait Custom
{
    /**
     * @param string $name
     * @param string $class = ''
     *
     * @return string
     */
    public static function icon(string $name, string $class = ''): string
    {
        return '<svg class="feather '.$class.'"><use xlink:href="'.static::asset('build/images/feather-sprite.svg').'#'.$name.'" /></svg>';
    }

    /**
     * @param string $path
     * @param string $class = ''
     *
     * @return string
     */
    public static function svg(string $path, string $class = ''): string
    {
        return str_replace('class=""', 'class="'.$class.'"', static::inline($path));
    }

    /**
     * @param ?bool $status
     * @param string $text = ''
     * @param string $class = ''
     *
     * @return string
     */
    public static function status(?bool $status, string $text = '', string $class = ''): string
    {
        if ($status === null) {
            return '-';
        }

        if ($status) {
            $theme = 'text-theme-10';
            $icon = 'check-square';
        } else {
            $theme = 'text-theme-24';
            $icon = 'square';
        }

        return '<span class="'.$theme.'">'.($text ?: static::icon($icon, 'w-4 h-4 '.$class)).'</span>';
    }

    /**
     * @param float $percent
     * @param string $class = 'h-3'
     *
     * @return string
     */
    public static function progressbar(float $percent, string $class = 'h-3'): string
    {
        if ($percent >= 90) {
            $color = '#F15B38';
        } elseif ($percent >= 70) {
            $color = '#EDBE38';
        } else {
            $color = '#1E3A8A';
        }

        $html = trim('
            <div class="w-full bg-slate-200 rounded overflow-hidden :class">
                <div role="progressbar" aria-valuenow=":percent" aria-valuemin="0" aria-valuemax="100" class="h-full rounded flex justify-center items-center" style="background-color: :color; width: :percent%"></div>
            </div>
        ');

        return strtr($html, [
            ':class' => $class,
            ':percent' => $percent,
            ':color' => $color,
        ]);
    }

    /**
     * @param ?array $data
     * @param string $class = 'border text-slate-600'
     *
     * @return string
     */
    public static function arrayAsBadges(?array $data, string $class = 'border text-slate-600'): string
    {
        return implode(array_map(static function ($key, $value) use ($class) {
            return '<span class="px-2 py-1 rounded-full whitespace-nowrap mr-2 '.$class.'">'.ucfirst($key).': '.static::valueToString($value).'</span> ';
        }, array_keys($data), $data));
    }

    /**
     * @param ?array $data
     * @param string $delimiter = ' - '
     *
     * @return string
     */
    public static function arrayAsText(?array $data, string $delimiter = ' - '): string
    {
        return implode($delimiter, array_map(static fn ($key, $value) => ucfirst($key).': '.static::valueToString($value), array_keys($data), $data));
    }

    /**
     * @param mixed $value
     *
     * @return string
     */
    public static function valueToString(mixed $value): string
    {
        if (is_array($value) || is_object($value)) {
            return substr(json_encode($value), 0, 20).'...';
        }

        return strval($value);
    }

    /**
     * @param ?string $date
     * @param ?string $timezone = null
     * @param string $format = 'd/m/Y H:i'
     *
     * @return string
     */
    public static function dateWithTimezone(?string $date, ?string $timezone = null, string $format = 'd/m/Y H:i'): string
    {
        static $timezone_default;

        if (empty($date)) {
            return '';
        }

        if (empty($timezone)) {
            $timezone_default ??= TimezoneModel::query()->whereDefault()->value('zone');
        }

        return helper()->dateUtcToTimezone('Y-m-d H:i:s', $date, $timezone ?: $timezone_default, $format);
    }

    /**
     * @param ?string $date
     * @param string $format = 'd/m/Y H:i'
     *
     * @return string
     */
    public static function dateWithUserTimezone(?string $date, string $format = 'd/m/Y H:i'): string
    {
        return static::dateWithTimezone($date, app('user')->timezone->zone, $format);
    }
}

```

`app/Services/Locate/Arcgis.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Locate;

class Arcgis extends LocateAbstract
{
    /**
     * @return ?\App\Services\Locate\Resource
     */
    public function locate(): ?Resource
    {
        if (empty($response = $this->request())) {
            return null;
        }

        return new Resource(
            $this->first($response, ['City', 'District']),
            $this->first($response, ['Subregion', 'Region']),
            $response['CntryName'],
            strtolower(substr($response['CountryCode'], 0, 2)),
        );
    }

    /**
     * @return ?array
     */
    protected function request(): ?array
    {
        return $this->curl()->send()->getBody('array')['address'] ?? null;
    }

    /**
     * @return string
     */
    protected function requestUrl(): string
    {
        return sprintf(
            'https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode?f=pjson&featureTypes=&location=%f,%f',
            $this->longitude,
            $this->latitude,
        );
    }
}

```

`app/Services/Locate/Gisgraphy.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Locate;

class Gisgraphy extends LocateAbstract
{
    /**
     * @return ?\App\Services\Locate\Resource
     */
    public function locate(): ?Resource
    {
        if (empty($response = $this->request())) {
            return null;
        }

        return new Resource(
            $this->first($response, ['city', 'citySubdivision']),
            $this->first($response, ['adm2Name', 'state']),
            $this->resourceCountry($response),
            strtolower($response['countryCode'])
        );
    }

    /**
     * @return ?array
     */
    protected function request(): ?array
    {
        return $this->curl()->send()->getBody('array')['result'][0] ?? null;
    }

    /**
     * @return string
     */
    protected function requestUrl(): string
    {
        return sprintf(
            'https://services.gisgraphy.com/reversegeocoding/search?format=json&lat=%s&lng=%s',
            $this->latitude,
            $this->longitude
        );
    }

    /**
     * @param array $response
     *
     * @return string
     */
    protected function resourceCountry(array $response): string
    {
        $full = explode(',', $response['formatedFull']);

        return trim(end($full));
    }
}

```

`app/Services/Locate/LocateAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Locate;

use App\Services\Curl\Curl;

abstract class LocateAbstract
{
    /**
     * @return ?\App\Services\Locate\Resource
     */
    abstract public function locate(): ?Resource;

    /**
     * @return string
     */
    abstract protected function requestUrl(): string;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param float $latitude
     * @param float $longitude
     *
     * @return self
     */
    public function __construct(protected float $latitude, protected float $longitude)
    {
        $this->latitude = round($latitude, 3);
        $this->longitude = round($longitude, 3);
    }

    /**
     * @return \App\Services\Curl\Curl
     */
    protected function curl(): Curl
    {
        return Curl::new()
            ->setUrl($this->requestUrl())
            ->setHeader('User-Agent', 'eusonlito/GPS-Tracker (https://github.com/eusonlito/GPS-Tracker)')
            ->setHeader('Referer', config('app.url'))
            ->setException(false)
            ->setCache(604800)
            ->setJson()
            ->setJsonResponse();
    }

    /**
     * @param array $data
     * @param array $keys
     *
     * @return string
     */
    protected function first(array $data, array $keys): string
    {
        foreach ($keys as $key) {
            if (empty($data[$key]) === false) {
                return $data[$key];
            }
        }

        return '';
    }
}

```

`app/Services/Locate/LocateFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Locate;

class LocateFactory
{
    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param float $latitude
     * @param float $longitude
     *
     * @return self
     */
    public function __construct(protected float $latitude, protected float $longitude)
    {
    }

    /**
     * @return ?\App\Services\Locate\Resource
     */
    public function locate(): ?Resource
    {
        foreach (config('locate.providers') as $provider) {
            if ($resource = $this->provider($provider)->locate()) {
                return $resource;
            }
        }

        return null;
    }

    /**
     * @param string $provider
     *
     * @return \App\Services\Locate\LocateAbstract
     */
    public function provider(string $provider): LocateAbstract
    {
        return new $provider($this->latitude, $this->longitude);
    }
}

```

`app/Services/Locate/Nominatim.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Locate;

class Nominatim extends LocateAbstract
{
    /**
     * @return ?\App\Services\Locate\Resource
     */
    public function locate(): ?Resource
    {
        if (empty($response = $this->request())) {
            return null;
        }

        return new Resource(
            $this->first($response, ['municipality', 'city', 'town', 'village', 'county', 'borough']),
            $this->first($response, ['province', 'state', 'county']),
            $response['country'],
            strtolower($response['country_code'])
        );
    }

    /**
     * @return ?array
     */
    protected function request(): ?array
    {
        return $this->curl()->send()->getBody('array')['address'] ?? null;
    }

    /**
     * @return string
     */
    protected function requestUrl(): string
    {
        return sprintf(
            'https://nominatim.openstreetmap.org/reverse?lat=%s&lon=%s&format=jsonv2&zoom=18&addressdetails=1',
            $this->latitude,
            $this->longitude
        );
    }
}

```

`app/Services/Locate/Resource.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Locate;

/**
 * @property string $city
 * @property string $state
 * @property string $country
 * @property string $country_code
 */
class Resource
{
    /**
     * @var array
     */
    protected array $attributes;

    /**
     * @param string $city
     * @param string $state
     * @param string $country
     * @param string $country_code
     *
     * @return self
     */
    public function __construct(string $city, string $state, string $country, string $country_code)
    {
        $this->attributes = [
            'city' => $city,
            'state' => $state,
            'country' => $country,
            'country_code' => $country_code,
        ];
    }

    /**
     * @param string $key
     *
     * @return mixed
     */
    public function __get(string $key): mixed
    {
        return $this->attributes[$key] ?? null;
    }

    /**
     * @param string $key
     */
    public function __isset(string $key): bool
    {
        return isset($this->attributes[$key]);
    }
}

```

`app/Services/Logger/DailyAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Logger;

use Monolog\Formatter\LineFormatter;
use Monolog\Handler\StreamHandler;
use Monolog\Logger;

abstract class DailyAbstract
{
    /**
     * @var bool
     */
    protected bool $includeStacktracesVendor = false;

    /**
     * @return string
     */
    abstract protected function name(): string;

    /**
     * @return \Monolog\Logger
     */
    public function __invoke(): Logger
    {
        return $this->logger();
    }

    /**
     * @return \Monolog\Formatter\LineFormatter
     */
    protected function formatter(): LineFormatter
    {
        $production = app()->isProduction();

        $formatter = new LineFormatter(null, 'c', true, true);
        $formatter->setMaxNormalizeDepth(1000);

        if ($this->includeStacktracesVendor) {
            $formatter->includeStacktraces(true);
        } else {
            $formatter->includeStacktraces(true, static fn ($line) => ($production || !str_contains($line, '/vendor/laravel/')) ? $line : null);
        }

        return $formatter;
    }

    /**
     * @return \Monolog\Handler\StreamHandler
     */
    public function handler(): StreamHandler
    {
        $handler = new StreamHandler($this->handlerFile(), 'DEBUG');
        $handler->setFormatter($this->formatter());

        return $handler;
    }

    /**
     * @return string
     */
    public function handlerFile(): string
    {
        return storage_path('logs/'.$this->name().'/'.date('Y/m/Y-m-d').'.log');
    }

    /**
     * @return \Monolog\Logger
     */
    public function logger(): Logger
    {
        $logger = new Logger($this->name().'-daily');
        $logger->pushHandler($this->handler());

        return $logger;
    }
}

```

`app/Services/Logger/DeprecationsDaily.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Logger;

class DeprecationsDaily extends DailyAbstract
{
    /**
     * @var bool
     */
    protected bool $includeStacktracesVendor = true;

    /**
     * @return string
     */
    protected function name(): string
    {
        return 'deprecations';
    }
}

```

`app/Services/Logger/LaravelDaily.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Logger;

class LaravelDaily extends DailyAbstract
{
    /**
     * @return string
     */
    protected function name(): string
    {
        return 'laravel';
    }
}

```

`app/Services/Logger/Mail.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Logger;

use DateTime;
use DateTimeZone;
use Monolog\Handler\StreamHandler;
use Monolog\Logger;

class Mail
{
    /**
     * @return \Monolog\Logger
     */
    public function __invoke(): Logger
    {
        return $this->logger();
    }

    /**
     * @return \Monolog\Handler\StreamHandler
     */
    public function handler(): StreamHandler
    {
        return new StreamHandler($this->file(), 'DEBUG');
    }

    /**
     * @return string
     */
    protected function file(): string
    {
        $date = new DateTime();
        $date->setTimezone(new DateTimeZone('UTC'));

        return storage_path('logs/mail/'.$date->format('Y/m/d/H-i-s-u').'.log');
    }

    /**
     * @return \Monolog\Logger
     */
    public function logger(): Logger
    {
        $logger = new Logger('mail');
        $logger->pushHandler($this->handler());

        return $logger;
    }
}

```

`app/Services/Logger/MonologRotatingFileAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Logger;

use Monolog\Formatter\LineFormatter;
use Monolog\Handler\StreamHandler;
use Monolog\Logger;

abstract class MonologRotatingFileAbstract
{
    /**
     * @var array
     */
    protected static array $logger = [];

    /**
     * @return string
     */
    abstract protected static function folder(): string;

    /**
     * @return string
     */
    abstract protected static function path(): string;

    /**
     * @param string $title
     * @param mixed $data
     *
     * @return void
     */
    public static function info(string $title, $data = []): void
    {
        static::write(__FUNCTION__, $title, $data);
    }

    /**
     * @param string $title
     * @param mixed $data
     *
     * @return void
     */
    public static function error(string $title, $data = []): void
    {
        static::write(__FUNCTION__, $title, $data);
    }

    /**
     * @param string $status
     * @param string $title
     * @param mixed $data
     *
     * @return void
     */
    protected static function write(string $status, string $title, $data = []): void
    {
        static::logger()->$status('['.strtoupper($status).'] '.$title, $data);
    }

    /**
     * @return \Monolog\Logger
     */
    public static function logger(): Logger
    {
        $name = static::folder();

        if (isset(static::$logger[$name])) {
            return static::$logger[$name];
        }

        $formatter = new LineFormatter("[%datetime%]: %message% %extra% %context%\n");
        $formatter->setMaxNormalizeDepth(10000);

        $handler = new StreamHandler(static::loggerFile());
        $handler->setFormatter($formatter);

        $logger = new Logger($name);
        $logger->pushHandler($handler);

        return static::$logger[$name] = $logger;
    }

    /**
     * @return string
     */
    protected static function loggerFile(): string
    {
        return storage_path('logs/'.static::folder().'/'.static::path().'.log');
    }
}

```

`app/Services/Logger/RotatingFileAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Logger;

abstract class RotatingFileAbstract
{
    /**
     * @return string
     */
    abstract protected static function folder(): string;

    /**
     * @return string
     */
    abstract protected static function path(): string;

    /**
     * @param string $title
     * @param mixed $data = null
     *
     * @return void
     */
    public static function info(string $title, mixed $data = null): void
    {
        static::write(__FUNCTION__, $title, $data);
    }

    /**
     * @param string $title
     * @param mixed $data = null
     *
     * @return void
     */
    public static function error(string $title, mixed $data = null): void
    {
        static::write(__FUNCTION__, $title, $data);
    }

    /**
     * @param string $status
     * @param mixed $title
     * @param mixed $data = null
     *
     * @return void
     */
    protected static function write(string $status, mixed $title, mixed $data = null): void
    {
        file_put_contents(static::file(), static::contents($status, $title, $data), FILE_APPEND | LOCK_EX);
    }

    /**
     * @return string
     */
    protected static function file(): string
    {
        $file = storage_path('logs/'.static::folder().'/'.static::path().'.log');

        clearstatcache(true, $file);

        if (is_file($file) === false) {
            helper()->mkdir($file, true);
        }

        return $file;
    }

    /**
     * @param string $status
     * @param mixed $title
     * @param mixed $data
     *
     * @return string
     */
    protected static function contents(string $status, mixed $title, mixed $data): string
    {
        return '['.static::timestamp().'] ['.strtoupper($status).'] '.static::toString($title).' '.static::toString($data)."\n";
    }

    /**
     * @return string
     */
    protected static function timestamp(): string
    {
        return date_create()->format('Y-m-d H:i:s.v P');
    }

    /**
     * @param mixed $contents
     *
     * @return string
     */
    protected static function toString(mixed $contents): string
    {
        if (is_string($contents) || is_numeric($contents)) {
            return '['.$contents.']';
        }

        return json_encode($contents, JSON_INVALID_UTF8_SUBSTITUTE | JSON_UNESCAPED_LINE_TERMINATORS | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
    }
}

```

`app/Services/Protocol/Aquila/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Aquila;

use App\Services\Protocol\Aquila\Parser\Location as LocationParser;
use App\Services\Protocol\ProtocolAbstract;
use App\Services\Server\Socket\Server;

class Manager extends ProtocolAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'aquila';
    }

    /**
     * @return string
     */
    public function name(): string
    {
        return 'Aquila';
    }

    /**
     * @param int $port
     *
     * @return \App\Services\Server\Socket\Server
     */
    public function server(int $port): Server
    {
        return Server::new($port)
            ->socketType('stream')
            ->socketProtocol('ip');
    }

    /**
     * @param string $message
     *
     * @return array
     */
    public function messages(string $message): array
    {
        if ($this->messageIsValidHex($message) === false) {
            return [];
        }

        return array_filter(array_map('trim', explode("\n", hex2bin($message))));
    }

    /**
     * @return array
     */
    protected function parsers(): array
    {
        return [
            LocationParser::class,
        ];
    }
}

```

`app/Services/Protocol/Aquila/Parser/Location.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Aquila\Parser;

use App\Services\Protocol\ParserAbstract;

class Location extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->values = explode(',', substr($this->message, 2, -3));

        $this->addIfValid($this->resourceLocation());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return (bool)preg_match($this->messageIsValidRegExp(), $this->message);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'\$\$[^,]*,'            //  0 - client
            .'[0-9]+,'               //  1 - serial
            .'[0-9]+,'               //  2 - type
            .'-?[0-9]+\.[0-9]+,'     //  3 - latitude
            .'-?[0-9]+\.[0-9]+,'     //  4 - longitude
            .'[0-9]{12},'            //  5 - datetime
            .'[VA],'                 //  6 - signal
            .'[0-9]+,'               //  7 - gsm
            .'[0-9]{1,3},'           //  8 - speed
            .'[0-9]+,'               //  9 - odometer
            .'[0-9]{1,3},'           // 10 - direction
            .'/';
    }

    /**
     * @return ?string
     */
    protected function maker(): ?string
    {
        return $this->values[0];
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->values[1];
    }

    /**
     * @return ?string
     */
    protected function type(): ?string
    {
        return $this->values[2];
    }

    /**
     * @return float
     */
    protected function latitude(): float
    {
        return floatval($this->values[3]);
    }

    /**
     * @return float
     */
    protected function longitude(): float
    {
        return floatval($this->values[4]);
    }

    /**
     * @return float
     */
    protected function speed(): float
    {
        return floatval($this->values[8]);
    }

    /**
     * @return int
     */
    protected function signal(): int
    {
        return $this->values[6] === 'A' ? 1 : 0;
    }

    /**
     * @return int
     */
    protected function direction(): int
    {
        return intval($this->values[10]);
    }

    /**
     * @return ?string
     */
    protected function datetime(): ?string
    {
        if (preg_match('/^0+$/', $this->values[5])) {
            return null;
        }

        return sprintf('20%s-%s-%s %s:%s:%s', ...str_split($this->values[5], 2));
    }

    /**
     * @return ?string
     */
    protected function timezone(): ?string
    {
        return helper()->latitudeLongitudeTimezone(
            $this->latitude(),
            $this->longitude(),
        );
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return '';
    }
}

```

`app/Services/Protocol/DebugHttp/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\DebugHttp;

use App\Services\Protocol\ProtocolAbstract;
use App\Services\Server\Http\Server;

class Manager extends ProtocolAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'debug-http';
    }

    /**
     * @return string
     */
    public function name(): string
    {
        return 'Debug HTTP';
    }

    /**
     * @param int $port
     *
     * @return \App\Services\Server\Http\Server
     */
    public function server(int $port): Server
    {
        return Server::new($port);
    }

    /**
     * @return array
     */
    protected function parsers(): array
    {
        return [];
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $message
     * @param array $data = []
     *
     * @return array
     */
    public function resources(string $message, array $data = []): array
    {
        return [];
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $message
     *
     * @return array
     */
    public function messages(string $message): array
    {
        return [];
    }
}

```

`app/Services/Protocol/DebugSocket/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\DebugSocket;

use App\Services\Protocol\ProtocolAbstract;
use App\Services\Server\Socket\Server;

class Manager extends ProtocolAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'debug-socket';
    }

    /**
     * @return string
     */
    public function name(): string
    {
        return 'Debug Socket';
    }

    /**
     * @param int $port
     *
     * @return \App\Services\Server\Socket\Server
     */
    public function server(int $port): Server
    {
        return Server::new($port)
            ->socketType('stream')
            ->socketProtocol('tcp');
    }

    /**
     * @return array
     */
    protected function parsers(): array
    {
        return [];
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $message
     * @param array $data = []
     *
     * @return array
     */
    public function resources(string $message, array $data = []): array
    {
        return [];
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param string $message
     *
     * @return array
     */
    public function messages(string $message): array
    {
        return [];
    }
}

```

`app/Services/Protocol/GPS103/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\GPS103;

use App\Services\Protocol\GPS103\Parser\Auth as AuthParser;
use App\Services\Protocol\GPS103\Parser\Command as CommandParser;
use App\Services\Protocol\GPS103\Parser\Heartbeat as HeartbeatParser;
use App\Services\Protocol\GPS103\Parser\Location as LocationParser;
use App\Services\Protocol\ProtocolAbstract;
use App\Services\Server\Socket\Server;

class Manager extends ProtocolAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'gps103';
    }

    /**
     * @return string
     */
    public function name(): string
    {
        return 'GPS103';
    }

    /**
     * @param int $port
     *
     * @return \App\Services\Server\Socket\Server
     */
    public function server(int $port): Server
    {
        return Server::new($port)
            ->socketType('stream')
            ->socketProtocol('ip');
    }

    /**
     * @return array
     */
    protected function parsers(): array
    {
        return [
            AuthParser::class,
            HeartbeatParser::class,
            LocationParser::class,
            CommandParser::class,
        ];
    }

    /**
     * @param string $message
     *
     * @return array
     */
    public function messages(string $message): array
    {
        if ($this->messageIsValidHex($message) === false) {
            return [];
        }

        return array_filter(array_map('trim', preg_split('/[\n;]/', hex2bin($message))));
    }
}

```

`app/Services/Protocol/GPS103/Parser/Auth.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\GPS103\Parser;

use App\Services\Protocol\ParserAbstract;

class Auth extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->values = explode(',', $this->message);

        $this->addIfValid($this->resourceAuth());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return (bool)preg_match($this->messageIsValidRegExp(), $this->message);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^\#\#,'
            .'imei:[0-9]+,' // 1 - serial
            .'A'            // 2 - type
            .'$/';
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return explode(':', $this->values[1])[1];
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return 'LOAD';
    }
}

```

`app/Services/Protocol/GPS103/Parser/Command.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\GPS103\Parser;

use App\Services\Protocol\ParserAbstract;

class Command extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->values = explode(',', $this->message);

        $this->addIfValid($this->resourceCommand());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return (bool)preg_match($this->messageIsValidRegExp(), $this->message);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'imei:[0-9]+,'    //  0 - serial
            .'[015][0-9]{2},'  //  1 - type
            .'[0-9]{6,},'      //  2 - datetime
            .'[^,]*,'          //  3 - rfid
            .'[FL],'           //  4 - signal
            .'[0-9\.]+,'       //  5 - fix time
            .'[AV],'           //  6 - signal
            .'[0-9]+\.[0-9]+,' //  7 - latitude
            .'[NS],'           //  8 - latitude direction
            .'[0-9]+\.[0-9]+,' //  9 - longitude
            .'[EW],'           // 10 - longitude direction
            .'/';
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return explode(':', $this->values[0])[1];
    }

    /**
     * @return ?string
     */
    protected function type(): ?string
    {
        return $this->values[1];
    }

    /**
     * @return array
     */
    protected function payload(): array
    {
        return [];
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return '';
    }
}

```

`app/Services/Protocol/GPS103/Parser/Heartbeat.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\GPS103\Parser;

use App\Services\Protocol\ParserAbstract;

class Heartbeat extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->values = explode(',', $this->message);

        $this->addIfValid($this->resourceHeartbeat());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return (bool)preg_match($this->messageIsValidRegExp(), $this->message);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'[0-9]+' // 0 - serial
            .'$/';
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->values[0];
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return 'ON';
    }
}

```

`app/Services/Protocol/GPS103/Parser/Location.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\GPS103\Parser;

use App\Services\Protocol\ParserAbstract;

class Location extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->values = explode(',', $this->message);

        $this->addIfValid($this->resourceLocation());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return $this->messageIsValidParse()
            && $this->messageIsValidType();
    }

    /**
     * @return bool
     */
    public function messageIsValidParse(): bool
    {
        return (bool)preg_match($this->typeIsValidParseExp(), $this->message);
    }

    /**
     * @return string
     */
    protected function typeIsValidParseExp(): string
    {
        return '/^'
            .'imei:[0-9]+,'    //  0 - serial
            .'[^,]*,'          //  1 - type
            .'[0-9]{6,},'      //  2 - datetime
            .'[^,]*,'          //  3 - rfid
            .'[FL],'           //  4 - signal
            .'[0-9\.]+,'       //  5 - fix time
            .'[AV],'           //  6 - signal
            .'[0-9]+\.[0-9]+,' //  7 - latitude
            .'[NS],'           //  8 - latitude direction
            .'[0-9]+\.[0-9]+,' //  9 - longitude
            .'[EW],'           // 10 - longitude direction
            .'[0-9]+\.[0-9]+,' // 11 - speed
            .'[0-9\.]*,?'      // 12 - direction
            .'/';
    }

    /**
     * @return bool
     */
    public function messageIsValidType(): bool
    {
        $type = explode(',', $this->message, 3)[1];

        return ($type === '001')
            || (is_numeric($type) === false);
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return explode(':', $this->values[0])[1];
    }

    /**
     * @return ?string
     */
    protected function type(): ?string
    {
        return $this->values[1];
    }

    /**
     * @return float
     */
    protected function latitude(): float
    {
        if (isset($this->cache[__FUNCTION__])) {
            return $this->cache[__FUNCTION__];
        }

        $degree = intval(substr($this->values[7], 0, 2));
        $minute = floatval(substr($this->values[7], 2));
        $direction = floatval(str_replace(['S', 'N'], ['-1', '1'], $this->values[8]));

        $latitude = round(($degree + ($minute / 60)) * $direction, 5);

        if (($latitude < -90) || ($latitude > 90)) {
            $latitude = 0.0;
        }

        return $this->cache[__FUNCTION__] = $latitude;
    }

    /**
     * @return float
     */
    protected function longitude(): float
    {
        if (isset($this->cache[__FUNCTION__])) {
            return $this->cache[__FUNCTION__];
        }

        $degree = intval(substr($this->values[9], 0, 3));
        $minute = floatval(substr($this->values[9], 3));
        $direction = floatval(str_replace(['W', 'E'], ['-1', '1'], $this->values[10]));

        $longitude = round(($degree + ($minute / 60)) * $direction, 5);

        if (($longitude < -180) || ($longitude > 180)) {
            $longitude = 0.0;
        }

        return $this->cache[__FUNCTION__] = $longitude;
    }

    /**
     * @return float
     */
    protected function speed(): float
    {
        return round(floatval($this->values[11]) * 1.852, 2);
    }

    /**
     * @return int
     */
    protected function signal(): int
    {
        return $this->values[4] === 'F' ? 1 : 0;
    }

    /**
     * @return int
     */
    protected function direction(): int
    {
        return intval($this->values[12]);
    }

    /**
     * @return ?string
     */
    protected function datetime(): ?string
    {
        $date = str_split($this->values[2], 2);

        if (count($date) < 5) {
            return null;
        }

        $date = '20'.$date[0].'-'.$date[1].'-'.$date[2].' '.$date[3].':'.$date[4].':'.($date[5] ?? '');

        if (str_ends_with($date, ':') === false) {
            return $date;
        }

        if (($this->data['date'] ?? null) !== $date) {
            $this->data['date'] = $date;
            $this->data['seconds'] = -5;
        }

        $this->data['seconds'] += 5;

        return $date.sprintf('%02d', $this->data['seconds']);
    }

    /**
     * @return ?string
     */
    protected function timezone(): ?string
    {
        return $this->cache[__FUNCTION__] ??= helper()->latitudeLongitudeTimezone(
            $this->latitude(),
            $this->longitude(),
        );
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return [
            'date' => $this->data['date'] ?? null,
            'seconds' => $this->data['seconds'] ?? -5,
        ];
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return match ($this->type()) {
            'help me' => $this->responseHelpMe(),
            default => $this->responseDefault(),
        };
    }

    /**
     * @return string
     */
    protected function responseHelpMe(): string
    {
        return '**,'.$this->values[0].',E;';
    }

    /**
     * @return string
     */
    protected function responseDefault(): string
    {
        return '';
    }
}

```

`app/Services/Protocol/GT06/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\GT06;

use App\Services\Protocol\GT06\Parser\Auth as AuthParser;
use App\Services\Protocol\GT06\Parser\Heartbeat as HeartbeatParser;
use App\Services\Protocol\GT06\Parser\LocationGpsModular as LocationGpsModularParser;
use App\Services\Protocol\GT06\Parser\LocationLbs as LocationLbsParser;
use App\Services\Protocol\ProtocolAbstract;
use App\Services\Server\Socket\Server;

class Manager extends ProtocolAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'gt06';
    }

    /**
     * @return string
     */
    public function name(): string
    {
        return 'GT06';
    }

    /**
     * @param int $port
     *
     * @return \App\Services\Server\Socket\Server
     */
    public function server(int $port): Server
    {
        return Server::new($port)
            ->socketType('stream')
            ->socketProtocol('ip');
    }

    /**
     * @return array
     */
    protected function parsers(): array
    {
        return [
            AuthParser::class,
            HeartbeatParser::class,
            LocationGpsModularParser::class,
            LocationLbsParser::class,
        ];
    }

    /**
     * @param string $message
     *
     * @return array
     */
    public function messages(string $message): array
    {
        return array_filter(array_map('trim', explode('0d0a', $message)));
    }
}

```

`app/Services/Protocol/GT06/Parser/Auth.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\GT06\Parser;

use App\Services\Protocol\ParserAbstract;

class Auth extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        $this->values = [];

        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->addIfValid($this->resourceAuth());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return (bool)preg_match($this->messageIsValidRegExp(), $this->message, $this->values);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'(7878)'        // 1 - start
            .'([0-9a-f]{2})' // 2 - length
            .'(01)'          // 3 - protocol
            .'([0-9]{16})'   // 4 - serial
            .'/';
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->values[4];
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ['serial' => $this->serial()];
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return hex2bin($this->values[1].'05'.$this->values[3].'0001D9DC0D0A');
    }
}

```

`app/Services/Protocol/GT06/Parser/Heartbeat.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\GT06\Parser;

use App\Services\Protocol\ParserAbstract;

class Heartbeat extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        $this->values = [];

        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->addIfValid($this->resourceHeartbeat());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return ($this->data['serial'] ?? false)
            && (bool)preg_match($this->messageIsValidRegExp(), $this->message, $this->values);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'(7878)'         //  1 - start
            .'([0-9a-f]{2})'  //  2 - length
            .'(13|23)'        //  3 - protocol
            .'/';
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->data['serial'];
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return hex2bin($this->values[1].'05'.$this->values[3].'0001D9DC0D0A');
    }
}

```

`app/Services/Protocol/GT06/Parser/LocationGpsModular.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\GT06\Parser;

use App\Services\Buffer\Bit as BufferBit;
use App\Services\Buffer\Byte as BufferByte;
use App\Services\Protocol\ParserAbstract;

class LocationGpsModular extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        $this->values = [];

        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->modules();

        $this->addIfValid($this->resourceLocation());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return ($this->data['serial'] ?? false)
            && (bool)preg_match($this->messageIsValidRegExp(), $this->message, $this->values);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'(7979)'        //  1 - start
            .'([0-9a-f]{4})' //  2 - length
            .'(70)'          //  3 - protocol
            .'/';
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->data['serial'];
    }

    /**
     * @return void
     */
    protected function modules(): void
    {
        $buffer = new BufferByte(substr($this->message, 10, -8));

        while ($buffer->length() > 6) {
            $type = $buffer->string(2);
            $content = $buffer->new($buffer->int(2));

            match ($type) {
                '0011' => $this->moduleCellTower($content),
                '0033' => $this->moduleGps($content),
                '002C' => $this->moduleTimestamp($content),
                default => null,
            };
        }
    }

    /**
     * @param \App\Services\Buffer\Byte $buffer
     *
     * @return void
     */
    protected function moduleGps(BufferByte $buffer): void
    {
        $this->cache['datetime'] = date('Y-m-d H:i:s', $buffer->int(4));

        $this->cache['latitude'] = round($buffer->int(4, 7) / 60 / 30000, 5);
        $this->cache['longitude'] = round($buffer->int(4) / 60 / 30000, 5);

        $this->cache['speed'] = round($buffer->int(1) * 1.852, 2);

        $flags = $buffer->int();

        $this->cache['direction'] = BufferBit::to($flags, 10);
        $this->cache['signal'] = intval(BufferBit::check($flags, 12));

        if (BufferBit::check($flags, 10) === false) {
            $this->cache['latitude'] = -$this->cache['latitude'];
        }

        if (BufferBit::check($flags, 11)) {
            $this->cache['longitude'] = -$this->cache['longitude'];
        }
    }

    /**
     * @param \App\Services\Buffer\Byte $buffer
     *
     * @return void
     */
    protected function moduleCellTower(BufferByte $buffer): void
    {
        $this->cache['mcc'] = $buffer->int(2);
        $this->cache['mnc'] = $buffer->int(2);
    }

    /**
     * @param \App\Services\Buffer\Byte $buffer
     *
     * @return void
     */
    protected function moduleTimestamp(BufferByte $buffer): void
    {
        $this->cache['datetime'] = date('Y-m-d H:i:s', $buffer->int());
    }

    /**
     * @return ?float
     */
    protected function latitude(): ?float
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?float
     */
    protected function longitude(): ?float
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?float
     */
    protected function speed(): ?float
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?int
     */
    protected function signal(): ?int
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?int
     */
    protected function direction(): ?int
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?string
     */
    protected function datetime(): ?string
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?string
     */
    protected function country(): ?string
    {
        if (isset($this->cache['mcc'], $this->cache['mnc']) === false) {
            return null;
        }

        return $this->cache[__FUNCTION__] ??= helper()->mcc($this->cache['mcc'], $this->cache['mnc'])?->iso;
    }

    /**
     * @return ?string
     */
    protected function timezone(): ?string
    {
        if (isset($this->cache['latitude'], $this->cache['longitude']) === false) {
            return null;
        }

        return $this->cache[__FUNCTION__] ??= helper()->latitudeLongitudeTimezone(
            $this->latitude(),
            $this->longitude(),
            $this->country()
        );
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return hex2bin($this->values[1].'0005'.$this->values[3].'0001D9DC0D0A');
    }
}

```

`app/Services/Protocol/GT06/Parser/LocationLbs.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\GT06\Parser;

use App\Services\Protocol\ParserAbstract;

class LocationLbs extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        $this->values = [];

        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->addIfValid($this->resourceLocation());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return ($this->data['serial'] ?? false)
            && (bool)preg_match($this->messageIsValidRegExp(), $this->message, $this->values);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'(7878)'         //  1 - start
            .'([0-9a-f]{2})'  //  2 - length
            .'(12|22)'        //  3 - protocol
            .'([0-9a-f]{12})' //  4 - datetime
            .'([0-9a-f]{2})'  //  5 - satellites
            .'([0-9a-f]{8})'  //  6 - latitude
            .'([0-9a-f]{8})'  //  7 - longitude
            .'([0-9a-f]{2})'  //  8 - speed
            .'([0-9a-f]{4})'  //  9 - status/signal/direction
            .'([0-9a-f]{4})'  // 10 - mcc
            .'([0-9a-f]{2})'  // 11 - mnc
            .'/';
    }

    /**
     * @return string
     */
    protected function statusValue(): string
    {
        return $this->cache[__FUNCTION__] ??= str_pad(base_convert($this->values[9], 16, 2), 16, '0', STR_PAD_LEFT);
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->data['serial'];
    }

    /**
     * @return float
     */
    protected function latitude(): float
    {
        return $this->cache[__FUNCTION__] ??= $this->latitudeLongitude(
            $this->values[6],
            ($this->statusValue()[5] === '0')
        );
    }

    /**
     * @return float
     */
    protected function longitude(): float
    {
        return $this->cache[__FUNCTION__] ??= $this->latitudeLongitude(
            $this->values[7],
            ($this->statusValue()[4] === '1')
        );
    }

    /**
     * @param string $hex
     * @param bool $negative
     *
     * @return float
     */
    protected function latitudeLongitude(string $hex, bool $negative): float
    {
        $value = round(hexdec($hex) / 60 / 30000, 5);

        if ($negative) {
            $value *= -1;
        }

        return $value;
    }

    /**
     * @return float
     */
    protected function speed(): float
    {
        return $this->cache[__FUNCTION__] ??= hexdec($this->values[8]);
    }

    /**
     * @return int
     */
    protected function signal(): int
    {
        return $this->cache[__FUNCTION__] ??= intval($this->statusValue()[3]);
    }

    /**
     * @return int
     */
    protected function direction(): int
    {
        return $this->cache[__FUNCTION__] ??= bindec(substr($this->statusValue(), 6, 10));
    }

    /**
     * @return ?string
     */
    protected function datetime(): ?string
    {
        $date = array_map(
            static fn ($value) => str_pad(strval(hexdec($value)), 2, '0', STR_PAD_LEFT),
            str_split($this->values[4], 2)
        );

        return '20'.$date[0].'-'.$date[1].'-'.$date[2].' '.$date[3].':'.$date[4].':'.$date[5];
    }

    /**
     * @return ?string
     */
    protected function country(): ?string
    {
        return $this->cache[__FUNCTION__] ??= helper()->mcc(
            hexdec($this->values[10]),
            hexdec($this->values[11])
        )?->iso;
    }

    /**
     * @return ?string
     */
    protected function timezone(): ?string
    {
        return $this->cache[__FUNCTION__] ??= helper()->latitudeLongitudeTimezone(
            $this->latitude(),
            $this->longitude(),
            $this->country()
        );
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return hex2bin($this->values[1].'05'.$this->values[3].'0001D9DC0D0A');
    }
}

```

`app/Services/Protocol/H02/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\H02;

use App\Services\Protocol\H02\Parser\Command as CommandParser;
use App\Services\Protocol\H02\Parser\Location as LocationParser;
use App\Services\Protocol\H02\Parser\LocationBinary as LocationBinaryParser;
use App\Services\Protocol\H02\Parser\Sms as SmsParser;
use App\Services\Protocol\ProtocolAbstract;
use App\Services\Server\Socket\Server;

class Manager extends ProtocolAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'h02';
    }

    /**
     * @return string
     */
    public function name(): string
    {
        return 'H02';
    }

    /**
     * @param int $port
     *
     * @return \App\Services\Server\Socket\Server
     */
    public function server(int $port): Server
    {
        return Server::new($port)
            ->socketType('stream')
            ->socketProtocol('ip');
    }

    /**
     * @param string $message
     *
     * @return array
     */
    public function messages(string $message): array
    {
        if ($this->messageIsValidHex($message) === false) {
            return [];
        }

        return array_filter(array_map('trim', explode("\n", hex2bin($message))));
    }

    /**
     * @return array
     */
    protected function parsers(): array
    {
        return [
            LocationParser::class,
            LocationBinaryParser::class,
            SmsParser::class,
            CommandParser::class,
        ];
    }
}

```

`app/Services/Protocol/H02/Parser/Command.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\H02\Parser;

use App\Services\Protocol\ParserAbstract;

class Command extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->values = explode(',', substr($this->message, 1, -1));

        $this->addIfValid($this->resourceCommand());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return (bool)preg_match($this->messageIsValidRegExp(), $this->message);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'\*[A-Z]{2},' // 0 - maker
            .'[0-9]+,'     // 1 - serial
            .'V4,'         // 2 - type
            .'.*'          // 3 - payload
            .'$/';
    }

    /**
     * @return string
     */
    protected function maker(): string
    {
        return $this->values[0];
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->values[1];
    }

    /**
     * @return string
     */
    protected function type(): string
    {
        return $this->values[2];
    }

    /**
     * @return array
     */
    protected function payload(): array
    {
        return explode(',', $this->values[3]);
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return '*'.$this->maker().','.$this->serial().',V4,'.$this->type().','.date('YmdHis').'#';
    }
}

```

`app/Services/Protocol/H02/Parser/Location.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\H02\Parser;

use App\Services\Protocol\ParserAbstract;

class Location extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->values = explode(',', substr($this->message, 1, -1));

        $this->addIfValid($this->resourceLocation());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return (bool)preg_match($this->messageIsValidRegExp(), $this->message);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'\*[A-Z]{2},'           //  0 - maker
            .'[0-9]+,'               //  1 - serial
            .'V[15],'                //  2 - type (V1,V5)
            .'[0-9]{6},'             //  3 - time
            .'[VA],'                 //  4 - signal
            .'[0-9]{4}\.[0-9]{4},'   //  5 - latitude
            .'[NS],'                 //  6 - latitude direction
            .'[0-9]{4,5}\.[0-9]{4},' //  7 - longitude (V1=5,V5=4)
            .'[EW],'                 //  8 - longitude direction
            .'[0-9]{0,3}\.[0-9]{2},' //  9 - speed
            .'[0-9]{0,3},'           // 10 - direction
            .'[0-9]{6},'             // 11 - date
            .'[0-9a-fA-F]{8},'       // 12 - status
            .'[0-9]+,'               // 13 - mcc
            .'[0-9]+,'               // 14 - mnc
            .'/';
    }

    /**
     * @return ?string
     */
    protected function maker(): ?string
    {
        return $this->values[0];
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->values[1];
    }

    /**
     * @return ?string
     */
    protected function type(): ?string
    {
        return $this->values[2];
    }

    /**
     * @return float
     */
    protected function latitude(): float
    {
        if (isset($this->cache[__FUNCTION__])) {
            return $this->cache[__FUNCTION__];
        }

        $degree = intval(substr($this->values[5], 0, 2));
        $minute = floatval(substr($this->values[5], 2, 7));
        $direction = floatval(str_replace(['S', 'N'], ['-1', '1'], $this->values[6]));

        return $this->cache[__FUNCTION__] = round(($degree + ($minute / 60)) * $direction, 5);
    }

    /**
     * @return float
     */
    protected function longitude(): float
    {
        if (isset($this->cache[__FUNCTION__])) {
            return $this->cache[__FUNCTION__];
        }

        $longitude = $this->values[7];
        $direction = floatval(str_replace(['W', 'E'], ['-1', '1'], $this->values[8]));

        if ($this->type() === 'V1') {
            $degree = intval(substr($longitude, 0, 3));
            $minute = floatval(substr($longitude, 3, 7));
        } else {
            $degree = intval(substr($longitude, 0, 2));
            $minute = floatval(substr($longitude, 2, 7));
        }

        return $this->cache[__FUNCTION__] = round(($degree + ($minute / 60)) * $direction, 5);
    }

    /**
     * @return float
     */
    protected function speed(): float
    {
        return round(floatval($this->values[9]) * 1.852, 2);
    }

    /**
     * @return int
     */
    protected function signal(): int
    {
        return $this->values[4] === 'A' ? 1 : 0;
    }

    /**
     * @return int
     */
    protected function direction(): int
    {
        return intval($this->values[10]);
    }

    /**
     * @return ?string
     */
    protected function datetime(): ?string
    {
        $value = $this->values[11].$this->values[3];

        if (preg_match('/^0+$/', $value)) {
            return null;
        }

        $date = str_split($value, 2);

        return '20'.$date[2].'-'.$date[1].'-'.$date[0].' '.$date[3].':'.$date[4].':'.$date[5];
    }

    /**
     * @return ?string
     */
    protected function country(): ?string
    {
        return $this->cache[__FUNCTION__] ??= helper()->mcc(
            intval($this->values[13]),
            intval($this->values[14])
        )?->iso;
    }

    /**
     * @return ?string
     */
    protected function timezone(): ?string
    {
        return $this->cache[__FUNCTION__] ??= helper()->latitudeLongitudeTimezone(
            $this->latitude(),
            $this->longitude(),
            $this->country()
        );
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return '*'.$this->maker().','.$this->serial().',V4,'.$this->type().','.date('YmdHis').'#';
    }
}

```

`app/Services/Protocol/H02/Parser/LocationBinary.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\H02\Parser;

use App\Services\Buffer\Byte as BufferByte;
use App\Services\Protocol\ParserAbstract;

class LocationBinary extends ParserAbstract
{
    /**
     * @var \App\Services\Buffer\Byte
     */
    protected BufferByte $buffer;

    /**
     * @return array
     */
    public function resources(): array
    {
        $this->message = bin2hex($this->message);

        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->setBuffer();
        $this->setSerial();
        $this->setDate();
        $this->setLatitude();
        $this->setBattery();
        $this->setLongitude();
        $this->setFlags();
        $this->setSpeedDirection();
        $this->setStatus();
        $this->setMccMnc();

        $this->addIfValid($this->resourceLocation());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return $this->messageIsValidLength()
            && $this->messageIsValidStart();
    }

    /**
     * @return bool
     */
    protected function messageIsValidLength(): bool
    {
        return (strlen($this->message) === 84)
            || (strlen($this->message) === 90);
    }

    /**
     * @return bool
     */
    protected function messageIsValidStart(): bool
    {
        return str_starts_with($this->message, '24');
    }

    /**
     * @return void
     */
    protected function setBuffer(): void
    {
        $this->buffer = new BufferByte($this->message);
    }

    /**
     * @return void
     */
    protected function setSerial(): void
    {
        $this->buffer->index(1);
        $this->cache['serial'] = $this->buffer->string(5);
    }

    /**
     * @return void
     */
    protected function setDate(): void
    {
        $hour = $this->buffer->string(1);
        $minute = $this->buffer->string(1);
        $second = $this->buffer->string(1);
        $day = $this->buffer->string(1);
        $month = $this->buffer->string(1);
        $year = $this->buffer->string(1);

        $this->cache['datetime'] = sprintf(
            '20%s-%s-%s %s:%s:%s',
            $year,
            $month,
            $day,
            $hour,
            $minute,
            $second,
        );
    }

    /**
     * @return void
     */
    protected function setLatitude(): void
    {
        preg_match('/(.{2})(.{2})(.{4})/', $this->buffer->string(4), $matches);

        $this->cache['latitude'] = intval($matches[1]) + (floatval($matches[2].'.'.$matches[3]) / 60);
    }

    /**
     * @return void
     */
    protected function setBattery(): void
    {
        $this->buffer->string(1);
    }

    /**
     * @return void
     */
    protected function setLongitude(): void
    {
        preg_match('/(.{3})(.{2})(.{4})/', $this->buffer->string(5), $matches);

        $this->cache['longitude'] = intval($matches[1]) + (floatval($matches[2].'.'.$matches[3]) / 60);
    }

    /**
     * @return void
     */
    protected function setFlags(): void
    {
        $flags = $this->buffer->peek(-1);

        $this->cache['signal'] = (($flags & 0x02) !== 0) ? 1 : 0;

        if (($flags & 0x04) === 0) {
            $this->cache['latitude'] *= -1;
        }

        if (($flags & 0x08) === 0) {
            $this->cache['longitude'] *= -1;
        }
    }

    /**
     * @return void
     */
    protected function setSpeedDirection(): void
    {
        $value = $this->buffer->string(3);

        $this->cache['speed'] = intval(substr($value, 0, 3));
        $this->cache['direction'] = intval(substr($value, 3, 3));
    }

    /**
     * @return void
     */
    protected function setStatus(): void
    {
        // Vehicle Status
        $this->buffer->string(4);
        // Alarm Flag
        $this->buffer->string(1);
        // Mileage
        $this->buffer->string(4);
    }

    /**
     * @return void
     */
    protected function setMccMnc(): void
    {
        $this->cache['mcc'] = $this->buffer->int(2);
        $this->cache['mnc'] = $this->buffer->int(1);
    }

    /**
     * @return string
     */
    protected function message(): string
    {
        return $this->message;
    }

    /**
     * @return string
     */
    protected function maker(): string
    {
        return 'HQ';
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->cache[__FUNCTION__];
    }

    /**
     * @return ?string
     */
    protected function type(): ?string
    {
        return 'V5';
    }

    /**
     * @return ?float
     */
    protected function latitude(): ?float
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?float
     */
    protected function longitude(): ?float
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?float
     */
    protected function speed(): ?float
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?int
     */
    protected function signal(): ?int
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?int
     */
    protected function direction(): ?int
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?string
     */
    protected function datetime(): ?string
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?string
     */
    protected function country(): ?string
    {
        if (isset($this->cache['mcc'], $this->cache['mnc']) === false) {
            return null;
        }

        return $this->cache[__FUNCTION__] ??= helper()->mcc(
            $this->cache['mcc'],
            $this->cache['mnc']
        )?->iso;
    }

    /**
     * @return ?string
     */
    protected function timezone(): ?string
    {
        if (isset($this->cache['latitude'], $this->cache['longitude']) === false) {
            return null;
        }

        return $this->cache[__FUNCTION__] ??= helper()->latitudeLongitudeTimezone(
            $this->latitude(),
            $this->longitude(),
            $this->country()
        );
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return '*'.$this->maker().','.$this->serial().',V4,'.$this->type().','.date('YmdHis').'#';
    }
}

```

`app/Services/Protocol/H02/Parser/Sms.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\H02\Parser;

use App\Services\Protocol\ParserAbstract;

class Sms extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->values = explode(',', substr($this->message, 1, -1));

        $this->addIfValid($this->resourceSms());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return (bool)preg_match($this->messageIsValidRegExp(), $this->message);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'\*[A-Z]{2},' // 0 - maker
            .'[0-9]+,'     // 1 - serial
            .'SMS,'        // 2 - type
            .'.*'          // 3 - payload
            .'$/';
    }

    /**
     * @return string
     */
    protected function maker(): string
    {
        return $this->values[0];
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->values[1];
    }

    /**
     * @return string
     */
    protected function type(): string
    {
        return $this->values[2];
    }

    /**
     * @return array
     */
    protected function payload(): array
    {
        return $this->cache[__FUNCTION__] ??= explode(',', $this->values[3]);
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return '*'.$this->maker().','.$this->serial().',V4,'.$this->type().','.date('YmdHis').'#';
    }
}

```

`app/Services/Protocol/OsmAnd/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\OsmAnd;

use App\Services\Protocol\OsmAnd\Parser\Location as LocationParser;
use App\Services\Protocol\ProtocolAbstract;
use App\Services\Server\Http\Server;

class Manager extends ProtocolAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'osmand';
    }

    /**
     * @return string
     */
    public function name(): string
    {
        return 'OsmAnd';
    }

    /**
     * @param int $port
     *
     * @return \App\Services\Server\Http\Server
     */
    public function server(int $port): Server
    {
        return Server::new($port);
    }

    /**
     * @param string $message
     *
     * @return array
     */
    public function messages(string $message): array
    {
        if ($this->messageIsValidHex($message) === false) {
            return [];
        }

        return array_filter(array_map('trim', preg_split('/[\n\r]/', hex2bin($message))));
    }

    /**
     * @return array
     */
    protected function parsers(): array
    {
        return [
            LocationParser::class,
        ];
    }
}

```

`app/Services/Protocol/OsmAnd/Parser/Location.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\OsmAnd\Parser;

use App\Services\Protocol\ParserAbstract;

class Location extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->addIfValid($this->resourceLocation());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        if (preg_match($this->messageIsValidRegExp(), $this->message, $matches) === 0) {
            return false;
        }

        parse_str($matches[2], $this->values);

        $this->valuesMap();

        return $this->values['id']
            && $this->values['lat']
            && $this->values['lon']
            && $this->values['timestamp'];
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/(GET|POST) \/[^\?]*\?(.*) HTTP\/1/';
    }

    /**
     * @return void
     */
    protected function valuesMap(): void
    {
        $this->values = [
            'id' => $this->values['deviceid'] ?? $this->values['id'] ?? null,
            'lat' => floatval($this->values['lat'] ?? 0),
            'lon' => floatval($this->values['lon'] ?? 0),
            'timestamp' => intval($this->values['timestamp'] ?? 0),
            'speed' => floatval($this->values['speed'] ?? 0),
            'direction' => intval($this->values['direction'] ?? $this->values['bearing'] ?? 0),
            'valid' => boolval($this->values['valid'] ?? true),
        ];
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->values['id'];
    }

    /**
     * @return ?string
     */
    protected function type(): ?string
    {
        return $this->values['type'] ?? null;
    }

    /**
     * @return float
     */
    protected function latitude(): float
    {
        return $this->values['lat'];
    }

    /**
     * @return float
     */
    protected function longitude(): float
    {
        return $this->values['lon'];
    }

    /**
     * @return float
     */
    protected function speed(): float
    {
        return round($this->values['speed'], 2);
    }

    /**
     * @return int
     */
    protected function signal(): int
    {
        return intval($this->values['valid']);
    }

    /**
     * @return int
     */
    protected function direction(): int
    {
        return $this->values['direction'];
    }

    /**
     * @return ?string
     */
    protected function datetime(): ?string
    {
        return date('Y-m-d H:i:s', $this->values['timestamp']);
    }

    /**
     * @return ?string
     */
    protected function country(): ?string
    {
        return null;
    }

    /**
     * @return ?string
     */
    protected function timezone(): ?string
    {
        return helper()->latitudeLongitudeTimezone($this->latitude(), $this->longitude(), $this->country());
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return implode("\r\n", $this->responseHeaders())."\r\n\r\n";
    }

    /**
     * @return array
     */
    protected function responseHeaders(): array
    {
        return [
            'HTTP/1.1 200 OK',
            'Date: '.gmdate('r'),
            'Server: '.config('app.name'),
            'Cache-Control: no-cache, private',
            'Connection: close',
            'Content-Type: text/html; charset=UTF-8',
        ];
    }
}

```

`app/Services/Protocol/ParserAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol;

use App\Services\Protocol\Resource\Auth as ResourceAuth;
use App\Services\Protocol\Resource\Command as ResourceCommand;
use App\Services\Protocol\Resource\Heartbeat as ResourceHeartbeat;
use App\Services\Protocol\Resource\Location as ResourceLocation;
use App\Services\Protocol\Resource\ResourceAbstract;
use App\Services\Protocol\Resource\Sms as ResourceSms;

abstract class ParserAbstract
{
    /**
     * @var array
     */
    protected array $values = [];

    /**
     * @var array<\App\Services\Protocol\Resource\ResourceAbstract>
     */
    protected array $resources = [];

    /**
     * @var array
     */
    protected array $cache = [];

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param string $message
     * @param array $data = []
     *
     * @return self
     */
    public function __construct(protected string $message, protected array $data = [])
    {
    }

    /**
     * @return array<\App\Services\Protocol\Resource\ResourceAbstract>
     */
    public function resources(): array
    {
        return $this->resources;
    }

    /**
     * @return void
     */
    protected function add(ResourceAbstract $resource): void
    {
        $this->resources[] = $resource;
    }

    /**
     * @return void
     */
    protected function addIfValid(?ResourceAbstract $resource): void
    {
        if ($resource?->isValid()) {
            $this->add($resource);
        }
    }

    /**
     * @return \App\Services\Protocol\Resource\Auth
     */
    protected function resourceAuth(): ResourceAuth
    {
        return new ResourceAuth([
            'message' => $this->message(),
            'serial' => $this->serial(),
            'response' => $this->response(),
            'data' => $this->data(),
        ]);
    }

    /**
     * @return \App\Services\Protocol\Resource\Command
     */
    protected function resourceCommand(): ResourceCommand
    {
        return new ResourceCommand([
            'message' => $this->message(),
            'serial' => $this->serial(),
            'type' => $this->type(),
            'payload' => $this->payload(),
            'data' => $this->data(),
            'response' => $this->response(),
        ]);
    }

    /**
     * @return \App\Services\Protocol\Resource\Heartbeat
     */
    protected function resourceHeartbeat(): ResourceHeartbeat
    {
        return new ResourceHeartbeat([
            'message' => $this->message(),
            'serial' => $this->serial(),
            'data' => $this->data(),
            'response' => $this->response(),
        ]);
    }

    /**
     * @return \App\Services\Protocol\Resource\Location
     */
    protected function resourceLocation(): ResourceLocation
    {
        return new ResourceLocation([
            'message' => $this->message(),
            'serial' => $this->serial(),
            'latitude' => $this->latitude(),
            'longitude' => $this->longitude(),
            'speed' => $this->speed(),
            'signal' => $this->signal(),
            'direction' => $this->direction(),
            'datetime' => $this->datetime(),
            'timezone' => $this->timezone(),
            'data' => $this->data(),
            'response' => $this->response(),
        ]);
    }

    /**
     * @return \App\Services\Protocol\Resource\Sms
     */
    protected function resourceSms(): ResourceSms
    {
        return new ResourceSms([
            'message' => $this->message(),
            'serial' => $this->serial(),
            'type' => $this->type(),
            'payload' => $this->payload(),
            'response' => $this->response(),
        ]);
    }

    /**
     * @return string
     */
    protected function message(): string
    {
        return $this->message;
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return $this->data;
    }
}

```

`app/Services/Protocol/ProtocolAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol;

use App\Services\Server\ServerAbstract;

abstract class ProtocolAbstract
{
    /**
     * @return string
     */
    abstract public function code(): string;

    /**
     * @return string
     */
    abstract public function name(): string;

    /**
     * @param int $port
     *
     * @return \App\Services\Server\ServerAbstract
     */
    abstract public function server(int $port): ServerAbstract;

    /**
     * @param string $message
     *
     * @return array
     */
    abstract public function messages(string $message): array;

    /**
     * @return array
     */
    abstract protected function parsers(): array;

    /**
     * @param string $message
     * @param array $data = []
     *
     * @return array
     */
    public function resources(string $message, array $data = []): array
    {
        $resources = [];

        foreach ($this->messages($message) as $message) {
            foreach ($this->parsers() as $parser) {
                $valid = $parser::new($message, $data)->resources();

                if (empty($valid)) {
                    continue;
                }

                $resources = array_merge($resources, $valid);

                break;
            }
        }

        return $resources;
    }

    /**
     * @param string $message
     *
     * @return bool
     */
    protected function messageIsValidHex(string $message): bool
    {
        return $message && (strlen($message) % 2 === 0) && ctype_xdigit($message);
    }
}

```

`app/Services/Protocol/ProtocolFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol;

use App\Exceptions\UnexpectedValueException;
use App\Services\Protocol\Aquila\Manager as AquilaManager;
use App\Services\Protocol\DebugHttp\Manager as DebugHttpManager;
use App\Services\Protocol\DebugSocket\Manager as DebugSocketManager;
use App\Services\Protocol\GPS103\Manager as GPS103Manager;
use App\Services\Protocol\GT06\Manager as GT06Manager;
use App\Services\Protocol\H02\Manager as H02Manager;
use App\Services\Protocol\OsmAnd\Manager as OsmAndManager;
use App\Services\Protocol\Queclink\Manager as QueclinkManager;
use App\Services\Protocol\Teltonika\Manager as TeltonikaManager;
use App\Services\Protocol\TK102\Manager as TK102Manager;

class ProtocolFactory
{
    /**
     * @return array
     */
    public static function list(): array
    {
        return [
            'aquila' => AquilaManager::class,
            'debug-http' => DebugHttpManager::class,
            'debug-socket' => DebugSocketManager::class,
            'gps103' => GPS103Manager::class,
            'gt06' => GT06Manager::class,
            'h02' => H02Manager::class,
            'osmand' => OsmAndManager::class,
            'queclink' => QueclinkManager::class,
            'teltonika' => TeltonikaManager::class,
            'tk102' => TK102Manager::class,
        ];
    }

    /**
     * @param string $code
     *
     * @return \App\Services\Protocol\ProtocolAbstract
     */
    public static function get(string $code): ProtocolAbstract
    {
        return static::new(static::class($code));
    }

    /**
     * @param ?string $class
     *
     * @return \App\Services\Protocol\ProtocolAbstract
     */
    protected static function new(?string $class): ProtocolAbstract
    {
        if ($class === null) {
            throw new UnexpectedValueException(__('protocol.port-not-found'));
        }

        return new $class();
    }

    /**
     * @param string $code
     *
     * @return ?string
     */
    protected static function class(string $code): ?string
    {
        return static::list()[$code] ?? null;
    }
}

```

`app/Services/Protocol/Queclink/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Queclink;

use App\Services\Protocol\ProtocolAbstract;
use App\Services\Protocol\Queclink\Parser\Location as LocationParser;
use App\Services\Server\Socket\Server;

class Manager extends ProtocolAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'queclink';
    }

    /**
     * @return string
     */
    public function name(): string
    {
        return 'Queclink';
    }

    /**
     * @param int $port
     *
     * @return \App\Services\Server\Socket\Server
     */
    public function server(int $port): Server
    {
        return Server::new($port)
            ->socketType('stream')
            ->socketProtocol('ip');
    }

    /**
     * @param string $message
     *
     * @return array
     */
    public function messages(string $message): array
    {
        if ($this->messageIsValidHex($message) === false) {
            return [];
        }

        preg_match_all('/\+[^\$]+\$/', hex2bin($message), $matches);

        return $matches[0];
    }

    /**
     * @return array
     */
    protected function parsers(): array
    {
        return [
            LocationParser::class,
        ];
    }
}

```

`app/Services/Protocol/Queclink/Parser/Location.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Queclink\Parser;

use App\Services\Protocol\ParserAbstract;

class Location extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->values = explode(',', substr($this->message, 0, -1));

        $this->addIfValid($this->resourceLocation());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return (bool)preg_match($this->messageIsValidRegExp(), $this->message);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'\+(RESP|BUFF):GTFRI,'        //  0 - response code
            .'[0-9A-Z]+,'                  //  1 - protocol version
            .'[0-9]{15},'                  //  2 - serial
            .'[0-9A-Za-z_-]{0,20},'        //  3 - device name
            .','                           //  4 - reserved
            .'[0-9]{0,5},'                 //  5 - external power voltage
            .'[0-9]{2},'                   //  6 - report id
            .'[0-9]{1,2},'                 //  7 - number
            .'[0-9]{1,2},'                 //  8 - gnss accuracy
            .'[0-9]{1,3}\.[0-9],'          //  9 - speed
            .'[0-9]{1,3},'                 // 10 - direction
            .'\-?[0-9]{1,5}\.[0-9],'       // 11 - altitude
            .'\-?[0-9]{1,3}\.[0-9]{0,6},'  // 12 - longitude
            .'\-?[0-9]{1,2}\.[0-9]{0,6},'  // 13 - latitude
            .'[0-9]{14},'                  // 14 - utc time
            .'[0-9A-Z]{0,4},'              // 15 - mcc
            .'[0-9A-Z]{0,4},'              // 16 - mnc
            .'[0-9A-Z]{0,4},'              // 17 - lac
            .'[0-9A-Z]{0,8},'              // 18 - cell id
            .'/';
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->values[2];
    }

    /**
     * @return string
     */
    protected function type(): string
    {
        return explode(':', $this->values[0])[1];
    }

    /**
     * @return float
     */
    protected function latitude(): float
    {
        return floatval($this->values[13]);
    }

    /**
     * @return float
     */
    protected function longitude(): float
    {
        return floatval($this->values[12]);
    }

    /**
     * @return float
     */
    protected function speed(): float
    {
        return floatval($this->values[9]);
    }

    /**
     * @return int
     */
    protected function signal(): int
    {
        return intval($this->values[8]);
    }

    /**
     * @return int
     */
    protected function direction(): int
    {
        return intval($this->values[10]);
    }

    /**
     * @return string
     */
    protected function datetime(): string
    {
        $date = str_split($this->values[14], 2);

        return $date[0].$date[1].'-'.$date[2].'-'.$date[3].' '.$date[4].':'.$date[5].':'.$date[6];
    }

    /**
     * @return ?string
     */
    protected function country(): ?string
    {
        return $this->cache[__FUNCTION__] ??= helper()->mcc(
            intval($this->values[15]),
            intval($this->values[16])
        )?->iso;
    }

    /**
     * @return ?string
     */
    protected function timezone(): ?string
    {
        return $this->cache[__FUNCTION__] ??= helper()->latitudeLongitudeTimezone(
            $this->latitude(),
            $this->longitude(),
            $this->country()
        );
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return '+SACK:'.end($this->values).'$';
    }
}

```

`app/Services/Protocol/Resource/Auth.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Resource;

class Auth extends ResourceAbstract
{
    /**
     * @return array
     */
    protected function attributesAvailable(): array
    {
        return ['message', 'serial', 'data', 'response'];
    }

    /**
     * @return string
     */
    public function format(): string
    {
        return 'auth';
    }

    /**
     * @return bool
     */
    public function isValid(): bool
    {
        return boolval($this->serial());
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function serial(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function response(): string
    {
        return $this->attribute(__FUNCTION__);
    }
}

```

`app/Services/Protocol/Resource/Command.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Resource;

class Command extends ResourceAbstract
{
    /**
     * @return array
     */
    protected function attributesAvailable(): array
    {
        return ['message', 'serial', 'type', 'payload', 'data', 'response'];
    }

    /**
     * @return string
     */
    public function format(): string
    {
        return 'command';
    }

    /**
     * @return bool
     */
    public function isValid(): bool
    {
        return $this->serial()
            && $this->type();
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function serial(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function type(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return ?array
     */
    public function payload(): ?array
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function response(): string
    {
        return $this->attribute(__FUNCTION__);
    }
}

```

`app/Services/Protocol/Resource/Heartbeat.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Resource;

class Heartbeat extends ResourceAbstract
{
    /**
     * @return array
     */
    protected function attributesAvailable(): array
    {
        return ['message', 'serial', 'data', 'response'];
    }

    /**
     * @return string
     */
    public function format(): string
    {
        return 'heartbeat';
    }

    /**
     * @return bool
     */
    public function isValid(): bool
    {
        return boolval($this->serial());
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function serial(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function response(): string
    {
        return $this->attribute(__FUNCTION__);
    }
}

```

`app/Services/Protocol/Resource/Location.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Resource;

class Location extends ResourceAbstract
{
    /**
     * @return array
     */
    protected function attributesAvailable(): array
    {
        return [
            'message', 'serial', 'type', 'latitude', 'longitude', 'speed',
            'signal', 'direction', 'datetime', 'timezone', 'country', 'data', 'response',
        ];
    }

    /**
     * @return string
     */
    public function format(): string
    {
        return 'location';
    }

    /**
     * @return bool
     */
    public function isValid(): bool
    {
        return $this->serial()
            && $this->latitude()
            && $this->longitude()
            && $this->datetime();
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function serial(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return ?string
     */
    public function type(): ?string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return ?float
     */
    public function latitude(): ?float
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return ?float
     */
    public function longitude(): ?float
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return ?float
     */
    public function speed(): ?float
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return ?int
     */
    public function signal(): ?int
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return ?int
     */
    public function direction(): ?int
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return ?string
     */
    public function datetime(): ?string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return ?string
     */
    public function timezone(): ?string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return ?string
     */
    public function country(): ?string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function response(): string
    {
        return $this->attribute(__FUNCTION__);
    }
}

```

`app/Services/Protocol/Resource/ResourceAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Resource;

abstract class ResourceAbstract
{
    /**
     * @var array
     */
    protected array $attributes = [];

    /**
     * @return string
     */
    abstract public function format(): string;

    /**
     * @return bool
     */
    abstract public function isValid(): bool;

    /**
     * @return string
     */
    abstract public function message(): string;

    /**
     * @return string
     */
    abstract public function serial(): string;

    /**
     * @return string
     */
    abstract public function response(): string;

    /**
     * @return array
     */
    abstract protected function attributesAvailable(): array;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param array $attributes
     *
     * @return self
     */
    public function __construct(array $attributes)
    {
        $this->attributes($attributes);
    }

    /**
     * @param array $attributes
     *
     * @return void
     */
    protected function attributes(array $attributes): void
    {
        array_map(fn ($key) => $this->attributes[$key] = $attributes[$key] ?? null, $this->attributesAvailable());
    }

    /**
     * @param string $key
     * @param mixed $default = null
     *
     * @return mixed
     */
    protected function attribute(string $key, mixed $default = null): mixed
    {
        return $this->attributes[$key] ?? $default;
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->attribute(__FUNCTION__, []);
    }

    /**
     * @return array
     */
    public function toArray(): array
    {
        return $this->attributes;
    }

    /**
     * @return string
     */
    public function toJson(): string
    {
        return json_encode($this->attributes, JSON_INVALID_UTF8_IGNORE | JSON_PARTIAL_OUTPUT_ON_ERROR | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
    }
}

```

`app/Services/Protocol/Resource/Sms.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Resource;

class Sms extends ResourceAbstract
{
    /**
     * @return array
     */
    protected function attributesAvailable(): array
    {
        return ['message', 'serial', 'type', 'payload', 'data', 'response'];
    }

    /**
     * @return string
     */
    public function format(): string
    {
        return 'sms';
    }

    /**
     * @return bool
     */
    public function isValid(): bool
    {
        return $this->serial()
            && $this->type();
    }

    /**
     * @return string
     */
    public function message(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function serial(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function type(): string
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return array
     */
    public function payload(): array
    {
        return $this->attribute(__FUNCTION__);
    }

    /**
     * @return string
     */
    public function response(): string
    {
        return $this->attribute(__FUNCTION__);
    }
}

```

`app/Services/Protocol/TK102/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\TK102;

use App\Services\Protocol\ProtocolAbstract;
use App\Services\Protocol\TK102\Parser\Command as CommandParser;
use App\Services\Protocol\TK102\Parser\Location as LocationParser;
use App\Services\Server\Socket\Server;

class Manager extends ProtocolAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'tk102';
    }

    /**
     * @return string
     */
    public function name(): string
    {
        return 'TK102';
    }

    /**
     * @param int $port
     *
     * @return \App\Services\Server\Socket\Server
     */
    public function server(int $port): Server
    {
        return Server::new($port)
            ->socketType('stream')
            ->socketProtocol('ip');
    }

    /**
     * @return array
     */
    protected function parsers(): array
    {
        return [
            CommandParser::class,
            LocationParser::class,
        ];
    }

    /**
     * @param string $message
     *
     * @return array
     */
    public function messages(string $message): array
    {
        if ($this->messageIsValidHex($message) === false) {
            return [];
        }

        return array_filter(array_map('trim', preg_split('/[\n\r]/', hex2bin($message))));
    }
}

```

`app/Services/Protocol/TK102/Parser/Command.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\TK102\Parser;

use App\Services\Protocol\ParserAbstract;

class Command extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->addIfValid($this->resourceCommand());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        foreach ($this->validResponses() as $response) {
            if (str_starts_with($this->message, $response)) {
                return true;
            }
        }

        return false;
    }

    /**
     * @return array
     */
    protected function validResponses(): array
    {
        return [
            'begin', 'password', 'admin', 'noadmin',
            'notn', 'monitor', 'tracker', 'stockade', 'nostockage',
            'move', 'nomove', 'speed', 'nospeed', 'help',
        ];
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->data['serial'];
    }

    /**
     * @return string
     */
    protected function type(): string
    {
        foreach ($this->validResponses() as $response) {
            if (str_starts_with($this->message, $response)) {
                return $response;
            }
        }

        return '';
    }

    /**
     * @return array
     */
    protected function payload(): array
    {
        return [$this->message];
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return '';
    }
}

```

`app/Services/Protocol/TK102/Parser/Location.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\TK102\Parser;

use App\Services\Protocol\ParserAbstract;

class Location extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->values = explode(',', $this->message);

        $this->addIfValid($this->resourceLocation());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return $this->messageIsValidParse()
            && $this->messageIsValidType();
    }

    /**
     * @return bool
     */
    public function messageIsValidParse(): bool
    {
        return (bool)preg_match($this->messageIsValidRegExp(), $this->message);
    }

    /**
     * @return string
     */
    protected function messageIsValidRegExp(): string
    {
        return '/^'
            .'[0-9]{10,},'           //  0 - local date/time (yymmddhhnn)
            .'[\+0-9]*,'             //  1 - admin phone
            .'GPRMC,'                //  2 - GPRMC sub-protocol part signature
            .'[0-9]+\.[0-9]+,'       //  3 - GPS time (hhnnss.tps)
            .'[AV],'                 //  4 - position status (A = data valid, V = data invalid)
            .'[0-9]+\.[0-9]+,'       //  5 - latitude
            .'[NS],'                 //  6 - latitude direction
            .'[0-9]+\.[0-9]+,'       //  7 - longitude
            .'[EW],'                 //  8 - longitude direction
            .'[0-9]+\.[0-9]+,'       //  9 - speed
            .'[0-9\.]*,'             // 10 - direction
            .'[0-9]+,'               // 11 - GPS date (ddmmyy)
            .'[0-9\.]*,'             // 12 - magnetic variation
            .'[EW]?,'                // 13 - magnetic variation direction
            .'[ADEMN]\*[0-9A-F]{2},' // 14 - positioning system mode indicator (A = Autonomous, N = Data not valid), asterisk instead of comma, 16-bit hex checksum
            .'[FL],'                 // 15 - GPS signal level (F = good, L = bad)
            .'(.+,)?'                // 16 - optional "help me" with comma if SOS button pressed
            .'imei:[0-9]+,'          // 16 or 17 - serial
            .'[0-9]+'                // 17 or 18 - altitude? (plus some garbage)
            .'/';
    }

    /**
     * @return bool
     */
    public function messageIsValidType(): bool
    {
        return intval(substr($this->message, 0, 10)) !== 0;
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        $index = 16;

        if (str_starts_with($this->values[$index], 'imei') === false) {
            $index++; // SOS button pressed
        }

        return trim(explode(':', $this->values[$index])[1]);
    }

    /**
     * @return float
     */
    protected function latitude(): float
    {
        if (isset($this->cache[__FUNCTION__])) {
            return $this->cache[__FUNCTION__];
        }

        $degree = intval(substr($this->values[5], 0, 2));
        $minute = floatval(substr($this->values[5], 2));
        $direction = floatval(str_replace(['S', 'N'], ['-1', '1'], $this->values[6]));

        $latitude = round(($degree + ($minute / 60)) * $direction, 5);

        if (($latitude < -90) || ($latitude > 90)) {
            $latitude = 0.0;
        }

        return $this->cache[__FUNCTION__] = $latitude;
    }

    /**
     * @return float
     */
    protected function longitude(): float
    {
        if (isset($this->cache[__FUNCTION__])) {
            return $this->cache[__FUNCTION__];
        }

        $degree = intval(substr($this->values[7], 0, 3));
        $minute = floatval(substr($this->values[7], 3));
        $direction = floatval(str_replace(['W', 'E'], ['-1', '1'], $this->values[8]));

        $longitude = round(($degree + ($minute / 60)) * $direction, 5);

        if (($longitude < -180) || ($longitude > 180)) {
            $longitude = 0.0;
        }

        return $this->cache[__FUNCTION__] = $longitude;
    }

    /**
     * @return float
     */
    protected function speed(): float
    {
        return round(floatval($this->values[9]) * 1.852, 2);
    }

    /**
     * @return int
     */
    protected function signal(): int
    {
        return ($this->values[15] === 'F') ? 1 : 0;
    }

    /**
     * @return int
     */
    protected function direction(): int
    {
        return intval($this->values[10]);
    }

    /**
     * @return ?string
     */
    protected function datetime(): ?string
    {
        $date = str_split($this->values[11], 2);
        $time = str_split(substr($this->values[3], 0, 6), 2);

        if (count($date) !== 3 || count($time) !== 3) {
            return null;
        }

        return '20'.$date[2].'-'.$date[1].'-'.$date[0].' '.$time[0].':'.$time[1].':'.$time[2];
    }

    /**
     * @return ?string
     */
    protected function timezone(): ?string
    {
        return $this->cache[__FUNCTION__] ??= helper()->latitudeLongitudeTimezone(
            $this->latitude(),
            $this->longitude(),
        );
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return '';
    }
}

```

`app/Services/Protocol/Teltonika/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Teltonika;

use App\Services\Protocol\ProtocolAbstract;
use App\Services\Protocol\Teltonika\Parser\Auth as AuthParser;
use App\Services\Protocol\Teltonika\Parser\Locations as LocationsParser;
use App\Services\Server\Socket\Server;

class Manager extends ProtocolAbstract
{
    /**
     * @return string
     */
    public function code(): string
    {
        return 'teltonika';
    }

    /**
     * @return string
     */
    public function name(): string
    {
        return 'Teltonika';
    }

    /**
     * @param int $port
     *
     * @return \App\Services\Server\Socket\Server
     */
    public function server(int $port): Server
    {
        return Server::new($port)
            ->socketType('stream')
            ->socketProtocol('ip');
    }

    /**
     * @param string $message
     *
     * @return array
     */
    public function messages(string $message): array
    {
        return [$message];
    }

    /**
     * @return array
     */
    protected function parsers(): array
    {
        return [
            AuthParser::class,
            LocationsParser::class,
        ];
    }
}

```

`app/Services/Protocol/Teltonika/Parser/Auth.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Teltonika\Parser;

use App\Services\Protocol\ParserAbstract;

class Auth extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->addIfValid($this->resourceAuth());

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return $this->messageIsValidLength()
            && $this->messageIsValidSerial();
    }

    /**
     * @return bool
     */
    public function messageIsValidLength(): bool
    {
        return strlen($this->message) === 34;
    }

    /**
     * @return bool
     */
    protected function messageIsValidSerial(): bool
    {
        $length = hexdec(substr($this->message, 0, 4));
        $imei = hex2bin(substr($this->message, 4, $length * 2));

        if (strlen($imei) !== $length) {
            return false;
        }

        $this->cache['serial'] = $imei;

        return true;
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->cache[__FUNCTION__];
    }

    /**
     * @return array
     */
    protected function data(): array
    {
        return ['serial' => $this->serial()];
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return "\x01";
    }
}

```

`app/Services/Protocol/Teltonika/Parser/Codec.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Teltonika\Parser;

class Codec
{
    /**
     * @const string
     */
    public const CODEC_8 = '08';

    /**
     * @const string
     */
    public const CODEC_8_EXT = '8e';

    /**
     * @const string
     */
    public const CODEC_12 = '0c';

    /**
     * @const string
     */
    public const CODEC_16 = '10';
}

```

`app/Services/Protocol/Teltonika/Parser/Location.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Teltonika\Parser;

use App\Services\Buffer\Byte as BufferByte;
use App\Services\Protocol\ParserAbstract;
use App\Services\Protocol\Resource\Location as LocationResource;

class Location extends ParserAbstract
{
    /**
     * @var \App\Services\Buffer\Byte
     */
    protected BufferByte $buffer;

    /**
     * @var string
     */
    protected string $codec;

    /**
     * @var int
     */
    protected int $total;

    /**
     * @param \App\Services\Buffer\Byte $buffer
     *
     * @return self
     */
    public function buffer(BufferByte $buffer): self
    {
        $this->buffer = $buffer;

        return $this;
    }

    /**
     * @param string $codec
     *
     * @return self
     */
    public function codec(string $codec): self
    {
        $this->codec = $codec;

        return $this;
    }

    /**
     * @param int $total
     *
     * @return self
     */
    public function total(int $total): self
    {
        $this->total = $total;

        return $this;
    }

    /**
     * @return \App\Services\Protocol\Resource\Location
     */
    public function resource(): LocationResource
    {
        $this->trackStart();
        $this->gps();
        $this->attributes();
        $this->trackEnd();

        return $this->resourceLocation();
    }

    /**
     * @return void
     */
    protected function trackStart(): void
    {
        $this->buffer->trackStart();
    }

    /**
     * @return void
     */
    protected function trackEnd(): void
    {
        $this->cache['message'] = $this->buffer->trackEnd();
    }

    /**
     * @return void
     */
    protected function gps(): void
    {
        $this->cache['datetime'] = date('Y-m-d H:i:s', intval($this->buffer->int(8) / 1000));

        $this->buffer->int(1); // priority

        $this->cache['longitude'] = $this->buffer->intSigned(4) / 10000000;
        $this->cache['latitude'] = $this->buffer->intSigned(4) / 10000000;

        $this->buffer->int(2); // altitude

        $this->cache['direction'] = $this->buffer->int(2);
        $this->cache['signal'] = $this->buffer->int(1);
        $this->cache['speed'] = round($this->buffer->int(2), 2);
    }

    /**
     * @return void
     */
    protected function attributes(): void
    {
        $this->buffer->intIf($this->codec, [Codec::CODEC_8_EXT, Codec::CODEC_16]);

        if ($this->codec === Codec::CODEC_16) {
            $this->buffer->int(1);
        }

        $this->buffer->intIf($this->codec, [Codec::CODEC_8_EXT]);

        $this->attributesBytes(1);
        $this->attributesBytes(2);
        $this->attributesBytes(4);

        if (in_array($this->codec, [Codec::CODEC_8, Codec::CODEC_8_EXT, Codec::CODEC_16])) {
            $this->attributesBytes(8);
        }

        if ($this->codec === Codec::CODEC_8_EXT) {
            $this->attributesCodec8Ext();
        }
    }

    /**
     * @param int $bytes
     *
     * @return void
     */
    protected function attributesBytes(int $bytes): void
    {
        $count = $this->buffer->intIf($this->codec, [Codec::CODEC_8_EXT]);

        for ($i = 0; $i < $count; $i++) {
            $this->buffer->intIf($this->codec, [Codec::CODEC_8_EXT, Codec::CODEC_16]);
            $this->buffer->int($bytes);
        }
    }

    /**
     * @return void
     */
    protected function attributesCodec8Ext(): void
    {
        $count = $this->buffer->int(2);

        for ($i = 0; $i < $count; $i++) {
            $this->buffer->int(2);
            $this->buffer->string($this->buffer->int(2));
        }
    }

    /**
     * @return string
     */
    protected function message(): string
    {
        return $this->cache[__FUNCTION__];
    }

    /**
     * @return string
     */
    protected function serial(): string
    {
        return $this->data['serial'];
    }

    /**
     * @return ?float
     */
    protected function latitude(): ?float
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?float
     */
    protected function longitude(): ?float
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?float
     */
    protected function speed(): ?float
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?int
     */
    protected function signal(): ?int
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?int
     */
    protected function direction(): ?int
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?string
     */
    protected function datetime(): ?string
    {
        return $this->cache[__FUNCTION__] ?? null;
    }

    /**
     * @return ?string
     */
    protected function country(): ?string
    {
        if (isset($this->cache['mcc'], $this->cache['mnc']) === false) {
            return null;
        }

        return $this->cache[__FUNCTION__] ??= helper()->mcc(
            $this->cache['mcc'],
            $this->cache['mnc']
        )?->iso;
    }

    /**
     * @return ?string
     */
    protected function timezone(): ?string
    {
        if (isset($this->cache['latitude'], $this->cache['longitude']) === false) {
            return null;
        }

        return $this->cache[__FUNCTION__] ??= helper()->latitudeLongitudeTimezone(
            $this->latitude(),
            $this->longitude(),
            $this->country()
        );
    }

    /**
     * @return string
     */
    protected function response(): string
    {
        return pack('N', $this->total);
    }
}

```

`app/Services/Protocol/Teltonika/Parser/Locations.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Protocol\Teltonika\Parser;

use App\Services\Buffer\Byte as BufferByte;
use App\Services\Protocol\ParserAbstract;

class Locations extends ParserAbstract
{
    /**
     * @return array
     */
    public function resources(): array
    {
        if ($this->messageIsValid() === false) {
            return [];
        }

        $this->read();

        return $this->resources;
    }

    /**
     * @return bool
     */
    public function messageIsValid(): bool
    {
        return $this->messageIsValidSerial()
            && $this->messageIsValidStart();
    }

    /**
     * @return bool
     */
    public function messageIsValidStart(): bool
    {
        return hexdec(substr($this->message, 0, 8)) === 0;
    }

    /**
     * @return bool
     */
    protected function messageIsValidSerial(): bool
    {
        return empty($this->data['serial']) === false;
    }

    /**
     * @return void
     */
    protected function read(): void
    {
        $length = hexdec(substr($this->message, 8, 8));
        $buffer = new BufferByte(substr($this->message, 16, $length * 2));

        $codec = $buffer->string(1);

        if ($this->isValidCodec($codec) === false) {
            return;
        }

        $count = $buffer->int(1);

        for ($i = 0; $i < $count; $i++) {
            $this->readResource($buffer, $codec, $count);
        }
    }

    /**
     * @return bool
     */
    protected function isValidCodec(string $codec): bool
    {
        return in_array($codec, [Codec::CODEC_8, Codec::CODEC_8_EXT, Codec::CODEC_16]);
    }

    /**
     * @param \App\Services\Buffer\Byte $buffer
     * @param string $codec
     * @param int $count
     *
     * @return void
     */
    protected function readResource(BufferByte $buffer, string $codec, int $count): void
    {
        $this->addIfValid(
            Location::new('', $this->data)
                ->buffer($buffer)
                ->codec($codec)
                ->total($count)
                ->resource()
        );
    }
}

```

`app/Services/Request/Response.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Request;

class Response
{
    /**
     * @var int
     */
    protected static $status = 200;

    /**
     * @param ?int $status = null
     *
     * @return int
     */
    public static function status(?int $status = null): int
    {
        if ($status !== null) {
            static::$status = static::get($status);
        }

        return static::$status;
    }

    /**
     * @param int $status
     *
     * @return int
     */
    protected static function get(int $status): int
    {
        return (($status >= 200) && ($status <= 500)) ? $status : 500;
    }
}

```

`app/Services/Request/Logger.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Request;

use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;
use App\Services\Logger\RotatingFileAbstract;

class Logger extends RotatingFileAbstract
{
    /**
     * @var array
     */
    protected static array $exclude = [
        'headers' => ['authorization', 'cookie', 'php-auth-user', 'php-auth-pw'],
        'headers-test' => ['cookie'],

        'input' => ['password'],
        'input-test' => [],
    ];

    /**
     * @var array
     */
    protected static array $excludeTest = ['cookie'];

    /**
     * @return string
     */
    protected static function folder(): string
    {
        return 'requests';
    }

    /**
     * @return string
     */
    protected static function path(): string
    {
        return date('Y/m/Y-m-d');
    }

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Symfony\Component\HttpFoundation\Response $response
     *
     * @return void
     */
    public static function fromRequestAndResponse(Request $request, Response $response): void
    {
        if (config('logging.channels.request.enabled') !== true) {
            return;
        }

        $type = static::responseType($response);

        static::$type($request->url(), static::data($request, [
            'response' => static::response($request, $response),
            'status' => $response->getStatusCode(),
        ]));
    }

    /**
     * @param \Illuminate\Http\Request $request
     * @param array $data = []
     *
     * @psalm-suppress UndefinedConstant
     *
     * @return array
     */
    protected static function data(Request $request, array $data = []): array
    {
        return [
            'ip' => $request->ip(),
            'method' => $request->method(),
            'headers' => static::headers($request),
            'input' => static::input($request),
            'execution_time' => sprintf('%.3f', microtime(true) - LARAVEL_START),
            'memory_usage' => round(memory_get_peak_usage(false) / 1024 / 1024, 2),
        ] + $data;
    }

    /**
     * @param \Illuminate\Http\Request $request
     *
     * @return array
     */
    protected static function headers(Request $request): array
    {
        return static::hidden($request->headers->all(), static::exclude('headers'));
    }

    /**
     * @param \Illuminate\Http\Request $request
     *
     * @return array
     */
    protected static function input(Request $request): array
    {
        return static::hidden($request->input(), static::exclude('input'));
    }

    /**
     * @param \Symfony\Component\HttpFoundation\Response $response
     *
     * @return string
     */
    protected static function responseType(Response $response): string
    {
        return match (substr(strval($response->getStatusCode()), 0, 1)) {
            '1', '2', '3' => 'info',
            default => 'error',
        };
    }

    /**
     * @param \Illuminate\Http\Request $request
     * @param \Symfony\Component\HttpFoundation\Response $response
     *
     * @return mixed
     */
    protected static function response(Request $request, Response $response): mixed
    {
        if (($request->wantsJson() === false) && ($request->isJson() === false)) {
            return null;
        }

        return method_exists($response, 'getData')
            ? $response->getData()
            : $response->getContent();
    }

    /**
     * @param string $name
     *
     * @return array
     */
    protected static function exclude(string $name): array
    {
        return static::$exclude[$name.(config('app.test') ? '-test' : '')];
    }

    /**
     * @param array $input
     * @param array $keys
     *
     * @return array
     */
    protected static function hidden(array $input, array $keys): array
    {
        foreach (array_unique($keys) as $each) {
            if (isset($input[$each])) {
                $input[$each] = 'HIDDEN';
            }
        }

        return $input;
    }
}

```

`app/Services/Server/Connection.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Server;

use Socket;
use Throwable;

class Connection
{
    /**
     * @const int
     */
    protected const TIMEOUT = 600;

    /**
     * @var string
     */
    protected string $id;

    /**
     * @var int
     */
    protected int $timestamp;

    /**
     * @var string
     */
    protected string $clientIp;

    /**
     * @var int
     */
    protected int $clientPort;

    /**
     * @var array
     */
    protected array $data = [];

    /**
     * @param int $serverPort
     * @param ?\Socket $socket
     *
     * @return self
     */
    public function __construct(protected int $serverPort, protected ?Socket $socket)
    {
        $this->setId();
        $this->setClient();
        $this->refresh();
    }

    /**
     * @return int
     */
    public function getServerPort(): int
    {
        return $this->serverPort;
    }

    /**
     * @return bool
     */
    public function isDebuggable(): bool
    {
        return $this->getClientIp() !== '127.0.0.1';
    }

    /**
     * @return self
     */
    protected function setId(): self
    {
        $this->id = uniqid();

        return $this;
    }

    /**
     * @return string
     */
    public function getId(): string
    {
        return $this->id;
    }

    /**
     * @return self
     */
    protected function setClient(): self
    {
        if (empty($this->socket)) {
            return $this;
        }

        socket_getpeername($this->socket, $address, $port);

        $this->clientIp = $address;
        $this->clientPort = $port;

        return $this;
    }

    /**
     * @return string
     */
    public function getClientIp(): string
    {
        return $this->clientIp;
    }

    /**
     * @return int
     */
    public function getClientPort(): int
    {
        return $this->clientPort;
    }

    /**
     * @return int
     */
    public function getTimestamp(): int
    {
        return $this->timestamp;
    }

    /**
     * @return self
     */
    public function refresh(): self
    {
        $this->timestamp = time();

        return $this;
    }

    /**
     * @param array $data
     *
     * @return self
     */
    public function setData(array $data): self
    {
        $this->data = array_merge($this->data, $data);

        return $this;
    }

    /**
     * @return array
     */
    public function getData(): array
    {
        return $this->data;
    }

    /**
     * @return ?\Socket
     */
    public function getSocket(): ?Socket
    {
        return $this->socket;
    }

    /**
     * @return void
     */
    public function close(): void
    {
        if ($this->socket) {
            try {
                socket_close($this->socket);
            } catch (Throwable $e) {
                $this->error($e);
            }
        }

        $this->socket = null;
    }

    /**
     * @return bool
     */
    public function isValid(): bool
    {
        return $this->socket
            && ($this->socket instanceof Socket)
            && ((time() - $this->timestamp) < static::TIMEOUT);
    }

    /**
     * @return array
     */
    public function __toArray(): array
    {
        return [
            'id' => $this->getId(),
            'timestamp' => $this->getTimestamp(),
            'server_port' => $this->getServerPort(),
            'client_ip' => $this->getClientIp(),
            'client_port' => $this->getClientPort(),
            'valid' => $this->isValid(),
        ];
    }

    /**
     * @param \Throwable $e
     *
     * @return void
     */
    protected function error(Throwable $e): void
    {
        logger()->error($e);

        if ($this->errorIsReportable($e)) {
            report($e);
        }
    }

    /**
     * @param \Throwable $e
     *
     * @return bool
     */
    protected function errorIsReportable(Throwable $e): bool
    {
        return (str_contains($e->getMessage(), ' closed ') === false)
            && (str_contains($e->getMessage(), ' unable to write to socket') === false)
            && (str_contains($e->getMessage(), ' reset by peer') === false);
    }
}

```

`app/Services/Server/Http/Client.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Server\Http;

use Closure;
use stdClass;
use Throwable;
use App\Services\Protocol\Resource\ResourceAbstract;

class Client
{
    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param \stdClass $client
     * @param \Closure $handler
     *
     * @return self
     */
    public function __construct(protected stdClass $client, protected Closure $handler)
    {
    }

    /**
     * @return void
     */
    public function handle(): void
    {
        if ($buffer = $this->readBuffer()) {
            $this->handleBuffer($buffer);
        }

        $this->close();
    }

    /**
     * @param string $buffer
     *
     * @return void
     */
    protected function handleBuffer(string $buffer): void
    {
        foreach ($this->readHandle($buffer) as $resource) {
            $this->readResource($resource);
        }
    }

    /**
     * @return ?string
     */
    protected function readBuffer(): ?string
    {
        if ($this->isSocket() === false) {
            return null;
        }

        if (($buffer = fread($this->client->socket, 2048)) === false) {
            return null;
        }

        return bin2hex($buffer);
    }

    /**
     * @param string $buffer
     *
     * @return array
     */
    protected function readHandle(string $buffer): array
    {
        $this->client->timestamp = time();

        try {
            return ($this->handler)($buffer);
        } catch (Throwable $e) {
            $this->error($e);
        }

        return [];
    }

    /**
     * @param \App\Services\Protocol\Resource\ResourceAbstract $resource
     *
     * @return void
     */
    protected function readResource(ResourceAbstract $resource): void
    {
        $this->readResourceResponse($resource);
    }

    /**
     * @param \App\Services\Protocol\Resource\ResourceAbstract $resource
     *
     * @return void
     */
    protected function readResourceResponse(ResourceAbstract $resource): void
    {
        fwrite($this->client->socket, $resource->response());
    }

    /**
     * @return bool
     */
    protected function isSocket(): bool
    {
        return is_resource($this->client->socket);
    }

    /**
     * @return void
     */
    protected function close(): void
    {
        if ($this->isSocket()) {
            try {
                fclose($this->client->socket);
            } catch (Throwable $e) {
                $this->error($e);
            }
        }

        $this->client->socket = null;
    }

    /**
     * @param \Throwable $e
     *
     * @return void
     */
    protected function error(Throwable $e): void
    {
        if ($this->errorIsReportable($e)) {
            report($e);
        }
    }

    /**
     * @param \Throwable $e
     *
     * @return bool
     */
    protected function errorIsReportable(Throwable $e): bool
    {
        return str_contains($e->getMessage(), ' closed ') === false;
    }
}

```

`app/Services/Server/Http/Server.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Server\Http;

use Closure;
use stdClass;
use Throwable;
use App\Services\Server\ServerAbstract;

class Server extends ServerAbstract
{
    /**
     * @const int
     */
    protected const SOCKET_TIMEOUT = 600;

    /**
     * @var ?resource
     */
    protected $socket;

    /**
     * @var array
     */
    protected array $clients = [];

    /**
     * @param \Closure $handler
     *
     * @return void
     */
    public function accept(Closure $handler): void
    {
        $this->create();

        set_time_limit(0);

        $this->gracefulShutdown();

        try {
            $this->read($handler);
        } catch (Throwable $e) {
            $this->error($e);
            $this->stop();
        }
    }

    /**
     * @param \Closure $handler
     *
     * @return void
     */
    protected function read(Closure $handler): void
    {
        do {
            usleep(1000);

            $this->clientFilter();

            $sockets = $this->clientSockets();

            if ($this->select($sockets) === 0) {
                continue;
            }

            if (in_array($this->socket, $sockets)) {
                $sockets = $this->clientAdd($sockets);
            }

            foreach ($sockets as $socket) {
                $this->clientRead($socket, $handler);
            }
        } while (true);
    }

    /**
     * @param array &$sockets
     *
     * @return int
     */
    protected function select(array &$sockets): int
    {
        $write = $except = null;

        array_push($sockets, $this->socket);

        return intval(stream_select($sockets, $write, $except, null));
    }

    /**
     * @param array $sockets
     *
     * @return array
     */
    protected function clientAdd(array $sockets): array
    {
        $this->clientAccept();

        unset($sockets[array_search($this->socket, $sockets)]);

        return array_values($sockets);
    }

    /**
     * @return void
     */
    protected function clientAccept(): void
    {
        $this->clients[] = (object)[
            'socket' => stream_socket_accept($this->socket, 1),
            'timestamp' => time(),
            'data' => [],
        ];
    }

    /**
     * @param resource $socket
     * @param \Closure $handler
     *
     * @return void
     */
    protected function clientRead($socket, Closure $handler): void
    {
        $client = $this->clientBySocket($socket);

        if ($client === null) {
            return;
        }

        Client::new($client, $handler)->handle();
    }

    /**
     * @return void
     */
    protected function create(): void
    {
        $this->socket = stream_socket_server('tcp://0.0.0.0:'.$this->port);
    }

    /**
     * @param resource $socket
     *
     * @return ?\stdClass
     */
    protected function clientBySocket($socket): ?stdClass
    {
        foreach ($this->clients as $client) {
            if ($client->socket === $socket) {
                return $client;
            }
        }

        return null;
    }

    /**
     * @return array
     */
    protected function clientSockets(): array
    {
        return array_filter(array_column($this->clients, 'socket'));
    }

    /**
     * @return void
     */
    protected function clientFilter(): void
    {
        foreach ($this->clients as &$client) {
            if (empty($client->socket)) {
                $client = null;

                continue;
            }

            if ((time() - $client->timestamp) < static::SOCKET_TIMEOUT) {
                continue;
            }

            $this->close($client->socket);

            $client = null;
        }

        $this->clients = array_filter($this->clients);
    }

    /**
     * @param ?resource &$socket
     *
     * @return void
     */
    protected function close(&$socket): void
    {
        if ($socket) {
            try {
                fclose($socket);
            } catch (Throwable $e) {
                $this->error($e);
            }
        }

        $socket = null;
    }

    /**
     * @return void
     */
    protected function gracefulShutdown(): void
    {
        if (function_exists('pcntl_signal') === false) {
            return;
        }

        pcntl_signal(SIGINT, [$this, 'gracefulShutdownHandler']);
        pcntl_signal(SIGTERM, [$this, 'gracefulShutdownHandler']);
    }

    /**
     * @return void
     */
    public function gracefulShutdownHandler(): void
    {
        $this->stop();
        exit;
    }

    /**
     * @return void
     */
    public function stop(): void
    {
        foreach ($this->clientSockets() as $client) {
            $this->close($client);
        }

        if ($this->socket) {
            $this->close($this->socket);
        }

        $this->clients = [];
        $this->socket = null;
    }

    /**
     * @param \Throwable $e
     *
     * @return void
     */
    protected function error(Throwable $e): void
    {
        if ($this->errorIsReportable($e)) {
            report($e);
        }
    }

    /**
     * @param \Throwable $e
     *
     * @return bool
     */
    protected function errorIsReportable(Throwable $e): bool
    {
        return str_contains($e->getMessage(), ' closed ') === false;
    }
}

```

`app/Services/Server/Logger.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Server;

class Logger
{
    /**
     * @param int $port
     *
     * @return self
     */
    public static function port(int $port): self
    {
        static $cache;

        return $cache[$port] ??= new self($port);
    }

    /**
     * @param int $port
     *
     * @return void
     */
    private function __construct(protected int $port)
    {
    }

    /**
     * @param string $title
     * @param mixed $data = null
     *
     * @return void
     */
    public function info(string $title, mixed $data = null): void
    {
        $this->write(__FUNCTION__, $title, $data);
    }

    /**
     * @param string $title
     * @param mixed $data = null
     *
     * @return void
     */
    public function error(string $title, mixed $data = null): void
    {
        $this->write(__FUNCTION__, $title, $data);
    }

    /**
     * @param string $status
     * @param mixed $title
     * @param mixed $data = null
     *
     * @return void
     */
    protected function write(string $status, mixed $title, mixed $data = null): void
    {
        file_put_contents($this->file(), $this->contents($status, $title, $data), FILE_APPEND | LOCK_EX);
    }

    /**
     * @return string
     */
    protected function file(): string
    {
        $file = storage_path('logs/server/'.date('Y/m/d').'/'.$this->port.'-connection.log');

        clearstatcache(true, $file);

        if (is_file($file) === false) {
            helper()->mkdir($file, true);
        }

        return $file;
    }

    /**
     * @param string $status
     * @param mixed $title
     * @param mixed $data
     *
     * @return string
     */
    protected function contents(string $status, mixed $title, mixed $data): string
    {
        return '['.$this->timestamp().'] ['.strtoupper($status).'] '.$this->toString($title).' '.$this->toString($data)."\n";
    }

    /**
     * @return string
     */
    protected function timestamp(): string
    {
        return date_create()->format('Y-m-d H:i:s.v P');
    }

    /**
     * @param mixed $contents
     *
     * @return string
     */
    protected function toString(mixed $contents): string
    {
        if (is_numeric($contents)) {
            return strval($contents);
        }

        if (is_string($contents)) {
            return trim($contents);
        }

        return json_encode($contents, JSON_INVALID_UTF8_SUBSTITUTE | JSON_UNESCAPED_LINE_TERMINATORS | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
    }
}

```

`app/Services/Server/Pool.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Server;

use Generator;
use Socket;

class Pool
{
    /**
     * @var array
     */
    protected array $list = [];

    /**
     * @param \App\Services\Server\Connection $connection
     *
     * @return self
     */
    public function add(Connection $connection): self
    {
        $this->list[] = $connection;

        return $this;
    }

    /**
     * @return array
     */
    public function get(): array
    {
        return $this->filter();
    }

    /**
     * @return int
     */
    public function count(): int
    {
        return count($this->list);
    }

    /**
     * @return array
     */
    public function sockets(): array
    {
        return array_map(static fn ($connection) => $connection->getSocket(), $this->filter());
    }

    /**
     * @param \Socket $socket
     *
     * @return ?\App\Services\Server\Connection
     */
    public function bySocket(Socket $socket): ?Connection
    {
        foreach ($this->list as $connection) {
            if ($connection->getSocket() === $socket) {
                return $connection;
            }
        }

        return null;
    }

    /**
     * @param array $sockets
     *
     * @return \Generator
     */
    public function bySockets(array $sockets): Generator
    {
        foreach ($this->list as $connection) {
            if (in_array($connection->getSocket(), $sockets)) {
                yield $connection;
            }
        }

        yield from [];
    }

    /**
     * @return array
     */
    public function filter(): array
    {
        foreach ($this->list as $index => $connection) {
            if ($connection->isValid()) {
                continue;
            }

            $connection->close();

            unset($this->list[$index]);
        }

        return $this->list = array_values($this->list);
    }

    /**
     * @return void
     */
    public function stop(): void
    {
        foreach ($this->list as $connection) {
            $connection->close();
        }

        $this->list = [];
    }
}

```

`app/Services/Server/Process.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Server;

use stdClass;
use Throwable;
use Illuminate\Support\Collection;
use App\Exceptions\UnexpectedValueException;
use App\Services\Command\Exec;

class Process
{
    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @return \Illuminate\Support\Collection
     */
    public function list(): Collection
    {
        $list = collect();

        foreach ($this->listProcesses() as $process) {
            $list->push($this->listProcess($process));
        }

        return $list;
    }

    /**
     * @return array
     */
    protected function listProcesses(): array
    {
        return Exec::cmdLinesArray($this->listExecCmd());
    }

    /**
     * @return string
     */
    protected function listExecCmd(): string
    {
        return 'export COLUMNS=256;'
            .' LC_ALL=C'
            .' ps -eo pid,user,lstart,rss,pcpu,cmd'
            .' | grep -- "'.base_path().'"'
            .' | grep -- "artisan server:start:port.*--port="'
            .' | sort'
            .' | grep -v "grep"';
    }

    /**
     * @param array $process
     *
     * @return \stdClass
     */
    protected function listProcess(array $process): stdClass
    {
        $command = implode(' ', array_slice($process, 9));

        preg_match('/\-\-port=([0-9]+)/', $command, $port);

        return (object)[
            'pid' => intval($process[0]),
            'owner' => $process[1],
            'start' => date('Y-m-d H:i:s', strtotime($process[3].' '.$process[4].' '.$process[6].' '.$process[5])),
            'memory' => round(floatval($process[7]) / 1024, 2),
            'cpu' => round(floatval($process[8]), 2),
            'command' => $command,
            'port' => intval($port[1]),
        ];
    }

    /**
     * @param int $port
     *
     * @return bool
     */
    public function kill(int $port): bool
    {
        foreach (['SIGINT', 'SIGTERM', 'SIGKILL'] as $signal) {
            if ($this->killSignal($port, $signal)) {
                return true;
            }
        }

        return false;
    }

    /**
     * @param int $port
     * @param string $signal
     *
     * @return bool
     */
    public function killSignal(int $port, string $signal): bool
    {
        if ($this->isBusy($port) === false) {
            return true;
        }

        $fuser = Exec::available('fuser');

        if (empty($fuser)) {
            throw new UnexpectedValueException(__('common.error.fuser-not-found'));
        }

        exec(sprintf($fuser.' -k -%s %s/tcp > /dev/null 2>&1', $signal, $port));

        sleep(1);

        return $this->isBusy($port) === false;
    }

    /**
     * @param int $port
     *
     * @return bool
     */
    public function isBusy(int $port): bool
    {
        $errno = $errstr = null;

        try {
            $fp = fsockopen('127.0.0.1', $port, $errno, $errstr, 1);
        } catch (Throwable $e) {
            return $errno !== 111;
        }

        fclose($fp);

        return true;
    }

    /**
     * @param int $port
     *
     * @return bool
     */
    public function isLocked(int $port): bool
    {
        $errno = $errstr = null;

        try {
            $fp = fsockopen('127.0.0.1', $port, $errno, $errstr, 5);
        } catch (Throwable $e) {
            return $errno === 110;
        }

        fclose($fp);

        return false;
    }
}

```

`app/Services/Server/ServerAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Server;

use Closure;

abstract class ServerAbstract
{
    /**
     * @var \App\Services\Server\Pool
     */
    protected Pool $pool;

    /**
     * @var \App\Services\Server\Process
     */
    protected Process $process;

    /**
     * @var bool
     */
    protected bool $debug = false;

    /**
     * @param \Closure $handler
     *
     * @return void
     */
    abstract public function accept(Closure $handler): void;

    /**
     * @return void
     */
    abstract public function stop(): void;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param int $port
     *
     * @return self
     */
    public function __construct(protected int $port)
    {
        $this->pool = new Pool();
        $this->process = new Process();
    }

    /**
     * @param bool $debug
     *
     * @return self
     */
    public function debug(bool $debug): self
    {
        $this->debug = $debug;

        return $this;
    }

    /**
     * @return void
     */
    public function kill(): void
    {
        $this->process->kill($this->port);
    }

    /**
     * @return bool
     */
    public function isBusy(): bool
    {
        return $this->process->isBusy($this->port);
    }

    /**
     * @return bool
     */
    public function isLocked(): bool
    {
        return $this->process->isLocked($this->port);
    }
}

```

`app/Services/Server/Socket/Client.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Server\Socket;

use Closure;
use Throwable;
use App\Domains\DeviceMessage\Model\DeviceMessage as DeviceMessageModel;
use App\Services\Protocol\Resource\ResourceAbstract;
use App\Services\Server\Connection;
use App\Services\Server\Logger;

class Client
{
    /**
     * @var bool
     */
    protected bool $debug = false;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param \App\Services\Server\Connection $connection
     * @param \Closure $handler
     *
     * @return self
     */
    public function __construct(protected Connection $connection, protected Closure $handler)
    {
    }

    /**
     * @param bool $debug
     *
     * @return self
     */
    public function debug(bool $debug): self
    {
        $this->debug = $debug && $this->connection->isDebuggable();

        return $this;
    }

    /**
     * @return bool
     */
    public function handle(): bool
    {
        $buffer = $this->readBuffer();

        $this->log('READ', $buffer);

        if (empty($buffer)) {
            return false;
        }

        $resources = $this->readHandle($buffer);

        if (empty($resources)) {
            return true;
        }

        foreach ($resources as $resource) {
            $this->readResourceData($resource);
        }

        $this->readResourceResponse($resource);
        $this->readResourceMessagesRead($resource);
        $this->readResourceMessagesWrite($resource);

        return true;
    }

    /**
     * @return string|bool|null
     */
    protected function readBuffer(): string|bool|null
    {
        try {
            $buffer = socket_read($this->connection->getSocket(), 2048);
        } catch (Throwable) {
            return false;
        }

        if (empty($buffer)) {
            return null;
        }

        return bin2hex($buffer);
    }

    /**
     * @param string $buffer
     *
     * @return array
     */
    protected function readHandle(string $buffer): array
    {
        $this->connection->refresh();

        try {
            return ($this->handler)($buffer, $this->connection->getData());
        } catch (Throwable $e) {
            $this->error($e);
        }

        return [];
    }

    /**
     * @param \App\Services\Protocol\Resource\ResourceAbstract $resource
     *
     * @return void
     */
    protected function readResourceData(ResourceAbstract $resource): void
    {
        if ($data = $resource->data()) {
            $this->connection->setData($data);
        }
    }

    /**
     * @param \App\Services\Protocol\Resource\ResourceAbstract $resource
     *
     * @return void
     */
    protected function readResourceResponse(ResourceAbstract $resource): void
    {
        if (empty($response = $resource->response())) {
            return;
        }

        $this->log('WRITE', $response);

        socket_write($this->connection->getSocket(), $response, strlen($response));
    }

    /**
     * @param \App\Services\Protocol\Resource\ResourceAbstract $resource
     *
     * @return void
     */
    protected function readResourceMessagesRead(ResourceAbstract $resource): void
    {
        if (in_array($resource->format(), ['sms', 'command']) === false) {
            return;
        }

        DeviceMessageModel::query()
            ->byDeviceSerial($resource->serial())
            ->whereSentAt(true)
            ->whereResponseAt(false)
            ->withDevice()
            ->orderByLast()
            ->limit(1)
            ->get()
            ->each(fn ($message) => $this->readResourceMessageRead($resource, $message));
    }

    /**
     * @param \App\Services\Protocol\Resource\ResourceAbstract $resource
     * @param \App\Domains\DeviceMessage\Model\DeviceMessage $message
     *
     * @return void
     */
    protected function readResourceMessageRead(ResourceAbstract $resource, DeviceMessageModel $message): void
    {
        $message->response = $resource->message();
        $message->response_at = date('Y-m-d H:i:s');

        $message->save();
    }

    /**
     * @param \App\Services\Protocol\Resource\ResourceAbstract $resource
     *
     * @return void
     */
    protected function readResourceMessagesWrite(ResourceAbstract $resource): void
    {
        DeviceMessageModel::query()
            ->byDeviceSerial($resource->serial())
            ->whereSentAt(false)
            ->withDevice()
            ->get()
            ->each($this->readResourceMessageWrite(...));
    }

    /**
     * @param \App\Domains\DeviceMessage\Model\DeviceMessage $message
     *
     * @return void
     */
    protected function readResourceMessageWrite(DeviceMessageModel $message): void
    {
        $message->sent_at = date('Y-m-d H:i:s');
        $message->save();

        $contents = $message->message();

        $this->log('WRITE', $contents);

        socket_write($this->connection->getSocket(), $contents, strlen($contents));
    }

    /**
     * @param \Throwable $e
     *
     * @return void
     */
    protected function error(Throwable $e): void
    {
        logger()->error($e);

        if ($this->errorIsReportable($e)) {
            report($e);
        }
    }

    /**
     * @param \Throwable $e
     *
     * @return bool
     */
    protected function errorIsReportable(Throwable $e): bool
    {
        return (str_contains($e->getMessage(), ' closed ') === false)
            && (str_contains($e->getMessage(), ' unable to write to socket') === false)
            && (str_contains($e->getMessage(), ' reset by peer') === false);
    }

    /**
     * @param string $message
     * @param mixed $data = ''
     *
     * @return void
     */
    protected function log(string $message, mixed $data = ''): void
    {
        if ($this->debug === false) {
            return;
        }

        Logger::port($this->connection->getServerPort())->info('['.$this->connection->getId().'] ['.$message.']', $data);
    }
}

```

`app/Services/Server/Socket/Server.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Server\Socket;

use Closure;
use Exception;
use Socket;
use Throwable;
use App\Services\Server\Connection;
use App\Services\Server\Logger;
use App\Services\Server\ServerAbstract;

class Server extends ServerAbstract
{
    /**
     * @const int
     */
    protected const SOCKET_TIMEOUT = 600;

    /**
     * @var ?\Socket
     */
    protected ?Socket $socket;

    /**
     * @var int
     */
    protected int $socketType = 1;

    /**
     * @var int
     */
    protected int $socketProtocol = 0;

    /**
     * @param string $type
     *
     * @return self
     */
    public function socketType(string $type): self
    {
        $this->socketType = match ($type) {
            'stream' => SOCK_STREAM,
            default => throw new Exception(sprintf('Invalid Socket Type %s', $type)),
        };

        return $this;
    }

    /**
     * @param string $protocol
     *
     * @return self
     */
    public function socketProtocol(string $protocol): self
    {
        $this->socketProtocol = match ($protocol) {
            'ip' => 0,
            'tcp' => 6,
            'udp' => 17,
            default => throw new Exception(sprintf('Invalid Socket Protocol %s', $protocol)),
        };

        return $this;
    }

    /**
     * @param \Closure $handler
     *
     * @return void
     */
    public function accept(Closure $handler): void
    {
        $this->create();
        $this->option();
        $this->bind();
        $this->listen();
        $this->nonblock();

        set_time_limit(0);

        $this->gracefulShutdown();

        try {
            $this->read($handler);
        } catch (Throwable $e) {
            $this->error($e);
            $this->stop();
        }
    }

    /**
     * @return void
     */
    protected function create(): void
    {
        $this->socket = socket_create(AF_INET, $this->socketType, $this->socketProtocol);
    }

    /**
     * @return void
     */
    protected function option(): void
    {
        socket_set_option($this->socket, SOL_SOCKET, SO_REUSEADDR, 1);
    }

    /**
     * @return void
     */
    protected function bind(): void
    {
        socket_bind($this->socket, '0.0.0.0', $this->port);
    }

    /**
     * @return void
     */
    protected function listen(): void
    {
        socket_listen($this->socket, SOMAXCONN);
    }

    /**
     * @return void
     */
    protected function nonblock(): void
    {
        socket_set_nonblock($this->socket);
    }

    /**
     * @param \Closure $handler
     *
     * @return void
     */
    protected function read(Closure $handler): void
    {
        do {
            usleep(1000);

            $sockets = $this->pool->sockets();

            if ($this->select($sockets) === 0) {
                continue;
            }

            if (in_array($this->socket, $sockets)) {
                $this->connectionAdd($sockets);
            }

            if (empty($sockets)) {
                continue;
            }

            foreach ($sockets as $socket) {
                if ($connection = $this->pool->bySocket($socket)) {
                    $this->connectionRead($connection, $handler);
                }
            }
        } while (true);
    }

    /**
     * @param array &$sockets
     *
     * @return int
     */
    protected function select(array &$sockets): int
    {
        $write = $except = null;

        array_push($sockets, $this->socket);

        return intval(socket_select($sockets, $write, $except, 0, 10000));
    }

    /**
     * @param array &$sockets
     *
     * @return void
     */
    protected function connectionAdd(array &$sockets): void
    {
        $this->connectionAccept();

        unset($sockets[array_search($this->socket, $sockets)]);
    }

    /**
     * @return void
     */
    protected function connectionAccept(): void
    {
        if (empty($socket = socket_accept($this->socket))) {
            return;
        }

        $timeout = ['sec' => 2, 'usec' => 0];

        socket_set_option($socket, SOL_SOCKET, SO_RCVTIMEO, $timeout);
        socket_set_option($socket, SOL_SOCKET, SO_SNDTIMEO, $timeout);

        socket_set_option($socket, SOL_TCP, TCP_NODELAY, 1);
        socket_set_option($socket, SOL_SOCKET, SO_KEEPALIVE, 1);

        $this->pool->add($connection = new Connection($this->port, $socket));

        if ($connection->isDebuggable() === false) {
            return;
        }

        $this->log('[CONNECTIONS]', $this->pool->count());
        $this->log('['.$connection->getId().'] [CONNECTED]', $connection->__toArray());
    }

    /**
     * @param \App\Services\Server\Connection $connection
     * @param \Closure $handler
     *
     * @return void
     */
    protected function connectionRead(Connection $connection, Closure $handler): void
    {
        try {
            $this->connectionReadHandle($connection, $handler);
        } catch (Throwable $e) {
            $this->connectionReadError($connection, $e);
        }
    }

    /**
     * @param \App\Services\Server\Connection $connection
     * @param \Closure $handler
     *
     * @return void
     */
    protected function connectionReadHandle(Connection $connection, Closure $handler): void
    {
        if (Client::new($connection, $handler)->debug($this->debug)->handle() === false) {
            $connection->close();
        }
    }

    /**
     * @param \App\Services\Server\Connection $connection
     * @param \Throwable $e
     *
     * @return void
     */
    protected function connectionReadError(Connection $connection, Throwable $e): void
    {
        $connection->close();

        $this->error($e);
    }

    /**
     * @param ?\Socket &$socket
     *
     * @return void
     */
    protected function close(?Socket &$socket): void
    {
        if ($socket) {
            try {
                socket_close($socket);
            } catch (Throwable $e) {
                $this->error($e);
            }
        }

        $socket = null;
    }

    /**
     * @return void
     */
    protected function gracefulShutdown(): void
    {
        if (function_exists('pcntl_signal') === false) {
            return;
        }

        pcntl_signal(SIGINT, [$this, 'gracefulShutdownHandler']);
        pcntl_signal(SIGTERM, [$this, 'gracefulShutdownHandler']);
    }

    /**
     * @return void
     */
    public function gracefulShutdownHandler(): void
    {
        $this->stop();
        exit;
    }

    /**
     * @return void
     */
    public function stop(): void
    {
        $this->pool->stop();

        if ($this->socket) {
            $this->close($this->socket);
        }

        $this->socket = null;
    }

    /**
     * @param \Throwable $e
     *
     * @return void
     */
    protected function error(Throwable $e): void
    {
        logger()->error($e);

        if ($this->errorIsReportable($e)) {
            report($e);
        }
    }

    /**
     * @param \Throwable $e
     *
     * @return bool
     */
    protected function errorIsReportable(Throwable $e): bool
    {
        return (str_contains($e->getMessage(), ' closed ') === false)
            && (str_contains($e->getMessage(), ' unable to write to socket') === false)
            && (str_contains($e->getMessage(), ' reset by peer') === false);
    }

    /**
     * @param string $message
     * @param mixed $data = ''
     *
     * @return void
     */
    protected function log(string $message, mixed $data = ''): void
    {
        if ($this->debug) {
            Logger::port($this->port)->info($message, $data);
        }
    }
}

```

`app/Services/Telegram/Client.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Telegram;

use stdClass;
use App\Services\Curl\Curl;

class Client
{
    /**
     * @var array
     */
    protected array $config;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @return self
     */
    public function __construct()
    {
        $this->config = (array)config('telegram');
    }

    /**
     * @param string $key
     *
     * @return mixed
     */
    public function config(string $key): mixed
    {
        return $this->config[$key] ?? null;
    }

    /**
     * @return string
     */
    public function botLink(): string
    {
        return 'http://t.me/'.$this->config('bot');
    }

    /**
     * @return bool
     */
    public function enabled(): bool
    {
        return ($this->config('enabled') === true)
            && $this->config('bot')
            && $this->config('token');
    }

    /**
     * @param string $username
     *
     * @return ?int
     */
    public function chatId(string $username): ?int
    {
        if ($this->enabled() === false) {
            return null;
        }

        foreach ($this->getUpdates() as $update) {
            if (($update->message->chat->type === 'private') && ($update->message->chat->username === $username)) {
                return $update->message->chat->id;
            }
        }

        return null;
    }

    /**
     * @return array
     */
    protected function getUpdates(): array
    {
        return $this->request('GET', '/getUpdates')->result ?? [];
    }

    /**
     * @param int $chat_id
     * @param string $text
     *
     * @return ?\stdClass
     */
    public function message(int $chat_id, string $text): ?stdClass
    {
        if ($this->enabled() === false) {
            return null;
        }

        return $this->request('POST', '/sendMessage', [
            'chat_id' => $chat_id,
            'text' => $text,
            'parse_mode' => 'html',
        ]);
    }

    /**
     * @param string $method
     * @param string $path
     * @param array $body = []
     *
     * @return array|\stdClass|null
     */
    protected function request(string $method, string $path, array $body = []): array|stdClass|null
    {
        return Curl::new()
            ->setMethod($method)
            ->setUrl($this->requestUrl($path))
            ->setBody($body)
            ->setLog(true)
            ->setJson(true)
            ->send()
            ->getBody();
    }

    /**
     * @param string $path
     *
     * @return string
     */
    protected function requestUrl(string $path): string
    {
        return 'https://api.telegram.org/bot'.$this->config('token').$path;
    }
}

```

`app/Services/Translator/Provider/DeepL/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Translator\Provider\DeepL;

use stdClass;
use Throwable;
use App\Exceptions\UnexpectedValueException;
use App\Services\Translator\Provider\ProviderAbstract;

class Manager extends ProviderAbstract
{
    /**
     * @const string
     */
    protected const ENDPOINT = 'https://api-free.deepl.com/v2/translate';

    /**
     * @param array $config
     *
     * @return void
     */
    protected function config(array $config): void
    {
        if (empty($config['key'])) {
            throw new UnexpectedValueException('You must set a DeepL Key');
        }

        $this->config = $config;
    }

    /**
     * @param string $from
     * @param string $to
     * @param array $strings
     *
     * @return array
     */
    public function array(string $from, string $to, array $strings): array
    {
        return $this->request($from, $to, $strings);
    }

    /**
     * @param string $from
     * @param string $to
     * @param array $strings
     *
     * @return array
     */
    protected function request(string $from, string $to, array $strings): array
    {
        try {
            return $this->requestResponse($this->requestCurl($from, $to, $strings));
        } catch (Throwable $e) {
            return $this->requestError($e);
        }
    }

    /**
     * @param \Throwable $e
     *
     * @return array
     */
    protected function requestError(Throwable $e): array
    {
        report($e);

        return [];
    }

    /**
     * @param string $from
     * @param string $to
     * @param array $strings
     *
     * @return \stdClass
     */
    protected function requestCurl(string $from, string $to, array $strings): stdClass
    {
        return $this->curl($this->requestEndpoint())
            ->setMethod('post')
            ->setHeaders($this->requestHeaders())
            ->setBody($this->requestBody($from, $to, $strings))
            ->send()
            ->getBody('object');
    }

    /**
     * @return string
     */
    protected function requestEndpoint(): string
    {
        return static::ENDPOINT;
    }

    /**
     * @return array
     */
    protected function requestHeaders(): array
    {
        return [
            'Authorization' => 'DeepL-Auth-Key '.$this->config['key'],
        ];
    }

    /**
     * @param string $from
     * @param string $to
     * @param array $strings
     *
     * @return array
     */
    protected function requestBody(string $from, string $to, array $strings): array
    {
        return [
            'source_lang' => strtoupper($from),
            'target_lang' => strtoupper($to),
            'text' => $this->requestBodyText($strings),
            'split_sentences' => 1,
            'preserve_formatting' => 1,
            'formality' => 'prefer_less',
            'tag_handling' => 'xml',
            'ignore_tags' => 'key',
        ];
    }

    /**
     * @param array $strings
     *
     * @return string
     */
    protected function requestBodyText(array $strings): string
    {
        return $this->requestBodyTextTags(implode("\n", $this->requestBodyTextKeys($strings)));
    }

    /**
     * @param array $strings
     *
     * @return array
     */
    protected function requestBodyTextKeys(array $strings): array
    {
        return array_map(
            static fn ($value, $key) => '<key>'.$key.'</key> '.$value,
            $strings,
            array_keys($strings)
        );
    }

    /**
     * @param string $text
     *
     * @return string
     */
    protected function requestBodyTextTags(string $text): string
    {
        return preg_replace_callback('/:[a-z_]+/', static function (array $tag) {
            return 'BS64T'.str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($tag[0]));
        }, $text);
    }

    /**
     * @param \stdClass $response
     *
     * @return array
     */
    protected function requestResponse(stdClass $response): array
    {
        $text = $response->translations[0]->text;

        $text = $this->requestResponseTags($text);
        $keys = $this->requestResponseKeys($text);
        $strings = $this->requestResponseString($text);

        $translations = [];

        foreach ($keys as $index => $key) {
            if (empty($strings[$index])) {
                exit(var_export([$text, $keys, $strings], true));
            }

            $translations[$key] = $strings[$index];
        }

        return $translations;
    }

    /**
     * @param string $text
     *
     * @return string
     */
    protected function requestResponseTags(string $text): string
    {
        return preg_replace_callback('/BS64T([a-zA-Z0-9_-]+)/', static function (array $tag) {
            return base64_decode(str_replace(['-', '_'], ['+', '/'], $tag[1]));
        }, $text);
    }

    /**
     * @param string $text
     *
     * @return array
     */
    protected function requestResponseKeys(string $text): array
    {
        preg_match_all('/<key>([^<]+)<\/key>/', $text, $matches);

        return $matches[1];
    }

    /**
     * @param string $text
     *
     * @return array
     */
    protected function requestResponseString(string $text): array
    {
        return array_map('trim', explode("\n", preg_replace('/<key>([^<]*)<\/key>/', '', $text)));
    }
}

```

`app/Services/Translator/Provider/Microsoft/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Translator\Provider\Microsoft;

use App\Exceptions\UnexpectedValueException;
use App\Services\Translator\Provider\ProviderAbstract;

class Manager extends ProviderAbstract
{
    /**
     * @const string
     */
    protected const ENDPOINT = 'https://api.cognitive.microsofttranslator.com/translate?api-version=3.0&from=:from&to=:to';

    /**
     * @param array $config
     *
     * @return void
     */
    protected function config(array $config): void
    {
        if (empty($config['key']) || empty($config['region'])) {
            throw new UnexpectedValueException('You must set a Microsoft Azure Key and Region');
        }

        $this->config = $config;
    }

    /**
     * @param string $from
     * @param string $to
     * @param array $strings
     *
     * @return array
     */
    public function array(string $from, string $to, array $strings): array
    {
        return $this->response($this->request($from, $to, $strings));
    }

    /**
     * @param string $from
     * @param string $to
     * @param array $strings
     *
     * @return array
     */
    protected function request(string $from, string $to, array $strings): array
    {
        return $this->curl($this->requestEndpoint($from, $to))
            ->setHeaders($this->requestHeaders())
            ->setBody($this->requestBody($strings))
            ->send()
            ->getBody('object');
    }

    /**
     * @param string $from
     * @param string $to
     *
     * @return string
     */
    protected function requestEndpoint(string $from, string $to): string
    {
        return str_replace([':from', ':to'], [$from, $to], static::ENDPOINT);
    }

    /**
     * @return array
     */
    protected function requestHeaders(): array
    {
        return [
            'Content-type' => 'application/json',
            'Ocp-Apim-Subscription-Key' => $this->config['key'],
            'Ocp-Apim-Subscription-Region' => $this->config['region'],
        ];
    }

    /**
     * @param array $strings
     *
     * @return string
     */
    protected function requestBody(array $strings): string
    {
        return json_encode(array_map(static fn ($value) => ['Text' => $value], array_values($strings)));
    }

    /**
     * @param array $response
     *
     * @return array
     */
    protected function response(array $response): array
    {
        return array_map(static fn ($value) => $value->translations[0]->text, $response);
    }
}

```

`app/Services/Translator/Provider/OpenAI/Manager.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Translator\Provider\OpenAI;

use App\Exceptions\UnexpectedValueException;
use App\Services\Curl\Curl;
use App\Services\Translator\Provider\ProviderAbstract;

class Manager extends ProviderAbstract
{
    /**
     * @const string
     */
    protected const ENDPOINT = 'https://api.openai.com/v1/chat/completions';

    /**
     * @param array $config
     *
     * @return void
     */
    protected function config(array $config): void
    {
        if (empty($config['key'])) {
            throw new UnexpectedValueException('You must set an OpenAI Key');
        }

        $this->config = $config;
    }

    /**
     * @param string $from
     * @param string $to
     * @param array $strings
     *
     * @return array
     */
    public function array(string $from, string $to, array $strings): array
    {
        return $this->response($this->request($from, $to, $strings));
    }

    /**
     * @param string $from
     * @param string $to
     * @param array $strings
     *
     * @return array
     */
    protected function request(string $from, string $to, array $strings): array
    {
        return Curl::new()
            ->setMethod('POST')
            ->setUrl(static::ENDPOINT)
            ->setJson()
            ->setAuthorization($this->config['key'])
            ->setBody($this->requestBody($from, $to, $strings))
            ->send()
            ->getBody('array');
    }

    /**
     * @param string $from
     * @param string $to
     * @param array $strings
     *
     * @return array
     */
    protected function requestBody(string $from, string $to, array $strings): array
    {
        return [
            'model' => $this->config['model'],
            'messages' => $this->requestBodyMessages($from, $to, $strings),
            'temperature' => $this->config['temperature'],
        ];
    }

    /**
     * @param string $from
     * @param string $to
     * @param array $strings
     *
     * @return array
     */
    protected function requestBodyMessages(string $from, string $to, array $strings): array
    {
        return [$this->requestBodyMessagesSystem($from, $to), ...$this->requestBodyMessagesUser($strings)];
    }

    /**
     * @param string $from
     * @param string $to
     *
     * @return array
     */
    protected function requestBodyMessagesSystem(string $from, string $to): array
    {
        return [
            'role' => 'system',
            'content' => $this->requestBodyMessagesSystemContent($from, $to),
        ];
    }

    /**
     * @param string $from
     * @param string $to
     *
     * @return string
     */
    protected function requestBodyMessagesSystemContent(string $from, string $to): string
    {
        return trim(
            $this->requestBodyMessagesSystemContentDefault($from, $to)
            ."\n".$this->requestBodyMessagesSystemContentPrompt()
        );
    }

    /**
     * @param string $from
     * @param string $to
     *
     * @return string
     */
    protected function requestBodyMessagesSystemContentDefault(string $from, string $to): string
    {
        return trim(<<<END
                You are a professional JSON translation engine.
                You must translate the JSON values from "$from" language into "$to" language without explanation.
                You must not translate any word starting with ":" because is a binding key.
                You can only include a valid JSON in the response, you cannot include anything else. You also must not include json formatting tags, such as "```json".
            END);
    }

    /**
     * @return string
     */
    protected function requestBodyMessagesSystemContentPrompt(): string
    {
        if (empty($this->config['prompt'])) {
            return '';
        }

        $file = base_path($this->config['prompt']);

        if (is_file($file) === false) {
            return '';
        }

        return file_get_contents($file);
    }

    /**
     * @param array $strings
     *
     * @return array
     */
    protected function requestBodyMessagesUser(array $strings): array
    {
        return [
            [
                'role' => 'user',
                'content' => json_encode($strings),
            ],
        ];
    }

    /**
     * @param array $response
     *
     * @return array
     */
    protected function response(array $response): array
    {
        $output = json_decode($response['choices'][0]['message']['content'], true);

        if ($output === null) {
            throw new UnexpectedValueException(sprintf('Invalid Translation Response: %s', $response['choices'][0]['message']['content']));
        }

        return $output;
    }
}

```

`app/Services/Translator/Provider/ProviderAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Translator\Provider;

use App\Services\Curl\Curl;

abstract class ProviderAbstract
{
    /**
     * @var array
     */
    protected array $config;

    /**
     * @param array $config
     *
     * @return void
     */
    public function __construct(array $config)
    {
        $this->config($config);
    }

    /**
     * @param array $config
     *
     * @return void
     */
    protected function config(array $config): void
    {
        $this->config = $config;
    }

    /**
     * @param string $url
     *
     * @return \App\Services\Curl\Curl
     */
    protected function curl(string $url): Curl
    {
        return Curl::new()
            ->setMethod('POST')
            ->setUrl($url)
            ->setCache(3600)
            ->setCachePost(true);
    }
}

```

`app/Services/Translator/TranslatorFactory.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Translator;

use App\Exceptions\UnexpectedValueException;
use App\Services\Translator\Provider\ProviderAbstract;

class TranslatorFactory
{
    /**
     * @return \App\Services\Translator\Provider\ProviderAbstract
     */
    public static function get(): ProviderAbstract
    {
        $provider = static::provider();
        $class = static::class($provider);

        return new $class(static::config()['providers'][$provider]);
    }

    /**
     * @return string
     */
    protected static function provider(): string
    {
        if ($provider = static::config()['provider']) {
            return $provider;
        }

        throw new UnexpectedValueException('Translator Provider Not Defined');
    }

    /**
     * @param string $provider
     *
     * @return string
     */
    protected static function class(string $provider): string
    {
        $class = __NAMESPACE__.'\\Provider\\'.$provider.'\\Manager';

        if (class_exists($class)) {
            return $class;
        }

        throw new UnexpectedValueException(sprintf('No Class Available to Provider %s', $provider));
    }

    /**
     * @return array
     */
    protected static function config(): array
    {
        static $cache;

        return $cache ?? config('translator');
    }
}

```

`app/Services/Validator/Data.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Validator;

use Stringable;

class Data
{
    /**
     * @var array
     */
    protected array $data = [];

    /**
     * @var array
     */
    protected array $rules = [];

    /**
     * @var bool
     */
    protected bool $all = true;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param array $data
     * @param array $rules
     * @param bool $all = true
     *
     * @return self
     */
    public function __construct(array $data, array $rules, bool $all = true)
    {
        $this->data = $this->data($data);
        $this->rules = $this->rules($rules);
        $this->all = $all;
    }

    /**
     * @return array
     */
    public function get(): array
    {
        return $this->castRules($this->data, $this->rules);
    }

    /**
     * @param array $data
     *
     * @return array
     */
    public function data(array $data): array
    {
        return array_filter($data, static fn ($key) => str_starts_with((string)$key, '_') === false, ARRAY_FILTER_USE_KEY);
    }

    /**
     * @param array $rules
     *
     * @return array
     */
    protected function rules(array $rules): array
    {
        foreach ($rules as $key => $rule) {
            if (is_array($rule)) {
                $rules[$key] = implode('|', array_filter($rule, 'is_string'));
            }
        }

        $rulesNew = [];

        foreach ($rules as $key => $value) {
            array_set($rulesNew, $key, $value);
        }

        return $rulesNew;
    }

    /**
     * @param array $data
     * @param array $rules
     *
     * @return array
     */
    protected function castRules(array $data, array $rules): array
    {
        foreach ($rules as $key => $rule) {
            if ($key === '*') {
                $data = $this->castRulesArray($data, $rule);
            } else {
                $data = $this->castRule($data, $key, $rule);
            }
        }

        return $data;
    }

    /**
     * @param array $data
     * @param string|int $key
     * @param string|array $rule
     *
     * @return array
     */
    protected function castRule(array $data, string|int $key, string|array $rule): array
    {
        $value = $data[$key] ?? null;

        if (is_array($rule)) {
            $value = $this->castRules(is_array($value) ? $value : [], $rule);
        } else {
            $value = $this->cast($value, $rule);
        }

        $data[$key] = $value;

        return $data;
    }

    /**
     * @param array $data
     * @param array|string $rules
     *
     * @return array
     */
    protected function castRulesArray(array $data, array|string $rules): array
    {
        if (empty($data)) {
            return [];
        }

        if (is_string($rules)) {
            return $this->castRulesArrayString($data, $rules);
        }

        foreach ($data as &$values) {
            foreach ($rules as $name => $rule) {
                $values = $this->castRule($values, $name, $rule);
            }
        }

        return $data;
    }

    /**
     * @param array $data
     * @param string $rules
     *
     * @return array
     */
    protected function castRulesArrayString(array $data, string $rules): array
    {
        $rules = explode('|', $rules);

        foreach ($data as &$values) {
            foreach ($rules as $rule) {
                $values = $this->cast($values, $rule);
            }
        }

        return $data;
    }

    /**
     * @param mixed $value
     * @param string $rule
     *
     * @return mixed
     */
    protected function cast(mixed $value, string $rule): mixed
    {
        $rule = explode('|', $rule);

        if ($this->castIsNullable($value, $rule)) {
            return null;
        }

        if (in_array('boolean', $rule, true)) {
            return filter_var($value, FILTER_VALIDATE_BOOLEAN);
        }

        if (in_array('integer', $rule, true)) {
            return (int)$value;
        }

        if (in_array('numeric', $rule, true)) {
            return (float)$value;
        }

        if (in_array('string', $rule, true)) {
            return (string)$value;
        }

        if (in_array('array', $rule, true)) {
            return (array)$value;
        }

        return $value;
    }

    /**
     * @param mixed $value
     * @param array $rule
     *
     * @return bool
     */
    protected function castIsNullable(mixed $value, array $rule): bool
    {
        if ($value) {
            return false;
        }

        if (in_array('nullable', $rule, true) === false) {
            return false;
        }

        if (is_null($value)) {
            return true;
        }

        if ((is_string($value) === false) && (($value instanceof Stringable) === false)) {
            return false;
        }

        return strlen(strval($value)) === 0;
    }
}

```

`app/Services/Validator/ValidatorAbstract.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\Validator;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator as ValidatorFacade;
use Illuminate\Support\MessageBag;
use Illuminate\Validation\Validator as ValidatorService;
use App\Exceptions\ValidatorException;

abstract class ValidatorAbstract
{
    /**
     * @return array
     */
    abstract public function rules(): array;

    /**
     * @return self
     */
    public static function new(): self
    {
        return new static(...func_get_args());
    }

    /**
     * @param ?\Illuminate\Http\Request $request
     * @param array $data
     *
     * @return self
     */
    public function __construct(protected ?Request $request, protected array $data)
    {
    }

    /**
     * @return array
     */
    public function data(): array
    {
        return $this->data;
    }

    /**
     * @return array
     */
    public function messages(): array
    {
        return [];
    }

    /**
     * @return array
     */
    public function handle(): array
    {
        $validator = ValidatorFacade::make($this->data(), $this->rules(), $this->messages());

        $this->check($validator);

        return Data::new($validator->validated(), $this->rules())->get();
    }

    /**
     * @param \Illuminate\Validation\Validator $validator
     *
     * @throws \App\Exceptions\ValidatorException
     *
     * @return void
     */
    protected function check(ValidatorService $validator): void
    {
        if ($validator->fails() === false) {
            return;
        }

        $this->notify($validator->errors());
        $this->throwException($validator);
    }

    /**
     * @phpcsSuppress SlevomatCodingStandard.Functions.UnusedParameter
     *
     * @param \Illuminate\Support\MessageBag $errors
     *
     * @return void
     */
    protected function notify(MessageBag $errors): void
    {
    }

    /**
     * @param \Illuminate\Validation\Validator $validator
     *
     * @throws \App\Exceptions\ValidatorException
     *
     * @return void
     */
    protected function throwException(ValidatorService $validator): void
    {
        throw new ValidatorException(
            message: $this->exceptionMessage($validator),
            code: $this->exceptionCode(),
            status: $this->exceptionStatus(),
            details: $this->exceptionDetails($validator)
        );
    }

    /**
     * @param \Illuminate\Validation\Validator $validator
     *
     * @return string
     */
    protected function exceptionMessage(ValidatorService $validator): string
    {
        return implode("\n", array_merge([], ...array_values($validator->errors()->messages())));
    }

    /**
     * @return int
     */
    protected function exceptionCode(): int
    {
        return 422;
    }

    /**
     * @return string
     */
    protected function exceptionStatus(): string
    {
        return 'validator';
    }

    /**
     * @param \Illuminate\Validation\Validator $validator
     *
     * @return array
     */
    protected function exceptionDetails(ValidatorService $validator): array
    {
        $failed = $validator->failed();

        $response = [];

        foreach ($validator->errors()->messages() as $key => $messages) {
            $response[] = $this->exceptionDetailsMessages($key, $failed[$key] ?? [], $messages);
        }

        return $response;
    }

    /**
     * @param string $key
     * @param array $messages
     * @param array $codes
     *
     * @return array
     */
    protected function exceptionDetailsMessages(string $key, array $codes, array $messages): array
    {
        return [
            'key' => $key,
            'messages' => array_combine(array_map('str_slug', array_keys($codes)), $messages),
        ];
    }
}

```

`app/Services/View/Bag.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\View;

use Illuminate\Support\ViewErrorBag;

class Bag extends ViewErrorBag
{
}

```

`app/Services/View/Message.php:`

```php
<?php declare(strict_types=1);

namespace App\Services\View;

use Throwable;
use Illuminate\Contracts\Session\Session;
use Illuminate\Http\Request;
use Illuminate\Support\MessageBag;

class Message
{
    /**
     * @const string
     */
    protected const BAG = 'default';

    /**
     * @const string
     */
    protected const KEY = 'default';

    /**
     * @var self
     */
    protected static self $self;

    /**
     * @var array
     */
    protected array $current = [];

    /**
     * @var \Illuminate\Http\Request
     */
    protected Request $request;

    /**
     * @var \Illuminate\Contracts\Session\Session
     */
    protected Session $session;

    /**
     * @return self
     */
    public static function instance(): self
    {
        return static::$self ??= new self();
    }

    /**
     * @return self
     */
    public static function reset(): self
    {
        return static::$self = new self();
    }

    /**
     * @return void
     */
    private function __construct()
    {
    }

    /**
     * @param string $message
     * @param string $bag = ''
     * @param string $key = ''
     *
     * @return void
     */
    public function success(string $message, string $bag = '', string $key = ''): void
    {
        $this->setMessage(__FUNCTION__, $bag, $key, $message);
    }

    /**
     * @param string $message
     * @param string $bag = ''
     * @param string $key = ''
     *
     * @return void
     */
    public function error(string $message, string $bag = '', string $key = ''): void
    {
        $this->setMessage(__FUNCTION__, $bag, $key, $message);
    }

    /**
     * @param \Throwable $e
     * @param string $bag = ''
     * @param string $key = ''
     *
     * @return void
     */
    public function throw(Throwable $e, string $bag = '', string $key = ''): void
    {
        $this->error($e->getMessage(), $bag, $key);

        throw $e;
    }

    /**
     * @param string $status
     * @param string $key
     *
     * @return \Illuminate\Support\MessageBag
     */
    public function get(string $status, string $key): MessageBag
    {
        $messages = $this->viewShareGet();

        if (empty($messages[$status])) {
            $messages[$status] = new Bag();
        }

        $this->sessionMessageDel($status, $key);

        return $messages[$status]->getBag($key);
    }

    /**
     * @param string $status
     *
     * @return array
     */
    public function getStatus(string $status): array
    {
        $messages = $this->viewShareGet();

        if (empty($messages[$status])) {
            return [];
        }

        $this->sessionMessageDelStatus($status);

        return $messages[$status]->getBags();
    }

    /**
     * @return array
     */
    public function getAll(): array
    {
        $messages = $this->viewShareGet();

        $this->sessionMessageDelAll();

        return $messages;
    }

    /**
     * @param array $messages
     *
     * @return void
     */
    public function set(array $messages): void
    {
        $this->sessionFlash($messages);
        $this->viewShareSet(array_map($this->setBag(...), $messages));
    }

    /**
     * @param \Illuminate\Http\Request $request
     *
     * @return self
     */
    public function request(Request $request): self
    {
        $this->request = $request;

        return $this;
    }

    /**
     * @param \Illuminate\Contracts\Session\Session $session
     *
     * @return self
     */
    public function session(Session $session): self
    {
        $this->session = $session;
        $this->set($this->session->get('messages', []));

        return $this;
    }

    /**
     * @param ?array $bags
     *
     * @return \App\Services\View\Bag
     */
    protected function setBag(?array $bags): Bag
    {
        $bag = new Bag();

        if (empty($bags)) {
            return $bag;
        }

        foreach ($bags as $key => $messages) {
            $bag->put($this->bagName($key), new MessageBag($messages));
        }

        return $bag;
    }

    /**
     * @param string $status
     * @param \App\Services\View\Bag $bag
     *
     * @return void
     */
    protected function share(string $status, Bag $bag): void
    {
        $this->viewShareSet([$status => $bag] + $this->viewShareGet());
    }

    /**
     * @param string $status
     * @param \Illuminate\Support\MessageBag $messageBag
     * @param string $bag = ''
     *
     * @return void
     */
    public function setMessageBag(string $status, MessageBag $messageBag, string $bag = ''): void
    {
        $this->share($status, $this->bag($bag, $messageBag));
    }

    /**
     * @param string $status
     * @param string $bag
     * @param string $key
     * @param string $message
     *
     * @return void
     */
    protected function setMessage(string $status, string $bag, string $key, string $message): void
    {
        if (isset($this->current[$status])) {
            return;
        }

        $this->setMessageBag($status, $this->messageBag($key, $message), $bag);
        $this->sessionMessageSet($status, $bag, $key, $message);

        $this->current[$status] = true;
    }

    /**
     * @param string $bag
     * @param \Illuminate\Support\MessageBag $messageBag
     *
     * @return \App\Services\View\Bag
     */
    protected function bag(string $bag, MessageBag $messageBag): Bag
    {
        return (new Bag())->put($this->bagName($bag), $messageBag);
    }

    /**
     * @param string $key
     * @param string $message
     *
     * @return \Illuminate\Support\MessageBag
     */
    protected function messageBag(string $key, string $message): MessageBag
    {
        return new MessageBag([$this->keyName($key) => $message]);
    }

    /**
     * @param string $status
     * @param string $bag
     * @param string $key
     * @param string $message
     *
     * @return void
     */
    protected function sessionMessageSet(string $status, string $bag, string $key, string $message): void
    {
        if ($this->sessionAvailable() === false) {
            return;
        }

        $messages = $this->session->get('messages', []);
        $messages[$status][$this->bagName($bag)][$this->keyName($key)] = $message;

        $this->sessionFlash($messages);
    }

    /**
     * @param string $status
     * @param string $bag
     *
     * @return void
     */
    protected function sessionMessageDel(string $status, string $bag): void
    {
        if ($this->sessionAvailable() === false) {
            return;
        }

        $messages = $this->session->get('messages', []);

        unset($messages[$status][$bag]);

        $this->sessionFlash($messages);
    }

    /**
     * @param string $status
     *
     * @return void
     */
    protected function sessionMessageDelStatus(string $status): void
    {
        if ($this->sessionAvailable() === false) {
            return;
        }

        $messages = $this->session->get('messages', []);

        unset($messages[$status]);

        $this->sessionFlash($messages);
    }

    /**
     * @return void
     */
    protected function sessionMessageDelAll(): void
    {
        if ($this->sessionAvailable() === false) {
            return;
        }

        $this->sessionFlash([]);
    }

    /**
     * @param array $messages
     *
     * @return void
     */
    protected function sessionFlash(array $messages): void
    {
        if ($this->sessionAvailable()) {
            $this->session->flash('messages', $messages);
        }
    }

    /**
     * @return array
     */
    protected function viewShareGet(): array
    {
        return view()->getShared()['messages'] ?? [];
    }

    /**
     * @param array $messages
     *
     * @return void
     */
    protected function viewShareSet(array $messages): void
    {
        view()->share(['messages' => $messages]);
    }

    /**
     * @return bool
     */
    protected function sessionAvailable(): bool
    {
        if (empty($this->session)) {
            return false;
        }

        return empty($this->request) || ($this->request->wantsJson() === false);
    }

    /**
     * @param string $name
     *
     * @return string
     */
    protected function bagName(string $name): string
    {
        return $name ?: static::BAG;
    }

    /**
     * @param string $name
     *
     * @return string
     */
    protected function keyName(string $name): string
    {
        return $name ?: static::KEY;
    }
}

```

`app/View/Components/ChartSpeed.php:`

```php
<?php declare(strict_types=1);

namespace App\View\Components;

use Illuminate\View\Component;
use Illuminate\View\View;
use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Position\Model\Position as PositionModel;

class ChartSpeed extends Component
{
    /**
     * @param \App\Domains\Position\Model\Collection\Position $positions
     *
     * @return self
     */
    public function __construct(public readonly PositionCollection $positions)
    {
    }

    /**
     * @return bool
     */
    public function shouldRender(): bool
    {
        return $this->positions->isNotEmpty();
    }

    /**
     * @return \Illuminate\View\View
     */
    public function render(): View
    {
        return view('components.chart-speed', [
            'id' => 'chart-speed-'.uniqid(),
            'positionsJson' => $this->positionsJson(),
        ]);
    }

    /**
     * @return string
     */
    protected function positionsJson(): string
    {
        return $this->positions
            ->toBase()
            ->sortBy('date_at')
            ->map($this->positionsJsonMap(...))
            ->values()
            ->toJson();
    }

    /**
     * @param \App\Domains\Position\Model\Position $position
     *
     * @return array
     */
    protected function positionsJsonMap(PositionModel $position): array
    {
        return [
            'id' => $position->id,
            'date_at' => explode(' ', $position->date_at)[1],
            'speed' => helper()->unit('speed', $position->speed),
        ];
    }
}

```

`app/View/Components/Map.php:`

```php
<?php declare(strict_types=1);

namespace App\View\Components;

use Illuminate\View\Component;
use Illuminate\View\View;
use App\Domains\Alarm\Model\Collection\Alarm as AlarmCollection;
use App\Domains\AlarmNotification\Model\Collection\AlarmNotification as AlarmNotificationCollection;
use App\Domains\Position\Model\Collection\Position as PositionCollection;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Trip\Model\Trip as TripModel;

class Map extends Component
{
    /**
     * @param \App\Domains\Trip\Model\Trip $trip
     * @param \App\Domains\Position\Model\Collection\Position $positions
     * @param ?\App\Domains\Alarm\Model\Collection\Alarm $alarms = null
     * @param ?\App\Domains\AlarmNotification\Model\Collection\AlarmNotification $notifications = null
     * @param bool $sidebarHidden = false
     *
     * @return self
     */
    public function __construct(
        public readonly TripModel $trip,
        public readonly PositionCollection $positions,
        public readonly ?AlarmCollection $alarms = null,
        public readonly ?AlarmNotificationCollection $notifications = null,
        public readonly bool $sidebarHidden = false,
    ) {
    }

    /**
     * @return bool
     */
    public function shouldRender(): bool
    {
        return $this->positions->isNotEmpty();
    }

    /**
     * @return \Illuminate\View\View
     */
    public function render(): View
    {
        return view('components.map', [
            'positionsJson' => $this->positionsJson(),
            'alarmsJson' => $this->alarmsJson(),
            'notificationsJson' => $this->notificationsJson(),
        ]);
    }

    /**
     * @return string
     */
    protected function positionsJson(): string
    {
        return $this->positions
            ->toBase()
            ->map($this->positionsJsonMap(...))
            ->sortByDesc('date_utc_at')
            ->values()
            ->toJson();
    }

    /**
     * @param \App\Domains\Position\Model\Position $position
     *
     * @return array
     */
    protected function positionsJsonMap(PositionModel $position): array
    {
        return [
            'id' => $position->id,
            'date_at' => $position->date_at,
            'date_utc_at' => $position->date_utc_at,
            'latitude' => $position->latitude,
            'longitude' => $position->longitude,
            'direction' => $position->direction,
            'speed' => helper()->unit('speed', $position->speed),
            'speed_human' => helper()->unitHuman('speed', $position->speed),
            'city' => $position->city?->name,
            'state' => $position->city?->state->name,
        ];
    }

    /**
     * @return ?string
     */
    protected function alarmsJson(): ?string
    {
        return $this->alarms?->toJson();
    }

    /**
     * @return ?string
     */
    protected function notificationsJson(): ?string
    {
        return $this->notifications?->map->only('id', 'type', 'date_at', 'date_utc_at', 'latitude', 'longitude', 'config', 'alarm')->toJson();
    }
}

```

`app/View/Components/MapDevice.php:`

```php
<?php declare(strict_types=1);

namespace App\View\Components;

use Illuminate\View\Component;
use Illuminate\View\View;
use App\Domains\Device\Model\Collection\Device as DeviceCollection;
use App\Domains\Device\Model\Device as DeviceModel;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class MapDevice extends Component
{
    /**
     * @param \App\Domains\Device\Model\Collection\Device $devices
     * @param bool $sidebarHidden = false
     *
     * @return self
     */
    public function __construct(
        public readonly DeviceCollection $devices,
        public readonly bool $sidebarHidden = false,
    ) {
    }

    /**
     * @return \Illuminate\View\View
     */
    public function render(): View
    {
        return view('components.map-device', [
            'id' => uniqid(),
            'devicesJson' => $this->devicesJson(),
            'filterFinished' => $this->filterFinished(),
            'filterFinishedMinutes' => $this->filterFinishedMinutes(),
        ]);
    }

    /**
     * @return string
     */
    protected function devicesJson(): string
    {
        return $this->devices
            ->toBase()
            ->map($this->devicesJsonMap(...))
            ->sortBy('name')
            ->values()
            ->toJson();
    }

    /**
     * @param \App\Domains\Device\Model\Device $device
     *
     * @return array
     */
    protected function devicesJsonMap(DeviceModel $device): array
    {
        return [
            'id' => $device->id,
            'name' => $device->name,
            'position' => $this->devicesJsonMapPosition($device->positionLast),
            'vehicle' => $this->devicesJsonMapVehicle($device->vehicle),
        ];
    }

    /**
     * @param ?\App\Domains\Vehicle\Model\Vehicle $vehicle
     *
     * @return ?array
     */
    protected function devicesJsonMapVehicle(?VehicleModel $vehicle): ?array
    {
        if ($vehicle === null) {
            return null;
        }

        return [
            'id' => $vehicle->id,
            'name' => $vehicle->name,
            'plate' => $vehicle->plate,
        ];
    }

    /**
     * @param ?\App\Domains\Position\Model\Position $position
     *
     * @return ?array
     */
    protected function devicesJsonMapPosition(?PositionModel $position): ?array
    {
        if ($position === null) {
            return null;
        }

        return [
            'id' => $position->id,
            'date_at' => $position->date_at,
            'date_utc_at' => $position->date_utc_at,
            'latitude' => $position->latitude,
            'longitude' => $position->longitude,
            'direction' => $position->direction,
            'speed' => helper()->unit('speed', $position->speed),
            'speed_human' => helper()->unitHuman('speed', $position->speed),
            'city' => $position->city?->name,
            'state' => $position->city?->state->name,
        ];
    }

    /**
     * @return array
     */
    protected function filterFinished(): array
    {
        return [
            '' => __('map-device.filter.finished-all'),
            '0' => __('map-device.filter.finished-no'),
            '1' => __('map-device.filter.finished-yes'),
        ];
    }

    /**
     * @return string
     */
    protected function filterFinishedMinutes(): string
    {
        return app('configuration')->string('trip_wait_minutes');
    }
}

```

`app/View/Components/MapRefuel.php:`

```php
<?php declare(strict_types=1);

namespace App\View\Components;

use Illuminate\View\Component;
use Illuminate\View\View;
use App\Domains\Refuel\Model\Collection\Refuel as RefuelCollection;
use App\Domains\Refuel\Model\Refuel as RefuelModel;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class MapRefuel extends Component
{
    /**
     * @param \App\Domains\Refuel\Model\Collection\Refuel $refuels
     * @param bool $sidebarHidden = false
     *
     * @return self
     */
    public function __construct(
        public readonly RefuelCollection $refuels,
        public readonly bool $sidebarHidden = false,
    ) {
    }

    /**
     * @return \Illuminate\View\View
     */
    public function render(): View
    {
        return view('components.map-refuel', [
            'id' => uniqid(),
            'refuelsJson' => $this->refuelsJson(),
        ]);
    }

    /**
     * @return string
     */
    protected function refuelsJson(): string
    {
        return $this->refuels
            ->toBase()
            ->map($this->refuelsJsonMap(...))
            ->sortByDesc('date_at')
            ->values()
            ->toJson();
    }

    /**
     * @param \App\Domains\Refuel\Model\Refuel $refuel
     *
     * @return array
     */
    protected function refuelsJsonMap(RefuelModel $refuel): array
    {
        return [
            'id' => $refuel->id,
            'date_at' => $refuel->date_at,
            'price' => $refuel->price,
            'total' => $refuel->total,
            'latitude' => $refuel->latitude,
            'longitude' => $refuel->longitude,
            'direction' => $refuel->direction,
            'city' => $refuel->city?->name,
            'state' => $refuel->city?->state->name,
            'vehicle' => $this->refuelsJsonMapVehicle($refuel->vehicle),
        ];
    }

    /**
     * @param ?\App\Domains\Vehicle\Model\Vehicle $vehicle
     *
     * @return ?array
     */
    protected function refuelsJsonMapVehicle(?VehicleModel $vehicle): ?array
    {
        if ($vehicle === null) {
            return null;
        }

        return [
            'id' => $vehicle->id,
            'name' => $vehicle->name,
        ];
    }
}

```

`app/View/Components/MapTrip.php:`

```php
<?php declare(strict_types=1);

namespace App\View\Components;

use Illuminate\View\Component;
use Illuminate\View\View;

class MapTrip extends Component
{
    /**
     * @param bool $sidebarHidden = false
     * @param bool $userShow = false
     * @param bool $vehicleShow = false
     * @param bool $deviceShow = false
     *
     * @return self
     */
    public function __construct(
        public readonly bool $sidebarHidden = false,
        public readonly bool $userShow = false,
        public readonly bool $vehicleShow = false,
        public readonly bool $deviceShow = false,
    ) {
    }

    /**
     * @return \Illuminate\View\View
     */
    public function render(): View
    {
        return view('components.map-trip', [
            'id' => uniqid(),
        ]);
    }
}

```

`app/View/Components/MapVehicle.php:`

```php
<?php declare(strict_types=1);

namespace App\View\Components;

use Illuminate\View\Component;
use Illuminate\View\View;
use App\Domains\Position\Model\Position as PositionModel;
use App\Domains\Vehicle\Model\Collection\Vehicle as VehicleCollection;
use App\Domains\Vehicle\Model\Vehicle as VehicleModel;

class MapVehicle extends Component
{
    /**
     * @param \App\Domains\Vehicle\Model\Collection\Vehicle $vehicles
     * @param bool $sidebarHidden = false
     *
     * @return self
     */
    public function __construct(
        public readonly VehicleCollection $vehicles,
        public readonly bool $sidebarHidden = false,
    ) {
    }

    /**
     * @return \Illuminate\View\View
     */
    public function render(): View
    {
        return view('components.map-vehicle', [
            'id' => uniqid(),
            'vehiclesJson' => $this->vehiclesJson(),
            'filterFinished' => $this->filterFinished(),
            'filterFinishedMinutes' => $this->filterFinishedMinutes(),
        ]);
    }

    /**
     * @return string
     */
    protected function vehiclesJson(): string
    {
        return $this->vehicles
            ->toBase()
            ->map($this->vehiclesJsonMap(...))
            ->sortBy('name')
            ->values()
            ->toJson();
    }

    /**
     * @param \App\Domains\Vehicle\Model\Vehicle $vehicle
     *
     * @return array
     */
    protected function vehiclesJsonMap(VehicleModel $vehicle): array
    {
        return [
            'id' => $vehicle->id,
            'name' => $vehicle->name,
            'plate' => $vehicle->plate,
            'position' => $this->vehiclesJsonMapPosition($vehicle->positionLast),
            'vehicle' => $this->vehiclesJsonMapVehicle($vehicle->vehicle),
        ];
    }

    /**
     * @param ?\App\Domains\Vehicle\Model\Vehicle $vehicle
     *
     * @return ?array
     */
    protected function vehiclesJsonMapVehicle(?VehicleModel $vehicle): ?array
    {
        if ($vehicle === null) {
            return null;
        }

        return [
            'id' => $vehicle->id,
            'name' => $vehicle->name,
            'plate' => $vehicle->plate,
        ];
    }

    /**
     * @param ?\App\Domains\Position\Model\Position $position
     *
     * @return ?array
     */
    protected function vehiclesJsonMapPosition(?PositionModel $position): ?array
    {
        if ($position === null) {
            return null;
        }

        return [
            'id' => $position->id,
            'date_at' => $position->date_at,
            'date_utc_at' => $position->date_utc_at,
            'latitude' => $position->latitude,
            'longitude' => $position->longitude,
            'direction' => $position->direction,
            'speed' => helper()->unit('speed', $position->speed),
            'speed_human' => helper()->unitHuman('speed', $position->speed),
            'city' => $position->city?->name,
            'state' => $position->city?->state->name,
        ];
    }

    /**
     * @return array
     */
    protected function filterFinished(): array
    {
        return [
            '' => __('map-vehicle.filter.finished-all'),
            '0' => __('map-vehicle.filter.finished-no'),
            '1' => __('map-vehicle.filter.finished-yes'),
        ];
    }

    /**
     * @return string
     */
    protected function filterFinishedMinutes(): string
    {
        return app('configuration')->string('trip_wait_minutes');
    }
}

```

`app/View/Components/Message.php:`

```php
<?php declare(strict_types=1);

namespace App\View\Components;

use Illuminate\View\Component;
use Illuminate\View\View;

class Message extends Component
{
    /**
     * @var string
     */
    public string $class;

    /**
     * @param string $type
     * @param string $bag = ''
     * @param string $message = ''
     *
     * @return self
     */
    public function __construct(
        public readonly string $type,
        public readonly string $bag = '',
        public string $message = ''
    ) {
        $this->class();
        $this->message();
    }

    /**
     * @return bool
     */
    public function shouldRender(): bool
    {
        return boolval($this->message);
    }

    /**
     * @return \Illuminate\View\View
     */
    public function render(): View
    {
        return view('components.message');
    }

    /**
     * @return void
     */
    protected function class(): void
    {
        $this->class = 'alert-dismissible show flex items-center mb-2 mt-2 alert';
        $this->class .= ($this->type === 'error') ? ' alert-danger' : ' alert-success';
    }

    /**
     * @return void
     */
    protected function message(): void
    {
        if ($this->message) {
            return;
        }

        $this->message = $this->bag
            ? $this->messageBag()
            : $this->messageType();
    }

    /**
     * @return string
     */
    protected function messageBag(): string
    {
        return service()->message()->get($this->type, $this->bag)->first();
    }

    /**
     * @return string
     */
    protected function messageType(): string
    {
        if (empty($messages = service()->message()->getStatus($this->type))) {
            return '';
        }

        return reset($messages)->first();
    }
}

```

`app/View/Components/Select.php:`

```php
<?php declare(strict_types=1);

namespace App\View\Components;

use Illuminate\Http\Request;
use Illuminate\Support\Collection;
use Illuminate\View\Component;
use Illuminate\View\View;

class Select extends Component
{
    /**
     * @var string
     */
    public string $class;

    /**
     * @param \Illuminate\Http\Request $request
     * @param array|\Illuminate\Support\Collection $options,
     * @param string $value = '',
     * @param string|int|array $text = '',
     * @param string $label = '',
     * @param string $name = '',
     * @param string $id = '',
     * @param array|string|null $selected = null,
     * @param string $placeholder = ''
     * @param bool $valueOnly = false
     * @param bool $optionsWithAttributes = false
     *
     * @return self
     */
    public function __construct(
        public Request $request,
        public array|Collection $options,
        public string $value = '',
        public string|int|array $text = '',
        public string $label = '',
        public string $name = '',
        public string $id = '',
        public array|string|null $selected = null,
        public string $placeholder = '',
        public bool $valueOnly = false,
        public bool $optionsWithAttributes = false,
    ) {
        $this->text = array_filter((array)$text);
        $this->selected = $this->selected($selected);
        $this->options = $this->options($options);
        $this->id = $id ?: 'input-'.uniqid();
        $this->placeholder($placeholder);
        $this->class();
    }

    /**
     * @param array|string|null $selected
     *
     * @return string|array
     */
    protected function selected(array|string|null $selected): string|array
    {
        $selected ??= $this->request->input(helper()->arrayKeyDot($this->name));

        return is_array($selected) ? $selected : strval($selected);
    }

    /**
     * @param array|\Illuminate\Support\Collection $options
     *
     * @return array
     */
    protected function options(array|Collection $options): array
    {
        if ($options instanceof Collection) {
            $options = $options->toArray();
        }

        if ($this->valueOnly) {
            return $this->optionsValue($options);
        }

        if (empty($this->value) || empty($this->text)) {
            return $this->optionsKeyValue($options);
        }

        return $this->optionsAssociative($options);
    }

    /**
     * @param array $options
     *
     * @return array
     */
    protected function optionsValue(array $options): array
    {
        return array_map($this->optionsValueOption(...), $options);
    }

    /**
     * @param mixed $value
     *
     * @return array
     */
    protected function optionsValueOption($value): array
    {
        return [
            'value' => $value,
            'text' => $value,
            'selected' => $this->optionsValueOptionSelected($value),
        ];
    }

    /**
     * @param mixed $value
     *
     * @return bool
     */
    protected function optionsValueOptionSelected($value): bool
    {
        if (is_array($this->selected)) {
            return in_array($value, $this->selected);
        }

        return strval($value) === $this->selected;
    }

    /**
     * @param array $options
     *
     * @return array
     */
    protected function optionsKeyValue(array $options): array
    {
        return array_map($this->optionsKeyValueOption(...), array_keys($options), $options);
    }

    /**
     * @param mixed $key
     * @param mixed $value
     *
     * @return array
     */
    protected function optionsKeyValueOption($key, $value): array
    {
        return [
            'value' => $key,
            'text' => $value,
            'selected' => $this->optionsKeyValueOptionSelected($key),
        ];
    }

    /**
     * @param mixed $key
     *
     * @return bool
     */
    protected function optionsKeyValueOptionSelected($key): bool
    {
        if (is_array($this->selected)) {
            return in_array($key, $this->selected);
        }

        return strval($key) === $this->selected;
    }

    /**
     * @param array $options
     *
     * @return array
     */
    protected function optionsAssociative(array $options): array
    {
        return array_map($this->optionsAssociativeOption(...), $options);
    }

    /**
     * @param array $option
     *
     * @return array
     */
    protected function optionsAssociativeOption(array $option): array
    {
        return [
            'value' => $this->optionsAssociativeOptionValue($option),
            'text' => $this->optionsAssociativeOptionText($option),
            'selected' => $this->optionsAssociativeOptionSelected($option),
            'attributes' => $this->optionsAssociativeOptionAttributes($option),
        ];
    }

    /**
     * @param array $option
     *
     * @return string
     */
    protected function optionsAssociativeOptionValue(array $option): string
    {
        return strval($option[$this->value] ?? '');
    }

    /**
     * @param array $option
     *
     * @return string
     */
    protected function optionsAssociativeOptionText(array $option): string
    {
        return implode(' - ', array_filter(array_map(fn ($key) => data_get($option, $key, ''), $this->text)));
    }

    /**
     * @param array $option
     *
     * @return bool
     */
    protected function optionsAssociativeOptionSelected(array $option): bool
    {
        $key = $option[$this->value] ?? '';

        if (is_array($this->selected)) {
            return in_array($key, $this->selected);
        }

        return strval($key) === $this->selected;
    }

    /**
     * @param array $option
     *
     * @return string
     */
    protected function optionsAssociativeOptionAttributes(array $option): string
    {
        if ($this->optionsWithAttributes === false) {
            return '';
        }

        $option = array_diff_key($option, array_flip(array_merge([$this->value, 'selected'], $this->text)));

        return helper()->arrayHtmlAttributes(array_filter($option));
    }

    /**
     * @param string $placeholder
     *
     * @return void
     */
    protected function placeholder(string $placeholder): void
    {
        if (empty($placeholder)) {
            return;
        }

        array_unshift($this->options, [
            'value' => '',
            'text' => $placeholder,
            'selected' => false,
        ]);
    }

    /**
     * @return void
     */
    protected function class(): void
    {
        $this->class = 'form-select form-select-lg bg-white';
    }

    /**
     * @return \Illuminate\View\View
     */
    public function render(): View
    {
        return view('components.select');
    }
}

```


